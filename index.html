
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ç»Ÿä¸€æ¸¸æˆå…¥å£</title>
  </head>
  <body>
    <script>
      (function () {
        'use strict';

        // æ£€æŸ¥SillyTavern API
        if (typeof getChatMessages === 'undefined' || typeof TavernHelper === 'undefined') {
          console.error('[ç»Ÿä¸€å…¥å£] SillyTavern API æœªæ‰¾åˆ°');
          return;
        }

        console.log('[ç»Ÿä¸€å…¥å£] å¼€å§‹åˆå§‹åŒ–...');

        // ğŸ”¥ å®šä¹‰é‡æ–°åŠ è½½å‡½æ•°ï¼Œä¾›å¼€å±€.htmlè°ƒç”¨
        window.reloadUnifiedEntry = async function () {
          console.log('[ç»Ÿä¸€å…¥å£] æ”¶åˆ°é‡æ–°åŠ è½½è¯·æ±‚...');
          try {
            // é‡æ–°æ‰§è¡Œåˆ¤æ–­é€»è¾‘
            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„loadStateï¼šä»åå¾€å‰æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰extra.teresen_chatçš„æ¶ˆæ¯
            let chatHistory = [];
            if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
              for (let i = SillyTavern.chat.length - 1; i >= 0; i--) {
                const msg = SillyTavern.chat[i];
                if (msg.extra?.teresen_chat && Array.isArray(msg.extra.teresen_chat)) {
                  chatHistory = msg.extra.teresen_chat;
                  break;
                }
              }
            }

            const hasGameHistory = Array.isArray(chatHistory) && chatHistory.length > 0;
            const shouldLoadMainPage = hasGameHistory;

            console.log('[ç»Ÿä¸€å…¥å£] é‡æ–°åˆ¤æ–­ç»“æœ:', {
              hasGameHistory: hasGameHistory,
              chatHistoryLength: chatHistory.length,
              shouldLoadMainPage: shouldLoadMainPage,
            });

            let url;
            if (shouldLoadMainPage) {
              console.log('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½æ­£æ–‡é¡µé¢...');
              url = 'https://fastly.jsdelivr.net/gh/EternalRe0/UmaProject@b6d4c312649c61d6f2fdf639fb07dce5cf0c19d0/mainpage.html';
            } else {
              console.log('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½å¼€å±€é¡µé¢...');
              url = 'https://fastly.jsdelivr.net/gh/EternalRe0/UmaProject@b6d4c312649c61d6f2fdf639fb07dce5cf0c19d0/startgame.html';
            }

            // åŠ è½½é¡µé¢
            if (typeof $ !== 'undefined' && $.fn.load) {
              $('body').load(url, function (response, status, xhr) {
                if (status === 'error') {
                  console.error('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½å¤±è´¥:', xhr.status, xhr.statusText);
                } else {
                  console.log('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½å®Œæˆ');
                }
              });
            } else {
              const response = await fetch(url);
              if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
              }

              const html = await response.text();
              const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
              const headMatch = html.match(/<head[^>]*>([\s\S]*?)<\/head>/i);

              let bodyContent = bodyMatch ? bodyMatch[1].trim() : html;

              if (headMatch) {
                const headContent = headMatch[1];
                const styleMatch = headContent.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
                const linkMatch = headContent.match(/<link[^>]*>/gi);

                let headStyles = '';
                if (styleMatch) {
                  headStyles += styleMatch.join('\n');
                }
                if (linkMatch) {
                  headStyles += linkMatch.join('\n');
                }

                if (headStyles) {
                  bodyContent = headStyles + '\n' + bodyContent;
                }
              }

              document.body.innerHTML = bodyContent;

              setTimeout(() => {
                const scripts = document.querySelectorAll('script');
                scripts.forEach(oldScript => {
                  if (oldScript.textContent.includes('[ç»Ÿä¸€å…¥å£]')) {
                    return;
                  }

                  const newScript = document.createElement('script');
                  Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                  });
                  if (oldScript.src) {
                    newScript.src = oldScript.src;
                  } else {
                    newScript.textContent = oldScript.textContent;
                  }
                  oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                console.log('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½å®Œæˆ');
              }, 100);
            }
          } catch (error) {
            console.error('[ç»Ÿä¸€å…¥å£] é‡æ–°åŠ è½½å¤±è´¥:', error);
          }
        };

        (async function () {
          try {
            // 1. æ£€æŸ¥æ¶ˆæ¯çŠ¶æ€ï¼Œåˆ¤æ–­åº”è¯¥åŠ è½½å“ªä¸ªé¡µé¢
            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„loadStateï¼šä»åå¾€å‰æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰extra.teresen_chatçš„æ¶ˆæ¯
            let chatHistory = [];
            if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
              for (let i = SillyTavern.chat.length - 1; i >= 0; i--) {
                const msg = SillyTavern.chat[i];
                if (msg.extra?.teresen_chat && Array.isArray(msg.extra.teresen_chat)) {
                  chatHistory = msg.extra.teresen_chat;
                  console.log(`[ç»Ÿä¸€å…¥å£] æ‰¾åˆ°extra.teresen_chatï¼Œä½ç½®ï¼šç¬¬${i}æ¡æ¶ˆæ¯ï¼ˆä»åå¾€å‰ï¼‰`);
                  break;
                }
              }
            }

            console.log('[ç»Ÿä¸€å…¥å£] æ£€æŸ¥ç»“æœ:', {
              chatHistoryLength: chatHistory.length,
            });

            // æ£€æŸ¥teresen_chatæ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ¸¸æˆè®°å½•ï¼ˆä¸æ˜¯ç©ºæ•°ç»„ï¼Œä¸”è‡³å°‘æœ‰ä¸€æ¡è®°å½•ï¼‰
            const hasGameHistory = Array.isArray(chatHistory) && chatHistory.length > 0;

            // åªæœ‰teresen_chatæœ‰è®°å½•æ—¶æ‰åŠ è½½æ­£æ–‡é¡µ
            // å¼€å±€é€‰æ‹©å®Œæˆåï¼Œè™½ç„¶0å±‚æœ‰å¼€åœºå‰§æƒ…ï¼Œä½†teresen_chatè¿˜æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ˜¾ç¤ºå¼€å±€é€‰æ‹©
            // ç›´åˆ°çœŸæ­£å¼€å§‹æ¸¸æˆå¹¶ä¿å­˜åˆ°teresen_chatåï¼Œæ‰ä¼šåŠ è½½æ­£æ–‡é¡µ
            const shouldLoadMainPage = hasGameHistory;

            console.log('[ç»Ÿä¸€å…¥å£] åˆ¤æ–­ç»“æœ:', {
              hasGameHistory: hasGameHistory,
              chatHistoryLength: chatHistory.length,
              shouldLoadMainPage: shouldLoadMainPage,
            });

            // 2. æ ¹æ®åˆ¤æ–­ç»“æœåŠ è½½å¯¹åº”çš„é¡µé¢
            let url;
            if (shouldLoadMainPage) {
              console.log('[ç»Ÿä¸€å…¥å£] åŠ è½½æ­£æ–‡é¡µé¢...');
              url = 'https://fastly.jsdelivr.net/gh/EternalRe0/UmaProject@cf79e30f1c8011509ce727ba364a051250fd41c3/mainpage.html';
            } else {
              console.log('[ç»Ÿä¸€å…¥å£] åŠ è½½å¼€å±€é¡µé¢...');
              url = 'https://fastly.jsdelivr.net/gh/EternalRe0/UmaProject@cf79e30f1c8011509ce727ba364a051250fd41c3/startgame.html';
            }

            // 3. ä½¿ç”¨jQueryçš„.load()æ–¹æ³•åŠ è½½ï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨fetch
            if (typeof $ !== 'undefined' && $.fn.load) {
              console.log('[ç»Ÿä¸€å…¥å£] ä½¿ç”¨jQuery.load()åŠ è½½é¡µé¢...');
              $('body').load(url, function (response, status, xhr) {
                if (status === 'error') {
                  console.error('[ç»Ÿä¸€å…¥å£] jQueryåŠ è½½å¤±è´¥:', xhr.status, xhr.statusText);
                  document.body.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥: ' + xhr.statusText + '</p>';
                } else {
                  console.log('[ç»Ÿä¸€å…¥å£] é¡µé¢åŠ è½½å®Œæˆ');
                }
              });
            } else {
              // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨fetch
              console.log('[ç»Ÿä¸€å…¥å£] ä½¿ç”¨fetchåŠ è½½é¡µé¢...');
              const response = await fetch(url);
              if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
              }

              const html = await response.text();

              // æå–bodyå†…å®¹ï¼ˆåŒ…æ‹¬headä¸­çš„styleå’Œscriptï¼‰
              const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
              const headMatch = html.match(/<head[^>]*>([\s\S]*?)<\/head>/i);

              let bodyContent = bodyMatch ? bodyMatch[1].trim() : html;

              // æå–headä¸­çš„styleå’Œlinkæ ‡ç­¾ï¼Œæ·»åŠ åˆ°bodyå‰
              if (headMatch) {
                const headContent = headMatch[1];
                const styleMatch = headContent.match(/<style[^>]*>([\s\S]*?)<\/style>/gi);
                const linkMatch = headContent.match(/<link[^>]*>/gi);

                let headStyles = '';
                if (styleMatch) {
                  headStyles += styleMatch.join('\n');
                }
                if (linkMatch) {
                  headStyles += linkMatch.join('\n');
                }

                if (headStyles) {
                  bodyContent = headStyles + '\n' + bodyContent;
                }
              }

              // æ›¿æ¢å½“å‰bodyå†…å®¹
              document.body.innerHTML = bodyContent;

              // æ‰§è¡Œè„šæœ¬ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ›´æ–°ï¼‰
              setTimeout(() => {
                const scripts = document.querySelectorAll('script');
                scripts.forEach(oldScript => {
                  // è·³è¿‡å½“å‰è„šæœ¬ï¼ˆç»Ÿä¸€å…¥å£çš„è„šæœ¬ï¼‰
                  if (oldScript.textContent.includes('[ç»Ÿä¸€å…¥å£]')) {
                    return;
                  }

                  const newScript = document.createElement('script');
                  Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                  });
                  if (oldScript.src) {
                    newScript.src = oldScript.src;
                  } else {
                    newScript.textContent = oldScript.textContent;
                  }
                  oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                console.log('[ç»Ÿä¸€å…¥å£] é¡µé¢åŠ è½½å®Œæˆ');
              }, 100);
            }
          } catch (error) {
            console.error('[ç»Ÿä¸€å…¥å£] åŠ è½½å¤±è´¥:', error);
            document.body.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
          }
        })();
      })();
    </script>
  </body>
</html>

