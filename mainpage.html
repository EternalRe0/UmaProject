
<!--
================================================================================
  ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ - è®­ç»ƒå‘˜ç”Ÿå­˜æŒ‡å—
  
  ä½œè€…: Eternal zz
  åˆ›æ„æ”¯æŒï¼ŒæŠ€æœ¯æ”¯æŒ
  Discord ID: eternalzz0840
  
  ç‰ˆæƒå£°æ˜:
  - ç¦æ­¢å•†ç”¨
  - ç¦æ­¢äºŒåˆ›
  - åªèƒ½åœ¨ç±»è„‘ã€æ—…ç¨‹äºŒä¼ 
  
  æœªç»ä½œè€…è®¸å¯ï¼Œä¸å¾—ç”¨äºä»»ä½•å•†ä¸šç”¨é€”æˆ–è¿›è¡ŒäºŒæ¬¡åˆ›ä½œ
================================================================================
-->
<!doctype html>

<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ</title>

    <meta name="description" content="ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ - ææ€–è§†è§‰å°è¯´ç•Œé¢" />

    <!-- ğŸ”¥ æ€§èƒ½ç›‘æ§ï¼šç›‘æ§èµ„æºåŠ è½½æ—¶é—´ -->
    <script>
      (function () {
        const perfData = {
          pageLoadStart: performance.timing ? performance.timing.navigationStart : performance.now(),
          resourceTimings: [],
        };

        // ç›‘æ§èµ„æºåŠ è½½
        if ('PerformanceObserver' in window) {
          const observer = new PerformanceObserver(list => {
            for (const entry of list.getEntries()) {
              if (entry.entryType === 'resource') {
                perfData.resourceTimings.push({
                  name: entry.name,
                  duration: entry.duration.toFixed(2),
                  size: entry.transferSize || 0,
                });
              }
            }
          });
          observer.observe({ entryTypes: ['resource'] });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¾“å‡ºæ€§èƒ½æŠ¥å‘Š
        window.addEventListener('load', () => {
          setTimeout(() => {
            const loadTime = performance.timing
              ? performance.timing.loadEventEnd - performance.timing.navigationStart
              : performance.now() - perfData.pageLoadStart;

            console.log('â±ï¸ [æ€§èƒ½] ========== é¡µé¢åŠ è½½æ€§èƒ½æŠ¥å‘Š ==========');
            console.log(`â±ï¸ [æ€§èƒ½] é¡µé¢æ€»åŠ è½½æ—¶é—´: ${loadTime.toFixed(2)}ms`);

            if (performance.timing) {
              const timing = performance.timing;
              console.log(`â±ï¸ [æ€§èƒ½] DNSæŸ¥è¯¢: ${(timing.domainLookupEnd - timing.domainLookupStart).toFixed(2)}ms`);
              console.log(`â±ï¸ [æ€§èƒ½] TCPè¿æ¥: ${(timing.connectEnd - timing.connectStart).toFixed(2)}ms`);
              console.log(`â±ï¸ [æ€§èƒ½] è¯·æ±‚å“åº”: ${(timing.responseEnd - timing.requestStart).toFixed(2)}ms`);
              console.log(`â±ï¸ [æ€§èƒ½] DOMè§£æ: ${(timing.domComplete - timing.domInteractive).toFixed(2)}ms`);
            }

            if (perfData.resourceTimings.length > 0) {
              console.log(`â±ï¸ [æ€§èƒ½] èµ„æºåŠ è½½ç»Ÿè®¡ (${perfData.resourceTimings.length}ä¸ªèµ„æº):`);
              perfData.resourceTimings
                .sort((a, b) => parseFloat(b.duration) - parseFloat(a.duration))
                .slice(0, 5)
                .forEach(resource => {
                  console.log(
                    `  - ${resource.name.split('/').pop()}: ${resource.duration}ms (${(resource.size / 1024).toFixed(2)}KB)`,
                  );
                });
            }
            console.log('â±ï¸ [æ€§èƒ½] ============================================');
          }, 100);
        });
      })();
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šå¼‚æ­¥åŠ è½½å­—ä½“ï¼Œé¿å…é˜»å¡æ¸²æŸ“ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'; this.onload=null;"
    />

    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Serif+SC:wght@400;500;600&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šå¼‚æ­¥åŠ è½½CSSï¼Œé¿å…é˜»å¡æ¸²æŸ“ -->
    <link rel="preload" href="/app.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="/app.css" /></noscript>

    <script>
      var e = Object.defineProperty,
        t = (t, n, s) => (
          ((t, n, s) => {
            n in t ? e(t, n, { enumerable: !0, configurable: !0, writable: !0, value: s }) : (t[n] = s);
          })(t, 'symbol' != typeof n ? n + '' : n, s),
          s
        );

      !(function () {
        const e = document.createElement('link').relList;

        if (!(e && e.supports && e.supports('modulepreload'))) {
          for (const e of document.querySelectorAll('link[rel="modulepreload"]')) t(e);

          new MutationObserver(e => {
            for (const n of e)
              if ('childList' === n.type)
                for (const e of n.addedNodes) 'LINK' === e.tagName && 'modulepreload' === e.rel && t(e);
          }).observe(document, { childList: !0, subtree: !0 });
        }

        function t(e) {
          if (e.ep) return;

          e.ep = !0;

          const t = (function (e) {
            const t = {};

            return (
              e.integrity && (t.integrity = e.integrity),
              e.referrerPolicy && (t.referrerPolicy = e.referrerPolicy),
              'use-credentials' === e.crossOrigin
                ? (t.credentials = 'include')
                : 'anonymous' === e.crossOrigin
                  ? (t.credentials = 'omit')
                  : (t.credentials = 'same-origin'),
              t
            );
          })(e);

          fetch(e.href, t);
        }
      })();

      const n = new (class {
        constructor() {
          // æ£€æŸ¥å…¨å±€å‡½æ•°æ˜¯å¦å¯ç”¨
          if (typeof window.eventEmit === 'undefined' || typeof window.eventOn === 'undefined') {
            console.warn('âš ï¸ MVUå…¨å±€å‡½æ•°æœªæ‰¾åˆ°ï¼Œå¯èƒ½å½±å“MVUåŠŸèƒ½');
            console.log(
              'å¯ç”¨çš„å…¨å±€å‡½æ•°:',
              Object.keys(window).filter(key => typeof window[key] === 'function'),
            );
          }

          // åˆå§‹åŒ–é©¬å¨˜è®°åå†Œå·²æ·»åŠ é›†åˆï¼Œé¿å…é‡å¤è®¡ç®—
          this.umaRosterAdded = new Set();

          // åˆå§‹åŒ–çŠ¶æ€åŠ¨ç”»æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          this.statusAnimationActive = false;

          // ğŸ”¥ è®°å¿†ç³»ç»Ÿç›¸å…³å˜é‡åˆå§‹åŒ–
          this.lastExtractedJourney = null; // æœ€åæå–çš„"æœ¬å‘¨ç›®ç»å†"ï¼ˆè¯¦ç»†è®°å¿†ï¼‰
          this.lastExtractedCoreMemory = null; // æœ€åæå–çš„"æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†"ï¼ˆè®°å¿†æ€»ç»“ï¼‰
          this.lastWrittenJourney = null; // æœ€åå†™å…¥çš„"æœ¬å‘¨ç›®ç»å†"
          this.lastWrittenCoreMemory = null; // æœ€åå†™å…¥çš„"æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†"
          this.isAutoWriteEnabled = true; // æ˜¯å¦è‡ªåŠ¨å†™å…¥ä¸–ç•Œä¹¦
          this.unifiedIndex = 1; // å½“å‰å‘¨ç›®ç´¢å¼•ï¼ˆç”¨äºå¤šå‘¨ç›®ï¼‰
          this.autoWriteIntervalId = null; // è‡ªåŠ¨å†™å…¥è½®è¯¢å®šæ—¶å™¨ID

          // ğŸ”¥ è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿç›¸å…³å˜é‡
          const savedAutoSaveState = localStorage.getItem('teresen_auto_save_enabled');
          this.isAutoSaveEnabled = savedAutoSaveState !== 'false'; // é»˜è®¤å¼€å¯ï¼Œé™¤éç”¨æˆ·æ˜ç¡®å…³é—­
          this.pendingAutoSave = null; // å¾…æäº¤çš„è‡ªåŠ¨å­˜æ¡£å¿«ç…§

          // ğŸ”¥ ç”Ÿæˆå¤±è´¥æ¢å¤ç›¸å…³å˜é‡
          this.lastValidStoryContentBeforeGeneration = ''; // ä¿å­˜ç”Ÿæˆå‰çš„æ­£æ–‡å†…å®¹ï¼Œç”¨äºç”Ÿæˆå¤±è´¥æ—¶æ¢å¤

          // ğŸ”¥ å­˜æ¡£ç³»ç»Ÿç›¸å…³å˜é‡åˆå§‹åŒ–
          this.chatHistoryCache = []; // å‰ç«¯å†å²è®°å½•ç¼“å­˜ï¼ˆå›åˆå¿«ç…§æ•°ç»„ï¼‰
          this.historyViewIndex = -1; // å½“å‰æŸ¥çœ‹çš„å†å²ç´¢å¼•
          this.isStreaming = false; // ğŸ”¥ æµå¼ä¼ è¾“çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢updateStoryContentåœ¨æµå¼ä¼ è¾“æ—¶è¦†ç›–å†…å®¹

          (t(this, 'updateInterval', null),
            t(this, 'isInitialized', !1),
            console.log('ğŸ® ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆMVUç•Œé¢ç®¡ç†å™¨å·²åˆ›å»º'));
        }

        async init() {
          const initStart = performance.now();
          console.log('â±ï¸ [æ€§èƒ½] ========== åˆå§‹åŒ–å¼€å§‹ ==========');

          if (!this.isInitialized) {
            if ((console.group('ğŸš€ ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆMVUç•Œé¢åˆå§‹åŒ–'), void 0 === window.TavernHelper)) {
              const initEnd = performance.now();
              console.log(`â±ï¸ [æ€§èƒ½] åˆå§‹åŒ–å¤±è´¥ï¼ˆTavernHelperæœªæ‰¾åˆ°ï¼‰ï¼Œè€—æ—¶: ${(initEnd - initStart).toFixed(2)}ms`);
              return (console.error('âŒ TavernHelperç¯å¢ƒæœªæ‰¾åˆ°'), void console.groupEnd());
            }

            console.log('âœ… TavernHelperç¯å¢ƒå·²æ‰¾åˆ°');

            console.log('ğŸ”§ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            this.setupEventListeners();

            console.log('ğŸ”§ è®¾ç½®æ§åˆ¶å°å‘½ä»¤...');
            this.setupConsoleCommands();

            console.log('ğŸ”„ è®¾ç½®æµå¼æ›´æ–°ç›‘å¬...');
            this.setupStreamListeners();

            // ğŸ”¥ æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¸¸æˆä¼šè¯ï¼ˆchatIdå˜åŒ–ï¼‰
            const checkStart = performance.now();
            await this._checkNewGameSession();
            const checkEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] _checkNewGameSession è€—æ—¶: ${(checkEnd - checkStart).toFixed(2)}ms`);

            // ğŸ”¥ æ¢å¤å˜é‡çŠ¶æ€ï¼ˆå‚è€ƒåˆ†æ2.jsï¼šä»æœ€åä¸€æ¡æ¶ˆæ¯çš„variableStateæ¢å¤ï¼‰
            console.log('ğŸ”„ æ¢å¤å˜é‡çŠ¶æ€...');
            const restoreStart = performance.now();
            await this.restoreVariableStateFromLastMessage();
            const restoreEnd = performance.now();
            console.log(
              `â±ï¸ [æ€§èƒ½] restoreVariableStateFromLastMessage è€—æ—¶: ${(restoreEnd - restoreStart).toFixed(2)}ms`,
            );

            console.log('ğŸ”„ æ›´æ–°ç•Œé¢...');
            const interfaceStart = performance.now();
            await this.updateInterface();
            const interfaceEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] updateInterface æ€»è€—æ—¶: ${(interfaceEnd - interfaceStart).toFixed(2)}ms`);

            // ğŸ”¥ åŠ è½½å­—ä½“å’ŒèƒŒæ™¯è®¾ç½®
            this.loadSettings && this.loadSettings();

            // ğŸ”¥ æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å…¨å±åŠ è½½ï¼ˆç”µè„‘ç«¯ï¼‰
            this.checkAutoFullscreen();

            console.log('â° å¯åŠ¨å›å¤æ—¶é—´å®šæ—¶å™¨...');
            this.startReplyTimer();

            // ğŸ”¥ ç»‘å®šæ•…äº‹æ–‡æœ¬æ“ä½œæŒ‰é’®äº‹ä»¶
            this.setupStoryActionButtons();

            this.updateInterval = setInterval(async () => {
              await this.updateInterface();
            }, 2e3);

            this.isInitialized = !0;

            console.log('âœ… MVUç•Œé¢åˆå§‹åŒ–å®Œæˆ');

            const initEnd = performance.now();
            const totalInitTime = (initEnd - initStart).toFixed(2);
            console.log(`â±ï¸ [æ€§èƒ½] ========== åˆå§‹åŒ–å®Œæˆï¼Œæ€»è€—æ—¶: ${totalInitTime}ms ==========`);
            console.log(`â±ï¸ [æ€§èƒ½] åˆå§‹åŒ–å„æ­¥éª¤è€—æ—¶ç»Ÿè®¡:`);
            console.log(`  - _checkNewGameSession: ${(checkEnd - checkStart).toFixed(2)}ms`);
            if (typeof restoreEnd !== 'undefined' && typeof restoreStart !== 'undefined') {
              console.log(`  - restoreVariableStateFromLastMessage: ${(restoreEnd - restoreStart).toFixed(2)}ms`);
            }
            console.log(`  - updateInterface: ${(interfaceEnd - interfaceStart).toFixed(2)}ms`);

            console.groupEnd();
          }
        }

        // æ–°å¢ï¼šMVUç¯å¢ƒè¯Šæ–­å’Œä¿®å¤å‡½æ•°
        debugMVUEnvironment() {
          console.group('ğŸ” MVUç¯å¢ƒè¯Šæ–­');

          // æ£€æŸ¥åŸºæœ¬å‡½æ•°
          console.log('window.eventEmit:', typeof window.eventEmit);
          console.log('window.eventOn:', typeof window.eventOn);
          console.log('getAllVariables:', typeof this.getAllVariables);

          // æ£€æŸ¥MVUå¯¹è±¡
          console.log('window.Mvu:', window.Mvu);
          console.log('window.mag_invoke_mvu:', typeof window.mag_invoke_mvu);

          // æ£€æŸ¥TavernHelperç¯å¢ƒ
          console.log('window.TavernHelper:', window.TavernHelper);

          // æ£€æŸ¥å½“å‰å˜é‡çŠ¶æ€
          try {
            const currentVars = this.getAllVariables();
            console.log('å½“å‰å˜é‡çŠ¶æ€:', currentVars);
          } catch (e) {
            console.error('è·å–å˜é‡å¤±è´¥:', e);
          }

          console.groupEnd();
        }

        // æ–°å¢ï¼šè®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨
        setupMVUListeners() {
          console.log('ğŸ”§ è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨...');

          // ç›‘å¬MVUå˜é‡æ›´æ–°äº‹ä»¶
          if (typeof window.eventOn === 'function') {
            window.eventOn('mag_variable_updated', (statData, path, oldValue, newValue) => {
              console.log('âœ… MVUå˜é‡æ›´æ–°äº‹ä»¶:', path, oldValue, 'â†’', newValue);
            });

            window.eventOn('mag_variable_update_ended', variables => {
              console.log('âœ… MVUå˜é‡æ›´æ–°å®Œæˆäº‹ä»¶:', variables);
            });

            window.eventOn('mag_variable_update_started', variables => {
              console.log('ğŸ”„ MVUå˜é‡æ›´æ–°å¼€å§‹äº‹ä»¶:', variables);
            });

            console.log('âœ… MVUäº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
          } else {
            console.warn('âš ï¸ window.eventOnå‡½æ•°ä¸å¯ç”¨ï¼Œæ— æ³•è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨');
            console.log(
              'å¯ç”¨çš„å…¨å±€å‡½æ•°:',
              Object.keys(window).filter(key => typeof window[key] === 'function'),
            );
          }
        }

        setupEventListeners() {
          $(document).ready(() => {
            (console.log('ğŸ”§ ä½¿ç”¨jQueryè®¾ç½®äº‹ä»¶ç›‘å¬å™¨...'),
              // ğŸ”¥ å­˜æ¡£æŒ‰é’®å·²åˆ é™¤
              $('#fullscreen-btn').on('click', () => this.toggleFullscreen()),
              $('#fullscreen-btn-right').on('click', () => this.toggleFullscreen()),
              $('#debug-btn').on('click', () => this.debugVariables()),
              $('#btn-send-action').on('click', async () => {
                await this.handleActionSubmit();
              }),
              // å›è½¦å‘é€æ¶ˆæ¯ï¼ˆæ ¹æ®è®¾ç½®åŠ¨æ€å¯ç”¨/ç¦ç”¨ï¼‰
              this.setupEnterToSend(),
              // ğŸ”¥ åˆå§‹åŒ–å¿«æ·åŠŸèƒ½å¼¹çª—
              this.initQuickActionModal(),
              // ğŸ”¥ åˆå§‹åŒ–å¿«æ·å§¿åŠ¿å¼¹çª—
              this.initQuickPositionModal(),
              $('#profile-expand').on('click', () => this.toggleProfile()),
              $('#sex-position-expand').on('click', () => this.toggleSexPosition()),
              $('#task-list-expand').on('click', () => this.toggleTaskList()),
              // å¤´åƒç‚¹å‡»äº‹ä»¶
              $(document).on('click', '#profile-avatar', () => {
                this.showAvatarSelector();
              }),
              $('#card-display-btn').on('click', () => this.showCardDisplayModal()),
              $('#close-card-display-btn').on('click', () => {
                const modal = document.getElementById('card-display-modal');
                if (modal) {
                  modal.style.display = 'none';
                  // å¦‚æœå¼¹çª—åœ¨å…¨å±è¦†ç›–å±‚ä¸­ï¼Œå¯èƒ½éœ€è¦ç§»å›åŸä½ç½®
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  if (overlay && modal.parentNode === overlay) {
                    // æ¢å¤åŸå§‹ä½ç½®ï¼ˆå¦‚æœæœ‰ä¿å­˜çš„è¯ï¼‰
                    const originalParent = modal.dataset.originalParent;
                    if (originalParent === 'BODY' || !originalParent) {
                      document.body.appendChild(modal);
                    }
                  }
                }
              }),
              $('#manage-talents-btn').on('click', () => this.showTalentsModal()),
              $('#manage-talents-btn-inner').on('click', () => this.showTalentsModal()),
              $('#close-talents-btn').on('click', () => {
                this.closeTalentsModal();
              }),
              $('#talents-modal').on('click', e => {
                if (e.target.id === 'talents-modal') {
                  this.closeTalentsModal();
                }
              }),
              $('#settings-btn').on('click', () => {
                console.log('ğŸ¯ è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»ï¼');
                const e = document.getElementById('settings-modal');
                if (e) {
                  console.log('âœ… æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†');
                  // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
                  (() => {
                    const overlay = document.getElementById('teresen-fullscreen-overlay');
                    if (overlay && e.parentNode !== overlay) {
                      e.dataset.originalParent = e.parentNode?.tagName || 'BODY';
                      overlay.appendChild(e);
                      console.log('âœ… settings-modal å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨');
                    }
                  })();
                  e.style.display = 'flex';
                  // æ¢å¤å·²ä¿å­˜çš„è®¾ç½®åˆ°UI
                  this.restoreSettingsToUI();
                } else {
                  console.error('âŒ è®¾ç½®æ¨¡æ€æ¡†æœªæ‰¾åˆ°');
                }
              }),
              // è®¾ç½®å¼¹çª—å…³é—­æŒ‰é’® - ç›´æ¥åœ¨setupEventListenersä¸­ç»‘å®šï¼Œå’Œsettings-btnä¸€æ ·
              $('#teresen-settings-close-btn').on('click', () => {
                $('#settings-modal').hide();
              }),
              // è®¾ç½®å¼¹çª—èƒŒæ™¯ç‚¹å‡»å…³é—­
              $('#settings-modal').on('click', e => {
                e.target === e.currentTarget && $('#settings-modal').hide();
              }),
              // è®¾ç½®å¼¹çª—å†…éƒ¨æŒ‰é’® - ç›´æ¥åœ¨setupEventListenersä¸­ç»‘å®š
              $('#settings-modal .font-option-btn').on('click', function () {
                $('#settings-modal .font-option-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                });
                $(this).addClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.2)',
                  'border-color': 'rgba(139, 105, 20, 0.6)',
                });
                const font = $(this).data('font');
                $('#font-preview').css('font-family', font);
              }),
              $('#settings-modal .font-size-btn').on('click', function () {
                $('#settings-modal .font-size-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                });
                $(this).addClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.2)',
                  'border-color': 'rgba(139, 105, 20, 0.6)',
                });
                const size = $(this).data('size');
                $('#font-preview').css('font-size', size + 'em');
              }),
              $('#settings-modal .bg-option-btn').on('click', function () {
                $('#settings-modal .bg-option-btn').removeClass('selected').css({
                  background: 'rgba(139, 105, 20, 0.05)',
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                  color: '#2d2d2d',
                });
                $(this).addClass('selected');
                const bgType = $(this).data('bg-type');
                if (bgType === 'black') {
                  $(this).css({
                    background: 'rgba(0, 0, 0, 0.85)',
                    color: '#fff',
                  });
                } else {
                  $(this).css({
                    background: 'rgba(139, 105, 20, 0.2)',
                    'border-color': 'rgba(139, 105, 20, 0.6)',
                  });
                }
                if (bgType === 'image') {
                  $('#bg-image-upload').show();
                } else {
                  $('#bg-image-upload').hide();
                }
              }),
              // åˆå§‹åŒ–é¢„è®¾å›¾ç‰‡
              (() => {
                const presetImages = [
                  'https://files.catbox.moe/7gjs8m.webp',
                  'https://files.catbox.moe/oq2h66.jpg',
                  'https://files.catbox.moe/539zn7.jpg',
                  'https://files.catbox.moe/lgxdwg.png',
                  'https://files.catbox.moe/91sb56.png',
                  'https://files.catbox.moe/xg93zf.jpg',
                  'https://files.catbox.moe/fo0wn5.jpg',
                  'https://files.catbox.moe/cs0ovj.jpg',
                  'https://files.catbox.moe/fdk1y8.jpg',
                  'https://files.catbox.moe/pa9p00.jpg',
                  'https://files.catbox.moe/2wpwlg.jpg',
                  'https://files.catbox.moe/yux828.jpg',
                  'https://files.catbox.moe/dedwqz.jpg',
                  'https://files.catbox.moe/v8bbky.jpg',
                  'https://files.catbox.moe/k6xrci.jpg',
                  'https://files.catbox.moe/yls8nv.jpg',
                  'https://files.catbox.moe/wn4s3w.jpg',
                  'https://files.catbox.moe/rjchsc.jpg',
                  'https://files.catbox.moe/sdyxal.jpg',
                  'https://files.catbox.moe/j6s7vg.jpg',
                  'https://files.catbox.moe/vtn448.jpg',
                  'https://files.catbox.moe/08474v.jpg',
                  'https://files.catbox.moe/uqvwrx.jpg',
                  'https://files.catbox.moe/anzvoc.jpg',
                ];

                const grid = $('#preset-images-grid');
                presetImages.forEach((url, index) => {
                  const imgItem = $(`
                    <div class="preset-image-item" data-url="${url}" style="
                      position: relative;
                      width: 100%;
                      aspect-ratio: 1;
                      border: 2px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      overflow: hidden;
                      cursor: pointer;
                      transition: all 0.2s;
                      background: rgba(139, 105, 20, 0.05);
                    ">
                      <img src="${url}" style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        display: block;
                      " onerror="this.parentElement.style.display='none'">
                    </div>
                  `);

                  imgItem.on('click', function () {
                    $('.preset-image-item').css({
                      'border-color': 'rgba(139, 105, 20, 0.3)',
                      transform: 'scale(1)',
                      'box-shadow': 'none',
                    });
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.8)',
                      transform: 'scale(1.05)',
                      'box-shadow': '0 4px 8px rgba(139, 105, 20, 0.4)',
                    });
                    const selectedUrl = $(this).data('url');
                    $('#bg-image-url').val(selectedUrl);
                    $('#bg-preview-img').attr('src', selectedUrl);
                    $('#bg-image-preview').show();
                  });

                  imgItem.on('mouseenter', function () {
                    if (!$(this).css('border-color').includes('0.8')) {
                      $(this).css('border-color', 'rgba(139, 105, 20, 0.5)');
                    }
                  });

                  imgItem.on('mouseleave', function () {
                    if (!$(this).css('border-color').includes('0.8')) {
                      $(this).css('border-color', 'rgba(139, 105, 20, 0.3)');
                    }
                  });

                  grid.append(imgItem);
                });
              })(),
              $('#bg-image-load-btn').on('click', function () {
                const url = $('#bg-image-url').val();
                if (url) {
                  $('#bg-preview-img').attr('src', url);
                  $('#bg-image-preview').show();
                  // å–æ¶ˆé¢„è®¾å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€
                  $('.preset-image-item').css({
                    'border-color': 'rgba(139, 105, 20, 0.3)',
                    transform: 'scale(1)',
                    'box-shadow': 'none',
                  });
                }
              }),
              // åˆ é™¤èƒŒæ™¯å›¾æŒ‰é’®
              $('#bg-image-delete-btn').on('click', function () {
                $('#bg-preview-img').attr('src', '');
                $('#bg-image-url').val('');
                $('#bg-image-preview').hide();
                localStorage.removeItem('teresen_fullscreen_background_image');
                // å–æ¶ˆé¢„è®¾å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€
                $('.preset-image-item').css({
                  'border-color': 'rgba(139, 105, 20, 0.3)',
                  transform: 'scale(1)',
                  'box-shadow': 'none',
                });
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯èƒŒæ™¯å›¾æ¨¡å¼ï¼Œåˆ‡æ¢åˆ°é»‘è¾¹æ¨¡å¼
                if ($('.bg-option-btn.selected').data('bg-type') === 'image') {
                  $('.bg-option-btn[data-bg-type="black"]').click();
                }
              }),
              $('#apply-settings-btn').on('click', async () => {
                await this.applySettings();
                $('#settings-modal').hide();
              }),
              $('#reset-settings-btn').on('click', () => {
                this.resetSettings();
              }),
              // æ¸…é™¤ç¼“å­˜æŒ‰é’®
              $('#clear-cache-btn').on('click', () => {
                this.clearCache();
              }),
              this.setupRulesModal(),
              this.setupLoadModal(),
              this.setupHistoryModal(),
              this.setupSettingsModal(),
              // åŠ è½½ä¿å­˜çš„å¤´åƒ
              this.loadProfileAvatar(),
              // è®¾ç½®MVUäº‹ä»¶ç›‘å¬å™¨
              this.setupMVUListeners(),
              document.addEventListener('fullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange()),
              document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange()),
              console.log('âœ… äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ'));
          });
        }

        async updateInterface() {
          try {
            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®

            const rightPanelContent = document.querySelector('.right-panel .panel-content');

            const leftPanelContent = document.querySelector('.left-panel .panel-content');

            const savedRightScrollTop = rightPanelContent ? rightPanelContent.scrollTop : 0;

            const savedLeftScrollTop = leftPanelContent ? leftPanelContent.scrollTop : 0;

            // ç«‹å³æ›´æ–°åŸºç¡€çŠ¶æ€

            (this.updateTrainerStatus(),
              this.updateUmaStatus(),
              this.updateTimeDisplay(),
              this.updateReplyTimer(),
              this.updateLocationImage(),
              this.initSexPositionSection(),
              this.updateSexPositionImage(),
              this.updateTaskList());

            // ğŸ”¥ æ›´æ–°è¿”å›å’Œé‡æ–°ç”ŸæˆæŒ‰é’®çš„çŠ¶æ€
            await this.updateBackRerollButtonsState();

            const e = Date.now();

            const lastUpdate = parseInt(localStorage.getItem('teresen_last_full_update') || '0');

            const isFirstLoad = lastUpdate === 0;

            const shouldUpdate = isFirstLoad || e - lastUpdate > 1e4;

            if (shouldUpdate) {
              console.log('ğŸ”„ æ‰§è¡Œå®Œæ•´ç•Œé¢æ›´æ–°...');
              const updateStart = performance.now();

              await this.updateStoryContent();

              const updateEnd = performance.now();
              console.log(
                `â±ï¸ [æ€§èƒ½] updateStoryContent åœ¨updateInterfaceä¸­è€—æ—¶: ${(updateEnd - updateStart).toFixed(2)}ms`,
              );

              this.updateInventory();

              this.updateRules();

              this.updateCurrencySystem();

              this.updateFestivalNotice();

              this.updateRulesCountdown();

              this.updateLocation();

              this.updateGachaCoin();

              localStorage.setItem('teresen_last_full_update', e.toString());

              console.log('âœ… å®Œæ•´ç•Œé¢æ›´æ–°å®Œæˆ');
            }

            // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°å®Œæˆï¼‰

            setTimeout(() => {
              if (rightPanelContent && savedRightScrollTop > 0) {
                rightPanelContent.scrollTop = savedRightScrollTop;
              }

              if (leftPanelContent && savedLeftScrollTop > 0) {
                leftPanelContent.scrollTop = savedLeftScrollTop;
              }
            }, 0);
          } catch (e) {
            console.error('æ›´æ–°ç•Œé¢æ—¶å‡ºé”™:', e);
          }
        }

        // æ–°å¢ï¼šå‚è€ƒé¡¹ç›®çš„updateDynamicDataæ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰åŠ¨æ€æ•°æ®éƒ½æ›´æ–°

        async updateDynamicData() {
          try {
            console.log('ğŸ”„ å¼€å§‹æ›´æ–°åŠ¨æ€æ•°æ®...');

            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰å…³é”®ç•Œé¢å…ƒç´ 

            this.updateTrainerStatus();

            this.updateUmaStatus();

            this.updateLocationImage();

            this.updateTaskList();

            this.updateSexPositionImage();

            // åˆå§‹åŒ–äººç‰©è¡¨æƒ…åŒºåŸŸï¼ˆå¦‚æœæ²¡æœ‰é€‰ä¸­é©¬å¨˜ï¼Œæ˜¾ç¤ºæç¤ºï¼‰
            this.showUmaExpression(null);

            this.updateTimeDisplay();

            this.updateReplyTimer();

            // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
            this.updateTaskList();

            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰é¢æ¿å†…å®¹

            await this.updateStoryContent();

            this.updateInventory();

            this.updateRules();

            this.updateCurrencySystem();

            this.updateFestivalNotice();

            this.updateRulesCountdown();

            this.updateLocation();

            this.updateGachaCoin();

            console.log('âœ… åŠ¨æ€æ•°æ®æ›´æ–°å®Œæˆ');
          } catch (error) {
            console.error('âŒ æ›´æ–°åŠ¨æ€æ•°æ®æ—¶å‡ºé”™:', error);
          }
        }

        getAllVariables() {
          // é‡è¦ï¼šä¼˜å…ˆä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®
          if (this.currentMvuState && this.currentMvuState.stat_data) {
            console.log('âœ… ä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®');
            return this.currentMvuState;
          }

          if ((console.group('ğŸ” è·å–å˜é‡è°ƒè¯•ä¿¡æ¯'), 'function' == typeof getAllVariables)) {
            console.log('âœ… getAllVariableså‡½æ•°å­˜åœ¨ï¼Œæ­£åœ¨è°ƒç”¨...');

            const e = getAllVariables();

            return (
              console.log('ğŸ“Š è·å–åˆ°çš„å˜é‡æ•°æ®:', e),
              e && e.stat_data
                ? (console.log('âœ… æ‰¾åˆ°stat_dataç»“æ„'),
                  console.log('ğŸƒ è®­ç»ƒå‘˜æ•°æ®:', e.stat_data.è®­ç»ƒå‘˜),
                  console.log('ğŸŒ ä¸–ç•Œæ•°æ®:', e.stat_data.ä¸–ç•Œ),
                  console.log('ğŸ é©¬å¨˜æ•°æ®:', e.stat_data.é©¬å¨˜),
                  e.stat_data.è§„åˆ™ && console.log('ğŸ“œ è§„åˆ™æ•°æ®:', e.stat_data.è§„åˆ™),
                  e.stat_data.å¤–ç¥ && console.log('ğŸ‘¹ å¤–ç¥æ•°æ®:', e.stat_data.å¤–ç¥))
                : (console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'), console.log('ğŸ” å®Œæ•´è¿”å›ç»“æœ:', e)),
              console.groupEnd(),
              e
            );
          }

          return (
            console.error('âŒ getAllVariableså‡½æ•°ä¸å­˜åœ¨'),
            console.log(
              'ğŸ” å½“å‰å…¨å±€å‡½æ•°:',

              Object.keys(window).filter(e => 'function' == typeof window[e]),
            ),
            console.groupEnd(),
            {}
          );
        }

        // æ–°å¢ï¼šç»Ÿä¸€çš„UIæ¸²æŸ“å‡½æ•°
        renderUI(data) {
          if (!data) {
            console.warn('RenderUI è°ƒç”¨å¤±è´¥ï¼šæ²¡æœ‰æä¾›æ•°æ®ã€‚');
            return;
          }

          console.log('ğŸ”„ å¼€å§‹æ¸²æŸ“UIï¼Œæ•°æ®:', data);

          try {
            // é‡è¦ï¼šå…ˆæ›´æ–°this.currentMvuStateï¼Œç¡®ä¿åç»­å‡½æ•°ä½¿ç”¨æœ€æ–°æ•°æ®
            if (this.currentMvuState && this.currentMvuState.stat_data) {
              console.log('âœ… ä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®æ¸²æŸ“UI');
              // å¼ºåˆ¶æ›´æ–°getAllVariablesçš„ç¼“å­˜
              this._forceRefreshVariables();
            }

            // æ›´æ–°è®­ç»ƒå‘˜çŠ¶æ€
            this.updateTrainerStatus();

            // æ›´æ–°é©¬å¨˜çŠ¶æ€
            this.updateUmaStatus();

            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            this.updateTimeDisplay();

            // æ›´æ–°å›å¤è®¡æ—¶å™¨
            this.updateReplyTimer();

            // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
            this.updateTaskList();

            // æ›´æ–°æ•…äº‹å†…å®¹
            this.updateStoryContent();

            // æ›´æ–°å…¶ä»–ç•Œé¢å…ƒç´ 
            this.updateInventory();
            this.updateRules();
            this.updateCurrencySystem();
            this.updateFestivalNotice();
            this.updateRulesCountdown();
            this.updateLocation();
            this.updateGachaCoin();

            console.log('âœ… UIæ¸²æŸ“å®Œæˆ');
          } catch (error) {
            console.error('âŒ UIæ¸²æŸ“å¤±è´¥:', error);
          }
        }

        // æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°å˜é‡çŠ¶æ€ï¼Œä½¿ç”¨MVUè¿”å›çš„æœ€æ–°æ•°æ®
        _forceRefreshVariables() {
          try {
            console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°å˜é‡çŠ¶æ€...');

            // å¦‚æœMVUè¿”å›äº†æ–°çŠ¶æ€ï¼Œå¼ºåˆ¶æ›´æ–°getAllVariablesçš„ç¼“å­˜
            if (this.currentMvuState && this.currentMvuState.stat_data) {
              console.log('âœ… æ£€æµ‹åˆ°MVUæ–°çŠ¶æ€ï¼Œå¼ºåˆ¶åˆ·æ–°å˜é‡');

              // è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥å¼ºåˆ¶åˆ·æ–°TavernHelperçš„å˜é‡ç¼“å­˜
              // æˆ–è€…ç›´æ¥ä½¿ç”¨this.currentMvuStateä¸­çš„æ•°æ®

              console.log('ğŸ“Š MVUæ–°çŠ¶æ€æ•°æ®:', this.currentMvuState.stat_data);
            }
          } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆ·æ–°å˜é‡å¤±è´¥:', error);
          }
        }

        updateTrainerStatus() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ä½“åŠ›', 100),
            n = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º', 100),
            s = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.è¿æ°”', 50),
            o = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', 0),
            b = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.èƒŒæ™¯', 'æ— '),
            talent = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', 'æ— '),
            title = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç§°å·', 'åˆå…¥ä¸–ç•Œ');

          // è‡ªæ§ï¼šå‚è€ƒç†æ™ºå’Œä½“åŠ›çš„è·å–æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨stat_data
          const selfControl = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.è‡ªæ§', 100);

          // åŠ›é‡ï¼šå‚è€ƒç†æ™ºå’Œä½“åŠ›çš„è·å–æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨stat_data
          const power = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.åŠ›é‡', 5);

          // æŠ€å·§ï¼šå‚è€ƒç†æ™ºå’Œä½“åŠ›çš„è·å–æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨stat_data
          const skill = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.æŠ€å·§', 5);

          // è¯»å–ç»“æ™¶ - ä½¿ç”¨å’Œä½ç½®ã€æ—¶é—´ç›¸åŒçš„æ–¹å¼
          const crystalsValue = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', 0);
          const crystals = parseInt(crystalsValue) || 0;

          // è°ƒè¯•ä¿¡æ¯
          if (crystals === 0 && e && e.stat_data && e.stat_data.è®­ç»ƒå‘˜) {
            console.log('ğŸ’ ç»“æ™¶è¯»å–è°ƒè¯•:', {
              crystalsValue: crystalsValue,
              parsed: crystals,
              hasTrainer: !!e.stat_data.è®­ç»ƒå‘˜,
              crystalsArray: e.stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶,
              crystalsArrayType: typeof e.stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶,
              isArray: Array.isArray(e.stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶),
            });
          }

          // æ›´æ–°è¿›åº¦æ¡é¢œè‰²

          this.updateProgressBar('stamina-bar', 'stamina-value', t, this.getStaminaColor(t));

          this.updateProgressBar('sanity-bar', 'sanity-value', n, this.getSanityColor(n));

          this.updateProgressBar(
            'self-control-bar',
            'self-control-value',
            selfControl,
            this.getSelfControlColor(selfControl),
          );

          this.updateProgressBar('luck-bar', 'luck-value', s, this.getLuckColor(s));

          // åŠ›é‡ã€æŠ€å·§åªæ›´æ–°æ•°å€¼ï¼Œä¸æ›´æ–°è¿›åº¦æ¡
          const powerValueEl = document.getElementById('power-value');
          if (powerValueEl) powerValueEl.textContent = power;

          const skillValueEl = document.getElementById('skill-value');
          if (skillValueEl) skillValueEl.textContent = skill;

          const a = document.getElementById('trainer-status'),
            l = document.getElementById('days-in-park'),
            bg = document.getElementById('trainer-background'),
            cry = document.getElementById('trainer-crystals'),
            titleEl = document.getElementById('trainer-title');

          // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œæ ·å¼

          if (a) {
            const statusText = this.getTrainerStatusText(n, t);

            a.textContent = statusText;

            a.className = `value ${this.getTrainerStatusClass(n, t)}`;
          }

          // æ›´æ–°åœ¨æ ¡å¤©æ•°

          if (l) {
            l.textContent = `${o}å¤©`;
          }

          // æ›´æ–°ç§°å·

          if (titleEl) {
            titleEl.textContent = title || 'åˆå…¥ä¸–ç•Œ';
          }

          // æ›´æ–°è®­ç»ƒå‘˜èƒŒæ™¯

          if (bg) {
            bg.textContent = b;
          }

          // æ›´æ–°ç•¸å½¢æƒ…æ„Ÿç»“æ™¶

          if (cry) {
            cry.textContent = crystals;
          }
        }

        updateUmaStatus() {
          const e = document.getElementById('uma-status');

          if (!e) return;

          const t = this.getAllVariables();

          console.log('ğŸ” æ‰€æœ‰å˜é‡:', t);

          const n = this.getVariable(t, 'stat_data.é©¬å¨˜', {});

          if ((console.log('ğŸ é©¬å¨˜æ•°æ®:', n), !n || 0 === Object.keys(n).length))
            return void (e.innerHTML = '<div class="empty-uma">æš‚æ— é©¬å¨˜æ•°æ®</div>');

          // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨uma-contentï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º

          let umaContent = e.querySelector('.uma-content');

          if (!umaContent) {
            e.innerHTML = '<div class="uma-content"></div>';

            umaContent = e.querySelector('.uma-content');
          }

          // æ›´æ–°ç°æœ‰çš„é©¬å¨˜é¡¹ç›®ï¼Œè€Œä¸æ˜¯é‡æ–°ç”Ÿæˆæ•´ä¸ªHTML

          Object.keys(n).forEach((umaName, index) => {
            // è‡ªåŠ¨æ·»åŠ åˆ°é©¬å¨˜è®°åå†Œï¼ˆåªåœ¨é¦–æ¬¡é‡åˆ°æ—¶æ·»åŠ ï¼‰
            if (window.teresenDebug && window.teresenDebug.addUmaToRoster && !this.umaRosterAdded.has(umaName)) {
              window.teresenDebug.addUmaToRoster(umaName, {
                notes: `é¦–æ¬¡é‡åˆ°: ${new Date().toLocaleString('zh-CN')}`,
              });
              this.umaRosterAdded.add(umaName);
            }

            const n = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.å¥½æ„Ÿåº¦`, 20),
              o = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.çŠ¶æ€`, 'æ­£å¸¸'),
              a = this.getUmaDescription(umaName, n, o),
              l = this.getUmaStatusClass(o),
              r = Math.max(1, Math.floor(n / 20)),
              i = this.getUmaAvatar(umaName),
              c = this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´', '06:00'),
              d = this.getTimeDangerLevel(c),
              g = this.getVariable(t, `stat_data.é©¬å¨˜.${umaName}.ç‹¬å åº¦`, 0),
              u = this.getAvatarStyle(g, d);

            // æŸ¥æ‰¾æˆ–åˆ›å»ºé©¬å¨˜é¡¹ç›®

            let umaItem = umaContent.children[index];

            if (!umaItem) {
              umaItem = document.createElement('div');

              umaItem.className = 'uma-item';

              umaContent.appendChild(umaItem);
            }

            // æ ¹æ®å¥½æ„Ÿåº¦å’Œç‹¬å åº¦è®¡ç®—åŠ¨æ€æ ·å¼

            const nameColor = this.getUmaNameColor(n, g);

            const statusColor = this.getUmaStatusColor(o, g, index);

            const statusBackground = this.getStatusBackgroundColor(o, g, index);

            // æ›´æ–°é©¬å¨˜é¡¹ç›®çš„å†…å®¹

            umaItem.innerHTML = `

              <div class="uma-header">

                                  <div class="uma-info">

                    ${i ? `<img src="${i}" alt="${umaName}" class="uma-avatar" style="${u}">` : ''}

                    <div class="uma-text-info">

                      <div class="uma-name" style="color: ${nameColor}">${umaName}</div>
                      <div class="uma-status-text" style="color: ${statusColor}">${o}</div>

                    </div>

                  </div>

              </div>

              <div class="uma-desc">${a}</div>

              <div class="uma-hearts">

                ${this.generateHeartIcons(r)}

              </div>

            `;

            // è®¾ç½®åŸºç¡€èƒŒæ™¯è‰²
            umaItem.style.setProperty('background', '#fdfbf7', 'important');
            umaItem.style.setProperty('background-color', '#fdfbf7', 'important');

            // æ ¹æ®ç‹¬å åº¦æ·»åŠ JavaScriptç»˜åˆ¶çš„èŠ±æœµ

            if (g > 30) {
              // åˆ›å»ºcanvaså…ƒç´ æ¥ç»˜åˆ¶èŠ±æœµ

              const canvas = document.createElement('canvas');

              canvas.width = 200;

              canvas.height = 200;

              canvas.style.cssText = `

                position: absolute;

                top: 50%;

                right: -20px;

                transform: translateY(-50%);

                width: 80px;

                height: 80px;

                pointer-events: none;

                z-index: 1;

                opacity: 0.4;

                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));

              `;

              const ctx = canvas.getContext('2d');

              const progress = g / 100;

              // ç»˜åˆ¶èŠ±æœµ - å‚è€ƒèƒŒæ™¯å›¾ç‰‡çš„æ ·å¼

              ctx.save();

              ctx.translate(100, 100);

              // æ ¹æ®ç‹¬å åº¦ç¡®å®šé¢œè‰²å’Œæ ·å¼

              let flowerColor, petalCount, petalSize;

              if (g > 90) {
                // 90-100%: æ·±çº¢è‰²å¤æ‚èŠ±æœµ

                flowerColor = '#8B0000';

                petalCount = 8;

                petalSize = 25;
              } else if (g > 80) {
                // 80-90%: çº¢è‰²èŠ±æœµ

                flowerColor = '#DC143C';

                petalCount = 7;

                petalSize = 25;
              } else if (g > 70) {
                // 70-80%: æµ…çº¢è‰²èŠ±æœµ

                flowerColor = '#EF4444';

                petalCount = 6;

                petalSize = 25;
              } else if (g > 60) {
                // 60-70%: ç²‰çº¢è‰²èŠ±æœµ

                flowerColor = '#F87171';

                petalCount = 6;

                petalSize = 25;
              } else if (g > 50) {
                // 50-60%: æµ…ç²‰è‰²èŠ±æœµ

                flowerColor = '#FCA5A5';

                petalCount = 5;

                petalSize = 25;
              } else if (g > 40) {
                // 40-50%: ç™½è‰²èŠ±æœµ

                flowerColor = '#FFFFFF';

                petalCount = 5;

                petalSize = 25;
              } else {
                // 30-40%: å¾ˆæ·¡çš„ç™½è‰²èŠ±æœµ

                flowerColor = '#FFFFFF';

                petalCount = 4;

                petalSize = 25;
              }

              // ç»˜åˆ¶èŠ±ç“£ - ä½¿ç”¨æ›´è‡ªç„¶çš„æ›²çº¿

              for (let i = 0; i < petalCount; i++) {
                ctx.save();

                ctx.rotate(((Math.PI * 2) / petalCount) * i);

                ctx.beginPath();

                ctx.moveTo(0, 0);

                // ä½¿ç”¨è´å¡å°”æ›²çº¿åˆ›å»ºæ›´è‡ªç„¶çš„èŠ±ç“£å½¢çŠ¶

                ctx.bezierCurveTo(
                  petalSize * 0.3,
                  -petalSize * 0.4,

                  petalSize * 0.7,
                  -petalSize * 0.3,

                  petalSize * 0.8,
                  0,
                );

                ctx.bezierCurveTo(
                  petalSize * 0.7,
                  petalSize * 0.3,

                  petalSize * 0.3,
                  petalSize * 0.4,

                  0,
                  0,
                );

                ctx.fillStyle = flowerColor;

                ctx.fill();

                // æ·»åŠ èŠ±ç“£è¾¹ç¼˜çš„ç»†èŠ‚

                ctx.strokeStyle = flowerColor;

                ctx.lineWidth = 1;

                ctx.stroke();

                ctx.restore();
              }

              // ç»˜åˆ¶èŠ±å¿ƒ

              ctx.beginPath();

              ctx.arc(0, 0, 8, 0, Math.PI * 2);

              ctx.fillStyle = flowerColor;

              ctx.fill();

              // æ·»åŠ èŠ±å¿ƒç»†èŠ‚

              ctx.beginPath();

              ctx.arc(0, 0, 4, 0, Math.PI * 2);

              ctx.fillStyle = '#FFF';

              ctx.fill();

              ctx.restore();

              // å°†èŠ±æœµæ·»åŠ åˆ°æè¿°åŒºåŸŸçš„æœ€å³è¾¹

              const descElement = umaItem.querySelector('.uma-desc');

              if (descElement) {
                descElement.style.position = 'relative';

                descElement.appendChild(canvas);
              } else {
                // å¦‚æœæ‰¾ä¸åˆ°æè¿°å…ƒç´ ï¼Œåˆ™æ·»åŠ åˆ°æ•´ä¸ªå¡ç‰‡

                umaItem.style.position = 'relative';

                umaItem.appendChild(canvas);
              }
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»å¡ç‰‡æ—¶åœ¨å³ä¾§äººç‰©è¡¨æƒ…åŒºåŸŸæ˜¾ç¤ºå¯¹åº”äººç‰©çš„è¡¨æƒ…
            umaItem.style.cursor = 'pointer';
            umaItem.setAttribute('data-uma-name', umaName);
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹æ¥æ¸…é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œdeep cloneåŒ…å«æ‰€æœ‰å­å…ƒç´ å’Œcanvasï¼‰
            const newUmaItem = umaItem.cloneNode(true);
            umaItem.parentNode.replaceChild(newUmaItem, umaItem);
            // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶ - ğŸ”¥ ä¿®å¤å†²çªï¼šä¼˜å…ˆå¤„ç†èµ é€/æŠ€èƒ½ï¼Œå¦åˆ™å±•ç¤ºè¡¨æƒ…
            newUmaItem.addEventListener('click', e => {
              // æ£€æŸ¥æ˜¯å¦åœ¨èµ é€é€‰æ‹©æ¨¡å¼
              if (window.giftSelectionMode && window.giftSelectionMode.active) {
                // èµ é€æ¨¡å¼ç”±gift-selectableå¤„ç†ï¼Œè¿™é‡Œä¸é˜»æ­¢
                return;
              }
              // æ£€æŸ¥æ˜¯å¦åœ¨æŠ€èƒ½é€‰æ‹©æ¨¡å¼
              if (window.skillSelectionMode && window.skillSelectionMode.active) {
                // æŠ€èƒ½æ¨¡å¼ç”±skill-selectableå¤„ç†ï¼Œè¿™é‡Œä¸é˜»æ­¢
                return;
              }
              // å¦åˆ™å±•ç¤ºè¡¨æƒ…
              e.stopPropagation();
              this.showUmaExpression(umaName);
            });
          });

          // ç§»é™¤å¤šä½™çš„é©¬å¨˜é¡¹ç›®

          while (umaContent.children.length > Object.keys(n).length) {
            umaContent.removeChild(umaContent.lastChild);
          }

          // æ›´æ–°QTEåŒºåŸŸçŠ¶æ€

          this.updateQTESection();
        }

        // æ–°å¢ï¼šè·å–çŠ¶æ€è£…é¥°å›¾æ ‡
        getStatusDecoration(status, exclusiveLevel) {
          const decorations = {
            æ­£å¸¸: 'ğŸŒ¸', // æ¨±èŠ± - ä»£è¡¨æ­£å¸¸çŠ¶æ€
            ç‹¬å : 'ğŸŒ¹', // ç«ç‘° - ä»£è¡¨ç‹¬å çŠ¶æ€
            å¤±è¸ª: 'ğŸŒ™', // æœˆäº® - ä»£è¡¨å¤±è¸ªçŠ¶æ€
            æ··ä¹±: 'ğŸŒ€', // æ¼©æ¶¡ - ä»£è¡¨æ··ä¹±çŠ¶æ€
            è­¦æˆ’: 'âš ï¸', // è­¦å‘Š - ä»£è¡¨è­¦æˆ’çŠ¶æ€
            ç—…å¨‡: 'ğŸ’€', // éª·é«… - ä»£è¡¨ç—…å¨‡çŠ¶æ€
            default: 'âœ¨', // é»˜è®¤è£…é¥°
          };

          // æ ¹æ®ç‹¬å åº¦è°ƒæ•´è£…é¥°
          if (exclusiveLevel > 80) {
            return 'ğŸ”¥'; // é«˜ç‹¬å åº¦ç”¨ç«ç„°
          } else if (exclusiveLevel > 60) {
            return 'â­'; // ä¸­é«˜ç‹¬å åº¦ç”¨æ˜Ÿæ˜Ÿ
          } else if (exclusiveLevel > 40) {
            return 'ğŸ’'; // ä¸­ç‹¬å åº¦ç”¨é’»çŸ³
          }

          return decorations[status] || decorations['default'];
        }

        getUmaAvatar(e) {
          return (
            {
              çˆ±ä¸½æ•°ç : 'https://files.catbox.moe/d70ku1.png',

              çˆ±ä¸½é€Ÿå­: 'https://files.catbox.moe/3r2gqv.png',

              çˆ±æ…•ç»‡å§¬: 'https://files.catbox.moe/wc144f.png',

              çˆ±å¦‚å¾€æ˜”: 'https://files.catbox.moe/j7set1.png',

              å…«é‡æ— æ•Œ: 'https://files.catbox.moe/fuvyvk.png',

              åŒ—éƒ¨ç„é©¹: 'https://files.catbox.moe/d7990k.png',

              åŒ—æ¸¯ç«å±±: 'https://files.catbox.moe/21rq96.png',

              è‰ä¸Šé£: 'https://files.catbox.moe/jevm3a.png',

              è¶…çº§å°æµ·æ¹¾: 'https://files.catbox.moe/x3ee0m.png',

              æˆç”°ç™½ä»: 'https://files.catbox.moe/75oai9.png',

              æˆç”°è·¯: 'https://files.catbox.moe/90ws3a.png',

              åˆ›å‡: 'https://files.catbox.moe/19o3se.png',

              åˆ›ä¸–é©¹: 'https://files.catbox.moe/1xs8sb.png',

              æ˜¥ç”°ä¹Œæ‹‰æ‹‰: 'https://files.catbox.moe/nvz9k4.png',

              å¤§å’Œèµ¤éª¥: 'https://files.catbox.moe/8ffgfq.png',

              å¤§é¸£å¤§æ”¾: 'https://files.catbox.moe/unxq4t.png',

              å¤§æ ‘å¿«è½¦: 'https://files.catbox.moe/5jg2l4.png',

              å¤§æ‹“å¤ªé˜³ç¥: 'https://files.catbox.moe/c7z8tt.png',

              å¾…å…¼ç¦æ¥: 'https://files.catbox.moe/v4dt95.png',

              å¸ç‹å…‰ç¯: 'https://files.catbox.moe/b04n2e.png',

              ç¬¬ä¸€çº¢å®çŸ³: 'https://files.catbox.moe/j5as90.png',

              ä¸œæµ·å¸ç‹: 'https://files.catbox.moe/r0i1vk.png',

              ä¸œå•†å˜é©: 'https://files.catbox.moe/02229w.png',

              å¤šæ—ºè¾¾: 'https://files.catbox.moe/8smudh.png',

              ä¼ç‰¹åŠ : 'https://files.catbox.moe/mef00p.png',

              é«˜å°šéªé€¸: 'https://files.catbox.moe/jp4src.png',

              è‘›åŸç‹ç‰Œ: 'https://files.catbox.moe/twqi3m.png',

              è´µå¦‡äºº: 'https://files.catbox.moe/9myg2p.png',

              å¥½æ­Œå‰§: 'https://files.catbox.moe/ymxboj.png',

              è’æ¼ è‹±é›„: 'https://files.catbox.moe/y61wwa.png',

              é»„é‡‘åŸå¸‚: 'https://files.catbox.moe/832mml.png',

              é»„é‡‘èˆ¹: 'https://files.catbox.moe/puxu1y.png',

              é»„é‡‘å·¨åŒ : 'https://files.catbox.moe/lg6d5i.png',

              æå³°: 'https://files.catbox.moe/j282j7.png',

              é‡‘é•‡ä¹‹å…‰: 'https://files.catbox.moe/4lx5nv.png',

              éªå·æ‰‹çº²: 'https://files.catbox.moe/7apiow.png',

              å‡¯æ—‹èŠ­è•¾: 'https://files.catbox.moe/rdldum.png',

              é‡Œè§å…‰é’»: 'https://files.catbox.moe/meq8kw.png',

              é‡Œè§çš‡å† : 'https://files.catbox.moe/mvmeuq.png',

              è±é’»å¥‡å®: 'https://files.catbox.moe/xm3tws.png',

              é²é“å¤«è±¡å¾: 'https://files.catbox.moe/zogjie.png',

              æ›¼åŸèŒ¶åº§: 'https://files.catbox.moe/8s8ow2.png',

              ç¾å¦™å§¿åŠ¿: 'https://files.catbox.moe/j4gt6b.png',

              ç¾æµ¦æ³¢æ—: 'https://files.catbox.moe/1dtwml.png',

              æ¢¦ä¹‹æ—…: 'https://files.catbox.moe/1k3mhi.png',

              è¿·äººæ™¯è‡´: 'https://files.catbox.moe/8x3cjc.png',

              ç±³æµ´: 'https://files.catbox.moe/c3gtgi.png',

              åå°†æ€’æ¶›: 'https://files.catbox.moe/xwghd4.png',

              æ‘©è€¶é‡ç‚®: 'https://files.catbox.moe/czbbvd.png',

              è°‹å‹‡å…¼å¤‡: 'https://files.catbox.moe/eq4zkw.png',

              ç›®ç™½é˜¿å°”ä¸¹: 'https://files.catbox.moe/ob99q8.png',

              ç›®ç™½å¤šä¼¯: 'https://files.catbox.moe/gbvkte.png',

              ç›®ç™½é«˜å³°: 'https://files.catbox.moe/iysgye.png',

              ç›®ç™½å…‰æ˜: 'https://files.catbox.moe/8d1iwy.png',

              ç›®ç™½éº¦æ˜†: 'https://files.catbox.moe/tpep4q.png',

              ç›®ç™½å–„ä¿¡: 'https://files.catbox.moe/p7t876.png',

              å¥‡é”éª: 'https://files.catbox.moe/6asj2q.png',

              æ°”æ§½: 'https://files.catbox.moe/bk7n8x.png',

              åƒæ˜ä»£è¡¨: 'https://files.catbox.moe/0q627d.png',

              å¼ºå‡»: 'https://files.catbox.moe/vzxfrt.png',

              é’äº‘å¤©ç©º: 'https://files.catbox.moe/5xrxk5.png',

              ç§‹å·å¼¥ç”Ÿ: 'https://files.catbox.moe/2mr9zz.png',

              è£è¿›é—ªè€€: 'https://files.catbox.moe/87lcsh.png',

              æ£®æ—å®ç©´: 'https://files.catbox.moe/50rq7n.png',

              ç¥é¹°: 'https://files.catbox.moe/1bch4y.png',

              åŒæ¶¡è½®: 'https://files.catbox.moe/ffi15d.png',

              ç‰¹åˆ«å‘¨: 'https://files.catbox.moe/waylx3.png',

              å¤©ç‹¼æ˜Ÿè±¡å¾: 'https://files.catbox.moe/457y2f.png',

              ä¸¸å–„æ–¯åŸº: 'https://files.catbox.moe/jujcy2.png',

              æ— å£°é“ƒé¹¿: 'https://files.catbox.moe/s6pnkl.png',

              è¥¿é‡èŠ±: 'https://files.catbox.moe/4qzhsz.png',

              å°æ —å¸½: 'https://files.catbox.moe/nmgyj9.png',

              å°æ—å†å¥‡: 'https://files.catbox.moe/sd03xi.png',

              æ–°å®‡å®™: 'https://files.catbox.moe/zaad8r.png',

              æç›®: 'https://files.catbox.moe/vejrmc.png',

              æ¨±èŠ±åƒä»£ç‹: 'https://files.catbox.moe/a3g3gf.png',

              ç‰è—»åå­—: 'https://files.catbox.moe/5g6z60.png',

              çœŸå¼“å¿«è½¦: 'https://files.catbox.moe/unihzk.png',

              çœŸæœºä¼¶: 'https://files.catbox.moe/5y8jxf.png',

              ä¸­å±±åº†å…¸: 'https://files.catbox.moe/x8az97.png',

              å‘¨æ—¥å®é™: 'https://files.catbox.moe/uccqyf.png',

              å“èŠ™: 'https://files.catbox.moe/syhdp7.png',

              è¾¾åˆ©é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/c2ldl4.png',

              é«˜å¤šèŠ¬é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/x2unca.png',

              é»„é‡‘æ—…ç¨‹: 'https://files.catbox.moe/ebrxrn.png',

              è‰¾å°¼æ–¯é£ç¥: 'https://files.catbox.moe/nnd19a.png',

              å¯Œå£«å¥‡çŸ³: 'https://files.catbox.moe/2p60gy.png',

              è±äºšé©¬é€Š: 'https://files.catbox.moe/xeeyrl.png',

              èƒœåˆ©å¥–åˆ¸: 'https://files.catbox.moe/lnhtai.png',

              è¶…å¸¸éªéª¥: 'https://files.catbox.moe/ek7uj0.png',
            }[e] || null
          );
        }

        // è·å–æ€§çˆ±å§¿åŠ¿å›¾ç‰‡ï¼ˆæ ¹æ®å§¿åŠ¿åç§°ï¼‰
        getSexPositionImage(positionName) {
          if (!positionName) {
            // é»˜è®¤è¿”å›"å¥³ä¸Šä½é‡å¤"
            return 'https://files.catbox.moe/6386xs.gif';
          }

          // ğŸ”¥ å®Œæ•´çš„å§¿åŠ¿å›¾ç‰‡æ˜ å°„ï¼ˆåŒ…å«æ‰€æœ‰æ–°å›¾ç‰‡ï¼‰
          const positionMap = {
            // åŸºç¡€äº’åŠ¨ä¸è°ƒæƒ…
            äº¤è°ˆ: 'https://files.catbox.moe/4xl6g6.png',
            è°ƒæƒ…: 'https://files.catbox.moe/4xl6g6.png',
            æ¥å»: 'https://files.catbox.moe/4xl6g6.png',
            æŠšæ‘¸è€³æœµ: 'https://files.catbox.moe/4xl6g6.png',
            çˆ±æŠšå¤§è…¿: 'https://files.catbox.moe/4xl6g6.png',
            çˆ±æŠšå°¾å·´: 'https://files.catbox.moe/4xl6g6.png',
            çˆ±æŠšèƒ¸éƒ¨: 'https://files.catbox.moe/lyrkgb.gif',
            çˆ±æŠšé˜´æ ¸: 'https://files.catbox.moe/4xl6g6.png',
            æ‰‹æŒ‡æ’å…¥: 'https://files.catbox.moe/4xl6g6.png',

            // å±€éƒ¨æ€§è¡Œä¸º
            æ‰‹äº¤: 'https://files.catbox.moe/sttoic.gif',
            å£äº¤: 'https://files.catbox.moe/dglho3.gif',
            æ·±å–‰: 'https://files.catbox.moe/bbezbz.gif',
            æ·±å–‰å£äº¤: 'https://files.catbox.moe/bbezbz.gif',
            æŒ‰å¤´å£äº¤: 'https://files.catbox.moe/2xu3gl.gif',
            èˆŒäº¤: 'https://files.catbox.moe/dglho3.gif',
            ä¹³äº¤: 'https://files.catbox.moe/qzhy79.gif',
            ä¹³å¤¹å£äº¤: 'https://files.catbox.moe/qzhy79.gif',
            è¶³äº¤: 'https://files.catbox.moe/3jmnfs.gif',
            ç´ è‚¡: 'https://files.catbox.moe/7fznxn.gif',
            èˆ”è‚›ä¾å¥‰: 'https://files.catbox.moe/4xl6g6.png',
            è‚‰æ£’æ‰“è„¸: 'https://files.catbox.moe/k8mjcl.gif',

            // æ­£å¼ä½“ä½ - å¸¸è§„
            æ­£å¸¸ä½: 'https://files.catbox.moe/ha9710.gif',
            æ­£å¸¸ä½æ’å…¥: 'https://files.catbox.moe/9lyaet.png',
            ä¸­å‡ºæ­£å¸¸ä½: 'https://files.catbox.moe/h7zf71.gif',
            æŒ‰ç€ä¸­å‡ºæ­£å¸¸ä½: 'https://files.catbox.moe/ha9710.gif',
            åèƒŒä½: 'https://files.catbox.moe/ync9or.gif',
            åå…¥: 'https://files.catbox.moe/ync9or.gif',
            å¯¹é¢åä½: 'https://files.catbox.moe/ue4bj4.gif',
            èƒŒé¢åä½: 'https://files.catbox.moe/jpentm.gif',
            èƒŒå¯¹å¥³ä¸Š: 'https://files.catbox.moe/jpentm.gif',
            å¯¹é¢ç«‹ä½: 'https://files.catbox.moe/vdlsy0.gif',
            èƒŒé¢ç«‹ä½: 'https://files.catbox.moe/vdlsy0.gif',
            ç«‹ä½å•è…¿æ”¯æ’‘: 'https://files.catbox.moe/61uy8w.gif',
            å…­ä¹å¼: 'https://files.catbox.moe/gdc9ge.gif',
            '69å¼': 'https://files.catbox.moe/gdc9ge.gif',
            å¥³ä¸Šä½: 'https://files.catbox.moe/6386xs.gif',
            å¥³ä¸Šä½æ’å…¥: 'https://files.catbox.moe/6kjny0.gif',
            å¥³ä¸Šä½å°„ç²¾: 'https://files.catbox.moe/0ess4j.gif',
            å¥³ä¸Šä½é‡å¤: 'https://files.catbox.moe/6386xs.gif',
            å¥³ä¸Šä½ç´ è‚¡: 'https://files.catbox.moe/7fznxn.gif',
            æ³³è£…å¥³ä¸Šä½: 'https://files.catbox.moe/zi9cwm.gif',
            å¥³ä¸ŠèƒŒå¯¹åå§¿æ‰“æ¡©: 'https://files.catbox.moe/nshpes.gif',
            æŠ±ç€æ“: 'https://files.catbox.moe/mygqgs.gif',

            // æ­£å¼ä½“ä½ - è‚›äº¤
            æ­£å¸¸ä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            åèƒŒä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            å¯¹é¢åä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            èƒŒé¢åä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            å¯¹é¢ç«‹ä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            èƒŒé¢ç«‹ä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',
            å¥³ä¸Šä½è‚›äº¤: 'https://files.catbox.moe/qav7rm.gif',

            // çŠ¶æ€ç›¸å…³
            æ ‡å‡†çŠ¶æ€: 'https://files.catbox.moe/4xl6g6.png',
            æ ‡å‡†çŠ¶æ€_æ’å…¥: 'https://files.catbox.moe/9lyaet.png',
            ç²¾æ¶²å°‘: 'https://files.catbox.moe/9k7svg.png',
            ç²¾æ¶²å°‘_æ’å…¥: 'https://files.catbox.moe/kpax3j.png',
            ç²¾æ¶²ä¸­: 'https://files.catbox.moe/rjd0lb.png',
            ç²¾æ¶²ä¸­_æ’å…¥: 'https://files.catbox.moe/hduhkb.png',
            ç²¾æ¶²å¤š: 'https://files.catbox.moe/j3jca9.png',
            ç²¾æ¶²å¤š_æ’å…¥: 'https://files.catbox.moe/2n42h7.png',
            å±é™©æœŸ: 'https://files.catbox.moe/ceobkd.png',
            å±é™©æœŸ_æ’å…¥: 'https://files.catbox.moe/svd5vs.png',
            æ’åµæœŸ: 'https://files.catbox.moe/aefbia.png',
            æ’åµæœŸ_æ’å…¥: 'https://files.catbox.moe/dd7gji.png',
            å—ç²¾: 'https://files.catbox.moe/4hqguy.png',
            å—ç²¾_æ’å…¥: 'https://files.catbox.moe/jz01gj.png',
            å¦Šå¨ : 'https://files.catbox.moe/jnd52k.png',
            å¦Šå¨ _æ’å…¥: 'https://files.catbox.moe/arfyv1.png',
            ä¸´ç›†: 'https://files.catbox.moe/5bjfv3.png',
            ä¸´ç›†_æ’å…¥: 'https://files.catbox.moe/c5omi0.png',
          };

          // ç²¾ç¡®åŒ¹é…
          if (positionMap[positionName]) {
            return positionMap[positionName];
          }

          // ä¼˜å…ˆåŒ¹é…æ›´å…·ä½“çš„å…³é”®è¯ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
          const priorityKeywords = [
            { keyword: 'ä¸´ç›†', image: 'https://files.catbox.moe/5bjfv3.png' },
            { keyword: 'å¦Šå¨ ', image: 'https://files.catbox.moe/jnd52k.png' },
            { keyword: 'å—ç²¾', image: 'https://files.catbox.moe/4hqguy.png' },
            { keyword: 'æ’åµæœŸ', image: 'https://files.catbox.moe/aefbia.png' },
            { keyword: 'å±é™©æœŸ', image: 'https://files.catbox.moe/ceobkd.png' },
            { keyword: 'ç²¾æ¶²å¤š', image: 'https://files.catbox.moe/j3jca9.png' },
            { keyword: 'ç²¾æ¶²ä¸­', image: 'https://files.catbox.moe/rjd0lb.png' },
            { keyword: 'ç²¾æ¶²å°‘', image: 'https://files.catbox.moe/9k7svg.png' },
            { keyword: 'æŒ‰ç€ä¸­å‡º', image: 'https://files.catbox.moe/ha9710.gif' },
            { keyword: 'ä¸­å‡ºæ­£å¸¸ä½', image: 'https://files.catbox.moe/h7zf71.gif' },
            { keyword: 'ä¸­å‡º', image: 'https://files.catbox.moe/h7zf71.gif' },
            { keyword: 'å¥³ä¸ŠèƒŒå¯¹åå§¿', image: 'https://files.catbox.moe/nshpes.gif' },
            { keyword: 'æ³³è£…å¥³ä¸Šä½', image: 'https://files.catbox.moe/zi9cwm.gif' },
            { keyword: 'ç«‹ä½å•è…¿', image: 'https://files.catbox.moe/61uy8w.gif' },
            { keyword: '69å¼', image: 'https://files.catbox.moe/gdc9ge.gif' },
            { keyword: 'å…­ä¹å¼', image: 'https://files.catbox.moe/gdc9ge.gif' },
            { keyword: 'æŒ‰å¤´å£äº¤', image: 'https://files.catbox.moe/2xu3gl.gif' },
            { keyword: 'æ·±å–‰å£äº¤', image: 'https://files.catbox.moe/bbezbz.gif' },
            { keyword: 'æ·±å–‰', image: 'https://files.catbox.moe/bbezbz.gif' },
            { keyword: 'è‚‰æ£’æ‰“è„¸', image: 'https://files.catbox.moe/k8mjcl.gif' },
            { keyword: 'æŠ±ç€æ“', image: 'https://files.catbox.moe/mygqgs.gif' },
            { keyword: 'èƒŒå¯¹å¥³ä¸Š', image: 'https://files.catbox.moe/jpentm.gif' },
            { keyword: 'èƒŒé¢åä½', image: 'https://files.catbox.moe/jpentm.gif' },
            { keyword: 'å¯¹é¢åä½', image: 'https://files.catbox.moe/ue4bj4.gif' },
            { keyword: 'å¯¹é¢ç«‹ä½', image: 'https://files.catbox.moe/vdlsy0.gif' },
            { keyword: 'èƒŒé¢ç«‹ä½', image: 'https://files.catbox.moe/vdlsy0.gif' },
            { keyword: 'åå…¥', image: 'https://files.catbox.moe/ync9or.gif' },
            { keyword: 'åèƒŒä½', image: 'https://files.catbox.moe/ync9or.gif' },
            { keyword: 'è‚›äº¤', image: 'https://files.catbox.moe/qav7rm.gif' },
            { keyword: 'ä¹³äº¤', image: 'https://files.catbox.moe/qzhy79.gif' },
            { keyword: 'ç´ è‚¡', image: 'https://files.catbox.moe/7fznxn.gif' },
            { keyword: 'å°„ç²¾', image: 'https://files.catbox.moe/0ess4j.gif' },
            { keyword: 'æ’å…¥', image: 'https://files.catbox.moe/9lyaet.png' },
            { keyword: 'æ‰‹äº¤', image: 'https://files.catbox.moe/sttoic.gif' },
            { keyword: 'å£äº¤', image: 'https://files.catbox.moe/dglho3.gif' },
            { keyword: 'è¶³äº¤', image: 'https://files.catbox.moe/3jmnfs.gif' },
            { keyword: 'çˆ±æŠšèƒ¸éƒ¨', image: 'https://files.catbox.moe/lyrkgb.gif' },
            { keyword: 'æ­£å¸¸ä½', image: 'https://files.catbox.moe/ha9710.gif' },
            { keyword: 'å¥³ä¸Šä½', image: 'https://files.catbox.moe/6386xs.gif' },
          ];

          // æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥å…³é”®è¯
          for (const item of priorityKeywords) {
            if (positionName.includes(item.keyword)) {
              return item.image;
            }
          }

          // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œè¿”å›é»˜è®¤çš„"å¥³ä¸Šä½é‡å¤"
          return 'https://files.catbox.moe/6386xs.gif';
        }

        // æ›´æ–°æ€§çˆ±å§¿åŠ¿å›¾ç‰‡æ˜¾ç¤º
        updateSexPositionImage() {
          const allVariables = this.getAllVariables();
          const position = this.getVariable(allVariables, 'stat_data.è®­ç»ƒå‘˜.æ€§çˆ±å§¿åŠ¿', '');
          const imageUrl = this.getSexPositionImage(position);
          const imageElement = document.getElementById('sex-position-image');
          const placeholderElement = document.getElementById('sex-position-placeholder');
          const textElement = document.getElementById('sex-position-text');

          // æ›´æ–°æ–‡å­—æ˜¾ç¤º
          if (textElement) {
            textElement.textContent = position || 'å¥³ä¸Šä½é‡å¤';
          }

          // æ›´æ–°å›¾ç‰‡æ˜¾ç¤º
          if (imageElement && placeholderElement) {
            imageElement.src = imageUrl;
            imageElement.style.display = 'block';
            placeholderElement.style.display = 'none';
          }
        }

        // åˆ‡æ¢æ€§çˆ±å§¿åŠ¿å›¾å±•å¼€/æŠ˜å ï¼ˆç±»ä¼¼ä¸ªäººæ¡£æ¡ˆçš„é€»è¾‘ï¼‰
        toggleSexPosition() {
          const basic = document.getElementById('sex-position-basic');
          const detail = document.getElementById('sex-position-detail');

          if (basic && detail) {
            if ('none' === detail.style.display) {
              basic.style.display = 'none';
              detail.style.display = 'block';
            } else {
              basic.style.display = 'block';
              detail.style.display = 'none';
            }
          }
        }

        // åˆå§‹åŒ–æ€§çˆ±å§¿åŠ¿å›¾åŒºåŸŸ
        initSexPositionSection() {
          // åˆå§‹åŒ–æ—¶æ›´æ–°å›¾ç‰‡
          this.updateSexPositionImage();
        }

        // è·å–åœ°ç‚¹å›¾ç‰‡
        getLocationImage(locationName) {
          if (!locationName) return null;

          const locationMap = {
            // å­¦å›­å†…éƒ¨åœ°ç‚¹
            ä¸­å¤®å¹¿åœº: 'https://files.catbox.moe/susi2t.avif',
            å¹¿åœº: 'https://files.catbox.moe/susi2t.avif',
            å®¤å¤–è®­ç»ƒåœº: 'https://files.catbox.moe/bn7rhq.png',
            å®¤å†…è®­ç»ƒåœº: 'https://files.catbox.moe/hjiq7q.avif',
            è®­ç»ƒåœº: 'https://files.catbox.moe/bn7rhq.png',
            é£Ÿå ‚: 'https://files.catbox.moe/2i7fpj.png',
            æ´»åŠ¨æ¥¼: 'https://files.catbox.moe/z1xy41.avif',
            èˆè¹ˆå®¤: 'https://files.catbox.moe/z1xy41.avif',
            æ¸¸æ³³é¦†: 'https://files.catbox.moe/sykb2y.jpg',
            å®¤å†…æ¸¸æ³³æ± : 'https://files.catbox.moe/sykb2y.jpg',
            æ¸¸æ³³æ± : 'https://files.catbox.moe/sykb2y.jpg',
            æ•™å­¦æ¥¼: 'https://files.catbox.moe/z1xy41.avif',
            ä¸»æ•™å­¦æ¥¼: 'https://files.catbox.moe/z1xy41.avif',
            è¡Œæ”¿æ¥¼: 'https://files.catbox.moe/z1xy41.avif',
            è®­ç»ƒå‘˜å®¤: 'https://files.catbox.moe/pggzuc.png',
            è®­ç»ƒå‘˜åŠå…¬å®¤: 'https://files.catbox.moe/pggzuc.png',
            å­¦ç”Ÿå®¿èˆ: 'https://files.catbox.moe/xnxgnw.png',
            å®¿èˆ: 'https://files.catbox.moe/xnxgnw.png',
            å°æ ‘æ—: 'https://files.catbox.moe/b730w6.png',
            ç½‘çƒåœº: 'https://files.catbox.moe/bn7rhq.png',
            è¶³çƒåœº: 'https://files.catbox.moe/bn7rhq.png',
            ä½“è‚²é¦†: 'https://files.catbox.moe/hjiq7q.avif',
            å®¤å†…ä½“è‚²é¦†: 'https://files.catbox.moe/hjiq7q.avif',
            æ‰‡å½¢éœ²å¤©å‰§åœº: 'https://files.catbox.moe/8bovd6.png',
            éœ²å¤©å‰§åœº: 'https://files.catbox.moe/8bovd6.png',
            é©¬å¨˜å®¿èˆ: 'https://files.catbox.moe/xnxgnw.png',

            // å­¦å›­å¤–éƒ¨/ç‰¹æ®Šåœ°ç‚¹
            ç›®ç™½åŸ: 'https://files.catbox.moe/bx68fl.png',
            é»„é‡‘å®¶: 'https://files.catbox.moe/bx68fl.png',
            è½¦ç«™: 'https://files.catbox.moe/eepwdx.png',
            å•†ä¸šè¡—: 'https://files.catbox.moe/7z60i6.png',
            å•†åº—è¡—: 'https://files.catbox.moe/7z60i6.png',
            æ²³å ¤: 'https://files.catbox.moe/b730w6.png',
            æ²³å·: 'https://files.catbox.moe/b730w6.png',

            // å…¶ä»–å·²æœ‰åœ°ç‚¹ï¼ˆä¿ç•™ï¼‰
            é“è·¯: 'https://files.catbox.moe/jzok4r.avif',
            æ¼”æ’­å®¤: 'https://files.catbox.moe/uko4mg.jpeg',
            å·´é»æˆ·å¤–: 'https://files.catbox.moe/ctz0ky.png',
            èƒŒæ™¯: 'https://files.catbox.moe/p3m82m.csv',
            è‰åœº: 'https://files.catbox.moe/bn7rhq.png',
            åœ°é“: 'https://files.catbox.moe/7r8z6y.png',
            åœ°ä¸‹å®¤: 'https://files.catbox.moe/rgqln3.png',
            è§‚ä¼—å¸­: 'https://files.catbox.moe/dodasg.png',
            å¹¿å·: 'https://files.catbox.moe/v9afs2.png',
            æµ·æ»©: 'https://files.catbox.moe/ynsuda.png',
            æµ·ä¹‹å®¶: 'https://files.catbox.moe/as90hx.png',
            åˆå®¿: 'https://files.catbox.moe/vq3w89.png',
            é…’åº—: 'https://files.catbox.moe/yby88y.png',
            æƒ…äººé…’åº—: 'https://files.catbox.moe/bnp1xz.png',
            ç¥ç¤¾: 'https://files.catbox.moe/7g7u0q.png',
            å¤©å°: 'https://files.catbox.moe/g3jmio.png',
            æ¸©æ³‰: 'https://files.catbox.moe/3y9jfi.png',
            å§å®¤: 'https://files.catbox.moe/xnxgnw.png',
            é¦™æ¸¯: 'https://files.catbox.moe/13mztz.png',
            æ ¡é•¿å®¤: 'https://files.catbox.moe/faizc9.png',
            ä¼‘æ¯å®¤: 'https://files.catbox.moe/sb7lp8.png',
            å­¦ç”Ÿä¼š: 'https://files.catbox.moe/7rgkhf.png',
            å­¦æ ¡å¤§é—¨: 'https://files.catbox.moe/6t9elx.png',
            åŒ»ç–—å®¤: 'https://files.catbox.moe/ef5av6.png',
            æµ´å®¤: 'https://files.catbox.moe/xga80h.png',
            ä¸­åº­: 'https://files.catbox.moe/8bovd6.png',
            è®­ç»ƒå‘˜å®¿èˆ: 'https://files.catbox.moe/xnxgnw.png',
          };

          // ç²¾ç¡®åŒ¹é…
          if (locationMap[locationName]) {
            return locationMap[locationName];
          }

          // æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³é”®è¯ï¼‰
          for (const key in locationMap) {
            if (locationName.includes(key) || key.includes(locationName)) {
              return locationMap[key];
            }
          }

          return null;
        }

        // æ›´æ–°åœ°ç‚¹å›¾ç‰‡æ˜¾ç¤º
        updateLocationImage() {
          const allVariables = this.getAllVariables();
          const location = this.getVariable(allVariables, 'stat_data.è®­ç»ƒå‘˜.ä½ç½®', '');
          const imageUrl = this.getLocationImage(location);
          const imageElement = document.getElementById('location-image');
          const placeholderElement = document.getElementById('location-image-placeholder');

          if (imageElement && placeholderElement) {
            if (imageUrl) {
              imageElement.src = imageUrl;
              imageElement.style.display = 'block';
              placeholderElement.style.display = 'none';
            } else {
              imageElement.style.display = 'none';
              placeholderElement.style.display = 'block';
              placeholderElement.textContent = location ? `æš‚æ— "${location}"çš„å›¾ç‰‡` : 'æš‚æ— åœ°ç‚¹å›¾ç‰‡';
            }
          }
        }

        // è·å–é©¬å¨˜è¡¨æƒ…å›¾ç‰‡ï¼ˆæ ¹æ®åå­—å’ŒçŠ¶æ€ï¼‰
        getUmaExpression(umaName, status = 'æ­£å¸¸') {
          // æ­£å¸¸çŠ¶æ€çš„è¡¨æƒ…å›¾ç‰‡æ˜ å°„
          const expressions = {
            è‰¾å°¼æ–¯é£ç¥: 'https://files.catbox.moe/xouqf3.png',
            çˆ±ä¸½æ•°ç : 'https://files.catbox.moe/bn0hlz.png',
            çˆ±ä¸½é€Ÿå­: 'https://files.catbox.moe/xsyqcm.png',
            çˆ±æ…•ç»‡å§¬: 'https://files.catbox.moe/ke05xh.png',
            çˆ±å¦‚å¾€æ˜”: 'https://files.catbox.moe/fv5pz2.png',
            å…«é‡æ— æ•Œ: 'https://files.catbox.moe/7soddj.png',
            åŒ—éƒ¨ç„é©¹: 'https://files.catbox.moe/zbdv8a.gif',
            åŒ—æ¸¯ç«å±±: 'https://files.catbox.moe/9ktm4g.png',
            è‰ä¸Šé£: 'https://files.catbox.moe/wywpzu.png',
            è¶…å¸¸éªéª¥: 'https://files.catbox.moe/er6j1p.png',
            è¶…çº§å°æµ·æ¹¾: 'https://files.catbox.moe/t7bjgq.png',
            æˆç”°ç™½ä»: 'https://files.catbox.moe/tpzsus.png',
            æˆç”°è·¯: 'https://files.catbox.moe/3972h0.png',
            åˆ›å‡: 'https://files.catbox.moe/swajhk.png',
            åˆ›ä¸–é©¹: 'https://files.catbox.moe/31z066.png',
            æ˜¥ç”°ä¹Œæ‹‰æ‹‰: 'https://files.catbox.moe/gued3b.png',
            è¾¾åˆ©é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/qclkp8.png',
            å¤§å’Œèµ¤éª¥: 'https://files.catbox.moe/99if8u.png',
            å¤§é¸£å¤§æ”¾: 'https://files.catbox.moe/h25gi9.png',
            å¤§æ ‘å¿«è½¦: 'https://files.catbox.moe/tf6hb4.png',
            å¤§æ‹“å¤ªé˜³ç¥: 'https://files.catbox.moe/hbvr8x.png',
            å¾…å…¼ç¦æ¥: 'https://files.catbox.moe/j9pl80.png',
            å¸ç‹å…‰ç¯: 'https://files.catbox.moe/zgdx2z.png',
            ç¬¬ä¸€çº¢å®çŸ³: 'https://files.catbox.moe/cx724j.png',
            ä¸œæµ·å¸ç‹: 'https://files.catbox.moe/mklaha.gif',
            ä¸œå•†å˜é©: 'https://files.catbox.moe/u960xy.png',
            å¤šæ—ºè¾¾: 'https://files.catbox.moe/gc048w.png',
            ä¼ç‰¹åŠ : 'https://files.catbox.moe/iv186t.png',
            å¯Œå£«å¥‡çŸ³: 'https://files.catbox.moe/izo6vs.png',
            é«˜å¤šèŠ¬é˜¿æ‹‰ä¼¯: 'https://files.catbox.moe/5e3ab6.png',
            é«˜å°šéªé€¸: 'https://files.catbox.moe/kyhfst.png',
            è‘›åŸç‹ç‰Œ: 'https://files.catbox.moe/33e850.png',
            è´µå¦‡äºº: 'https://files.catbox.moe/nsudgg.png',
            å¥½æ­Œå‰§: 'https://files.catbox.moe/lqowfn.png',
            è’æ¼ è‹±é›„: 'https://files.catbox.moe/7bzt14.png',
            é»„é‡‘åŸå¸‚: 'https://files.catbox.moe/uxvhpz.png',
            é»„é‡‘èˆ¹: 'https://files.catbox.moe/44dysd.gif',
            é»„é‡‘å·¨åŒ : 'https://files.catbox.moe/3rd2wy.png',
            æå³°: 'https://files.catbox.moe/hdqmyf.png',
            é‡‘é•‡ä¹‹å…‰: 'https://files.catbox.moe/5k2wgf.png',
            éªå·æ‰‹çº²: 'https://files.catbox.moe/h8lnpb.png',
            å‡¯æ—‹èŠ­è•¾: 'https://files.catbox.moe/vcn3th.png',
            é‡Œè§å…‰é’»: 'https://files.catbox.moe/dqw0y6.png',
            é‡Œè§çš‡å† : 'https://files.catbox.moe/cg41jm.png',
            è±äºšé©¬é€Š: 'https://files.catbox.moe/99cudj.png',
            è±é’»å¥‡å®: 'https://files.catbox.moe/3ft4ul.png',
            é²é“å¤«è±¡å¾: 'https://files.catbox.moe/0wa5bz.gif',
            æ›¼åŸèŒ¶åº§: 'https://files.catbox.moe/orfodw.png',
            ç¾å¦™å§¿åŠ¿: 'https://files.catbox.moe/b5wfjt.png',
            ç¾æµ¦æ³¢æ—: 'https://files.catbox.moe/b0o5e2.png',
            æ¢¦ä¹‹æ—…: 'https://files.catbox.moe/1u9uaq.png',
            è¿·äººæ™¯è‡´: 'https://files.catbox.moe/nlioux.png',
            ç±³æµ´: 'https://files.catbox.moe/ocn5bm.png',
            åå°†æ€’æ¶›: 'https://files.catbox.moe/td87zn.png',
            è°‹å‹‡å…¼å¤‡: 'https://files.catbox.moe/gx0jnb.png',
            ç›®ç™½é˜¿å°”ä¸¹: 'https://files.catbox.moe/xkb3nf.png',
            ç›®ç™½å¤šä¼¯: 'https://files.catbox.moe/jvnwa0.png',
            ç›®ç™½é«˜å³°: 'https://files.catbox.moe/7fej5w.png',
            ç›®ç™½å…‰æ˜: 'https://files.catbox.moe/r1cyoh.png',
            ç›®ç™½éº¦æ˜†: 'https://files.catbox.moe/xcb8k2.png',
            å¥‡é”éª: 'https://files.catbox.moe/52akq2.png',
            æ°”æ§½: 'https://files.catbox.moe/98r9ts.png',
            åƒæ˜ä»£è¡¨: 'https://files.catbox.moe/j9cvjj.png',
            å¼ºå‡»: 'https://files.catbox.moe/9tgk2k.png',
            é’äº‘å¤©ç©º: 'https://files.catbox.moe/n57tuv.png',
            ç§‹å·å¼¥ç”Ÿ: 'https://files.catbox.moe/o54zh8.png',
            è£è¿›é—ªè€€: 'https://files.catbox.moe/6a37jy.png',
            æ£®æ—å®ç©´: 'https://files.catbox.moe/ctas7q.png',
            ç¥é¹°: 'https://files.catbox.moe/20j2r1.png',
            èƒœåˆ©å¥–åˆ¸: 'https://files.catbox.moe/gyvzf9.png',
            åŒæ¶¡è½®: 'https://files.catbox.moe/hk8pn2.png',
            ç‰¹åˆ«å‘¨: 'https://files.catbox.moe/t4ypr9.png',
            å¤©ç‹¼æ˜Ÿè±¡å¾: 'https://files.catbox.moe/cb69c6.png',
            ä¸¸å–„æ–¯åŸº: 'https://files.catbox.moe/ljlozm.png',
            æ— å£°é“ƒé¹¿: 'https://files.catbox.moe/xtga93.png',
            è¥¿é‡èŠ±: 'https://files.catbox.moe/lteyym.png',
            å°æ —å¸½: 'https://files.catbox.moe/1uczzo.png',
            å°æ—å†å¥‡: 'https://files.catbox.moe/marfld.png',
            æ–°å®‡å®™: 'https://files.catbox.moe/tx0odm.png',
            æç›®: 'https://files.catbox.moe/b5kxrb.png',
            æ¨±èŠ±åƒä»£ç‹: 'https://files.catbox.moe/9qacpw.png',
            ç‰è—»åå­—: 'https://files.catbox.moe/wy7zbx.png',
            çœŸå¼“å¿«è½¦: 'https://files.catbox.moe/llnx3q.png',
            çœŸæœºä¼¶: 'https://files.catbox.moe/gu3e37.png',
            ä¸­å±±åº†å…¸: 'https://files.catbox.moe/wg2b6r.png',
            å“èŠ™: 'https://files.catbox.moe/gjjjpy.png',
          };

          // å¦‚æœçŠ¶æ€ä¸æ˜¯"æ­£å¸¸"ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•å…¶ä»–çŠ¶æ€çš„æ˜ å°„
          // ç›®å‰åªè¿”å›"æ­£å¸¸"çŠ¶æ€çš„å›¾ç‰‡
          if (status === 'æ­£å¸¸' || !status) {
            return expressions[umaName] || null;
          }

          // æœªæ¥å¯ä»¥æ‰©å±•å…¶ä»–çŠ¶æ€çš„æ˜ å°„
          return expressions[umaName] || null;
        }

        // åœ¨å³ä¾§äººç‰©è¡¨æƒ…åŒºåŸŸæ˜¾ç¤ºæŒ‡å®šé©¬å¨˜çš„è¡¨æƒ…
        showUmaExpression(umaName) {
          const grid = document.getElementById('main-uma-expression-grid');
          if (!grid) return;

          // å¦‚æœæ²¡æœ‰ä¼ å…¥é©¬å¨˜åå­—ï¼Œæ˜¾ç¤ºæç¤º
          if (!umaName) {
            grid.innerHTML =
              '<div style="text-align: center; color: #8b4513; padding: 20px; font-size: 0.9em;">ç‚¹å‡»é©¬å¨˜å¤´åƒæŸ¥çœ‹è¡¨æƒ…</div>';
            return;
          }

          // è·å–æ‰€æœ‰é©¬å¨˜æ•°æ®
          const allVariables = this.getAllVariables();
          const umaData = this.getVariable(allVariables, 'stat_data.é©¬å¨˜', {});

          if (!umaData || !umaData[umaName]) {
            grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">æœªæ‰¾åˆ°è¯¥é©¬å¨˜æ•°æ®</div>';
            return;
          }

          // æ˜¾ç¤ºåŠ è½½æç¤º
          grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">åŠ è½½ä¸­...</div>';

          // è·å–è¯¥é©¬å¨˜çš„çŠ¶æ€å’Œè¡¨æƒ…
          const umaStatus = this.getVariable(allVariables, `stat_data.é©¬å¨˜.${umaName}.çŠ¶æ€`, 'æ­£å¸¸');
          const expressionImage = this.getUmaExpression(umaName, umaStatus);

          if (expressionImage) {
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ å¹¶é¢„åŠ è½½
            const img = document.createElement('img');
            img.src = expressionImage;
            img.alt = umaName;
            img.style.cssText =
              'max-width: 100%; width: auto; height: auto; min-height: 100px; border-radius: 8px; display: block; margin: 0 auto;';
            img.loading = 'eager'; // ä½¿ç”¨eageråŠ è½½ä»¥æé«˜é€Ÿåº¦

            // å›¾ç‰‡åŠ è½½å®Œæˆåæ˜¾ç¤º
            img.onload = () => {
              grid.innerHTML = '';
              const container = document.createElement('div');
              container.style.cssText = 'text-align: center;';
              container.appendChild(img);
              grid.appendChild(container);
            };

            // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯
            img.onerror = () => {
              grid.innerHTML = '<div style="text-align: center; color: #8b4513; padding: 20px;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
            };
          } else {
            grid.innerHTML =
              '<div style="text-align: center; color: #8b4513; padding: 20px;">æš‚æ— è¯¥é©¬å¨˜çš„è¡¨æƒ…å›¾ç‰‡</div>';
          }
        }

        // æ¸²æŸ“äººç‰©è¡¨æƒ…åˆ—è¡¨ï¼ˆç”¨äºæ¨¡æ€æ¡†ï¼‰
        renderUmaExpressions(selectedUmaName = null) {
          const grid = document.getElementById('uma-expression-grid');
          if (!grid) return;

          // è·å–æ‰€æœ‰é©¬å¨˜æ•°æ®
          const allVariables = this.getAllVariables();
          const umaData = this.getVariable(allVariables, 'stat_data.é©¬å¨˜', {});

          if (!umaData || Object.keys(umaData).length === 0) {
            grid.innerHTML = '<div class="empty-uma">æš‚æ— é©¬å¨˜æ•°æ®</div>';
            return;
          }

          // æ¸…ç©ºç½‘æ ¼
          grid.innerHTML = '';

          // å¦‚æœæŒ‡å®šäº†é©¬å¨˜åå­—ï¼Œåªæ˜¾ç¤ºè¯¥é©¬å¨˜çš„è¡¨æƒ…
          const umaNamesToShow = selectedUmaName ? [selectedUmaName] : Object.keys(umaData);

          // éå†è¦æ˜¾ç¤ºçš„é©¬å¨˜ï¼Œæ¸²æŸ“è¡¨æƒ…
          umaNamesToShow.forEach(umaName => {
            // æ£€æŸ¥è¯¥é©¬å¨˜æ˜¯å¦å­˜åœ¨
            if (!umaData[umaName]) return;

            const umaStatus = this.getVariable(allVariables, `stat_data.é©¬å¨˜.${umaName}.çŠ¶æ€`, 'æ­£å¸¸');
            const expressionImage = this.getUmaExpression(umaName, umaStatus);

            if (expressionImage) {
              const item = document.createElement('div');
              item.className = 'uma-expression-item';
              item.innerHTML = `
                <div class="uma-expression-card">
                  <div class="uma-expression-name">${umaName}</div>
                  <div class="uma-expression-status">çŠ¶æ€: ${umaStatus}</div>
                  <img src="${expressionImage}" alt="${umaName} - ${umaStatus}" class="uma-expression-image" loading="lazy">
                </div>
              `;
              grid.appendChild(item);
            }
          });
        }

        getAvatarStyle(e, t) {
          return `width: 58.44px; height: 64px; border-radius: 0.5rem; object-fit: cover;`;
        }

        // æ ¹æ®å¥½æ„Ÿåº¦å’Œç‹¬å åº¦è®¡ç®—åå­—é¢œè‰²

        getUmaNameColor(favorability, exclusivity) {
          // é«˜ç‹¬å åº¦æ—¶æ˜¾ç¤ºçº¢è‰²ç³»

          if (exclusivity > 90) return '#dc2626'; // æ·±çº¢è‰²

          if (exclusivity > 80) return '#ef4444'; // çº¢è‰²

          if (exclusivity > 70) return '#f87171'; // æµ…çº¢è‰²

          // é«˜å¥½æ„Ÿåº¦æ—¶æ˜¾ç¤ºç²‰è‰²ç³»

          if (favorability > 80) return '#ec4899'; // ç²‰è‰²

          if (favorability > 60) return '#f472b6'; // æµ…ç²‰è‰²

          if (favorability > 40) return '#f9a8d4'; // æ›´æµ…ç²‰è‰²

          // é»˜è®¤é¢œè‰²

          return '#8b6914'; // é‡‘è‰²
        }

        // çŠ¶æ€æ–‡å­—é¢œè‰²å›ºå®šä¸ºç™½è‰²

        getUmaStatusColor(status, exclusivity, index = 0) {
          return '#ffffff'; // å›ºå®šç™½è‰²
        }

        // æ ¹æ®å¡ç‰‡ç´¢å¼•è®¡ç®—çŠ¶æ€å¾½ç« èƒŒæ™¯è‰²

        getStatusBackgroundColor(status, exclusivity, index = 0) {
          // æ ¹æ®å¡ç‰‡æ’åºåˆ†å¸ƒèƒŒæ™¯è‰²ï¼Œä¸æ–‡å­—é¢œè‰²å½¢æˆå¯¹æ¯”

          const backgrounds = [
            'rgba(239, 68, 68, 0.15)', // æµ…çº¢è‰²èƒŒæ™¯

            'rgba(59, 130, 246, 0.15)', // æµ…è“è‰²èƒŒæ™¯

            'rgba(34, 197, 94, 0.15)', // æµ…ç»¿è‰²èƒŒæ™¯

            'rgba(251, 191, 36, 0.15)', // æµ…é»„è‰²èƒŒæ™¯

            'rgba(139, 92, 246, 0.15)', // æµ…ç´«è‰²èƒŒæ™¯

            'rgba(249, 115, 22, 0.15)', // æµ…æ©™è‰²èƒŒæ™¯

            'rgba(6, 182, 212, 0.15)', // æµ…é’è‰²èƒŒæ™¯

            'rgba(236, 72, 153, 0.15)', // æµ…ç²‰è‰²èƒŒæ™¯

            'rgba(132, 204, 22, 0.15)', // æµ…é’ç»¿è‰²èƒŒæ™¯

            'rgba(245, 158, 11, 0.15)', // æµ…ç¥ç€è‰²èƒŒæ™¯
          ];

          return backgrounds[index % backgrounds.length];
        }

        updateCurrencySystem() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å®éªŒæ•°æ®ç‚¹', 0),
            n = document.getElementById('currency-value'),
            profileCurrency = document.getElementById('profile-currency-value');

          n && (n.textContent = t.toString());

          profileCurrency && (profileCurrency.textContent = t.toString());
        }

        updateFestivalNotice() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰èŠ‚æ—¥', ''),
            s = document.getElementById('festival-notice'),
            o = document.getElementById('festival-text');

          s &&
            o &&
            (t && t !== '' && t !== null && t !== 'null'
              ? ((o.textContent = `${t}`), (s.style.display = 'flex'))
              : ((o.textContent = 'å¹³å¹³æ— å¥‡çš„ä¸€å¤©'), (s.style.display = 'flex')));
        }

        updateRulesCountdown() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.è§„åˆ™åˆ·æ–°æ—¥', 0),
            n = document.getElementById('rules-countdown'),
            s = document.getElementById('countdown-text');

          n &&
            s &&
            (t > 0
              ? ((s.textContent = `è§„åˆ™åˆ·æ–°: ${t}å¤©å`), (n.style.display = 'flex'))
              : ((s.textContent = 'è§„åˆ™ä»Šæ—¥åˆ·æ–°'), (n.style.display = 'flex')));
        }

        updateReplyTimer() {
          try {
            const e = document.getElementById('reply-timer'),
              t = document.getElementById('reply-timer-text');

            if (!e || !t) return;

            const n = localStorage.getItem('teresen_waiting_for_reply'),
              s = localStorage.getItem('teresen_reply_start_time');

            if ('true' === n && s) {
              const n = parseInt(s),
                o = new Date().getTime() - n,
                a = Math.floor(o / 6e4),
                l = Math.floor((o % 6e4) / 1e3);

              ((t.textContent = `Eternal zzç å­—ä¸­: ${a.toString().padStart(2, '0')}:${l.toString().padStart(2, '0')}`),
                (e.className = o >= 3e5 ? 'reply-timer danger' : o >= 18e4 ? 'reply-timer warning' : 'reply-timer'),
                (e.style.display = 'flex'));
            } else {
              const n = localStorage.getItem('teresen_last_reply_time');

              const evaluation = localStorage.getItem('teresen_last_reply_evaluation') || '';

              if (n) {
                const s = parseInt(n),
                  o = Math.floor(s / 6e4),
                  a = Math.floor((s % 6e4) / 1e3);

                const timeText = `${o.toString().padStart(2, '0')}:${a.toString().padStart(2, '0')}`;

                const displayText = evaluation ? `${timeText}ï¼ŒEçœ¼ç›¯å¸§ï¼š${evaluation}` : `${timeText}`;

                ((t.textContent = displayText), (e.className = 'reply-timer'), (e.style.display = 'flex'));
              } else this.hideReplyTimer();
            }
          } catch (e) {
            (console.error('æ›´æ–°å›å¤æ—¶é—´è®¡ç®—å¤±è´¥:', e), this.hideReplyTimer());
          }
        }

        hideReplyTimer() {
          const e = document.getElementById('reply-timer');

          e && (e.style.display = 'none');
        }

        startReplyTimer() {
          setInterval(() => {
            this.updateReplyTimer();
          }, 1e3);
        }

        // é˜²æŠ–å®šæ—¶å™¨
        streamUpdateDebounceTimer = null;

        handleStreamUpdate(fullText) {
          try {
            if (!fullText || !fullText.trim()) return;

            // ä½¿ç”¨é˜²æŠ–ï¼Œå‡å°‘é¢‘ç¹æ›´æ–°ï¼ˆ200mså†…åªæ›´æ–°ä¸€æ¬¡ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦å’Œæ€§èƒ½ï¼‰
            if (this.streamUpdateDebounceTimer) {
              clearTimeout(this.streamUpdateDebounceTimer);
            }

            this.streamUpdateDebounceTimer = setTimeout(() => {
              this._doStreamUpdate(fullText);
            }, 200);
          } catch (e) {
            console.error('æµå¼æ›´æ–°å¤±è´¥:', e);
          }
        }

        // å®é™…æ‰§è¡Œæµå¼æ›´æ–°çš„æ–¹æ³•
        _doStreamUpdate(fullText) {
          try {
            const storyContent = document.getElementById('story-content');
            if (!storyContent) return;

            // ç»Ÿä¸€æå–contentå’Œactionæ ‡ç­¾ï¼ˆä¸€ä¸ªcontentå¯¹åº”ä¸€ä¸ªactionï¼‰
            let contentText = '';
            let actionText = '';

            // æå–æœ€åä¸€ä¸ªcontentæ ‡ç­¾å†…å®¹ï¼ˆæ”¯æŒæµå¼æ›´æ–°ä¸­çš„ä¸å®Œæ•´æ ‡ç­¾ï¼‰
            const contentMatches = [...fullText.matchAll(/<content>([\s\S]*?)(?:<\/content>|$)/g)];
            if (contentMatches.length > 0) {
              // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæœ€æ–°çš„contentï¼‰
              const lastMatch = contentMatches[contentMatches.length - 1];
              contentText = lastMatch[1].trim();
            }

            // æå–æœ€åä¸€ä¸ªactionæ ‡ç­¾å†…å®¹ï¼ˆæ”¯æŒæµå¼æ›´æ–°ä¸­çš„ä¸å®Œæ•´æ ‡ç­¾ï¼‰
            const actionMatches = [...fullText.matchAll(/<action>([\s\S]*?)(?:<\/action>|$)/g)];
            if (actionMatches.length > 0) {
              // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæœ€æ–°çš„actionï¼‰
              const lastMatch = actionMatches[actionMatches.length - 1];
              actionText = lastMatch[1].trim();
            }

            // æ›´æ–°æ­£æ–‡å†…å®¹ï¼ˆåªåœ¨æœ‰contentæ—¶æ›´æ–°ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œï¼‰
            if (contentText && contentText !== this.lastContentText) {
              this.lastContentText = contentText;
              // åº”ç”¨å»å…«è‚¡è§„åˆ™
              const processedContent = this.applyAntiBoilerplateRules(contentText);

              // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–DOMæ›´æ–°æ€§èƒ½
              requestAnimationFrame(() => {
                storyContent.innerHTML = `<p class="story-text">${processedContent}</p>`;

                // åº”ç”¨å­—ä½“è®¾ç½®ï¼ˆåªåœ¨å†…å®¹å˜åŒ–æ—¶åº”ç”¨ä¸€æ¬¡ï¼‰
                const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
                const size = localStorage.getItem('teresen_font_size') || '1';
                $('.story-text').css({
                  'font-family': font,
                  'font-size': size + 'em',
                });
              });
            }

            // æ›´æ–°actioné€‰é¡¹ï¼ˆç›´æ¥ä½¿ç”¨æå–çš„actionTextï¼Œé¿å…é‡å¤æå–ï¼‰
            // åªåœ¨actionå†…å®¹å˜åŒ–æ—¶æ›´æ–°ï¼Œé¿å…é¢‘ç¹DOMæ“ä½œ
            if (actionText !== this.lastActionText) {
              this.lastActionText = actionText;
              // ç›´æ¥ä¼ å…¥actionå†…å®¹ï¼Œè€Œä¸æ˜¯fullTextï¼Œæå‡æ€§èƒ½
              this.updateActionOptionsFromContent(actionText);
            } else if (!actionText && this.lastActionText) {
              // actionè¢«æ¸…ç©ºäº†ï¼Œä¹Ÿè¦æ›´æ–°
              this.lastActionText = '';
              this.updateActionOptionsFromContent('');
            }

            // ğŸ”¥ æå–UpdateVariableæ ‡ç­¾å†…å®¹ï¼ˆæ”¯æŒæµå¼æ›´æ–°ä¸­çš„ä¸å®Œæ•´æ ‡ç­¾ï¼‰
            let variableUpdateText = '';
            const variableMatches = [...fullText.matchAll(/<UpdateVariable>([\s\S]*?)(?:<\/UpdateVariable>|$)/g)];
            if (variableMatches.length > 0) {
              // å–æœ€åä¸€ä¸ªåŒ¹é…ï¼ˆæœ€æ–°çš„UpdateVariableï¼‰
              const lastMatch = variableMatches[variableMatches.length - 1];
              variableUpdateText = lastMatch[1].trim();
            }

            // ğŸ”¥ æ›´æ–°å˜é‡æ›´æ–°è£…é¥°ï¼ˆåœ¨æµå¼æ›´æ–°æ—¶ä¹Ÿæ˜¾ç¤ºï¼‰
            if (variableUpdateText) {
              this.updateVariableDecoration(variableUpdateText, true); // trueè¡¨ç¤ºæ­£åœ¨æµå¼ä¼ è¾“
            }
          } catch (e) {
            console.error('æµå¼æ›´æ–°æ‰§è¡Œå¤±è´¥:', e);
          }
        }

        startHighFrequencyStreaming() {
          // å¦‚æœå·²ç»æœ‰é«˜é¢‘æ›´æ–°åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
          if (this.highFrequencyStreamingInterval) {
            clearInterval(this.highFrequencyStreamingInterval);
          }

          // å¯åŠ¨é«˜é¢‘æ›´æ–°ï¼Œæ¯150msæ£€æŸ¥ä¸€æ¬¡ï¼ˆé™ä½é¢‘ç‡ï¼Œæå‡æ€§èƒ½ï¼‰
          this.highFrequencyStreamingInterval = setInterval(() => {
            // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨ç”Ÿæˆä¸­
            const isGenerating = document.querySelector('.generating-indicator')?.style.display !== 'none';
            if (!isGenerating) {
              // ç”Ÿæˆç»“æŸï¼Œåœæ­¢é«˜é¢‘æ›´æ–°
              clearInterval(this.highFrequencyStreamingInterval);
              this.highFrequencyStreamingInterval = null;
              // ğŸ”¥ æ ‡è®°æµå¼ä¼ è¾“ç»“æŸï¼ˆå¤‡ç”¨ï¼Œä»¥é˜²GENERATION_ENDEDäº‹ä»¶æ²¡æœ‰è§¦å‘ï¼‰
              this.isStreaming = false;
              // ç”Ÿæˆç»“æŸæ—¶ï¼Œç¡®ä¿æœ€åä¸€æ¬¡æ›´æ–°ï¼ˆä½¿ç”¨å®Œæ•´æ–‡æœ¬ï¼‰
              const latestMessage = document.querySelector('.message:last-child .message-content');
              if (latestMessage && latestMessage.textContent) {
                this._doStreamUpdate(latestMessage.textContent);
              }
              // ğŸ”¥ ç”Ÿæˆç»“æŸåï¼Œç§»é™¤å˜é‡æ›´æ–°è£…é¥°çš„åŠ¨ç”»ç±»
              const decoration = document.getElementById('variable-update-decoration');
              if (decoration) {
                decoration.classList.remove('updating');
              }
              return;
            }

            // å°è¯•ä»æœ€æ–°çš„æ¶ˆæ¯ä¸­è·å–å†…å®¹
            const latestMessage = document.querySelector('.message:last-child .message-content');
            if (latestMessage && latestMessage.textContent) {
              this.handleStreamUpdate(latestMessage.textContent);
            }
          }, 150); // æ¯150msæ›´æ–°ä¸€æ¬¡ï¼Œå¹³è¡¡æ€§èƒ½å’Œå“åº”é€Ÿåº¦
        }

        async handleGenerationEnd(finalText) {
          try {
            console.log('ğŸ”„ å¤„ç†ç”Ÿæˆç»“æŸ...');
            console.log(`  - finalTexté•¿åº¦: ${finalText?.length || 0}`);
            console.log(`  - chatHistoryCacheå½“å‰é•¿åº¦: ${this.chatHistoryCache?.length || 0}`);

            const storyContent = document.getElementById('story-content');

            // ğŸ”¥ æ£€æŸ¥ç”Ÿæˆæ˜¯å¦å¤±è´¥ï¼ˆfinalTextä¸ºç©ºã€æ— æ•ˆæˆ–æ²¡æœ‰æœ‰æ•ˆçš„contentæ ‡ç­¾ï¼‰
            if (!finalText || !finalText.trim()) {
              console.warn('âš ï¸ finalTextä¸ºç©ºæˆ–æ— æ•ˆï¼Œç”Ÿæˆå¤±è´¥ï¼Œæ¢å¤åŸæ–‡');
              // æ¢å¤ç”Ÿæˆå‰çš„æ­£æ–‡å†…å®¹ï¼Œé¿å…æ˜¾ç¤ºç©ºæ–‡æœ¬æˆ–é”™è¯¯å†…å®¹
              if (storyContent && this.lastValidStoryContentBeforeGeneration) {
                storyContent.innerHTML = this.lastValidStoryContentBeforeGeneration;
                console.log('âœ… å·²æ¢å¤ç”Ÿæˆå‰çš„åŸæ–‡ï¼Œé¿å…æ˜¾ç¤ºç©ºå†…å®¹');
              }
              return; // ç”Ÿæˆå¤±è´¥ï¼Œä¸ç»§ç»­åç»­å¤„ç†
            }

            // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„contentæ ‡ç­¾ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜ç”Ÿæˆå¤±è´¥ï¼‰
            const hasContentTag = /<content>[\s\S]*?<\/content>/i.test(finalText);
            if (!hasContentTag) {
              console.warn('âš ï¸ finalTextä¸­æ²¡æœ‰æœ‰æ•ˆçš„contentæ ‡ç­¾ï¼Œç”Ÿæˆå¤±è´¥ï¼Œæ¢å¤åŸæ–‡');
              // æ¢å¤ç”Ÿæˆå‰çš„æ­£æ–‡å†…å®¹
              if (storyContent && this.lastValidStoryContentBeforeGeneration) {
                storyContent.innerHTML = this.lastValidStoryContentBeforeGeneration;
                console.log('âœ… å·²æ¢å¤ç”Ÿæˆå‰çš„åŸæ–‡ï¼Œå› ä¸ºæ²¡æœ‰æœ‰æ•ˆçš„contentæ ‡ç­¾');
              }
              return; // ç”Ÿæˆå¤±è´¥ï¼Œä¸ç»§ç»­åç»­å¤„ç†
            }

            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç”Ÿæˆç»“æŸåï¼Œåªæ›´æ–°å…¶ä»–ç•Œé¢å…ƒç´ ï¼Œä¸æ›´æ–°æ­£æ–‡å†…å®¹
            // å› ä¸ºæµå¼ä¼ è¾“å·²ç»æ˜¾ç¤ºäº†æ­£ç¡®çš„å†…å®¹ï¼ŒupdateStoryContent()ä¼šä»extra.teresen_chatè¯»å–æ¶ˆæ¯
            // å¯èƒ½è¯»å–åˆ°æ—§æ¶ˆæ¯ï¼Œå¯¼è‡´æ˜¾ç¤ºå›åˆ°ç¬¬ä¸€æ¡
            // æ‰€ä»¥è¿™é‡Œåªæ›´æ–°å˜é‡ã€çŠ¶æ€ç­‰ç•Œé¢å…ƒç´ ï¼Œä¿æŒæµå¼ä¼ è¾“æ˜¾ç¤ºçš„æ­£æ–‡å†…å®¹
            console.log('ğŸ”„ æ›´æ–°ç•Œé¢å…ƒç´ ï¼ˆè·³è¿‡æ­£æ–‡å†…å®¹æ›´æ–°ï¼Œä¿æŒæµå¼ä¼ è¾“æ˜¾ç¤ºï¼‰');

            // æ›´æ–°åŸºç¡€çŠ¶æ€ï¼ˆå˜é‡ã€é©¬å¨˜ã€æ—¶é—´ç­‰ï¼‰ï¼Œä½†ä¸æ›´æ–°æ­£æ–‡å†…å®¹
            this.updateTrainerStatus();
            this.updateUmaStatus();
            this.updateTimeDisplay();
            this.updateReplyTimer();
            this.updateLocationImage();
            this.initSexPositionSection();
            this.updateSexPositionImage();
            this.updateTaskList();
            this.updateInventory();
            this.updateRules();
            this.updateCurrencySystem();
            this.updateFestivalNotice();

            // 3. å¦‚æœæœ‰å˜é‡æ›´æ–°ï¼Œå¤„ç†MVUæ›´æ–°
            if (finalText && finalText.trim()) {
              // æå–UpdateVariableæ ‡ç­¾å†…å®¹
              const variableMatch = finalText.match(/<UpdateVariable>(.*?)<\/UpdateVariable>/s);
              if (variableMatch) {
                const updateScript = variableMatch[1].trim();
                console.log('ğŸ“Š æ£€æµ‹åˆ°å˜é‡æ›´æ–°:', updateScript);

                // ğŸ”¥ æ˜¾ç¤ºå˜é‡æ›´æ–°è£…é¥°ï¼ˆç”Ÿæˆç»“æŸæ—¶ï¼ŒisStreaming=falseï¼‰
                this.updateVariableDecoration(updateScript, false);

                // è°ƒç”¨MVUæ›´æ–°å˜é‡
                if (this.currentMvuState && updateScript) {
                  const inputData = { old_variables: this.currentMvuState };
                  try {
                    const mvuPromise = eventEmit('mag_invoke_mvu', updateScript, inputData);
                    const timeoutPromise = new Promise((_, reject) =>
                      setTimeout(() => reject(new Error('MVU event timeout')), 3000),
                    );
                    await Promise.race([mvuPromise, timeoutPromise]);

                    if (inputData.new_variables) {
                      this.currentMvuState = inputData.new_variables;
                      console.log('âœ… MVUå˜é‡æ›´æ–°æˆåŠŸ');
                    }
                  } catch (eventError) {
                    console.error('âŒ MVUå˜é‡æ›´æ–°å¤±è´¥:', eventError);
                  }
                }
              } else {
                // æ²¡æœ‰å˜é‡æ›´æ–°ï¼Œéšè—è£…é¥°
                this.updateVariableDecoration('');
              }

              // ğŸ”¥ 3. æå–è®°å¿†æ ‡ç­¾ï¼ˆä»AIå›å¤ä¸­æå–ï¼‰
              console.log('ğŸ“ å¼€å§‹æå–è®°å¿†...');
              const cleanedText = finalText.replace(/<safe>[\s\S]*?<\/safe>/g, '');
              this.lastExtractedJourney = this._extractLastTagContent('æœ¬å‘¨ç›®ç»å†', cleanedText);
              this.lastExtractedCoreMemory = this._extractLastTagContent('æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†', cleanedText);

              // ğŸ”¥ 4. å¦‚æœå¯ç”¨äº†è‡ªåŠ¨å†™å…¥ï¼Œåˆ™è‡ªåŠ¨å†™å…¥ä¸–ç•Œä¹¦
              if (this.isAutoWriteEnabled) {
                if (this.lastExtractedJourney) {
                  await this.writeJourneyToLorebook(true); // silent = trueï¼Œä¸æ˜¾ç¤ºæç¤º
                  this.lastWrittenJourney = this.lastExtractedJourney;
                  console.log('âœ… æœ¬å‘¨ç›®ç»å†å·²å†™å…¥ä¸–ç•Œä¹¦');
                }
                if (this.lastExtractedCoreMemory) {
                  await this.writeCoreMemoryToLorebook(true);
                  this.lastWrittenCoreMemory = this.lastExtractedCoreMemory;
                  console.log('âœ… æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†å·²å†™å…¥ä¸–ç•Œä¹¦');
                }
              }

              // ğŸ”¥ 5. ä¿å­˜å›åˆå¿«ç…§åˆ°å†å²ç¼“å­˜ï¼ˆæ–°å¢ï¼‰
              console.log(`[å†å²ç³»ç»Ÿ] å‡†å¤‡ä¿å­˜å›åˆå¿«ç…§ï¼ŒcleanedTexté•¿åº¦: ${cleanedText?.length || 0}`);
              await this._finalizeTurn(cleanedText);
              console.log(
                `[å†å²ç³»ç»Ÿ] å›åˆå¿«ç…§ä¿å­˜å®Œæˆï¼Œå½“å‰chatHistoryCacheé•¿åº¦: ${this.chatHistoryCache?.length || 0}`,
              );

              // ğŸ”¥ 6. å¦‚æœå¯ç”¨äº†è‡ªåŠ¨å­˜æ¡£ï¼Œæ‰§è¡Œè‡ªåŠ¨å­˜æ¡£
              if (this.isAutoSaveEnabled) {
                await this.performAutoSave();
              }
            } else {
              console.warn('[å†å²ç³»ç»Ÿ] âš ï¸ finalTextä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜å›åˆå¿«ç…§');
            }

            console.log('âœ… ç”Ÿæˆç»“æŸå¤„ç†å®Œæˆ');
          } catch (e) {
            console.error('âŒ ç”Ÿæˆç»“æŸå¤„ç†å¤±è´¥:', e);
          }
        }

        // ====================================================================
        // è®°å¿†ç³»ç»Ÿæ ¸å¿ƒæ–¹æ³•
        // ====================================================================

        // ğŸ”¥ æå–æ ‡ç­¾å†…å®¹ï¼ˆä»AIå›å¤ä¸­æå–è®°å¿†ï¼‰
        _extractLastTagContent(tagName, text, keepTags = false) {
          if (!text || typeof text !== 'string') return '';

          // åŒ¹é…æœ€åä¸€ä¸ªæ ‡ç­¾å¯¹
          const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<\\/${tagName}>`, 'gi');
          const matches = [...text.matchAll(regex)];

          if (matches.length === 0) return '';

          // è¿”å›æœ€åä¸€ä¸ªåŒ¹é…çš„å†…å®¹
          const lastMatch = matches[matches.length - 1];
          const content = lastMatch[1].trim();

          return keepTags ? `<${tagName}>${content}</${tagName}>` : content;
        }

        // ğŸ”¥ è·å–å†å²è®°å½•å­˜å‚¨é”®
        _getHistoryKey() {
          const chatId = TavernHelper?.chatId;
          if (!chatId) {
            console.warn('[å†å²ç³»ç»Ÿ] æ— æ³•è·å–chatIdï¼Œä½¿ç”¨å…¨å±€å†å²è®°å½•');
            return 'frontend_chat_history_fallback';
          }
          return `frontend_chat_history_${chatId}`;
        }

        // ====================================================================
        // extra.teresen_chat è¾…åŠ©å‡½æ•°
        // ====================================================================

        /**
         * ä» extra.teresen_chat åŠ è½½æ¶ˆæ¯å†å²
         * @returns {Array} æ¶ˆæ¯å†å²æ•°ç»„
         */
        async loadChatHistoryFromExtra() {
          try {
            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„loadStateï¼šä»SillyTavern.chatä»åå¾€å‰æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰extra.teresen_chatçš„æ¶ˆæ¯
            // ä¸æ˜¯ä»0å±‚æ¶ˆæ¯è¯»å–ï¼Œè€Œæ˜¯ä»æœ€åä¸€æ¡æ¶ˆæ¯å¼€å§‹æŸ¥æ‰¾
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.log('ğŸ“ SillyTavern.chatä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„');
              return [];
            }

            const chat = SillyTavern.chat;
            // ä»åå¾€å‰æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰extra.teresen_chatçš„æ¶ˆæ¯
            for (let i = chat.length - 1; i >= 0; i--) {
              const msg = chat[i];
              if (msg.extra?.teresen_chat && Array.isArray(msg.extra.teresen_chat)) {
                console.log(`âœ… ä»ç¬¬${i}æ¡æ¶ˆæ¯çš„extra.teresen_chatåŠ è½½äº† ${msg.extra.teresen_chat.length} æ¡æ¶ˆæ¯`);
                return JSON.parse(JSON.stringify(msg.extra.teresen_chat)); // æ·±æ‹·è´
              }
            }

            console.log('ğŸ“ æœªæ‰¾åˆ°extra.teresen_chatï¼Œè¿”å›ç©ºæ•°ç»„');
            return [];
          } catch (error) {
            console.error('âŒ åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
            return [];
          }
        }

        /**
         * ä¿å­˜æ¶ˆæ¯å†å²åˆ° extra.teresen_chat
         * @param {Array} chatHistory - æ¶ˆæ¯å†å²æ•°ç»„
         * @param {Object|null} updatedVariables - æ›´æ–°åçš„å˜é‡çŠ¶æ€ï¼ˆå¯é€‰ï¼Œå‚è€ƒåˆ†æ2.jsçš„saveStateç¬¬äºŒä¸ªå‚æ•°ï¼‰
         */
        async saveChatHistoryToExtra(chatHistory, updatedVariables = null) {
          try {
            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„saveStateï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
            // åˆ†æ2.jsä½¿ç”¨ SillyTavern.chat[a.length - 1]ï¼Œè€Œä¸æ˜¯getChatMessages(0)
            if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
              console.error('âŒ æ— æ³•è·å–èŠå¤©è®°å½•ï¼Œæ— æ³•ä¿å­˜èŠå¤©å†å²');
              return;
            }

            const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
            if (!lastMessage.extra) {
              lastMessage.extra = {};
            }

            // ä¿å­˜åˆ° extra.teresen_chatï¼ˆå‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼Œä¸æ›´æ–°æ¶ˆæ¯çš„messageå­—æ®µï¼‰
            lastMessage.extra.teresen_chat = JSON.parse(JSON.stringify(chatHistory)); // æ·±æ‹·è´

            // ğŸ”¥ ä½¿ç”¨SillyTavern.saveChat()ä¿å­˜ï¼Œè€Œä¸æ˜¯setChatMessagesæ›´æ–°æ¶ˆæ¯
            // å‚è€ƒåˆ†æ2.jsçš„saveStateå‡½æ•°ï¼šåªä¿å­˜åˆ°extraï¼Œä¸æ›´æ–°message
            if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
              await SillyTavern.saveChat();
              console.log(
                `âœ… å·²é€šè¿‡SillyTavern.saveChat()ä¿å­˜ ${chatHistory.length} æ¡æ¶ˆæ¯åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„ extra.teresen_chat`,
              );
            } else {
              // å¦‚æœSillyTavern.saveChatä¸å¯ç”¨ï¼Œä½¿ç”¨setChatMessagesä½†åªæ›´æ–°extraï¼Œä¸æ›´æ–°message
              // æ³¨æ„ï¼šè¿™é‡Œä¸è®¾ç½®messageå­—æ®µï¼Œåªæ›´æ–°extra
              await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
              console.log(
                `âœ… å·²é€šè¿‡setChatMessagesä¿å­˜ ${chatHistory.length} æ¡æ¶ˆæ¯åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„ extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰`,
              );
            }

            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„_updateVariablesInScopeï¼šå¦‚æœæœ‰å˜é‡ï¼Œå…ˆæ›´æ–°messageå±‚ï¼Œå†åŒæ­¥åˆ°chatå±‚
            if (updatedVariables) {
              try {
                if (typeof updateVariablesWith === 'function' && typeof getVariables === 'function') {
                  // 1. å…ˆæ›´æ–°messageå±‚ï¼ˆlatestæ¶ˆæ¯ï¼‰
                  await updateVariablesWith(() => JSON.parse(JSON.stringify(updatedVariables)), {
                    type: 'message',
                    message_id: 'latest',
                  });

                  // 2. è·å–æ›´æ–°åçš„å˜é‡
                  const updated = getVariables({ type: 'message' });

                  // 3. åŒæ­¥åˆ°chatå±‚ï¼ˆè¿™æ ·æ•´ä¸ªä¼šè¯éƒ½èƒ½è®¿é—®ï¼‰
                  await updateVariablesWith(() => updated, { type: 'chat' });

                  console.log('âœ… å·²é€šè¿‡updateVariablesWithæ›´æ–°messageå±‚å’Œchatå±‚å˜é‡');
                } else {
                  console.warn('âš ï¸ updateVariablesWithæˆ–getVariablesä¸å¯ç”¨ï¼Œå˜é‡ä»…ä¿å­˜åœ¨æœ¬åœ°');
                }
              } catch (commitError) {
                console.error('âŒ æäº¤å˜é‡æ›´æ–°å¤±è´¥:', commitError);
                // ä¸å½±å“æ¶ˆæ¯ä¿å­˜ï¼Œç»§ç»­æ‰§è¡Œ
              }
            }
          } catch (error) {
            console.error('âŒ ä¿å­˜èŠå¤©å†å²å¤±è´¥:', error);
          }
        }

        /**
         * æ·»åŠ æ¶ˆæ¯åˆ° extra.teresen_chat
         * @param {string} role - 'user' æˆ– 'assistant'
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         * @param {Object} variableState - å˜é‡çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
         */
        async addMessageToExtra(role, content, variableState = null) {
          try {
            // 1. åŠ è½½ç°æœ‰å†å²
            let chatHistory = await this.loadChatHistoryFromExtra();

            // 2. åˆ›å»ºæ–°æ¶ˆæ¯å¯¹è±¡
            const newMessage = {
              role: role,
              content: content,
              id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              timestamp: Date.now(),
              variableState: variableState ? JSON.parse(JSON.stringify(variableState)) : null,
            };

            // 3. æ·»åŠ åˆ°å†å²
            chatHistory.push(newMessage);

            // 4. ğŸ”¥ ä¿å­˜ï¼ˆå‚è€ƒåˆ†æ2.jsï¼šå¦‚æœå˜é‡ä¸ä¸ºnullï¼Œä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼‰
            const variablesToSave = variableState || null;
            await this.saveChatHistoryToExtra(chatHistory, variablesToSave);

            console.log(`âœ… å·²æ·»åŠ ${role}æ¶ˆæ¯åˆ°extra.teresen_chat`);
            return newMessage;
          } catch (error) {
            console.error('âŒ æ·»åŠ æ¶ˆæ¯å¤±è´¥:', error);
            throw error;
          }
        }

        /**
         * è·å–æœ€æ–°æ¶ˆæ¯ï¼ˆä» extra.teresen_chatï¼‰
         * @returns {Object|null} æœ€æ–°æ¶ˆæ¯å¯¹è±¡
         */
        async getLatestMessageFromExtra() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();
            if (chatHistory.length === 0) return null;
            return chatHistory[chatHistory.length - 1];
          } catch (error) {
            console.error('âŒ è·å–æœ€æ–°æ¶ˆæ¯å¤±è´¥:', error);
            return null;
          }
        }

        /**
         * ğŸ”¥ å¤„ç†å˜é‡ï¼ˆå‚è€ƒåˆ†æ2.jsçš„_processVariableså‡½æ•°ï¼‰
         * @param {string} content - AIå›å¤å†…å®¹
         * @param {Object} currentVariables - å½“å‰å˜é‡çŠ¶æ€
         * @returns {Object} { updatedVariables, snapshot }
         */
        async _processVariables(content, currentVariables) {
          const inputData = { old_variables: currentVariables };
          try {
            if ('function' == typeof window.eventEmit) {
              await window.eventEmit('mag_invoke_mvu', content, inputData);
              if (inputData.new_variables) {
                const updatedVariables = inputData.new_variables;
                return {
                  updatedVariables: updatedVariables,
                  snapshot: JSON.parse(JSON.stringify(updatedVariables)),
                };
              }
            }
          } catch (error) {
            console.error('âŒ å¤„ç†å˜é‡å¤±è´¥:', error);
          }
          // å¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œè¿”å›åŸå§‹å˜é‡
          return {
            updatedVariables: currentVariables,
            snapshot: JSON.parse(JSON.stringify(currentVariables)),
          };
        }

        /**
         * ğŸ”¥ åŒæ­¥çŠ¶æ€ä¸å†å²ï¼ˆå‚è€ƒåˆ†æ2.jsçš„_syncStateWithHistoryå‡½æ•°ï¼‰
         * ä»å†å²è®°å½•çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„variableStateè·å–å˜é‡çŠ¶æ€ï¼Œç„¶åä¿å­˜
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         */
        async _syncStateWithHistory(chatHistory) {
          // ä»æœ€åä¸€æ¡æ¶ˆæ¯çš„variableStateè·å–å˜é‡çŠ¶æ€
          const variables = (chatHistory.length > 0 && chatHistory[chatHistory.length - 1].variableState) || {};
          await this.saveChatHistoryToExtra(chatHistory, variables);
        }

        /**
         * ğŸ”¥ ä»æœ€åä¸€æ¡æ¶ˆæ¯æ¢å¤å˜é‡çŠ¶æ€ï¼ˆå‚è€ƒåˆ†æ2.jsçš„é€»è¾‘ï¼‰
         * åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œç¡®ä¿å˜é‡çŠ¶æ€æ­£ç¡®æ¢å¤
         */
        async restoreVariableStateFromLastMessage() {
          try {
            // 1. åŠ è½½èŠå¤©å†å²
            const chatHistory = await this.loadChatHistoryFromExtra();

            if (chatHistory && chatHistory.length > 0) {
              // 2. ä»æœ€åä¸€æ¡æ¶ˆæ¯çš„variableStateè·å–å˜é‡çŠ¶æ€ï¼ˆå‚è€ƒåˆ†æ2.jsçš„_syncStateWithHistoryï¼‰
              const lastMessage = chatHistory[chatHistory.length - 1];
              const variableState = lastMessage?.variableState || null;

              if (variableState) {
                console.log('ğŸ”„ ä»æœ€åä¸€æ¡æ¶ˆæ¯æ¢å¤å˜é‡çŠ¶æ€...');

                // 3. æ›´æ–°æœ¬åœ°çŠ¶æ€
                this.currentMvuState = JSON.parse(JSON.stringify(variableState));

                // 4. ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„_updateVariablesInScopeï¼šå…ˆæ›´æ–°messageå±‚ï¼Œå†åŒæ­¥åˆ°chatå±‚
                try {
                  if (typeof updateVariablesWith === 'function' && typeof getVariables === 'function') {
                    // 1. å…ˆæ›´æ–°messageå±‚ï¼ˆlatestæ¶ˆæ¯ï¼‰
                    await updateVariablesWith(() => JSON.parse(JSON.stringify(variableState)), {
                      type: 'message',
                      message_id: 'latest',
                    });

                    // 2. è·å–æ›´æ–°åçš„å˜é‡
                    const updated = getVariables({ type: 'message' });

                    // 3. åŒæ­¥åˆ°chatå±‚ï¼ˆè¿™æ ·æ•´ä¸ªä¼šè¯éƒ½èƒ½è®¿é—®ï¼‰
                    await updateVariablesWith(() => updated, { type: 'chat' });

                    console.log('âœ… å·²é€šè¿‡updateVariablesWithæ¢å¤messageå±‚å’Œchatå±‚å˜é‡çŠ¶æ€');
                  } else {
                    console.warn('âš ï¸ updateVariablesWithæˆ–getVariablesä¸å¯ç”¨ï¼Œä»…æ›´æ–°æœ¬åœ°çŠ¶æ€');
                  }
                } catch (varError) {
                  console.error('âŒ æ¢å¤å˜é‡çŠ¶æ€å¤±è´¥:', varError);
                  // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œè‡³å°‘æœ¬åœ°çŠ¶æ€å·²æ›´æ–°
                }

                // 5. é‡æ–°æ¸²æŸ“UIï¼ˆå¦‚æœæœ‰stat_dataï¼‰
                if (variableState.stat_data) {
                  this.renderUI(variableState.stat_data);
                }

                console.log('âœ… å˜é‡çŠ¶æ€å·²ä»æœ€åä¸€æ¡æ¶ˆæ¯æ¢å¤');
                return variableState;
              } else {
                console.log('ğŸ“ æœ€åä¸€æ¡æ¶ˆæ¯æ²¡æœ‰variableStateï¼Œè·³è¿‡å˜é‡æ¢å¤');
              }
            } else {
              console.log('ğŸ“ èŠå¤©å†å²ä¸ºç©ºï¼Œè·³è¿‡å˜é‡æ¢å¤');
            }
          } catch (error) {
            console.error('âŒ æ¢å¤å˜é‡çŠ¶æ€å¤±è´¥:', error);
          }
          return null;
        }

        // ğŸ”¥ è·å–å½“å‰å‘¨ç›®çš„åŸºç¡€é”®å
        _getBaseJourneyKey() {
          const index = this.unifiedIndex || 1;
          return index > 1 ? `æœ¬å‘¨ç›®ç»å†(${index})` : 'æœ¬å‘¨ç›®ç»å†';
        }

        _getBaseCoreMemoryKey() {
          const index = this.unifiedIndex || 1;
          return index > 1 ? `æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†(${index})` : 'æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†';
        }

        // ğŸ”¥ ç¦ç”¨å…¶ä»–å‘¨ç›®çš„åŒåæ¡ç›®ï¼ˆé¿å…AIè¯»å–é”™è¯¯çš„è®°å¿†ï¼‰
        async _disableOtherPlaythroughEntries(bookName, baseEntryKey, currentEntryKey) {
          try {
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const entriesToDisable = [];

            for (const entry of allEntries) {
              // æ£€æŸ¥æ˜¯å¦æ˜¯åŒç±»å‹çš„æ¡ç›®ï¼ˆæœ¬å‘¨ç›®ç»å† æˆ– æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†ï¼‰
              const isSameType = entry.comment.startsWith(baseEntryKey);
              // ä½†ä¸æ˜¯å½“å‰å‘¨ç›®çš„æ¡ç›®
              const isNotCurrent = entry.comment !== currentEntryKey;

              if (isSameType && isNotCurrent && entry.enabled) {
                entriesToDisable.push({ uid: entry.uid, enabled: false });
              }
            }

            if (entriesToDisable.length > 0) {
              await TavernHelper.setLorebookEntries(bookName, entriesToDisable);
              console.log(`âœ… å·²ç¦ç”¨ ${entriesToDisable.length} ä¸ªå…¶ä»–å‘¨ç›®çš„"${baseEntryKey}"æ¡ç›®`);
            }
          } catch (error) {
            console.error('ç¦ç”¨å…¶ä»–å‘¨ç›®æ¡ç›®å¤±è´¥:', error);
          }
        }

        // ğŸ”¥ æ£€æŸ¥æ˜¯å¦ä¸ºæ–°æ¸¸æˆä¼šè¯ï¼ˆchatIdå˜åŒ–ï¼‰
        async _checkNewGameSession() {
          try {
            const sessionStart = performance.now();
            const currentChatId = TavernHelper?.chatId || 'default';
            const lastChatIdKey = 'teresen_last_chat_id';
            const lastChatId = localStorage.getItem(lastChatIdKey);

            // ğŸ”¥ å…ˆåŠ è½½å½“å‰ä¼šè¯çš„å†å²ç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const cacheStart = performance.now();
            await this._loadHistoryCache();
            const cacheEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] _loadHistoryCache è€—æ—¶: ${(cacheEnd - cacheStart).toFixed(2)}ms`);

            // å¦‚æœchatIdå˜åŒ–ï¼Œè¯´æ˜æ˜¯æ–°æ¸¸æˆä¼šè¯
            if (lastChatId && lastChatId !== currentChatId) {
              console.log(`[æ–°æ¸¸æˆæ£€æµ‹] æ£€æµ‹åˆ°chatIdå˜åŒ–: ${lastChatId} -> ${currentChatId}`);

              // ğŸ”¥ åªæœ‰åœ¨å†å²ç¼“å­˜ä¸ºç©ºæ—¶æ‰æ¸…ç©ºï¼ˆé¿å…è¯»æ¡£ååˆè¢«æ¸…ç©ºï¼‰
              if (this.chatHistoryCache.length === 0) {
                console.log('[æ–°æ¸¸æˆæ£€æµ‹] å†å²ç¼“å­˜ä¸ºç©ºï¼Œå‡†å¤‡å¼€å§‹æ–°æ¸¸æˆ');

                // æ¸…ç©ºå½“å‰ä¼šè¯çš„å†å²è®°å½•å­˜å‚¨
                const historyKey = this._getHistoryKey();
                localStorage.removeItem(historyKey);
              } else {
                console.log(
                  `[æ–°æ¸¸æˆæ£€æµ‹] æ£€æµ‹åˆ°å·²æœ‰å†å²è®°å½• (${this.chatHistoryCache.length} ä¸ªå›åˆ)ï¼Œä¿ç•™å†å²ï¼ˆå¯èƒ½æ˜¯è¯»æ¡£åçš„çŠ¶æ€ï¼‰`,
                );
              }
            }

            // ä¿å­˜å½“å‰chatId
            localStorage.setItem(lastChatIdKey, currentChatId);

            // ğŸ”¥ å¦‚æœæ˜¯æ–°æ¸¸æˆï¼ˆå†å²ç¼“å­˜ä¸ºç©ºï¼‰ï¼Œåˆ›å»ºåˆå§‹å¿«ç…§ï¼ˆå‚è€ƒæ­£æ–‡å‚è€ƒ.htmlï¼‰
            if (this.chatHistoryCache.length === 0 && this.currentMvuState) {
              console.log('[æ–°æ¸¸æˆæ£€æµ‹] æ£€æµ‹åˆ°æ–°æ¸¸æˆï¼Œæ­£åœ¨åˆ›å»ºåˆå§‹çŠ¶æ€å¿«ç…§...');
              try {
                let initialMessage = 'æ¸¸æˆå¼€å§‹';
                try {
                  const initMsgStart = performance.now();
                  const messages = await getChatMessages('0');
                  const initMsgEnd = performance.now();
                  console.log(
                    `â±ï¸ [æ€§èƒ½] _checkNewGameSessionä¸­getChatMessages('0')è€—æ—¶: ${(initMsgEnd - initMsgStart).toFixed(2)}ms`,
                  );
                  initialMessage = messages?.[0]?.message || 'æ¸¸æˆå¼€å§‹';
                } catch (e) {
                  console.warn('[æ–°æ¸¸æˆæ£€æµ‹] è·å–åˆå§‹æ¶ˆæ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                }

                const initialSnapshot = {
                  message_id: `frontend-hist-initial-${Date.now()}`,
                  message: initialMessage.substring(0, 100), // ç®€åŒ–æ˜¾ç¤ºæ–‡æœ¬
                  is_user: false,
                  role: 'assistant',
                  data: {
                    ...JSON.parse(JSON.stringify(this.currentMvuState)),
                  },
                  timestamp: Date.now(),
                };

                this.chatHistoryCache.push(initialSnapshot);

                // ä¿å­˜åˆ°localStorage
                const historyKey = this._getHistoryKey();
                localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
                this.historyViewIndex = 0;

                console.log('[æ–°æ¸¸æˆæ£€æµ‹] âœ… åˆå§‹å¿«ç…§åˆ›å»ºå¹¶ä¿å­˜æˆåŠŸï¼');
              } catch (e) {
                console.error('[æ–°æ¸¸æˆæ£€æµ‹] åˆ›å»ºåˆå§‹å¿«ç…§å¤±è´¥:', e);
              }
            }
            const sessionEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] _checkNewGameSession æ€»è€—æ—¶: ${(sessionEnd - sessionStart).toFixed(2)}ms`);
          } catch (error) {
            console.error('[æ–°æ¸¸æˆæ£€æµ‹] æ£€æŸ¥æ–°æ¸¸æˆä¼šè¯å¤±è´¥:', error);
            const sessionEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] _checkNewGameSession å¤±è´¥ï¼Œæ€»è€—æ—¶: ${(sessionEnd - sessionStart).toFixed(2)}ms`);
          }
        }

        // ğŸ”¥ ä¿å­˜å›åˆå¿«ç…§åˆ°å†å²ç¼“å­˜
        async _finalizeTurn(textToSave) {
          try {
            if (!textToSave || !textToSave.trim()) {
              console.warn('[å†å²ç³»ç»Ÿ] æ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜å¿«ç…§');
              return;
            }

            const newSnapshot = {
              message_id: `frontend-hist-${Date.now()}`,
              message: textToSave,
              is_user: false,
              role: 'assistant',
              data: {
                ...(this.currentMvuState ? JSON.parse(JSON.stringify(this.currentMvuState)) : {}),
              },
              timestamp: Date.now(),
            };

            // ğŸ”¥ ç¡®ä¿chatHistoryCacheå·²åˆå§‹åŒ–
            if (!Array.isArray(this.chatHistoryCache)) {
              console.warn('[å†å²ç³»ç»Ÿ] chatHistoryCacheä¸æ˜¯æ•°ç»„ï¼Œé‡æ–°åˆå§‹åŒ–');
              this.chatHistoryCache = [];
            }

            this.chatHistoryCache.push(newSnapshot);

            // é™åˆ¶æœ€å¤š50æ¡è®°å½•
            if (this.chatHistoryCache.length > 50) {
              this.chatHistoryCache.shift();
            }

            // ä¿å­˜åˆ°localStorage
            const historyKey = this._getHistoryKey();
            localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
            this.historyViewIndex = this.chatHistoryCache.length - 1;

            console.log(`[å†å²ç³»ç»Ÿ] âœ… æ–°å›åˆå¿«ç…§å·²ä¿å­˜ï¼`);
            console.log(`  - å½“å‰æ€»æ•°: ${this.chatHistoryCache.length}`);
            console.log(`  - æ¶ˆæ¯é•¿åº¦: ${textToSave.length} å­—ç¬¦`);
            console.log(`  - å­˜å‚¨é”®: ${historyKey}`);
          } catch (error) {
            console.error('[å†å²ç³»ç»Ÿ] âŒ ä¿å­˜å›åˆå¿«ç…§å¤±è´¥:', error);
          }
        }

        // ğŸ”¥ åŠ è½½å†å²ç¼“å­˜ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨requestIdleCallbackå»¶è¿Ÿéå…³é”®æ•°æ®åŠ è½½ï¼‰
        async _loadHistoryCache() {
          const loadCacheStart = performance.now();
          try {
            // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šå¯¹äºå¤§æ•°æ®ï¼Œä½¿ç”¨requestIdleCallbackå»¶è¿ŸåŠ è½½
            const storedHistory = await new Promise(resolve => {
              if ('requestIdleCallback' in window) {
                requestIdleCallback(
                  () => {
                    const getItemStart = performance.now();
                    const data = localStorage.getItem(this._getHistoryKey());
                    const getItemEnd = performance.now();
                    console.log(`â±ï¸ [æ€§èƒ½] localStorage.getItem è€—æ—¶: ${(getItemEnd - getItemStart).toFixed(2)}ms`);
                    resolve(data);
                  },
                  { timeout: 100 },
                ); // æœ€å¤šç­‰å¾…100ms
              } else {
                // é™çº§æ–¹æ¡ˆï¼šç›´æ¥è¯»å–
                const getItemStart = performance.now();
                const data = localStorage.getItem(this._getHistoryKey());
                const getItemEnd = performance.now();
                console.log(`â±ï¸ [æ€§èƒ½] localStorage.getItem è€—æ—¶: ${(getItemEnd - getItemStart).toFixed(2)}ms`);
                resolve(data);
              }
            });

            if (storedHistory) {
              // ğŸ”¥ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨setTimeoutå°†JSONè§£ææ”¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œé¿å…é˜»å¡
              const parsed = await new Promise((resolve, reject) => {
                setTimeout(() => {
                  try {
                    const parseStart = performance.now();
                    const result = JSON.parse(storedHistory);
                    const parseEnd = performance.now();
                    console.log(
                      `â±ï¸ [æ€§èƒ½] JSON.parse è€—æ—¶: ${(parseEnd - parseStart).toFixed(2)}ms (æ•°æ®å¤§å°: ${storedHistory.length}å­—ç¬¦)`,
                    );
                    resolve(result);
                  } catch (e) {
                    reject(e);
                  }
                }, 0);
              });

              if (Array.isArray(parsed) && parsed.length > 0) {
                this.chatHistoryCache = parsed;
                this.historyViewIndex = this.chatHistoryCache.length - 1;
                console.log(`[å†å²ç³»ç»Ÿ] å·²åŠ è½½ ${this.chatHistoryCache.length} æ¡å†å²è®°å½•`);
              } else {
                this.chatHistoryCache = [];
                this.historyViewIndex = -1;
              }
            } else {
              this.chatHistoryCache = [];
              this.historyViewIndex = -1;
            }
          } catch (error) {
            console.error('[å†å²ç³»ç»Ÿ] åŠ è½½å†å²ç¼“å­˜å¤±è´¥:', error);
            this.chatHistoryCache = [];
            this.historyViewIndex = -1;
          }
          const loadCacheEnd = performance.now();
          console.log(`â±ï¸ [æ€§èƒ½] _loadHistoryCache è€—æ—¶: ${(loadCacheEnd - loadCacheStart).toFixed(2)}ms`);
        }

        // ğŸ”¥ è§£æ"æœ¬å‘¨ç›®ç»å†"å†…å®¹ä¸ºäº‹ä»¶æ•°ç»„
        parseJourneyEntry(contentString) {
          if (!contentString || typeof contentString !== 'string') return [];
          try {
            const events = [];
            // æŒ‰"åºå·|"åˆ†å‰²äº‹ä»¶å—
            const eventBlocks = contentString
              .trim()
              .split(/\n*\s*åºå·\|/)
              .filter(s => s.trim() !== '');

            const fieldOrder = [
              'æ—¥æœŸ',
              'æ ‡é¢˜',
              'åœ°ç‚¹',
              'äººç‰©',
              'æè¿°',
              'äººç‰©å…³ç³»',
              'æ ‡ç­¾',
              'é‡è¦ä¿¡æ¯',
              'æš—çº¿ä¸ä¼ç¬”',
              'è‡ªåŠ¨åŒ–ç³»ç»Ÿ',
            ];

            eventBlocks.forEach(block => {
              const firstLineEnd = block.indexOf('\n');
              const seq = block.substring(0, firstLineEnd !== -1 ? firstLineEnd : undefined).trim();
              if (!/\d+/.test(seq)) return; // è·³è¿‡æ— æ•ˆåºå·

              const event = { åºå·: seq };
              let remainingBlock = firstLineEnd !== -1 ? block.substring(firstLineEnd).trim() : '';

              // é€è¡Œè§£æå­—æ®µ
              const lines = remainingBlock.split('\n');
              let currentKey = null;
              for (const line of lines) {
                let matched = false;
                for (const key of fieldOrder) {
                  if (line.startsWith(key + '|')) {
                    if (currentKey && event[currentKey] === undefined) {
                      event[currentKey] = '';
                    }
                    currentKey = key;
                    event[currentKey] = line.substring(key.length + 1).trim();
                    matched = true;
                    break;
                  }
                }
                if (!matched && currentKey && event[currentKey] !== undefined) {
                  event[currentKey] += '\n' + line;
                }
              }
              events.push(event);
            });

            return events;
          } catch (e) {
            console.error('è§£æ"æœ¬å‘¨ç›®ç»å†"æ—¶å‡ºé”™:', e);
            return [];
          }
        }

        // ğŸ”¥ å°†äº‹ä»¶å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
        stringifyJourneyEvent(event) {
          const fieldOrder = [
            'åºå·',
            'æ—¥æœŸ',
            'æ ‡é¢˜',
            'åœ°ç‚¹',
            'äººç‰©',
            'æè¿°',
            'äººç‰©å…³ç³»',
            'æ ‡ç­¾',
            'é‡è¦ä¿¡æ¯',
            'æš—çº¿ä¸ä¼ç¬”',
            'è‡ªåŠ¨åŒ–ç³»ç»Ÿ',
          ];
          return fieldOrder
            .map(key => (event[key] ? `${key}|${event[key]}` : null))
            .filter(Boolean)
            .join('\n');
        }

        // ğŸ”¥ å†™å…¥ä¸–ç•Œä¹¦æ ¸å¿ƒæ–¹æ³•
        async writeToLorebook(baseEntryKey, contentToWrite, silent = false) {
          if (!contentToWrite || contentToWrite.trim() === '') {
            if (!silent) console.log('æ²¡æœ‰å¯å†™å…¥çš„å†…å®¹ã€‚');
            return;
          }

          const index = this.unifiedIndex || 1;
          const finalEntryKey = index > 1 ? `${baseEntryKey}(${index})` : baseEntryKey;
          const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ'; // ä¸–ç•Œä¹¦åç§°
          const reformattedContent = contentToWrite.trim();

          try {
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            let targetEntry = allEntries.find(entry => entry.comment === finalEntryKey);

            // å¦‚æœæ¡ç›®ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ
            if (!targetEntry) {
              if (!silent) console.log(`æ¡ç›® "${finalEntryKey}" ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...`);
              const baseEntryTemplate = allEntries.find(entry => entry.comment === baseEntryKey);
              const newEntryData = {
                comment: finalEntryKey,
                content: reformattedContent,
                keys: baseEntryTemplate ? [...baseEntryTemplate.keys, finalEntryKey] : [finalEntryKey],
                enabled: true, // ğŸ”¥ åˆ›å»ºæ—¶è‡ªåŠ¨æ¿€æ´»ï¼Œè®©AIèƒ½è¯»å–
                selective: baseEntryTemplate?.selective,
                constant: baseEntryTemplate?.constant,
                position: baseEntryTemplate?.position || 'in_chat',
                case_sensitive: baseEntryTemplate?.case_sensitive,
              };
              await TavernHelper.createLorebookEntries(bookName, [newEntryData]);
              if (!silent) console.log(`å·²åˆ›å»ºå¹¶å†™å…¥åˆ°"${finalEntryKey}"ï¼Œå¹¶å·²æ¿€æ´»ã€‚`);

              // ğŸ”¥ åˆ›å»ºåï¼Œç¦ç”¨å…¶ä»–å‘¨ç›®çš„åŒåæ¡ç›®ï¼ˆé¿å…AIè¯»å–é”™è¯¯çš„è®°å¿†ï¼‰
              await this._disableOtherPlaythroughEntries(bookName, baseEntryKey, finalEntryKey);
              return;
            }

            // å¦‚æœæ¡ç›®å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æˆ–è¿½åŠ é€»è¾‘
            const existingContent = targetEntry.content || '';
            let finalContent = '';

            if (baseEntryKey === 'æœ¬å‘¨ç›®ç»å†') {
              // ğŸ”¥ å…³é”®ï¼šå¯¹äº"æœ¬å‘¨ç›®ç»å†"ï¼Œéœ€è¦è§£æå¹¶åˆå¹¶äº‹ä»¶
              const existingEvents = this.parseJourneyEntry(existingContent);
              const newEvents = this.parseJourneyEntry(reformattedContent);
              if (newEvents.length === 0) return;

              const newEvent = newEvents[0];
              const newEventId = newEvent['åºå·'];
              const eventIndex = existingEvents.findIndex(event => event['åºå·'] === newEventId);

              if (eventIndex !== -1) {
                // å¦‚æœäº‹ä»¶å·²å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
                existingEvents[eventIndex] = newEvent;
                if (!silent) console.log(`å·²æ›´æ–°äº‹ä»¶ #${newEventId}ã€‚`);
              } else {
                // å¦‚æœäº‹ä»¶ä¸å­˜åœ¨ï¼Œè¿½åŠ å®ƒ
                existingEvents.push(newEvent);
                if (!silent) console.log(`å·²è¿½åŠ æ–°äº‹ä»¶ #${newEventId}ã€‚`);
              }

              // æŒ‰åºå·æ’åº
              existingEvents.sort((a, b) => (parseInt(a.åºå·, 10) || 0) - (parseInt(b.åºå·, 10) || 0));
              finalContent = existingEvents.map(ev => this.stringifyJourneyEvent(ev)).join('\n\n');
            } else if (baseEntryKey === 'æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†') {
              // å¯¹äºæ ¸å¿ƒè®°å¿†ï¼Œæ‰§è¡Œè¦†ç›–å¼æ›´æ–°
              finalContent = reformattedContent;
              if (!silent) console.log(`å·²æ›´æ–°"${finalEntryKey}"ã€‚`);
            } else {
              // å¯¹äºå…¶ä»–æ¡ç›®ï¼Œæ‰§è¡Œè¿½åŠ é€»è¾‘
              if (existingContent.includes(reformattedContent)) {
                if (!silent) console.log('å†…å®¹å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤å†™å…¥ã€‚');
                return;
              }
              finalContent = existingContent + (existingContent ? '\n\n' : '') + reformattedContent;
              if (!silent) console.log(`å·²è¿½åŠ å†…å®¹åˆ°"${finalEntryKey}"ã€‚`);
            }

            // å°†æœ€ç»ˆæ„å»ºå¥½çš„å†…å®¹å†™å›ä¸–ç•Œä¹¦
            await TavernHelper.setLorebookEntries(bookName, [{ uid: targetEntry.uid, content: finalContent }]);
          } catch (error) {
            console.error(`å†™å…¥ä¸–ç•Œä¹¦ "${finalEntryKey}" æ—¶å‡ºé”™:`, error);
            if (!silent) console.error(`å†™å…¥å¤±è´¥: ${error.message}`);
          }
        }

        // ğŸ”¥ å†™å…¥"æœ¬å‘¨ç›®ç»å†"
        async writeJourneyToLorebook(silent = false) {
          const content = this.lastExtractedJourney;
          await this.writeToLorebook('æœ¬å‘¨ç›®ç»å†', content, silent);
        }

        // ğŸ”¥ å†™å…¥"æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†"
        async writeCoreMemoryToLorebook(silent = false) {
          const content = this.lastExtractedCoreMemory;
          await this.writeToLorebook('æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†', content, silent);
        }

        // ğŸ”¥ ä»ä¸–ç•Œä¹¦è¯»å–è®°å¿†å¹¶ç»„è£…åŠ¨æ€ä¸Šä¸‹æ–‡
        async _assembleDynamicContext(userMessage) {
          let contextParts = [];
          const stat_data = this.currentMvuState?.stat_data;
          if (!stat_data) return '';

          // [çŸ­æœŸè®°å¿†]ï¼šè‡ªåŠ¨æå–æœ€æ–°çš„5ä¸ªäº‹ä»¶
          try {
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const index = this.unifiedIndex || 1;
            const journeyKey = index > 1 ? `æœ¬å‘¨ç›®ç»å†(${index})` : 'æœ¬å‘¨ç›®ç»å†';
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const journeyEntry = allEntries.find(entry => entry.comment === journeyKey);

            if (journeyEntry && journeyEntry.content) {
              const events = this.parseJourneyEntry(journeyEntry.content);
              if (events.length > 0) {
                const recentEvents = events.slice(-5); // åªå–æœ€å5ä¸ª
                const recentEventsText = recentEvents.map(ev => this.stringifyJourneyEvent(ev)).join('\n\n');
                contextParts.push(`[è¿‘æœŸå‘ç”Ÿçš„å‡ ä»¶äº‹]\n${recentEventsText}`);
              }
            }
          } catch (e) {
            console.error('[è®°å¿†ç³»ç»Ÿ] æå–çŸ­æœŸè®°å¿†æ—¶å‡ºé”™:', e);
          }

          // [æ ¸å¿ƒå‰§æƒ…æ‘˜è¦]ï¼šä»"æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†"è¯»å–è®°å¿†æ€»ç»“
          try {
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const index = this.unifiedIndex || 1;
            const coreMemoryKey = index > 1 ? `æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†(${index})` : 'æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†';
            const allEntries = await TavernHelper.getLorebookEntries(bookName);
            const coreMemoryEntry = allEntries.find(entry => entry.comment === coreMemoryKey);

            if (coreMemoryEntry && coreMemoryEntry.content) {
              contextParts.push(`[æ ¸å¿ƒå‰§æƒ…æ‘˜è¦]\n${coreMemoryEntry.content}`);
            }
          } catch (e) {
            console.error('[è®°å¿†ç³»ç»Ÿ] æå–æ ¸å¿ƒè®°å¿†æ—¶å‡ºé”™:', e);
          }

          // è¿”å›æœ€ç»ˆç»„åˆå¥½çš„ã€é«˜åº¦æµ“ç¼©çš„è®°å¿†å¤‡å¿˜å½•
          return contextParts.join('\n\n');
        }

        setupStreamListeners() {
          try {
            // è®¾ç½®æµå¼ä¼ è¾“å¤é€‰æ¡†äº‹ä»¶
            const streamingCheckbox = document.getElementById('streaming-checkbox');
            if (streamingCheckbox) {
              streamingCheckbox.addEventListener('change', event => {
                const isEnabled = event.target.checked;
                console.log(isEnabled ? 'âœ… æµå¼ä¼ è¾“å·²å¯ç”¨' : 'âŒ æµå¼ä¼ è¾“å·²ç¦ç”¨');
                // å­˜å‚¨æµå¼ä¼ è¾“çŠ¶æ€
                localStorage.setItem('teresen_streaming_enabled', isEnabled.toString());
              });

              // é»˜è®¤å‹¾é€‰æµå¼ä¼ è¾“ï¼ˆå¦‚æœlocalStorageä¸­æ²¡æœ‰å€¼æˆ–è€…æ˜¯falseï¼Œéƒ½è®¾ç½®ä¸ºtrueï¼‰
              const savedState = localStorage.getItem('teresen_streaming_enabled');
              if (savedState === 'true') {
                streamingCheckbox.checked = true;
              } else {
                // é»˜è®¤å‹¾é€‰ï¼ˆåŒ…æ‹¬é¦–æ¬¡ä½¿ç”¨æˆ–ä¹‹å‰æ˜¯falseçš„æƒ…å†µï¼‰
                streamingCheckbox.checked = true;
                localStorage.setItem('teresen_streaming_enabled', 'true');
              }
              console.log('ğŸ”„ æµå¼ä¼ è¾“å¤é€‰æ¡†äº‹ä»¶å·²è®¾ç½®');
            }

            // ğŸ”¥ è®¾ç½®èŠå¤©å†å²å¤é€‰æ¡†äº‹ä»¶
            // ğŸ”¥ æŸ¥çœ‹èŠå¤©æŒ‰é’® - åœ¨æ•…äº‹å†…å®¹åŒºåŸŸæ˜¾ç¤ºèŠå¤©è®°å½•ï¼ˆå¸¦ç¼–è¾‘åŠŸèƒ½ï¼‰
            const chatHistoryCheckbox = document.getElementById('chat-history-checkbox');
            if (chatHistoryCheckbox) {
              chatHistoryCheckbox.addEventListener('change', async event => {
                const isEnabled = event.target.checked;
                if (isEnabled) {
                  console.log('âœ… åœ¨æ•…äº‹å†…å®¹åŒºåŸŸæ˜¾ç¤ºèŠå¤©è®°å½•...');
                  await this.handleChatHistory();
                } else {
                  // æ¢å¤åŸå§‹æ•…äº‹å†…å®¹
                  await this.restoreStoryContent();
                }
              });
              console.log('ğŸ”„ æŸ¥çœ‹èŠå¤©æŒ‰é’®äº‹ä»¶å·²è®¾ç½®');
            }

            if ('undefined' != typeof eventOn && void 0 !== window.iframe_events) {
              const e = window.iframe_events;

              (eventOn(e.GENERATION_STARTED, () => {
                (console.log('ğŸš€ AIå¼€å§‹ç”Ÿæˆå›å¤'),
                  // ğŸ”¥ æ ‡è®°å¼€å§‹æµå¼ä¼ è¾“ï¼Œé˜²æ­¢updateStoryContentè¦†ç›–æµå¼å†…å®¹
                  (this.isStreaming = true),
                  // ğŸ”¥ åœ¨ç”Ÿæˆå¼€å§‹å‰ä¿å­˜å½“å‰æ­£æ–‡å†…å®¹ï¼Œç”¨äºç”Ÿæˆå¤±è´¥æ—¶æ¢å¤
                  (() => {
                    const storyContent = document.getElementById('story-content');
                    if (storyContent) {
                      this.lastValidStoryContentBeforeGeneration = storyContent.innerHTML;
                      console.log('ğŸ’¾ å·²ä¿å­˜ç”Ÿæˆå‰çš„æ­£æ–‡å†…å®¹ï¼Œç”¨äºå¯èƒ½çš„æ¢å¤');
                    }
                  })(),
                  this.startReplyTiming());
              }),
                eventOn(e.STREAM_TOKEN_RECEIVED_FULLY, e => {
                  // æ£€æŸ¥æµå¼ä¼ è¾“æ˜¯å¦å¯ç”¨
                  const isStreamingEnabled = document.getElementById('streaming-checkbox')?.checked;
                  if (isStreamingEnabled) {
                    this.handleStreamUpdate(e);

                    // å¯åŠ¨é«˜é¢‘æµå¼æ›´æ–°
                    this.startHighFrequencyStreaming();
                  }
                }),
                eventOn(e.GENERATION_ENDED, e => {
                  console.log('âœ… AIå›å¤ç”Ÿæˆå®Œæˆ');
                  // ğŸ”¥ æ ‡è®°æµå¼ä¼ è¾“ç»“æŸï¼Œå…è®¸updateStoryContentæ›´æ–°
                  this.isStreaming = false;
                  this.endReplyTimer();

                  // åœæ­¢é«˜é¢‘æµå¼æ›´æ–°
                  if (this.highFrequencyStreamingInterval) {
                    clearInterval(this.highFrequencyStreamingInterval);
                    this.highFrequencyStreamingInterval = null;
                  }

                  // ğŸ”¥ ç”Ÿæˆç»“æŸåï¼Œæ˜¾ç¤ºé€‰é¡¹ï¼ˆå¦‚æœæœ‰ï¼‰
                  const latestMessage = document.querySelector('.message:last-child .message-content');
                  if (latestMessage && latestMessage.textContent) {
                    const actionContent = this._extractLastTagContent('action', latestMessage.textContent);
                    if (actionContent && actionContent.trim()) {
                      this.updateActionOptionsFromContent(actionContent);
                    }
                  }

                  // ğŸ”¥ ç”Ÿæˆç»“æŸåï¼Œç§»é™¤å˜é‡æ›´æ–°è£…é¥°çš„åŠ¨ç”»ç±»
                  const decoration = document.getElementById('variable-update-decoration');
                  if (decoration) {
                    decoration.classList.remove('updating');
                  }

                  // æ¸…ç©ºé˜²æŠ–å®šæ—¶å™¨ï¼Œç¡®ä¿æœ€åä¸€æ¬¡æ›´æ–°èƒ½ç«‹å³æ‰§è¡Œ
                  if (this.streamUpdateDebounceTimer) {
                    clearTimeout(this.streamUpdateDebounceTimer);
                    this.streamUpdateDebounceTimer = null;
                  }

                  // å¤„ç†ç”Ÿæˆç»“æŸï¼šå…ˆå¤„ç†å˜é‡æ›´æ–°ï¼Œå†æ›´æ–°ç•Œé¢
                  this.handleGenerationEnd(e);

                  // AIå›å¤å®Œæˆåï¼Œè®©ä¸­å¤®é¢æ¿æ»šåŠ¨åˆ°é¡¶éƒ¨
                  setTimeout(() => {
                    const centerPanel = document.querySelector('.center-panel');
                    if (centerPanel) {
                      centerPanel.scrollTop = 0;
                      console.log('ğŸ“œ ä¸­å¤®é¢æ¿å·²æ»šåŠ¨åˆ°é¡¶éƒ¨');
                    }
                  }, 100);

                  // AIå›å¤å®Œæˆåï¼Œæ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºQTEï¼ˆç®€åŒ–ç‰ˆï¼‰

                  setTimeout(() => {
                    try {
                      console.log('ğŸ” æ£€æµ‹QTEè§¦å‘æ¡ä»¶...');

                      // æ–¹æ³•1ï¼šé€šè¿‡TavernHelper APIè·å–æœ€æ–°AIæ¶ˆæ¯

                      let aiContent = '';

                      if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {
                        try {
                          const messages = TavernHelper.getChatMessages();

                          const aiMessages = messages.filter(msg => msg.role === 'assistant');

                          if (aiMessages.length > 0) {
                            const lastMessage = aiMessages[aiMessages.length - 1];

                            aiContent = lastMessage.content || '';

                            console.log('ğŸ” é€šè¿‡APIè·å–AIå†…å®¹ï¼Œé•¿åº¦:', aiContent.length);
                          }
                        } catch (apiError) {
                          console.warn('APIè·å–å¤±è´¥ï¼Œä½¿ç”¨DOMæ–¹æ³•:', apiError);
                        }
                      }

                      // æ–¹æ³•2ï¼šå¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨DOMæ–¹æ³•

                      if (!aiContent) {
                        aiContent =
                          $('#chat_container .mes_text_ai').last().text() ||
                          $('#chat_container .mes_text').last().text() ||
                          '';

                        console.log('ğŸ” é€šè¿‡DOMè·å–AIå†…å®¹ï¼Œé•¿åº¦:', aiContent.length);
                      }

                      console.log('ğŸ” AIå†…å®¹å‰100å­—ç¬¦:', aiContent.substring(0, 100));

                      if (aiContent && this.containsBindingKeywords(aiContent)) {
                        $('#qte-section').show();

                        console.log('ğŸ® QTEå·²æ˜¾ç¤º');
                      } else {
                        $('#qte-section').hide();

                        console.log('ğŸ® QTEå·²éšè—');
                      }
                    } catch (error) {
                      console.error('âŒ QTEæ£€æµ‹å¤±è´¥:', error);
                    }
                  }, 1500);
                }),
                console.log('âœ… æµå¼æ›´æ–°ç›‘å¬å™¨è®¾ç½®å®Œæˆ'));
            } else
              (console.warn('âš ï¸ æµå¼äº‹ä»¶APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ›´æ–°æ–¹å¼'),
                $('#btn-send-action').on('click', () => {
                  (console.log('ğŸš€ å¤‡ç”¨æ–¹æ¡ˆï¼šå¼€å§‹è®¡æ—¶'), this.startReplyTiming());
                }));
          } catch (e) {
            console.error('âŒ è®¾ç½®æµå¼ç›‘å¬å™¨å¤±è´¥:', e);
          }
        }

        startReplyTiming() {
          const e = new Date().getTime();

          (localStorage.setItem('teresen_reply_start_time', e.toString()),
            localStorage.setItem('teresen_waiting_for_reply', 'true'),
            console.log('â±ï¸ å¼€å§‹è®¡æ—¶:', new Date(e).toLocaleString()));
        }

        endReplyTimer() {
          try {
            const e = localStorage.getItem('teresen_reply_start_time'),
              t = localStorage.getItem('teresen_waiting_for_reply');

            if (e && 'true' === t) {
              const t = parseInt(e),
                n = new Date().getTime() - t;

              const seconds = Math.floor(n / 1e3);

              // æ ¹æ®å›å¤æ—¶é—´ç”Ÿæˆè¯„ä»·

              let evaluation = '';

              if (seconds <= 20) {
                evaluation = 'ç¥ï¼';
              } else if (seconds <= 30) {
                evaluation = 'å¾ˆå¿«ï¼';
              } else if (seconds <= 40) {
                evaluation = 'å¿«ï¼';
              } else if (seconds <= 50) {
                evaluation = 'è¿˜è¡Œï¼';
              } else if (seconds <= 60) {
                evaluation = 'ä¸€èˆ¬ï¼';
              } else if (seconds <= 90) {
                evaluation = 'æ…¢ï¼';
              } else if (seconds <= 120) {
                evaluation = 'å¾ˆæ…¢ï¼';
              } else {
                evaluation = 'å¤ªæ…¢äº†ï¼';
              }

              (localStorage.setItem('teresen_last_reply_time', n.toString()),
                localStorage.setItem('teresen_waiting_for_reply', 'false'),
                localStorage.setItem('teresen_last_reply_evaluation', evaluation),
                console.log(`âœ… å›å¤ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶: ${seconds}ç§’ï¼ŒEçœ¼ç›¯å¸§ï¼š${evaluation}`),
                this.updateReplyTimer());
            }
          } catch (e) {
            console.error('ç»“æŸè®¡æ—¶å¤±è´¥:', e);
          }
        }

        async updateStoryContent() {
          const perfStart = performance.now();
          const callStack = new Error().stack?.split('\n').slice(1, 4).join(' -> ') || 'unknown';
          console.log(`â±ï¸ [æ€§èƒ½] updateStoryContent å¼€å§‹ (è°ƒç”¨æ¥æº: ${callStack})`);

          // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ­£åœ¨æŸ¥çœ‹èŠå¤©å†å²ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡ï¼ˆé¿å…è¦†ç›–èŠå¤©å†å²æ˜¾ç¤ºï¼‰
          const chatHistoryCheckbox = document.getElementById('chat-history-checkbox');
          if (chatHistoryCheckbox && chatHistoryCheckbox.checked) {
            console.log('â­ï¸ æ­£åœ¨æŸ¥çœ‹èŠå¤©å†å²ï¼Œè·³è¿‡updateStoryContentä»¥é¿å…è¦†ç›–èŠå¤©å†å²æ˜¾ç¤º');
            return;
          }

          // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¦‚æœæ­£åœ¨æµå¼ä¼ è¾“ï¼Œè·³è¿‡æ›´æ–°ï¼ˆé¿å…è¦†ç›–æµå¼ä¼ è¾“æ˜¾ç¤ºçš„å†…å®¹ï¼‰
          if (this.isStreaming) {
            console.log('â­ï¸ æ­£åœ¨æµå¼ä¼ è¾“ï¼Œè·³è¿‡updateStoryContentï¼ˆé¿å…è¦†ç›–æµå¼å†…å®¹ï¼‰');
            return;
          }

          try {
            let n = '';
            let originalMessage = ''; // ä¿å­˜åŸå§‹æ¶ˆæ¯ï¼Œç”¨äºæå–action

            // ğŸ”¥ ä» extra.teresen_chat è·å–å…¨éƒ¨å†å²æ¶ˆæ¯ï¼Œå–æœ€æ–°ä¸€æ¡ç”¨äºæ˜¾ç¤º
            try {
              const apiStart = performance.now();
              const chatHistory = await this.loadChatHistoryFromExtra();
              const apiEnd = performance.now();
              const apiTime = (apiEnd - apiStart).toFixed(2);
              console.log(`â±ï¸ [æ€§èƒ½] loadChatHistoryFromExtra è€—æ—¶: ${apiTime}ms`);

              if (chatHistory && chatHistory.length > 0) {
                // è·å–æœ€åä¸€æ¡assistantæ¶ˆæ¯ï¼ˆAIå›å¤ï¼‰
                const assistantMessages = chatHistory.filter(msg => msg.role === 'assistant');
                if (assistantMessages.length > 0) {
                  const latestMsg = assistantMessages[assistantMessages.length - 1];
                  originalMessage = latestMsg.content;
                  n = originalMessage;
                  console.log(
                    `âœ… ä»extra.teresen_chatè·å–åˆ°å†…å®¹ (å…±${chatHistory.length}æ¡æ¶ˆæ¯, æœ€æ–°AIå›å¤é•¿åº¦: ${n.length}å­—ç¬¦)`,
                  );
                } else {
                  // å¦‚æœæ²¡æœ‰assistantæ¶ˆæ¯ï¼Œä½¿ç”¨æœ€åä¸€æ¡æ¶ˆæ¯
                  const latestMsg = chatHistory[chatHistory.length - 1];
                  originalMessage = latestMsg.content;
                  n = originalMessage;
                  console.log(
                    `âœ… ä»extra.teresen_chatè·å–åˆ°å†…å®¹ (å…±${chatHistory.length}æ¡æ¶ˆæ¯, æœ€æ–°æ¶ˆæ¯é•¿åº¦: ${n.length}å­—ç¬¦)`,
                  );
                }
              } else {
                console.log('ğŸ“ extra.teresen_chatä¸ºç©ºï¼Œå°è¯•ä»0å±‚æ¶ˆæ¯è·å–ï¼ˆå…¼å®¹æ€§å›é€€ï¼‰');
                // å¦‚æœextraä¸­æ²¡æœ‰ï¼Œå›é€€åˆ°0å±‚æ¶ˆæ¯ï¼ˆå…¼å®¹æ€§ï¼Œä»…ç”¨äºè¿ç§»ï¼‰
                // ğŸ”¥ å…³é”®ä¿®å¤ï¼šåªåœ¨é¦–æ¬¡è¿ç§»æ—¶æ‰§è¡Œï¼Œé¿å…é‡å¤è¿ç§»å¯¼è‡´å†å²è¢«é‡ç½®
                const migrationKey = 'teresen_chat_migrated_' + (TavernHelper?.chatId || 'default');
                const hasMigrated = localStorage.getItem(migrationKey) === 'true';

                if ('function' == typeof getChatMessages) {
                  const e = await getChatMessages(0);
                  if (e && e.length > 0 && e[0].message) {
                    originalMessage = e[0].message;
                    n = originalMessage;
                    console.log(`âš ï¸ ä»0å±‚æ¶ˆæ¯è·å–åˆ°å†…å®¹ (å…¼å®¹æ€§å›é€€, é•¿åº¦: ${n.length}å­—ç¬¦)`);
                    // ğŸ”¥ åªåœ¨æœªè¿ç§»è¿‡ä¸”å†…å®¹æœ‰æ•ˆæ—¶æ‰è¿ç§»
                    if (!hasMigrated && n && n.trim() && n !== 'å†…å®¹ä¸ºç©ºï¼è¯·æ£€æŸ¥ä½ çš„api\nè‹¥è¦ç»§ç»­ï¼Œè¯·è¯»å–ä¸Šä¸€æ¬¡å­˜æ¡£') {
                      console.log('ğŸ”„ æ£€æµ‹åˆ°0å±‚æœ‰å†…å®¹ä½†extraä¸ºç©ºï¼Œå¼€å§‹è¿ç§»ï¼ˆä»…é¦–æ¬¡ï¼‰...');
                      await this.addMessageToExtra('assistant', n, null);
                      localStorage.setItem(migrationKey, 'true'); // æ ‡è®°å·²è¿ç§»
                      console.log('âœ… å·²è¿ç§»0å±‚æ¶ˆæ¯åˆ°extra.teresen_chatï¼ˆä»…é¦–æ¬¡ï¼‰');
                    } else if (hasMigrated) {
                      console.log('â­ï¸ å·²è¿ç§»è¿‡ï¼Œè·³è¿‡è¿ç§»ï¼ˆé¿å…é‡å¤ï¼‰');
                    }
                  }
                }
              }
            } catch (e) {
              console.warn('âŒ ä»extra.teresen_chatè·å–æ¶ˆæ¯å¤±è´¥ï¼Œå°è¯•å›é€€åˆ°0å±‚æ¶ˆæ¯:', e);
              // å›é€€åˆ°0å±‚æ¶ˆæ¯ï¼ˆä»…ä½œä¸ºæœ€åçš„åå¤‡æ–¹æ¡ˆï¼‰
              if ('function' == typeof getChatMessages) {
                try {
                  const e = await getChatMessages(0);
                  if (e && e.length > 0 && e[0].message) {
                    originalMessage = e[0].message;
                    n = originalMessage;
                    console.log('âš ï¸ ä½¿ç”¨0å±‚æ¶ˆæ¯ä½œä¸ºåå¤‡æ–¹æ¡ˆ');
                  }
                } catch (err) {
                  console.warn('âŒ è·å–0å±‚æ¶ˆæ¯ä¹Ÿå¤±è´¥:', err);
                }
              }
            }

            // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹

            if (!n) {
              n = 'å†…å®¹ä¸ºç©ºï¼è¯·æ£€æŸ¥ä½ çš„api\nè‹¥è¦ç»§ç»­ï¼Œè¯·è¯»å–ä¸Šä¸€æ¬¡å­˜æ¡£';
              originalMessage = n; // ä¿å­˜åŸå§‹æ¶ˆæ¯
            }

            // æå– <content></content> æ ‡ç­¾ä¸­çš„å†…å®¹
            const extractStart = performance.now();
            const contentMatch = n.match(/<content>(.*?)<\/content>/s);

            if (contentMatch) {
              n = contentMatch[1].trim();
              console.log('âœ… ä»<content></content>æ ‡ç­¾ä¸­æå–å†…å®¹æˆåŠŸ');
            } else {
              console.log('ğŸ“ æœªæ‰¾åˆ°<content></content>æ ‡ç­¾ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
            }
            const extractEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] æå–contentæ ‡ç­¾è€—æ—¶: ${(extractEnd - extractStart).toFixed(2)}ms`);

            // åº”ç”¨å»å…«è‚¡æ­£åˆ™è„šæœ¬
            const regexStart = performance.now();
            n = this.applyAntiBoilerplateRules(n);
            const regexEnd = performance.now();
            const regexTime = (regexEnd - regexStart).toFixed(2);
            console.log(`â±ï¸ [æ€§èƒ½] applyAntiBoilerplateRules è€—æ—¶: ${regexTime}ms`);

            const domStart = performance.now();
            const s = document.getElementById('story-content');

            if (s) {
              s.innerHTML = `<p class="story-text">${n}</p>`;

              // ğŸ”¥ åº”ç”¨ä¿å­˜çš„å­—ä½“è®¾ç½®
              const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
              const size = localStorage.getItem('teresen_font_size') || '1';
              $('.story-text').css({
                'font-family': font,
                'font-size': size + 'em',
              });

              // æ£€æŸ¥æ­£æ–‡æ˜¯å¦å¯è§
              const rect = s.getBoundingClientRect();
              const isVisible = rect.width > 0 && rect.height > 0;
              console.log(
                `â±ï¸ [æ€§èƒ½] æ­£æ–‡å…ƒç´ çŠ¶æ€: å¯è§=${isVisible}, ä½ç½®=(${rect.left}, ${rect.top}), å¤§å°=(${rect.width}, ${rect.height})`,
              );

              // ä½¿ç”¨requestAnimationFrameæ£€æŸ¥å®é™…æ¸²æŸ“æ—¶é—´
              requestAnimationFrame(() => {
                const renderTime = performance.now();
                console.log(`â±ï¸ [æ€§èƒ½] æ­£æ–‡é¦–æ¬¡æ¸²æŸ“å®Œæˆï¼Œè·ç¦»DOMæ›´æ–°: ${(renderTime - domStart).toFixed(2)}ms`);
              });
            } else {
              console.warn('â±ï¸ [æ€§èƒ½è­¦å‘Š] story-content å…ƒç´ æœªæ‰¾åˆ°ï¼');
            }

            const domEnd = performance.now();
            console.log(`â±ï¸ [æ€§èƒ½] DOMæ“ä½œè€—æ—¶: ${(domEnd - domStart).toFixed(2)}ms`);

            // ğŸ”¥ æå–å¹¶æ˜¾ç¤ºactioné€‰é¡¹ï¼ˆä½¿ç”¨åŸå§‹å®Œæ•´æ¶ˆæ¯ï¼ŒåŒ…å«actionæ ‡ç­¾ï¼‰
            this.updateActionOptions(originalMessage || n);

            // èŠå¤©å†å²é¢æ¿å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°

            const perfEnd = performance.now();
            const totalTime = (perfEnd - perfStart).toFixed(2);
            console.log(`â±ï¸ [æ€§èƒ½] updateStoryContent æ€»è€—æ—¶: ${totalTime}ms`);
          } catch (e) {
            console.log('æ— æ³•è·å–æ­£æ–‡å†…å®¹:', e);
            const perfEnd = performance.now();
            const totalTime = (perfEnd - perfStart).toFixed(2);
            console.log(`â±ï¸ [æ€§èƒ½] updateStoryContent å¤±è´¥ï¼Œæ€»è€—æ—¶: ${totalTime}ms`);
          }
        }

        applyAntiBoilerplateRules(content) {
          if (!content || typeof content !== 'string') return content;

          const ruleStart = performance.now();
          let processed = content;

          // åŸºç¡€æ€»åˆ™ - åˆ é™¤ç‰¹å®šè¯æ±‡
          processed = processed.replace(
            /((?:ç»æœ›|éº»æœ¨|å‹¾èµ·|ä¸€ä¸(?:ä¸)|å°é—­|åƒµä½|ææƒ§|ææ…Œ|æƒ§æ€•|éœ‡æƒŠ|ç¾è€»|å±ˆè¾±|ç—…æ€|å´©æºƒ|å››è‚¢ç™¾éª¸|cá»‘gáº¯ng|subtly|yet|æ»šçƒ«çš„å²©æµ†|ç”Ÿç†(?:çš„|æ€§|å±‚é¢|æœ¬èƒ½)|å‹æŠ‘|ä¸ä¼¼äººå£°|æœºæ¢°åœ°|é‡å…½|å¹¼å…½|æ¯’è›‡|è—¤è”“|ç¼ ç»•|è‚‰åˆƒ|å°–é”|å†°å†·|éš¾ä»¥ç½®ä¿¡|ä¸å®¹(?:ç½®ç–‘|ç½®å–™)|æ³›ç™½|ä»–çŸ¥é“|å¥¹çŸ¥é“|æ¿’ä¸´å¤±æ§|æ„å‘³æ·±é•¿|é‚ªé­…|é‚ªç¬‘|ååƒå…¥è…¹|æµ·å•¸|é—ªç€|é—ªçƒ|ä½å¼|å”‡èˆŒ|ç ”ç£¨|éª¨è¡€|éª¨è¡€ä¹‹ä¸­|èºå€™|æè‡´|å¼§åº¦|å°(?:å…½|å¦–ç²¾|éªšè´§|å¯çˆ±|æåº¦|ä¸œè¥¿|ç‹ç‹¸|é‡çŒ«)|å¼“(?:èµ·|ç€))[åœ°ä¸çš„å¾—]?\**)/g,
            '  ',
          );

          // åˆ é™¤æ€»åˆ™ - åˆ é™¤ç‰¹å®šè¡¨è¾¾
          processed = processed.replace(
            /ä¸ä¼¼äººå£°(çš„|åœ°|å¾—)?|(æ¨ä¸|æƒ³è¦).*?å¡è¿›å»[,\\.ï¼Œã€‚]?|ä¸å®¹[\u4e00-\u9fff]{2}(çš„|åœ°|å¾—)/g,
            '',
          );

          // è­¦è§‰æ›¿æ¢
          processed = processed.replace(/(è­¦è§‰|è­¦è§‰)/g, this.getRandomReplacement(['ç•™å¿ƒ', 'ç¨ä½œç•™æ„', 'æ³¨æ„']));

          // é¤è¶³æ›¿æ¢
          processed = processed.replace(/(é¤è¶³)/g, 'æ»¡è¶³');

          // é‡å…½ç³»æ›¿æ¢
          processed = processed.replace(
            /(å°å…½|å¹¼å…½)/g,
            this.getRandomReplacement(['åƒå°çŒ«', 'ç‡ç›´', 'æœ¬èƒ½è€Œæ€¥åˆ‡', 'åƒå°ç‹—', 'çº¯ç²¹å‡­ç€æ„Ÿè§‰', 'æ‡µæ‡µæ‡‚æ‡‚']),
          );

          // è‚‰åˆƒæ›¿æ¢
          processed = processed.replace(
            /(è‚‰åˆƒ|è‚‰èŒ)/g,
            this.getRandomReplacement(['è‚‰æŸ±', 'é˜³å…·', 'é˜´èŒ', 'é¸¡å·´', 'å·¨ç‰©', 'é¾™æ ¹']),
          );

          // ç—‰æŒ›æ›¿æ¢
          processed = processed.replace(/(ç—‰æŒ›)/g, this.getRandomReplacement(['æŠ½æ', 'å¼ºåŠ›æ”¶ç¼©', 'è‚Œè‚‰ç´§å¼ ']));

          // ç”¬é“æ›¿æ¢
          processed = processed.replace(/(ç”¬é“)/g, 'é€šé“');

          // ç”Ÿç†ç³»æ›¿æ¢
          processed = processed.replace(
            /(ç”Ÿç†æ€§|ç”Ÿç†ä¸Š|ç”Ÿç†å±‚é¢)/g,
            this.getRandomReplacement(['æœ¬èƒ½çš„', 'æºè‡ªèº«ä½“çš„']),
          );

          // ç‹¡é» æ›¿æ¢
          processed = processed.replace(/(ç‹¡é» )/g, this.getRandomReplacement(['å¤çµç²¾æ€ª', 'è°ƒçš®', 'ä¿ƒç‹­']));

          // ç­é¡¶æ›¿æ¢
          processed = processed.replace(/(ç­é¡¶)/g, this.getRandomReplacement(['å¼ºçƒˆ', 'æ— è¾¹', 'éš¾ä»¥è¨€å–»']));

          // æœºæ¢°åœ°æ›¿æ¢
          processed = processed.replace(/(æœºæ¢°åœ°)/g, this.getRandomReplacement(['å•è°ƒåœ°', 'ä¸»åŠ¨åœ°']));

          // æ‰­æ›²æ›¿æ¢
          processed = processed.replace(/(æ‰­æ›²)/g, this.getRandomReplacement(['åˆ«æ ·', 'ä¸å‡¡', 'ç‹¬ç‰¹', 'ç‰¹æ®Š']));

          // å°é—­æ›¿æ¢
          processed = processed.replace(/(å°é—­)/g, this.getRandomReplacement(['ç•¥æœ‰çŠ¹è±«', 'è‹¥æœ‰æ‰€æ€', 'çŸ­æš‚æ²‰é»˜']));

          // å››è‚¢ç™¾éª¸æ›¿æ¢
          processed = processed.replace(
            /(å››è‚¢ç™¾éª¸)/g,
            this.getRandomReplacement(['å…¨èº«', 'å‘¨èº«', 'ä»å¤´åˆ°è„š', 'æ•´ä¸ªèº«ä½“']),
          );

          // å–Ÿå¹æ›¿æ¢
          processed = processed.replace(/(å–Ÿå¹)/g, this.getRandomReplacement(['å¹æ¯', 'æ„Ÿå¹']));

          // å¼å«ç±»æ›¿æ¢
          processed = processed.replace(
            /(ä½å¼)/g,
            this.getRandomReplacement(['é—·å“¼', 'ä½å–˜', 'å–‰éŸ³', 'ç²—é‡çš„å‘¼å¸', 'ä½å¼']),
          );

          // å‹æ›¿æ¢
          processed = processed.replace(/(å‹)/g, 'çŒ›');

          // å…¨ç„¶æ›¿æ¢
          processed = processed.replace(/(å…¨ç„¶)/g, this.getRandomReplacement(['çº¯ç²¹', 'å®Œå…¨', 'å…¨èº«å¿ƒ']));

          // ä¸æ˜“å¯Ÿè§‰æ›¿æ¢
          processed = processed.replace(
            /(ä¸æ˜“å¯Ÿè§‰)/g,
            this.getRandomReplacement(['éš¾ä»¥å¯Ÿè§‰', 'ç»†å¾®', 'éšçº¦', 'éš¾ä»¥è§‰å¯Ÿ']),
          );

          // ä¸€ä¸æ›¿æ¢
          processed = processed.replace(
            /(ä¸€ä¸ä¸|ä¸€ä¸(?!ä¸è‹Ÿ))/g,
            this.getRandomReplacement(['äº›å¾®', 'äº›è®¸', 'ä¸€ç‚¹', 'ä¸€ä¸']),
          );

          // å¤–è¯­è¯æ±‡æ›¿æ¢
          processed = processed.replace(/(Ğ²Ğ»Ğ°Ğ¶Ğ½Ğ¾Ğ¹)/g, this.getRandomReplacement(['æ¹¿æ¶¦', 'æ³›æ»¥', 'æ³¥æ³']));
          processed = processed.replace(/(vÃ©n)/g, 'é™è„‰');
          processed = processed.replace(/(subtly)/g, this.getRandomReplacement(['å¾®å¦™çš„', 'ç²¾å¦™çš„']));
          processed = processed.replace(/(strangely)/g, 'å¥‡æ€ª');
          processed = processed.replace(/(cá»‘gáº¯ng)/g, this.getRandomReplacement(['åŠªåŠ›åœ°', 'å°½åŠ›åœ°', 'åŠ›å›¾']));

          // æŠ•çŸ³ç³»åˆ é™¤ - åˆ é™¤å„ç§æŠ•çŸ³ç›¸å…³çš„è¡¨è¾¾
          processed = processed.replace(
            /(?:[,ï¼Œ]\s*)?(?:(?:å¦‚åŒ|ä»¿ä½›|çŠ¹å¦‚|åƒ)\s+)?[^.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?(?:æ‰è½|æ‰å…¥|æ‰è¿›|æŠ›å…¥|æŠ›è¿›|æŠ›è½|è½å…¥|æŠ•è¿›|æŠ•å…¥|ä¸¢è¿›|ä¸¢å…¥|æ”¾å…¥|æŠ•ä¸‹)[^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?(?:(?:é£|é“å—|ç§å­|é“œå—|é‡‘å—|å†°å—|çŸ³å¤´|çŸ³å­|å¤§çŸ³|å·¨çŸ³|ç‚¸å¼¹|é¹…åµçŸ³|æ¸…æ²¹|ç³–æœ|æ»´æ°´|æµ·ç»µ|æµ“å¢¨|é—ªç”µ|å‚¬åŒ–å‰‚|å†·æ°´|é’¥åŒ™|æ°´æ»´|å†°æ°´|å†°å±±)[^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n][^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?æ¶Ÿæ¼ª[)ï¼‰]?|(?:é£|é“å—|ç§å­|é“œå—|é‡‘å—|å†°å—|çŸ³å¤´|çŸ³å­|å¤§çŸ³|å·¨çŸ³|ç‚¸å¼¹|é¹…åµçŸ³|æ¸…æ²¹|ç³–æœ|æ»´æ°´|æµ·ç»µ|æµ“å¢¨|é—ªç”µ|å‚¬åŒ–å‰‚|å†·æ°´|é’¥åŒ™|æ°´æ»´|å†°æ°´|å†°å±±)[)ï¼‰]?|[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n][^,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n]*?æ¶Ÿæ¼ª[)ï¼‰]?|[,ï¼Œ.ã€‚ï¼ï¼Ÿ>:ï¼š""\n])/g,
            '',
          );

          // å…¶ä»–å¸¸è§æ›¿æ¢
          processed = processed.replace(/(ç»æœ›|éº»æœ¨|å´©æºƒ)/g, 'å¤±è½');
          processed = processed.replace(/(ææƒ§|ææ…Œ|æƒ§æ€•)/g, 'å®³æ€•');
          processed = processed.replace(/(éœ‡æƒŠ|éš¾ä»¥ç½®ä¿¡)/g, 'æƒŠè®¶');
          processed = processed.replace(/(ç¾è€»|å±ˆè¾±)/g, 'ç¾æ„§');

          // æ–‡æœ¬æ ¼å¼ç¾åŒ–
          processed = processed.replace(/â€œ([^â€]+)â€/g, (match, p1) => {
            return `<span class="dialogue-text">${match}</span>`;
          });
          processed = processed.replace(/\[([^\]]+)\]/g, (match, p1) => {
            return `<span class="psychology-text">${match}</span>`;
          });
          processed = processed.replace(/\*\*([^*]+)\*\*/g, (match, p1) => {
            return `<span class="scenery-text">${match}</span>`;
          });

          const ruleEnd = performance.now();
          const ruleTime = (ruleEnd - ruleStart).toFixed(2);
          if (ruleTime > 10) {
            console.log(
              `â±ï¸ [æ€§èƒ½è­¦å‘Š] applyAntiBoilerplateRules è€—æ—¶è¾ƒé•¿: ${ruleTime}ms (æ–‡æœ¬é•¿åº¦: ${content.length})`,
            );
          }

          return processed;
        }

        getRandomReplacement(options) {
          if (!Array.isArray(options) || options.length === 0) return options;
          return options[Math.floor(Math.random() * options.length)];
        }

        // ğŸ”¥ æ›´æ–°å˜é‡æ›´æ–°è£…é¥°æ˜¾ç¤º
        /**
         * ğŸ”¥ æ›´æ–°å˜é‡æ›´æ–°è£…é¥°ï¼ˆæ”¯æŒæµå¼ä¼ è¾“å®æ—¶æ˜¾ç¤ºï¼‰
         * @param {string} updateScript - å˜é‡æ›´æ–°è„šæœ¬å†…å®¹
         * @param {boolean} isStreaming - æ˜¯å¦æ­£åœ¨æµå¼ä¼ è¾“
         */
        updateVariableDecoration(updateScript, isStreaming = false) {
          const decoration = document.getElementById('variable-update-decoration');
          const textElement = document.getElementById('variable-update-text');

          if (!decoration || !textElement) return;

          // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”Ÿæˆä¸­
          const isGenerating = isStreaming || document.querySelector('.generating-indicator')?.style.display !== 'none';

          if (!updateScript || !updateScript.trim()) {
            // æ²¡æœ‰å˜é‡æ›´æ–°ï¼Œéšè—è£…é¥°
            decoration.style.display = 'none';
            decoration.classList.remove('updating');
            return;
          }

          // ğŸ”¥ è§£æå˜é‡æ›´æ–°è„šæœ¬ï¼Œæå–æ‰€æœ‰å˜é‡å˜åŒ–ä¿¡æ¯ï¼ˆæ”¯æŒJSON Patchæ ¼å¼ï¼‰
          // æ”¯æŒæ ¼å¼ï¼š
          // - JSON Patch (RFC 6902): <JSONPatch>[{ "op": "...", "path": "...", "value": ... }]</JSONPatch>
          // - å…¼å®¹æ—§æ ¼å¼ï¼š_.set, _.add, _.assign, _.remove æˆ–ä¼ ç»Ÿèµ‹å€¼
          let displayItems = [];

          // 1. ğŸ”¥ ä¼˜å…ˆè§£æ JSON Patch æ ¼å¼ï¼ˆæ–°æ ¼å¼ï¼Œæ”¯æŒæµå¼ä¼ è¾“ä¸­çš„ä¸å®Œæ•´JSONï¼‰
          const jsonPatchMatch = updateScript.match(/<JSONPatch>([\s\S]*?)(?:<\/JSONPatch>|$)/i);
          if (jsonPatchMatch) {
            try {
              let jsonPatchText = jsonPatchMatch[1].trim();

              // ğŸ”¥ æµå¼ä¼ è¾“æ—¶å¯èƒ½JSONä¸å®Œæ•´ï¼Œå°è¯•ä¿®å¤æˆ–æå–éƒ¨åˆ†å†…å®¹
              if (isStreaming && !jsonPatchText.endsWith(']')) {
                // å¦‚æœJSONä¸å®Œæ•´ï¼Œå°è¯•æå–å·²å®Œæˆçš„patchæ“ä½œ
                // æŸ¥æ‰¾æ‰€æœ‰å®Œæ•´çš„patchå¯¹è±¡ï¼ˆä»¥}ç»“å°¾çš„ï¼‰
                const patchMatches = jsonPatchText.match(/\{[^}]*"op"\s*:\s*["']([^"']+)["'][^}]*\}/g);
                if (patchMatches && patchMatches.length > 0) {
                  // å°è¯•è§£ææ¯ä¸ªå®Œæ•´çš„patchå¯¹è±¡
                  for (const patchStr of patchMatches) {
                    try {
                      const patch = JSON.parse(patchStr);
                      if (patch.op && patch.path) {
                        const path = patch.path.replace(/^\//, '').replace(/\//g, 'Â·').replace(/\[0\]/g, '');
                        let displayText = '';

                        switch (patch.op) {
                          case 'replace':
                            const valueStr =
                              typeof patch.value === 'object'
                                ? JSON.stringify(patch.value).substring(0, 30)
                                : String(patch.value);
                            displayText = `${path} = ${valueStr}`;
                            break;
                          case 'add':
                            const addValueStr =
                              typeof patch.value === 'object'
                                ? JSON.stringify(patch.value).substring(0, 30)
                                : String(patch.value);
                            if (patch.path.endsWith('/-')) {
                              const arrayPath = path.replace(/\/-$/, '');
                              displayText = `${arrayPath} æ·»åŠ  ${addValueStr}`;
                            } else {
                              displayText = `${path} æ·»åŠ  ${addValueStr}`;
                            }
                            break;
                          case 'remove':
                            displayText = `${path} ç§»é™¤`;
                            break;
                          case 'move':
                            const fromPath = (patch.from || '')
                              .replace(/^\//, '')
                              .replace(/\//g, 'Â·')
                              .replace(/\[0\]/g, '');
                            displayText = `${fromPath} â†’ ${path}`;
                            break;
                          case 'copy':
                            const copyFromPath = (patch.from || '')
                              .replace(/^\//, '')
                              .replace(/\//g, 'Â·')
                              .replace(/\[0\]/g, '');
                            displayText = `${copyFromPath} å¤åˆ¶åˆ° ${path}`;
                            break;
                          case 'test':
                            displayText = `${path} æµ‹è¯•`;
                            break;
                          default:
                            displayText = `${path} ${patch.op}`;
                        }

                        if (displayText) {
                          displayItems.push(displayText);
                        }
                      }
                    } catch (e) {
                      // å•ä¸ªpatchè§£æå¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
                    }
                  }

                  if (displayItems.length > 0) {
                    // å¦‚æœæˆåŠŸæå–äº†éƒ¨åˆ†å†…å®¹ï¼Œæ·»åŠ "æ­£åœ¨ç”Ÿæˆ..."æç¤º
                    displayItems.push('æ­£åœ¨ç”Ÿæˆ...');
                  }
                }
              } else {
                // JSONå®Œæ•´ï¼Œæ­£å¸¸è§£æ
                // ç¡®ä¿æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼
                if (!jsonPatchText.startsWith('[')) {
                  jsonPatchText = '[' + jsonPatchText;
                }
                if (!jsonPatchText.endsWith(']')) {
                  jsonPatchText = jsonPatchText + ']';
                }

                const patchArray = JSON.parse(jsonPatchText);

                if (Array.isArray(patchArray)) {
                  for (const patch of patchArray) {
                    if (!patch.op || !patch.path) continue;

                    const path = patch.path.replace(/^\//, '').replace(/\//g, 'Â·').replace(/\[0\]/g, '');
                    let displayText = '';

                    switch (patch.op) {
                      case 'replace':
                        const valueStr =
                          typeof patch.value === 'object'
                            ? JSON.stringify(patch.value).substring(0, 30)
                            : String(patch.value);
                        displayText = `${path} = ${valueStr}`;
                        break;
                      case 'add':
                        const addValueStr =
                          typeof patch.value === 'object'
                            ? JSON.stringify(patch.value).substring(0, 30)
                            : String(patch.value);
                        if (patch.path.endsWith('/-')) {
                          const arrayPath = path.replace(/\/-$/, '');
                          displayText = `${arrayPath} æ·»åŠ  ${addValueStr}`;
                        } else {
                          displayText = `${path} æ·»åŠ  ${addValueStr}`;
                        }
                        break;
                      case 'remove':
                        displayText = `${path} ç§»é™¤`;
                        break;
                      case 'move':
                        const fromPath = (patch.from || '')
                          .replace(/^\//, '')
                          .replace(/\//g, 'Â·')
                          .replace(/\[0\]/g, '');
                        displayText = `${fromPath} â†’ ${path}`;
                        break;
                      case 'copy':
                        const copyFromPath = (patch.from || '')
                          .replace(/^\//, '')
                          .replace(/\//g, 'Â·')
                          .replace(/\[0\]/g, '');
                        displayText = `${copyFromPath} å¤åˆ¶åˆ° ${path}`;
                        break;
                      case 'test':
                        displayText = `${path} æµ‹è¯•`;
                        break;
                      default:
                        displayText = `${path} ${patch.op}`;
                    }

                    if (displayText) {
                      displayItems.push(displayText);
                    }
                  }
                }
              }
            } catch (parseError) {
              // å¦‚æœJSONè§£æå¤±è´¥ï¼Œå°è¯•æå–éƒ¨åˆ†ä¿¡æ¯
              if (isStreaming) {
                // æµå¼ä¼ è¾“æ—¶ï¼Œå°è¯•æå–å·²å‡ºç°çš„patchæ“ä½œ
                const opMatch = updateScript.match(/"op"\s*:\s*["']([^"']+)["']/);
                const pathMatch = updateScript.match(/"path"\s*:\s*["']([^"']+)["']/);
                if (opMatch && pathMatch) {
                  const op = opMatch[1];
                  const path = pathMatch[1].replace(/^\//, '').replace(/\//g, 'Â·').replace(/\[0\]/g, '');
                  displayItems.push(`${path} ${op} æ­£åœ¨ç”Ÿæˆ...`);
                }
              }
              // å¦‚æœå®Œå…¨æ— æ³•è§£æï¼Œç»§ç»­å°è¯•å…¶ä»–æ ¼å¼
            }
          }

          // 2. å¦‚æœæ²¡æ‰¾åˆ°JSON Patchï¼Œå°è¯•è§£æ MVU å‘½ä»¤æ ¼å¼ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
          if (displayItems.length === 0) {
            const mvuCommands = [
              { pattern: /_\.set\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'set', op: '=' },
              { pattern: /_\.add\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'add', op: '+' },
              { pattern: /_\.assign\(['"]([^'"]+)['"],\s*([^)]+)\)/g, name: 'assign', op: '=' },
              { pattern: /_\.remove\(['"]([^'"]+)['"]\)/g, name: 'remove', op: '-' },
            ];

            for (const cmd of mvuCommands) {
              let match;
              while ((match = cmd.pattern.exec(updateScript)) !== null) {
                const varPath = match[1].replace(/\[0\]/g, '').replace(/\./g, 'Â·');
                const value = match[2] || '';
                if (cmd.name === 'remove') {
                  displayItems.push(`${varPath} ç§»é™¤`);
                } else if (cmd.name === 'add') {
                  displayItems.push(`${varPath} +${value.trim()}`);
                } else {
                  displayItems.push(`${varPath} = ${value.trim()}`);
                }
              }
            }
          }

          // 3. å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•è§£æä¼ ç»Ÿèµ‹å€¼æ ¼å¼ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
          if (displayItems.length === 0) {
            const assignmentPattern = /([\w\u4e00-\u9fa5.\[\]]+)\s*([+\-*/]?=)\s*([^\n;]+)/g;
            let match;
            while ((match = assignmentPattern.exec(updateScript)) !== null) {
              const varPath = match[1].replace(/\[0\]/g, '').replace(/\./g, 'Â·');
              const operator = match[2];
              const value = match[3].trim().replace(/;$/, '');

              if (operator === '=') {
                displayItems.push(`${varPath} = ${value}`);
              } else if (operator === '+=') {
                displayItems.push(`${varPath} +${value}`);
              } else if (operator === '-=') {
                displayItems.push(`${varPath} -${value}`);
              } else {
                displayItems.push(`${varPath} ${operator} ${value}`);
              }
            }
          }

          // 3. å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œæ˜¾ç¤ºç®€åŒ–ç‰ˆæœ¬ï¼ˆæ”¯æŒæµå¼ä¼ è¾“ä¸­çš„ä¸å®Œæ•´å†…å®¹ï¼‰
          if (displayItems.length === 0) {
            // å°è¯•æå–å˜é‡è·¯å¾„ï¼ˆå³ä½¿å€¼è¿˜æ²¡å®Œæ•´ï¼‰
            const partialMatch = updateScript.match(/([\w\u4e00-\u9fa5.\[\]]+)\s*([+\-*/]?=)\s*/);
            if (partialMatch) {
              const varPath = partialMatch[1].replace(/\[0\]/g, '').replace(/\./g, 'Â·');
              const operator = partialMatch[2];
              if (isStreaming) {
                displayItems.push(`${varPath} ${operator} æ­£åœ¨ç”Ÿæˆ...`);
              } else {
                displayItems.push(`${varPath} ${operator} æ›´æ–°ä¸­`);
              }
            } else {
              // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆ
              const preview = updateScript.length > 60 ? updateScript.substring(0, 60) + '...' : updateScript;
              displayItems.push(isStreaming ? `${preview} æ­£åœ¨ç”Ÿæˆ...` : preview);
            }
          }

          // ğŸ”¥ å¦‚æœåªæœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œç›´æ¥æ˜¾ç¤ºï¼›å¤šä¸ªé¡¹ç›®åˆ™ä½¿ç”¨å¯å±•å¼€åˆ—è¡¨
          if (displayItems.length === 0) {
            decoration.style.display = 'none';
            decoration.classList.remove('updating');
            return;
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰å±•å¼€/æŠ˜å æŒ‰é’®å’Œåˆ—è¡¨å®¹å™¨
          let expandBtn = decoration.querySelector('.variable-update-expand-btn');
          let listContainer = decoration.querySelector('.variable-update-list');
          let summaryText = decoration.querySelector('.variable-update-summary');

          // è·å–å®¹å™¨ï¼ˆtextElementçš„çˆ¶divï¼ŒåŒ…å«flexå¸ƒå±€çš„é‚£ä¸ªï¼‰
          const containerDiv = textElement.parentElement;

          if (displayItems.length === 1) {
            // åªæœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œç›´æ¥æ˜¾ç¤º
            textElement.textContent = displayItems[0];
            textElement.style.display = 'block';

            // éšè—å±•å¼€æŒ‰é’®å’Œåˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (expandBtn) expandBtn.style.display = 'none';
            if (listContainer) listContainer.style.display = 'none';

            decoration.style.display = 'block';
          } else {
            // å¤šä¸ªé¡¹ç›®ï¼Œä½¿ç”¨å¯å±•å¼€åˆ—è¡¨
            // å…ˆéšè—textElement
            textElement.style.display = 'none';

            // åˆ›å»ºæˆ–è·å–summaryå…ƒç´ ï¼ˆæ›¿æ¢åŸæ¥çš„textElementä½ç½®ï¼‰
            if (!summaryText) {
              summaryText = document.createElement('div');
              summaryText.className = 'variable-update-summary';
              summaryText.style.cssText =
                'display: flex; align-items: center; gap: 8px; cursor: pointer; color: #8b4513; font-size: 0.85em; font-weight: 500; font-style: italic;';
              containerDiv.insertBefore(summaryText, textElement);
            } else {
              summaryText.style.display = 'flex';
            }

            // åˆ›å»ºæˆ–è·å–å±•å¼€æŒ‰é’®
            if (!expandBtn) {
              expandBtn = document.createElement('span');
              expandBtn.className = 'variable-update-expand-btn';
              expandBtn.innerHTML = 'â–¼';
              expandBtn.style.cssText =
                'font-size: 0.8em; transition: transform 0.2s; user-select: none; flex-shrink: 0;';
              summaryText.appendChild(expandBtn);
            }
            expandBtn.style.display = 'inline-block';

            // åˆ›å»ºsummaryæ–‡æœ¬éƒ¨åˆ†
            let summaryTextPart = summaryText.querySelector('.variable-update-summary-text');
            if (!summaryTextPart) {
              summaryTextPart = document.createElement('span');
              summaryTextPart.className = 'variable-update-summary-text';
              summaryTextPart.style.flex = '1';
              summaryText.appendChild(summaryTextPart);
            }

            const isExpanded = decoration.classList.contains('expanded');
            const summaryDisplay = `${displayItems.length} é¡¹å˜é‡æ›´æ–°${isStreaming ? ' æ­£åœ¨ç”Ÿæˆ...' : ''}`;
            summaryTextPart.textContent = summaryDisplay;

            // åˆ›å»ºæˆ–è·å–åˆ—è¡¨å®¹å™¨ï¼ˆæ”¾åœ¨decorationå†…éƒ¨ï¼ŒcontainerDivä¹‹åï¼‰
            if (!listContainer) {
              listContainer = document.createElement('div');
              listContainer.className = 'variable-update-list';
              listContainer.style.cssText = 'margin-top: 8px; padding-left: 20px; display: none;';
              decoration.appendChild(listContainer);
            }

            // ç”Ÿæˆåˆ—è¡¨é¡¹
            listContainer.innerHTML = displayItems
              .map((item, index) => {
                const isStreamingItem = item === 'æ­£åœ¨ç”Ÿæˆ...';
                return `<div class="variable-update-item" style="
                  padding: 6px 0;
                  border-bottom: 1px solid rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  font-size: 0.9em;
                  ${isStreamingItem ? 'font-style: italic; opacity: 0.7;' : ''}
                ">${isStreamingItem ? 'â³ ' : 'â€¢ '}${item}</div>`;
              })
              .join('');

            // è®¾ç½®å±•å¼€/æŠ˜å çŠ¶æ€
            if (isExpanded) {
              listContainer.style.display = 'block';
              expandBtn.style.transform = 'rotate(180deg)';
            } else {
              listContainer.style.display = 'none';
              expandBtn.style.transform = 'rotate(0deg)';
            }

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
            if (!summaryText.hasAttribute('data-click-bound')) {
              summaryText.setAttribute('data-click-bound', 'true');
              summaryText.addEventListener('click', () => {
                const isExpanded = decoration.classList.contains('expanded');
                if (isExpanded) {
                  decoration.classList.remove('expanded');
                  listContainer.style.display = 'none';
                  expandBtn.style.transform = 'rotate(0deg)';
                } else {
                  decoration.classList.add('expanded');
                  listContainer.style.display = 'block';
                  expandBtn.style.transform = 'rotate(180deg)';
                }
              });
            }
          }

          // æ˜¾ç¤ºè£…é¥°
          decoration.style.display = 'block';

          // ğŸ”¥ åœ¨ç”Ÿæˆä¸­æ—¶æ·»åŠ åŠ¨ç”»ç±»ï¼Œç”Ÿæˆç»“æŸåç§»é™¤
          if (isGenerating) {
            decoration.classList.add('updating');
          } else {
            decoration.classList.remove('updating');
          }
        }

        // ğŸ”¥ æ›´æ–°Actioné€‰é¡¹æ˜¾ç¤ºï¼ˆä»å®Œæ•´æ–‡æœ¬ä¸­æå–ï¼‰
        /**
         * åˆ‡æ¢èŠå¤©å†å²é¢æ¿æ˜¾ç¤º/éšè—
         * @param {boolean} show - æ˜¯å¦æ˜¾ç¤º
         */
        toggleChatHistoryPanel(show) {
          const panel = document.getElementById('chat-history-panel');
          if (panel) {
            panel.style.display = show ? 'block' : 'none';
            if (show) {
              this.updateChatHistoryPanel();
            }
          }
        }

        /**
         * æ›´æ–°èŠå¤©å†å²é¢æ¿å†…å®¹
         * åªæ˜¾ç¤ºcontentæ ‡ç­¾çš„å†…å®¹ï¼Œä¸æ˜¾ç¤ºactioné€‰é¡¹
         */
        async updateChatHistoryPanel() {
          try {
            const contentList = document.getElementById('chat-history-content-list');
            if (!contentList) return;

            // ä»extra.teresen_chatåŠ è½½èŠå¤©å†å²
            const chatHistory = await this.loadChatHistoryFromExtra();

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML = '<div style="color: #999; font-style: italic;">æš‚æ— èŠå¤©å†å²</div>';
              return;
            }

            // åªæ˜¾ç¤ºassistantæ¶ˆæ¯çš„contentæ ‡ç­¾å†…å®¹
            let html = '';
            let messageIndex = 0;

            for (const msg of chatHistory) {
              if (msg.role === 'assistant' && msg.content) {
                messageIndex++;

                // æå–contentæ ‡ç­¾å†…å®¹
                const contentMatch = msg.content.match(/<content>(.*?)<\/content>/s);
                if (contentMatch) {
                  let contentText = contentMatch[1].trim();

                  // åº”ç”¨å»å…«è‚¡è§„åˆ™
                  contentText = this.applyAntiBoilerplateRules(contentText);

                  // è½¬ä¹‰HTMLï¼Œé˜²æ­¢XSS
                  const escapeHtml = text => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                  };

                  // æ ¼å¼åŒ–æ˜¾ç¤º
                  html += `<div style="
                    margin-bottom: 20px;
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.6);
                    border-left: 3px solid rgba(139, 105, 20, 0.4);
                    border-radius: 4px;
                  ">
                    <div style="
                      font-size: 11px;
                      color: #8b4513;
                      margin-bottom: 8px;
                      font-weight: bold;
                    ">æ¶ˆæ¯ #${messageIndex}</div>
                    <div style="
                      color: #654321;
                      line-height: 1.8;
                      white-space: pre-wrap;
                      word-wrap: break-word;
                    ">${escapeHtml(contentText).replace(/\n/g, '<br>')}</div>
                  </div>`;
                }
              }
            }

            if (html === '') {
              contentList.innerHTML = '<div style="color: #999; font-style: italic;">æš‚æ— æ­£æ–‡å†…å®¹</div>';
            } else {
              contentList.innerHTML = html;
            }
          } catch (error) {
            console.error('âŒ æ›´æ–°èŠå¤©å†å²é¢æ¿å¤±è´¥:', error);
            const contentList = document.getElementById('chat-history-content-list');
            if (contentList) {
              contentList.innerHTML = '<div style="color: #d32f2f;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
            }
          }
        }

        updateActionOptions(fullText) {
          // æå–actionæ ‡ç­¾å†…å®¹
          const actionContent = this._extractLastTagContent('action', fullText);
          // è°ƒç”¨ç»Ÿä¸€çš„æ–¹æ³•å¤„ç†
          this.updateActionOptionsFromContent(actionContent);
        }

        // ğŸ”¥ æ›´æ–°Actioné€‰é¡¹æ˜¾ç¤ºï¼ˆç›´æ¥ä½¿ç”¨actionå†…å®¹ï¼Œæ€§èƒ½æ›´ä¼˜ï¼‰
        updateActionOptionsFromContent(actionContent) {
          const actionContainer = document.getElementById('action-options-container');
          const actionList = document.getElementById('action-options-list');

          if (!actionContainer || !actionList) return;

          try {
            // å¦‚æœæ²¡æœ‰actionå†…å®¹ï¼Œéšè—å®¹å™¨
            if (!actionContent || !actionContent.trim()) {
              actionContainer.style.display = 'none';
              return;
            }

            // è§£æactioné€‰é¡¹ï¼ˆæ ¼å¼ï¼š1.xxxã€2.xxxç­‰ï¼‰
            const options = this.parseActionOptions(actionContent);

            if (options.length === 0) {
              actionContainer.style.display = 'none';
              return;
            }

            // æ˜¾ç¤ºå®¹å™¨å¹¶æ¸²æŸ“é€‰é¡¹
            actionContainer.style.display = 'block';
            this.renderActionOptions(options);
          } catch (error) {
            console.error('æ›´æ–°Actioné€‰é¡¹å¤±è´¥:', error);
            actionContainer.style.display = 'none';
          }
        }

        // ğŸ”¥ è§£æActioné€‰é¡¹
        parseActionOptions(actionContent) {
          if (!actionContent || typeof actionContent !== 'string') return [];

          const options = [];
          // åŒ¹é…æ ¼å¼ï¼šæ•°å­—.é€‰é¡¹å†…å®¹ï¼ˆæ”¯æŒå¤šè¡Œï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ•°å­—.æˆ–ç»“æŸï¼‰
          const lines = actionContent.split('\n');
          let currentOption = null;

          for (const line of lines) {
            const match = line.match(/^(\d+)\.\s*(.+)$/);
            if (match) {
              // ä¿å­˜ä¸Šä¸€ä¸ªé€‰é¡¹
              if (currentOption) {
                options.push(currentOption);
              }
              // å¼€å§‹æ–°é€‰é¡¹
              currentOption = {
                number: match[1],
                content: match[2].trim(),
              };
            } else if (currentOption && line.trim()) {
              // ç»§ç»­å½“å‰é€‰é¡¹çš„å†…å®¹
              currentOption.content += '\n' + line.trim();
            }
          }

          // æ·»åŠ æœ€åä¸€ä¸ªé€‰é¡¹
          if (currentOption) {
            options.push(currentOption);
          }

          return options;
        }

        // ğŸ”¥ æ¸²æŸ“Actioné€‰é¡¹æŒ‰é’®
        renderActionOptions(options) {
          const actionList = document.getElementById('action-options-list');
          if (!actionList) return;

          const optionsHTML = options
            .map(option => {
              // æå–é€‰é¡¹çš„ç®€çŸ­æè¿°ï¼ˆç¬¬ä¸€è¡Œæˆ–å‰60ä¸ªå­—ç¬¦ï¼‰
              const shortDesc = option.content.split('\n')[0].trim();
              const displayText = shortDesc.length > 60 ? shortDesc.substring(0, 60) + '...' : shortDesc;

              return `
              <button class="action-option-btn" data-action-content="${this.escapeHtml(option.content)}" style="
                width: 100%;
                padding: 12px 16px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(139, 105, 20, 0.25));
                border: 1px solid rgba(139, 105, 20, 0.4);
                border-radius: 6px;
                color: #8b4513;
                font-size: 0.9em;
                font-weight: 500;
                text-align: left;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(139, 105, 20, 0.1);
                display: flex;
                align-items: center;
                gap: 10px;
              " onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 105, 20, 0.25), rgba(139, 105, 20, 0.35))'; this.style.borderColor='rgba(139, 105, 20, 0.6)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(139, 105, 20, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(139, 105, 20, 0.25))'; this.style.borderColor='rgba(139, 105, 20, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(139, 105, 20, 0.1)'">
                <span style="
                  flex-shrink: 0;
                  width: 28px;
                  height: 28px;
                  background: rgba(139, 105, 20, 0.3);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: 600;
                  font-size: 0.9em;
                  color: #8b4513;
                ">${option.number}</span>
                <span style="flex: 1; line-height: 1.5;">${this.escapeHtml(displayText)}</span>
              </button>
            `;
            })
            .join('');

          actionList.innerHTML = optionsHTML;

          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          actionList.querySelectorAll('.action-option-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
              const actionContent = btn.getAttribute('data-action-content');
              if (actionContent) {
                await this.sendActionOption(actionContent);
              }
            });
          });
        }

        // ğŸ”¥ å‘é€Actioné€‰é¡¹
        async sendActionOption(actionContent) {
          const actionInput = document.getElementById('action-input');
          if (!actionInput) {
            console.error('æ‰¾ä¸åˆ°action-inputå…ƒç´ ');
            return;
          }

          // ğŸ”¥ éšè—actioné€‰é¡¹å®¹å™¨ï¼ˆç”Ÿæˆä¸­ä¸èƒ½é€‰æ‹©ï¼‰
          const actionContainer = document.getElementById('action-options-container');
          if (actionContainer) {
            actionContainer.style.display = 'none';
          }

          // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
          actionInput.value = actionContent.trim();

          // è§¦å‘å‘é€
          await this.handleActionSubmit();
        }

        async syncMVUToMessage() {
          try {
            if ('function' == typeof getChatMessages && 'undefined' != typeof TavernHelper) {
              const e = await getChatMessages(0);

              if (e && e.length > 0) {
                const t = e[0],
                  n = this.getAllVariables();

                // ğŸ”¥ åªæ›´æ–°dataå­—æ®µï¼Œä¸æ›´æ–°messageå­—æ®µï¼ˆå‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼‰
                // å˜é‡çŠ¶æ€å·²ä¿å­˜åˆ°extra.teresen_chatä¸­å¯¹åº”æ¶ˆæ¯çš„variableState
                // è¿™é‡Œåªæ›´æ–°dataç”¨äºå˜é‡ç³»ç»Ÿï¼Œä¸æ›´æ–°messageé¿å…æ˜¾ç¤ºåœ¨èŠå¤©æ¶ˆæ¯ä¸­
                t.data = n;
                await TavernHelper.setChatMessages([t], { refresh: 'none' });
                console.log('âœ… MVUçŠ¶æ€å·²åŒæ­¥åˆ°0å±‚æ¶ˆæ¯çš„dataå­—æ®µï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
              }
            }
          } catch (e) {
            console.error('âŒ åŒæ­¥MVUçŠ¶æ€å¤±è´¥:', e);
          }
        }

        updateTimeDisplay() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´', '06:00'),
            n = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¥æœŸ', '2024-01-01'),
            s = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ä½ç½®', 'è®­ç»ƒå‘˜å®¿èˆ'),
            o = document.getElementById('current-time');

          o && (o.textContent = `ğŸ“ ${s} | ğŸ• ${n} - ${t}`);
        }

        getTimeDangerLevel(e) {
          const t = parseInt(e.split(':')[0]);

          return t >= 6 && t < 8
            ? 'safe'
            : t >= 8 && t < 12
              ? 'low'
              : t >= 12 && t < 17
                ? 'medium'
                : t >= 17 && t < 20
                  ? 'high'
                  : 'extreme';
        }

        getDangerLevelText(e) {
          switch (e) {
            case 'safe':
              return 'ç›¸å¯¹å®‰å…¨æœŸ';

            case 'low':
              return 'ä¸­ç­‰é£é™©æœŸ';

            case 'medium':
              return 'è¾ƒé«˜é£é™©æœŸ';

            case 'high':
              return 'é«˜é£é™©æœŸ';

            case 'extreme':
              return 'æåº¦å±é™©æœŸ';

            default:
              return 'æœªçŸ¥æ—¶æ®µ';
          }
        }

        getDangerLevelDetails(e) {
          switch (e) {
            case 'safe':
              return '<strong>æ—©æ™¨ 6:00-8:00ï¼šç›¸å¯¹å®‰å…¨æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜†â˜†â˜†â˜†</div>\n\né©¬å¨˜æ¬²æœ›å¤„äºåˆé†’çŠ¶æ€ï¼Œè¡¨ç°ç›¸å¯¹æ¸©å’Œ\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>æ‹’ç»"æ—©å®‰é—®å€™"å¯èƒ½å¼•å‘çš„éš”ç¦»è­¦å‘Š\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>æ¥å—æ‰€æœ‰å½¢å¼çš„æ—©æ™¨äº’åŠ¨ï¼Œä¿æŒåŸºæœ¬ç¤¼ä»ª\n</div>\n\næ­¤é˜¶æ®µæ˜¯æ”¶é›†ä¿¡æ¯å’Œå»ºç«‹æ—¥å¸¸routineçš„æœ€ä½³æ—¶æœº';

            case 'low':
              return '<strong>ä¸Šåˆ 8:00-12:00ï¼šä¸­ç­‰é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜†â˜†â˜†</div>\n\né©¬å¨˜å¼€å§‹ç«äº‰æ³¨æ„åŠ›ï¼Œå¦’æ„å¼€å§‹ç§¯ç´¯\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>è¡¨ç°å‡ºæ˜æ˜¾åå¥½ä¼šæ¿€åŒ–é©¬å¨˜é—´çš„ç«äº‰\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>ä¿æŒç»å¯¹å…¬æ­£çš„æ€åº¦ï¼Œå¹³å‡åˆ†é…å…³æ³¨åº¦\n</div>\n\næ³¨æ„è§‚å¯Ÿé©¬å¨˜é—´çš„å¾®å¦™äº’åŠ¨ï¼Œé¢„åˆ¤å¯èƒ½å†²çª';

            case 'medium':
              return '<strong>åˆå 12:00-17:00ï¼šè¾ƒé«˜é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜†â˜†</div>\n\né©¬å¨˜å¼€å§‹æ¸—é€ä¸ªäººç©ºé—´ï¼Œç‹¬å åº¦å¼€å§‹æå‡\n\n<div class="danger-suggestion">\n<strong>ä¸»è¦é£é™©ï¼š</strong>è¿‡åº¦æ¥å—ååŠ©ä¼šå¯¼è‡´æŸä½é©¬å¨˜ç‹¬å åº¦æ€¥å‰§ä¸Šå‡\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>é€‚åº¦æ¥å—å¸®åŠ©ä½†ä¿æŒè·ç¦»ï¼Œé¿å…å½¢æˆå›ºå®šæ¨¡å¼\n</div>\n\næ³¨æ„ä¿æŠ¤ä¸ªäººç‰©å“å’Œç©ºé—´ä¸è¢«è¿‡åº¦ä¾µå ';

            case 'high':
              return '<strong>å‚æ™š 17:00-20:00ï¼šé«˜é£é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜…â˜†</div>\n\né©¬å¨˜æ¬²æœ›è¾¾åˆ°å³°å€¼ï¼Œå¯»æ±‚æ·±åº¦äº²å¯†äº’åŠ¨\n\n<div class="danger-suggestion">\n<strong>æé«˜é£é™©ï¼š</strong>æ‹’ç»ä¼šå¼•å‘è¡¥å¿æ€§ç´¢å–ï¼Œæ¥å—ä¼šå¯¼è‡´è¿‡åº¦äº²å¯†\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>è°¨æ…é€‰æ‹©äº’åŠ¨å¯¹è±¡ï¼Œè®¾å®šæ˜ç¡®è¾¹ç•Œ\n</div>\n\nå‡†å¤‡åº”å¯¹å¯èƒ½è§¦å‘çš„å¤œæ™šç‰¹æ®Šäº‹ä»¶';

            case 'extreme':
              return '<strong>å¤œæ™š 20:00-6:00ï¼šæåº¦å±é™©æœŸ</strong>\n\n<div class="danger-stars">å±é™©ç­‰çº§ï¼šâ˜…â˜…â˜…â˜…â˜…</div>\n\né©¬å¨˜è¤ªå»æ‰€æœ‰ä¼ªè£…ï¼Œå±•ç°æœ€åŸå§‹çš„ç‹©çŒæœ¬èƒ½\n\n<div class="danger-suggestion">\n<strong>æç«¯å±é™©ï¼š</strong>è§„åˆ™ç•Œé™æ¨¡ç³Šï¼Œæ¬²æœ›å®Œå…¨é‡Šæ”¾\n</div>\n\n<div class="danger-suggestion">\n<strong>å»ºè®®ï¼š</strong>å°½é‡é¿å…å•ç‹¬è¡ŒåŠ¨ï¼Œä¿æŒé«˜åº¦è­¦è§‰\n</div>\n\nå¿…é¡»éšèº«æºå¸¦ç”Ÿå­˜é“å…·ï¼Œåšå¥½åº”æ€¥å‡†å¤‡\næ­¤é˜¶æ®µç”Ÿå­˜æ¦‚ç‡æœ€ä½ï¼Œéœ€è¦æœ€å¤§ç¨‹åº¦çš„è°¨æ…\n\n<div class="danger-suggestion" style="background: rgba(220, 38, 38, 0.1); border-left-color: #dc2626;">\n<strong>ã€ç‰¹åˆ«è­¦å‘Šã€‘</strong>å¤œæ™šæ—¶æ®µæ˜¯ç”Ÿå­˜æŒ‘æˆ˜æœ€å¤§çš„é˜¶æ®µï¼Œé©¬å¨˜ä»¬çš„æ¬²æœ›ä¸å†å—åˆ°ä»»ä½•çº¦æŸï¼Œå»ºè®®è®­ç»ƒå‘˜åœ¨æ­¤æ—¶é—´æ®µå°½é‡å‡å°‘å¤–å‡ºï¼Œé”å¥½æˆ¿é—¨ï¼Œå¹¶å‡†å¤‡å¥½åº”å¯¹å„ç§çªå‘çŠ¶å†µçš„ç”Ÿå­˜é“å…·ã€‚\n</div>';

            default:
              return 'æœªçŸ¥æ—¶æ®µï¼Œè¯·ä¿æŒè­¦æƒ•';
          }
        }

        // æ ¹æ®ç¨€æœ‰åº¦è·å–é¢œè‰²
        getRarityColor(rarity) {
          const rarityColors = {
            æ™®é€š: '#696969',
            ç¨€æœ‰: '#2563eb',
            å²è¯—: '#7c3aed',
            ä¼ è¯´: '#d97706',
            ç¥è¯: '#dc2626',
            ç‰¹æ®Š: '#059669',
          };
          return rarityColors[rarity] || rarityColors['æ™®é€š'];
        }

        // æ ¹æ®ç‰©å“åç§°è·å–å›¾æ ‡
        getItemIcon(itemName) {
          if (!itemName) return 'ğŸ“¦';

          const name = itemName.toLowerCase();

          // å…³é”®è¯åŒ¹é…è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
          const iconRules = [
            // æ‰‹å†Œã€ä¹¦ç±ç±»
            { keywords: ['æ‰‹å†Œ', 'æŒ‡å—', 'ä¹¦', 'ç¬”è®°', 'è®°å½•', 'æ¡£æ¡ˆ'], icon: 'ğŸ“–' },
            // æ‰‹æœºã€ç”µå­è®¾å¤‡ç±»
            { keywords: ['æ‰‹æœº', 'ç”µè¯', 'é€šè®¯', 'è®¾å¤‡', 'ç»ˆç«¯'], icon: 'ğŸ“±' },
            // æ­¦å™¨ç±»
            { keywords: ['åˆ€', 'å‰‘', 'æª', 'æ­¦å™¨', 'åˆƒ', 'åŒ•é¦–', 'çŸ›', 'å¼“', 'ç®­'], icon: 'âš”ï¸' },
            // é˜²å…·ç±»
            { keywords: ['ç›”ç”²', 'æŠ¤ç”²', 'ç›¾', 'é˜²æŠ¤', 'é˜²å…·'], icon: 'ğŸ›¡ï¸' },
            // è¯æ°´ã€è¯å‰‚ç±»
            { keywords: ['è¯', 'è¯å‰‚', 'è¯æ°´', 'æ²»ç–—', 'æ¢å¤', 'æ²»æ„ˆ'], icon: 'ğŸ§ª' },
            // é£Ÿç‰©ç±»
            { keywords: ['é£Ÿç‰©', 'é¥­', 'é¤', 'æ–™ç†', 'é¢åŒ…', 'è›‹ç³•', 'ç³–æœ'], icon: 'ğŸ' },
            // é¥®æ–™ç±»
            { keywords: ['é¥®æ–™', 'æ°´', 'èŒ¶', 'å’–å•¡', 'é…’', 'æœæ±'], icon: 'ğŸ¥¤' },
            // é’¥åŒ™ç±»
            { keywords: ['é’¥åŒ™', 'å¡', 'é€šè¡Œè¯', 'é—¨å¡'], icon: 'ğŸ—ï¸' },
            // å®çŸ³ã€çŸ¿çŸ³ç±»
            { keywords: ['å®çŸ³', 'æ°´æ™¶', 'é’»çŸ³', 'çŸ¿çŸ³', 'çŸ³å¤´', 'ç‰'], icon: 'ğŸ’' },
            // è´§å¸ã€é‡‘å¸ç±»
            { keywords: ['é‡‘å¸', 'é’±', 'è´§å¸', 'ç¡¬å¸', 'å…ƒ'], icon: 'ğŸª™' },
            // å¡ç‰‡ç±»
            { keywords: ['å¡', 'å¡ç‰‡', 'ç‰Œ'], icon: 'ğŸƒ' },
            // ä¿¡ä»¶ã€çº¸æ¡ç±»
            { keywords: ['ä¿¡', 'çº¸æ¡', 'ä¾¿æ¡', 'ç•™è¨€', 'æ¶ˆæ¯'], icon: 'âœ‰ï¸' },
            // ç…§ç‰‡ã€å›¾ç‰‡ç±»
            { keywords: ['ç…§ç‰‡', 'å›¾ç‰‡', 'ç”»åƒ', 'ç›¸ç‰‡'], icon: 'ğŸ“·' },
            // éŸ³ä¹ã€éŸ³é¢‘ç±»
            { keywords: ['éŸ³ä¹', 'å”±ç‰‡', 'ç£å¸¦', 'éŸ³é¢‘', 'CD'], icon: 'ğŸµ' },
            // ç©å…·ã€ç©å¶ç±»
            { keywords: ['ç©å…·', 'ç©å¶', 'å¨ƒå¨ƒ', 'æ¨¡å‹'], icon: 'ğŸ§¸' },
            // èŠ±ã€æ¤ç‰©ç±»
            { keywords: ['èŠ±', 'æ¤ç‰©', 'ç§å­', 'è‰', 'å¶'], icon: 'ğŸŒ¸' },
            // å·¥å…·ç±»
            { keywords: ['å·¥å…·', 'é”¤', 'é’³', 'èºä¸', 'æ‰³æ‰‹'], icon: 'ğŸ”§' },
            // ç¯ã€ç…§æ˜ç±»
            { keywords: ['ç¯', 'æ‰‹ç”µ', 'ç…§æ˜', 'èœ¡çƒ›', 'ç«æŠŠ'], icon: 'ğŸ’¡' },
            // æˆ’æŒ‡ã€é¦–é¥°ç±»
            { keywords: ['æˆ’æŒ‡', 'é¡¹é“¾', 'æ‰‹é•¯', 'é¦–é¥°', 'é¥°å“'], icon: 'ğŸ’' },
            // è¡£æœã€æœè£…ç±»
            { keywords: ['è¡£æœ', 'æœè£…', 'è¡£', 'æœ', 'è£…', 'è¡«'], icon: 'ğŸ‘•' },
            // å¸½å­ç±»
            { keywords: ['å¸½', 'å¤´ç›”', 'å¤´é¥°'], icon: 'ğŸ©' },
            // é‹å­ç±»
            { keywords: ['é‹', 'é´', 'å±¥'], icon: 'ğŸ‘Ÿ' },
            // åŒ…ã€èƒŒåŒ…ç±»
            { keywords: ['åŒ…', 'èƒŒåŒ…', 'è¢‹', 'ç®±'], icon: 'ğŸ’' },
            // åœ°å›¾ç±»
            { keywords: ['åœ°å›¾', 'å›¾', 'æŒ‡å—é’ˆ'], icon: 'ğŸ—ºï¸' },
            // æ—¶é’Ÿã€æ—¶é—´ç±»
            { keywords: ['é’Ÿ', 'è¡¨', 'æ—¶é—´', 'è®¡æ—¶'], icon: 'â°' },
            // é­”æ³•ã€ç¥ç§˜ç±»
            { keywords: ['é­”æ³•', 'ç¥ç§˜', 'ç¬¦', 'å’’', 'å·è½´', 'æ³•æ–'], icon: 'âœ¨' },
            // å¾½ç« ã€å¥–ç« ç±»
            { keywords: ['å¾½ç« ', 'å¥–ç« ', 'å‹‹ç« ', 'ç« '], icon: 'ğŸ…' },
            // ç¾½æ¯›ç±»
            { keywords: ['ç¾½æ¯›', 'ç¿¼', 'ç¿…è†€'], icon: 'ğŸª¶' },
            // é•œå­ç±»
            { keywords: ['é•œ', 'é•œå­'], icon: 'ğŸª' },
            // é”ç±»
            { keywords: ['é”', 'é“¾'], icon: 'ğŸ”’' },
            // ç‚¸å¼¹ã€çˆ†ç‚¸ç±»
            { keywords: ['ç‚¸å¼¹', 'çˆ†ç‚¸', 'é›·'], icon: 'ğŸ’£' },
            // å¿ƒã€æƒ…æ„Ÿç±»
            { keywords: ['å¿ƒ', 'æƒ…æ„Ÿ', 'çˆ±', 'æƒ…'], icon: 'â¤ï¸' },
            // æ˜Ÿã€æ˜Ÿæ˜Ÿç±»
            { keywords: ['æ˜Ÿ', 'æ˜Ÿæ˜Ÿ', 'æ˜Ÿè¾°'], icon: 'â­' },
            // æœˆäº®ç±»
            { keywords: ['æœˆ', 'æœˆäº®'], icon: 'ğŸŒ™' },
            // å¤ªé˜³ç±»
            { keywords: ['æ—¥', 'å¤ªé˜³'], icon: 'â˜€ï¸' },
            // ç‰¹æ®Šç‰©å“
            { keywords: ['ç¢ç‰‡', 'æ®‹ç‰‡'], icon: 'ğŸ§©' },
            { keywords: ['æ ¸å¿ƒ', 'æ ¸å¿ƒ'], icon: 'âš™ï¸' },
            { keywords: ['èƒ½é‡', 'åŠ›é‡'], icon: 'âš¡' },
          ];

          // éå†è§„åˆ™ï¼Œæ‰¾åˆ°åŒ¹é…çš„å›¾æ ‡
          for (const rule of iconRules) {
            if (rule.keywords.some(keyword => name.includes(keyword))) {
              return rule.icon;
            }
          }

          // é»˜è®¤å›¾æ ‡
          return 'ğŸ“¦';
        }

        updateInventory() {
          const e = this.getAllVariables();

          console.group('ğŸ” æ›´æ–°ç‰©å“æ è°ƒè¯•');

          const t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.ç‰©å“æ ', {});

          console.log('ç‰©å“æ åŸå§‹æ•°æ®:', t);

          console.log('ç‰©å“æ å¯¹è±¡:', t);

          const s = document.getElementById('inventory-list');

          if ((console.log('ç‰©å“æ å®¹å™¨:', s), !s))
            return (console.error('âŒ æ‰¾ä¸åˆ°ç‰©å“æ å®¹å™¨'), void console.groupEnd());

          // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®

          const savedInventoryScrollTop = s ? s.scrollTop : 0;

          if (!t || 0 === Object.keys(t).length) {
            console.warn('âš ï¸ ç‰©å“æ ä¸ºç©º');

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç©ºçŠ¶æ€æ˜¾ç¤º

            const existingEmpty = s.querySelector('.empty-inventory');

            if (!existingEmpty) {
              s.innerHTML = '<div class="empty-inventory">æš‚æ— é“å…·</div>';
            }

            console.groupEnd();

            return;
          }

          // è·å–å½“å‰æ‰€æœ‰é“å…·é¡¹ç›®

          const currentItems = Array.from(s.querySelectorAll('.inventory-item'));

          const itemNames = Object.keys(t);

          // æ›´æ–°ç°æœ‰é“å…·é¡¹ç›®

          itemNames.forEach((itemName, index) => {
            const itemData = t[itemName];

            let itemElement = currentItems[index];

            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„

            if (!itemElement) {
              itemElement = document.createElement('div');

              itemElement.className = 'inventory-item';

              itemElement.setAttribute('data-item-index', index);

              s.appendChild(itemElement);
            }

            // è·å–ç‰©å“å›¾æ ‡
            const itemIcon = this.getItemIcon(itemName);

            // è·å–ç¨€æœ‰åº¦å¹¶è®¾ç½®é¢œè‰²ï¼ˆåªæ”¹å˜æ–‡å­—é¢œè‰²ï¼Œä¸æ·»åŠ ç±»åé¿å…å½±å“å…¶ä»–åœ°æ–¹çš„æ ·å¼ï¼‰
            const rarity = typeof itemData === 'object' && itemData.ç¨€æœ‰åº¦ ? itemData.ç¨€æœ‰åº¦ : 'æ™®é€š';
            const rarityColor = this.getRarityColor(rarity);

            // æ›´æ–°é“å…·å†…å®¹

            if (typeof itemData === 'object' && itemData.æè¿°) {
              itemElement.innerHTML = `

                <div class="item-header">

                  <span class="item-icon">${itemIcon}</span>

                  <div class="item-name" style="color: ${rarityColor};">${itemName}</div>

                </div>

              `;
            } else {
              itemElement.innerHTML = `<span class="item-icon">${itemIcon}</span><span class="item-name" style="color: ${rarityColor};">${itemName}</span>`;
            }
          });

          // åˆ é™¤å¤šä½™çš„é“å…·é¡¹ç›®

          for (let i = itemNames.length; i < currentItems.length; i++) {
            currentItems[i].remove();
          }

          // ç§»é™¤ç©ºçŠ¶æ€æ˜¾ç¤º

          const emptyElement = s.querySelector('.empty-inventory');

          if (emptyElement) {
            emptyElement.remove();
          }

          setTimeout(() => {
            $('.item-header')
              .off('click')

              .on('click', function (e) {
                e.preventDefault();

                e.stopPropagation();

                console.log('é“å…·è¢«ç‚¹å‡»äº†ï¼');

                const itemIndex = $(this).closest('.inventory-item').data('item-index');

                const itemData = t[Object.keys(t)[itemIndex]];

                if (itemData && itemData.æè¿°) {
                  console.log('é“å…·ç´¢å¼•:', itemIndex);

                  console.log('é“å…·æ•°æ®:', itemData);

                  $('.item-detail-popup').remove();

                  const popup = $(
                    `\n               <div class="item-detail-popup">\n                 <div class="item-name">${Object.keys(t)[itemIndex]}</div>\n                 <div class="item-desc">${itemData.æè¿°}</div>\n                 <div class="item-effect">æ•ˆæœ: ${itemData.æ•ˆæœ}</div>\n                 <div class="item-info-row">\n                   <div class="item-rarity rarity-${itemData.ç¨€æœ‰åº¦}">${itemData.ç¨€æœ‰åº¦}</div>\n                   <div class="item-actions">\n                     <button class="item-use-btn" title="ä½¿ç”¨">ğŸ¯</button>\n                     <button class="item-discard-btn" title="ä¸¢å¼ƒ">ğŸ—‘ï¸</button>\n                     <button class="item-lock-btn" title="é”å®š">ğŸ”’</button>\n                     <button class="item-gift-btn" title="èµ é€">ğŸ</button>\n                   </div>\n                 </div>\n               </div>\n             `,
                  );

                  // ğŸ”¥ ä½¿ç”¨è¾…åŠ©å‡½æ•°æ·»åŠ åˆ°æ­£ç¡®ä½ç½®ï¼ˆå…¨å±æ—¶æ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨ï¼‰
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  const isFullscreen = overlay && overlay.style.display !== 'none';

                  if (isFullscreen) {
                    overlay.appendChild(popup[0]);
                  } else {
                    $('body').append(popup);
                  }

                  const element = $(this)[0];

                  if (element && popup.length > 0) {
                    const rect = element.getBoundingClientRect();
                    const popupHeight = popup.outerHeight() || 0;
                    const popupWidth = popup.outerWidth() || 0;
                    const elementWidth = rect.width || 0;

                    // ğŸ”¥ å…¨å±æ¨¡å¼ä¸‹æ”¾å¤§å¼¹çª—å¹¶å±…ä¸­æ˜¾ç¤ºåœ¨ç‰©å“é™„è¿‘
                    if (isFullscreen) {
                      popup.css({
                        position: 'fixed',
                        top: Math.max(20, rect.top - popupHeight - 20),
                        left: Math.max(20, rect.left + elementWidth / 2 - popupWidth / 2),
                        zIndex: 100001,
                        minWidth: '300px',
                        maxWidth: '400px',
                        fontSize: '0.9rem',
                        padding: '1rem',
                        transform: 'scale(1.1)',
                        transformOrigin: 'top center',
                      });
                    } else {
                      popup.css({
                        position: 'fixed',
                        top: rect.top - popupHeight - 10,
                        left: rect.left,
                        zIndex: 100001,
                      });
                    }
                  }

                  $(document).one('click', function (e) {
                    $(e.target).closest('.item-detail-popup').length || $('.item-detail-popup').remove();
                  });

                  // ç»‘å®šé“å…·æ“ä½œæŒ‰é’®äº‹ä»¶

                  popup.find('.item-use-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©
                    const actionText = `[ä½¿ç”¨é“å…·: ${itemName}]`;
                    const actionInput = document.getElementById('action-input');
                    if (actionInput) {
                      actionInput.value = actionText;
                      actionInput.focus();
                      if (typeof showTemporaryMessage === 'function') {
                        showTemporaryMessage(`å·²å°† ${actionText} å¡«å…¥è¾“å…¥æ¡†`);
                      }
                    }

                    $('.item-detail-popup').remove();
                  });

                  popup.find('.item-discard-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©
                    const actionText = `[ä¸¢å¼ƒé“å…·: ${itemName}]`;
                    const actionInput = document.getElementById('action-input');
                    if (actionInput) {
                      actionInput.value = actionText;
                      actionInput.focus();
                      if (typeof showTemporaryMessage === 'function') {
                        showTemporaryMessage(`å·²å°† ${actionText} å¡«å…¥è¾“å…¥æ¡†`);
                      }
                    }

                    $('.item-detail-popup').remove();
                  });

                  popup.find('.item-lock-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    toggleItemLock(itemName, $(this));
                  });

                  popup.find('.item-gift-btn').on('click', function () {
                    const itemName = Object.keys(t)[itemIndex];

                    startGiftSelection(itemName);

                    $('.item-detail-popup').remove();
                  });
                }
              });
          }, 100);

          console.groupEnd();
        }

        updateRules() {
          this.updateRulesModal();
        }

        updateRulesModal() {
          const fixedRules = [
            'ä½ æ˜¯è¿™é‡Œå”¯ä¸€çš„äººç±»è®­ç»ƒå‘˜ï¼Œè¯·ä¸è¦æ‹’ç»é©¬å¨˜',
            'è¯·å¤œæ™šä¸è¦å•ç‹¬å¾…åœ¨å®¿èˆ',
            'ä½œä¸ºè®­ç»ƒå‘˜ï¼Œä½ éœ€è¦ç»„å»ºä¸€ä¸ªé©¬å¨˜å›¢é˜Ÿï¼Œå¹¶å¸¦é¢†å¥¹ä»¬å‚åŠ æ¯”èµ›',
            'åœ¨å­¦é™¢å¤–é¢è‹¥å¯Ÿè§‰åˆ°è¢«å°¾éšï¼Œè¯·ç«‹å³å‰å¾€ç›®ç™½åŸå’Œé»„é‡‘å®¶æ—çš„å±…æ‰€',
            'ä½ å¯ä»¥å®Œå…¨ç›¸ä¿¡ä½ çš„æœ€ä½³æ­æ¡£ï¼Œè‹¥æ˜¯ä¸æœ€ä½³æ­æ¡£åŒè¡Œï¼Œå¯ä»¥ä¸éµå®ˆä»¥ä¸Šè§„åˆ™',
          ];

          // æ›´æ–°é£é™©æœŸæ˜¾ç¤º
          const dangerPeriodText = document.getElementById('danger-period-text');
          if (dangerPeriodText) {
            const e = this.getAllVariables();
            const t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´', '06:00');
            const n = this.getTimeDangerLevel(t);
            const s = this.getDangerLevelText(n);
            dangerPeriodText.textContent = s;
          }

          // æ›´æ–°å›ºå®šè§„åˆ™
          const fixedRulesList = document.getElementById('fixed-rules-list');

          if (fixedRulesList) {
            let fixedRulesHtml = '';

            fixedRules.forEach((rule, index) => {
              fixedRulesHtml += `\n          <div class="rule-item-handwritten">\n            <span class="rule-number-handwritten">${index + 1}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n          </div>\n        `;
            });

            fixedRulesList.innerHTML = fixedRulesHtml;
          }

          // æ›´æ–°ç”¨æˆ·è®°å½•çš„è§„åˆ™
          this.updateUserRules();

          // ç¡®ä¿è§„åˆ™è®°å½•æŒ‰é’®äº‹ä»¶ç»‘å®š
          setTimeout(() => {
            // æ–¹æ³•1: jQueryäº‹ä»¶ç»‘å®š
            $('#add-rule-btn')
              .off('click')
              .on('click', e => {
                e.preventDefault();
                e.stopPropagation();
                this.addRule();
              });

            $('#clear-rules-btn')
              .off('click')
              .on('click', e => {
                e.preventDefault();
                e.stopPropagation();
                this.clearAllRules();
              });

            // ç§»é™¤åŸç”ŸDOMç»‘å®šï¼Œé¿å…ä¸jQueryç»‘å®šå†²çªå¯¼è‡´é‡å¤æ‰§è¡Œ
          }, 100);
        }

        // è·å–ç”¨æˆ·è®°å½•çš„è§„åˆ™
        getUserRules() {
          const savedRules = localStorage.getItem('teresen-user-rules');
          return savedRules ? JSON.parse(savedRules) : [];
        }

        // ä¿å­˜ç”¨æˆ·è®°å½•çš„è§„åˆ™
        saveUserRules(rules) {
          localStorage.setItem('teresen-user-rules', JSON.stringify(rules));
        }

        // æ›´æ–°ç”¨æˆ·è§„åˆ™æ˜¾ç¤º
        updateUserRules() {
          const userRules = this.getUserRules();
          const randomRulesList = document.getElementById('random-rules-list');

          if (randomRulesList) {
            let randomRulesHtml = '';

            if (userRules.length === 0) {
              randomRulesHtml = '<div class="empty-rules">æš‚æ— è®°å½•çš„è§„åˆ™ï¼Œç‚¹å‡»"æ·»åŠ è§„åˆ™"å¼€å§‹è®°å½•</div>';
            } else {
              userRules.forEach((rule, index) => {
                randomRulesHtml += `\n          <div class="rule-item-handwritten rule-item-editable" data-rule-index="${index}">\n            <span class="rule-number-handwritten">${index + 6}.</span>\n            <span class="rule-text-handwritten">${rule}</span>\n            <button class="rule-edit-btn" onclick="window.teresenDebug.editRule(${index})" title="ç¼–è¾‘è§„åˆ™">âœï¸</button>\n            <button class="rule-delete-btn" onclick="window.teresenDebug.deleteRule(${index})" title="åˆ é™¤è§„åˆ™">ğŸ—‘ï¸</button>\n          </div>\n        `;
              });
            }

            randomRulesList.innerHTML = randomRulesHtml;
          }
        }

        // æ·»åŠ æ–°è§„åˆ™
        addRule() {
          console.log('ğŸ¯ addRuleæ–¹æ³•è¢«è°ƒç”¨');
          const userRules = this.getUserRules();

          if (userRules.length >= 7) {
            alert('æœ€å¤šåªèƒ½è®°å½•7æ¡è§„åˆ™ï¼');
            return;
          }

          // ç›´æ¥æ·»åŠ ä¸€ä¸ªç©ºè§„åˆ™ï¼Œè®©ç”¨æˆ·åœ¨ç•Œé¢ä¸Šç¼–è¾‘
          userRules.push('ç‚¹å‡»è¿™é‡Œç¼–è¾‘è§„åˆ™...');
          this.saveUserRules(userRules);
          this.updateUserRules();

          // è‡ªåŠ¨è¿›å…¥ç¼–è¾‘æ¨¡å¼
          setTimeout(() => {
            this.editRule(userRules.length - 1);
          }, 100);
        }

        // ç¼–è¾‘è§„åˆ™ - ç›´æ¥åœ¨é¡µé¢å†…ç¼–è¾‘
        editRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            // æ‰¾åˆ°å¯¹åº”çš„è§„åˆ™å…ƒç´ 
            const ruleElement = document.querySelector(`[data-rule-index="${index}"] .rule-text-handwritten`);
            if (!ruleElement) return;

            const currentText = userRules[index];

            // åˆ›å»ºè¾“å…¥æ¡†æ›¿æ¢æ–‡æœ¬
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText === 'ç‚¹å‡»è¿™é‡Œç¼–è¾‘è§„åˆ™...' ? '' : currentText;
            input.className = 'rule-edit-input';
            input.style.cssText = `
              width: 100%;
              border: 2px solid #d4af37;
              border-radius: 4px;
              padding: 4px 8px;
              font-family: inherit;
              font-size: inherit;
              background: #ffffff;
              color: #333;
              outline: none;
            `;

            // æ›¿æ¢æ–‡æœ¬å…ƒç´ 
            ruleElement.style.display = 'none';
            ruleElement.parentNode.insertBefore(input, ruleElement.nextSibling);

            // èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
            input.focus();
            if (input.value) {
              input.select();
            }

            // ä¿å­˜ç¼–è¾‘
            const saveEdit = () => {
              const newText = input.value.trim();
              if (newText) {
                userRules[index] = newText;
                this.saveUserRules(userRules);
                this.updateUserRules();
              } else {
                // å¦‚æœä¸ºç©ºï¼Œæ¢å¤åŸå§‹å†…å®¹ï¼Œä¸è‡ªåŠ¨åˆ é™¤
                this.updateUserRules();
                if (typeof this.showCustomAlert === 'function') {
                  this.showCustomAlert('è§„åˆ™å†…å®¹ä¸èƒ½ä¸ºç©ºï¼Œå·²æ¢å¤åŸå†…å®¹');
                }
              }
            };

            // å–æ¶ˆç¼–è¾‘
            const cancelEdit = () => {
              input.remove();
              ruleElement.style.display = '';
            };

            // ç»‘å®šäº‹ä»¶
            input.addEventListener('keydown', e => {
              if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit();
              } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit();
              }
            });

            input.addEventListener('blur', () => {
              saveEdit();
            });
          }
        }

        // åˆ é™¤è§„åˆ™ - ç›´æ¥åˆ é™¤ï¼Œæ— å¼¹çª—ç¡®è®¤
        deleteRule(index) {
          const userRules = this.getUserRules();
          if (index >= 0 && index < userRules.length) {
            // è·å–è¦åˆ é™¤çš„è§„åˆ™æ–‡æœ¬ï¼Œç”¨äºæ’¤é”€æç¤º
            const deletedRule = userRules[index];

            // ç›´æ¥åˆ é™¤è§„åˆ™
            userRules.splice(index, 1);
            this.saveUserRules(userRules);
            this.updateUserRules();

            // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤ºï¼ˆå¦‚æœæœ‰showCustomAlertå‡½æ•°çš„è¯ï¼‰
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert(
                `å·²åˆ é™¤è§„åˆ™ï¼š${deletedRule.length > 20 ? deletedRule.substring(0, 20) + '...' : deletedRule}`,
              );
            }
          }
        }

        // æ¸…ç©ºæ‰€æœ‰è§„åˆ™ - åŒå‡»ç¡®è®¤ï¼Œæ— å¼¹çª—
        clearAllRules() {
          const userRules = this.getUserRules();
          if (userRules.length === 0) {
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert('æ²¡æœ‰è§„åˆ™éœ€è¦æ¸…ç©º');
            }
            return;
          }

          // ä½¿ç”¨åŒå‡»ç¡®è®¤æœºåˆ¶
          if (!this._clearAllClickCount) {
            this._clearAllClickCount = 1;
            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert('å†æ¬¡ç‚¹å‡»"æ¸…ç©ºæ‰€æœ‰è§„åˆ™"ç¡®è®¤åˆ é™¤æ‰€æœ‰è§„åˆ™');
            }

            // 5ç§’åé‡ç½®ç‚¹å‡»è®¡æ•°
            setTimeout(() => {
              this._clearAllClickCount = 0;
            }, 5000);
          } else {
            // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œæ‰§è¡Œæ¸…ç©º
            const ruleCount = userRules.length;
            this.saveUserRules([]);
            this.updateUserRules();
            this._clearAllClickCount = 0;

            if (typeof this.showCustomAlert === 'function') {
              this.showCustomAlert(`å·²æ¸…ç©ºæ‰€æœ‰è§„åˆ™ï¼ˆå…±${ruleCount}æ¡ï¼‰`);
            }
          }
        }
        updateProgressBar(e, t, n, color) {
          const s = document.getElementById(e),
            o = document.getElementById(t);

          if (s) {
            const e = Math.min(100, Math.max(0, n));

            s.style.width = `${e}%`;

            s.className = 'progress-fill';

            // åº”ç”¨é¢œè‰²

            if (color) {
              s.style.background = color;
            } else {
              // é»˜è®¤é¢œè‰²é€»è¾‘

              e < 30 ? s.classList.add('danger') : e < 60 && s.classList.add('warning');
            }
          }

          o && (o.textContent = n.toString());
        }

        getVariable(e, t, n) {
          try {
            const s = t.split(/\.|\[|\]/).filter(e => '' !== e);

            let o = e;

            for (let e = 0; e < s.length; e++) {
              const t = s[e];

              if (!o || 'object' != typeof o) return n;

              if (e + 1 < s.length && !isNaN(parseInt(s[e + 1]))) {
                if (!Array.isArray(o[t])) return n;

                {
                  const n = parseInt(s[e + 1]);

                  ((o = o[t][n]), e++);
                }
              } else o = o[t];
            }

            const a = void 0 !== o ? o : n;

            return a;
          } catch (s) {
            console.error(`âŒ è·å–å˜é‡å‡ºé”™: ${t}`, s);
            return n;
          }
        }

        getTrainerStatusText(sanity, stamina) {
          if (sanity >= 80 && stamina >= 80) return 'ç»å¥½è°ƒ';

          if (sanity >= 60 && stamina >= 60) return 'å¥½è°ƒ';

          if (sanity >= 40 && stamina >= 40) return 'æ™®é€š';

          if (sanity >= 20 && stamina >= 20) return 'ä¸è°ƒ';

          return 'ç»ä¸è°ƒ';
        }

        getTrainerStatusClass(sanity, stamina) {
          if (sanity >= 80 && stamina >= 80) return 'status-excellent';

          if (sanity >= 60 && stamina >= 60) return 'status-good';

          if (sanity >= 40 && stamina >= 40) return 'status-normal';

          if (sanity >= 20 && stamina >= 20) return 'status-bad';

          return 'status-terrible';
        }

        getStaminaColor(stamina) {
          if (stamina >= 80) return 'linear-gradient(90deg, #10b981 0%, #34d399 100%)';

          if (stamina >= 60) return 'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)';

          if (stamina >= 40) return 'linear-gradient(90deg, #f97316 0%, #fb923c 100%)';

          if (stamina >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';
        }

        getSanityColor(sanity) {
          if (sanity >= 80) return 'linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%)';

          if (sanity >= 60) return 'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)';

          if (sanity >= 40) return 'linear-gradient(90deg, #ec4899 0%, #f472b6 100%)';

          if (sanity >= 20) return 'linear-gradient(90deg, #dc2626 0%, #ef4444 100%)';

          return 'linear-gradient(90deg, #7f1d1d 0%, #dc2626 100%)';
        }

        getSelfControlColor(selfControl) {
          if (selfControl >= 80) return 'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)';

          if (selfControl >= 60) return 'linear-gradient(90deg, #7c3aed 0%, #8b5cf6 100%)';

          if (selfControl >= 40) return 'linear-gradient(90deg, #6d28d9 0%, #7c3aed 100%)';

          if (selfControl >= 20) return 'linear-gradient(90deg, #5b21b6 0%, #6d28d9 100%)';

          return 'linear-gradient(90deg, #4c1d95 0%, #5b21b6 100%)';
        }

        getLuckColor(luck) {
          if (luck >= 80) return 'linear-gradient(90deg, #ffd700 0%, #ffed4e 100%)';

          if (luck >= 60) return 'linear-gradient(90deg, #ff8c00 0%, #ffa500 100%)';

          if (luck >= 40) return 'linear-gradient(90deg, #ff6b35 0%, #ff8c00 100%)';

          if (luck >= 20) return 'linear-gradient(90deg, #ff4500 0%, #ff6b35 100%)';

          return 'linear-gradient(90deg, #cc3700 0%, #ff4500 100%)';
        }

        getUmaDescription(e, t, n) {
          return 'è¢«é™„èº«' === n
            ? 'è¢«æŸç§åŠ›é‡æ§åˆ¶ç€...'
            : 'å¤±è¸ª' === n
              ? 'ä¸çŸ¥å»å‘...'
              : t >= 80
                ? 'å¯¹ä½ éå¸¸ä¿¡ä»»'
                : t >= 60
                  ? 'å¯¹ä½ æ¯”è¾ƒå‹å¥½'
                  : t >= 40
                    ? 'å¯¹ä½ æœ‰äº›æˆ’å¤‡'
                    : t >= 20
                      ? 'å¯¹ä½ ä¿æŒè·ç¦»'
                      : 'å¯¹ä½ å¾ˆé™Œç”Ÿ';
        }

        getUmaStatusClass(e) {
          switch (e) {
            case 'æ­£å¸¸':

            default:
              return 'normal';

            case 'ç—…å¨‡':
              return 'yandere';

            case 'è¢«é™„èº«':
              return 'possessed';

            case 'å¤±è¸ª':
              return 'missing';
          }
        }

        generateHeartIcons(e) {
          let t = '';

          // console.log(`ğŸ’– ç”Ÿæˆå¿ƒå½¢å›¾æ ‡ï¼Œæ•°é‡: ${e}`);

          const n = Math.max(1, Math.min(5, e));

          // console.log(`ğŸ’– å®é™…æ˜¾ç¤ºæ•°é‡: ${n}`);

          for (let s = 0; s < n; s++) t += '<span class="heart">â¤</span>';

          return (console.log(`ğŸ’– ç”Ÿæˆçš„å¿ƒå½¢HTML: ${t}`), t);
        }

        toggleItemDetails(e) {
          const t = document.getElementById(`item-details-${e}`),
            n = document.querySelector(`[data-item-index="${e}"] .item-toggle`);

          if (t && n) {
            if ('none' !== t.style.display) ((t.style.display = 'none'), (n.textContent = 'â–¼'));
            else {
              const sound = document.getElementById('item-detail-sound');

              if (sound) {
                sound.currentTime = 0;

                sound.play().catch(err => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', err));
              }

              ((t.style.display = 'block'), (n.textContent = 'â–²'));
            }
          }
        }

        toggleRules(e) {
          const t = document.getElementById(`${e}-rules-content`),
            n = document.querySelector(`[onclick="window.teresenDebug.toggleRules('${e}')"] .rules-toggle`);

          if (t && n) {
            'none' !== t.style.display
              ? ((t.style.display = 'none'), (n.textContent = 'â–¼'))
              : ((t.style.display = 'block'), (n.textContent = 'â–²'));
          }
        }

        toggleUmaSection() {
          const e = document.getElementById('uma-content'),
            t = document.querySelector('.uma-toggle');

          if (e && t) {
            'none' !== e.style.display
              ? ((e.style.display = 'none'), (t.textContent = 'â–¼'))
              : ((e.style.display = 'block'), (t.textContent = 'â–²'));
          }
        }

        toggleProfile() {
          const e = document.getElementById('profile-basic'),
            t = document.getElementById('profile-detail');

          e &&
            t &&
            ('none' === t.style.display
              ? ((e.style.display = 'none'), (t.style.display = 'block'))
              : ((e.style.display = 'block'), (t.style.display = 'none')));
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨å±•å¼€/æŠ˜å ï¼ˆç±»ä¼¼ä¸ªäººæ¡£æ¡ˆçš„é€»è¾‘ï¼‰
        toggleTaskList() {
          const basic = document.getElementById('task-list-basic');
          const detail = document.getElementById('task-list-detail');

          if (basic && detail) {
            if ('none' === detail.style.display) {
              basic.style.display = 'none';
              detail.style.display = 'block';
              // å±•å¼€æ—¶æ›´æ–°ä»»åŠ¡åˆ—è¡¨
              this.updateTaskList();
            } else {
              basic.style.display = 'block';
              detail.style.display = 'none';
            }
          }
        }

        // æ›´æ–°ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        updateTaskList() {
          const taskListContent = document.getElementById('task-list-content');
          if (!taskListContent) return;

          try {
            // ä»MVUçŠ¶æ€ä¸­è¯»å–ä»»åŠ¡åˆ—è¡¨
            const taskList = this.currentMvuState?.stat_data?.ä»»åŠ¡åˆ—è¡¨;

            if (!taskList || typeof taskList !== 'object') {
              taskListContent.innerHTML =
                '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">æš‚æ— ä»»åŠ¡</div>';
              return;
            }

            // è¿‡æ»¤æ‰$metaå…ƒæ•°æ®
            const tasks = Object.keys(taskList)
              .filter(key => key !== '$meta' && taskList[key] && typeof taskList[key] === 'object')
              .map(key => ({ id: key, ...taskList[key] }));

            if (tasks.length === 0) {
              taskListContent.innerHTML =
                '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">æš‚æ— ä»»åŠ¡</div>';
              return;
            }

            // ç”Ÿæˆä»»åŠ¡åˆ—è¡¨HTML
            const tasksHTML = tasks
              .map((task, index) => {
                const ç®€ä»‹ = task.ç®€ä»‹ || 'æ— ';
                const ç›®æ ‡ = task.ç›®æ ‡ || 'æ— ';
                const å¥–åŠ± = task.å¥–åŠ± || 'æ— ';

                return `
                <div style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(255, 255, 255, 0.4);
                  border: 1px solid rgba(139, 105, 20, 0.2);
                  border-radius: 6px;
                  border-left: 3px solid rgba(139, 105, 20, 0.5);
                ">
                  <div style="
                    font-weight: 600;
                    color: #8b4513;
                    font-size: 0.9em;
                    margin-bottom: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  ">
                    <span style="font-size: 1.1em;">ğŸ“‹</span>
                    <span>ä»»åŠ¡ ${index + 1}</span>
                  </div>
                  <div style="
                    font-size: 0.85em;
                    color: #6b5b3d;
                    line-height: 1.6;
                  ">
                    <div style="margin-bottom: 6px;">
                      <strong style="color: #8b4513;">ç®€ä»‹ï¼š</strong>
                      <span>${ç®€ä»‹}</span>
                    </div>
                    <div style="margin-bottom: 6px;">
                      <strong style="color: #8b4513;">ç›®æ ‡ï¼š</strong>
                      <span>${ç›®æ ‡}</span>
                    </div>
                    <div>
                      <strong style="color: #8b4513;">å¥–åŠ±ï¼š</strong>
                      <span style="color: #b8860b; font-weight: 500;">${å¥–åŠ±}</span>
                    </div>
                  </div>
                </div>
              `;
              })
              .join('');

            taskListContent.innerHTML = tasksHTML;
          } catch (error) {
            console.error('æ›´æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            taskListContent.innerHTML =
              '<div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px;">åŠ è½½ä»»åŠ¡åˆ—è¡¨æ—¶å‡ºé”™</div>';
          }
        }

        toggleUmaStatus() {
          const umaList = document.getElementById('uma-status');

          const expandBtn = document.getElementById('uma-expand-btn');

          if (umaList && expandBtn) {
            if ('none' === umaList.style.display) {
              umaList.style.display = 'block';
            } else {
              umaList.style.display = 'none';
            }
          }
        }

        checkAutoFullscreen() {
          // æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†è‡ªåŠ¨å…¨å±åŠ è½½
          const autoFullscreen = localStorage.getItem('teresen_auto_fullscreen') !== 'false'; // é»˜è®¤ä¸ºtrue

          if (!autoFullscreen) {
            console.log('â­ï¸ è‡ªåŠ¨å…¨å±åŠ è½½æœªå¯ç”¨');
            return;
          }

          // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
          const isMobile =
            window.mobileDetector?.isMobile ||
            /mobile|android|iphone|ipad|ipod/i.test(navigator.userAgent) ||
            window.innerWidth <= 768;

          if (isMobile) {
            console.log('ğŸ“± ç§»åŠ¨ç«¯è®¾å¤‡ï¼Œè·³è¿‡è‡ªåŠ¨å…¨å±åŠ è½½');
            return;
          }

          // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å…¨å±çŠ¶æ€
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            console.log('âœ… å·²åœ¨å…¨å±çŠ¶æ€ï¼Œè·³è¿‡è‡ªåŠ¨å…¨å±åŠ è½½');
            return;
          }

          // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
          setTimeout(() => {
            console.log('ğŸš€ è‡ªåŠ¨è¿›å…¥å…¨å±ç¼©æ”¾æ¨¡å¼...');
            const panels = document.querySelector('.connected-panels');
            const btn = document.getElementById('fullscreen-btn');
            if (panels && btn) {
              this.enterFullscreenWithZoom(panels, btn);
            }
          }, 500);
        }

        toggleJourney() {
          const e = document.getElementById('journey-basic'),
            t = document.getElementById('journey-detail');

          e &&
            t &&
            ('none' === t.style.display
              ? ((e.style.display = 'none'), (t.style.display = 'block'))
              : ((e.style.display = 'block'), (t.style.display = 'none')));
        }

        // ğŸ”¥ å­˜æ¡£åŠŸèƒ½å·²åˆ é™¤

        toggleFullscreen() {
          // ğŸ”¥ å…¨å±+ç¼©æ”¾åŠŸèƒ½ï¼šåˆ›å»ºè¦†ç›–å±‚ï¼Œæ”¯æŒç¼©æ”¾å¹¶ä¿æŒåŸæœ‰æ¯”ä¾‹
          const panels = document.querySelector('.connected-panels');
          const btn = document.getElementById('fullscreen-btn');

          if (!panels || !btn) return;

          // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å…¨å±æ¨¡å¼
          const existingOverlay = document.getElementById('teresen-fullscreen-overlay');

          if (existingOverlay) {
            // é€€å‡ºå…¨å±
            this.exitFullscreenWithZoom(panels, btn, existingOverlay);
          } else {
            // è¿›å…¥å…¨å±
            this.enterFullscreenWithZoom(panels, btn);
          }
        }

        // ğŸ”¥ è¿›å…¥å…¨å±+ç¼©æ”¾æ¨¡å¼
        enterFullscreenWithZoom(panels, btn) {
          try {
            // è·å–åŸå§‹å°ºå¯¸å’Œæ¯”ä¾‹
            const computedStyle = window.getComputedStyle(panels);
            const originalWidth = parseFloat(computedStyle.width) || 1600;
            const originalHeight = parseFloat(computedStyle.height) || 575;
            const originalAspectRatio = originalWidth / originalHeight;

            // ä¿å­˜åŸå§‹æ ·å¼
            const originalStyle = {
              position: panels.style.position || '',
              width: panels.style.width || '',
              height: panels.style.height || '',
              maxWidth: panels.style.maxWidth || '',
              maxHeight: panels.style.maxHeight || '',
              margin: panels.style.margin || '',
              transform: panels.style.transform || '',
              transformOrigin: panels.style.transformOrigin || '',
            };
            panels.dataset.originalStyle = JSON.stringify(originalStyle);
            panels.dataset.originalWidth = originalWidth;
            panels.dataset.originalHeight = originalHeight;
            panels.dataset.originalAspectRatio = originalAspectRatio;

            // ä¿å­˜åŸå§‹çˆ¶å…ƒç´ å’Œä½ç½®ä¿¡æ¯ï¼ˆå…³é”®ï¼šç”¨äºæ¢å¤ï¼‰
            const originalParent = panels.parentNode;
            const originalNextSibling = panels.nextSibling;
            panels.dataset.originalParentId = originalParent?.id || '';
            panels.dataset.originalParentTag = originalParent?.tagName || '';
            if (originalNextSibling) {
              panels.dataset.originalNextSiblingId = originalNextSibling.id || '';
              panels.dataset.originalNextSiblingTag = originalNextSibling.tagName || '';
            }

            // åˆ›å»ºå…¨å±è¦†ç›–å±‚ï¼ˆå¸¦é»‘è¾¹èƒŒæ™¯ï¼‰
            const overlay = document.createElement('div');
            overlay.id = 'teresen-fullscreen-overlay';

            // åŠ è½½èƒŒæ™¯è®¾ç½®ï¼ˆé»˜è®¤ä½¿ç”¨å›¾ç‰‡èƒŒæ™¯ï¼‰
            const defaultBgImage = 'https://files.catbox.moe/rjchsc.jpg';
            const overlayBgType = localStorage.getItem('teresen_fullscreen_background_type') || 'image';
            const overlayBgImage = localStorage.getItem('teresen_fullscreen_background_image') || defaultBgImage;

            console.log('ğŸ¨ å…¨å±èƒŒæ™¯è®¾ç½®:', { overlayBgType, overlayBgImage });

            // è®¾ç½®èƒŒæ™¯æ ·å¼
            overlay.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100vw;
              height: 100vh;
              backdrop-filter: blur(8px);
              z-index: 99999;
              display: flex;
              justify-content: center;
              align-items: center;
              overflow: hidden;
              padding: 0;
              box-sizing: border-box;
            `;

            // åº”ç”¨èƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (overlayBgType === 'image' && overlayBgImage) {
              console.log('ğŸ¨ åº”ç”¨èƒŒæ™¯å›¾ç‰‡:', overlayBgImage);
              overlay.style.backgroundImage = `url("${overlayBgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)'; // é™ä½é»‘è‰²é€æ˜åº¦ï¼Œè®©å›¾ç‰‡æ›´æ˜æ˜¾
            } else {
              console.log('ğŸ¨ ä½¿ç”¨é»‘è¾¹èƒŒæ™¯');
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            }

            // åˆ›å»ºæ§åˆ¶æ ï¼ˆç¼©æ”¾æ§åˆ¶ï¼‰
            const controls = document.createElement('div');
            controls.id = 'fullscreen-controls';
            controls.style.cssText = `
              position: absolute;
              top: 20px;
              right: 20px;
              display: flex;
              gap: 10px;
              align-items: center;
              z-index: 100000;
              background: rgba(45, 27, 27, 0.9);
              padding: 10px 15px;
              border-radius: 8px;
              border: 1px solid #8b7355;
              backdrop-filter: blur(4px);
            `;

            // ç¼©æ”¾æ ‡ç­¾
            const zoomLabel = document.createElement('span');
            zoomLabel.textContent = 'ç¼©æ”¾:';
            zoomLabel.style.cssText = 'color: #e0dcd1; font-size: 14px; margin-right: 5px;';

            // ç¼©æ”¾æ»‘å—
            const zoomSlider = document.createElement('input');
            zoomSlider.type = 'range';
            zoomSlider.min = '0.5';
            zoomSlider.max = '2';
            zoomSlider.step = '0.1';
            zoomSlider.value = '1';
            zoomSlider.style.cssText = 'width: 150px; cursor: pointer;';

            // ç¼©æ”¾å€¼æ˜¾ç¤º
            const zoomValue = document.createElement('span');
            zoomValue.id = 'zoom-value';
            zoomValue.textContent = '100%';
            zoomValue.style.cssText = 'color: #e0dcd1; font-size: 14px; min-width: 50px; text-align: center;';

            // è®¡ç®—åˆå§‹ç¼©æ”¾æ¯”ä¾‹ï¼ˆç”µè„‘ç«¯é»˜è®¤140%ï¼‰
            const screenWidth = window.innerWidth - 40;
            const screenHeight = window.innerHeight - 40;
            const widthByHeight = screenHeight * originalAspectRatio;
            const heightByWidth = screenWidth / originalAspectRatio;

            // ğŸ”¥ ç”µè„‘ç«¯é»˜è®¤140%ç¼©æ”¾ï¼Œå³ä½¿è¶…å‡ºå±å¹•ä¹Ÿä½¿ç”¨140%ï¼ˆä¸å†è‡ªåŠ¨è°ƒæ•´ä¸º93%ï¼‰
            let initialScale = 1.4;

            // é™åˆ¶åˆå§‹ç¼©æ”¾èŒƒå›´
            initialScale = Math.max(0.5, Math.min(2, initialScale));
            zoomSlider.value = initialScale.toFixed(1);
            zoomValue.textContent = Math.round(initialScale * 100) + '%';

            // ç¼©æ”¾äº‹ä»¶å¤„ç†ï¼ˆé™åˆ¶å°ºå¯¸ï¼Œä¸ç›´æ¥æ‰©å±•ï¼‰
            let currentScale = initialScale;
            zoomSlider.addEventListener('input', e => {
              const scale = parseFloat(e.target.value);
              currentScale = scale;
              zoomValue.textContent = Math.round(scale * 100) + '%';

              // åº”ç”¨ç¼©æ”¾ï¼Œä¿æŒå®½é«˜æ¯”ï¼Œå¹¶é™åˆ¶å°ºå¯¸ï¼ˆé˜²æ­¢ç›´æ¥æ‰©å±•ï¼‰
              const scaledWidth = originalWidth * scale;
              const scaledHeight = originalHeight * scale;

              panels.style.width = scaledWidth + 'px';
              panels.style.height = scaledHeight + 'px';
              panels.style.maxWidth = scaledWidth + 'px'; // ğŸ”¥ é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ‰©å±•
              panels.style.maxHeight = scaledHeight + 'px'; // ğŸ”¥ é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢æ‰©å±•
              panels.style.minWidth = scaledWidth + 'px'; // ğŸ”¥ é™åˆ¶æœ€å°å®½åº¦
              panels.style.minHeight = scaledHeight + 'px'; // ğŸ”¥ é™åˆ¶æœ€å°é«˜åº¦
              panels.style.transform = '';
              panels.style.transformOrigin = 'center center';
              panels.style.flexShrink = '0'; // ğŸ”¥ é˜²æ­¢è¢«å‹ç¼©
            });

            // å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âœ•';
            closeBtn.style.cssText = `
              width: 32px;
              height: 32px;
              background: rgba(139, 105, 20, 0.8);
              border: 2px solid #8b6914;
              border-radius: 50%;
              color: #e0dcd1;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              margin-left: 10px;
            `;
            closeBtn.onmouseover = () => {
              closeBtn.style.background = '#8b6914';
              closeBtn.style.transform = 'rotate(90deg)';
            };
            closeBtn.onmouseout = () => {
              closeBtn.style.background = 'rgba(139, 105, 20, 0.8)';
              closeBtn.style.transform = 'rotate(0deg)';
            };
            closeBtn.onclick = () => this.toggleFullscreen();

            // ç»„è£…æ§åˆ¶æ 
            controls.appendChild(zoomLabel);
            controls.appendChild(zoomSlider);
            controls.appendChild(zoomValue);
            controls.appendChild(closeBtn);

            // åˆ›å»ºå†…å®¹å®¹å™¨ï¼ˆé™åˆ¶å°ºå¯¸ï¼Œä¸ç›´æ¥æ‰©å±•ï¼‰
            const contentWrapper = document.createElement('div');
            contentWrapper.style.cssText = `
              width: 100%;
              height: 100%;
              display: flex;
              justify-content: center;
              align-items: center;
              overflow: auto;
              padding: 20px;
              box-sizing: border-box;
            `;

            // åº”ç”¨åˆå§‹ç¼©æ”¾ï¼ˆé™åˆ¶å°ºå¯¸ï¼Œä¸ç›´æ¥æ‰©å±•ï¼‰
            const scaledWidth = originalWidth * initialScale;
            const scaledHeight = originalHeight * initialScale;
            panels.style.width = scaledWidth + 'px';
            panels.style.height = scaledHeight + 'px';
            panels.style.maxWidth = scaledWidth + 'px'; // ğŸ”¥ é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ‰©å±•
            panels.style.maxHeight = scaledHeight + 'px'; // ğŸ”¥ é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢æ‰©å±•
            panels.style.minWidth = scaledWidth + 'px'; // ğŸ”¥ é™åˆ¶æœ€å°å®½åº¦
            panels.style.minHeight = scaledHeight + 'px'; // ğŸ”¥ é™åˆ¶æœ€å°é«˜åº¦
            panels.style.position = 'relative';
            panels.style.margin = 'auto';
            panels.style.transformOrigin = 'center center';
            panels.style.flexShrink = '0'; // ğŸ”¥ é˜²æ­¢è¢«å‹ç¼©

            // ç»„è£…è¦†ç›–å±‚
            contentWrapper.appendChild(panels);
            overlay.appendChild(contentWrapper);
            overlay.appendChild(controls);

            // æ·»åŠ åˆ°body
            document.body.appendChild(overlay);

            // ğŸ”¥ åŠ è½½èƒŒæ™¯è®¾ç½®ï¼ˆå¦‚æœå·²ä¿å­˜ï¼‰
            const bgType = localStorage.getItem('teresen_bg_type') || 'black';
            const bgImage = localStorage.getItem('teresen_bg_image');
            if (bgType === 'image' && bgImage) {
              overlay.style.backgroundImage = `url(${bgImage})`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            }

            // ğŸ”¥ å°†æ‰€æœ‰å·²å­˜åœ¨çš„å¼¹çª—ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
            this.moveModalsToOverlay(overlay);

            // æ·»åŠ åˆ°bodyï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
            document.body.appendChild(overlay);

            // ğŸ”¥ å¯¹æ•´ä¸ªè¦†ç›–å±‚ä½¿ç”¨Fullscreen APIï¼ˆä¿ç•™ç¼©æ”¾é»‘è¾¹ï¼‰
            // æ³¨æ„ï¼šrequestFullscreen éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½è§¦å‘ï¼Œæ‰€ä»¥å…ˆæ·»åŠ åˆ°DOMï¼Œç„¶ååœ¨ç”¨æˆ·äº¤äº’æ—¶è§¦å‘
            const requestFullscreen =
              overlay.requestFullscreen ||
              overlay.webkitRequestFullscreen ||
              overlay.mozRequestFullScreen ||
              overlay.msRequestFullscreen;

            if (requestFullscreen) {
              // å°è¯•è‡ªåŠ¨è¿›å…¥å…¨å±ï¼ˆå¦‚æœæµè§ˆå™¨å…è®¸ï¼Œæ¯”å¦‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼‰
              requestFullscreen
                .call(overlay)
                .then(() => {
                  console.log('âœ… æˆåŠŸè¿›å…¥å…¨å±æ¨¡å¼');
                })
                .catch(error => {
                  console.log('âš ï¸ è‡ªåŠ¨å…¨å±è¢«é˜»æ­¢ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰ï¼Œå°†åœ¨ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»æ—¶è¿›å…¥å…¨å±:', error);
                  // æ·»åŠ ä¸€ä¸ªæç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·ç‚¹å‡»ä»»æ„ä½ç½®è¿›å…¥å…¨å±
                  const fullscreenHint = document.createElement('div');
                  fullscreenHint.id = 'fullscreen-hint';
                  fullscreenHint.innerHTML = 'ğŸ‘† ç‚¹å‡»ä»»æ„ä½ç½®è¿›å…¥å…¨å±æ¨¡å¼';
                  fullscreenHint.style.cssText = `
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background: rgba(45, 27, 27, 0.95);
                  color: #e0dcd1;
                  padding: 20px 40px;
                  border-radius: 12px;
                  border: 2px solid #8b7355;
                  z-index: 100001;
                  font-size: 18px;
                  font-weight: 600;
                  cursor: pointer;
                  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                  animation: pulse 2s infinite;
                  pointer-events: auto;
                `;
                  overlay.appendChild(fullscreenHint);

                  // ç‚¹å‡»æç¤ºæˆ–è¦†ç›–å±‚æ—¶è¿›å…¥å…¨å±
                  const enterFullscreenOnClick = e => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æ§åˆ¶æ ï¼Œä¸è§¦å‘å…¨å±
                    if (e.target.closest('#fullscreen-controls')) {
                      return;
                    }
                    requestFullscreen
                      .call(overlay)
                      .then(() => {
                        console.log('âœ… ç”¨æˆ·äº¤äº’åæˆåŠŸè¿›å…¥å…¨å±æ¨¡å¼');
                        if (fullscreenHint.parentNode) {
                          fullscreenHint.parentNode.removeChild(fullscreenHint);
                        }
                        overlay.removeEventListener('click', enterFullscreenOnClick);
                        fullscreenHint.removeEventListener('click', enterFullscreenOnClick);
                      })
                      .catch(err => {
                        console.error('âŒ è¿›å…¥å…¨å±å¤±è´¥:', err);
                      });
                  };

                  fullscreenHint.addEventListener('click', enterFullscreenOnClick);
                  overlay.addEventListener('click', enterFullscreenOnClick);

                  // 3ç§’åè‡ªåŠ¨éšè—æç¤º
                  setTimeout(() => {
                    if (fullscreenHint.parentNode) {
                      fullscreenHint.style.opacity = '0';
                      fullscreenHint.style.transition = 'opacity 0.5s';
                      setTimeout(() => {
                        if (fullscreenHint.parentNode) {
                          fullscreenHint.parentNode.removeChild(fullscreenHint);
                        }
                      }, 500);
                    }
                  }, 3000);
                });
            } else {
              console.warn('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå…¨å±APIï¼Œä»…æ˜¾ç¤ºè¦†ç›–å±‚');
            }

            // ğŸ”¥ æ›´æ–°ä¸ºé€€å‡ºå…¨å±å›¾æ ‡ï¼ˆç¼©å°å›¾æ ‡ï¼‰ï¼Œåªæ›´æ–°SVGï¼Œä¸æ›´æ–°æ–‡å­—
            const updateBtnState = button => {
              if (!button) return;
              const svg = button.querySelector('svg');
              if (svg) {
                svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
              }
              button.title = 'é€€å‡ºå…¨å±';
            };
            updateBtnState(btn);
            updateBtnState(document.getElementById('fullscreen-btn-right'));

            console.log('ğŸ–¥ï¸ è¿›å…¥å…¨å±+ç¼©æ”¾æ¨¡å¼ï¼Œåˆå§‹ç¼©æ”¾:', Math.round(initialScale * 100) + '%');
          } catch (error) {
            console.error('âŒ è¿›å…¥å…¨å±å¤±è´¥:', error);
            alert('å…¨å±åŠŸèƒ½å¤±è´¥: ' + error.message);
          }
        }

        // ğŸ”¥ é€€å‡ºå…¨å±+ç¼©æ”¾æ¨¡å¼
        exitFullscreenWithZoom(panels, btn, overlay) {
          try {
            // ğŸ”¥ å…ˆé€€å‡ºå…¨å±ï¼ˆå¦‚æœè¦†ç›–å±‚åœ¨å…¨å±çŠ¶æ€ï¼‰
            if (
              document.fullscreenElement === overlay ||
              document.webkitFullscreenElement === overlay ||
              document.mozFullScreenElement === overlay ||
              document.msFullscreenElement === overlay
            ) {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
              } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
              } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
              }
            }

            // ğŸ”¥ å…ˆå°†æ‰€æœ‰å¼¹çª—ç§»å›åŸä½ç½®
            this.restoreModalsToOriginalPosition();

            // ğŸ”¥ å…³é”®ï¼šå…ˆä»è¦†ç›–å±‚ä¸­å–å‡ºpanelsï¼ˆåœ¨ç§»é™¤è¦†ç›–å±‚ä¹‹å‰ï¼‰
            if (panels && panels.parentNode) {
              // æ‰¾åˆ°panelsçš„çˆ¶å®¹å™¨ï¼ˆcontentWrapperï¼‰
              const contentWrapper = panels.parentNode;

              // æ¢å¤åŸå§‹æ ·å¼ï¼ˆæ¢å¤åˆ°åŸå§‹ç¼©æ”¾æ¯”ä¾‹ï¼‰
              if (panels.dataset.originalStyle) {
                const originalStyle = JSON.parse(panels.dataset.originalStyle);
                panels.style.position = originalStyle.position || '';
                panels.style.width = originalStyle.width || '';
                panels.style.height = originalStyle.height || '';
                panels.style.maxWidth = originalStyle.maxWidth || '';
                panels.style.maxHeight = originalStyle.maxHeight || '';
                panels.style.minWidth = ''; // ğŸ”¥ æ¸…é™¤å…¨å±æ—¶æ·»åŠ çš„minWidth
                panels.style.minHeight = ''; // ğŸ”¥ æ¸…é™¤å…¨å±æ—¶æ·»åŠ çš„minHeight
                panels.style.margin = originalStyle.margin || '';
                panels.style.transform = originalStyle.transform || '';
                panels.style.transformOrigin = originalStyle.transformOrigin || '';
                panels.style.flexShrink = ''; // ğŸ”¥ æ¸…é™¤å…¨å±æ—¶æ·»åŠ çš„flexShrink

                delete panels.dataset.originalStyle;
                delete panels.dataset.originalWidth;
                delete panels.dataset.originalHeight;
                delete panels.dataset.originalAspectRatio;

                console.log('âœ… å·²æ¢å¤åˆ°åŸå§‹ç¼©æ”¾æ¯”ä¾‹:', originalStyle.width, 'x', originalStyle.height);
              }

              // å°è¯•æ‰¾åˆ°åŸå§‹çˆ¶å…ƒç´ å¹¶ç§»å›
              let originalParent = null;

              // ä¼˜å…ˆé€šè¿‡IDæŸ¥æ‰¾
              if (panels.dataset.originalParentId) {
                originalParent = document.getElementById(panels.dataset.originalParentId);
              }

              // å¦‚æœIDæŸ¥æ‰¾å¤±è´¥ï¼Œå°è¯•é€šè¿‡tagNameæŸ¥æ‰¾
              if (!originalParent && panels.dataset.originalParentTag) {
                const candidates = document.getElementsByTagName(panels.dataset.originalParentTag);
                for (let i = 0; i < candidates.length; i++) {
                  const candidate = candidates[i];
                  if (candidate.id || candidate.className) {
                    originalParent = candidate;
                    break;
                  }
                }
              }

              // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨body
              if (!originalParent) {
                originalParent = document.body;
              }

              // å°†panelsç§»å›åŸå§‹ä½ç½®
              if (originalParent) {
                if (panels.dataset.originalNextSiblingId) {
                  const nextSibling = document.getElementById(panels.dataset.originalNextSiblingId);
                  if (nextSibling && nextSibling.parentNode === originalParent) {
                    originalParent.insertBefore(panels, nextSibling);
                  } else {
                    originalParent.appendChild(panels);
                  }
                } else {
                  originalParent.appendChild(panels);
                }
                console.log('âœ… panelså·²ç§»å›åŸå§‹ä½ç½®');
              }

              // æ¸…ç†ä¿å­˜çš„å¼•ç”¨
              delete panels.dataset.originalParentId;
              delete panels.dataset.originalParentTag;
              delete panels.dataset.originalNextSiblingId;
              delete panels.dataset.originalNextSiblingTag;
            }

            // ç§»é™¤è¦†ç›–å±‚
            if (overlay && overlay.parentNode) {
              overlay.parentNode.removeChild(overlay);
            }

            // ğŸ”¥ æ›´æ–°ä¸ºå…¨å±å›¾æ ‡ï¼ˆå±•å¼€å›¾æ ‡ï¼‰ï¼Œåªæ›´æ–°SVGï¼Œä¸æ›´æ–°æ–‡å­—
            const updateBtnState = button => {
              if (!button) return;
              const svg = button.querySelector('svg');
              if (svg) {
                svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
              }
              button.title = 'å…¨å±';
            };
            updateBtnState(btn);
            updateBtnState(document.getElementById('fullscreen-btn-right'));

            console.log('ğŸ–¥ï¸ é€€å‡ºå…¨å±+ç¼©æ”¾æ¨¡å¼');
          } catch (error) {
            console.error('âŒ é€€å‡ºå…¨å±å¤±è´¥:', error);
          }
        }

        handleFullscreenChange() {
          // ğŸ”¥ ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼Œé€€å‡ºæ—¶æ¢å¤åŸå§‹æ¯”ä¾‹
          const e = document.querySelector('.connected-panels'),
            t = document.getElementById('fullscreen-btn'),
            tRight = document.getElementById('fullscreen-btn-right');

          if (!e || !t) return;

          const isFullscreen = !!(
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement
          );

          // æ›´æ–°æŒ‰é’®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
          const updateButton = (btn, isFullscreen) => {
            if (!btn) return;
            const svg = btn.querySelector('svg');
            if (svg) {
              // ä¸¤ä¸ªæŒ‰é’®ä½¿ç”¨ç›¸åŒçš„å…¨å±å›¾æ ‡ï¼ˆå±•å¼€/ç¼©å°éƒ½æ˜¯åŒä¸€ä¸ªå›¾æ ‡ï¼Œå› ä¸ºæ˜¯åˆ‡æ¢åŠŸèƒ½ï¼‰
              svg.innerHTML = `<path d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" />`;
            }
            btn.title = isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±';
          };

          if (isFullscreen) {
            e.classList.add('fullscreen-active');
            // ğŸ”¥ æ›´æ–°ä¸ºé€€å‡ºå…¨å±å›¾æ ‡ï¼ˆç¼©å°å›¾æ ‡ï¼‰
            updateButton(t, true);
            updateButton(tRight, true);
            console.log('ğŸ–¥ï¸ è¿›å…¥å…¨å±æ¨¡å¼');
          } else {
            e.classList.remove('fullscreen-active');

            // ğŸ”¥ å¦‚æœé€šè¿‡ESCé€€å‡ºå…¨å±ï¼Œä¹Ÿéœ€è¦æ¢å¤åŸå§‹æ¯”ä¾‹
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay) {
              // è°ƒç”¨é€€å‡ºå‡½æ•°æ¥æ¢å¤
              this.exitFullscreenWithZoom(e, t, overlay);

              // ğŸ”¥ é€€å‡ºå…¨å±æ—¶ï¼Œå°†æ‰€æœ‰å¼¹çª—ä»overlayç§»å›body
              const modalsToRestore = [
                'quick-action-modal',
                'quick-position-modal',
                'rules-modal',
                'settings-modal',
                'talents-modal',
                'load-modal',
                'world-map-modal',
              ];

              modalsToRestore.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.parentNode === overlay) {
                  const originalParent = modal.dataset.originalParent;
                  if (originalParent === 'BODY' || !originalParent) {
                    document.body.appendChild(modal);
                    console.log(`âœ… ${modalId} å·²ä»overlayç§»å›body`);
                  }
                }
              });
            } else {
              // å¦‚æœæ²¡æœ‰è¦†ç›–å±‚ï¼Œåªæ¢å¤æ ·å¼ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
              if (e.dataset.originalStyle) {
                const originalStyle = JSON.parse(e.dataset.originalStyle);
                e.style.width = originalStyle.width || '';
                e.style.height = originalStyle.height || '';
                e.style.maxWidth = originalStyle.maxWidth || '';
                e.style.maxHeight = originalStyle.maxHeight || '';
                e.style.minWidth = '';
                e.style.minHeight = '';
                e.style.flexShrink = '';

                delete e.dataset.originalStyle;
                delete e.dataset.originalWidth;
                delete e.dataset.originalHeight;
                delete e.dataset.originalAspectRatio;
              }
            }

            // ğŸ”¥ æ›´æ–°ä¸ºå…¨å±å›¾æ ‡ï¼ˆå±•å¼€å›¾æ ‡ï¼‰
            updateButton(t, false);
            updateButton(tRight, false);
            console.log('ğŸ–¥ï¸ é€€å‡ºå…¨å±æ¨¡å¼');
          }
        }

        async handleSave(e = 'local') {
          try {
            console.log(`ğŸ’¾ å¼€å§‹${'local' === e ? 'æœ¬åœ°' : 'ä¸–ç•Œä¹¦'}å­˜æ¡£...`);

            // è·å–å½“å‰æ¸¸æˆçŠ¶æ€

            const gameState = this.getAllVariables();

            // ğŸ”¥ ä»extra.teresen_chatè¯»å–èŠå¤©å†å²ï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
            let chatHistory = [];
            try {
              chatHistory = await this.loadChatHistoryFromExtra();
              console.log(`ğŸ“‹ ä»extra.teresen_chatè¯»å–åˆ° ${chatHistory.length} æ¡æ¶ˆæ¯`);
            } catch (error) {
              console.error('âŒ è¯»å–extra.teresen_chatå¤±è´¥:', error);
              chatHistory = [];
            }

            // ğŸ”¥ è¯»å–å½“å‰ä¸–ç•Œä¹¦å†…å®¹ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼šä¿å­˜AIçš„è®°å¿†ï¼‰
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
              console.log(
                `ğŸ“š è¯»å–ä¸–ç•Œä¹¦å†…å®¹: æœ¬å‘¨ç›®ç»å†(${journeyContent.length}å­—ç¬¦), æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†(${coreMemoryContent.length}å­—ç¬¦)`,
              );
            } catch (e) {
              console.error('âŒ è¯»å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
            }

            // ğŸ”¥ æ„å»ºå­˜æ¡£æ•°æ®ï¼šä¼˜å…ˆä½¿ç”¨extra.teresen_chatï¼Œå…¼å®¹chatHistoryCache
            // å¦‚æœextra.teresen_chatæœ‰æ•°æ®ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨chatHistoryCache
            let timelineHistory = [];
            if (chatHistory && chatHistory.length > 0) {
              // å°†extra.teresen_chatæ ¼å¼è½¬æ¢ä¸ºtimeline_historyæ ¼å¼
              timelineHistory = chatHistory.map(msg => ({
                message: msg.content || '',
                message_id: msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                timestamp: msg.timestamp || Date.now(),
                data: msg.variableState || null,
              }));
            } else if (this.chatHistoryCache && this.chatHistoryCache.length > 0) {
              // å…¼å®¹æ—§æ ¼å¼ï¼šä½¿ç”¨chatHistoryCache
              timelineHistory = JSON.parse(JSON.stringify(this.chatHistoryCache));
            }

            const saveData = {
              timestamp: Date.now(),

              saveName: `æ‰‹åŠ¨å­˜æ¡£_${new Date().toLocaleString('zh-CN')}`,

              type: 'manual',

              timeline_history: timelineHistory, // ğŸ”¥ ä½¿ç”¨extra.teresen_chatè½¬æ¢çš„timeline_history

              snapshot_data: {
                mvu_data: gameState,

                lorebook_content: {
                  journey: journeyContent,

                  core_memory: coreMemoryContent,
                },
              },
            };

            if (e === 'local') {
              // ä¿å­˜åˆ°æœ¬åœ°

              localStorage.setItem('teresen-save', JSON.stringify(saveData));

              console.log('âœ… æœ¬åœ°å­˜æ¡£æˆåŠŸï¼ŒåŒ…å«', timelineHistory.length, 'æ¡æ¶ˆæ¯');

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`æœ¬åœ°å­˜æ¡£æˆåŠŸï¼åŒ…å« ${timelineHistory.length} æ¡æ¶ˆæ¯`);
              }
            } else {
              // ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰

              localStorage.setItem('teresen-save', JSON.stringify(saveData));

              console.log('âœ… ä¸–ç•Œä¹¦å­˜æ¡£æˆåŠŸï¼ŒåŒ…å«', timelineHistory.length, 'æ¡æ¶ˆæ¯');

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`ä¸–ç•Œä¹¦å­˜æ¡£æˆåŠŸï¼åŒ…å« ${timelineHistory.length} æ¡æ¶ˆæ¯`);
              }
            }

            // ğŸ”¥ åˆ›å»ºå¯¹åº”çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå­˜æ¡£å¿«ç…§ï¼‰
            try {
              const saveLorebookEntry = {
                comment: `å­˜æ¡£-${saveData.saveName}`,
                content: JSON.stringify({
                  save_name: saveData.saveName,
                  timestamp: saveData.timestamp,
                  round_count: timelineHistory.length,
                  has_journey: !!journeyContent,
                  has_core_memory: !!coreMemoryContent,
                }),
                keys: [`å­˜æ¡£`, saveData.saveName],
                enabled: false,
                selective: false,
                constant: false,
                position: 'in_chat',
              };

              await TavernHelper.createLorebookEntries(bookName, [saveLorebookEntry]);
              console.log(`âœ… å·²åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®: å­˜æ¡£-${saveData.saveName}`);
            } catch (e) {
              console.warn('åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥ï¼ˆä¸å½±å“å­˜æ¡£ï¼‰:', e);
            }

            // å…³é—­å­˜æ¡£ç•Œé¢

            $('#load-modal').hide();
          } catch (error) {
            console.error('âŒ å­˜æ¡£å¤±è´¥:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        // ğŸ”¥ äººç‰©å†ç¨‹åŠŸèƒ½å·²åˆ é™¤

        // æ˜¾ç¤ºå¡é¢å±•ç¤ºæ¨¡æ€æ¡†
        showCardDisplayModal(selectedUmaName = null) {
          const modal = document.getElementById('card-display-modal');
          if (!modal) return;

          // å¡é¢å›¾ç‰‡åˆ—è¡¨
          const cardImages = [
            'https://files.catbox.moe/36fhm3.jpg',
            'https://files.catbox.moe/9jxt30.jpg',
            'https://files.catbox.moe/1fd3pn.jpg',
            'https://files.catbox.moe/cqffwa.jpg',
            'https://files.catbox.moe/57i6qj.jpg',
            'https://files.catbox.moe/z08qxd.jpg',
            'https://files.catbox.moe/tsumsa.jpg',
            'https://files.catbox.moe/rsv3mm.jpg',
            'https://files.catbox.moe/gnktvf.jpg',
            'https://files.catbox.moe/qbowdw.jpg',
            'https://files.catbox.moe/ue6x85.png',
            'https://files.catbox.moe/eot80j.jpg',
            'https://files.catbox.moe/ozkbye.jpg',
            'https://files.catbox.moe/w297n5.jpg',
            'https://files.catbox.moe/kccykt.jpg',
            'https://files.catbox.moe/assi4l.jpg',
            'https://files.catbox.moe/fhi7da.jpg',
            'https://files.catbox.moe/uke771.jpg',
            'https://files.catbox.moe/8vcxud.jpg',
            'https://files.catbox.moe/nkeit7.jpg',
            'https://files.catbox.moe/gm6cx6.jpg',
            'https://files.catbox.moe/zazebb.jpg',
            'https://files.catbox.moe/ytrv9i.jpg',
            'https://files.catbox.moe/laljcm.jpg',
            'https://files.catbox.moe/5gws7d.jpg',
            'https://files.catbox.moe/y9qq3y.jpg',
            'https://files.catbox.moe/9imu7g.jpg',
            'https://files.catbox.moe/yx5jn2.jpg',
            'https://files.catbox.moe/g0apn7.jpg',
            'https://files.catbox.moe/wqz5ef.jpg',
            'https://files.catbox.moe/9sclw5.jpg',
            'https://files.catbox.moe/akrm5f.jpg',
            'https://files.catbox.moe/edqc3z.png',
            'https://files.catbox.moe/zqiezy.jpg',
            'https://files.catbox.moe/4b07sg.jpg',
            'https://files.catbox.moe/fajmhh.jpg',
            'https://files.catbox.moe/tzkoqy.jpg',
            'https://files.catbox.moe/8emnoa.jpg',
            'https://files.catbox.moe/y509g7.jpg',
            'https://files.catbox.moe/x0geql.jpg',
            'https://files.catbox.moe/2ox545.jpg',
            'https://files.catbox.moe/cp1qb1.jpg',
            'https://files.catbox.moe/t23ror.jpg',
            'https://files.catbox.moe/6i5pb1.jpg',
            'https://files.catbox.moe/ny0jew.jpg',
            'https://files.catbox.moe/71az9q.jpg',
            'https://files.catbox.moe/m9cnh2.jpg',
            'https://files.catbox.moe/a351n7.jpg',
            'https://files.catbox.moe/jw6uyo.jpg',
            'https://files.catbox.moe/m66rwd.jpg',
            'https://files.catbox.moe/xve0fr.jpg',
          ];

          // ç”Ÿæˆå›¾ç‰‡ç½‘æ ¼
          const grid = document.getElementById('card-display-grid');
          if (grid) {
            grid.innerHTML = '';
            cardImages.forEach((imageUrl, index) => {
              const item = document.createElement('div');
              item.className = 'card-display-item';
              item.innerHTML = `<img src="${imageUrl}" alt="å¡é¢ ${index + 1}" loading="lazy">`;
              item.addEventListener('click', () => this.showCardImageViewer(imageUrl));
              grid.appendChild(item);
            });
          }

          // æ¸²æŸ“äººç‰©è¡¨æƒ…åŒºåŸŸï¼ˆå¦‚æœæŒ‡å®šäº†é©¬å¨˜åå­—ï¼Œåªæ˜¾ç¤ºè¯¥é©¬å¨˜çš„è¡¨æƒ…ï¼‰
          this.renderUmaExpressions(selectedUmaName);

          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';

          // ğŸ”¥ å…¨å±æ¨¡å¼æ”¯æŒï¼šæ£€æŸ¥å¹¶ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          this.ensureModalInOverlay(modal);
        }

        // æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        showCardImageViewer(imageUrl) {
          // ç§»é™¤å·²å­˜åœ¨çš„æŸ¥çœ‹å™¨
          const existingViewer = document.querySelector('.card-image-viewer');
          if (existingViewer) {
            existingViewer.remove();
          }

          // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ˜¾ç¤º
          requestAnimationFrame(() => {
            // åˆ›å»ºæŸ¥çœ‹å™¨
            const viewer = document.createElement('div');
            viewer.className = 'card-image-viewer';

            // åˆ›å»ºå›¾ç‰‡å…ƒç´ ï¼ˆä¼˜åŒ–åŠ è½½ï¼‰
            const img = document.createElement('img');
            img.alt = 'å¡é¢å¤§å›¾';
            img.setAttribute('data-loading', 'true');

            // å›¾ç‰‡åŠ è½½å®Œæˆåçš„å¤„ç†
            img.onload = () => {
              requestAnimationFrame(() => {
                img.setAttribute('data-loaded', 'true');
                img.removeAttribute('data-loading');
              });
            };

            // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
            img.onerror = () => {
              img.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
              img.setAttribute('data-loaded', 'true');
              img.removeAttribute('data-loading');
            };

            // å¼€å§‹åŠ è½½å›¾ç‰‡
            img.src = imageUrl;

            // åˆ›å»ºå…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-viewer';
            closeBtn.textContent = 'Ã—';

            viewer.appendChild(closeBtn);
            viewer.appendChild(img);

            // å…³é—­æŒ‰é’®äº‹ä»¶
            closeBtn.addEventListener('click', e => {
              e.stopPropagation();
              // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–ç§»é™¤
              requestAnimationFrame(() => {
                viewer.remove();
              });
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            viewer.addEventListener('click', e => {
              if (e.target === viewer) {
                requestAnimationFrame(() => {
                  viewer.remove();
                });
              }
            });

            // ESCé”®å…³é—­
            const escHandler = e => {
              if (e.key === 'Escape') {
                requestAnimationFrame(() => {
                  viewer.remove();
                  document.removeEventListener('keydown', escHandler);
                });
              }
            };
            document.addEventListener('keydown', escHandler);

            // ğŸ”¥ å…¨å±æ¨¡å¼æ”¯æŒï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ åˆ°è¦†ç›–å±‚
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay) {
              overlay.appendChild(viewer);
            } else {
              document.body.appendChild(viewer);
            }

            // å¼ºåˆ¶é‡æ’ä»¥ç¡®ä¿ç¡¬ä»¶åŠ é€Ÿç”Ÿæ•ˆ
            viewer.offsetHeight;
          });
        }

        // ğŸ”¥ äººç‰©å†ç¨‹åŠŸèƒ½å·²åˆ é™¤

        // ğŸ”¥ å¤„ç†èŠå¤©è®°å½•æŸ¥çœ‹ - åœ¨chat-history-panelä¸­æ˜¾ç¤ºï¼ˆä»extra.teresen_chatåŠ è½½ï¼‰
        async handleChatHistory() {
          try {
            console.log('ğŸ’¬ åœ¨èŠå¤©å†å²é¢æ¿ä¸­æ˜¾ç¤ºèŠå¤©è®°å½•...');

            // ğŸ”¥ ä½¿ç”¨ç°æœ‰çš„chat-history-panelå’Œchat-history-content-list
            const chatHistoryPanel = document.getElementById('chat-history-panel');
            const contentList = document.getElementById('chat-history-content-list');

            if (!chatHistoryPanel || !contentList) {
              console.error('âŒ æ‰¾ä¸åˆ°èŠå¤©å†å²é¢æ¿');
              return;
            }

            // æ˜¾ç¤ºé¢æ¿
            chatHistoryPanel.style.display = 'block';

            // ğŸ”¥ ä»extra.teresen_chatåŠ è½½å®Œæ•´çš„èŠå¤©å†å²
            const chatHistory = await this.loadChatHistoryFromExtra();
            console.log('ğŸ“Š ä»extra.teresen_chatåŠ è½½äº†', chatHistory.length, 'æ¡æ¶ˆæ¯');

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML =
                '<div style="text-align: center; color: #8b4513; padding: 20px;">æš‚æ— èŠå¤©è®°å½•</div>';
              return;
            }

            // ğŸ”¥ æ ¼å¼åŒ–èŠå¤©å†å²è®°å½•ï¼ˆå¸¦ç¼–è¾‘åŠŸèƒ½ï¼‰
            const formattedHistory = chatHistory.map((msg, index) => {
              // æå–contentæ ‡ç­¾å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`, // ğŸ”¥ ä¿å­˜åŸå§‹æ¶ˆæ¯IDï¼Œç”¨äºç¼–è¾‘å’Œåˆ é™¤
                role: msg.role || 'assistant',
                timestamp: msg.timestamp || Date.now() - (chatHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : `æ¶ˆæ¯ #${index + 1}`,
                content: displayContent,
                message: msg.content || '', // ä¿å­˜åŸå§‹å®Œæ•´æ¶ˆæ¯ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰
                variableState: msg.variableState || msg.data || null,
                originalIndex: index, // ä¿å­˜åŸå§‹ç´¢å¼•ï¼Œæ–¹ä¾¿å®šä½
              };
            });

            const html = this.formatChatHistoryForStory(formattedHistory);

            // ğŸ”¥ åœ¨èŠå¤©å†å²é¢æ¿ä¸­æ˜¾ç¤º
            contentList.innerHTML = html;

            // ğŸ”¥ åº”ç”¨ä¿å­˜çš„å­—ä½“è®¾ç½®ï¼ˆä¸åŸå§‹æ•…äº‹å†…å®¹ä¸€è‡´ï¼‰
            const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
            const size = localStorage.getItem('teresen_font_size') || '1';

            // ğŸ”¥ åº”ç”¨å­—ä½“æ ·å¼åˆ°æ‰€æœ‰message-content
            const messageContents = contentList.querySelectorAll('.message-content');
            messageContents.forEach(el => {
              el.style.fontFamily = font;
              el.style.fontSize = size + 'em';
            });

            // ğŸ”¥ ä¿å­˜æ ¼å¼åŒ–åçš„å†å²è®°å½•ï¼Œç”¨äºç¼–è¾‘å’Œåˆ é™¤æ“ä½œ
            this.currentChatHistory = formattedHistory;

            // ğŸ”¥ ç»‘å®šç¼–è¾‘ã€åˆ é™¤å’Œå¤åˆ¶æŒ‰é’®äº‹ä»¶
            this.bindChatHistoryActions(contentList);

            // é»˜è®¤æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
            setTimeout(() => {
              chatHistoryPanel.scrollTo({ top: chatHistoryPanel.scrollHeight, behavior: 'smooth' });
            }, 100);
          } catch (error) {
            console.error('æ˜¾ç¤ºèŠå¤©è®°å½•å¤±è´¥:', error);
            const contentList = document.getElementById('chat-history-content-list');
            if (contentList) {
              contentList.innerHTML = `<div style="text-align: center; color: #dc3545; padding: 20px;">æ˜¾ç¤ºèŠå¤©è®°å½•å¤±è´¥: ${error.message}</div>`;
            }
          }
        }

        /**
         * ğŸ”¥ éšè—èŠå¤©å†å²é¢æ¿
         */
        async restoreStoryContent() {
          try {
            // ğŸ”¥ éšè—èŠå¤©å†å²é¢æ¿
            const chatHistoryPanel = document.getElementById('chat-history-panel');
            if (chatHistoryPanel) {
              chatHistoryPanel.style.display = 'none';
              console.log('âœ… å·²éšè—èŠå¤©å†å²é¢æ¿');
            }

            // æ¸…é™¤èŠå¤©å†å²å¼•ç”¨
            this.currentChatHistory = null;
          } catch (error) {
            console.error('âŒ éšè—èŠå¤©å†å²é¢æ¿å¤±è´¥:', error);
          }
        }

        // åˆ›å»ºèŠå¤©è®°å½•æŸ¥çœ‹å™¨
        createChatHistoryViewer(chatHistory) {
          // ç§»é™¤å·²å­˜åœ¨çš„æŸ¥çœ‹å™¨
          const existing = document.getElementById('chat-history-modal');
          if (existing) {
            existing.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'chat-history-modal';
          modal.innerHTML = `
            <div class="summary-modal-overlay" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
            ">
              <div class="summary-modal-content" style="
                background: linear-gradient(135deg, #f5f0e8, #ede4d3);
                border: 2px solid #d4af37;
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 80%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
              ">
                <div class="summary-modal-header" style="
                  padding: 20px;
                  border-bottom: 1px solid #d4af37;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  background: linear-gradient(135deg, #f0e6d2, #e8dcc6);
                ">
                  <h3 style="
                    color: #8b4513;
                    margin: 0;
                    font-size: 18px;
                    font-weight: bold;
                  ">ğŸ’¬ èŠå¤©è®°å½•æŸ¥çœ‹å™¨</h3>
                  <button class="chat-history-close-btn" style="
                    background: none;
                    border: none;
                    color: #8b4513;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 5px;
                    border-radius: 4px;
                    transition: background 0.2s;
                  ">&times;</button>
                </div>
                <div class="chat-controls" style="
                  padding: 15px 20px;
                  border-bottom: 1px solid rgba(212, 175, 55, 0.3);
                  display: flex;
                  gap: 10px;
                  align-items: center;
                  flex-wrap: wrap;
                  background: rgba(212, 175, 55, 0.1);
                ">
                  <input type="text" id="chat-search-input" placeholder="ğŸ” æœç´¢èŠå¤©å†…å®¹..." style="
                    flex: 1;
                    min-width: 200px;
                    padding: 8px 12px;
                    background: rgba(255,255,255,0.8);
                    border: 1px solid #d4af37;
                    color: #8b4513;
                    border-radius: 4px;
                    font-size: 0.9em;
                  ">
                  <button id="scroll-to-top-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">â¬†ï¸ é¡¶éƒ¨</button>
                  <button id="scroll-to-bottom-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">â¬‡ï¸ åº•éƒ¨</button>
                  <button id="export-chat-btn" style="
                    padding: 8px 15px;
                    background: linear-gradient(135deg, #d4af37, #e6c347);
                    border: 1px solid #8b4513;
                    color: #8b4513;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    font-weight: bold;
                  ">ğŸ“¥ å¯¼å‡º</button>
                </div>
                <div class="chat-history-body" id="chat-history-content" style="
                  padding: 20px;
                  flex-grow: 1;
                  overflow-y: auto;
                  background: rgba(255,255,255,0.3);
                  color: #8b4513;
                ">
                  ${this.formatChatHistory(chatHistory)}
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          this.ensureModalInOverlay(modal);

          // ç»‘å®šæ‰€æœ‰äº‹ä»¶
          const closeBtn = modal.querySelector('.chat-history-close-btn');
          const overlay = modal.querySelector('.summary-modal-overlay');
          const searchInput = modal.querySelector('#chat-search-input');
          const scrollTopBtn = modal.querySelector('#scroll-to-top-btn');
          const scrollBottomBtn = modal.querySelector('#scroll-to-bottom-btn');
          const exportBtn = modal.querySelector('#export-chat-btn');
          const contentArea = modal.querySelector('#chat-history-content');

          const closeModal = () => modal.remove();

          // å…³é—­äº‹ä»¶
          closeBtn.addEventListener('click', closeModal);
          overlay.addEventListener('click', e => {
            if (e.target === overlay) closeModal();
          });

          // æœç´¢åŠŸèƒ½
          let searchTimeout;
          searchInput.addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              this.searchChatHistory(e.target.value, contentArea, chatHistory);
            }, 300);
          });

          // æ»šåŠ¨æ§åˆ¶
          scrollTopBtn.addEventListener('click', () => {
            contentArea.scrollTo({ top: 0, behavior: 'smooth' });
          });

          scrollBottomBtn.addEventListener('click', () => {
            contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
          });

          // å¯¼å‡ºåŠŸèƒ½
          exportBtn.addEventListener('click', async () => {
            await this.exportChatHistory(chatHistory);
          });

          // ğŸ”¥ ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆå‚è€ƒåˆ†æ2.jsï¼‰
          contentArea.addEventListener('click', async e => {
            const btn = e.target.closest('.msg-btn');
            if (!btn) return;

            const messageId = btn.getAttribute('data-message-id');
            const messageItem = contentArea.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageItem) return;

            if (btn.classList.contains('edit-btn')) {
              // ç¼–è¾‘æ¶ˆæ¯
              await this.handleEditMessage(messageId, messageItem, chatHistory);
            } else if (btn.classList.contains('delete-btn')) {
              // åˆ é™¤æ¶ˆæ¯
              await this.handleDeleteMessage(messageId, chatHistory, modal);
            } else if (btn.classList.contains('save-btn')) {
              // ä¿å­˜ç¼–è¾‘
              const textarea = messageItem.querySelector('.edit-textarea');
              if (textarea) {
                await this.updateMessageInHistory(messageId, textarea.value, chatHistory, modal);
              }
            } else if (btn.classList.contains('cancel-btn')) {
              // å–æ¶ˆç¼–è¾‘
              await this.refreshChatHistoryViewer(modal, chatHistory);
            }
          });

          // æŒ‰é’®æ‚¬åœæ•ˆæœ
          [scrollTopBtn, scrollBottomBtn, exportBtn].forEach(btn => {
            btn.addEventListener('mouseenter', () => {
              btn.style.background = 'rgba(139, 69, 19, 0.4)';
              btn.style.transform = 'translateY(-1px)';
            });
            btn.addEventListener('mouseleave', () => {
              btn.style.background = 'rgba(139, 69, 19, 0.2)';
              btn.style.transform = 'translateY(0)';
            });
          });

          // é»˜è®¤æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
          setTimeout(() => {
            contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
          }, 100);
        }

        /**
         * ğŸ”¥ æ ¼å¼åŒ–èŠå¤©å†å²ç”¨äºåœ¨æ•…äº‹å†…å®¹åŒºåŸŸæ˜¾ç¤ºï¼ˆç®€æ´æ•…äº‹é£æ ¼ï¼‰
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         * @returns {string} HTMLå­—ç¬¦ä¸²
         */
        formatChatHistoryForStory(chatHistory) {
          if (!chatHistory || chatHistory.length === 0) {
            return '<p class="story-text" style="text-align: center; color: #8b4513; padding: 20px;">æš‚æ— èŠå¤©è®°å½•</p>';
          }

          console.log(`ğŸ“œ æ­£åœ¨æ ¼å¼åŒ– ${chatHistory.length} æ¡èŠå¤©è®°å½•ç”¨äºæ•…äº‹å†…å®¹åŒºåŸŸæ˜¾ç¤º`);

          let html = '';

          // æŒ‰æ—¶é—´æ’åºç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºé¡ºåº
          const sortedMessages = [...chatHistory].sort((a, b) => {
            const timeA = new Date(a.timestamp || a.send_date || Date.now()).getTime();
            const timeB = new Date(b.timestamp || b.send_date || Date.now()).getTime();
            return timeA - timeB;
          });

          let messageNumber = 0; // ğŸ”¥ æ¶ˆæ¯åºå·è®¡æ•°å™¨
          sortedMessages.forEach((msg, index) => {
            // è·å–å†…å®¹ä¿¡æ¯
            let content = msg.content || msg.message || '';

            // è·³è¿‡ç©ºå†…å®¹çš„æ¶ˆæ¯
            if (!content.trim()) {
              return;
            }

            messageNumber++; // åªå¯¹æœ‰æ•ˆæ¶ˆæ¯è®¡æ•°

            // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œæå–contentæ ‡ç­¾å†…å®¹
            if (msg.role === 'assistant' || msg.role === 'ai') {
              const contentMatch = content.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                content = contentMatch[1].trim();
              }
            }

            // ğŸ”¥ ç”Ÿæˆæ¶ˆæ¯å”¯ä¸€IDï¼ˆç”¨äºç¼–è¾‘å’Œåˆ é™¤ï¼‰
            const messageId = msg.id || `msg_${index}_${Date.now()}`;

            // ğŸ”¥ ç®€æ´çš„æ•…äº‹æ­£æ–‡é£æ ¼æ˜¾ç¤ºï¼šæŒ‰ç…§é¡ºåºæ˜¾ç¤ºï¼Œç”¨æˆ·è¾“å…¥ â†’ AIå›å¤ â†’ ç”¨æˆ·è¾“å…¥ â†’ AIå›å¤...
            // ğŸ”¥ è½¬ä¹‰contentç”¨äºdata-contentå±æ€§ï¼ˆé¿å…HTMLç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
            const escapedContent = this.escapeHtml(content).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            html += `
              <div class="chat-message-item" data-message-id="${messageId}" style="
                margin-bottom: 15px;
                position: relative;
                padding-bottom: 10px;
                border-bottom: 1px solid rgba(139, 105, 20, 0.1);
              ">
                <div style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 6px;
                ">
                  <div style="
                    color: rgba(139, 105, 20, 0.6);
                    font-size: 0.8em;
                    font-weight: 500;
                  ">ç¬¬ ${messageNumber} æ¡æ¶ˆæ¯</div>
                  <div class="message-actions" style="
                    display: flex;
                    gap: 6px;
                    opacity: 0;
                    transition: opacity 0.2s;
                  ">
                    <span class="msg-icon copy-btn" title="å¤åˆ¶" data-message-id="${messageId}" data-content="${escapedContent}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(139, 105, 20, 0.9)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">ğŸ“‹</span>
                    <span class="msg-icon edit-btn" title="ç¼–è¾‘" data-message-id="${messageId}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(139, 105, 20, 0.9)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">âœï¸</span>
                    <span class="msg-icon delete-btn" title="åˆ é™¤" data-message-id="${messageId}" style="
                      color: rgba(139, 105, 20, 0.6);
                      cursor: pointer;
                      font-size: 1em;
                      transition: color 0.2s;
                      user-select: none;
                    " onmouseover="this.style.color='rgba(220, 53, 69, 0.8)'" onmouseout="this.style.color='rgba(139, 105, 20, 0.6)'">ğŸ—‘ï¸</span>
                  </div>
                </div>
                <div class="message-content" style="
                  color: #2d1810;
                  line-height: 1.6;
                  white-space: pre-wrap;
                  word-wrap: break-word;
                ">${this.escapeHtml(content)}</div>
              </div>
            `;
          });

          // æ·»åŠ CSSæ ·å¼ï¼Œä½¿æŒ‰é’®åœ¨é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤º
          html += `
            <style>
              .chat-message-item:hover .message-actions {
                opacity: 1 !important;
              }
            </style>
          `;

          console.log(`âœ… æˆåŠŸæ ¼å¼åŒ–èŠå¤©è®°å½•`);

          return html || '<div style="text-align: center; color: #8b4513; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©è®°å½•</div>';
        }

        // æ ¼å¼åŒ–èŠå¤©å†å² - æ”¹è¿›ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰å±‚çº§æ˜¾ç¤ºï¼ˆç”¨äºå¼¹çª—ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
        formatChatHistory(chatHistory) {
          if (!chatHistory || chatHistory.length === 0) {
            return '<div style="color: #8b4513; text-align: center; padding: 20px; font-weight: bold;">æš‚æ— èŠå¤©è®°å½•</div>';
          }

          // ğŸ¯ ä¸å†é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œæ˜¾ç¤ºæ‰€æœ‰è®°å½•
          console.log(`ğŸ“œ æ­£åœ¨æ ¼å¼åŒ– ${chatHistory.length} æ¡èŠå¤©è®°å½•`);

          let html = '';
          let displayCount = 0;

          // æŒ‰æ—¶é—´æ’åºç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºé¡ºåº
          const sortedMessages = [...chatHistory].sort((a, b) => {
            const timeA = new Date(a.timestamp || a.send_date || Date.now()).getTime();
            const timeB = new Date(b.timestamp || b.send_date || Date.now()).getTime();
            return timeA - timeB;
          });

          sortedMessages.forEach((msg, index) => {
            // è·å–æ—¶é—´ä¿¡æ¯
            const time =
              msg.send_date ||
              (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '') ||
              new Date().toLocaleString('zh-CN');

            // è·å–å†…å®¹ä¿¡æ¯
            const content = msg.content || msg.mes || msg.message || '';

            // è·³è¿‡ç©ºå†…å®¹çš„æ¶ˆæ¯
            if (!content.trim()) {
              console.log(`â­ï¸ è·³è¿‡ç¬¬${index + 1}æ¡æ¶ˆæ¯: å†…å®¹ä¸ºç©º`);
              return;
            }

            // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
            const isUser = msg.is_user || msg.type === 'user';
            const isAI = msg.type === 'ai' || msg.type === 'assistant' || (!isUser && content);

            displayCount++;

            // ğŸ”¥ ç”Ÿæˆæ¶ˆæ¯å”¯ä¸€IDï¼ˆç”¨äºç¼–è¾‘å’Œåˆ é™¤ï¼‰
            const messageId = msg.id || `msg_${index}_${Date.now()}`;

            if (isUser) {
              html += `
                <div class="chat-message-item" data-message-id="${messageId}" style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(100, 149, 237, 0.1);
                  border-left: 4px solid #6495ED;
                  border-radius: 4px;
                  animation: fadeIn 0.3s ease-in;
                  position: relative;
                ">
                  <div style="color: #6495ED; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ® ç©å®¶</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85em; opacity: 0.8;">${time}</span>
                      <div class="message-actions" style="display: flex; gap: 4px;">
                        <button class="msg-btn edit-btn" title="ç¼–è¾‘" data-message-id="${messageId}" style="
                          background: rgba(100, 149, 237, 0.2);
                          border: none;
                          color: #6495ED;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(100, 149, 237, 0.4)'" onmouseout="this.style.background='rgba(100, 149, 237, 0.2)'">âœï¸</button>
                        <button class="msg-btn delete-btn" title="åˆ é™¤" data-message-id="${messageId}" style="
                          background: rgba(220, 53, 69, 0.2);
                          border: none;
                          color: #dc3545;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">ğŸ—‘ï¸</button>
                  </div>
                    </div>
                  </div>
                  <div class="message-content" style="color: #2d1810; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; font-weight: 500;">
                    ${this.escapeHtml(content)}
                  </div>
                </div>
              `;
              displayCount++;
            } else if (isAI) {
              html += `
                <div class="chat-message-item" data-message-id="${messageId}" style="
                  margin-bottom: 15px;
                  padding: 12px;
                  background: rgba(255, 165, 0, 0.1);
                  border-left: 4px solid #FFA500;
                  border-radius: 4px;
                  animation: fadeIn 0.3s ease-in;
                  position: relative;
                ">
                  <div style="color: #FFA500; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ¤– AIåŠ©æ‰‹</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85em; opacity: 0.8;">${time}</span>
                      <div class="message-actions" style="display: flex; gap: 4px;">
                        <button class="msg-btn edit-btn" title="ç¼–è¾‘" data-message-id="${messageId}" style="
                          background: rgba(255, 165, 0, 0.2);
                          border: none;
                          color: #FF8C00;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255, 165, 0, 0.4)'" onmouseout="this.style.background='rgba(255, 165, 0, 0.2)'">âœï¸</button>
                        <button class="msg-btn delete-btn" title="åˆ é™¤" data-message-id="${messageId}" style="
                          background: rgba(220, 53, 69, 0.2);
                          border: none;
                          color: #dc3545;
                          padding: 4px 8px;
                          border-radius: 3px;
                          cursor: pointer;
                          font-size: 0.9em;
                          transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">ğŸ—‘ï¸</button>
                  </div>
                    </div>
                  </div>
                  <div class="message-content" style="color: #2d1810; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; font-weight: 500;">
                    ${this.escapeHtml(content)}
                  </div>
                </div>
              `;
              displayCount++;
            }
          });

          console.log(`âœ… æˆåŠŸæ ¼å¼åŒ– ${displayCount} æ¡èŠå¤©è®°å½•`);

          if (html) {
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            html =
              `
              <div style="
                text-align: center; 
                color: #8b4513; 
                margin-bottom: 20px; 
                padding: 10px;
                background: rgba(212, 175, 55, 0.15);
                border-radius: 4px;
                font-weight: bold;
              ">
                ğŸ“Š å…±æ˜¾ç¤º ${displayCount} æ¡èŠå¤©è®°å½•
              </div>
            ` + html;

            return html;
          } else {
            return '<div style="color: #8b4513; text-align: center; padding: 20px; font-weight: bold;">æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©è®°å½•</div>';
          }
        }

        // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
        escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        /**
         * ğŸ”¥ ç¼–è¾‘æ¶ˆæ¯ï¼ˆå‚è€ƒåˆ†æ2.jsçš„handleEditï¼‰
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {HTMLElement} messageItem - æ¶ˆæ¯DOMå…ƒç´ 
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         */
        async handleEditMessage(messageId, messageItem, chatHistory) {
          try {
            // æŸ¥æ‰¾æ¶ˆæ¯
            const msg = chatHistory.find(m => m.id === messageId);
            if (!msg) {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°æ¶ˆæ¯:', messageId);
              return;
            }

            // è·å–åŸå§‹æ¶ˆæ¯å†…å®¹ï¼ˆåŒ…å«æ ‡ç­¾ï¼‰
            const originalContent = msg.message || msg.content || '';
            const messageContent = messageItem.querySelector('.message-content');
            const messageActions = messageItem.querySelector('.message-actions');

            if (!messageContent || !messageActions) return;

            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
            messageContent.innerHTML = `<textarea class="edit-textarea" style="
              width: 100%;
              min-height: 100px;
              padding: 8px;
              border: 1px solid rgba(139, 105, 20, 0.3);
              border-radius: 4px;
              background: rgba(255, 255, 255, 0.9);
              color: #2d1810;
              font-size: 0.9em;
              line-height: 1.5;
              resize: vertical;
              font-family: inherit;
            ">${this.escapeHtml(originalContent)}</textarea>`;

            messageActions.innerHTML = `
              <button class="msg-btn save-btn" title="ä¿å­˜" data-message-id="${messageId}" style="
                background: rgba(40, 167, 69, 0.2);
                border: none;
                color: #28a745;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(40, 167, 69, 0.4)'" onmouseout="this.style.background='rgba(40, 167, 69, 0.2)'">âœ”ï¸</button>
              <button class="msg-btn cancel-btn" title="å–æ¶ˆ" data-message-id="${messageId}" style="
                background: rgba(220, 53, 69, 0.2);
                border: none;
                color: #dc3545;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(220, 53, 69, 0.4)'" onmouseout="this.style.background='rgba(220, 53, 69, 0.2)'">âŒ</button>
            `;

            messageItem.classList.add('is-editing');

            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            const textarea = messageContent.querySelector('.edit-textarea');
            if (textarea) {
              this._autoResizeTextarea(textarea);
              textarea.focus();
              textarea.addEventListener('input', () => this._autoResizeTextarea(textarea));
            }
          } catch (error) {
            console.error('âŒ ç¼–è¾‘æ¶ˆæ¯å¤±è´¥:', error);
          }
        }

        /**
         * ğŸ”¥ è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦ï¼ˆå‚è€ƒåˆ†æ2.jsçš„_autoResizeTextareaï¼‰
         * @param {HTMLTextAreaElement} textarea - textareaå…ƒç´ 
         */
        _autoResizeTextarea(textarea) {
          textarea.style.height = 'auto';
          textarea.style.height = `${textarea.scrollHeight}px`;
        }

        /**
         * ğŸ”¥ ç»‘å®šèŠå¤©è®°å½•çš„ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆç”¨äºæ•…äº‹å†…å®¹åŒºåŸŸï¼‰
         * @param {HTMLElement} container - å®¹å™¨å…ƒç´ ï¼ˆstory-contentï¼‰
         */
        bindChatHistoryActions(container) {
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œé€šè¿‡dataå±æ€§æ ‡è¯†æ¥é¿å…é‡å¤ç»‘å®š
          // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç›‘å¬å™¨ï¼ˆé€šè¿‡å‘½åå‡½æ•°æ¥å®ç°ï¼‰
          if (this.chatHistoryClickHandler) {
            container.removeEventListener('click', this.chatHistoryClickHandler);
          }

          // åˆ›å»ºæ–°çš„ç›‘å¬å™¨å‡½æ•°
          this.chatHistoryClickHandler = async e => {
            // ğŸ”¥ æ”¯æŒå›¾æ ‡ç‚¹å‡»ï¼ˆmsg-iconï¼‰å’ŒæŒ‰é’®ç‚¹å‡»ï¼ˆmsg-btnï¼‰
            const icon = e.target.closest('.msg-icon');
            const btn = e.target.closest('.msg-btn');
            const target = icon || btn;
            if (!target) return;

            const messageId = target.getAttribute('data-message-id');
            const messageItem = container.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageItem || !this.currentChatHistory) return;

            // ğŸ”¥ å¤åˆ¶åŠŸèƒ½
            if (target.classList.contains('copy-btn')) {
              const content =
                target.getAttribute('data-content') || messageItem.querySelector('.message-content')?.textContent || '';
              try {
                await navigator.clipboard.writeText(content);
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const originalText = target.textContent;
                target.textContent = 'âœ“';
                target.style.color = '#28a745';
                setTimeout(() => {
                  target.textContent = originalText;
                  target.style.color = '';
                }, 1000);
                console.log('âœ… å·²å¤åˆ¶æ¶ˆæ¯å†…å®¹åˆ°å‰ªè´´æ¿');
              } catch (err) {
                console.error('âŒ å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = content;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const originalText = target.textContent;
                target.textContent = 'âœ“';
                target.style.color = '#28a745';
                setTimeout(() => {
                  target.textContent = originalText;
                  target.style.color = '';
                }, 1000);
              }
              return;
            }

            if (target.classList.contains('edit-btn') || btn?.classList.contains('edit-btn')) {
              // ç¼–è¾‘æ¶ˆæ¯
              await this.handleEditMessageInStory(messageId, messageItem, this.currentChatHistory);
            } else if (target.classList.contains('delete-btn') || btn?.classList.contains('delete-btn')) {
              // åˆ é™¤æ¶ˆæ¯
              await this.handleDeleteMessageInStory(messageId, this.currentChatHistory);
            } else if (btn?.classList.contains('save-btn')) {
              // ä¿å­˜ç¼–è¾‘
              const textarea = messageItem.querySelector('.edit-textarea');
              if (textarea) {
                await this.updateMessageInStory(messageId, textarea.value, this.currentChatHistory);
              }
            } else if (btn?.classList.contains('cancel-btn')) {
              // å–æ¶ˆç¼–è¾‘
              await this.refreshChatHistoryInStory(this.currentChatHistory);
            }
          };

          // ç»‘å®šäº‹ä»¶
          container.addEventListener('click', this.chatHistoryClickHandler);
        }

        /**
         * ğŸ”¥ åœ¨æ•…äº‹å†…å®¹åŒºåŸŸç¼–è¾‘æ¶ˆæ¯
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {HTMLElement} messageItem - æ¶ˆæ¯DOMå…ƒç´ 
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         */
        async handleEditMessageInStory(messageId, messageItem, chatHistory) {
          // å¤ç”¨ç°æœ‰çš„handleEditMessageé€»è¾‘
          await this.handleEditMessage(messageId, messageItem, chatHistory);
        }

        /**
         * ğŸ”¥ åœ¨æ•…äº‹å†…å®¹åŒºåŸŸåˆ é™¤æ¶ˆæ¯
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         */
        async handleDeleteMessageInStory(messageId, chatHistory) {
          try {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
              return;
            }

            // ä»extra.teresen_chatåŠ è½½å®Œæ•´å†å²
            const fullHistory = await this.loadChatHistoryFromExtra();

            // åˆ é™¤æŒ‡å®šæ¶ˆæ¯
            const updatedHistory = fullHistory.filter(msg => msg.id !== messageId);

            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„handleDeleteï¼šåˆ é™¤åè°ƒç”¨_syncStateWithHistoryåŒæ­¥å˜é‡çŠ¶æ€
            await this._syncStateWithHistory(updatedHistory);

            // ğŸ”¥ é‡æ–°åŠ è½½å¹¶åˆ·æ–°æ•…äº‹å†…å®¹åŒºåŸŸçš„èŠå¤©è®°å½•æ˜¾ç¤º
            await this.refreshChatHistoryInStory(updatedHistory);

            // ğŸ”¥ æ›´æ–°UIä»¥åæ˜ å˜é‡çŠ¶æ€çš„å˜åŒ–
            const lastMessage = updatedHistory[updatedHistory.length - 1];
            if (lastMessage && lastMessage.variableState) {
              this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
              if (lastMessage.variableState.stat_data) {
                this.renderUI(lastMessage.variableState.stat_data);
              }
            }
          } catch (error) {
            console.error('âŒ åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
          }
        }

        /**
         * ğŸ”¥ åœ¨æ•…äº‹å†…å®¹åŒºåŸŸæ›´æ–°æ¶ˆæ¯
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {string} newContent - æ–°å†…å®¹
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         */
        async updateMessageInStory(messageId, newContent, chatHistory) {
          try {
            // ä»extra.teresen_chatåŠ è½½å®Œæ•´å†å²
            const fullHistory = await this.loadChatHistoryFromExtra();

            // æ‰¾åˆ°è¦æ›´æ–°çš„æ¶ˆæ¯
            const msgIndex = fullHistory.findIndex(msg => msg.id === messageId);
            if (msgIndex === -1) {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°è¦æ›´æ–°çš„æ¶ˆæ¯:', messageId);
              return;
            }

            // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆå¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œéœ€è¦åŒ…è£…åœ¨contentæ ‡ç­¾ä¸­ï¼‰
            const msg = fullHistory[msgIndex];
            if (msg.role === 'assistant' || msg.role === 'ai') {
              // AIæ¶ˆæ¯éœ€è¦åŒ…è£…åœ¨contentæ ‡ç­¾ä¸­
              msg.content = `<content>\n${newContent}\n</content>`;
            } else {
              // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ›´æ–°
              msg.content = newContent;
            }

            // ä¿å­˜æ›´æ–°åçš„å†å²
            await this.saveChatHistoryToExtra(fullHistory);

            // ğŸ”¥ å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œéœ€è¦åŒæ­¥å˜é‡çŠ¶æ€
            if (msgIndex === fullHistory.length - 1) {
              await this._syncStateWithHistory(fullHistory);
            }

            // åˆ·æ–°æ˜¾ç¤º
            await this.refreshChatHistoryInStory(fullHistory);
          } catch (error) {
            console.error('âŒ æ›´æ–°æ¶ˆæ¯å¤±è´¥:', error);
          }
        }

        /**
         * ğŸ”¥ åˆ·æ–°èŠå¤©å†å²é¢æ¿çš„æ˜¾ç¤º
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä»extra.teresen_chatåŠ è½½ï¼‰
         */
        async refreshChatHistoryInStory(chatHistory = null) {
          try {
            const contentList = document.getElementById('chat-history-content-list');
            if (!contentList) {
              // å¦‚æœé¢æ¿ä¸å­˜åœ¨ï¼Œé‡æ–°è°ƒç”¨handleChatHistory
              await this.handleChatHistory();
              return;
            }

            // å¦‚æœæ²¡æœ‰æä¾›å†å²è®°å½•ï¼Œä»extra.teresen_chatåŠ è½½
            if (!chatHistory) {
              chatHistory = await this.loadChatHistoryFromExtra();
            }

            if (!chatHistory || chatHistory.length === 0) {
              contentList.innerHTML =
                '<div style="text-align: center; color: #8b4513; padding: 20px;">æš‚æ— èŠå¤©è®°å½•</div>';
              return;
            }

            // æ ¼å¼åŒ–å†å²è®°å½•
            const formattedHistory = chatHistory.map((msg, index) => {
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`,
                role: msg.role || 'assistant',
                timestamp: msg.timestamp || Date.now() - (chatHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : `æ¶ˆæ¯ #${index + 1}`,
                content: displayContent,
                message: msg.content || '',
                variableState: msg.variableState || msg.data || null,
                originalIndex: index,
              };
            });

            // æ›´æ–°æ˜¾ç¤º
            const html = this.formatChatHistoryForStory(formattedHistory);
            contentList.innerHTML = html;

            // ğŸ”¥ åº”ç”¨å­—ä½“æ ·å¼
            const font = localStorage.getItem('teresen_font') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
            const size = localStorage.getItem('teresen_font_size') || '1';

            const messageContents = contentList.querySelectorAll('.message-content');
            messageContents.forEach(el => {
              el.style.fontFamily = font;
              el.style.fontSize = size + 'em';
            });

            // æ›´æ–°ä¿å­˜çš„å†å²è®°å½•
            this.currentChatHistory = formattedHistory;

            // é‡æ–°ç»‘å®šäº‹ä»¶
            this.bindChatHistoryActions(contentList);
          } catch (error) {
            console.error('âŒ åˆ·æ–°èŠå¤©è®°å½•æ˜¾ç¤ºå¤±è´¥:', error);
          }
        }

        /**
         * ğŸ”¥ åˆ é™¤æ¶ˆæ¯ï¼ˆå‚è€ƒåˆ†æ2.jsçš„handleDeleteï¼‰
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         * @param {HTMLElement} modal - æ¨¡æ€æ¡†å…ƒç´ 
         */
        async handleDeleteMessage(messageId, chatHistory, modal) {
          try {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
              return;
            }

            // ä»extra.teresen_chatåŠ è½½å®Œæ•´å†å²
            const fullHistory = await this.loadChatHistoryFromExtra();

            // åˆ é™¤æŒ‡å®šæ¶ˆæ¯
            const updatedHistory = fullHistory.filter(msg => msg.id !== messageId);

            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„handleDeleteï¼šåˆ é™¤åè°ƒç”¨_syncStateWithHistoryåŒæ­¥å˜é‡çŠ¶æ€
            // _syncStateWithHistoryä¼šä»updatedHistoryçš„æœ€åä¸€æ¡æ¶ˆæ¯è·å–variableStateå¹¶æ›´æ–°å˜é‡
            await this._syncStateWithHistory(updatedHistory);

            // é‡æ–°åŠ è½½å¹¶åˆ·æ–°æŸ¥çœ‹å™¨
            const newHistory = await this.loadChatHistoryFromExtra();
            if (newHistory && newHistory.length > 0) {
              // è½¬æ¢æ ¼å¼
              const formattedHistory = newHistory.map((msg, index) => {
                let displayContent = msg.content || '';
                const contentMatch = displayContent.match(/<content>(.*?)<\/content>/s);
                if (contentMatch) {
                  displayContent = contentMatch[1].trim();
                }

                return {
                  id: msg.id || `msg_${index}_${Date.now()}`,
                  type: msg.role === 'user' ? 'user' : 'ai',
                  timestamp: msg.timestamp || Date.now() - (newHistory.length - index) * 1000,
                  send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : `æ¶ˆæ¯ #${index + 1}`,
                  content: displayContent,
                  message: msg.content || '',
                  data: msg.variableState || msg.data || null,
                  originalIndex: index,
                };
              });

              // åˆ·æ–°æŸ¥çœ‹å™¨
              const contentArea = modal.querySelector('#chat-history-content');
              if (contentArea) {
                contentArea.innerHTML = this.formatChatHistory(formattedHistory);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                  contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
                }, 100);
              }

              // ğŸ”¥ æ›´æ–°UIä»¥åæ˜ å˜é‡çŠ¶æ€çš„å˜åŒ–
              const lastMessage = newHistory[newHistory.length - 1];
              if (lastMessage && lastMessage.variableState) {
                this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                if (lastMessage.variableState.stat_data) {
                  this.renderUI(lastMessage.variableState.stat_data);
                }
              }
            } else {
              // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œå…³é—­æŸ¥çœ‹å™¨
              modal.remove();
              await this.showCustomAlert('å·²åˆ é™¤æ‰€æœ‰æ¶ˆæ¯');
            }

            console.log('âœ… æ¶ˆæ¯å·²åˆ é™¤ï¼Œå˜é‡çŠ¶æ€å·²åŒæ­¥');
          } catch (error) {
            console.error('âŒ åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
            await this.showCustomAlert('åˆ é™¤æ¶ˆæ¯å¤±è´¥: ' + error.message);
          }
        }

        /**
         * ğŸ”¥ æ›´æ–°æ¶ˆæ¯ï¼ˆå‚è€ƒåˆ†æ2.jsçš„updateMessageï¼‰
         * @param {string} messageId - æ¶ˆæ¯ID
         * @param {string} newContent - æ–°å†…å®¹
         * @param {Array} chatHistory - èŠå¤©å†å²æ•°ç»„
         * @param {HTMLElement} modal - æ¨¡æ€æ¡†å…ƒç´ 
         */
        async updateMessageInHistory(messageId, newContent, chatHistory, modal) {
          try {
            // ä»extra.teresen_chatåŠ è½½å®Œæ•´å†å²
            const fullHistory = await this.loadChatHistoryFromExtra();

            // æ‰¾åˆ°è¦æ›´æ–°çš„æ¶ˆæ¯
            const messageIndex = fullHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°è¦æ›´æ–°çš„æ¶ˆæ¯:', messageId);
              return;
            }

            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            fullHistory[messageIndex].content = newContent.trim();

            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„updateMessageï¼šç¼–è¾‘æ¶ˆæ¯æ—¶ä¼ nullï¼Œä¸æ›´æ–°å˜é‡çŠ¶æ€
            // ä½†å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåº”è¯¥è°ƒç”¨_syncStateWithHistoryæ¥åŒæ­¥å˜é‡çŠ¶æ€
            // è¿™é‡Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯
            if (messageIndex === fullHistory.length - 1) {
              // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè°ƒç”¨_syncStateWithHistoryåŒæ­¥å˜é‡çŠ¶æ€
              await this._syncStateWithHistory(fullHistory);
            } else {
              // å¦‚æœä¸æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåªä¿å­˜å†å²ï¼Œä¸æ›´æ–°å˜é‡
              await this.saveChatHistoryToExtra(fullHistory, null);
            }

            // åˆ·æ–°æŸ¥çœ‹å™¨
            await this.refreshChatHistoryViewer(modal, chatHistory);

            // ğŸ”¥ å¦‚æœæ›´æ–°çš„æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ›´æ–°UIä»¥åæ˜ å˜é‡çŠ¶æ€çš„å˜åŒ–
            if (messageIndex === fullHistory.length - 1) {
              const lastMessage = fullHistory[fullHistory.length - 1];
              if (lastMessage && lastMessage.variableState) {
                this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                if (lastMessage.variableState.stat_data) {
                  this.renderUI(lastMessage.variableState.stat_data);
                }
              }
            }

            console.log('âœ… æ¶ˆæ¯å·²æ›´æ–°');
          } catch (error) {
            console.error('âŒ æ›´æ–°æ¶ˆæ¯å¤±è´¥:', error);
            await this.showCustomAlert('æ›´æ–°æ¶ˆæ¯å¤±è´¥: ' + error.message);
          }
        }

        /**
         * ğŸ”¥ åˆ·æ–°èŠå¤©è®°å½•æŸ¥çœ‹å™¨
         * @param {HTMLElement} modal - æ¨¡æ€æ¡†å…ƒç´ 
         * @param {Array} originalChatHistory - åŸå§‹èŠå¤©å†å²æ•°ç»„ï¼ˆç”¨äºä¿ç•™æ ¼å¼ï¼‰
         */
        async refreshChatHistoryViewer(modal, originalChatHistory) {
          try {
            // ä»extra.teresen_chaté‡æ–°åŠ è½½
            const newHistory = await this.loadChatHistoryFromExtra();
            if (!newHistory || newHistory.length === 0) {
              modal.remove();
              await this.showCustomAlert('æ²¡æœ‰èŠå¤©è®°å½•äº†');
              return;
            }

            // è½¬æ¢æ ¼å¼
            const formattedHistory = newHistory.map((msg, index) => {
              let displayContent = msg.content || '';
              const contentMatch = displayContent.match(/<content>(.*?)<\/content>/s);
              if (contentMatch) {
                displayContent = contentMatch[1].trim();
              }

              return {
                id: msg.id || `msg_${index}_${Date.now()}`,
                type: msg.role === 'user' ? 'user' : 'ai',
                timestamp: msg.timestamp || Date.now() - (newHistory.length - index) * 1000,
                send_date: msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : `æ¶ˆæ¯ #${index + 1}`,
                content: displayContent,
                message: msg.content || '',
                data: msg.variableState || msg.data || null,
                originalIndex: index,
              };
            });

            // æ›´æ–°å†…å®¹
            const contentArea = modal.querySelector('#chat-history-content');
            if (contentArea) {
              contentArea.innerHTML = this.formatChatHistory(formattedHistory);

              // æ»šåŠ¨åˆ°ä¹‹å‰çš„ä½ç½®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
              setTimeout(() => {
                contentArea.scrollTo({ top: contentArea.scrollHeight, behavior: 'smooth' });
              }, 100);
            }
          } catch (error) {
            console.error('âŒ åˆ·æ–°æŸ¥çœ‹å™¨å¤±è´¥:', error);
          }
        }

        // æœç´¢èŠå¤©å†å²åŠŸèƒ½
        searchChatHistory(searchTerm, contentArea, chatHistory) {
          if (!searchTerm.trim()) {
            // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è®°å½•
            contentArea.innerHTML = this.formatChatHistory(chatHistory);
            return;
          }

          // è¿‡æ»¤åŒ…å«æœç´¢è¯çš„è®°å½•
          const filteredHistory = chatHistory.filter(msg => {
            const content = (msg.content || msg.mes || msg.message || '').toLowerCase();
            return content.includes(searchTerm.toLowerCase());
          });

          if (filteredHistory.length === 0) {
            contentArea.innerHTML = `
              <div style="color: #b0b0b0; text-align: center; padding: 20px;">
                <p>ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${searchTerm}" çš„èŠå¤©è®°å½•</p>
                <p style="font-size: 0.9em; opacity: 0.7;">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯è¿›è¡Œæœç´¢</p>
              </div>
            `;
          } else {
            contentArea.innerHTML =
              `
              <div style="
                text-align: center; 
                color: #a0a0a0; 
                margin-bottom: 20px; 
                padding: 10px;
                background: rgba(255,255,255,0.05);
                border-radius: 4px;
              ">
                ğŸ” æœç´¢ "${searchTerm}" æ‰¾åˆ° ${filteredHistory.length} æ¡è®°å½•
              </div>
            ` +
              this.formatChatHistory(filteredHistory).replace(
                /ğŸ“Š å…±æ˜¾ç¤º \d+ æ¡èŠå¤©è®°å½•/,
                `ğŸ” æœç´¢ç»“æœ: ${filteredHistory.length} æ¡åŒ¹é…è®°å½•`,
              );
          }
        }

        // å¯¼å‡ºèŠå¤©å†å²åŠŸèƒ½ï¼ˆä½¿ç”¨chatHistoryCacheï¼‰
        async exportChatHistory(chatHistory) {
          try {
            // è·å–å½“å‰æ¸¸æˆçŠ¶æ€
            const gameState = this.getAllVariables();

            // è·å–ä¸–ç•Œä¹¦å†…å®¹
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
            } catch (e) {
              console.warn('è¯»å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
            }

            const exportData = {
              exportTime: new Date().toLocaleString('zh-CN'),
              gameTitle: 'ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ',
              version: '2.0',
              totalMessages: chatHistory.length,
              gameState: gameState,
              chatHistory: chatHistory.map(msg => ({
                type: msg.is_user || msg.type === 'user' ? 'user' : 'ai',
                time: msg.send_date || (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : ''),
                content: msg.content || msg.mes || msg.message || '',
              })),
              lorebook_content: {
                journey: journeyContent,
                core_memory: coreMemoryContent,
              },
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `èŠå¤©è®°å½•_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.showCustomAlert('âœ… èŠå¤©è®°å½•å¯¼å‡ºæˆåŠŸï¼');
          } catch (error) {
            console.error('å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥:', error);
            this.showCustomAlert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
          }
        }

        // ç®€å•çš„æç¤ºæ¡†å‡½æ•°ï¼ˆå¦‚æœä¹‹å‰åˆ é™¤äº†çš„è¯ï¼‰
        async showCustomAlert(message) {
          return new Promise(resolve => {
            const alert = document.createElement('div');
            alert.innerHTML = `
              <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 15000;
                display: flex;
                align-items: center;
                justify-content: center;
              ">
                <div style="
                  background: linear-gradient(135deg, #2c1810, #3d2817);
                  border: 2px solid #8b4513;
                  border-radius: 12px;
                  padding: 30px;
                  max-width: 400px;
                  text-align: center;
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                ">
                  <p style="
                    color: #e0e0e0;
                    margin: 0 0 20px 0;
                    line-height: 1.6;
                    font-size: 16px;
                  ">${message}</p>
                  <button style="
                    background: linear-gradient(135deg, #8b4513, #a0522d);
                    color: #fff;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                  ">ç¡®å®š</button>
                </div>
              </div>
            `;

            document.body.appendChild(alert);

            const btn = alert.querySelector('button');
            btn.addEventListener('click', () => {
              alert.remove();
              resolve();
            });
          });
        }

        handleDangerPeriod() {
          console.log('å±é™©æ—¶æ®µæŒ‰é’®è¢«ç‚¹å‡»');

          // æ’­æ”¾å±é™©æ—¶æ®µç¿»é¡µå£°éŸ³
          const sound = document.getElementById('danger-rules-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´', '06:00'),
            n = this.getTimeDangerLevel(t),
            s = this.getDangerLevelText(n),
            o = this.getDangerLevelDetails(n),
            a = document.createElement('div');

          ((a.className = 'danger-modal'),
            (a.innerHTML = `\n      <div class="danger-modal-content">\n        <div class="danger-modal-header">\n          <h3>ã€è®­ç»ƒå‘˜æ—¶æ®µç”Ÿå­˜æŒ‡å—ã€‘</h3>\n          <span class="danger-modal-close">&times;</span>\n        </div>\n        <div class="danger-modal-body">\n          <div class="danger-current-period">\n            <strong>å½“å‰æ—¶æ®µï¼š${s}</strong>\n          </div>\n          <div class="danger-details-content">\n            ${o}\n          </div>\n        </div>\n      </div>\n    `),
            // ğŸ”¥ ä½¿ç”¨è¾…åŠ©å‡½æ•°æ·»åŠ åˆ°æ­£ç¡®ä½ç½®
            (() => {
              const overlay = document.getElementById('teresen-fullscreen-overlay');
              if (overlay) {
                overlay.appendChild(a);
              } else {
                document.body.appendChild(a);
              }
            })());

          const l = a.querySelector('.danger-modal-close');

          (l &&
            l.addEventListener('click', () => {
              a.remove();
            }),
            a.addEventListener('click', e => {
              e.target === a && a.remove();
            }));
        }

        debugVariables() {
          console.log('ğŸ” è°ƒè¯•å˜é‡æŒ‰é’®è¢«ç‚¹å‡»');

          const e = this.getAllVariables();

          (console.log('ğŸ“Š æ‰€æœ‰å˜é‡æ•°æ®:', e),
            e && e.stat_data
              ? (console.log('âœ… æ‰¾åˆ°stat_dataç»“æ„'),
                console.log('ğŸƒ è®­ç»ƒå‘˜æ•°æ®:', e.stat_data.è®­ç»ƒå‘˜),
                console.log('ğŸŒ ä¸–ç•Œæ•°æ®:', e.stat_data.ä¸–ç•Œ),
                console.log('ğŸ é©¬å¨˜æ•°æ®:', e.stat_data.é©¬å¨˜),
                e.stat_data.é©¬å¨˜ &&
                  (console.log('ğŸ” é©¬å¨˜æ•°æ®è¯¦æƒ…:'),
                  Object.keys(e.stat_data.é©¬å¨˜).forEach(t => {
                    const n = e.stat_data.é©¬å¨˜[t];

                    (console.log(`ğŸ ${t}:`, n),
                      n.å¥½æ„Ÿåº¦ && console.log(`  ğŸ’– ${t} å¥½æ„Ÿåº¦:`, n.å¥½æ„Ÿåº¦),
                      n.ç‹¬å åº¦ && console.log(`  ğŸ”¥ ${t} ç‹¬å åº¦:`, n.ç‹¬å åº¦),
                      n.çŠ¶æ€ && console.log(`  ğŸ“Š ${t} çŠ¶æ€:`, n.çŠ¶æ€));
                  })),
                e.stat_data.è§„åˆ™ && console.log('ğŸ“œ è§„åˆ™æ•°æ®:', e.stat_data.è§„åˆ™))
              : (console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'), console.log('ğŸ” å®Œæ•´è¿”å›ç»“æœ:', e)),
            console.log('ğŸ® å½“å‰ç•Œé¢çŠ¶æ€:'),
            console.log('  - é©¬å¨˜å®¹å™¨:', document.getElementById('uma-status')),
            console.log('  - æ—¶é—´æ˜¾ç¤º:', document.getElementById('current-time')),
            console.log('  - è®­ç»ƒå‘˜çŠ¶æ€:', document.getElementById('trainer-status')));
        }

        async handleActionSubmit() {
          const e = document.getElementById('action-input');

          if (!e || !e.value.trim()) return;

          const userMessage = e.value.trim();

          console.log('ğŸ¯ æäº¤è¡ŒåŠ¨:', userMessage);

          // ğŸ”¥ å‘é€æ¶ˆæ¯åç«‹å³æ¸…é™¤æŒ‡ä»¤é˜Ÿåˆ—ï¼ˆæ¨¡æ‹Ÿç‚¹å‡»æ¸…é™¤æŒ‰é’®ï¼‰
          try {
            // è§¦å‘æ¸…é™¤æŒ‡ä»¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼ˆå’ŒæŒ‰é’®ç»‘å®šçš„é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
            const clearAllBtn = document.querySelector('.clear-all-btn');
            if (clearAllBtn) {
              clearAllBtn.click();
            } else {
              // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‰é’®ï¼Œç›´æ¥è°ƒç”¨å‡½æ•°
              if (typeof clearAllActions === 'function' && typeof updateCommandList === 'function') {
                clearAllActions();
                updateCommandList();
              }
            }
          } catch (err) {
            console.warn('æ¸…é™¤æŒ‡ä»¤å¤±è´¥:', err);
          }

          // ğŸ”¥ éšè—actioné€‰é¡¹å®¹å™¨ï¼ˆç”Ÿæˆä¸­ä¸èƒ½é€‰æ‹©ï¼‰
          const actionContainer = document.getElementById('action-options-container');
          if (actionContainer) {
            actionContainer.style.display = 'none';
          }

          // ğŸ”¥ æ”¹å˜å‘é€æŒ‰é’®æ–‡å­—ä¸º"ç”Ÿæˆä¸­"
          const sendBtn = document.getElementById('btn-send-action');
          const originalText = sendBtn ? sendBtn.textContent : 'å‘é€';
          if (sendBtn) {
            sendBtn.textContent = 'ç”Ÿæˆä¸­';
            sendBtn.disabled = true;
          }

          // ğŸ”¥ åœ¨å‘é€æ¶ˆæ¯å‰åˆ›å»ºå¾…å®šè‡ªåŠ¨å­˜æ¡£
          if (this.isAutoSaveEnabled) {
            await this.createPendingAutoSave();
          }

          try {
            // 1. æ•´åˆæŒ‡ä»¤å’Œç”¨æˆ·è¾“å…¥

            let commandText = '';

            if (window.pendingActions && window.pendingActions.length > 0) {
              commandText += '[è®­ç»ƒå‘˜è¡ŒåŠ¨æŒ‡ä»¤]\n';
              commandText += 'è®­ç»ƒå‘˜åœ¨æœ¬å›åˆä¸­æ˜ç¡®è¦æ‰§è¡Œä»¥ä¸‹è¡ŒåŠ¨ï¼Œè¯·åŠ¡å¿…åœ¨å›å¤ä¸­è¯¦ç»†æè¿°è¿™äº›è¡ŒåŠ¨çš„æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœï¼š\n\n';

              window.pendingActions.forEach((cmd, index) => {
                let requestText = '';
                switch (cmd.action) {
                  case 'use':
                    const useDesc = cmd.itemData?.æè¿° || 'æ— æè¿°';
                    const useEffect = cmd.itemData?.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜';
                    requestText = `<Request: ä½¿ç”¨é“å…·${cmd.itemName}ï¼Œæè¿°:${useDesc}ï¼Œæ•ˆæœ:${useEffect}>`;
                    break;
                  case 'discard':
                    const discardDesc = cmd.itemData?.æè¿° || 'æ— æè¿°';
                    requestText = `<Request: ä¸¢å¼ƒé“å…·${cmd.itemName}ï¼Œæè¿°:${discardDesc}>`;
                    break;
                  case 'gift':
                    const giftDesc = cmd.itemData?.æè¿° || 'æ— æè¿°';
                    const giftEffect = cmd.itemData?.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜';
                    requestText = `<Request: èµ é€é“å…·${cmd.itemName}ç»™${cmd.characterName || cmd.target}ï¼Œæè¿°:${giftDesc}ï¼Œæ•ˆæœ:${giftEffect}>`;
                    break;
                  case 'move':
                    const moveDesc = cmd.description || 'æ— è¯¦ç»†æè¿°';
                    requestText = `<Request: å‰å¾€${cmd.itemName}ï¼Œæè¿°:${moveDesc}>`;
                    break;
                  case 'lock':
                    requestText = `<Request: é”å®šé“å…·${cmd.itemName}>`;
                    break;
                  case 'skill':
                    const skillInfo = cmd.skillType || 'æœªçŸ¥æŠ€èƒ½';
                    const targetInfo = cmd.target === 'self' ? 'å¯¹è‡ªå·±' : cmd.characterName || 'å¯¹ç›®æ ‡';
                    requestText = `<Request: ä½¿ç”¨æŠ€èƒ½${skillInfo}${targetInfo}>`;
                    break;
                  case 'meal':
                    requestText = `<Request: åŠ é¤${cmd.characterName ? `ä¸${cmd.characterName}` : ''}>`;
                    break;
                  case 'borrow':
                    requestText = `<Request: å€Ÿé’±${cmd.characterName ? `å‘${cmd.characterName}` : ''}>`;
                    break;
                  case 'game':
                    requestText = `<Request: æ‰“æ¸¸æˆ${cmd.characterName ? `ä¸${cmd.characterName}` : ''}>`;
                    break;
                  case 'chat':
                    requestText = `<Request: èŠå¤©${cmd.characterName ? `ä¸${cmd.characterName}` : ''}>`;
                    break;
                  case 'rest':
                    requestText = `<Request: ä¼‘æ¯åˆ°ä¸‹å‘¨>`;
                    break;
                  default:
                    requestText = `<Request: æ‰§è¡Œæ“ä½œ${cmd.action}${cmd.itemName ? `ï¼Œé“å…·:${cmd.itemName}` : ''}>`;
                }

                commandText += `- ${requestText}\n`;
              });

              commandText += '\n';

              console.log('ğŸ“‹ æŒ‡ä»¤æ–‡æœ¬å·²ç”Ÿæˆï¼Œå…±', window.pendingActions.length, 'æ¡æŒ‡ä»¤:');
              console.log(commandText);
            } else {
              console.log('ğŸ“‹ æ²¡æœ‰å¾…æ‰§è¡Œçš„æŒ‡ä»¤');
            }

            // 2. ğŸ”¥ ä»ä¸–ç•Œä¹¦è¯»å–è®°å¿†å¹¶ç»„è£…åŠ¨æ€ä¸Šä¸‹æ–‡
            let dynamicContext = '';
            try {
              dynamicContext = await this._assembleDynamicContext(userMessage);
              if (dynamicContext) {
                console.log('ğŸ“– å·²ä»ä¸–ç•Œä¹¦è¯»å–è®°å¿†');
              }
            } catch (e) {
              console.error('âŒ è¯»å–è®°å¿†å¤±è´¥:', e);
            }

            // 3. æ„å»ºåˆå¹¶å†…å®¹ï¼ˆåŒ…å«è®°å¿†å¤‡å¿˜å½•ï¼‰

            let combinedContent = '';

            // ğŸ”¥ å¦‚æœæœ‰è®°å¿†ï¼Œå…ˆæ·»åŠ è®°å¿†å¤‡å¿˜å½•
            if (dynamicContext) {
              combinedContent += `[è®°å¿†å¤‡å¿˜å½•]\n${dynamicContext}\n\n`;
            }

            if (commandText) {
              combinedContent += commandText;
              console.log('âœ… æŒ‡ä»¤å·²æ·»åŠ åˆ°combinedContentï¼Œé•¿åº¦:', commandText.length);
            } else {
              console.log('âš ï¸ æ²¡æœ‰æŒ‡ä»¤æ–‡æœ¬');
            }

            if (userMessage) {
              combinedContent += `<userinput>\n${userMessage}\n</userinput>`;
            }

            if (!combinedContent) {
              console.warn('âš ï¸ æ²¡æœ‰å†…å®¹å¯å‘é€');

              return;
            }

            console.log('ğŸ“¤ å‡†å¤‡å‘é€çš„å®Œæ•´å†…å®¹:', combinedContent);

            // 3. ä¿å­˜ç”¨æˆ·è¾“å…¥å’ŒæŒ‡ä»¤ï¼Œç”¨äºé‡æ–°ç”Ÿæˆå’Œè¿”å›åŠŸèƒ½
            this.lastUserInput = combinedContent;
            this.lastSentPrompt = combinedContent; // ğŸ”¥ ä¿å­˜å®Œæ•´æç¤ºè¯ï¼ˆåŒ…å«æŒ‡ä»¤ï¼‰ï¼Œç”¨äºé‡æ–°ç”Ÿæˆ

            // 4. ğŸ”¥ åŠ è½½å†å²æ¶ˆæ¯ï¼ˆå‚è€ƒåˆ†æ2.jsçš„handleSendï¼šå…ˆåŠ è½½å†å²ï¼‰
            let chatHistory = await this.loadChatHistoryFromExtra();
            console.log(`ğŸ“‹ [handleActionSubmit] åŠ è½½å†å²æ¶ˆæ¯: ${chatHistory.length} æ¡`);

            // 5. ğŸ”¥ æ„å»ºinjectsæ•°ç»„ï¼ˆå‚è€ƒåˆ†æ2.jsï¼šå°†æ‰€æœ‰å†å²æ¶ˆæ¯è½¬æ¢ä¸ºinjectsï¼‰
            // åˆ†æ2.jsä½¿ç”¨: a.map((t, e) => ({ role, content: formatAsTavernRegexedString(...), depth: i - 1 - e + 1 }))
            // æ³¨æ„ï¼šåˆ†æ2.jsä¸­ï¼Œdepthè®¡ç®—ä¸º i - 1 - e + 1ï¼Œå…¶ä¸­iæ˜¯æ€»æ¶ˆæ¯æ•°ï¼ˆåŒ…æ‹¬æ–°æ¶ˆæ¯ï¼‰ï¼Œeæ˜¯ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
            // depthèŒƒå›´ï¼šç´¢å¼•0ï¼ˆæœ€æ—§ï¼‰çš„depth = iï¼Œç´¢å¼•i-1ï¼ˆæœ€æ–°ï¼‰çš„depth = 1
            const totalMessages = chatHistory.length + 1; // å†å²æ¶ˆæ¯ + å½“å‰ç”¨æˆ·è¾“å…¥
            const injects = [];

            // 5.1 å°†å†å²æ¶ˆæ¯è½¬æ¢ä¸ºinjectsï¼ˆå¦‚æœæœ‰formatAsTavernRegexedStringå‡½æ•°ï¼Œä½¿ç”¨å®ƒæ ¼å¼åŒ–ï¼‰
            // ğŸ”¥ æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦å…ˆæ·»åŠ å†å²æ¶ˆæ¯ï¼Œç„¶åæ·»åŠ å½“å‰ç”¨æˆ·è¾“å…¥
            // è¿™æ ·å½“å‰ç”¨æˆ·è¾“å…¥åœ¨æ•°ç»„æœ€åï¼Œå¯¹åº”çš„depthåº”è¯¥æ˜¯1ï¼ˆæœ€æ–°ï¼‰
            chatHistory.forEach((msg, index) => {
              // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„depthè®¡ç®—ï¼šdepth = i - 1 - e + 1
              // è¿™é‡Œi = totalMessagesï¼Œe = indexï¼ˆå†å²æ¶ˆæ¯åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼‰
              // å¯¹äºå†å²æ¶ˆæ¯ï¼Œeçš„èŒƒå›´æ˜¯0åˆ°chatHistory.length-1
              // å½“å‰ç”¨æˆ·è¾“å…¥ä¼šæ·»åŠ åœ¨æœ€åï¼Œç´¢å¼•ä¸ºchatHistory.lengthï¼Œdepth = totalMessages - chatHistory.length = 1
              // æ‰€ä»¥å†å²æ¶ˆæ¯çš„depth = totalMessages - indexï¼ˆç´¢å¼•0çš„æœ€æ—§æ¶ˆæ¯depthæœ€å¤§ï¼‰
              const depth = totalMessages - index;
              let content = msg.content || '';

              // å¦‚æœæœ‰formatAsTavernRegexedStringå‡½æ•°ï¼Œä½¿ç”¨å®ƒæ ¼å¼åŒ–å†…å®¹
              if (typeof formatAsTavernRegexedString === 'function') {
                try {
                  const msgType = msg.role === 'user' ? 'user_input' : 'ai_output';
                  content = formatAsTavernRegexedString(content, msgType, 'prompt', { depth: depth });
                } catch (e) {
                  console.warn('âš ï¸ formatAsTavernRegexedStringå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹:', e);
                }
              }

              injects.push({
                role: msg.role,
                content: content,
                position: 'in_chat',
                depth: depth,
                should_scan: true,
              });
            });

            // 5.2 æ·»åŠ å½“å‰ç”¨æˆ·è¾“å…¥ï¼ˆdepth: 1ï¼Œå› ä¸ºæ˜¯æœ€æ–°çš„ï¼‰
            let currentUserContent = combinedContent;
            if (typeof formatAsTavernRegexedString === 'function') {
              try {
                currentUserContent = formatAsTavernRegexedString(combinedContent, 'user_input', 'prompt', { depth: 1 });
              } catch (e) {
                console.warn('âš ï¸ formatAsTavernRegexedStringå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹:', e);
              }
            }

            injects.push({
              role: 'user',
              content: currentUserContent,
              position: 'in_chat',
              depth: 1, // æœ€æ–°æ¶ˆæ¯depthä¸º1
              should_scan: true,
            });

            console.log(`ğŸ“¤ å‡†å¤‡å‘é€ ${injects.length} æ¡æ¶ˆæ¯ç»™AI (å†å²: ${chatHistory.length}, å½“å‰: 1)`);

            // 6. ç”ŸæˆAIå›å¤
            if ('undefined' != typeof TavernHelper && TavernHelper.generate) {
              const generateConfig = {
                injects: injects, // ğŸ”¥ ä½¿ç”¨åŒ…å«å†å²æ¶ˆæ¯çš„injectsæ•°ç»„
                max_chat_history: 0, // ğŸ”¥ å‚è€ƒåˆ†æ2.jsï¼šè®¾ç½®ä¸º0ï¼Œå› ä¸ºæ‰€æœ‰å†å²éƒ½åœ¨injectsä¸­
                should_stream: true,
              };

              try {
                console.log('ğŸš€ å¼€å§‹æµå¼ç”Ÿæˆ...');

                const aiResponse = await TavernHelper.generate(generateConfig);

                console.log('âœ… AIç”Ÿæˆå®Œæˆ:', aiResponse);

                // 7. ä¿å­˜ç”¨æˆ·è¾“å…¥å’ŒAIå›å¤åˆ° extra.teresen_chat
                // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„é€»è¾‘ï¼šåœ¨åŒä¸€ä¸ªå‡½æ•°ä¸­ç»´æŠ¤å†å²æ•°ç»„ï¼Œé¿å…å¤šæ¬¡åŠ è½½å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
                try {
                  // 7.1 ä½¿ç”¨ä¹‹å‰å·²åŠ è½½çš„å†å²ï¼ˆé¿å…é‡å¤åŠ è½½ï¼ŒchatHistoryå·²ç»åœ¨æ­¥éª¤4ä¸­åŠ è½½ï¼‰
                  // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ä¹‹å‰åŠ è½½çš„chatHistoryå˜é‡ï¼Œä¸å†é‡æ–°åŠ è½½
                  console.log(`ğŸ“‹ [handleActionSubmit] ä½¿ç”¨å·²åŠ è½½çš„å†å²: ${chatHistory.length} æ¡æ¶ˆæ¯`);

                  // 7.2 ğŸ”¥ è·å–å½“å‰å˜é‡çŠ¶æ€ï¼ˆå‚è€ƒåˆ†æ2.jsçš„handleSendï¼‰
                  // åˆ†æ2.jsä½¿ç”¨: getVariables({ type: "message" })
                  let currentVariables = {};
                  try {
                    if (typeof getVariables === 'function') {
                      currentVariables = JSON.parse(JSON.stringify(getVariables({ type: 'message' }) || {}));
                    } else {
                      // å¤‡ç”¨æ–¹æ¡ˆï¼šä»å†å²è®°å½•çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„variableStateè·å–
                      const lastMsg = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1] : null;
                      currentVariables = lastMsg?.variableState || this.currentMvuState || this.getAllVariables() || {};
                    }
                  } catch (error) {
                    console.warn('âš ï¸ è·å–å˜é‡çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                    currentVariables = this.currentMvuState || this.getAllVariables() || {};
                  }

                  // 7.3 ğŸ”¥ å¤„ç†å˜é‡ï¼ˆå‚è€ƒåˆ†æ2.jsçš„_processVariablesï¼‰
                  const variableResult = await this._processVariables(aiResponse, currentVariables);
                  const updatedVariables = variableResult.updatedVariables;
                  const variableSnapshot = variableResult.snapshot;

                  // 7.4 åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å¯¹è±¡å¹¶æ·»åŠ åˆ°å†…å­˜æ•°ç»„
                  const userMessageObj = {
                    role: 'user',
                    content: userMessage,
                    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: Date.now(),
                    variableState: JSON.parse(JSON.stringify(currentVariables)), // ç”¨æˆ·æ¶ˆæ¯ä¿å­˜å‘é€å‰çš„å˜é‡çŠ¶æ€
                  };
                  chatHistory.push(userMessageObj);
                  console.log(`ğŸ“‹ [handleActionSubmit] æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åï¼Œå†å²é•¿åº¦: ${chatHistory.length}`);

                  // 7.5 åˆ›å»ºAIæ¶ˆæ¯å¯¹è±¡å¹¶æ·»åŠ åˆ°å†…å­˜æ•°ç»„ï¼ˆæ­¤æ—¶chatHistoryè¿˜åŒ…å«ç”¨æˆ·æ¶ˆæ¯ï¼‰
                  // ğŸ”¥ å‚è€ƒåˆ†æ2.jsï¼šAIæ¶ˆæ¯çš„variableStateä¿å­˜å¤„ç†åçš„å˜é‡å¿«ç…§
                  const assistantMessageObj = {
                    role: 'assistant',
                    content: aiResponse,
                    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    timestamp: Date.now(),
                    variableState: variableSnapshot, // ä¿å­˜å¤„ç†åçš„å˜é‡å¿«ç…§
                  };
                  chatHistory.push(assistantMessageObj);
                  console.log(`ğŸ“‹ [handleActionSubmit] æ·»åŠ AIæ¶ˆæ¯åï¼Œå†å²é•¿åº¦: ${chatHistory.length}`);

                  // 7.6 ä¸€æ¬¡æ€§ä¿å­˜å®Œæ•´å†å²æ•°ç»„ï¼ˆåŒ…å«ç”¨æˆ·æ¶ˆæ¯+AIå›å¤ï¼‰
                  // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„saveStateï¼šç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥æ›´æ–°åçš„å˜é‡
                  await this.saveChatHistoryToExtra(chatHistory, updatedVariables);

                  // 7.7 éªŒè¯ä¿å­˜ç»“æœ
                  const verifyHistory = await this.loadChatHistoryFromExtra();
                  console.log(`ğŸ“‹ [handleActionSubmit] ä¿å­˜åéªŒè¯ï¼Œå†å²é•¿åº¦: ${verifyHistory.length} æ¡æ¶ˆæ¯`);
                  if (verifyHistory.length !== chatHistory.length) {
                    console.error(
                      `âŒ [handleActionSubmit] ä¿å­˜éªŒè¯å¤±è´¥ï¼æœŸæœ› ${chatHistory.length} æ¡ï¼Œå®é™… ${verifyHistory.length} æ¡`,
                    );
                  } else {
                    console.log('âœ… ç”¨æˆ·è¾“å…¥å’ŒAIå›å¤å·²ä¿å­˜åˆ° extra.teresen_chat');
                  }

                  // 7.8 å¯é€‰ï¼šæ›´æ–°0å±‚æ¶ˆæ¯ç”¨äºç•Œé¢æ˜¾ç¤ºï¼ˆä»…ç”¨äºå…¼å®¹æ€§ï¼Œä¸ä½œä¸ºæ•°æ®æºï¼‰
                  // æ³¨æ„ï¼šæ ¹æ®"è„±ç¦»0å±‚æ¶ˆæ¯æ–¹æ¡ˆ"ï¼Œ0å±‚æ¶ˆæ¯åªä½œä¸ºå®¹å™¨ï¼Œæ•°æ®ä¸»è¦å­˜å‚¨åœ¨extra.teresen_chat
                  // å¦‚æœç•Œé¢éœ€è¦æ˜¾ç¤ºï¼Œå¯ä»¥æ›´æ–°0å±‚ï¼Œä½†è¯»å–æ—¶åº”è¯¥ä¼˜å…ˆä»extraè¯»å–
                  // è¿™é‡Œé€‰æ‹©ä¸æ›´æ–°0å±‚æ¶ˆæ¯ï¼Œå®Œå…¨ä¾èµ–extra.teresen_chat
                  console.log('ğŸ“ æ¶ˆæ¯å·²ä¿å­˜åˆ°extra.teresen_chatï¼Œä¸æ›´æ–°0å±‚æ¶ˆæ¯ï¼ˆå®Œå…¨è„±ç¦»0å±‚æ–¹æ¡ˆï¼‰');

                  // 7.9 ğŸ”¥ æ›´æ–°å˜é‡çŠ¶æ€å’Œç•Œé¢ï¼ˆå˜é‡å·²åœ¨_processVariablesä¸­å¤„ç†ï¼‰
                  // å‚è€ƒåˆ†æ2.jsï¼šå˜é‡å¤„ç†å·²ç»åœ¨_processVariablesä¸­å®Œæˆï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°æœ¬åœ°çŠ¶æ€å’ŒUI
                  if (updatedVariables) {
                    this.currentMvuState = updatedVariables;
                    // é‡æ–°æ¸²æŸ“UIï¼ˆå¦‚æœæœ‰stat_dataï¼‰
                    if (updatedVariables.stat_data) {
                      this.renderUI(updatedVariables.stat_data);
                    }
                    console.log('âœ… å˜é‡çŠ¶æ€å·²æ›´æ–°å¹¶ä¿å­˜åˆ°extra.teresen_chat');
                  }
                } catch (saveError) {
                  console.error('âŒ ä¿å­˜åˆ°extra.teresen_chatå¤±è´¥:', saveError);
                  // å¦‚æœä¿å­˜å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸å›é€€åˆ°0å±‚æ¶ˆæ¯
                  // å› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®Œå…¨è„±ç¦»0å±‚æ¶ˆæ¯ï¼Œæ‰€ä»¥å³ä½¿å¤±è´¥ä¹Ÿä¸åº”è¯¥å›é€€
                  console.error('âŒ ä¿å­˜å¤±è´¥ï¼Œä½†ä¸ä¼šå›é€€åˆ°0å±‚æ¶ˆæ¯ï¼ˆå®Œå…¨è„±ç¦»0å±‚æ–¹æ¡ˆï¼‰');
                  throw saveError; // æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
                }

                // 8. ğŸ”¥ ä¸å†æ›´æ–°0å±‚æ¶ˆæ¯çš„messageå­—æ®µï¼ˆå‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼‰
                // æ•°æ®å·²ä¿å­˜åˆ°extra.teresen_chatï¼Œä¸éœ€è¦æ›´æ–°0å±‚æ¶ˆæ¯
                // å¦‚æœéœ€è¦åœ¨åŒå±‚æ¸¸ç©ï¼Œåº”è¯¥ä»extra.teresen_chatè¯»å–ï¼Œè€Œä¸æ˜¯ä»0å±‚æ¶ˆæ¯è¯»å–
                console.log('ğŸ“ æ•°æ®å·²ä¿å­˜åˆ°extra.teresen_chatï¼Œä¸æ›´æ–°0å±‚æ¶ˆæ¯ï¼ˆå®Œå…¨è„±ç¦»0å±‚æ–¹æ¡ˆï¼‰');

                // 9. æŒ‡ä»¤é˜Ÿåˆ—å·²åœ¨å‘é€æ¶ˆæ¯æ—¶æ¸…é™¤ï¼ˆæ— éœ€é‡å¤æ¸…é™¤ï¼‰

                // 10. è‡ªåŠ¨å­˜æ¡£AIå›å¤ï¼ˆåœ¨handleGenerationEndä¸­å·²å¤„ç†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤ï¼‰

                // 11. ç«‹å³ç»“æŸè®¡æ—¶å™¨

                this.endReplyTimer();
              } catch (error) {
                console.error('âŒ AIç”Ÿæˆå¤±è´¥:', error);

                this.endReplyTimer();
              } finally {
                // æœ€ç»ˆä¿®å¤ï¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨ã€å¯é åœ°åˆ·æ–°UIï¼Œé¿å…ä»»ä½•äº‹ä»¶å†²çª
                try {
                  await this.updateDynamicData();
                  console.log('âœ… æœ€ç»ˆUIåˆ·æ–°å®Œæˆ');
                } catch (finalError) {
                  console.warn('âš ï¸ æœ€ç»ˆUIåˆ·æ–°å¤±è´¥:', finalError);
                }

                // ğŸ”¥ æ¢å¤å‘é€æŒ‰é’®æ–‡å­—ä¸º"å‘é€"ï¼ˆåœ¨AIç”Ÿæˆå®Œæˆåæ¢å¤ï¼‰
                const sendBtn = document.getElementById('btn-send-action');
                if (sendBtn) {
                  sendBtn.textContent = 'å‘é€';
                  sendBtn.disabled = false;
                }
              }
            }

            // ç•Œé¢å·²åœ¨AIå›å¤åæ›´æ–°ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è°ƒç”¨
          } catch (error) {
            console.error('âŒ äº¤äº’å¤±è´¥:', error);
          } finally {
            // å‚è€ƒé¡¹ç›®æ¨¡å¼ï¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆåï¼Œä¸»åŠ¨ã€å¯é åœ°åˆ·æ–°UI

            await this.updateDynamicData();

            console.log('âœ… æœ€ç»ˆç•Œé¢æ›´æ–°å®Œæˆï¼ˆå‚è€ƒé¡¹ç›®æ¨¡å¼ï¼‰');

            // ğŸ”¥ æ¢å¤å‘é€æŒ‰é’®æ–‡å­—ä¸º"å‘é€"ï¼ˆç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ¢å¤ï¼‰
            const sendBtn = document.getElementById('btn-send-action');
            if (sendBtn) {
              sendBtn.textContent = 'å‘é€';
              sendBtn.disabled = false;
            }
          }

          e.value = '';
        }

        setupRulesModal() {
          ($('#view-rules-btn').on('click', () => {
            console.log('ğŸ¯ æŸ¥çœ‹è§„åˆ™æŒ‰é’®è¢«ç‚¹å‡»ï¼');

            const e = document.getElementById('rules-modal'),
              t = document.getElementById('danger-rules-sound');
            e && t
              ? (console.log('âœ… æ˜¾ç¤ºè§„åˆ™æ¨¡æ€æ¡†'),
                t.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e)),
                // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
                (() => {
                  const overlay = document.getElementById('teresen-fullscreen-overlay');
                  if (overlay && e.parentNode !== overlay) {
                    e.dataset.originalParent = e.parentNode?.tagName || 'BODY';
                    overlay.appendChild(e);
                    console.log('âœ… rules-modal å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨');
                  }
                })(),
                (e.style.display = 'flex'),
                this.updateRulesModal())
              : console.error('âŒ æ¨¡æ€æ¡†æˆ–éŸ³æ•ˆå…ƒç´ æœªæ‰¾åˆ°');
          }),
            $('#close-rules-btn').on('click', () => {
              $('#rules-modal').hide();
            }),
            $('#rules-modal').on('click', e => {
              e.target === e.currentTarget && $('#rules-modal').hide();
            }),
            // éŸ³ä¹æ§åˆ¶åŠŸèƒ½
            this.setupMusicControls(),
            // è§„åˆ™è®°å½•åŠŸèƒ½äº‹ä»¶ç»‘å®šï¼ˆå…ˆè§£ç»‘é¿å…é‡å¤ç»‘å®šï¼‰
            $('#add-rule-btn')
              .off('click')
              .on('click', () => {
                this.addRule();
              }),
            $('#clear-rules-btn')
              .off('click')
              .on('click', () => {
                this.clearAllRules();
              }));
        }

        setupSettingsModal() {
          // ç©ºå‡½æ•°ï¼Œæ‰€æœ‰äº‹ä»¶ç»‘å®šå·²ç§»åˆ°setupEventListenersä¸­ï¼Œå’Œsettings-btnä¸€æ ·
        }

        // åŠ è½½ä¿å­˜çš„å¤´åƒ
        loadProfileAvatar() {
          const savedAvatar = localStorage.getItem('teresen_profile_avatar');
          if (savedAvatar) {
            const avatarImg = document.getElementById('profile-avatar');
            if (avatarImg) {
              avatarImg.src = savedAvatar;
            }
          }
        }

        // æ˜¾ç¤ºå¤´åƒé€‰æ‹©å™¨
        showAvatarSelector() {
          // ç§»é™¤å·²å­˜åœ¨çš„é€‰æ‹©å™¨
          const existing = document.getElementById('avatar-selector-modal');
          if (existing) {
            existing.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'avatar-selector-modal';
          modal.className = 'rules-modal';
          modal.style.display = 'flex';

          const avatarIcons = [
            'https://files.catbox.moe/qflzxu.jpg',
            'https://files.catbox.moe/0yc93h.png',
            'https://files.catbox.moe/dqck58.png',
            'https://files.catbox.moe/dz30g2.png',
            'https://files.catbox.moe/j5ey17.png',
            'https://files.catbox.moe/8guz7f.png',
            'https://files.catbox.moe/a6j27z.png',
            'https://files.catbox.moe/fwsr5i.png',
            'https://files.catbox.moe/gto9os.png',
            'https://files.catbox.moe/mmpm2o.png',
            'https://files.catbox.moe/5o1sq8.png',
            'https://files.catbox.moe/cwze03.png',
            'https://files.catbox.moe/lb6i2m.png',
            'https://files.catbox.moe/vaybf1.png',
            'https://files.catbox.moe/6ji5t8.png',
            'https://files.catbox.moe/2bdoqf.png',
            'https://files.catbox.moe/0e87w5.png',
            'https://files.catbox.moe/88bl5k.png',
            'https://files.catbox.moe/q8iq99.png',
            'https://files.catbox.moe/0kwkeu.png',
            'https://files.catbox.moe/ohxr62.png',
            'https://files.catbox.moe/qnjifq.png',
            'https://files.catbox.moe/ti7a7e.png',
            'https://files.catbox.moe/lt44fw.png',
            'https://files.catbox.moe/ho8xuw.png',
            'https://files.catbox.moe/uh8els.png',
            'https://files.catbox.moe/sexais.png',
            'https://files.catbox.moe/y1zi4p.png',
            'https://files.catbox.moe/jnhnnm.png',
            'https://files.catbox.moe/a8ldtj.png',
            'https://files.catbox.moe/g88mff.png',
            'https://files.catbox.moe/ws098v.png',
            'https://files.catbox.moe/utoc62.png',
            'https://files.catbox.moe/a6o2cp.png',
            'https://files.catbox.moe/tw6yxw.png',
            'https://files.catbox.moe/3fts2d.png',
            'https://files.catbox.moe/oe13q9.png',
            'https://files.catbox.moe/5su1k9.png',
            'https://files.catbox.moe/bt39hi.png',
            'https://files.catbox.moe/gvwlym.png',
            'https://files.catbox.moe/0jx1t6.png',
            'https://files.catbox.moe/ap6q6m.png',
            'https://files.catbox.moe/92lv2o.png',
            'https://files.catbox.moe/ug311x.png',
            'https://files.catbox.moe/dv90ej.png',
            'https://files.catbox.moe/27hpzv.png',
            'https://files.catbox.moe/zr06x6.png',
            'https://files.catbox.moe/qljj32.png',
            'https://files.catbox.moe/fziqii.png',
            'https://files.catbox.moe/crh2a4.png',
            'https://files.catbox.moe/2bvb02.png',
            'https://files.catbox.moe/ypgbw8.png',
            'https://files.catbox.moe/7epz7w.png',
            'https://files.catbox.moe/e0irum.png',
            'https://files.catbox.moe/n9lgpv.png',
            'https://files.catbox.moe/78myzx.png',
            'https://files.catbox.moe/ywa39v.png',
            'https://files.catbox.moe/6jtp5b.png',
            'https://files.catbox.moe/jyy7wi.png',
            'https://files.catbox.moe/inpm0l.png',
            'https://files.catbox.moe/3368uv.png',
            'https://files.catbox.moe/ick1y5.png',
            'https://files.catbox.moe/qy58sb.png',
            'https://files.catbox.moe/vtjt9y.jpg',
            'https://files.catbox.moe/1ay7et.png',
            'https://files.catbox.moe/rytn3t.png',
            'https://files.catbox.moe/e78dpk.png',
            'https://files.catbox.moe/uod4x0.png',
            'https://files.catbox.moe/klo9wi.png',
            'https://files.catbox.moe/kw4nhq.png',
            'https://files.catbox.moe/7xxwak.png',
            'https://files.catbox.moe/6you6o.png',
            'https://files.catbox.moe/i89w2a.png',
            'https://files.catbox.moe/cvaugj.png',
            'https://files.catbox.moe/vdrsps.png',
            'https://files.catbox.moe/60mzvm.gif',
            'https://files.catbox.moe/u2ka32.gif',
            'https://files.catbox.moe/6kw9ll.gif',
            'https://files.catbox.moe/dyzslx.gif',
            'https://files.catbox.moe/3xncjo.gif',
            'https://files.catbox.moe/utmasr.gif',
            'https://files.catbox.moe/1c8zo7.gif',
            'https://files.catbox.moe/2e10cw.gif',
            'https://files.catbox.moe/lxvoqi.gif',
            'https://files.catbox.moe/8bsfya.gif',
            'https://files.catbox.moe/dv1pz6.gif',
            'https://files.catbox.moe/7tj3wk.gif',
            'https://files.catbox.moe/8d77ys.gif',
            'https://files.catbox.moe/oh6zw2.gif',
            'https://files.catbox.moe/u0e986.gif',
            'https://files.catbox.moe/3o3ct2.gif',
            'https://files.catbox.moe/mb5hph.gif',
            'https://files.catbox.moe/u63tde.gif',
            'https://files.catbox.moe/wxivic.gif',
            'https://files.catbox.moe/uwgh8o.gif',
            'https://files.catbox.moe/q8lbcc.gif',
            'https://files.catbox.moe/e7kqj7.gif',
            'https://files.catbox.moe/8pnx62.gif',
            'https://files.catbox.moe/dc4z95.gif',
            'https://files.catbox.moe/xhvxq8.png',
            'https://files.catbox.moe/b274n3.png',
            'https://files.catbox.moe/tl4ovt.gif',
            'https://files.catbox.moe/h0sg39.gif',
            'https://files.catbox.moe/mugsxv.gif',
            'https://files.catbox.moe/gj5ft1.gif',
            'https://files.catbox.moe/4ss182.gif',
            'https://files.catbox.moe/4nicqk.gif',
            'https://files.catbox.moe/sbbpci.gif',
            'https://files.catbox.moe/4whwro.gif',
            'https://files.catbox.moe/v0bwfa.gif',
            'https://files.catbox.moe/rg2u7e.gif',
            'https://files.catbox.moe/gyihwy.gif',
            'https://files.catbox.moe/wxeof4.gif',
            'https://files.catbox.moe/n6aoa9.gif',
            'https://files.catbox.moe/y72gh5.gif',
            'https://files.catbox.moe/u9szcj.gif',
            'https://files.catbox.moe/90rvne.gif',
          ];

          const avatarImg = document.getElementById('profile-avatar');
          const currentAvatar = avatarImg
            ? localStorage.getItem('teresen_profile_avatar') || avatarImg.src || 'https://files.catbox.moe/u9szcj.gif'
            : 'https://files.catbox.moe/u9szcj.gif';

          modal.innerHTML = `
            <div class="rules-modal-content" style="
              background: linear-gradient(135deg, #f5f0e8, #ede4d3);
              border: 2px solid #d4af37;
              border-radius: 12px;
              width: 90%;
              max-width: 800px;
              max-height: 85vh;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
              display: flex;
              flex-direction: column;
            ">
              <div class="rules-modal-header" style="
                padding: 20px;
                border-bottom: 1px solid #d4af37;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: linear-gradient(135deg, #f0e6d2, #e8dcc6);
              ">
                <h3 style="
                  color: #8b4513;
                  margin: 0;
                  font-size: 18px;
                  font-weight: bold;
                ">é€‰æ‹©å¤´åƒ</h3>
                <button id="avatar-selector-close-btn" style="
                  background: none;
                  border: none;
                  color: #8b4513;
                  font-size: 24px;
                  cursor: pointer;
                  padding: 5px;
                  border-radius: 4px;
                  transition: background 0.2s;
                ">&times;</button>
              </div>
              <div class="rules-modal-body" style="
                padding: 20px;
                flex: 1;
                overflow-y: auto;
              ">
                <div id="avatar-grid" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                  gap: 15px;
                "></div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          this.ensureModalInOverlay(modal);

          // å¡«å……å¤´åƒç½‘æ ¼
          const grid = modal.querySelector('#avatar-grid');
          avatarIcons.forEach(url => {
            const avatarItem = document.createElement('div');
            // åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰é€‰ä¸­çš„å¤´åƒï¼ˆæ¯”è¾ƒURLï¼Œå¿½ç•¥åè®®å’ŒåŸŸåå·®å¼‚ï¼‰
            const currentAvatarUrl = currentAvatar.replace(/^https?:\/\/[^\/]+/, '').replace(/^\/+/, '');
            const compareUrl = url.replace(/^https?:\/\/[^\/]+/, '').replace(/^\/+/, '');
            const isSelected =
              url === currentAvatar || currentAvatarUrl === compareUrl || currentAvatar.includes(url.split('/').pop());

            avatarItem.style.cssText = `
              position: relative;
              aspect-ratio: 1;
              border: 3px solid ${isSelected ? 'rgba(139, 105, 20, 0.8)' : 'rgba(139, 105, 20, 0.3)'};
              border-radius: 8px;
              overflow: hidden;
              cursor: pointer;
              transition: all 0.2s;
              background: rgba(139, 105, 20, 0.05);
              ${isSelected ? 'transform: scale(1.05); box-shadow: 0 4px 8px rgba(139, 105, 20, 0.4);' : ''}
            `;

            const img = document.createElement('img');
            img.src = url;
            img.style.cssText = `
              width: 100%;
              height: 100%;
              object-fit: cover;
              display: block;
            `;
            img.onerror = () => {
              avatarItem.style.display = 'none';
            };

            avatarItem.appendChild(img);

            let itemIsSelected = isSelected;

            avatarItem.addEventListener('click', () => {
              // æ›´æ–°å¤´åƒ
              const profileAvatarImg = document.getElementById('profile-avatar');
              if (profileAvatarImg) {
                profileAvatarImg.src = url;
              }
              // ä¿å­˜åˆ°localStorage
              localStorage.setItem('teresen_profile_avatar', url);
              // å…³é—­å¼¹çª—
              modal.remove();
            });

            avatarItem.addEventListener('mouseenter', () => {
              if (!itemIsSelected) {
                avatarItem.style.borderColor = 'rgba(139, 105, 20, 0.5)';
              }
            });

            avatarItem.addEventListener('mouseleave', () => {
              if (!itemIsSelected) {
                avatarItem.style.borderColor = 'rgba(139, 105, 20, 0.3)';
              }
            });

            grid.appendChild(avatarItem);
          });

          // å…³é—­æŒ‰é’®äº‹ä»¶
          const closeBtn = modal.querySelector('#avatar-selector-close-btn');
          closeBtn.addEventListener('click', () => {
            modal.remove();
          });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          modal.addEventListener('click', e => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        async applySettings() {
          // è·å–é€‰ä¸­çš„å­—ä½“
          const selectedFont =
            $('.font-option-btn.selected').data('font') ||
            $('.font-option-btn').first().data('font') ||
            "'Source Han Serif', 'æ€æºå®‹ä½“', serif";

          // è·å–é€‰ä¸­çš„å­—ä½“å¤§å°
          const selectedSize =
            $('.font-size-btn.selected').data('size') || $('.font-size-btn[data-size="1"]').data('size') || '1';

          // è·å–é€‰ä¸­çš„èƒŒæ™¯ç±»å‹
          const selectedBgType =
            $('.bg-option-btn.selected').data('bg-type') ||
            $('.bg-option-btn[data-bg-type="black"]').data('bg-type') ||
            'black';

          // è·å–èƒŒæ™¯å›¾ç‰‡
          let bgImage = '';
          if (selectedBgType === 'image') {
            bgImage = $('#bg-preview-img').attr('src') || $('#bg-image-url').val() || '';
          }

          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('teresen_font_family', selectedFont);
          localStorage.setItem('teresen_font_size', selectedSize);
          localStorage.setItem('teresen_fullscreen_background_type', selectedBgType);

          // åªå­˜å‚¨URLï¼Œä¸å­˜å‚¨base64æ•°æ®ï¼ˆé¿å…localStorageé…é¢è¶…é™ï¼‰
          if (bgImage) {
            // å¦‚æœæ˜¯base64æ•°æ®ï¼ˆdata:å¼€å¤´ï¼‰ï¼Œæç¤ºç”¨æˆ·ä½¿ç”¨URL
            if (bgImage.startsWith('data:')) {
              console.warn('âš ï¸ æ£€æµ‹åˆ°base64å›¾ç‰‡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨å›¾ç‰‡URL');
              // æ£€æŸ¥base64æ•°æ®å¤§å°
              const base64Data = bgImage.split(',')[1] || '';
              if (base64Data.length > 100000) {
                // å¦‚æœbase64æ•°æ®å¤§äº100KBï¼Œæç¤ºç”¨æˆ·
                alert(
                  'å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼è¯·ä½¿ç”¨å›¾ç‰‡URLè€Œä¸æ˜¯ä¸Šä¼ æ–‡ä»¶ã€‚\n\næç¤ºï¼šå¯ä»¥å°†å›¾ç‰‡ä¸Šä¼ åˆ°å›¾åºŠï¼ˆå¦‚imgurã€sm.msç­‰ï¼‰ï¼Œç„¶åä½¿ç”¨å›¾ç‰‡URLã€‚',
                );
                localStorage.removeItem('teresen_fullscreen_background_image');
              } else {
                // å¦‚æœå°äº100KBï¼Œå°è¯•å­˜å‚¨
                try {
                  localStorage.setItem('teresen_fullscreen_background_image', bgImage);
                } catch (error) {
                  console.error('âŒ å­˜å‚¨èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', error);
                  alert('å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼Œæ— æ³•å­˜å‚¨ï¼è¯·ä½¿ç”¨å›¾ç‰‡URLã€‚');
                  localStorage.removeItem('teresen_fullscreen_background_image');
                }
              }
            } else {
              // å¦‚æœæ˜¯æ™®é€šURLï¼Œç›´æ¥å­˜å‚¨
              localStorage.setItem('teresen_fullscreen_background_image', bgImage);
            }
          } else {
            localStorage.removeItem('teresen_fullscreen_background_image');
          }

          // ä¿å­˜å…¨å±åŠ è½½è®¾ç½®
          const autoFullscreenCheckbox = document.getElementById('auto-fullscreen-checkbox');
          if (autoFullscreenCheckbox) {
            localStorage.setItem('teresen_auto_fullscreen', autoFullscreenCheckbox.checked ? 'true' : 'false');
          }

          // ä¿å­˜å›è½¦å‘é€è®¾ç½®
          const enterToSendCheckbox = document.getElementById('enter-to-send-checkbox');
          if (enterToSendCheckbox) {
            if (enterToSendCheckbox.checked) {
              localStorage.setItem('teresen_enter_to_send', 'true');
            } else {
              localStorage.removeItem('teresen_enter_to_send'); // åˆ é™¤è¡¨ç¤ºfalse
            }
            this.setupEnterToSend(); // é‡æ–°è®¾ç½®å›è½¦å‘é€åŠŸèƒ½
          }

          // åº”ç”¨è®¾ç½®
          $('.story-text').css({
            'font-family': selectedFont,
            'font-size': selectedSize + 'em',
          });

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            if (selectedBgType === 'black') {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            } else if (selectedBgType === 'image' && bgImage) {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = `url("${bgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
            }
          }

          console.log('âœ… è®¾ç½®å·²åº”ç”¨');
        }

        restoreSettingsToUI() {
          // ä»localStorageåŠ è½½è®¾ç½®
          const fontFamily = localStorage.getItem('teresen_font_family') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
          const fontSize = localStorage.getItem('teresen_font_size') || '1';
          const bgType = localStorage.getItem('teresen_fullscreen_background_type') || 'black';
          const bgImage = localStorage.getItem('teresen_fullscreen_background_image') || '';
          const autoFullscreen = localStorage.getItem('teresen_auto_fullscreen') !== 'false'; // é»˜è®¤ä¸ºtrue

          // æ¢å¤å…¨å±åŠ è½½è®¾ç½®
          const autoFullscreenCheckbox = document.getElementById('auto-fullscreen-checkbox');
          if (autoFullscreenCheckbox) {
            autoFullscreenCheckbox.checked = autoFullscreen;
          }

          // æ¢å¤å›è½¦å‘é€è®¾ç½®ï¼ˆé»˜è®¤å…³é—­ï¼‰
          const enterToSend = localStorage.getItem('teresen_enter_to_send') === 'true'; // é»˜è®¤ä¸ºfalse
          const enterToSendCheckbox = document.getElementById('enter-to-send-checkbox');
          if (enterToSendCheckbox) {
            enterToSendCheckbox.checked = enterToSend;
          }

          // æ¢å¤å­—ä½“é€‰æ‹©
          $('.font-option-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
          });
          const fontBtn = $(`.font-option-btn[data-font="${fontFamily}"]`).first();
          if (fontBtn.length) {
            fontBtn.addClass('selected').css({
              background: 'rgba(139, 105, 20, 0.2)',
              'border-color': 'rgba(139, 105, 20, 0.6)',
            });
            $('#font-preview').css('font-family', fontFamily);
          }

          // æ¢å¤å­—ä½“å¤§å°é€‰æ‹©
          $('.font-size-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
          });
          const sizeBtn = $(`.font-size-btn[data-size="${fontSize}"]`).first();
          if (sizeBtn.length) {
            sizeBtn.addClass('selected').css({
              background: 'rgba(139, 105, 20, 0.2)',
              'border-color': 'rgba(139, 105, 20, 0.6)',
            });
            $('#font-preview').css('font-size', fontSize + 'em');
          }

          // æ¢å¤èƒŒæ™¯ç±»å‹é€‰æ‹©
          $('.bg-option-btn').removeClass('selected').css({
            background: 'rgba(139, 105, 20, 0.05)',
            'border-color': 'rgba(139, 105, 20, 0.3)',
            color: '#2d2d2d',
          });
          const bgBtn = $(`.bg-option-btn[data-bg-type="${bgType}"]`).first();
          if (bgBtn.length) {
            bgBtn.addClass('selected');
            if (bgType === 'black') {
              bgBtn.css({
                background: 'rgba(0, 0, 0, 0.85)',
                color: '#fff',
              });
            } else {
              bgBtn.css({
                background: 'rgba(139, 105, 20, 0.2)',
                'border-color': 'rgba(139, 105, 20, 0.6)',
              });
            }
            if (bgType === 'image') {
              $('#bg-image-upload').show();
              if (bgImage) {
                $('#bg-preview-img').attr('src', bgImage);
                $('#bg-image-preview').show();
                $('#bg-image-url').val(bgImage);
                // é«˜äº®å¯¹åº”çš„é¢„è®¾å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                $('.preset-image-item').each(function () {
                  if ($(this).data('url') === bgImage) {
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.8)',
                      transform: 'scale(1.05)',
                      'box-shadow': '0 4px 8px rgba(139, 105, 20, 0.4)',
                    });
                  } else {
                    $(this).css({
                      'border-color': 'rgba(139, 105, 20, 0.3)',
                      transform: 'scale(1)',
                      'box-shadow': 'none',
                    });
                  }
                });
              }
            } else {
              $('#bg-image-upload').hide();
            }
          }
        }

        loadSettings() {
          // ä»localStorageåŠ è½½è®¾ç½®
          const defaultBgImage = 'https://files.catbox.moe/rjchsc.jpg';
          const fontFamily = localStorage.getItem('teresen_font_family') || "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
          const fontSize = localStorage.getItem('teresen_font_size') || '1';
          const bgType = localStorage.getItem('teresen_fullscreen_background_type') || 'image';
          const bgImage = localStorage.getItem('teresen_fullscreen_background_image') || defaultBgImage;

          // åº”ç”¨å­—ä½“è®¾ç½®
          $('.story-text').css({
            'font-family': fontFamily,
            'font-size': fontSize + 'em',
          });

          // åº”ç”¨å…¨å±èƒŒæ™¯è®¾ç½®ï¼ˆå¦‚æœå…¨å±è¦†ç›–å±‚å­˜åœ¨ï¼‰
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            if (bgType === 'black') {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
              overlay.style.backgroundImage = 'none';
            } else if (bgType === 'image' && bgImage) {
              overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
              overlay.style.backgroundImage = `url("${bgImage}")`;
              overlay.style.backgroundSize = 'cover';
              overlay.style.backgroundPosition = 'center';
              overlay.style.backgroundRepeat = 'no-repeat';
            }
          }
        }

        resetSettings() {
          // é‡ç½®ä¸ºé»˜è®¤å€¼
          const defaultBgImage = 'https://files.catbox.moe/rjchsc.jpg';
          localStorage.removeItem('teresen_font_family');
          localStorage.removeItem('teresen_font_size');
          localStorage.setItem('teresen_fullscreen_background_type', 'image');
          localStorage.setItem('teresen_fullscreen_background_image', defaultBgImage);
          localStorage.setItem('teresen_auto_fullscreen', 'true'); // é»˜è®¤å‹¾é€‰
          localStorage.removeItem('teresen_enter_to_send'); // é»˜è®¤å…³é—­å›è½¦å‘é€ï¼ˆåˆ é™¤è¯¥é¡¹ï¼Œè¡¨ç¤ºfalseï¼‰

          // é‡ç½®UIæ˜¾ç¤º
          this.restoreSettingsToUI();

          // åº”ç”¨é»˜è®¤è®¾ç½®
          const defaultFont = "'Source Han Serif', 'æ€æºå®‹ä½“', serif";
          const defaultSize = '1';

          $('.story-text').css({
            'font-family': defaultFont,
            'font-size': defaultSize + 'em',
          });

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
            overlay.style.backgroundImage = `url("${defaultBgImage}")`;
            overlay.style.backgroundSize = 'cover';
            overlay.style.backgroundPosition = 'center';
            overlay.style.backgroundRepeat = 'no-repeat';
          }

          console.log('âœ… è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
        }

        clearCache() {
          // ç¡®è®¤å¯¹è¯æ¡†
          if (
            !confirm(
              'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š\n- æ‰€æœ‰è®¾ç½®\n- èŠå¤©å†å²è®°å½•\n- æ¸¸æˆçŠ¶æ€æ•°æ®\n- å…¶ä»–æœ¬åœ°å­˜å‚¨çš„æ•°æ®\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
            )
          ) {
            return;
          }

          const resultDiv = $('#clear-cache-result');
          resultDiv.hide();

          try {
            // ç»Ÿè®¡è¦æ¸…é™¤çš„é¡¹ç›®æ•°é‡
            let clearedCount = 0;
            const keysToKeep = []; // å¯ä»¥ä¿ç•™çš„é”®ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰

            // æ¸…é™¤æ‰€æœ‰ä»¥ 'teresen_' å¼€å¤´çš„ localStorage é¡¹
            for (let i = localStorage.length - 1; i >= 0; i--) {
              const key = localStorage.key(i);
              if (key && key.startsWith('teresen_') && !keysToKeep.includes(key)) {
                localStorage.removeItem(key);
                clearedCount++;
              }
            }

            // æ¸…é™¤å…¶ä»–å¯èƒ½çš„ç¼“å­˜é”®ï¼ˆä¸ä»¥teresen_å¼€å¤´çš„ï¼‰
            const otherCacheKeys = [
              'treisenAchievements', // æˆå°±ç³»ç»Ÿï¼ˆæ³¨æ„æ‹¼å†™æ˜¯treisenï¼‰
              'uma_roster', // é©¬å¨˜è®°åå†Œ
              'item_pending_actions', // å¾…æ‰§è¡ŒåŠ¨ä½œ
              'game_current_day', // æ¸¸æˆå½“å‰å¤©æ•°
              'frontend_chat_history_fallback', // å›é€€å†å²è®°å½•
            ];

            otherCacheKeys.forEach(key => {
              if (localStorage.getItem(key)) {
                localStorage.removeItem(key);
                clearedCount++;
              }
            });

            // æ¸…é™¤æ‰€æœ‰ä»¥ç‰¹å®šå‰ç¼€å¼€å¤´çš„é”®
            const prefixPatterns = [
              'frontend_chat_history_', // èŠå¤©å†å²è®°å½•ï¼ˆæ ¼å¼ï¼šfrontend_chat_history_${chatId}ï¼‰
              'tarot_', // å¡”ç½—ç‰Œç›¸å…³ï¼ˆæ ¼å¼ï¼štarot_*ï¼‰
            ];

            prefixPatterns.forEach(prefix => {
              for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && key.startsWith(prefix)) {
                  localStorage.removeItem(key);
                  clearedCount++;
                }
              }
            });

            // æ¸…é™¤ sessionStorage
            try {
              const sessionCount = sessionStorage.length;
              sessionStorage.clear();
              clearedCount += sessionCount;
            } catch (e) {
              console.warn('æ¸…é™¤ sessionStorage å¤±è´¥:', e);
            }

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            resultDiv
              .css({
                background: 'rgba(16, 185, 129, 0.1)',
                border: '1px solid rgba(16, 185, 129, 0.3)',
                color: '#059669',
              })
              .html(`âœ… æˆåŠŸæ¸…é™¤äº† ${clearedCount} é¡¹ç¼“å­˜æ•°æ®ï¼é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...`)
              .fadeIn(200);

            console.log(`âœ… å·²æ¸…é™¤ ${clearedCount} é¡¹ç¼“å­˜`);

            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } catch (error) {
            console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', error);
            resultDiv
              .css({
                background: 'rgba(220, 38, 38, 0.1)',
                border: '1px solid rgba(220, 38, 38, 0.3)',
                color: '#dc2626',
              })
              .html(`âŒ æ¸…é™¤ç¼“å­˜æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`)
              .fadeIn(200);
          }
        }

        setupConsoleCommands() {
          try {
            ((window.teresenDebug = {
              showAllVariables: () => this.showAllVariables(),

              showTrainerStatus: () => this.showTrainerStatus(),

              showUmaStatus: () => this.showUmaStatus(),

              showWorldInfo: () => this.showWorldInfo(),

              showRules: () => this.showRules(),

              help: () => this.showConsoleHelp(),

              toggleItemDetails: e => this.toggleItemDetails(e),

              toggleRules: e => this.toggleRules(e),

              toggleUmaSection: () => this.toggleUmaSection(),

              checkCrystals: () => this.checkCrystals(),

              // æ–°å¤©èµ‹ç³»ç»Ÿ

              showTalentsModal: () => this.showTalentsModal(),

              switchTalentPage: page => this.switchTalentPage(page),

              prevTalentPage: () => this.prevTalentPage(),

              nextTalentPage: () => this.nextTalentPage(),

              selectTalentOption: (level, optionIndex) => this.selectTalentOption(level, optionIndex),

              testMvuInjection: () => this.testMvuInjection(),

              checkMvuStatus: () => this.checkMvuStatus(),

              showItemPopup: (e, t) => this.showItemPopup(e, t),

              loadLocalSave: () => this.loadLocalSave(),

              loadWorldbookSave: e => this.loadWorldbookSave(e),

              loadAutoSave: e => this.loadAutoSave(e),

              triggerQTE: e => this.triggerQTE(e),

              updateQTESection: () => this.updateQTESection(),

              manualCheckQTE: () => this.manualCheckQTE(),

              startReplyTiming: () => this.startReplyTiming(),

              endReplyTimer: () => this.endReplyTimer(),

              debugSaves: () => this.debugSaves(),

              debugCommands: () => this.debugCommands(),

              debugAutoSaves: () => this.debugAutoSaves(),

              // è§„åˆ™è®°å½•åŠŸèƒ½
              addRule: index => this.addRule(),
              editRule: index => this.editRule(index),
              deleteRule: index => this.deleteRule(index),
              clearAllRules: () => this.clearAllRules(),
              getUserRules: () => this.getUserRules(),

              // é©¬å¨˜è®°åå†ŒåŠŸèƒ½
              openUmaRoster: () => this.openUmaRoster(),
              addUmaToRoster: umaName => this.addUmaToRoster(umaName),
              getUmaRoster: () => this.getUmaRoster(),

              // çŠ¶æ€åˆ¤å®šåŠ¨ç”»ç³»ç»Ÿ
              checkStatusTriggers: () => this.checkStatusTriggers(),
              triggerStatusAnimation: (stamina, sanity) => this.triggerStatusAnimation(stamina, sanity),

              // å¡”ç½—å åœç³»ç»Ÿé€šè¿‡TarotDivinationSystemç±»è‡ªåŠ¨ç»‘å®šï¼Œæ— éœ€é¢å¤–æ¥å£

              // æµ‹è¯•åŠŸèƒ½
              testTarotDivination: () => this.testTarotDivination(),

              // ğŸ”¥ å…¨å±å¼¹çª—ï¼ˆæ›¿ä»£ alert/confirmï¼‰
              showFullscreenAlert: (message, options) => this.showFullscreenAlert(message, options),
              showFullscreenConfirm: (message, options) => this.showFullscreenConfirm(message, options),

              // ğŸ”¥ å¿«æ·åŠŸèƒ½
              executeQuickAction: (actionType, characterName, characterId) =>
                this.executeQuickAction(actionType, characterName, characterId),
              cancelQuickActionSelection: () => this.cancelQuickActionSelection(),
            }),
              console.log('ğŸ® ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆè°ƒè¯•å‘½ä»¤å·²åŠ è½½ï¼'),
              console.log('ğŸ’¡ è¾“å…¥ teresenDebug.help() æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤'),
              console.log('ğŸ” è°ƒè¯•å¯¹è±¡:', window.teresenDebug));
          } catch (e) {
            console.error('âŒ è®¾ç½®æ§åˆ¶å°å‘½ä»¤æ—¶å‡ºé”™:', e);
          }
        }

        showAllVariables() {
          const e = this.getAllVariables();

          (console.group('ğŸ“Š æ‰€æœ‰å˜é‡ä¿¡æ¯'),
            console.log('å®Œæ•´å˜é‡å¯¹è±¡:', e),
            e.stat_data
              ? (console.group('ğŸƒ è®­ç»ƒå‘˜ä¿¡æ¯'),
                console.table(e.stat_data.è®­ç»ƒå‘˜),
                console.groupEnd(),
                console.group('ğŸŒ ä¸–ç•Œä¿¡æ¯'),
                console.table(e.stat_data.ä¸–ç•Œ),
                console.groupEnd(),
                console.group('ğŸ èµ›é©¬å¨˜ä¿¡æ¯'),
                console.table(e.stat_data.é©¬å¨˜),
                console.groupEnd(),
                e.stat_data.è§„åˆ™ && (console.group('ğŸ“œ è§„åˆ™ä¿¡æ¯'), console.table(e.stat_data.è§„åˆ™), console.groupEnd()),
                e.stat_data.å¤–ç¥ && (console.group('ğŸ‘¹ å¤–ç¥ä¿¡æ¯'), console.table(e.stat_data.å¤–ç¥), console.groupEnd()))
              : console.warn('âš ï¸ æœªæ‰¾åˆ°stat_dataç»“æ„'),
            console.groupEnd());
        }

        showTrainerStatus() {
          var e;

          const t = this.getAllVariables();

          (console.group('ğŸƒ è®­ç»ƒå‘˜çŠ¶æ€è¯¦æƒ…'),
            (null == (e = t.stat_data) ? void 0 : e.è®­ç»ƒå‘˜)
              ? (t.stat_data.è®­ç»ƒå‘˜,
                console.log('ä½“åŠ›:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ä½“åŠ›', 'N/A')),
                console.log('ç†æ™º:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º', 'N/A')),
                console.log('è¿æ°”:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.è¿æ°”', 'N/A')),
                console.log('ä½ç½®:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ä½ç½®', 'N/A')),
                console.log('åœ¨æ ¡å¤©æ•°:', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', 'N/A')),
                console.log('ç‰©å“æ :', this.getVariable(t, 'stat_data.è®­ç»ƒå‘˜.ç‰©å“æ ', 'N/A')))
              : console.warn('âš ï¸ æœªæ‰¾åˆ°è®­ç»ƒå‘˜æ•°æ®'),
            console.groupEnd());
        }

        showUmaStatus() {
          const e = this.getAllVariables();

          console.group('ğŸ èµ›é©¬å¨˜çŠ¶æ€è¯¦æƒ…');

          (['ä¸œæµ·å¸ç‹', 'çˆ±å¦‚å¾€æ˜”', 'ç‰¹åˆ«å‘¨', 'æ— å£°é“ƒé¹¿', 'ç¦æ¥', 'çˆ±ä¸½é€Ÿå­'].forEach(t => {
            console.group(`${t} çŠ¶æ€`);

            const n = this.getVariable(e, `stat_data.é©¬å¨˜.${t}.å¥½æ„Ÿåº¦`, 'N/A'),
              s = this.getVariable(e, `stat_data.é©¬å¨˜.${t}.çŠ¶æ€`, 'N/A');

            (console.log('å¥½æ„Ÿåº¦:', n),
              console.log('çŠ¶æ€:', s),
              console.log('æè¿°:', this.getUmaDescription(t, Number(n) || 0, s)),
              console.groupEnd());
          }),
            console.groupEnd());
        }

        showWorldInfo() {
          var e;

          const t = this.getAllVariables();

          (console.group('ğŸŒ ä¸–ç•Œä¿¡æ¯è¯¦æƒ…'),
            (null == (e = t.stat_data) ? void 0 : e.ä¸–ç•Œ)
              ? (console.log('å½“å‰æ—¶é—´:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¶é—´', 'N/A')),
                console.log('å½“å‰æ—¥æœŸ:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ—¥æœŸ', 'N/A')),
                console.log('å½“å‰æ­£æ–‡:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.å½“å‰æ­£æ–‡', 'N/A')),
                console.log('ç¦å¿Œè§„åˆ™:', this.getVariable(t, 'stat_data.ä¸–ç•Œ.ç¦å¿Œè§„åˆ™', 'N/A')))
              : console.warn('âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œæ•°æ®'),
            console.groupEnd());
        }

        // é©¬å¨˜è®°åå†ŒåŠŸèƒ½å®ç°
        openUmaRoster() {
          if (window.umaRosterSystem) {
            window.umaRosterSystem.openUmaRoster();
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
          }
        }

        addUmaToRoster(umaName, details = {}) {
          if (window.umaRosterSystem) {
            return window.umaRosterSystem.addUmaToRoster(umaName, details);
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
            return false;
          }
        }

        getUmaRoster() {
          if (window.umaRosterSystem) {
            return window.umaRosterSystem.getUmaRoster();
          } else {
            console.error('é©¬å¨˜è®°åå†Œç³»ç»Ÿæœªåˆå§‹åŒ–');
            return {};
          }
        }

        showRules() {
          var e;

          const t = this.getAllVariables();

          if ((console.group('ğŸ“œ è§„åˆ™ä¿¡æ¯è¯¦æƒ…'), null == (e = t.stat_data) ? void 0 : e.è§„åˆ™)) {
            console.group('å›ºå®šè§„åˆ™');

            const e = this.getVariable(t, 'stat_data.è§„åˆ™.å›ºå®šè§„åˆ™', []);

            (Array.isArray(e) &&
              e.forEach((e, t) => {
                console.log(`${t + 1}. ${e}`);
              }),
              console.groupEnd(),
              console.group('éšæœºè§„åˆ™'));

            const n = this.getVariable(t, 'stat_data.è§„åˆ™.éšæœºè§„åˆ™', []);

            (Array.isArray(n) &&
              n.forEach((e, t) => {
                console.log(`${t + 1}. ${e}`);
              }),
              console.groupEnd(),
              console.log('è¿åæ¬¡æ•°:', this.getVariable(t, 'stat_data.è§„åˆ™.è¿åæ¬¡æ•°', 'N/A')));
          } else console.warn('âš ï¸ æœªæ‰¾åˆ°è§„åˆ™æ•°æ®');

          console.groupEnd();
        }

        updateLocation() {}

        updateGachaCoin() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.æ‰­è›‹å¸', 0),
            n = document.getElementById('gacha-coin-text'),
            profileGacha = document.getElementById('profile-gacha-coin');

          n && (n.textContent = `æ‰­è›‹å¸: ${t}`);

          profileGacha && (profileGacha.textContent = t.toString());
        }

        updateJourneyModal() {
          const e = this.getAllVariables(),
            t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å†ç¨‹', []),
            n = document.getElementById('journey-list-modal');

          if (n)
            if (Array.isArray(t) && t.length > 0) {
              let e = '';

              (t.forEach((t, n) => {
                e += `\n            <div class="journey-entry">\n              <div class="journey-header">\n                <span class="journey-day">ç¬¬${t.å¤©æ•° || n + 1}å¤©</span>\n                <span class="journey-status ${t.çŠ¶æ€ || 'normal'}">${t.çŠ¶æ€ || 'æ­£å¸¸'}</span>\n              </div>\n              <div class="journey-event">${t.äº‹ä»¶ || 'æœªçŸ¥äº‹ä»¶'}</div>\n              <div class="journey-desc">${t.æè¿° || 'æš‚æ— æè¿°'}</div>\n            </div>\n          `;
              }),
                (n.innerHTML = e));
            } else n.innerHTML = '<div class="empty-inventory">æš‚æ— å†ç¨‹è®°å½•</div>';
        }

        setupLoadModal() {
          ($('#close-load-btn').on('click', () => {
            $('#load-modal').hide();
          }),
            $('#load-modal').on('click', e => {
              e.target === e.currentTarget && $('#load-modal').hide();
            }));

          // ğŸ”¥ æ‹¦æˆª load-modal çš„æ˜¾ç¤ºï¼Œç¡®ä¿åœ¨å…¨å±æ—¶ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          const self = this;
          const originalShow = $.fn.show;
          $.fn.show = function (...args) {
            const result = originalShow.apply(this, args);
            if (this.is('#load-modal')) {
              const modal = document.getElementById('load-modal');
              self.ensureModalInOverlay(modal);
            }
            return result;
          };
        }

        setupHistoryModal() {
          ($('#close-history-btn').on('click', () => {
            $('#history-modal').hide();
          }),
            $('#history-modal').on('click', e => {
              e.target === e.currentTarget && $('#history-modal').hide();
            }));
        }

        async updateLoadModal() {
          try {
            console.log('ğŸ’¾ æ›´æ–°å­˜æ¡£ç•Œé¢...');

            const localSavesList = document.getElementById('local-saves-list');

            const worldbookSavesList = document.getElementById('worldbook-saves-list');

            // 1. æ›´æ–°æœ¬åœ°å­˜æ¡£åˆ—è¡¨

            if (localSavesList) {
              let localSaveHtml = '';

              // æ˜¾ç¤ºæ‰‹åŠ¨æœ¬åœ°å­˜æ¡£

              const localSave = localStorage.getItem('teresen-save');

              if (localSave) {
                try {
                  const saveData = JSON.parse(localSave);

                  localSaveHtml += `

                    <div class="save-item manual-save-item" onclick="window.teresenDebug.loadLocalSave()">

                      <div class="save-name">${saveData.saveName || 'æœ¬åœ°å­˜æ¡£'}</div>

                      <div class="save-time">${new Date(saveData.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">æ‰‹åŠ¨å­˜æ¡£</div>

                    </div>

                  `;
                } catch (error) {
                  console.warn('è§£ææœ¬åœ°å­˜æ¡£å¤±è´¥:', error);
                }
              }

              // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£

              const autoSaves = this.getAutoSaves();

              console.log('æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£:', autoSaves.length, 'ä¸ª');

              if (autoSaves.length > 0) {
                autoSaves.forEach(save => {
                  // æå–<content></content>æ ‡ç­¾å†…çš„å†…å®¹ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬

                  let displayContent = 'è‡ªåŠ¨å­˜æ¡£';

                  if (save.data.message_content) {
                    const contentMatch = save.data.message_content.match(/<content>(.*?)<\/content>/s);

                    if (contentMatch) {
                      displayContent =
                        contentMatch[1].trim().substring(0, 50) + (contentMatch[1].length > 50 ? '...' : '');
                    } else {
                      displayContent =
                        save.data.message_content.substring(0, 50) +
                        (save.data.message_content.length > 50 ? '...' : '');
                    }
                  }

                  localSaveHtml += `

                    <div class="save-item auto-save-item" onclick="window.teresenDebug.loadAutoSave('${save.key}')">

                      <div class="save-name">${save.data.save_name || 'è‡ªåŠ¨å­˜æ¡£'}</div>

                      <div class="save-content">${displayContent}</div>

                      <div class="save-time">${new Date(save.data.timestamp).toLocaleString('zh-CN')}</div>

                      <div class="save-type">è‡ªåŠ¨å­˜æ¡£</div>

                    </div>

                  `;
                });
              }

              localSavesList.innerHTML = localSaveHtml || '<div class="empty-save">æš‚æ— æœ¬åœ°å­˜æ¡£</div>';

              console.log('æœ¬åœ°å­˜æ¡£åˆ—è¡¨å·²æ›´æ–°');
            }

            // 2. æ›´æ–°ä¸–ç•Œä¹¦å­˜æ¡£åˆ—è¡¨

            if (worldbookSavesList) {
              const worldbookEntries = await this.getWorldbookEntries();

              let worldbookHtml = '';

              if (worldbookEntries && worldbookEntries.length > 0) {
                worldbookEntries.forEach(entry => {
                  if (entry.title && entry.title.includes('å­˜æ¡£')) {
                    worldbookHtml += `

                      <div class="save-item worldbook-save-item" onclick="window.teresenDebug.loadWorldbookSave('${entry.title}')">

                        <div class="save-name">${entry.title}</div>

                        <div class="save-time">${entry.content ? new Date(entry.content).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}</div>

                        <div class="save-type">ä¸–ç•Œä¹¦å­˜æ¡£</div>

                      </div>

                    `;
                  }
                });
              }

              worldbookSavesList.innerHTML = worldbookHtml || '<div class="empty-save">æš‚æ— ä¸–ç•Œä¹¦å­˜æ¡£</div>';

              console.log('ä¸–ç•Œä¹¦å­˜æ¡£åˆ—è¡¨å·²æ›´æ–°');
            }

            // 3. è®¾ç½®å­˜æ¡£æŒ‰é’®ï¼ˆåªè®¾ç½®ä¸€æ¬¡ï¼‰

            this.setupSaveButtons();
          } catch (error) {
            console.error('âŒ æ›´æ–°å­˜æ¡£ç•Œé¢å¤±è´¥:', error);
          }
        }

        // è®¾ç½®å­˜æ¡£æŒ‰é’®ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰

        setupSaveButtons() {
          try {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æŒ‰é’®

            const existingButtons = document.querySelectorAll('.save-button');

            if (existingButtons.length > 0) {
              console.log('å­˜æ¡£æŒ‰é’®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');

              return;
            }

            const loadSection = document.querySelector('.load-section');

            if (!loadSection) {
              console.warn('æœªæ‰¾åˆ°å­˜æ¡£åŒºåŸŸ');

              return;
            }

            // åˆ›å»ºæœ¬åœ°å­˜æ¡£æŒ‰é’®

            const localSaveBtn = document.createElement('button');

            localSaveBtn.className = 'save-button subtle-hover';

            localSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>ä¿å­˜åˆ°æœ¬åœ°</span>

            `;

            localSaveBtn.onclick = () => this.handleSave('local');

            // åˆ›å»ºä¸–ç•Œä¹¦å­˜æ¡£æŒ‰é’®

            const worldbookSaveBtn = document.createElement('button');

            worldbookSaveBtn.className = 'save-button subtle-hover';

            worldbookSaveBtn.innerHTML = `

              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">

                <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h-1v5.586l-2.293-2.293z" />

              </svg>

              <span>ä¿å­˜åˆ°ä¸–ç•Œä¹¦</span>

            `;

            worldbookSaveBtn.onclick = () => this.handleSave('worldbook');

            // åˆ›å»ºæŒ‰é’®å®¹å™¨

            const buttonContainer = document.createElement('div');

            buttonContainer.style.cssText = 'margin-top: 1rem; display: flex; gap: 0.5rem;';

            buttonContainer.appendChild(localSaveBtn);

            buttonContainer.appendChild(worldbookSaveBtn);

            loadSection.appendChild(buttonContainer);

            console.log('å­˜æ¡£æŒ‰é’®å·²åˆ›å»º');
          } catch (error) {
            console.error('è®¾ç½®å­˜æ¡£æŒ‰é’®å¤±è´¥:', error);
          }
        }

        async updateHistoryModal() {
          try {
            const e = document.getElementById('current-journey-list');

            if (e) {
              const t = await this.getWorldbookEntries();

              let n = '';

              (t &&
                t.length > 0 &&
                t.forEach(e => {
                  if (e.title && e.title.includes('ä¸ªäººå†ç¨‹'))
                    try {
                      const t = JSON.parse(e.content || '[]');

                      Array.isArray(t) &&
                        t.forEach((e, t) => {
                          n += `\n                      <div class="journey-entry">\n                        <div class="journey-header">\n                          <span class="journey-day">ç¬¬${e.å¤©æ•° || t + 1}å¤©</span>\n                          <span class="journey-status ${e.çŠ¶æ€ || 'normal'}">${e.çŠ¶æ€ || 'æ­£å¸¸'}</span>\n                        </div>\n                        <div class="journey-event">${e.äº‹ä»¶ || 'æœªçŸ¥äº‹ä»¶'}</div>\n                        <div class="journey-desc">${e.æè¿° || 'æš‚æ— æè¿°'}</div>\n                      </div>\n                    `;
                        });
                    } catch (t) {
                      console.warn('è§£æä¸ªäººå†ç¨‹æ•°æ®å¤±è´¥:', t);
                    }
                }),
                (e.innerHTML = n || '<div class="empty-journey">æš‚æ— äººç‰©å†ç¨‹</div>'));
            }
          } catch (e) {
            console.error('âŒ æ›´æ–°å†å²è®°å½•ç•Œé¢å¤±è´¥:', e);
          }
        }

        async saveToWorldbook(e) {
          try {
            if ('undefined' != typeof TavernHelper && TavernHelper.createLorebookEntries) {
              const t = {
                title: e.saveName,

                content: e.timestamp,

                category: 'å­˜æ¡£',

                keywords: ['å­˜æ¡£', 'ç‰¹é›·æ£®', 'è®­ç»ƒå‘˜'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: JSON.stringify(e),
              };

              (await TavernHelper.createLorebookEntries([t]), console.log('âœ… å­˜æ¡£å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦'));
            }
          } catch (t) {
            console.error('âŒ ä¿å­˜åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', t);
          }
        }

        async saveJourneyToWorldbook() {
          try {
            const e = this.getAllVariables(),
              t = this.getVariable(e, 'stat_data.è®­ç»ƒå‘˜.å†ç¨‹', []);

            if (
              Array.isArray(t) &&
              t.length > 0 &&
              'undefined' != typeof TavernHelper &&
              TavernHelper.createLorebookEntries
            ) {
              const e = {
                title: 'ä¸ªäººå†ç¨‹',

                content: JSON.stringify(t),

                category: 'å†ç¨‹',

                keywords: ['å†ç¨‹', 'ç‰¹é›·æ£®', 'è®­ç»ƒå‘˜', 'ä¸ªäººå†ç¨‹'],

                force_activation: !1,

                selective: !1,

                display_index: 0,

                probability: 100,

                exclude_recursion: !1,

                use_extra: !1,

                extra: '',
              };

              (await TavernHelper.createLorebookEntries([e]), console.log('âœ… äººç‰©å†ç¨‹å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦'));
            }
          } catch (e) {
            console.error('âŒ ä¿å­˜äººç‰©å†ç¨‹åˆ°ä¸–ç•Œä¹¦å¤±è´¥:', e);
          }
        }

        async getWorldbookEntries() {
          try {
            return 'undefined' != typeof TavernHelper && TavernHelper.getLorebookEntries
              ? await TavernHelper.getLorebookEntries()
              : [];
          } catch (e) {
            return (console.error('âŒ è·å–ä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥:', e), []);
          }
        }

        // ğŸ”¥ å­˜æ¡£åŠŸèƒ½å·²åˆ é™¤
        async loadLocalSave_DELETED() {
          try {
            console.log('ğŸ“‚ åŠ è½½æœ¬åœ°å­˜æ¡£...');

            const saveData = localStorage.getItem('teresen-save');

            if (!saveData) {
              throw new Error('æœ¬åœ°å­˜æ¡£ä¸å­˜åœ¨');
            }

            const save = JSON.parse(saveData);

            console.log('æœ¬åœ°å­˜æ¡£æ•°æ®:', save);

            // æ¢å¤æ¸¸æˆçŠ¶æ€

            if (save.data && save.data.variables && 'function' == typeof eventEmit) {
              // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
              this.currentMvuState = save.data.variables;
              this.renderUI(this.currentMvuState.stat_data);

              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');
            }

            // æ¢å¤èŠå¤©å†å²
            // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„saveStateï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
            if (
              save.data &&
              save.data.message &&
              typeof SillyTavern !== 'undefined' &&
              SillyTavern.chat &&
              SillyTavern.chat.length > 0
            ) {
              const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
              if (!lastMessage.extra) {
                lastMessage.extra = {};
              }

              // ğŸ”¥ è¯»æ¡£æ—¶æ¢å¤æ¶ˆæ¯åˆ°extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯çš„messageå­—æ®µ
              // å‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼Œåªä¿å­˜åˆ°extraï¼Œä¸æ›´æ–°message
              if (save.data.chat_history && Array.isArray(save.data.chat_history)) {
                // å¦‚æœæœ‰å®Œæ•´çš„èŠå¤©å†å²ï¼Œæ¢å¤åˆ°extra.teresen_chat
                lastMessage.extra.teresen_chat = JSON.parse(JSON.stringify(save.data.chat_history));

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('âœ… èŠå¤©å†å²å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chat');
                } else {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('âœ… èŠå¤©å†å²å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                }
              } else if (save.data.message) {
                // å¦‚æœåªæœ‰å•æ¡æ¶ˆæ¯ï¼Œåˆ›å»ºèŠå¤©å†å²æ•°ç»„
                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: save.data.message,
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: save.data.variables || null,
                  },
                ];

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chat');
                } else {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                }
              }
            }

            await this.updateInterface();

            $('#load-modal').hide();

            console.log('âœ… æœ¬åœ°å­˜æ¡£åŠ è½½æˆåŠŸ');

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('æœ¬åœ°å­˜æ¡£åŠ è½½æˆåŠŸï¼');
            }
          } catch (error) {
            console.error('âŒ è¯»å–æœ¬åœ°å­˜æ¡£å¤±è´¥:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('è¯»å–å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        async loadWorldbookSave(e) {
          try {
            const t = (await this.getWorldbookEntries()).find(t => t.title === e);

            if (t && t.extra) {
              const e = JSON.parse(t.extra);

              (await this.loadSaveData(e), $('#load-modal').hide());
            }
          } catch (t) {
            (console.error('âŒ è¯»å–ä¸–ç•Œä¹¦å­˜æ¡£å¤±è´¥:', t),
              typeof showTemporaryMessage === 'function' && showTemporaryMessage('è¯»å–å­˜æ¡£å¤±è´¥ï¼'));
          }
        }

        // ğŸ”¥ å­˜æ¡£åŠŸèƒ½å·²åˆ é™¤
        async loadSaveData_DELETED(e) {
          try {
            // ğŸ”¥ æ¢å¤å˜é‡çŠ¶æ€
            if (e.variables && 'function' == typeof eventEmit) {
              eventEmit('mag_invoke_mvu');
              console.log('âœ… MVUå˜é‡å·²æ›´æ–°');
            }

            // ğŸ”¥ æ¢å¤èŠå¤©å†å²åˆ°extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
            if (e.message || (e.timeline_history && Array.isArray(e.timeline_history))) {
              if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
                console.warn('âš ï¸ SillyTavern.chatä¸ºç©ºï¼Œæ— æ³•æ¢å¤èŠå¤©å†å²');
              } else {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }

                // å¦‚æœæœ‰timeline_historyï¼Œè½¬æ¢ä¸ºteresen_chatæ ¼å¼
                if (e.timeline_history && Array.isArray(e.timeline_history) && e.timeline_history.length > 0) {
                  lastMessage.extra.teresen_chat = e.timeline_history.map(snapshot => ({
                    role: 'assistant',
                    content: snapshot.message || '',
                    id: snapshot.message_id || `snapshot_${Date.now()}`,
                    timestamp: snapshot.timestamp || Date.now(),
                    variableState: snapshot.data || null,
                  }));
                } else if (e.message) {
                  // å…¼å®¹æ—§æ ¼å¼ï¼šåªæœ‰å•æ¡æ¶ˆæ¯
                  lastMessage.extra.teresen_chat = [
                    {
                      role: 'assistant',
                      content: e.message,
                      id: 'load_' + Date.now(),
                      timestamp: Date.now(),
                      variableState: e.variables || null,
                    },
                  ];
                }

                // ä¿å­˜åˆ°extra.teresen_chat
                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('âœ… èŠå¤©å†å²å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chat');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('âœ… èŠå¤©å†å²å·²æ¢å¤åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                }
              }
            }

            await this.updateInterface();
            console.log('âœ… å­˜æ¡£åŠ è½½æˆåŠŸ');
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('å­˜æ¡£åŠ è½½æˆåŠŸï¼');
            }
          } catch (t) {
            console.error('âŒ åŠ è½½å­˜æ¡£æ•°æ®å¤±è´¥:', t);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('åŠ è½½å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        // æ–°å¢ï¼šAIå›å¤åè‡ªåŠ¨å­˜æ¡£ï¼ˆä¿®å¤ç‰ˆï¼šä¿å­˜å®Œæ•´èŠå¤©å†å²ï¼‰

        async autoSaveAfterAIResponse(aiResponse, userInput) {
          try {
            console.log('ğŸ’¾ å¼€å§‹è‡ªåŠ¨å­˜æ¡£AIå›å¤...');

            const currentVariables = this.getAllVariables();

            // ğŸ”§ ä¿®å¤ï¼šè·å–å®Œæ•´çš„èŠå¤©å†å²è®°å½•ï¼ˆæ‰€æœ‰æ¶ˆæ¯ï¼‰

            let fullChatHistory = [];

            if (typeof getChatMessages === 'function') {
              try {
                // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨getCurrentMessageId()è·å–å½“å‰æ¶ˆæ¯IDï¼Œç„¶åè·å–æ‰€æœ‰æ¶ˆæ¯

                let allChatMessages = null;

                // æ–¹æ¡ˆ1ï¼šå°è¯•ä½¿ç”¨getCurrentMessageId()è·å–å®Œæ•´èŠå¤©å†å²

                if (typeof getCurrentMessageId === 'function') {
                  try {
                    const currentId = getCurrentMessageId();

                    allChatMessages = await getChatMessages(currentId);

                    console.log('ğŸ“š é€šè¿‡getCurrentMessageIdè·å–èŠå¤©å†å²:', allChatMessages?.length || 0, 'æ¡æ¶ˆæ¯');
                  } catch (e) {
                    console.warn('âš ï¸ getCurrentMessageIdæ–¹æ³•å¤±è´¥:', e);
                  }
                }

                // æ–¹æ¡ˆ2ï¼šç›´æ¥è°ƒç”¨getChatMessages()ä½œä¸ºå¤‡ç”¨

                if (!allChatMessages || !Array.isArray(allChatMessages) || allChatMessages.length === 0) {
                  allChatMessages = await getChatMessages();

                  console.log('ğŸ“š é€šè¿‡ç›´æ¥è°ƒç”¨è·å–èŠå¤©å†å²:', allChatMessages?.length || 0, 'æ¡æ¶ˆæ¯');
                }

                // å¤„ç†è·å–åˆ°çš„æ¶ˆæ¯

                if (allChatMessages && Array.isArray(allChatMessages) && allChatMessages.length > 0) {
                  fullChatHistory = allChatMessages.map(msg => ({
                    message: msg.message || '',

                    role: msg.role || 'unknown',

                    data: msg.data || null,

                    timestamp: msg.timestamp || Date.now(),
                  }));

                  console.log('âœ… æˆåŠŸè·å–å®Œæ•´èŠå¤©å†å²:', fullChatHistory.length, 'æ¡æ¶ˆæ¯');
                } else {
                  console.warn('âš ï¸ æœªèƒ½è·å–åˆ°æœ‰æ•ˆçš„èŠå¤©æ¶ˆæ¯ï¼Œä½¿ç”¨ç©ºæ•°ç»„');

                  fullChatHistory = [];
                }
              } catch (chatError) {
                console.error('âŒ è·å–èŠå¤©å†å²å¤±è´¥:', chatError);

                fullChatHistory = [];
              }
            } else {
              console.warn('âš ï¸ getChatMessageså‡½æ•°ä¸å¯ç”¨');

              fullChatHistory = [];
            }

            // ğŸ”§ ä¿®å¤ï¼šè·å–æœ€åä¸€æ¡AIæ¶ˆæ¯ä½œä¸ºå½“å‰æ¶ˆæ¯

            let currentMessage = '';

            if (fullChatHistory && fullChatHistory.length > 0) {
              // ä»åå¾€å‰æ‰¾æœ€åä¸€æ¡AIæ¶ˆæ¯

              const lastAiMessage = [...fullChatHistory].reverse().find(msg => msg.role === 'assistant');

              currentMessage = lastAiMessage
                ? lastAiMessage.message
                : fullChatHistory[fullChatHistory.length - 1].message;
            }

            // ğŸ”¥ è¯»å–å½“å‰ä¸–ç•Œä¹¦å†…å®¹
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const baseJourneyKey = this._getBaseJourneyKey();
            const baseCoreKey = this._getBaseCoreMemoryKey();
            let journeyContent = '';
            let coreMemoryContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);
              journeyContent = journeyEntry?.content || '';
              coreMemoryContent = coreEntry?.content || '';
            } catch (e) {
              console.warn('è¯»å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
            }

            const timestamp = Date.now();

            const saveData = {
              timestamp: timestamp,

              save_name: `è‡ªåŠ¨å­˜æ¡£_${new Date().toLocaleString('zh-CN')}`,

              timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), // ğŸ”¥ ä½¿ç”¨å›åˆå¿«ç…§æ•°ç»„

              snapshot_data: {
                mvu_data: currentVariables,

                lorebook_content: {
                  journey: journeyContent,

                  core_memory: coreMemoryContent,
                },
              },

              type: 'auto',

              version: '2.0', // æ ‡è®°ä¸ºæ–°ç‰ˆæœ¬å­˜æ¡£æ ¼å¼
            };

            // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºkeyï¼Œä¿å­˜å¤šä¸ªè‡ªåŠ¨å­˜æ¡£

            const saveKey = `teresen-auto-save-${timestamp}`;

            localStorage.setItem(saveKey, JSON.stringify(saveData));

            // åŒæ—¶ä¿å­˜æœ€æ–°çš„è‡ªåŠ¨å­˜æ¡£å¼•ç”¨

            localStorage.setItem('teresen_auto_save', JSON.stringify(saveData));

            console.log('âœ… è‡ªåŠ¨å­˜æ¡£æˆåŠŸï¼ˆåŒ…å«', fullChatHistory ? fullChatHistory.length : 0, 'æ¡å†å²æ¶ˆæ¯ï¼‰');

            // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥

            this.showAutoSaveNotification();

            // æ¸…ç†æ—§çš„è‡ªåŠ¨å­˜æ¡£ï¼ˆä¿ç•™æœ€æ–°çš„10ä¸ªï¼‰

            this.cleanupOldAutoSaves();

            // ä¿å­˜æœ€åå‘é€çš„æŒ‡ä»¤ï¼Œç”¨äºé‡æ–°ç”Ÿæˆ

            this.lastSentPrompt = userInput;
          } catch (error) {
            console.error('âŒ è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            throw error;
          }
        }

        // æ¸…ç†æ—§çš„è‡ªåŠ¨å­˜æ¡£

        cleanupOldAutoSaves() {
          try {
            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£...');

            const autoSaveKeys = [];

            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {
                autoSaveKeys.push(key);
              }
            }

            console.log(`ğŸ“Š æ‰¾åˆ° ${autoSaveKeys.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

            // åªæœ‰å½“å­˜æ¡£æ•°é‡è¶…è¿‡15ä¸ªæ—¶æ‰æ¸…ç†

            if (autoSaveKeys.length > 15) {
              // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„10ä¸ª

              autoSaveKeys.sort().reverse();

              const keysToRemove = autoSaveKeys.slice(10);

              console.log(`ğŸ—‘ï¸ éœ€è¦æ¸…ç† ${keysToRemove.length} ä¸ªæ—§å­˜æ¡£`);

              keysToRemove.forEach(key => {
                localStorage.removeItem(key);

                console.log('ğŸ—‘ï¸ æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£:', key);
              });
            } else {
              console.log('âœ… è‡ªåŠ¨å­˜æ¡£æ•°é‡æ­£å¸¸ï¼Œæ— éœ€æ¸…ç†');
            }
          } catch (error) {
            console.warn('æ¸…ç†æ—§è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);
          }
        }

        // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥

        showAutoSaveNotification() {
          try {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 

            const notification = document.createElement('div');

            notification.id = 'auto-save-notification';

            notification.innerHTML = 'ğŸ’¾ Eå®å·²ä¸ºæ‚¨è‡ªåŠ¨å­˜æ¡£';

            notification.style.cssText = `

              position: fixed;

              top: 20px;

              right: 20px;

              background: rgba(34, 197, 94, 0.9);

              color: white;

              padding: 8px 16px;

              border-radius: 6px;

              font-size: 12px;

              font-weight: bold;

              z-index: 10000;

              opacity: 0;

              transform: translateX(100%);

              transition: all 0.3s ease;

              pointer-events: none;

            `;

            document.body.appendChild(notification);

            // æ˜¾ç¤ºåŠ¨ç”»

            setTimeout(() => {
              notification.style.opacity = '1';

              notification.style.transform = 'translateX(0)';
            }, 100);

            // 3ç§’åéšè—

            setTimeout(() => {
              notification.style.opacity = '0';

              notification.style.transform = 'translateX(100%)';

              setTimeout(() => {
                if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
                }
              }, 300);
            }, 3000);
          } catch (error) {
            console.warn('æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£é€šçŸ¥å¤±è´¥:', error);
          }
        }

        // æ£€æµ‹AIå›å¤ä¸­çš„é©¬å¨˜åå­—
        detectUmaInAIResponse(aiResponse) {
          try {
            console.log('ğŸ” å¼€å§‹æ£€æµ‹AIå›å¤ä¸­çš„é©¬å¨˜åå­—...');

            // é©¬å¨˜åå­—åˆ—è¡¨
            const umaNames = [
              'ä¸œæµ·å¸ç‹',
              'çˆ±å¦‚å¾€æ˜”',
              'ç‰¹åˆ«å‘¨',
              'æ— å£°é“ƒé¹¿',
              'ç¦æ¥',
              'çˆ±ä¸½é€Ÿå­',
              'ç›®ç™½å…‰æ˜',
              'ç›®ç™½éº¦æ˜†',
              'ç›®ç™½å–„ä¿¡',
              'ç›®ç™½å¤šä¼¯',
              'ç›®ç™½èµ–æ©',
              'å°æ —å¸½',
              'ç‰è—»åå­—',
              'è¶…çº§å°æµ·æ¹¾',
              'æ¨±èŠ±è¿›ç‹',
              'èƒœåˆ©å¥–åˆ¸',
              'æˆç”°ç™½ä»',
              'çµç¶æ™¨å…‰',
              'é‡ç‚®',
              'æ›¼åŸèŒ¶åº§',
              'å¥½æ­Œå‰§',
              'çˆ±ä¸½æ•°ç ',
              'ç©ºä¸­ç¥å®«',
              'æ˜Ÿäº‘å¤©ç©º',
              'è‰ä¸Šé£',
              'ç¥é¹°',
              'åå°†æ€’æ¶›',
              'ç›®ç™½é›·æ©',
              'ç›®ç™½é˜¿å°”ä¸¹',
              'ç›®ç™½é«˜å³°',
              'å¤§å’Œèµ¤éª¥',
              'ä¼ç‰¹åŠ ',
              'å¤§æ‹“å¤ªé˜³ç¥',
              'é»„é‡‘èˆ¹',
              'é»„é‡‘åŸå¸‚',
              'ä¸­å±±åº†å…¸',
              'ä¸­å±±å…‰è¾‰',
              'ä¸­å±±éª‘å£«',
              'ä¸­å±±è‹±é›„',
              'ç¾æµ¦æ³¢æ—',
              'ç±³æµ´',
              'æ˜¥ä¸½',
              'ä¹Œæ‹‰æ‹‰',
              'å¾…å…¼ç¦æ¥',
              'å¾…å…¼è¯—æ­Œå‰§',
              'è¶…å¸¸éªéª¥',
            ];

            // æ£€æµ‹AIå›å¤ä¸­æ˜¯å¦åŒ…å«é©¬å¨˜åå­—
            const detectedUmas = [];
            umaNames.forEach(umaName => {
              if (aiResponse.includes(umaName)) {
                detectedUmas.push(umaName);
                console.log(`ğŸ æ£€æµ‹åˆ°é©¬å¨˜: ${umaName}`);
              }
            });

            // å°†æ£€æµ‹åˆ°çš„é©¬å¨˜æ·»åŠ åˆ°è®°åå†Œ
            if (detectedUmas.length > 0) {
              detectedUmas.forEach(umaName => {
                if (window.teresenDebug && window.teresenDebug.addUmaToRoster) {
                  window.teresenDebug.addUmaToRoster(umaName, {
                    notes: `åœ¨AIå›å¤ä¸­æ£€æµ‹åˆ°: ${new Date().toLocaleString('zh-CN')}`,
                  });
                }
              });
              console.log(`ğŸ“– å·²å°† ${detectedUmas.length} ä¸ªé©¬å¨˜æ·»åŠ åˆ°è®°åå†Œ`);
            } else {
              console.log('ğŸ” æœªæ£€æµ‹åˆ°é©¬å¨˜åå­—');
            }
          } catch (error) {
            console.error('æ£€æµ‹é©¬å¨˜åå­—å¤±è´¥:', error);
          }
        }

        // è·å–èŠå¤©å†å² - é‡‡ç”¨å¤šé‡ç­–ç•¥ç¡®ä¿è·å–å®Œæ•´è®°å½•

        async getChatHistory() {
          try {
            let allChatHistory = [];

            // ğŸ¯ ä¼˜å…ˆç­–ç•¥ï¼šä»æ•°æ®åº“è·å–å½“å‰å±€æ¬¡çš„èŠå¤©è®°å½•ï¼ˆé¿å…è·¨å±€æ··æ·†ï¼‰
            console.log('ğŸ” å¼€å§‹è·å–å½“å‰å±€æ¬¡èŠå¤©å†å²...');

            // ğŸ¯ ç­–ç•¥1: ä»å­˜æ¡£æ•°æ®åº“è·å–å½“å‰å±€æ¬¡è®°å½•ï¼ˆæ¨èæ–¹å¼ï¼‰
            if (this.currentArchiveName && this.db) {
              try {
                const archive = await this.db.archives.get(this.currentArchiveName);
                if (archive && archive.data && archive.data.logs) {
                  // è¿‡æ»¤å‡ºèŠå¤©è®°å½•ï¼ˆæ’é™¤ç³»ç»Ÿæ¶ˆæ¯å’Œæ€»ç»“ï¼‰
                  const chatLogs = archive.data.logs.filter(
                    log => log.type === 'user' || log.type === 'ai' || log.type === 'assistant',
                  );
                  if (chatLogs.length > 0) {
                    console.log('ğŸ“š ä»å­˜æ¡£æ•°æ®åº“è·å–èŠå¤©å†å²:', chatLogs.length, 'æ¡è®°å½•');
                    allChatHistory.push(...chatLogs);
                  }
                }
              } catch (e) {
                console.warn('âš ï¸ ä»å­˜æ¡£æ•°æ®åº“è·å–å¤±è´¥:', e);
              }
            }

            // ğŸ¯ ç­–ç•¥2: ä½¿ç”¨SillyTavern APIè·å–
            if ('function' == typeof getChatMessages) {
              let allChatMessages = null;

              // æ–¹æ¡ˆ2.1ï¼šå°è¯•ä½¿ç”¨getCurrentMessageId()è·å–å®Œæ•´èŠå¤©å†å²
              if (typeof getCurrentMessageId === 'function') {
                try {
                  const currentId = getCurrentMessageId();
                  allChatMessages = await getChatMessages(currentId);
                  console.log('ğŸ“š é€šè¿‡getCurrentMessageIdè·å–èŠå¤©å†å²:', allChatMessages?.length || 0, 'æ¡æ¶ˆæ¯');
                } catch (e) {
                  console.warn('âš ï¸ getCurrentMessageIdæ–¹æ³•å¤±è´¥:', e);
                }
              }

              // æ–¹æ¡ˆ2.2ï¼šç›´æ¥è°ƒç”¨getChatMessages()ä½œä¸ºå¤‡ç”¨
              if (!allChatMessages || !Array.isArray(allChatMessages) || allChatMessages.length === 0) {
                allChatMessages = await getChatMessages();
                console.log('ğŸ“š é€šè¿‡ç›´æ¥è°ƒç”¨è·å–èŠå¤©å†å²:', allChatMessages?.length || 0, 'æ¡æ¶ˆæ¯');
              }

              if (allChatMessages && Array.isArray(allChatMessages) && allChatMessages.length > 0) {
                allChatHistory.push(...allChatMessages);
                console.log('ğŸ“š ä»SillyTavern APIè·å–èŠå¤©å†å²:', allChatMessages.length, 'æ¡æ¶ˆæ¯');
              }
            }

            // ğŸ¯ ç­–ç•¥3: ä»SillyTavernä¸Šä¸‹æ–‡è·å–
            if (window.SillyTavern && window.SillyTavern.getContext) {
              try {
                const context = window.SillyTavern.getContext();
                if (context && context.chat && context.chat.length > 0) {
                  console.log('ğŸ“š ä»SillyTavernä¸Šä¸‹æ–‡è·å–èŠå¤©å†å²:', context.chat.length, 'æ¡æ¶ˆæ¯');
                  allChatHistory.push(...context.chat);
                }
              } catch (e) {
                console.warn('âš ï¸ SillyTavernä¸Šä¸‹æ–‡è·å–å¤±è´¥:', e);
              }
            }

            // ğŸ¯ ç­–ç•¥4: ä»å…¨å±€å˜é‡è·å–
            if (window.chat && Array.isArray(window.chat) && window.chat.length > 0) {
              console.log('ğŸ“š ä»å…¨å±€å˜é‡è·å–èŠå¤©å†å²:', window.chat.length, 'æ¡æ¶ˆæ¯');
              allChatHistory.push(...window.chat);
            }

            // ğŸ”§ å»é‡å’Œæ’åºå¤„ç†
            if (allChatHistory.length > 0) {
              // æŒ‰æ—¶é—´æˆ³å»é‡ï¼ˆé¿å…é‡å¤è®°å½•ï¼‰
              const uniqueHistory = [];
              const seenMessages = new Set();

              for (const msg of allChatHistory) {
                const content = msg.content || msg.mes || msg.message || '';
                const timestamp = msg.timestamp || msg.send_date || Date.now();
                const key = `${content.slice(0, 100)}_${timestamp}`;

                if (!seenMessages.has(key) && content.trim()) {
                  seenMessages.add(key);
                  uniqueHistory.push(msg);
                }
              }

              // æŒ‰æ—¶é—´æ’åº
              uniqueHistory.sort((a, b) => {
                const timeA = new Date(a.timestamp || a.send_date || 0).getTime();
                const timeB = new Date(b.timestamp || b.send_date || 0).getTime();
                return timeA - timeB;
              });

              console.log('âœ… è·å–å®Œæ•´èŠå¤©å†å²æˆåŠŸ:', uniqueHistory.length, 'æ¡è®°å½•ï¼ˆå»é‡åï¼‰');
              return uniqueHistory;
            }

            console.warn('âš ï¸ æ‰€æœ‰è·å–èŠå¤©å†å²çš„ç­–ç•¥éƒ½å¤±è´¥äº†');
            return [];
          } catch (error) {
            console.warn('è·å–èŠå¤©å†å²å¤±è´¥:', error);

            return [];
          }
        }

        // å‰ç«¯æ£€æµ‹QTEåŠŸèƒ½

        updateQTESection() {
          try {
            // å‰ç«¯æ£€æµ‹QTEè§¦å‘æ¡ä»¶

            const shouldShowQTE = this.detectQTECondition();

            const qteSection = document.getElementById('qte-section');

            if (!qteSection) {
              console.warn('âŒ æ‰¾ä¸åˆ°QTEåŒºåŸŸå…ƒç´ ');

              return;
            }

            if (shouldShowQTE) {
              // æ˜¾ç¤ºQTEåŒºåŸŸ

              qteSection.style.display = 'block';

              // æ›´æ–°æè¿°æ–‡æœ¬

              const description = qteSection.querySelector('.qte-description');

              if (description) {
                description.textContent = 'ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...';
              }

              console.log('ğŸ® QTEåŒºåŸŸå·²æ˜¾ç¤ºï¼ˆå‰ç«¯æ£€æµ‹ï¼‰');
            } else {
              // éšè—QTEåŒºåŸŸ

              qteSection.style.display = 'none';

              console.log('ğŸ® QTEåŒºåŸŸå·²éšè—');
            }
          } catch (error) {
            console.error('âŒ æ›´æ–°QTEåŒºåŸŸå¤±è´¥:', error);
          }
        }

        // æ£€æµ‹QTEè§¦å‘æ¡ä»¶

        detectQTECondition() {
          try {
            // æ£€æŸ¥AIå›å¤å†…å®¹

            const aiText = this.getLastAIText();

            console.log('ğŸ” è·å–åˆ°çš„AIæ–‡æœ¬:', aiText ? aiText.substring(0, 100) + '...' : 'ç©ºæ–‡æœ¬');

            if (aiText && this.containsBindingKeywords(aiText)) {
              console.log('ğŸ” æ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œè§¦å‘QTE');

              return true;
            } else {
              console.log('ğŸ” æœªæ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œä¸è§¦å‘QTE');
            }

            return false;
          } catch (error) {
            console.error('âŒ æ£€æµ‹QTEæ¡ä»¶å¤±è´¥:', error);

            return false;
          }
        }

        // è·å–æœ€åä¸€æ¡AIå›å¤æ–‡æœ¬

        getLastAIText() {
          try {
            // æ–¹æ³•1ï¼šé€šè¿‡TavernHelper API

            if (typeof TavernHelper !== 'undefined' && TavernHelper.getChatMessages) {
              const messages = TavernHelper.getChatMessages();

              const aiMessages = messages.filter(msg => msg.role === 'assistant');

              const lastMessage = aiMessages[aiMessages.length - 1];

              if (lastMessage && lastMessage.content) {
                console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', lastMessage.content.length);

                return lastMessage.content;
              }
            }

            // æ–¹æ³•2ï¼šé€šè¿‡DOMå…ƒç´ æŸ¥æ‰¾

            const aiResponseElements = document.querySelectorAll('.mes_text, .mes_text_ai, .ai-response');

            if (aiResponseElements.length > 0) {
              const lastElement = aiResponseElements[aiResponseElements.length - 1];

              const text = lastElement.textContent || lastElement.innerText || '';

              console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', text.length);

              return text;
            }

            // æ–¹æ³•3ï¼šé€šè¿‡èŠå¤©å®¹å™¨æŸ¥æ‰¾

            const chatContainer = document.querySelector('#chat_container, .chat-container');

            if (chatContainer) {
              const aiMessages = chatContainer.querySelectorAll('.mes_text, .mes_text_ai');

              if (aiMessages.length > 0) {
                const lastMessage = aiMessages[aiMessages.length - 1];

                const text = lastMessage.textContent || lastMessage.innerText || '';

                console.log('ğŸ” è·å–AIæ–‡æœ¬æˆåŠŸï¼Œé•¿åº¦:', text.length);

                return text;
              }
            }

            console.log('ğŸ” è·å–AIæ–‡æœ¬å¤±è´¥');

            return '';
          } catch (error) {
            console.warn('è·å–AIæ–‡æœ¬å¤±è´¥:', error);

            return '';
          }
        }

        // æ‰‹åŠ¨æ£€æµ‹QTEï¼ˆç”¨äºè°ƒè¯•ï¼‰

        manualCheckQTE() {
          console.log('ğŸ” æ‰‹åŠ¨æ£€æµ‹QTE...');

          this.checkQTEFromCurrentContent();
        }

        // ç›´æ¥ä»å½“å‰é¡µé¢å†…å®¹æ£€æµ‹QTE

        checkQTEFromCurrentContent() {
          try {
            // è·å–å½“å‰é¡µé¢çš„AIå›å¤å†…å®¹

            const aiContent =
              $('#chat_container .mes_text_ai').last().text() ||
              $('#chat_container .mes_text').last().text() ||
              $('.ai-response').last().text() ||
              '';

            console.log('ğŸ” å½“å‰AIå†…å®¹é•¿åº¦:', aiContent.length);

            if (aiContent && this.containsBindingKeywords(aiContent)) {
              console.log('ğŸ” æ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œæ˜¾ç¤ºQTE');

              $('#qte-section').show();

              $('#qte-section .qte-description').text('ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼é€‰æ‹©ä½ çš„è¡ŒåŠ¨...');
            } else {
              console.log('ğŸ” æœªæ£€æµ‹åˆ°æŸç¼šå…³é”®è¯ï¼Œéšè—QTE');

              $('#qte-section').hide();
            }
          } catch (error) {
            console.error('âŒ æ£€æµ‹QTEå¤±è´¥:', error);
          }
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«æŸç¼šå…³é”®è¯

        containsBindingKeywords(text) {
          const keywords = [
            // åŸºç¡€æŸç¼šè¯æ±‡

            'æŸç¼š',

            'æŠ±ä½',

            'æŠ“ä½',

            'æ‚ä½',

            'ç´§æŠ±',

            'å›°ä½',

            'å‹åˆ¶',

            'ç¬¼ç½©',

            'ç¦é”¢',

            'é”ä½',

            'ä¾µå ',

            'å¼ºç¡¬',

            'å µä½',

            'å›´ä½',

            'åœˆä½',

            'ç¼ ä½',

            'ç»‘ä½',

            'æŒ‰ä½',

            'å‹ä½',

            'æ‰£ä½',

            'å¤¹ä½',

            'å¡ä½',

            'å¡åœ¨',

            'é™·åœ¨',

            'å›°åœ¨',

            // ç›´æ¥é’ˆå¯¹è®­ç»ƒå‘˜çš„è¯æ±‡

            'æŠŠä½ å‹åœ¨',

            'ä¸å®¹åæŠ—',

            'æ— æ³•æŒ£è„±',

            'æŠŠä½ å›°ä½',

            'æŠŠä½ å‹åˆ¶',

            'ç´§ç´§æŠ±ä½',

            'æŠŠä½ æŠ±ä½',

            'æ‚ä½ä½ ',

            'æŠ“ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹åˆ¶ä½ ',

            'æŠŠä½ é”ä½',

            'æŠŠä½ ä¾µå ',

            'æŠŠä½ å›´ä½',

            'æŠŠä½ åœˆä½',

            'æŠŠä½ ç¼ ä½',

            'æŠŠä½ ç»‘ä½',

            'æŠŠä½ æŒ‰ä½',

            'æŠŠä½ å‹ä½',

            'æŠŠä½ æ‰£ä½',

            'æŠŠä½ å¤¹ä½',

            // åŠ¨ä½œæè¿°è¯æ±‡

            'æ‰‘å‘ä½ ',

            'æ‰‘å€’ä½ ',

            'æ‰‘åœ¨ä½ ',

            'å‹åœ¨ä½ ',

            'å‹å‘ä½ ',

            'å‹ä½ä½ ',

            'æŠ±ä½ä½ ',

            'æ‚ä½ä½ ',

            'æŠ“ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹åˆ¶ä½ ',

            'é”ä½ä½ ',

            'ä¾µå ä½ ',

            'å›´ä½ä½ ',

            'åœˆä½ä½ ',

            'ç¼ ä½ä½ ',

            'ç»‘ä½ä½ ',

            'æŒ‰ä½ä½ ',

            'æ‰£ä½ä½ ',

            'å¤¹ä½ä½ ',

            'å¡ä½ä½ ',

            'é™·ä½ä½ ',

            'å›°ä½ä½ ',

            'å‹ä½ä½ ',

            // çŠ¶æ€æè¿°è¯æ±‡

            'åŠ¨å¼¹ä¸å¾—',

            'æ— æ³•ç§»åŠ¨',

            'æ— æ³•æŒ£è„±',

            'æ— æ³•åæŠ—',

            'æ— æ³•é€ƒè„±',

            'æ— æ³•æ‘†è„±',

            'æ— æ³•ç¦»å¼€',

            'æ— æ³•è„±èº«',

            'æ— æ³•è„±é€ƒ',

            'æ— æ³•è„±å›°',

            'æ— æ³•è„±å‡º',

            'æ— æ³•è„±å¼€',

            'æ— æ³•è„±æ‰',

            'æ— æ³•è„±ä¸‹',

            'æ— æ³•è„±ä¸‹',

            // å¼ºåº¦æè¿°è¯æ±‡

            'æ­»æ­»',

            'ç´§ç´§',

            'ç‰¢ç‰¢',

            'ç‰¢ç‰¢åœ°',

            'æ­»æ­»åœ°',

            'ç´§ç´§åœ°',

            'æ­»æ­»æŠ±ä½',

            'ç´§ç´§æŠ±ä½',

            'ç‰¢ç‰¢æŠ±ä½',

            'æ­»æ­»æŠ“ä½',

            'ç´§ç´§æŠ“ä½',

            'ç‰¢ç‰¢æŠ“ä½',

            'æ­»æ­»å›°ä½',

            'ç´§ç´§å›°ä½',

            'ç‰¢ç‰¢å›°ä½',

            'æ­»æ­»å‹åˆ¶',

            'ç´§ç´§å‹åˆ¶',

            'ç‰¢ç‰¢å‹åˆ¶',

            'æ­»æ­»é”ä½',

            'ç´§ç´§é”ä½',

            'ç‰¢ç‰¢é”ä½',

            // æƒ…æ„Ÿè‰²å½©è¯æ±‡

            'ä¸å®¹åæŠ—',

            'ä¸å®¹æ‹’ç»',

            'ä¸å®¹é€ƒè„±',

            'ä¸å®¹ç¦»å¼€',

            'ä¸å®¹è„±èº«',

            'å¼ºè¿«',

            'å¼ºåˆ¶',

            'å¼ºè¿«ä½ ',

            'å¼ºåˆ¶ä½ ',

            'é€¼è¿«',

            'é€¼è¿«ä½ ',

            'å¨èƒ',

            'å¨èƒä½ ',

            'æå“',

            'æå“ä½ ',

            'å¨é€¼',

            'å¨é€¼ä½ ',

            // ç‰¹æ®Šåœºæ™¯è¯æ±‡

            'å£å’š',

            'å£å’šä½ ',

            'æŠŠä½ å£å’š',

            'å£å’šåœ¨å¢™ä¸Š',

            'æŠŠä½ å£å’šåœ¨å¢™ä¸Š',

            'æ¨å€’',

            'æ¨å€’ä½ ',

            'æŠŠä½ æ¨å€’',

            'æ¨å€’åœ¨',

            'æŠŠä½ æ¨å€’åœ¨',

            'å‹å€’',

            'å‹å€’ä½ ',

            'æŠŠä½ å‹å€’',

            'å‹å€’åœ¨åœ°ä¸Š',

            'æŠŠä½ å‹å€’åœ¨åœ°ä¸Š',

            // é©¬å¨˜ç‰¹æœ‰è¯æ±‡

            'é©¬å¨˜çš„åŠ›é‡',

            'èµ›é©¬å¨˜çš„åŠ›é‡',

            'é©¬å¨˜çš„åŠ›æ°”',

            'èµ›é©¬å¨˜çš„åŠ›æ°”',

            'é©¬å¨˜çš„æ‹¥æŠ±',

            'èµ›é©¬å¨˜çš„æ‹¥æŠ±',

            'é©¬å¨˜çš„æ€€æŠ±',

            'èµ›é©¬å¨˜çš„æ€€æŠ±',

            'é©¬å¨˜çš„æŸç¼š',

            'èµ›é©¬å¨˜çš„æŸç¼š',

            'é©¬å¨˜çš„å‹åˆ¶',

            'èµ›é©¬å¨˜çš„å‹åˆ¶',

            // èº«ä½“éƒ¨ä½è¯æ±‡

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ å‹åœ¨ä¸‹é¢',

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ å‹åœ¨èº«ä¸‹',

            'æŠŠä½ æŠ±åœ¨æ€€é‡Œ',

            'æŠŠä½ æ‚åœ¨æ€€é‡Œ',

            'æŠŠä½ å›°åœ¨æ€€é‡Œ',

            'æŠŠä½ é”åœ¨æ€€é‡Œ',

            'æŠŠä½ å‹åœ¨å¢™ä¸Š',

            'æŠŠä½ å›°åœ¨å¢™ä¸Š',

            'æŠŠä½ é”åœ¨å¢™ä¸Š',

            'æŠŠä½ å‹åœ¨é—¨ä¸Š',

            'æŠŠä½ å›°åœ¨é—¨ä¸Š',

            'æŠŠä½ é”åœ¨é—¨ä¸Š',

            'æŠŠä½ å‹åœ¨åºŠä¸Š',

            'æŠŠä½ å›°åœ¨åºŠä¸Š',

            'æŠŠä½ é”åœ¨åºŠä¸Š',

            'æŠŠä½ å‹åœ¨æ²™å‘ä¸Š',

            'æŠŠä½ å›°åœ¨æ²™å‘ä¸Š',

            'æŠŠä½ é”åœ¨æ²™å‘ä¸Š',

            // æ—¶é—´æŒç»­è¯æ±‡

            'ä¸€ç›´',

            'ä¸€ç›´æŠ±ç€',

            'ä¸€ç›´æ‚ç€',

            'ä¸€ç›´æŠ“ç€',

            'ä¸€ç›´å›°ç€',

            'ä¸€ç›´å‹ç€',

            'ä¸€ç›´é”ç€',

            'ä¸€ç›´æŒ‰ç€',

            'ä¸€ç›´æ‰£ç€',

            'ä¸€ç›´å¤¹ç€',

            'æŒç»­',

            'æŒç»­æŠ±ç€',

            'æŒç»­æ‚ç€',

            'æŒç»­æŠ“ç€',

            'æŒç»­å›°ç€',

            'æŒç»­å‹ç€',

            'æŒç»­é”ç€',

            'æŒç»­æŒ‰ç€',

            'æŒç»­æ‰£ç€',

            'æŒç»­å¤¹ç€',

            // ç¨‹åº¦å‰¯è¯

            'å®Œå…¨',

            'å®Œå…¨æŸç¼š',

            'å®Œå…¨æŠ±ä½',

            'å®Œå…¨æŠ“ä½',

            'å®Œå…¨å›°ä½',

            'å®Œå…¨å‹åˆ¶',

            'å®Œå…¨é”ä½',

            'å®Œå…¨ä¾µå ',

            'å®Œå…¨å›´ä½',

            'å®Œå…¨åœˆä½',

            'å½»åº•',

            'å½»åº•æŸç¼š',

            'å½»åº•æŠ±ä½',

            'å½»åº•æŠ“ä½',

            'å½»åº•å›°ä½',

            'å½»åº•å‹åˆ¶',

            'å½»åº•é”ä½',

            'å½»åº•ä¾µå ',

            'å½»åº•å›´ä½',

            'å½»åº•åœˆä½',

            // å¦å®šæ€§è¯æ±‡

            'ä¸è®©ä½ ',

            'ä¸è®©ä½ åŠ¨',

            'ä¸è®©ä½ èµ°',

            'ä¸è®©ä½ ç¦»å¼€',

            'ä¸è®©ä½ é€ƒè„±',

            'ä¸è®©ä½ æŒ£è„±',

            'ä¸è®©ä½ åæŠ—',

            'ä¸è®©ä½ æ‹’ç»',

            'ä¸è®©ä½ è„±èº«',

            'é˜»æ­¢ä½ ',

            'é˜»æ­¢ä½ åŠ¨',

            'é˜»æ­¢ä½ èµ°',

            'é˜»æ­¢ä½ ç¦»å¼€',

            'é˜»æ­¢ä½ é€ƒè„±',

            'é˜»æ­¢ä½ æŒ£è„±',

            'é˜»æ­¢ä½ åæŠ—',

            'é˜»æ­¢ä½ æ‹’ç»',

            'é˜»æ­¢ä½ è„±èº«',

            // å‘½ä»¤æ€§è¯æ±‡

            'ä¸è®¸åŠ¨',

            'ä¸è®¸èµ°',

            'ä¸è®¸ç¦»å¼€',

            'ä¸è®¸é€ƒè„±',

            'ä¸è®¸æŒ£è„±',

            'ä¸è®¸åæŠ—',

            'ä¸è®¸æ‹’ç»',

            'ä¸è®¸è„±èº«',

            'ä¸å‡†åŠ¨',

            'ä¸å‡†èµ°',

            'ä¸å‡†ç¦»å¼€',

            'ä¸å‡†é€ƒè„±',

            'ä¸å‡†æŒ£è„±',

            'ä¸å‡†åæŠ—',

            'ä¸å‡†æ‹’ç»',

            'ä¸å‡†è„±èº«',

            'ä¸èƒ½åŠ¨',

            'ä¸èƒ½èµ°',

            'ä¸èƒ½ç¦»å¼€',

            'ä¸èƒ½é€ƒè„±',

            'ä¸èƒ½æŒ£è„±',

            'ä¸èƒ½åæŠ—',

            'ä¸èƒ½æ‹’ç»',

            'ä¸èƒ½è„±èº«',
          ];

          // æ£€æµ‹åŒ¹é…çš„å…³é”®è¯

          const matchedKeywords = keywords.filter(keyword => text.includes(keyword));

          if (matchedKeywords.length > 0) {
            console.log('ğŸ” åŒ¹é…åˆ°çš„å…³é”®è¯:', matchedKeywords);

            return true;
          } else {
            console.log('ğŸ” æœªåŒ¹é…åˆ°ä»»ä½•å…³é”®è¯');

            return false;
          }
        }

        // è§¦å‘QTEåŠ¨ä½œ

        // è§¦å‘è¶£å‘³QTE

        // è§¦å‘è¶£å‘³QTEï¼ˆä½¿ç”¨jQueryï¼‰

        async triggerQTE(action) {
          try {
            console.log(`ğŸ® è§¦å‘è¶£å‘³QTE: ${action}`);

            let qteCommand = '';

            if (action === 'struggle') {
              // å¥‹åŠ›æŒ£æ‰

              qteCommand = `å¥‹åŠ›æŒ£æ‰ï¼Œå°è¯•æŒ£è„±æŸç¼š`;
            } else if (action === 'submit') {
              // ä¸åæŠ—

              qteCommand = `é€‰æ‹©ä¸åæŠ—ï¼Œæ¥å—ç°çŠ¶`;
            }

            if (qteCommand) {
              // å°†QTEå‘½ä»¤å¡«å…¥è¾“å…¥æ¡†

              $('#action-input').val(qteCommand);

              console.log('âœ… è¶£å‘³QTEå‘½ä»¤å·²å¡«å…¥è¾“å…¥æ¡†:', qteCommand);
            }

            // éšè—QTEåŒºåŸŸ

            this.checkQTEFromCurrentContent();
          } catch (error) {
            console.error('âŒ è§¦å‘è¶£å‘³QTEå¤±è´¥:', error);
          }
        }

        // è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨

        getAutoSaves() {
          const autoSaves = [];

          try {
            console.log('ğŸ” å¼€å§‹è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨...');

            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);

              if (key && key.startsWith('teresen-auto-save-')) {
                const data = localStorage.getItem(key);

                if (data) {
                  try {
                    const saveData = JSON.parse(data);

                    autoSaves.push({
                      key: key,

                      data: saveData,
                    });

                    console.log(
                      `ğŸ“ æ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£: ${key}, æ—¶é—´: ${new Date(saveData.timestamp).toLocaleString('zh-CN')}`,
                    );
                  } catch (parseError) {
                    console.warn(`âŒ è§£æè‡ªåŠ¨å­˜æ¡£å¤±è´¥: ${key}`, parseError);
                  }
                }
              }
            }

            // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œæœ€æ–°çš„åœ¨å‰

            autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);

            console.log(`ğŸ“Š æ€»å…±æ‰¾åˆ° ${autoSaves.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

            // è¿”å›æœ€è¿‘10ä¸ª

            const result = autoSaves.slice(0, 10);

            console.log(`ğŸ“‹ è¿”å›æœ€è¿‘ ${result.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

            return result;
          } catch (error) {
            console.warn('è·å–è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨å¤±è´¥:', error);

            return [];
          }
        }

        // åŠ è½½è‡ªåŠ¨å­˜æ¡£ï¼ˆä¿®å¤ç‰ˆï¼šæ¢å¤å®Œæ•´èŠå¤©å†å²ï¼‰

        async loadAutoSave(saveKey) {
          try {
            console.log('ğŸ“‚ åŠ è½½è‡ªåŠ¨å­˜æ¡£:', saveKey);

            const saveData = localStorage.getItem(saveKey);

            if (!saveData) {
              throw new Error('è‡ªåŠ¨å­˜æ¡£ä¸å­˜åœ¨');
            }

            const save = JSON.parse(saveData);

            console.log('ğŸ“„ å­˜æ¡£æ•°æ®ç»“æ„:', save);

            // ğŸ”¥ æ¢å¤å›åˆå¿«ç…§å†å²ï¼ˆæ–°ç‰ˆæœ¬æ ¼å¼ï¼‰
            if (save.timeline_history && Array.isArray(save.timeline_history) && save.timeline_history.length > 0) {
              console.log('ğŸ”„ æ¢å¤å›åˆå¿«ç…§å†å² (' + save.timeline_history.length + ' ä¸ªå›åˆ)...');

              // æ¢å¤chatHistoryCache
              this.chatHistoryCache = JSON.parse(JSON.stringify(save.timeline_history));
              localStorage.setItem(this._getHistoryKey(), JSON.stringify(this.chatHistoryCache));
              this.historyViewIndex = this.chatHistoryCache.length - 1;

              // æ¢å¤æœ€åä¸€æ¡æ¶ˆæ¯åˆ°ç•Œé¢
              // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„saveStateï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
              const lastSnapshot = this.chatHistoryCache[this.chatHistoryCache.length - 1];
              if (
                lastSnapshot &&
                lastSnapshot.message &&
                typeof SillyTavern !== 'undefined' &&
                SillyTavern.chat &&
                SillyTavern.chat.length > 0
              ) {
                try {
                  const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                  if (!lastMessage.extra) {
                    lastMessage.extra = {};
                  }

                  // ğŸ”¥ æ¢å¤æ¶ˆæ¯åˆ°extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯çš„messageå­—æ®µ
                  // å¦‚æœæœ‰timeline_historyï¼Œè½¬æ¢ä¸ºteresen_chatæ ¼å¼
                  if (save.timeline_history && save.timeline_history.length > 0) {
                    lastMessage.extra.teresen_chat = save.timeline_history.map(snapshot => ({
                      role: 'assistant',
                      content: snapshot.message || '',
                      id: snapshot.message_id || `snapshot_${Date.now()}`,
                      timestamp: snapshot.timestamp || Date.now(),
                      variableState: snapshot.data || null,
                    }));
                  } else if (lastSnapshot) {
                    lastMessage.extra.teresen_chat = [
                      {
                        role: 'assistant',
                        content: lastSnapshot.message || '',
                        id: 'load_' + Date.now(),
                        timestamp: Date.now(),
                        variableState: lastSnapshot.data || null,
                      },
                    ];
                  }

                  // åªæ›´æ–°dataå­—æ®µï¼Œä¸æ›´æ–°messageå­—æ®µ
                  if (lastSnapshot && lastSnapshot.data) {
                    lastMessage.data = lastSnapshot.data;
                  }

                  if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                    await SillyTavern.saveChat();
                  } else {
                    await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  }
                  // ğŸ”¥ å¼ºåˆ¶æ›´æ–°æ–‡æœ¬å†…å®¹
                  if (typeof this.updateInterface === 'function') {
                    await this.updateInterface();
                  }
                } catch (e) {
                  console.warn('æ¢å¤èŠå¤©æ¶ˆæ¯å¤±è´¥:', e);
                }
              }

              console.log('âœ… å›åˆå¿«ç…§å†å²å·²æ¢å¤ (' + save.timeline_history.length + ' ä¸ªå›åˆ)');
            }
            // ğŸ”¥ å…¼å®¹æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆchat_historyï¼‰
            else if (save.chat_history && Array.isArray(save.chat_history) && save.chat_history.length > 0) {
              console.log('ğŸ”„ æ¢å¤å®Œæ•´èŠå¤©å†å²ï¼ˆæ—§æ ¼å¼ï¼‰(' + save.chat_history.length + ' æ¡æ¶ˆæ¯)...');

              if (
                'function' == typeof getChatMessages &&
                'undefined' != typeof TavernHelper &&
                TavernHelper.setChatMessages
              ) {
                await TavernHelper.setChatMessages(save.chat_history, { refresh: 'full' });
                // ğŸ”¥ å¼ºåˆ¶æ›´æ–°æ–‡æœ¬å†…å®¹
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
                console.log('âœ… å®Œæ•´èŠå¤©å†å²å·²æ¢å¤ (' + save.chat_history.length + ' æ¡æ¶ˆæ¯)');
              }
            }
            // ğŸ”¥ å…¼å®¹æ›´æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆmessage_contentï¼‰
            else if (save.message_content) {
              console.log('âš ï¸ ä½¿ç”¨æ—§ç‰ˆå­˜æ¡£æ ¼å¼ï¼Œåªæ¢å¤å•æ¡æ¶ˆæ¯');

              // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
              if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }

                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: save.message_content || '',
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: null,
                  },
                ];

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæ—§ç‰ˆæ ¼å¼ï¼‰');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                }

                // ğŸ”¥ å¼ºåˆ¶æ›´æ–°æ–‡æœ¬å†…å®¹
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
              }
            }

            // æ¢å¤æ¸¸æˆçŠ¶æ€
            if (save.snapshot_data && save.snapshot_data.mvu_data) {
              this.currentMvuState = save.snapshot_data.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');
            } else if (save.mvu_data && 'function' == typeof eventEmit) {
              // å…¼å®¹æ—§æ ¼å¼
              this.currentMvuState = save.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤ï¼ˆæ—§æ ¼å¼ï¼‰');
            }

            // ğŸ”¥ æ¢å¤ä¸–ç•Œä¹¦å†…å®¹å¹¶æ¿€æ´»ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼šè®©AIè®°ä½ä¹‹å‰çš„ç»å†ï¼‰
            // ğŸ”¥ å…³é”®ï¼šåªæ¿€æ´»å½“å‰å‘¨ç›®çš„æ¡ç›®ï¼Œç¦ç”¨å…¶ä»–å‘¨ç›®çš„æ¡ç›®
            if (save.snapshot_data && save.snapshot_data.lorebook_content) {
              const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
              const baseJourneyKey = this._getBaseJourneyKey();
              const baseCoreKey = this._getBaseCoreMemoryKey();

              try {
                const allEntries = await TavernHelper.getLorebookEntries(bookName);
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);

                // ğŸ”¥ å…ˆç¦ç”¨æ‰€æœ‰å…¶ä»–å‘¨ç›®çš„æ¡ç›®
                const entriesToDisable = [];
                for (const entry of allEntries) {
                  const isJourneyEntry = entry.comment.startsWith('æœ¬å‘¨ç›®ç»å†');
                  const isCoreEntry = entry.comment.startsWith('æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†');
                  if (!isJourneyEntry && !isCoreEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;
                  const isCurrentCore = entry.comment === baseCoreKey;

                  // å¦‚æœä¸æ˜¯å½“å‰å‘¨ç›®çš„æ¡ç›®ï¼Œåˆ™ç¦ç”¨
                  if (!isCurrentJourney && !isCurrentCore && entry.enabled) {
                    entriesToDisable.push({ uid: entry.uid, enabled: false });
                  }
                }

                if (entriesToDisable.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, entriesToDisable);
                  console.log(`âœ… å·²ç¦ç”¨ ${entriesToDisable.length} ä¸ªå…¶ä»–å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®`);
                }

                // ğŸ”¥ æ¢å¤å¹¶æ¿€æ´»å½“å‰å‘¨ç›®çš„"æœ¬å‘¨ç›®ç»å†"
                if (journeyEntry) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: save.snapshot_data.lorebook_content.journey || '',
                      enabled: true, // ğŸ”¥ æ¿€æ´»ï¼šè®©AIèƒ½è¯»å–è¿™ä¸ªè®°å¿†
                    },
                  ]);
                  console.log(`âœ… "${baseJourneyKey}"å·²æ¢å¤å¹¶æ¿€æ´»ï¼ŒAIç°åœ¨èƒ½è®°ä½ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…`);
                } else {
                  console.warn(`âš ï¸ æ‰¾ä¸åˆ°"${baseJourneyKey}"æ¡ç›®ï¼Œæ— æ³•æ¢å¤`);
                }

                // ğŸ”¥ æ¢å¤å¹¶æ¿€æ´»å½“å‰å‘¨ç›®çš„"æœ¬å‘¨ç›®æ ¸å¿ƒè®°å¿†"
                if (coreEntry && save.snapshot_data.lorebook_content.core_memory) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: coreEntry.uid,
                      content: save.snapshot_data.lorebook_content.core_memory,
                      enabled: true, // ğŸ”¥ æ¿€æ´»ï¼šè®©AIèƒ½è¯»å–è¿™ä¸ªè®°å¿†
                    },
                  ]);
                  console.log(`âœ… "${baseCoreKey}"å·²æ¢å¤å¹¶æ¿€æ´»ï¼ŒAIç°åœ¨èƒ½è®°ä½æ ¸å¿ƒå‰§æƒ…`);
                } else {
                  console.warn(`âš ï¸ æ‰¾ä¸åˆ°"${baseCoreKey}"æ¡ç›®æˆ–å†…å®¹ä¸ºç©º`);
                }

                console.log('âœ… ä¸–ç•Œä¹¦è®°å¿†åŠŸèƒ½å·²æ¢å¤ï¼AIç°åœ¨å¯ä»¥è®°ä½å­˜æ¡£æ—¶çš„æ‰€æœ‰è®°å¿†');
              } catch (e) {
                console.error('âŒ æ¢å¤ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
              }
            } else if (save.lorebook_content) {
              // å…¼å®¹æ—§æ ¼å¼
              const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
              const baseJourneyKey = this._getBaseJourneyKey();
              const baseCoreKey = this._getBaseCoreMemoryKey();

              try {
                const allEntries = await TavernHelper.getLorebookEntries(bookName);
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                const coreEntry = allEntries.find(entry => entry.comment === baseCoreKey);

                if (journeyEntry && save.lorebook_content.journey) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: save.lorebook_content.journey,
                      enabled: true,
                    },
                  ]);
                }

                if (coreEntry && save.lorebook_content.core_memory) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: coreEntry.uid,
                      content: save.lorebook_content.core_memory,
                      enabled: true,
                    },
                  ]);
                }

                console.log('âœ… ä¸–ç•Œä¹¦è®°å¿†åŠŸèƒ½å·²æ¢å¤ï¼ˆæ—§æ ¼å¼ï¼‰ï¼');
              } catch (e) {
                console.error('âŒ æ¢å¤ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥ï¼ˆæ—§æ ¼å¼ï¼‰:', e);
              }
            }

            await this.updateInterface();

            $('#saveManagerModal').hide();

            console.log('âœ… è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸ');

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼AIç°åœ¨å¯ä»¥è®°ä½ä¹‹å‰çš„å¯¹è¯äº†ã€‚');
            }
          } catch (error) {
            console.error('âŒ åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        // è°ƒè¯•å­˜æ¡£åŠŸèƒ½

        debugSaves() {
          console.log('ğŸ” è°ƒè¯•å­˜æ¡£åŠŸèƒ½...');

          // æ£€æŸ¥æ‰€æœ‰localStorageä¸­çš„å­˜æ¡£

          const allSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && (key === 'teresen-save' || key.startsWith('teresen-auto-save-'))) {
              try {
                const data = localStorage.getItem(key);

                const save = JSON.parse(data);

                allSaves.push({
                  key: key,

                  save: save,
                });
              } catch (error) {
                console.warn('è§£æå­˜æ¡£å¤±è´¥:', key, error);
              }
            }
          }

          console.log('ğŸ“Š æ‰€æœ‰å­˜æ¡£:', allSaves);

          // æ˜¾ç¤ºå­˜æ¡£ç»Ÿè®¡

          const manualSaves = allSaves.filter(s => s.key === 'teresen-save');

          const autoSaves = allSaves.filter(s => s.key.startsWith('teresen-auto-save-'));

          console.log('ğŸ“‹ å­˜æ¡£ç»Ÿè®¡:');

          console.log('  æ‰‹åŠ¨å­˜æ¡£:', manualSaves.length, 'ä¸ª');

          console.log('  è‡ªåŠ¨å­˜æ¡£:', autoSaves.length, 'ä¸ª');

          // æ˜¾ç¤ºæ¯ä¸ªå­˜æ¡£çš„è¯¦ç»†ä¿¡æ¯

          allSaves.forEach((saveInfo, index) => {
            console.group(`å­˜æ¡£ ${index + 1}: ${saveInfo.key}`);

            console.log('å­˜æ¡£æ•°æ®:', saveInfo.save);

            if (saveInfo.save.data) {
              console.log('å­˜æ¡£æ—¶é—´:', new Date(saveInfo.save.timestamp).toLocaleString('zh-CN'));

              console.log('å­˜æ¡£åç§°:', saveInfo.save.saveName);

              console.log('å­˜æ¡£ç±»å‹:', saveInfo.save.type);
            }

            console.groupEnd();
          });

          // æµ‹è¯•è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨åŠŸèƒ½

          const autoSavesList = this.getAutoSaves();

          console.log('ğŸ”§ è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨åŠŸèƒ½æµ‹è¯•:', autoSavesList);
        }

        // è°ƒè¯•æŒ‡ä»¤äº¤äº’ç³»ç»Ÿ

        debugCommands() {
          console.log('âš¡ è°ƒè¯•æŒ‡ä»¤äº¤äº’ç³»ç»Ÿ...');

          // æ£€æŸ¥è¾“å…¥æ¡†

          const actionInput = document.getElementById('action-input');

          console.log('æŒ‡ä»¤è¾“å…¥æ¡†:', actionInput);

          // æ£€æŸ¥å‘é€æŒ‰é’®

          const sendBtn = document.querySelector('.send-button, #send-btn, button[onclick*="handleActionSubmit"]');

          console.log('å‘é€æŒ‰é’®:', sendBtn);

          // æ£€æŸ¥æœ€åå‘é€çš„æŒ‡ä»¤

          console.log('æœ€åå‘é€çš„æŒ‡ä»¤:', this.lastSentPrompt);

          // æ£€æŸ¥èŠå¤©å†å²

          const chatContainer = document.getElementById('chat_container');

          console.log('èŠå¤©å®¹å™¨:', chatContainer);
        }

        // è°ƒè¯•è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿ

        debugAutoSaves() {
          console.log('ğŸ’¾ è°ƒè¯•è‡ªåŠ¨å­˜æ¡£ç³»ç»Ÿ...');

          // æ£€æŸ¥æ‰€æœ‰localStorageä¸­çš„è‡ªåŠ¨å­˜æ¡£

          const allAutoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {
              try {
                const data = localStorage.getItem(key);

                const saveData = JSON.parse(data);

                allAutoSaves.push({
                  key: key,

                  timestamp: saveData.timestamp,

                  time: new Date(saveData.timestamp).toLocaleString('zh-CN'),

                  saveName: saveData.saveName,
                });
              } catch (error) {
                console.warn(`è§£æå­˜æ¡£å¤±è´¥: ${key}`, error);
              }
            }
          }

          // æŒ‰æ—¶é—´æ’åº

          allAutoSaves.sort((a, b) => b.timestamp - a.timestamp);

          console.log('ğŸ“Š æ‰€æœ‰è‡ªåŠ¨å­˜æ¡£:');

          allAutoSaves.forEach((save, index) => {
            console.log(`${index + 1}. ${save.key} - ${save.time} - ${save.saveName}`);
          });

          console.log(`ğŸ“ˆ æ€»è®¡: ${allAutoSaves.length} ä¸ªè‡ªåŠ¨å­˜æ¡£`);

          // æµ‹è¯•getAutoSavesæ–¹æ³•

          const recentSaves = this.getAutoSaves();

          console.log('ğŸ“‹ getAutoSavesè¿”å›:', recentSaves.length, 'ä¸ª');
        }

        // æ–°å¢ï¼šç®€å•å­˜æ¡£ç³»ç»Ÿ

        // ğŸ”¥ è·å–æ‰€æœ‰å­˜æ¡£æ•°æ®
        getSavesFromStorage() {
          try {
            // ğŸ”¥ åˆå¹¶å½“å‰ä¼šè¯çš„è‡ªåŠ¨å­˜æ¡£å’Œå…¨å±€æ‰‹åŠ¨å­˜æ¡£
            const chatId = TavernHelper?.chatId || 'default';
            const autoSaveKey = `teresen_auto_save_${chatId}`;
            const manualSaveKey = 'teresen_multi_save_data';

            let allSaves = {};

            // è¯»å–æ‰‹åŠ¨å­˜æ¡£ï¼ˆå…¨å±€ï¼Œæ‰€æœ‰ä¼šè¯å…±äº«ï¼‰
            try {
              const manualSaves = localStorage.getItem(manualSaveKey);
              if (manualSaves) {
                allSaves = JSON.parse(manualSaves);
              }
            } catch (e) {
              console.warn('[å­˜æ¡£ç³»ç»Ÿ] è¯»å–æ‰‹åŠ¨å­˜æ¡£å¤±è´¥:', e);
            }

            // è¯»å–å½“å‰ä¼šè¯çš„è‡ªåŠ¨å­˜æ¡£å¹¶åˆå¹¶
            try {
              const autoSaves = localStorage.getItem(autoSaveKey);
              if (autoSaves) {
                const parsedAutoSaves = JSON.parse(autoSaves);
                // å°†è‡ªåŠ¨å­˜æ¡£åˆå¹¶åˆ°allSavesä¸­
                Object.assign(allSaves, parsedAutoSaves);
              }
            } catch (e) {
              console.warn('[å­˜æ¡£ç³»ç»Ÿ] è¯»å–è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', e);
            }

            return allSaves;
          } catch (e) {
            console.error('è·å–å­˜æ¡£å¤±è´¥:', e);
            return {};
          }
        }

        // ğŸ”¥ å­˜æ¡£å‘½åå¯¹è¯æ¡†
        async promptForSaveName(defaultName) {
          return new Promise(resolve => {
            try {
              // åˆ›å»ºé®ç½©å±‚
              const overlay = document.createElement('div');
              overlay.style.cssText =
                'position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100005; display: flex; align-items: center; justify-content: center;';
              overlay.id = 'save-name-overlay';

              // åˆ›å»ºå¯¹è¯æ¡†
              const modal = document.createElement('div');
              modal.style.cssText =
                'background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 2px solid #8b7355; border-radius: 8px; padding: 0; width: 450px; max-width: 90vw; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

              modal.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #8b7355;">
                  <h2 style="margin: 0; color: #e0dcd1; font-size: 18px; font-weight: bold;">å­˜æ¡£å‘½å</h2>
                </div>
                <div style="padding: 20px;">
                  <p style="margin: 0 0 15px 0; color: #c9aa71; font-size: 14px;">è¯·è¾“å…¥å­˜æ¡£åç§°ï¼š</p>
                  <input type="text" id="save-name-input" placeholder="${defaultName}"
                         value="${defaultName}"
                         style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #8b7355;
                                color: #e0dcd1; border-radius: 4px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;">
                  <p style="font-size: 12px; color: #8b7355; margin: 0 0 20px 0; line-height: 1.5;">
                    å°†åˆ›å»ºç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼š<br>
                    â€¢ <span id="preview-journey" style="color: #c9aa71;">${defaultName}-æœ¬å‘¨ç›®ç»å†</span>
                  </p>
                  <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="save-name-cancel" class="interaction-btn" style="padding: 8px 16px; min-width: 80px; background: linear-gradient(135deg, #3d2b2b, #4d3b3b); border: 1px solid #8b7355; color: #e0dcd1; cursor: pointer;">å–æ¶ˆ</button>
                    <button id="save-name-confirm" class="interaction-btn primary-btn" style="padding: 8px 16px; min-width: 80px; background: linear-gradient(135deg, #8b4513, #a0522d); border: 1px solid #8b7355; color: #f0e6d2; cursor: pointer; font-weight: bold;">ç¡®è®¤</button>
                  </div>
                </div>
              `;

              overlay.appendChild(modal);
              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;
              parent.appendChild(overlay);

              const input = modal.querySelector('#save-name-input');
              const previewJourney = modal.querySelector('#preview-journey');
              const confirmBtn = modal.querySelector('#save-name-confirm');
              const cancelBtn = modal.querySelector('#save-name-cancel');

              // ç‚¹å‡»é®ç½©å±‚å…³é—­
              overlay.addEventListener('click', e => {
                if (e.target === overlay) {
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(null);
                }
              });

              // å®æ—¶æ›´æ–°é¢„è§ˆ
              if (input && previewJourney) {
                input.addEventListener('input', e => {
                  const name = e.target.value.trim() || defaultName;
                  previewJourney.textContent = `${name}-æœ¬å‘¨ç›®ç»å†`;
                });
              }

              // ç¡®è®¤æŒ‰é’®
              if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                  const name = input?.value?.trim() || defaultName;
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(name);
                });
              }

              // å–æ¶ˆæŒ‰é’®
              if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                  if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                  resolve(null);
                });
              }

              // å›è½¦ç¡®è®¤ï¼ŒESCå–æ¶ˆ
              if (input) {
                input.addEventListener('keydown', e => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    const name = input.value.trim() || defaultName;
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    resolve(name);
                  } else if (e.key === 'Escape') {
                    e.preventDefault();
                    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    resolve(null);
                  }
                });
                // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                  input.focus();
                  input.select();
                }, 50);
              }
            } catch (error) {
              console.error('åˆ›å»ºå­˜æ¡£å‘½åå¯¹è¯æ¡†å¤±è´¥:', error);
              resolve(defaultName);
            }
          });
        }

        // ğŸ”¥ é€šç”¨ï¼šå…¨å±æç¤ºå¼¹çª—ï¼ˆæ›¿ä»£ alertï¼‰
        async showFullscreenAlert(message, options = {}) {
          return new Promise(resolve => {
            try {
              const { title = 'æç¤º', icon = 'â„¹ï¸', okText = 'ç¡®å®š' } = options || {};
              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;

              const overlay = document.createElement('div');
              overlay.id = `teresen-alert-overlay-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
              overlay.style.cssText = `
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.7);
                z-index: 100005;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px;
                box-sizing: border-box;
              `;

              const modal = document.createElement('div');
              modal.style.cssText = `
                background: linear-gradient(135deg, #2d1b1b, #3d2b2b);
                border: 2px solid #8b7355;
                border-radius: 10px;
                width: 520px;
                max-width: 95vw;
                box-shadow: 0 12px 40px rgba(0,0,0,0.6);
                overflow: hidden;
              `;

              const header = document.createElement('div');
              header.style.cssText = `
                padding: 16px 18px;
                border-bottom: 1px solid rgba(139, 115, 85, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
              `;

              const h = document.createElement('div');
              h.style.cssText =
                'color: #e0dcd1; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;';
              const iconSpan = document.createElement('span');
              iconSpan.textContent = icon;
              const titleSpan = document.createElement('span');
              titleSpan.textContent = title;
              h.appendChild(iconSpan);
              h.appendChild(titleSpan);

              const closeBtn = document.createElement('button');
              closeBtn.type = 'button';
              closeBtn.textContent = 'Ã—';
              closeBtn.className = 'interaction-btn';
              closeBtn.style.cssText =
                'width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18); color: #ffffff; font-size: 18px; cursor: pointer; line-height: 1;';

              header.appendChild(h);
              header.appendChild(closeBtn);

              const body = document.createElement('div');
              body.style.cssText = 'padding: 18px; color: #f0e6d2;';
              const msg = document.createElement('div');
              msg.style.cssText =
                'white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: #f0e6d2; background: rgba(0,0,0,0.25); border: 1px solid rgba(139,115,85,0.35); border-radius: 8px; padding: 12px 14px;';
              msg.textContent = String(message ?? '');
              body.appendChild(msg);

              const footer = document.createElement('div');
              footer.style.cssText =
                'padding: 16px 18px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid rgba(139, 115, 85, 0.35);';
              const okBtn = document.createElement('button');
              okBtn.type = 'button';
              okBtn.className = 'interaction-btn primary-btn';
              okBtn.textContent = okText;
              okBtn.style.cssText =
                'padding: 10px 16px; min-width: 96px; background: linear-gradient(135deg, #8b4513, #a0522d); border: 1px solid #8b7355; color: #f0e6d2; cursor: pointer; font-weight: 700; border-radius: 8px;';
              footer.appendChild(okBtn);

              modal.appendChild(header);
              modal.appendChild(body);
              modal.appendChild(footer);
              overlay.appendChild(modal);
              parent.appendChild(overlay);

              const onKeyDown = e => {
                if (e.key === 'Escape' || e.key === 'Enter') {
                  e.preventDefault();
                  finish();
                }
              };

              const cleanup = () => {
                document.removeEventListener('keydown', onKeyDown, true);
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
              };

              const finish = () => {
                cleanup();
                resolve();
              };

              overlay.addEventListener('click', e => {
                if (e.target === overlay) finish();
              });
              closeBtn.addEventListener('click', finish);
              okBtn.addEventListener('click', finish);
              document.addEventListener('keydown', onKeyDown, true);
              setTimeout(() => okBtn.focus(), 0);
            } catch (e) {
              console.warn('showFullscreenAlert failed, fallback to alert:', e);
              alert(String(message ?? ''));
              resolve();
            }
          });
        }

        // ğŸ”¥ é€šç”¨ï¼šå…¨å±ç¡®è®¤å¼¹çª—ï¼ˆæ›¿ä»£ confirmï¼‰
        async showFullscreenConfirm(message, options = {}) {
          return new Promise(resolve => {
            try {
              const {
                title = 'ç¡®è®¤',
                icon = 'âš ï¸',
                confirmText = 'ç¡®è®¤',
                cancelText = 'å–æ¶ˆ',
                danger = false,
              } = options || {};

              const parent = document.getElementById('teresen-fullscreen-overlay') || document.body;
              const overlay = document.createElement('div');
              overlay.id = `teresen-confirm-overlay-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
              overlay.style.cssText = `
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.75);
                z-index: 100005;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px;
                box-sizing: border-box;
              `;

              const modal = document.createElement('div');
              modal.style.cssText = `
                background: linear-gradient(135deg, #2d1b1b, #3d2b2b);
                border: 2px solid #8b7355;
                border-radius: 10px;
                width: 560px;
                max-width: 95vw;
                box-shadow: 0 12px 40px rgba(0,0,0,0.65);
                overflow: hidden;
              `;

              const header = document.createElement('div');
              header.style.cssText = `
                padding: 16px 18px;
                border-bottom: 1px solid rgba(139, 115, 85, 0.7);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
              `;

              const h = document.createElement('div');
              h.style.cssText =
                'color: #e0dcd1; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;';
              const iconSpan = document.createElement('span');
              iconSpan.textContent = icon;
              const titleSpan = document.createElement('span');
              titleSpan.textContent = title;
              h.appendChild(iconSpan);
              h.appendChild(titleSpan);

              const closeBtn = document.createElement('button');
              closeBtn.type = 'button';
              closeBtn.textContent = 'Ã—';
              closeBtn.className = 'interaction-btn';
              closeBtn.style.cssText =
                'width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18); color: #ffffff; font-size: 18px; cursor: pointer; line-height: 1;';

              header.appendChild(h);
              header.appendChild(closeBtn);

              const body = document.createElement('div');
              body.style.cssText = 'padding: 18px; color: #f0e6d2;';
              const msg = document.createElement('div');
              msg.style.cssText =
                'white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: #f0e6d2; background: rgba(0,0,0,0.25); border: 1px solid rgba(139,115,85,0.35); border-radius: 8px; padding: 12px 14px;';
              msg.textContent = String(message ?? '');
              body.appendChild(msg);

              const footer = document.createElement('div');
              footer.style.cssText =
                'padding: 16px 18px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid rgba(139, 115, 85, 0.35);';

              const cancelBtn = document.createElement('button');
              cancelBtn.type = 'button';
              cancelBtn.className = 'interaction-btn';
              cancelBtn.textContent = cancelText;
              cancelBtn.style.cssText =
                'padding: 10px 16px; min-width: 96px; background: linear-gradient(135deg, #3d2b2b, #4d3b3b); border: 1px solid #8b7355; color: #e0dcd1; cursor: pointer; border-radius: 8px;';

              const confirmBtn = document.createElement('button');
              confirmBtn.type = 'button';
              confirmBtn.className = 'interaction-btn primary-btn';
              confirmBtn.textContent = confirmText;
              confirmBtn.style.cssText = `
                padding: 10px 16px;
                min-width: 96px;
                background: ${danger ? 'linear-gradient(135deg, #b91c1c, #dc2626)' : 'linear-gradient(135deg, #8b4513, #a0522d)'};
                border: 1px solid #8b7355;
                color: #f0e6d2;
                cursor: pointer;
                font-weight: 700;
                border-radius: 8px;
              `;

              footer.appendChild(cancelBtn);
              footer.appendChild(confirmBtn);

              modal.appendChild(header);
              modal.appendChild(body);
              modal.appendChild(footer);
              overlay.appendChild(modal);
              parent.appendChild(overlay);

              const onKeyDown = e => {
                if (e.key === 'Escape') {
                  e.preventDefault();
                  finish(false);
                } else if (e.key === 'Enter') {
                  e.preventDefault();
                  finish(true);
                }
              };

              const cleanup = () => {
                document.removeEventListener('keydown', onKeyDown, true);
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
              };

              const finish = result => {
                cleanup();
                resolve(!!result);
              };

              overlay.addEventListener('click', e => {
                if (e.target === overlay) finish(false);
              });
              closeBtn.addEventListener('click', () => finish(false));
              cancelBtn.addEventListener('click', () => finish(false));
              confirmBtn.addEventListener('click', () => finish(true));
              document.addEventListener('keydown', onKeyDown, true);
              setTimeout(() => confirmBtn.focus(), 0);
            } catch (e) {
              console.warn('showFullscreenConfirm failed, fallback to confirm:', e);
              resolve(confirm(String(message ?? '')));
            }
          });
        }

        async saveGame(slotId = 'slot_1') {
          try {
            // é¦–å…ˆå¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·å‘½åå­˜æ¡£
            const saveName = await this.promptForSaveName(`æ‰‹åŠ¨å­˜æ¡£_${new Date().toLocaleString('zh-CN')}`);
            if (!saveName) {
              console.log('å­˜æ¡£å·²å–æ¶ˆ');
              return;
            }

            const allSaves = this.getSavesFromStorage();
            const slotExists = allSaves[slotId];

            const performSave = async () => {
              try {
                // è·å–å½“å‰æ¸¸æˆçŠ¶æ€
                const gameState = this.getAllVariables();
                const chatMessages = await getChatMessages(0);
                const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';

                // ğŸ”¥ è¯»å–å½“å‰ä¸–ç•Œä¹¦å†…å®¹ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼šä¿å­˜AIçš„è®°å¿†ï¼‰
                const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
                const baseJourneyKey = this._getBaseJourneyKey();
                let journeyContent = '';
                try {
                  const allEntries = await TavernHelper.getLorebookEntries(bookName);
                  const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
                  journeyContent = journeyEntry?.content || '';
                  console.log(`ğŸ“š è¯»å–ä¸–ç•Œä¹¦å†…å®¹: æœ¬å‘¨ç›®ç»å†(${journeyContent.length}å­—ç¬¦)`);
                } catch (e) {
                  console.error('âŒ è¯»å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
                }

                // ğŸ”¥ åˆ›å»ºç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆæ¯ä¸ªå­˜æ¡£éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼‰
                const saveJourneyEntryName = `${saveName}-æœ¬å‘¨ç›®ç»å†`;

                let lorebookEntries = {
                  journey_entry_name: saveJourneyEntryName,
                };

                try {
                  const allEntries = await TavernHelper.getLorebookEntries(bookName);
                  const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);

                  // åˆ›å»ºç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®
                  const entriesToCreate = [];

                  // åˆ›å»º"æœ¬å‘¨ç›®ç»å†"çš„ç‹¬ç«‹æ¡ç›®
                  if (journeyEntry) {
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: journeyEntry.content || '',
                      keys: [saveJourneyEntryName],
                      enabled: false, // é»˜è®¤ç¦ç”¨ï¼Œè¯»æ¡£æ—¶æ‰æ¿€æ´»
                      position: 'before_character_definition',
                      order: 20,
                    });
                    console.log(
                      `[å­˜æ¡£] å‡†å¤‡åˆ›å»º"${saveJourneyEntryName}"æ¡ç›®ï¼Œå†…å®¹é•¿åº¦: ${(journeyEntry.content || '').length}`,
                    );
                  } else {
                    // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹æ¡ç›®ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„
                    entriesToCreate.push({
                      comment: saveJourneyEntryName,
                      content: '# æœ¬å‘¨ç›®ç»å†\næš‚æ— è®°å½•',
                      keys: [saveJourneyEntryName],
                      enabled: false,
                      position: 'before_character_definition',
                      order: 20,
                    });
                    console.log(`[å­˜æ¡£] åŸå§‹"æœ¬å‘¨ç›®ç»å†"æ¡ç›®ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ¡ç›®`);
                  }

                  if (entriesToCreate.length > 0) {
                    await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
                    console.log(`âœ… [å­˜æ¡£] å·²åˆ›å»º ${entriesToCreate.length} ä¸ªç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®`);

                    // ğŸ”¥ ç¡®ä¿å½“å‰å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®ä¿æŒæ¿€æ´»ï¼ˆå­˜æ¡£ä¸å½±å“å½“å‰æ¸¸æˆï¼‰
                    const updatedEntries = await TavernHelper.getLorebookEntries(bookName);
                    const currentJourneyEntry = updatedEntries.find(entry => entry.comment === baseJourneyKey);
                    if (currentJourneyEntry && !currentJourneyEntry.enabled) {
                      await TavernHelper.setLorebookEntries(bookName, [
                        {
                          uid: currentJourneyEntry.uid,
                          enabled: true,
                        },
                      ]);
                      console.log(`âœ… [å­˜æ¡£] å·²ç¡®ä¿å½“å‰å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®"${baseJourneyKey}"ä¿æŒæ¿€æ´»`);
                    }
                  }
                } catch (error) {
                  console.error('âŒ åˆ›å»ºç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®æ—¶å‡ºé”™:', error);
                  console.warn('âš ï¸ è­¦å‘Šï¼šåˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®å¤±è´¥ï¼Œä½†ä¸»æ•°æ®ä»ä¼šä¿å­˜ã€‚');
                }

                // æ„å»ºå­˜æ¡£æ•°æ®
                const saveData = {
                  timestamp: Date.now(),
                  save_name: saveName,
                  type: 'manual',
                  timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), // ğŸ”¥ ä½¿ç”¨å›åˆå¿«ç…§æ•°ç»„
                  lorebook_entries: lorebookEntries, // ğŸ”¥ ä¿å­˜ä¸–ç•Œä¹¦æ¡ç›®åç§°
                  snapshot_data: {
                    mvu_data: gameState,
                    lorebook_content: {
                      journey: journeyContent,
                    },
                  },
                  message_content: currentMessage,
                };

                allSaves[slotId] = saveData;
                localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));

                console.log(`âœ… å­˜æ¡£"${saveName}"å·²ä¿å­˜åˆ°å­˜æ¡£ä½ ${slotId.split('_')[1]}`);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage(`å­˜æ¡£"${saveName}"å·²ä¿å­˜ï¼`);
                }
              } catch (error) {
                console.error('å­˜æ¡£å¤±è´¥:', error);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage(`å­˜æ¡£å¤±è´¥: ${error.message}`);
                }
              }
            };

            if (slotExists) {
              const confirmMsg = `å­˜æ¡£ä½ ${slotId.split('_')[1]} å·²æœ‰æ•°æ®ï¼Œç¡®å®šè¦è¦†ç›–å—ï¼Ÿ`;
              const ok = await this.showFullscreenConfirm(confirmMsg, {
                title: 'è¦†ç›–å­˜æ¡£',
                icon: 'âš ï¸',
                confirmText: 'è¦†ç›–',
                cancelText: 'å–æ¶ˆ',
                danger: true,
              });
              if (ok) await performSave();
            } else {
              await performSave();
            }
          } catch (error) {
            console.error('å­˜æ¡£è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`å­˜æ¡£å¤±è´¥: ${error.message}`);
            }
          }
        }

        // ğŸ”¥ å­˜æ¡£åŠŸèƒ½å·²åˆ é™¤
        async loadGame_DELETED(slotId = 'slot_1') {
          try {
            const allSaves = this.getSavesFromStorage();
            const saveData = allSaves[slotId];

            if (!saveData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('å­˜æ¡£ä¸å­˜åœ¨ï¼');
              }
              return;
            }

            const saveName = saveData.save_name || `å­˜æ¡£${slotId.split('_')[1]}`;
            const ok = await this.showFullscreenConfirm(
              `ç¡®å®šè¦è¯»å–å­˜æ¡£"${saveName}"å—ï¼Ÿå½“å‰æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦å°†ä¼šè¢«è¦†ç›–ã€‚`,
              { title: 'è¯»å–å­˜æ¡£', icon: 'ğŸ“–', confirmText: 'è¯»å–', cancelText: 'å–æ¶ˆ' },
            );
            if (!ok) return;

            // ğŸ”¥ æ¢å¤å›åˆå¿«ç…§å†å²ï¼ˆæ ¸å¿ƒï¼šæ¢å¤å®Œæ•´çš„chatHistoryCacheï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­åœ¨è¿™ä¸ªå†å²åŸºç¡€ä¸Šå­˜æ¡£ï¼‰
            if (
              saveData.timeline_history &&
              Array.isArray(saveData.timeline_history) &&
              saveData.timeline_history.length > 0
            ) {
              console.log('ğŸ”„ æ¢å¤å›åˆå¿«ç…§å†å² (' + saveData.timeline_history.length + ' ä¸ªå›åˆ)...');

              // ğŸ”¥ æ¢å¤chatHistoryCacheï¼ˆæ·±æ‹·è´ï¼Œç¡®ä¿ç‹¬ç«‹ï¼‰
              this.chatHistoryCache = JSON.parse(JSON.stringify(saveData.timeline_history));

              // ğŸ”¥ ä¿å­˜åˆ°å½“å‰ä¼šè¯çš„å†å²è®°å½•å­˜å‚¨ï¼ˆè¿™æ ·è¯»æ¡£åå¯ä»¥ç»§ç»­å­˜æ¡£ï¼‰
              const historyKey = this._getHistoryKey();
              localStorage.setItem(historyKey, JSON.stringify(this.chatHistoryCache));
              this.historyViewIndex = this.chatHistoryCache.length - 1;

              console.log(`âœ… å›åˆå¿«ç…§å†å²å·²æ¢å¤ (${saveData.timeline_history.length} ä¸ªå›åˆ)ï¼Œå·²ä¿å­˜åˆ°å½“å‰ä¼šè¯`);

              // ğŸ”¥ æ¢å¤æœ€åä¸€æ¡æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆè®©ç”¨æˆ·çœ‹åˆ°è¯»æ¡£åçš„çŠ¶æ€ï¼‰
              // å‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
              const lastSnapshot = this.chatHistoryCache[this.chatHistoryCache.length - 1];
              if (lastSnapshot && lastSnapshot.message) {
                try {
                  if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                    const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                    if (!lastMessage.extra) {
                      lastMessage.extra = {};
                    }

                    // å°†timeline_historyè½¬æ¢ä¸ºteresen_chatæ ¼å¼
                    if (saveData.timeline_history && Array.isArray(saveData.timeline_history)) {
                      lastMessage.extra.teresen_chat = saveData.timeline_history.map(snapshot => ({
                        role: 'assistant',
                        content: snapshot.message || '',
                        id: snapshot.message_id || `snapshot_${Date.now()}`,
                        timestamp: snapshot.timestamp || Date.now(),
                        variableState: snapshot.data || null,
                      }));
                    } else if (lastSnapshot && lastSnapshot.message) {
                      lastMessage.extra.teresen_chat = [
                        {
                          role: 'assistant',
                          content: lastSnapshot.message,
                          id: 'load_' + Date.now(),
                          timestamp: Date.now(),
                          variableState: lastSnapshot.data || null,
                        },
                      ];
                    }

                    // åªæ›´æ–°dataå­—æ®µï¼Œä¸æ›´æ–°messageå­—æ®µ
                    if (saveData.mvu_data) {
                      lastMessage.data = saveData.mvu_data;
                    } else if (lastSnapshot && lastSnapshot.data) {
                      lastMessage.data = lastSnapshot.data;
                    }

                    // ä¿å­˜åˆ°extra.teresen_chat
                    if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                      await SillyTavern.saveChat();
                      console.log('âœ… èŠå¤©æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆè¯»æ¡£ï¼‰');
                    } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                      await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                      console.log('âœ… èŠå¤©æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                    }
                  }
                } catch (e) {
                  console.warn('æ¢å¤èŠå¤©æ¶ˆæ¯å¤±è´¥:', e);
                }
              }
            }
            // ğŸ”¥ å…¼å®¹æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆmessage_contentï¼‰
            else if (saveData.message_content) {
              console.log('âš ï¸ ä½¿ç”¨æ—§ç‰ˆå­˜æ¡£æ ¼å¼ï¼Œåªæ¢å¤å•æ¡æ¶ˆæ¯');

              // ğŸ”¥ å‚è€ƒåˆ†æ2.jsçš„æ–¹å¼ï¼šä¿å­˜åˆ°æœ€åä¸€æ¡æ¶ˆæ¯çš„extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯
              if (typeof SillyTavern !== 'undefined' && SillyTavern.chat && SillyTavern.chat.length > 0) {
                const lastMessage = SillyTavern.chat[SillyTavern.chat.length - 1];
                if (!lastMessage.extra) {
                  lastMessage.extra = {};
                }

                lastMessage.extra.teresen_chat = [
                  {
                    role: 'assistant',
                    content: saveData.message_content || '',
                    id: 'load_' + Date.now(),
                    timestamp: Date.now(),
                    variableState: saveData.mvu_data || null,
                  },
                ];

                // åªæ›´æ–°dataå­—æ®µï¼Œä¸æ›´æ–°messageå­—æ®µ
                if (saveData.mvu_data) {
                  lastMessage.data = saveData.mvu_data;
                }

                if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                  await SillyTavern.saveChat();
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæ—§ç‰ˆæ ¼å¼ï¼‰');
                } else if (typeof TavernHelper !== 'undefined' && TavernHelper.setChatMessages) {
                  await TavernHelper.setChatMessages([lastMessage], { refresh: 'none' });
                  console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
                }

                // ğŸ”¥ å¼ºåˆ¶æ›´æ–°æ–‡æœ¬å†…å®¹
                if (typeof this.updateInterface === 'function') {
                  await this.updateInterface();
                }
              }
            }

            // æ¢å¤æ¸¸æˆçŠ¶æ€
            if (saveData.snapshot_data && saveData.snapshot_data.mvu_data) {
              this.currentMvuState = saveData.snapshot_data.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');
            } else if (saveData.mvu_data) {
              // å…¼å®¹æ—§æ ¼å¼
              this.currentMvuState = saveData.mvu_data;
              this.renderUI(this.currentMvuState.stat_data);
              console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤ï¼ˆæ—§æ ¼å¼ï¼‰');
            }

            // ğŸ”¥ æ¢å¤ä¸–ç•Œä¹¦å†…å®¹å¹¶æ¿€æ´»ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼šè®©AIè®°ä½ä¹‹å‰çš„ç»å†ï¼‰
            // ğŸ”¥ å…³é”®ï¼šä»ç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®æ¢å¤åˆ°å½“å‰å‘¨ç›®çš„æ¡ç›®
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const baseJourneyKey = this._getBaseJourneyKey();

            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);

              // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ç‹¬ç«‹çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆæ–°ç‰ˆæœ¬å­˜æ¡£æ ¼å¼ï¼‰
              if (saveData.lorebook_entries) {
                const entries = saveData.lorebook_entries;

                // æŸ¥æ‰¾å­˜æ¡£çš„ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆæŒ‰commentåŒ¹é…ï¼‰
                const saveJourneyEntry = allEntries.find(entry => entry.comment === entries.journey_entry_name);

                // æŸ¥æ‰¾å½“å‰å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆæŒ‰commentåŒ¹é…ï¼‰
                const currentJourneyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);

                // ğŸ”¥ æ¢å¤"æœ¬å‘¨ç›®ç»å†"ï¼ˆå‚è€ƒæ­£æ–‡å‚è€ƒ.htmlçš„å®ç°ï¼‰
                if (saveJourneyEntry) {
                  const contentToRestore = saveJourneyEntry.content || '';
                  console.log(
                    `[è¯»æ¡£] æ‰¾åˆ°å­˜æ¡£çš„ä¸–ç•Œä¹¦æ¡ç›®"${entries.journey_entry_name}"ï¼Œå†…å®¹é•¿åº¦: ${contentToRestore.length}`,
                  );

                  if (currentJourneyEntry) {
                    // ğŸ”¥ ç›´æ¥æ›´æ–°å½“å‰å‘¨ç›®çš„æ¡ç›®å†…å®¹ï¼ˆä½¿ç”¨uidï¼Œå‚è€ƒæ­£æ–‡å‚è€ƒ.htmlï¼‰
                    await TavernHelper.setLorebookEntries(bookName, [
                      {
                        uid: currentJourneyEntry.uid,
                        content: contentToRestore,
                        enabled: true, // ğŸ”¥ ç¡®ä¿æ¿€æ´»
                      },
                    ]);
                    console.log(
                      `âœ… [è¯»æ¡£] å·²æ›´æ–°å¹¶æ¿€æ´»"${baseJourneyKey}"æ¡ç›®ï¼ˆUID: ${currentJourneyEntry.uid}ï¼‰ï¼Œå†…å®¹é•¿åº¦: ${contentToRestore.length}`,
                    );
                  } else {
                    // åˆ›å»ºæ–°æ¡ç›®å¹¶æ¿€æ´»
                    await TavernHelper.createLorebookEntries(bookName, [
                      {
                        comment: baseJourneyKey,
                        content: contentToRestore,
                        keys: [baseJourneyKey],
                        enabled: true, // ğŸ”¥ æ¿€æ´»
                        position: 'before_character_definition',
                        order: 20,
                      },
                    ]);
                    console.log(`âœ… [è¯»æ¡£] åˆ›å»º"${baseJourneyKey}"æ¡ç›®ï¼Œå†…å®¹é•¿åº¦: ${contentToRestore.length}`);
                  }
                } else {
                  console.warn(
                    `âš ï¸ [è¯»æ¡£] æ‰¾ä¸åˆ°å­˜æ¡£çš„ä¸–ç•Œä¹¦æ¡ç›®"${entries.journey_entry_name}"ï¼Œå°è¯•ä½¿ç”¨snapshot_dataä¸­çš„å†…å®¹`,
                  );
                  // å¦‚æœæ‰¾ä¸åˆ°ç‹¬ç«‹æ¡ç›®ï¼Œå°è¯•ä½¿ç”¨snapshot_dataä¸­çš„å†…å®¹
                  if (saveData.snapshot_data && saveData.snapshot_data.lorebook_content) {
                    const journeyContent = saveData.snapshot_data.lorebook_content.journey || '';
                    if (currentJourneyEntry && journeyContent) {
                      await TavernHelper.setLorebookEntries(bookName, [
                        {
                          uid: currentJourneyEntry.uid,
                          content: journeyContent,
                          enabled: true,
                        },
                      ]);
                      console.log(`âœ… [è¯»æ¡£] ä½¿ç”¨snapshot_dataæ¢å¤"${baseJourneyKey}"æ¡ç›®`);
                    }
                  }
                }

                // ğŸ”¥ ç¦ç”¨æ‰€æœ‰å…¶ä»–å‘¨ç›®çš„"æœ¬å‘¨ç›®ç»å†"æ¡ç›®ï¼Œç¡®ä¿åªæœ‰å½“å‰å‘¨ç›®çš„æ¡ç›®æ¿€æ´»
                const entriesToDisable = [];
                const entriesToEnable = [];

                // é‡æ–°è·å–æ‰€æœ‰æ¡ç›®ï¼ˆå› ä¸ºå¯èƒ½å·²ç»æ›´æ–°äº†ï¼‰
                const updatedEntries = await TavernHelper.getLorebookEntries(bookName);

                for (const entry of updatedEntries) {
                  const isJourneyEntry = entry.comment.startsWith('æœ¬å‘¨ç›®ç»å†');
                  if (!isJourneyEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;

                  if (isCurrentJourney) {
                    // ğŸ”¥ ç¡®ä¿å½“å‰å‘¨ç›®çš„æ¡ç›®å·²æ¿€æ´»ï¼ˆä½¿ç”¨uidï¼‰
                    if (!entry.enabled) {
                      entriesToEnable.push({ uid: entry.uid, enabled: true });
                      console.log(`[è¯»æ¡£] éœ€è¦æ¿€æ´»å½“å‰å‘¨ç›®çš„æ¡ç›®"${baseJourneyKey}"ï¼ˆUID: ${entry.uid}ï¼‰`);
                    }
                  } else {
                    // å¦‚æœä¸æ˜¯å½“å‰å‘¨ç›®çš„æ¡ç›®ï¼Œåˆ™ç¦ç”¨ï¼ˆä½¿ç”¨uidï¼‰
                    if (entry.enabled) {
                      entriesToDisable.push({ uid: entry.uid, enabled: false });
                    }
                  }
                }

                // ğŸ”¥ æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨uidç¡®ä¿å‡†ç¡®æ€§ï¼‰
                const allUpdates = [...entriesToEnable, ...entriesToDisable];
                if (allUpdates.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, allUpdates);
                  if (entriesToEnable.length > 0) {
                    console.log(`âœ… [è¯»æ¡£] å·²æ¿€æ´»å½“å‰å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®"${baseJourneyKey}"`);
                  }
                  if (entriesToDisable.length > 0) {
                    console.log(`âœ… [è¯»æ¡£] å·²ç¦ç”¨ ${entriesToDisable.length} ä¸ªå…¶ä»–å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®`);
                  }
                }

                console.log('âœ… [è¯»æ¡£] ä¸–ç•Œä¹¦è®°å¿†åŠŸèƒ½å·²æ¢å¤ï¼ˆä»ç‹¬ç«‹æ¡ç›®ï¼‰ï¼AIç°åœ¨å¯ä»¥è®°ä½å­˜æ¡£æ—¶çš„æ‰€æœ‰è®°å¿†');
              }
              // ğŸ”¥ å…¼å®¹æ—§ç‰ˆæœ¬æ ¼å¼ï¼ˆç›´æ¥ä½¿ç”¨snapshot_dataä¸­çš„å†…å®¹ï¼Œå‚è€ƒæ­£æ–‡å‚è€ƒ.htmlï¼‰
              else if (saveData.snapshot_data && saveData.snapshot_data.lorebook_content) {
                const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);

                // ğŸ”¥ æ¢å¤å¹¶æ¿€æ´»å½“å‰å‘¨ç›®çš„"æœ¬å‘¨ç›®ç»å†"ï¼ˆä½¿ç”¨uidï¼Œå‚è€ƒæ­£æ–‡å‚è€ƒ.htmlï¼‰
                if (journeyEntry) {
                  await TavernHelper.setLorebookEntries(bookName, [
                    {
                      uid: journeyEntry.uid,
                      content: saveData.snapshot_data.lorebook_content.journey || '',
                      enabled: true, // ğŸ”¥ æ¿€æ´»ï¼šè®©AIèƒ½è¯»å–è¿™ä¸ªè®°å¿†
                    },
                  ]);
                  console.log(
                    `âœ… [è¯»æ¡£] "${baseJourneyKey}"å·²æ¢å¤å¹¶æ¿€æ´»ï¼ˆUID: ${journeyEntry.uid}ï¼‰ï¼ŒAIç°åœ¨èƒ½è®°ä½ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…`,
                  );
                } else {
                  console.warn(`âš ï¸ [è¯»æ¡£] æ‰¾ä¸åˆ°"${baseJourneyKey}"æ¡ç›®ï¼Œæ— æ³•æ¢å¤`);
                }

                // ğŸ”¥ ç¦ç”¨æ‰€æœ‰å…¶ä»–å‘¨ç›®çš„æ¡ç›®ï¼Œå¹¶ç¡®ä¿å½“å‰å‘¨ç›®çš„æ¡ç›®å·²æ¿€æ´»ï¼ˆä½¿ç”¨uidï¼‰
                const entriesToDisable = [];
                const entriesToEnable = [];

                // é‡æ–°è·å–æ‰€æœ‰æ¡ç›®ï¼ˆå› ä¸ºå¯èƒ½å·²ç»æ›´æ–°äº†ï¼‰
                const updatedEntries = await TavernHelper.getLorebookEntries(bookName);

                for (const entry of updatedEntries) {
                  const isJourneyEntry = entry.comment.startsWith('æœ¬å‘¨ç›®ç»å†');
                  if (!isJourneyEntry) continue;

                  const isCurrentJourney = entry.comment === baseJourneyKey;

                  if (isCurrentJourney) {
                    // ç¡®ä¿å½“å‰å‘¨ç›®çš„æ¡ç›®å·²æ¿€æ´»ï¼ˆä½¿ç”¨uidï¼‰
                    if (!entry.enabled) {
                      entriesToEnable.push({ uid: entry.uid, enabled: true });
                    }
                  } else {
                    // å¦‚æœä¸æ˜¯å½“å‰å‘¨ç›®çš„æ¡ç›®ï¼Œåˆ™ç¦ç”¨ï¼ˆä½¿ç”¨uidï¼‰
                    if (entry.enabled) {
                      entriesToDisable.push({ uid: entry.uid, enabled: false });
                    }
                  }
                }

                // æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨uidç¡®ä¿å‡†ç¡®æ€§ï¼‰
                const allUpdates = [...entriesToEnable, ...entriesToDisable];
                if (allUpdates.length > 0) {
                  await TavernHelper.setLorebookEntries(bookName, allUpdates);
                  if (entriesToEnable.length > 0) {
                    console.log(`âœ… [è¯»æ¡£] å·²æ¿€æ´»å½“å‰å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®"${baseJourneyKey}"`);
                  }
                  if (entriesToDisable.length > 0) {
                    console.log(`âœ… [è¯»æ¡£] å·²ç¦ç”¨ ${entriesToDisable.length} ä¸ªå…¶ä»–å‘¨ç›®çš„ä¸–ç•Œä¹¦æ¡ç›®`);
                  }
                }

                console.log('âœ… [è¯»æ¡£] ä¸–ç•Œä¹¦è®°å¿†åŠŸèƒ½å·²æ¢å¤ï¼ˆæ—§æ ¼å¼ï¼‰ï¼AIç°åœ¨å¯ä»¥è®°ä½å­˜æ¡£æ—¶çš„æ‰€æœ‰è®°å¿†');
              }
            } catch (e) {
              console.error('âŒ æ¢å¤ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥:', e);
            }

            await this.updateInterface();
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`å­˜æ¡£"${saveName}"åŠ è½½æˆåŠŸï¼AIç°åœ¨å¯ä»¥è®°ä½ä¹‹å‰çš„å¯¹è¯äº†ã€‚`);
            }

            // åˆ·æ–°å­˜æ¡£åˆ—è¡¨
            if (document.getElementById('saveManagerModal')) {
              this.showSaveLoadManager();
              setTimeout(() => {
                this.bindSaveSlotListeners();
              }, 100);
            }
          } catch (error) {
            console.error('âŒ åŠ è½½å­˜æ¡£å¤±è´¥:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('åŠ è½½å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        // ğŸ”¥ åˆ›å»ºå¾…å®šè‡ªåŠ¨å­˜æ¡£ï¼ˆåœ¨å‘é€æ¶ˆæ¯å‰ï¼‰
        async createPendingAutoSave() {
          if (!this.isAutoSaveEnabled) {
            this.pendingAutoSave = null;
            return;
          }

          try {
            // å¦‚æœcurrentMvuStateä¸å­˜åœ¨ï¼Œä»getAllVariablesè·å–
            let mvuState = this.currentMvuState;
            if (!mvuState || !mvuState.stat_data) {
              console.log('[AutoSave] currentMvuStateæœªè®¾ç½®ï¼Œä»getAllVariablesè·å–...');
              mvuState = this.getAllVariables();
              // æ›´æ–°currentMvuStateä»¥ä¾¿åç»­ä½¿ç”¨
              if (mvuState && mvuState.stat_data) {
                this.currentMvuState = mvuState;
              }
            }

            if (!mvuState || !mvuState.stat_data) {
              console.warn('[AutoSave] æ— æ³•è·å–MVUçŠ¶æ€ï¼Œè·³è¿‡è‡ªåŠ¨å­˜æ¡£');
              this.pendingAutoSave = null;
              return;
            }

            let currentMessageContent = '';
            try {
              const messages = await getChatMessages('0');
              currentMessageContent = messages?.[0]?.message || '';
            } catch (e) {
              console.warn('[AutoSave] åˆ›å»ºå¿«ç…§æ—¶è·å–æ¶ˆæ¯å†…å®¹å¤±è´¥ã€‚');
            }

            // è¯»å–å½“å‰ä¸–ç•Œä¹¦å†…å®¹
            const bookName = '- èµ›é©¬å¨˜ ç‰¹é›·æ£®æ€ªè°ˆ';
            const baseJourneyKey = this._getBaseJourneyKey();
            let journeyContent = '';
            try {
              const allEntries = await TavernHelper.getLorebookEntries(bookName);
              const journeyEntry = allEntries.find(entry => entry.comment === baseJourneyKey);
              journeyContent = journeyEntry?.content || '';
            } catch (e) {
              console.warn('[AutoSave] è¯»å–ä¸–ç•Œä¹¦å†…å®¹å¤±è´¥ã€‚');
            }

            this.pendingAutoSave = {
              timestamp: Date.now(),
              save_name: 'è‡ªåŠ¨å­˜æ¡£ - ä¸Šä¸€å›åˆ',
              message_content: currentMessageContent,
              timeline_history: JSON.parse(JSON.stringify(this.chatHistoryCache)), // ä¿å­˜å½“å‰å›åˆå¿«ç…§å†å²
              snapshot_data: {
                mvu_data: JSON.parse(JSON.stringify(mvuState)),
                lorebook_content: {
                  journey: journeyContent,
                },
              },
            };

            console.log('[AutoSave] å·²åˆ›å»ºå¾…å®šè‡ªåŠ¨å­˜æ¡£å¿«ç…§');
          } catch (error) {
            console.error('[AutoSave] åˆ›å»ºå¾…å®šå­˜æ¡£å¿«ç…§æ—¶å‡ºé”™:', error);
            this.pendingAutoSave = null;
          }
        }

        // ğŸ”¥ æäº¤è‡ªåŠ¨å­˜æ¡£ï¼ˆåœ¨AIå›å¤åï¼‰
        async performAutoSave() {
          if (!this.isAutoSaveEnabled || !this.pendingAutoSave) {
            return;
          }

          try {
            // ğŸ”¥ ä½¿ç”¨chatIdä½œä¸ºé”®çš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿ä¸åŒæ¸¸æˆä¼šè¯çš„è‡ªåŠ¨å­˜æ¡£åˆ†å¼€å­˜å‚¨
            const chatId = TavernHelper?.chatId || 'default';
            const autoSaveKey = `teresen_auto_save_${chatId}`;

            // è¯»å–å½“å‰ä¼šè¯çš„è‡ªåŠ¨å­˜æ¡£
            let currentAutoSaves = {};
            try {
              const saved = localStorage.getItem(autoSaveKey);
              if (saved) {
                currentAutoSaves = JSON.parse(saved);
              }
            } catch (e) {
              console.warn('[AutoSave] è¯»å–å½“å‰ä¼šè¯è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°çš„:', e);
            }

            // å°†ä¸Šä¸€æ¬¡è‡ªåŠ¨å­˜æ¡£ç§»åˆ°auto_save_slot_1
            if (currentAutoSaves['auto_save_slot_0']) {
              currentAutoSaves['auto_save_slot_1'] = JSON.parse(JSON.stringify(currentAutoSaves['auto_save_slot_0']));
              currentAutoSaves['auto_save_slot_1'].save_name = 'è‡ªåŠ¨å­˜æ¡£ - ä¸Šä¸€æ¬¡';
            }

            // å°†å¾…å®šå­˜æ¡£æäº¤ä¸ºæœ€æ–°è‡ªåŠ¨å­˜æ¡£
            currentAutoSaves['auto_save_slot_0'] = this.pendingAutoSave;
            currentAutoSaves['auto_save_slot_0'].save_name = 'è‡ªåŠ¨å­˜æ¡£ - æœ€æ–°';

            localStorage.setItem(autoSaveKey, JSON.stringify(currentAutoSaves));
            console.log(`[AutoSave] âœ… å·²æäº¤è‡ªåŠ¨å­˜æ¡£ (chatId: ${chatId})`);
          } catch (error) {
            console.error('[AutoSave] æäº¤è‡ªåŠ¨å­˜æ¡£æ—¶å‘ç”Ÿé”™è¯¯:', error);
          } finally {
            this.pendingAutoSave = null;
          }
        }

        // ğŸ”¥ æ˜¾ç¤ºå­˜æ¡£ç®¡ç†ç•Œé¢ï¼ˆå¤šä¸ªå­˜æ¡£æ§½ä½ï¼‰
        showSaveLoadManager() {
          const autoContainer = document.getElementById('auto-save-slot-container');
          const manualContainer = document.getElementById('save-slots-container');
          if (!autoContainer || !manualContainer) return;

          let saves;
          try {
            saves = this.getSavesFromStorage();
          } catch (e) {
            console.error('è§£æå­˜æ¡£æ–‡ä»¶å¤±è´¥:', e);
            manualContainer.innerHTML = `<div style="color: #ff6b6b; padding: 20px; text-align: center;"><p>é”™è¯¯ï¼šå­˜æ¡£æ–‡ä»¶å·²æŸåã€‚</p></div>`;
            autoContainer.innerHTML = '';
            return;
          }

          // 1. æ¸²æŸ“è‡ªåŠ¨å­˜æ¡£æ§½ä½
          let autoSaveHtml = '';
          const autoSaveSlots = [
            { id: 'auto_save_slot_0', name: 'æœ€æ–°è‡ªåŠ¨å­˜æ¡£', color: '#66CDAA' },
            { id: 'auto_save_slot_1', name: 'ä¸Šä¸€æ¬¡è‡ªåŠ¨å­˜æ¡£', color: '#FFD700' },
          ];

          autoSaveSlots.forEach(slotInfo => {
            const autoSaveData = saves[slotInfo.id];
            autoSaveHtml += `<div class="save-slot" data-slot-id="${slotInfo.id}" style="margin-bottom: 10px; padding: 10px; background: rgba(45, 27, 27, 0.6); border: 1px solid rgba(139, 105, 20, 0.5); border-radius: 6px; backdrop-filter: blur(2px);">`;
            if (autoSaveData && autoSaveData.snapshot_data && autoSaveData.snapshot_data.mvu_data) {
              const date = new Date(autoSaveData.timestamp).toLocaleString('zh-CN');
              const statData = autoSaveData.snapshot_data.mvu_data.stat_data || {};
              const summary = this._getDisplayText(autoSaveData.message_content || '');

              autoSaveHtml += `
                <div class="save-slot-info" style="margin-bottom: 10px;">
                  <div class="slot-name" style="color: ${slotInfo.color}; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${slotInfo.name}</div>
                  <div class="slot-time" style="color: #d4c4a8; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${date}</div>
                  <div class="slot-summary" style="color: #c9b99b; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${summary ? summary.substring(0, 40) + '...' : 'æ— æ­£æ–‡è®°å½•'}</div>
                </div>
                <div class="save-slot-actions" style="display: flex; gap: 5px;">
                  <button class="interaction-btn btn-load-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #4a6741, #5a7a51); border: 1px solid #6b8e5a; color: #f0e6d2; cursor: pointer; font-weight: 500;">è¯»æ¡£</button>
                  <button class="interaction-btn btn-export-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #5a4a3a, #6a5a4a); border: 1px solid #7a6a5a; color: #f0e6d2; cursor: pointer; font-weight: 500;">å¯¼å‡º</button>
                  <button class="interaction-btn btn-delete-slot" data-slot-id="${slotInfo.id}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #b00000; color: #ffffff; cursor: pointer; font-weight: 500;">åˆ é™¤</button>
                </div>
              `;
            } else {
              autoSaveHtml += `
                <div class="save-slot-info" style="margin-bottom: 10px;">
                  <div class="slot-name" style="color: ${slotInfo.color}; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${slotInfo.name}</div>
                  <div class="slot-time" style="font-style: italic; color: #d4c4a8; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">æ— è‡ªåŠ¨å­˜æ¡£è®°å½•</div>
                </div>
                <div class="save-slot-actions" style="display: flex; gap: 5px;">
                  <button class="interaction-btn btn-load-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(74, 103, 65, 0.3); border: 1px solid rgba(107, 142, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;">è¯»æ¡£</button>
                  <button class="interaction-btn btn-export-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(90, 74, 58, 0.3); border: 1px solid rgba(122, 106, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;">å¯¼å‡º</button>
                  <button class="interaction-btn btn-delete-slot" disabled style="padding: 6px 12px; font-size: 12px; background: rgba(139, 0, 0, 0.3); border: 1px solid rgba(176, 0, 0, 0.3); color: rgba(255, 255, 255, 0.5); cursor: not-allowed;">åˆ é™¤</button>
                </div>
              `;
            }
            autoSaveHtml += `</div>`;
          });
          autoContainer.innerHTML = autoSaveHtml;

          // 2. æ¸²æŸ“æ‰‹åŠ¨å­˜æ¡£æ§½ä½
          let manualHtml = '';
          const totalSlots = 5;
          for (let i = 1; i <= totalSlots; i++) {
            const slotId = `slot_${i}`;
            const saveData = saves[slotId];

            manualHtml += `<div class="save-slot" data-slot-id="${slotId}" style="margin-bottom: 10px; padding: 10px; background: rgba(45, 27, 27, 0.6); border: 1px solid rgba(139, 105, 20, 0.5); border-radius: 6px; backdrop-filter: blur(2px);">`;
            manualHtml += `<div class="save-slot-info" style="margin-bottom: 10px;">`;

            if (saveData && saveData.snapshot_data && saveData.snapshot_data.mvu_data) {
              const date = new Date(saveData.timestamp).toLocaleString('zh-CN');
              const statData = saveData.snapshot_data.mvu_data.stat_data || {};
              const summary = this._getDisplayText(saveData.message_content || '');
              // ğŸ”¥ ä¿®å¤ï¼šç¡®ä¿æ­£ç¡®è¯»å–å­˜æ¡£åç§°
              const saveName = saveData.save_name || saveData.saveName || `å­˜æ¡£ ${i}`;

              manualHtml += `
                <div class="slot-name" style="font-weight: bold; margin-bottom: 5px; color: #f0e6d2; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${saveName}</div>
                <div class="slot-time" style="color: #d4c4a8; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${date}</div>
                <div class="slot-summary" style="color: #c9b99b; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${summary ? summary.substring(0, 40) + '...' : 'æ— æ­£æ–‡è®°å½•'}</div>
              `;
            } else {
              manualHtml += `
                <div class="slot-name" style="font-weight: bold; margin-bottom: 5px; color: #f0e6d2; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">å­˜æ¡£ ${i}</div>
                <div class="slot-time" style="font-style: italic; color: #d4c4a8; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">ç©ºå­˜æ¡£ä½</div>
              `;
            }

            manualHtml += `</div>`;
            manualHtml += `<div class="save-slot-actions" style="display: flex; gap: 5px;">`;

            // å­˜æ¡£æŒ‰é’®ï¼ˆæ€»æ˜¯å¯ç”¨ï¼‰
            const saveBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #6a5a4a, #7a6a5a); border: 1px solid #8a7a6a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #6a5a4a, #7a6a5a); border: 1px solid #8a7a6a; color: #f0e6d2; cursor: pointer; font-weight: 500;';
            manualHtml += `<button class="interaction-btn btn-save-slot" data-slot-id="${slotId}" style="${saveBtnStyle}">å­˜æ¡£</button>`;

            // è¯»æ¡£æŒ‰é’®
            const loadBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #4a6741, #5a7a51); border: 1px solid #6b8e5a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(74, 103, 65, 0.3); border: 1px solid rgba(107, 142, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-load-slot" data-slot-id="${slotId}" style="${loadBtnStyle}" ${!saveData ? 'disabled' : ''}>è¯»æ¡£</button>`;

            // å¯¼å‡ºæŒ‰é’®
            const exportBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #5a4a3a, #6a5a4a); border: 1px solid #7a6a5a; color: #f0e6d2; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(90, 74, 58, 0.3); border: 1px solid rgba(122, 106, 90, 0.3); color: rgba(240, 230, 210, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-export-slot" data-slot-id="${slotId}" style="${exportBtnStyle}" ${!saveData ? 'disabled' : ''}>å¯¼å‡º</button>`;

            // åˆ é™¤æŒ‰é’®
            const deleteBtnStyle = saveData
              ? 'padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #b00000; color: #ffffff; cursor: pointer; font-weight: 500;'
              : 'padding: 6px 12px; font-size: 12px; background: rgba(139, 0, 0, 0.3); border: 1px solid rgba(176, 0, 0, 0.3); color: rgba(255, 255, 255, 0.5); cursor: not-allowed;';
            manualHtml += `<button class="interaction-btn btn-delete-slot" data-slot-id="${slotId}" style="${deleteBtnStyle}" ${!saveData ? 'disabled' : ''}>åˆ é™¤</button>`;

            manualHtml += `</div></div>`;
          }
          manualContainer.innerHTML = manualHtml;
        }

        // ğŸ”¥ ç»‘å®šå­˜æ¡£æ§½ä½æŒ‰é’®äº‹ä»¶
        bindSaveSlotListeners() {
          // å­˜æ¡£æŒ‰é’®
          document.querySelectorAll('.btn-save-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId) {
                await this.saveGame(slotId);
                // åˆ·æ–°ç•Œé¢
                this.showSaveLoadManager();
                setTimeout(() => {
                  this.bindSaveSlotListeners();
                }, 100);
              }
            });
          });

          // è¯»æ¡£æŒ‰é’®
          document.querySelectorAll('.btn-load-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                await this.loadGame(slotId);
              }
            });
          });

          // åˆ é™¤æŒ‰é’®
          document.querySelectorAll('.btn-delete-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                const ok = await this.showFullscreenConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ', {
                  title: 'åˆ é™¤å­˜æ¡£',
                  icon: 'ğŸ—‘ï¸',
                  confirmText: 'åˆ é™¤',
                  cancelText: 'å–æ¶ˆ',
                  danger: true,
                });
                if (ok) {
                  const allSaves = this.getSavesFromStorage();
                  delete allSaves[slotId];
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));
                  // åˆ·æ–°ç•Œé¢
                  this.showSaveLoadManager();
                  setTimeout(() => {
                    this.bindSaveSlotListeners();
                  }, 100);
                }
              }
            });
          });

          // å¯¼å‡ºæŒ‰é’®
          document.querySelectorAll('.btn-export-slot').forEach(btn => {
            btn.addEventListener('click', async e => {
              const slotId = e.target.dataset.slotId;
              if (slotId && !e.target.disabled) {
                const allSaves = this.getSavesFromStorage();
                const saveData = allSaves[slotId];
                if (saveData) {
                  const jsonString = JSON.stringify(saveData, null, 2);
                  const blob = new Blob([jsonString], { type: 'application/json' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `å­˜æ¡£_${saveData.save_name || slotId}_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                }
              }
            });
          });
        }

        // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šè·å–æ˜¾ç¤ºæ–‡æœ¬
        _getDisplayText(messageContent) {
          if (!messageContent) return '';
          const contentMatch = messageContent.match(/<content>(.*?)<\/content>/s);
          if (contentMatch) {
            return contentMatch[1].trim();
          }
          return messageContent.substring(0, 100);
        }

        // æ–°å¤©èµ‹ç³»ç»Ÿå‡½æ•°

        showTalentsModal() {
          // æ’­æ”¾å¤©èµ‹ç®¡ç†å£°éŸ³
          const sound = document.getElementById('talent-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          const modal = document.getElementById('talents-modal');

          if (modal) {
            modal.style.display = 'flex';

            modal.style.justifyContent = 'center';

            modal.style.alignItems = 'center';

            // åˆå§‹åŒ–ç¿»é¡µç³»ç»Ÿ

            this.currentTalentPage = 0;

            this.updatePageIndicator();

            this.updatePageButtons();

            this.updateTalentsModal();

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬

            this.addKeyboardListeners();

            // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨ï¼Œä¿®å¤ç¿»é¡µé—®é¢˜

            this.addResizeListener();
          }
        }

        updateTalentsModal() {
          this.updateCurrentTalents();

          this.updateTalentOptions();

          this.updateUpgradeHistory();

          this.updateCurrentPageOptions();
        }

        updateCurrentTalents() {
          const container = document.getElementById('current-talents-list');

          if (!container) return;

          try {
            let majorTalent = 'æ— ';

            let crystals = 0;

            let acquiredTalents = [];

            // ä»å˜é‡è¯»å–æ•°æ® - ä½¿ç”¨å’ŒupdateTrainerStatusç›¸åŒçš„æ–¹å¼
            const variables = this.getAllVariables();

            // è¯»å–å¤§å¤©èµ‹
            majorTalent = this.getVariable(variables, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', 'æ— ');

            // è¯»å–ç»“æ™¶ - ä½¿ç”¨å’Œä½ç½®ã€æ—¶é—´ç›¸åŒçš„æ–¹å¼
            const crystalsValue = this.getVariable(variables, 'stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', 0);
            crystals = parseInt(crystalsValue) || 0;
            console.log('ğŸ’ updateCurrentTalents - è¯»å–ç»“æ™¶æ•°é‡:', { raw: crystalsValue, parsed: crystals });

            // è¯»å–å·²è·å¾—çš„å¤©èµ‹
            const levels = ['èŒèŠ½', 'ç”Ÿé•¿', 'ç•¸å˜', 'æƒæŸ„', 'æ·±æ¸Š'];
            levels.forEach(level => {
              const talent = this.getVariable(variables, `stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${level}`, null);
              if (talent) {
                acquiredTalents.push({
                  level: level,
                  title: talent,
                });
              }
            });

            // è·å–å¤§å¤©èµ‹æè¿°è¯

            const talentInfo = this.getMajorTalentDescription(majorTalent);

            let html = `

              <div style="max-width: 800px; margin: 0 auto;">

                <!-- å¤§å¤©èµ‹ä¿¡æ¯å¡ç‰‡ -->

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(139, 69, 19, 0.05)); border: 2px solid rgba(139, 69, 19, 0.3); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    
                    <h4 style="color: #8b4513; font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px;">

                      <span style="font-size: 20px;">ğŸ­</span>

                      ${talentInfo.name}

                    </h4>

                    <!-- ç»“æ™¶æ˜¾ç¤º -->
                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.12), rgba(168, 85, 247, 0.06)); border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 8px; padding: 8px 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                      <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 12px;">ğŸ’</span>
                        <span style="color: #a855f7; font-size: 12px; font-weight: 600;">ç»“æ™¶</span>
                        <span style="color: #a855f7; font-size: 14px; font-weight: bold;">${crystals}</span>
                      </div>
                    </div>

                  </div>

                  <div style="color: #8b4513; font-size: 14px; line-height: 1.6; margin-bottom: 16px; text-align: center; font-style: italic;">

                    ${talentInfo.description}

                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.03)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <!-- æ‰­æ›²çš„è£…é¥°çº¿æ¡ -->

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.6), transparent);"></div>

                      

                      <div style="color: #15803d; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(34, 197, 94, 0.3); letter-spacing: 0.5px;">åŠ›é‡ä¹‹æº</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.positive}</div>

                    </div>

                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.03)); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 16px; position: relative; overflow: hidden;">

                      <!-- æ‰­æ›²çš„è£…é¥°çº¿æ¡ -->

                      <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.6), transparent);"></div>

                      

                      <div style="color: #dc2626; font-size: 14px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(239, 68, 68, 0.3); letter-spacing: 0.5px;">ä»£ä»·ä¹‹ç—•</div>

                      <div style="color: #1a1a1a; font-size: 13px; line-height: 1.6; font-weight: 500; text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);">${talentInfo.negative}</div>

                    </div>

                  </div>

                </div>



              </div>

            `;

            // æ˜¾ç¤ºå·²è·å¾—çš„å¤©èµ‹

            if (acquiredTalents.length > 0) {
              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">

                  <h4 style="color: #22c55e; font-size: 18px; font-weight: bold; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; text-align: center; justify-content: center;">

                    <span style="font-size: 20px;">ğŸŒŸ</span>

                    å·²è·å¾—å¤©èµ‹

                  </h4>

                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">

              `;

              acquiredTalents.forEach(talent => {
                html += `

                  <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08)); border: 2px solid rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 16px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.1)'">

                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                      <span style="color: #22c55e; font-size: 14px; font-weight: bold; background: rgba(34, 197, 94, 0.25); padding: 6px 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${talent.level}</span>

                      <span style="color: #22c55e; font-size: 12px; opacity: 0.9; font-weight: 500;">âœ¨ å·²æ¿€æ´»</span>

                    </div>

                    <div style="color: #2d1b1b; font-size: 14px; line-height: 1.5; font-weight: 500;">${talent.title}</div>

                  </div>

                `;
              });

              html += `

                  </div>

                </div>

              `;
            } else {
              html += `

                <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.08), rgba(139, 69, 19, 0.04)); border: 2px solid rgba(139, 69, 19, 0.25); border-radius: 16px; padding: 40px; text-align: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;">



                  

                  <div style="font-size: 36px; margin-bottom: 16px; opacity: 0.8; filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));">ğŸ“–</div>

                  <div style="color: #8b4513; font-size: 16px; font-weight: 600; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(139, 69, 19, 0.2);">å¤©èµ‹ä¹‹ä¹¦</div>

                  <div style="color: #666666; font-size: 14px; font-style: italic; margin-bottom: 8px; opacity: 0.8;">æš‚æ— å·²è·å¾—å¤©èµ‹</div>

                  <div style="color: #8b4513; font-size: 13px; opacity: 0.7;">è¯·ç¿»é¡µæŸ¥çœ‹å¯å‡çº§çš„å¤©èµ‹é€‰é¡¹</div>

                </div>

              `;
            }

            container.innerHTML = html;
          } catch (error) {
            console.error('æ›´æ–°å½“å‰å¤©èµ‹æ˜¾ç¤ºå¤±è´¥:', error);

            container.innerHTML =
              '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">åŠ è½½å¤±è´¥</div>';
          }
        }

        updateTalentOptions() {
          const levels = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          levels.forEach(level => {
            this.updateTalentLevelOptions(level);
          });
        }

        updateTalentLevelOptions(level) {
          const container = document.getElementById(`${level}-options`);

          if (!container) return;

          const levelData = this.getTalentData(level);

          if (!levelData) return;

          // æ£€æŸ¥å‰ç½®æ¡ä»¶ï¼šä¸Šä¸€å±‚æ˜¯å¦å·²æ³¨å…¥å¤©èµ‹

          const isLevelUnlocked = this.isLevelUnlocked(level);

          if (!isLevelUnlocked) {
            // å¦‚æœå±‚çº§æœªè§£é”ï¼Œæ˜¾ç¤ºé”å®šçŠ¶æ€

            const previousLevel = this.getPreviousLevel(level);

            const previousLevelChinese = this.getLevelChineseName(previousLevel);

            container.innerHTML = `

              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(107, 114, 128, 0.05)); border: 2px dashed rgba(107, 114, 128, 0.3); border-radius: 12px;">

                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>

                <h4 style="color: #6b7280; font-size: 16px; font-weight: bold; margin-bottom: 8px;">å±‚çº§æœªè§£é”</h4>

                <p style="color: #9ca3af; font-size: 14px; line-height: 1.5; margin: 0;">éœ€è¦å…ˆå®Œæˆ <span style="color: #8b4513; font-weight: bold;">${previousLevelChinese}</span> å±‚çº§çš„å¤©èµ‹é€‰æ‹©</p>

                <p style="color: #9ca3af; font-size: 12px; margin-top: 8px; font-style: italic;">è¯·è¿”å›ä¸Šä¸€é¡µé€‰æ‹©å¤©èµ‹</p>

              </div>

            `;

            return;
          }

          let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

          // æ£€æŸ¥å½“å‰å±‚çº§æ˜¯å¦å·²æœ‰å¤©èµ‹
          const levelChineseName = this.getLevelChineseName(level);
          let currentTalent = null;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              currentTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}`, {
                default_value: null,
              });
            }
          } catch (e) {
            console.warn('è·å–å½“å‰å±‚çº§å¤©èµ‹å¤±è´¥:', e);
          }
          const hasTalent = currentTalent && currentTalent !== '';

          levelData.options.forEach((option, index) => {
            const isAcquired = this.isTalentAcquired(level, index);

            const cost = this.getTalentCost(level);

            // å¦‚æœè¯¥å±‚çº§å·²æœ‰å¤©èµ‹ä¸”ä¸æ˜¯å½“å‰é€‰é¡¹ï¼Œç¦ç”¨ç‚¹å‡»
            const isDisabled = hasTalent && !isAcquired;
            const cursorStyle = isDisabled ? 'not-allowed' : 'pointer';
            const opacityStyle = isDisabled ? '0.5' : '1';
            const onclickHandler = isDisabled
              ? ''
              : `onclick="window.teresenDebug.selectTalentOption('${level}', ${index})"`;

            html += `

              <div style="background: ${isAcquired ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08))' : 'linear-gradient(135deg, rgba(139, 69, 19, 0.12), rgba(139, 69, 19, 0.06))'}; border: 2px solid ${isAcquired ? 'rgba(34, 197, 94, 0.4)' : 'rgba(139, 69, 19, 0.3)'}; border-radius: 10px; padding: 14px; cursor: ${cursorStyle}; transition: all 0.3s; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15); opacity: ${opacityStyle};" onmouseover="${isDisabled ? '' : "this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.2)'"}" onmouseout="${isDisabled ? '' : "this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 12px rgba(0,0,0,0.15)'"}" ${onclickHandler}>

                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">

                  <h4 style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 15px; font-weight: bold; margin: 0; flex: 1; text-shadow: 0 1px 2px rgba(255,255,255,0.8);">${option.title}</h4>

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 11px; font-weight: bold; background: ${isAcquired ? 'rgba(34, 197, 94, 0.25)' : 'rgba(139, 69, 19, 0.2)'}; padding: 5px 10px; border-radius: 8px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${isAcquired ? 'âœ… å·²è·å¾—' : 'ğŸ’ ' + cost}</span>

                </div>

                <p style="color: #2d1b1b; font-size: 13px; line-height: 1.5; margin: 0 0 10px 0; font-weight: 500;">${option.description}</p>

                <div style="background: ${isAcquired ? 'rgba(34, 197, 94, 0.1)' : 'rgba(139, 69, 19, 0.08)'}; border: 1px solid ${isAcquired ? 'rgba(34, 197, 94, 0.3)' : 'rgba(139, 69, 19, 0.2)'}; border-radius: 8px; padding: 8px 10px; text-align: center;">

                  <span style="color: ${isAcquired ? '#22c55e' : '#8b4513'}; font-size: 12px; font-weight: bold; text-shadow: 0 1px 1px rgba(255,255,255,0.5);">${option.effects}</span>

                </div>

              </div>

            `;
          });

          html += '</div>';

          container.innerHTML = html;
        }

        // æ ¹æ®é¡µé¢ç´¢å¼•è·å–å¯¹åº”çš„å±‚çº§

        getLevelByPageIndex(pageIndex) {
          const levelMap = {
            0: null, // å½“å‰å¤©èµ‹é¡µé¢

            1: 'seed',

            2: 'growth',

            3: 'mutation',

            4: 'authority',

            5: 'abyss',

            6: null, // å‡çº§è®°å½•é¡µé¢
          };

          return levelMap[pageIndex];
        }

        // è·å–å¤©èµ‹æ¶ˆè€—

        getTalentCost(level) {
          const costMap = {
            seed: 3,

            growth: 12,

            mutation: 25,

            authority: 40,

            abyss: 70,
          };

          return costMap[level] || 0;
        }

        // æ›´æ–°å½“å‰é¡µé¢çš„é€‰é¡¹

        updateCurrentPageOptions() {
          const level = this.getLevelByPageIndex(this.currentTalentPage);

          if (level) {
            this.updateTalentLevelOptions(level);
          }
        }

        getTalentData(level) {
          // è·å–å½“å‰é€‰æ‹©çš„å¤§å¤©èµ‹æ–¹å‘ï¼ˆä¸ä½¿ç”¨[0]ç´¢å¼•ï¼‰

          let majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';

          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ğŸ”¥ ä¸ä½¿ç”¨[0]ç´¢å¼•ï¼Œç›´æ¥è·å–å¤§å¤©èµ‹
              majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', { default_value: null });

              // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨getAllVariablesä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
                  const allVars = window.teresenDebug.getAllVariables();
                  majorTalent = window.teresenDebug.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', null);
                }
              }

              // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
              }
            }
          } catch (error) {
            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          // æ ¹æ®å¤§å¤©èµ‹æ–¹å‘è¿”å›å¯¹åº”çš„å¤©èµ‹æ•°æ®

          const talentData = {
            seed: {
              prompt:
                'ä½ åªæ˜¯åœ¨ç»å¢ƒä¸­ï¼Œæ— æ„è¯†åœ°æŠ“ä½äº†æ±‚ç”Ÿçš„ç¨»è‰ã€‚è¿™ä»½åŠ›é‡å¾®å¼±ã€ä¸å—æ§åˆ¶ï¼Œæ˜¯ä½ åœ¨è¿™åˆ«æ ·ä¸–ç•Œä¸­å‘å‡ºçš„ç¬¬ä¸€å£°å¾®å¼±çš„å•¼å“­ã€‚',

              options: this.getTalentOptionsByMajor(majorTalent, 'seed'),
            },

            growth: {
              prompt:
                'ä½ å¼€å§‹ç†è§£å¹¶æœ‰æ„è¯†åœ°è¿ç”¨è¿™ä»½åŠ›é‡ï¼Œå°†å…¶ä½œä¸ºè§£å†³é—®é¢˜çš„å·¥å…·ã€‚ä½ ä»è¢«åŠ¨çš„å—å®³è€…ï¼Œè½¬å˜ä¸ºä¸€ä¸ªèƒ½åœ¨æ£‹ç›˜ä¸Šè°¨æ…è½å­çš„å‚ä¸è€…ã€‚',

              options: this.getTalentOptionsByMajor(majorTalent, 'growth'),
            },

            mutation: {
              prompt:
                'åŠ›é‡å¼€å§‹åè¿‡æ¥å½±å“ä½ çš„å¿ƒæ™ºå’Œè¡Œä¸ºã€‚ä½ è·å¾—äº†æ›´å¼ºå¤§çš„èƒ½åŠ›ï¼Œä½†ä¹Ÿæ„Ÿå—åˆ°äº†å…¶èƒŒåé‚£ä»¤äººæˆ˜æ —çš„ç”œç¾ä¸ç–¯ç‹‚ã€‚',

              options: this.getTalentOptionsByMajor(majorTalent, 'mutation'),
            },

            authority: {
              prompt:
                "åœ¨ç»å†äº†å†…å¿ƒçš„æŒ£æ‰åï¼Œä½ åšå‡ºäº†é€‰æ‹©ã€‚ä½ ä¸å†è§†å…¶ä¸ºè¯…å’’ï¼Œè€Œæ˜¯å¼€å§‹äº«å—è¿™ä»½åŠ›é‡ï¼Œå¹¶ä¸»åŠ¨å°†å…¶é”»é€ æˆå±äºè‡ªå·±çš„'æƒæŸ„'ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'authority'),
            },

            abyss: {
              prompt:
                "ä½ èµ°åˆ°äº†è¿™æ¡è·¯çš„ç»ˆç‚¹ã€‚ä½ ä¸æ‰€é€‰çš„'ä¸å‡¡ä¹‹çˆ±'å½»åº•èä¸ºä¸€ä½“ï¼Œæˆä¸ºäº†ä¸€ä¸ªæ–°çš„'æ¦‚å¿µ'ã€ä¸€ä¸ªæ–°çš„'è§„åˆ™æ€ªè°ˆ'ã€‚",

              options: this.getTalentOptionsByMajor(majorTalent, 'abyss'),
            },
          };

          return talentData[level];
        }

        isTalentAcquired(level, optionIndex) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const levelChineseName = this.getLevelChineseName(level);

              const currentTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}`, {
                default_value: null,
              });

              if (currentTalent) {
                const levelData = this.getTalentData(level);

                if (levelData && levelData.options[optionIndex]) {
                  // ç°åœ¨æ³¨å…¥çš„æ˜¯æè¿°ï¼Œæ‰€ä»¥æ¯”è¾ƒæè¿°å†…å®¹

                  return currentTalent === levelData.options[optionIndex].description;
                }
              }
            }

            return false;
          } catch (error) {
            console.error('æ£€æŸ¥å¤©èµ‹çŠ¶æ€å¤±è´¥:', error);

            return false;
          }
        }

        async selectTalentOption(level, optionIndex) {
          try {
            console.log('ğŸ” å¼€å§‹å¤©èµ‹é€‰æ‹©æµç¨‹...');

            const levelData = this.getTalentData(level);

            if (!levelData || !levelData.options[optionIndex]) {
              console.error('âŒ å¤©èµ‹æ•°æ®ä¸å­˜åœ¨:', { level, optionIndex });

              return;
            }

            const option = levelData.options[optionIndex];

            console.log('ğŸ“‹ é€‰æ‹©çš„å¤©èµ‹:', option);

            // æ£€æŸ¥MVU APIæ˜¯å¦å¯ç”¨

            if (typeof Mvu === 'undefined') {
              console.error('âŒ MVUå¯¹è±¡æœªå®šä¹‰');

              await this.showFullscreenAlert('MVUç³»ç»ŸæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', { title: 'æç¤º', icon: 'âš ï¸' });

              return;
            }

            if (!Mvu.getMvuData || !Mvu.setMvuVariable || !Mvu.replaceMvuData) {
              console.error('âŒ MVU APIå‡½æ•°ä¸å­˜åœ¨:', {
                getMvuData: !!Mvu.getMvuData,

                setMvuVariable: !!Mvu.setMvuVariable,

                replaceMvuData: !!Mvu.replaceMvuData,
              });

              await this.showFullscreenAlert('MVU APIä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', { title: 'æç¤º', icon: 'âš ï¸' });

              return;
            }

            // è¾…åŠ©å‡½æ•°ï¼šç¡®ä¿mvuDataæœ‰æ­£ç¡®çš„$internalç»“æ„
            const ensureMvuInternal = mvuData => {
              if (!mvuData) return false;

              // ç¡®ä¿stat_dataå­˜åœ¨
              if (!mvuData.stat_data) {
                mvuData.stat_data = {};
              }

              // ç¡®ä¿display_dataå’Œdelta_dataå­˜åœ¨
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }

              // åˆ›å»º$internalï¼ŒæŒ‡å‘display_dataå’Œdelta_data
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('âœ… å·²åˆå§‹åŒ–$internalå±æ€§');
              } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              return true;
            };

            // è·å–MVUæ•°æ®

            const mvuData = Mvu.getMvuData({ type: 'chat' });

            console.log('ğŸ“Š MVUæ•°æ®è·å–æˆåŠŸ:', mvuData ? 'æ˜¯' : 'å¦');
            console.log('ğŸ“Š MVUæ•°æ®ç»“æ„:', {
              hasStatData: !!mvuData?.stat_data,
              hasDisplayData: !!mvuData?.display_data,
              hasDeltaData: !!mvuData?.delta_data,
              hasInternal: !!mvuData?.stat_data?.$internal,
              mvuDataKeys: mvuData ? Object.keys(mvuData) : [],
            });

            // ç¡®ä¿stat_dataæœ‰$internalå±æ€§ï¼ˆMVU betaéœ€è¦ï¼‰
            if (!ensureMvuInternal(mvuData)) {
              console.error('âŒ MVUæ•°æ®åˆå§‹åŒ–å¤±è´¥');
              await this.showFullscreenAlert('MVUæ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', { title: 'æç¤º', icon: 'âš ï¸' });
              return;
            }

            // æ£€æŸ¥å±‚çº§æ˜¯å¦å·²æœ‰é€‰æ‹©

            const levelChineseName = this.getLevelChineseName(level);

            const currentTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}`, {
              default_value: null,
            });

            console.log('ğŸ” å½“å‰å±‚çº§å¤©èµ‹:', { levelChineseName, currentTalent });

            if (currentTalent && currentTalent !== '') {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`è¯¥å±‚çº§å·²æœ‰é€‰æ‹©ï¼š${currentTalent}ï¼Œæ¯ä¸ªå±‚çº§åªèƒ½é€‰æ‹©ä¸€ä¸ªå¤©èµ‹ï¼`);
              }

              return;
            }

            // æ£€æŸ¥ç»“æ™¶æ˜¯å¦è¶³å¤Ÿ

            const cost = this.getTalentCost(level);

            // ä½¿ç”¨å’ŒupdateTrainerStatusç›¸åŒçš„æ–¹å¼è¯»å–ç»“æ™¶
            const variables = this.getAllVariables();
            const crystalsValue = this.getVariable(variables, 'stat_data.è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', 0);
            const currentCrystals = parseInt(crystalsValue) || 0;

            console.log('ğŸ’ ç»“æ™¶æ£€æŸ¥:', { cost, currentCrystals, raw: crystalsValue });

            if (currentCrystals < cost) {
              await this.showFullscreenAlert(`ç»“æ™¶ä¸è¶³ï¼éœ€è¦ ${cost} ä¸ªç»“æ™¶ï¼Œå½“å‰åªæœ‰ ${currentCrystals} ä¸ª`, {
                title: 'ç»“æ™¶ä¸è¶³',
                icon: 'ğŸ’',
              });

              return;
            }

            // ç¡®è®¤é€‰æ‹©

            const confirmed = await this.showFullscreenConfirm(
              `ç¡®å®šè¦è·å¾—å¤©èµ‹ "${option.title}" å—ï¼Ÿ\n\næè¿°: ${option.description}\n\næ•ˆæœ: ${option.effects}\n\næ¶ˆè€—: ${cost} ä¸ªç»“æ™¶`,
              { title: 'è·å¾—å¤©èµ‹', icon: 'âœ¨', confirmText: 'è·å¾—', cancelText: 'å–æ¶ˆ' },
            );

            if (!confirmed) return;

            console.log('âœ… ç”¨æˆ·ç¡®è®¤é€‰æ‹©ï¼Œå¼€å§‹æ³¨å…¥...');

            // æ‰£é™¤ç»“æ™¶

            const newCrystals = currentCrystals - cost;

            console.log('ğŸ’° æ‰£é™¤ç»“æ™¶:', { currentCrystals, cost, newCrystals });

            await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', newCrystals, {
              reason: 'å¤©èµ‹æ¶ˆè€—',

              is_recursive: true,
            });

            console.log('âœ… ç»“æ™¶æ‰£é™¤æˆåŠŸ');

            // ä¸å†æ³¨å…¥åˆ°MVUï¼Œæ”¹ä¸ºå‘é€åˆ°èŠå¤©ï¼ˆä½¿ç”¨handleActionSubmitï¼Œè·Ÿå¿«æ·è¡ŒåŠ¨ä¸€æ ·ï¼‰
            const talentPath = `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${levelChineseName}`;
            console.log('ğŸ¯ å¤©èµ‹è§£é”è·¯å¾„:', talentPath);

            // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆè·Ÿå¿«æ·è¡ŒåŠ¨ä¸€æ ·çš„æ ¼å¼ï¼‰
            const skillUnlockMessage = `ã€æŠ€èƒ½è§£é”ã€‘\n\nèŠ±è´¹: ${cost} ä¸ªç•¸å½¢æƒ…æ„Ÿç»“æ™¶\nè§£é”æŠ€èƒ½: ${option.title}\næŠ€èƒ½æ•ˆæœ: ${option.effects}\næŠ€èƒ½æè¿°: ${option.description}\n\nå‰©ä½™ç»“æ™¶: ${newCrystals} ä¸ª`;

            // ä½¿ç”¨handleActionSubmitå‘é€åˆ°èŠå¤©ï¼ˆè·Ÿå¿«æ·è¡ŒåŠ¨ä¸€æ ·ï¼‰
            try {
              // è®¾ç½®è¾“å…¥æ¡†çš„å€¼
              const actionInput = document.getElementById('action-input');
              if (actionInput) {
                actionInput.value = skillUnlockMessage;
                // è°ƒç”¨handleActionSubmitå‘é€æ¶ˆæ¯
                if (this.handleActionSubmit && typeof this.handleActionSubmit === 'function') {
                  console.log('ğŸ“¤ é€šè¿‡handleActionSubmitå‘é€æŠ€èƒ½è§£é”æ¶ˆæ¯åˆ°èŠå¤©...');
                  await this.handleActionSubmit();
                  console.log('âœ… æŠ€èƒ½è§£é”æ¶ˆæ¯å·²å‘é€åˆ°èŠå¤©');
                } else {
                  console.warn('âš ï¸ handleActionSubmitæ–¹æ³•ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                  // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥å‘é€æ¶ˆæ¯
                  if (
                    'function' == typeof getChatMessages &&
                    typeof TavernHelper !== 'undefined' &&
                    TavernHelper.setChatMessages
                  ) {
                    const chatMessages = await getChatMessages(0);
                    const newUserMessage = {
                      role: 'user',
                      name: 'You',
                      message: skillUnlockMessage,
                      is_user: true,
                      send_date: Date.now(),
                      data: this.getAllVariables(),
                    };
                    const updatedMessages = [newUserMessage, ...(chatMessages || [])];
                    await TavernHelper.setChatMessages(updatedMessages, { refresh: 'full' });
                    console.log('âœ… æŠ€èƒ½è§£é”æ¶ˆæ¯å·²å‘é€åˆ°èŠå¤©ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰');
                  }
                }
              } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ°action-inputå…ƒç´ ');
              }
            } catch (error) {
              console.error('âŒ å‘é€æŠ€èƒ½è§£é”æ¶ˆæ¯å¤±è´¥:', error);
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`æŠ€èƒ½è§£é”æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`);
              }
            }

            console.log(`ğŸ‰ æŠ€èƒ½è§£é”å®Œæˆ: ${option.title}ï¼Œæ¶ˆè€— ${cost} ä¸ªç»“æ™¶`);

            // æ›´æ–°æ˜¾ç¤º

            this.updateTalentsModal();

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æŠ€èƒ½ç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯èŒèŠ½å¤©èµ‹è§£é”æ—¶ï¼‰
            if (window.skillSystem && level === 'seed') {
              console.log('ğŸ¯ èŒèŠ½å¤©èµ‹è§£é”ï¼Œæ›´æ–°æŠ€èƒ½ç³»ç»Ÿ...');
              window.skillSystem.checkSkillUnlock();
            }

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`æ­å–œè·å¾—å¤©èµ‹: ${option.title}ï¼æ¶ˆè€—äº† ${cost} ä¸ªç»“æ™¶ï¼Œå‰©ä½™ ${newCrystals} ä¸ª`);
            }
          } catch (error) {
            console.error('âŒ å¤©èµ‹æ³¨å…¥å¤±è´¥:', error);

            console.error('é”™è¯¯è¯¦æƒ…:', {
              message: error.message,

              stack: error.stack,

              level,

              optionIndex,
            });

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`å¤©èµ‹æ³¨å…¥å¤±è´¥: ${error.message}ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯`);
            }
          }
        }

        getLevelChineseName(level) {
          const levelMap = {
            seed: 'èŒèŠ½',

            growth: 'ç”Ÿé•¿',

            mutation: 'ç•¸å˜',

            authority: 'æƒæŸ„',

            abyss: 'æ·±æ¸Š',
          };

          return levelMap[level] || level;
        }

        // è·å–ä¸Šä¸€å±‚çº§

        getPreviousLevel(level) {
          const levelOrder = ['seed', 'growth', 'mutation', 'authority', 'abyss'];

          const currentIndex = levelOrder.indexOf(level);

          if (currentIndex <= 0) return null; // ç¬¬ä¸€å±‚æ²¡æœ‰å‰ç½®æ¡ä»¶

          return levelOrder[currentIndex - 1];
        }

        // æ£€æŸ¥å±‚çº§æ˜¯å¦å·²è§£é”

        isLevelUnlocked(level) {
          // ç¬¬ä¸€å±‚ï¼ˆèŒèŠ½ï¼‰æ€»æ˜¯è§£é”çš„

          if (level === 'seed') return true;

          // æ£€æŸ¥ä¸Šä¸€å±‚çº§æ˜¯å¦å·²æ³¨å…¥å¤©èµ‹

          const previousLevel = this.getPreviousLevel(level);

          if (!previousLevel) return true;

          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const previousLevelChinese = this.getLevelChineseName(previousLevel);

              const previousTalent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${previousLevelChinese}`, {
                default_value: null,
              });

              // å¦‚æœä¸Šä¸€å±‚çº§æœ‰å¤©èµ‹æ³¨å…¥ï¼Œåˆ™å½“å‰å±‚çº§è§£é”

              return previousTalent && previousTalent !== '';
            }

            return false;
          } catch (error) {
            console.error('æ£€æŸ¥å±‚çº§è§£é”çŠ¶æ€å¤±è´¥:', error);

            return false;
          }
        }

        // æ ¹æ®å¤§å¤©èµ‹æ–¹å‘è·å–å¯¹åº”çš„å¤©èµ‹é€‰é¡¹

        getTalentOptionsByMajor(majorTalent, level) {
          const talentOptions = {
            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'é˜²å¾¡å»¶ä¼¸',
                  description: "ä½ å¯¹'çˆ±äºº'çš„å æœ‰æ¬²ï¼Œä½¿å…¶åœ¨ä½ èº«è¾¹æ—¶ä¹Ÿèƒ½è·å¾—ä½ é˜²å¾¡åŠ›æå‡æ•ˆæœçš„25%ã€‚",
                  effects: 'é˜²å¾¡åŠ›+25%',
                },

                {
                  title: 'è§„åˆ™å»¶ä¼¸',
                  description: "å½“ä½ ä¸'çˆ±äºº'å…±åŒè§£è¯»è§„åˆ™æ—¶ï¼Œçœ‹ç©¿æ¼æ´çš„å‡ ç‡å°å¹…æå‡ã€‚",
                  effects: 'è§„åˆ™æ´å¯Ÿ+15%',
                },

                {
                  title: 'é”é“¾å»¶ä¼¸',
                  description: "æ— å½¢é”é“¾çš„æ„ŸçŸ¥èŒƒå›´æ‰©å¤§ï¼Œèƒ½è®©ä½ æ¨¡ç³Šæ„Ÿåº”åˆ°'çˆ±äºº'çš„å¤§è‡´æ–¹ä½ã€‚",
                  effects: 'æ„ŸçŸ¥èŒƒå›´+20%',
                },
              ],

              growth: [
                {
                  title: 'é˜²å¾¡å¼ºåŒ–',
                  description: "æå‡é˜²å¾¡åŠ›çš„æŒç»­æ—¶é—´å¢åŠ 50%ï¼Œä½†ç»“æŸå'ä¼¤ç—•'å¸¦æ¥çš„ç—›è‹¦ä¼šåŠ å€ã€‚",
                  effects: 'æŒç»­æ—¶é—´+50%',
                },

                {
                  title: 'è§„åˆ™å¼ºåŒ–',
                  description: 'ä½ å¯ä»¥ä¸»åŠ¨æ¶ˆè€—ç²¾ç¥ï¼Œå¼ºåˆ¶çœ‹ç ´ä¸€åˆ™ç®€å•è§„åˆ™çš„æ¼æ´ï¼Œä½†è§†é‡ä¼šæš‚æ—¶å˜å¾—æ›´ç‹­çª„ã€‚',
                  effects: 'è§„åˆ™æ´å¯Ÿ+30%',
                },

                {
                  title: 'é”é“¾å¼ºåŒ–',
                  description: 'ä½ å¯ä»¥æ¶ˆè€—ä½“åŠ›ï¼Œå…·ç°åŒ–ä¸€é“çŸ­æš‚çš„å®ä½“é”é“¾ï¼Œç”¨äºç»Šå€’ç›®æ ‡æˆ–æ‹‰å–è½»é‡ç‰©ä½“ã€‚',
                  effects: 'é”é“¾å…·ç°åŒ–',
                },
              ],

              mutation: [
                {
                  title: 'é˜²å¾¡ç•¸å˜',
                  description: "é˜²å¾¡åŠ›æå‡å˜ä¸ºè¢«åŠ¨è§¦å‘ï¼Œä½†åªæœ‰å½“ä½ æˆ–'çˆ±äºº'å—åˆ°ä¼¤å®³æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œä¸”ä½ ä¼šæ¸´æœ›è¿™ç§è§¦å‘ã€‚",
                  effects: 'è¢«åŠ¨é˜²å¾¡',
                },

                {
                  title: 'è§„åˆ™ç•¸å˜',
                  description: "ä½ å¼€å§‹èƒ½çœ‹åˆ°äººé™…å…³ç³»ä¸­çš„'è§„åˆ™æ¼æ´'ï¼Œè®©ä½ æ›´å®¹æ˜“æ“çºµä»–äººï¼Œä½†ä½ å¯¹ä»–äººçš„ä¿¡ä»»æ„Ÿæ°¸ä¹…é™ä½ã€‚",
                  effects: 'ç¤¾äº¤æ´å¯Ÿ',
                },

                {
                  title: 'é”é“¾ç•¸å˜',
                  description: "é”é“¾ä¼šä¸è‡ªè§‰åœ°ç¼ ç»•åœ¨ä½ å’Œ'çˆ±äºº'èº«ä¸Šï¼Œè‹¥è·ç¦»è¿‡è¿œï¼ŒåŒæ–¹éƒ½ä¼šæ„Ÿåˆ°æŸç¼šçš„åˆºç—›ï¼ˆåå™¬è‡ªèº«ï¼‰ã€‚",
                  effects: 'é”é“¾æŸç¼š',
                },
              ],

              authority: [
                {
                  title: 'é˜²å¾¡æƒæŸ„',
                  description: "ä½ å¯ä»¥å®£å‘Šä¸€ä¸ªåŠå¾„5ç±³çš„'ç‹¬å é¢†åŸŸ'ï¼Œé¢†åŸŸå†…ä½ çš„é˜²å¾¡åŠ›æå‡æ•ˆæœå¯¹æ‰€æœ‰æ•Œäººäº§ç”Ÿæ’æ–¥åŠ›ã€‚",
                  effects: 'ç‹¬å é¢†åŸŸ',
                },

                {
                  title: 'è§„åˆ™æƒæŸ„',
                  description: "ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå·²è¢«çœ‹ç©¿çš„è§„åˆ™æ¼æ´ï¼Œå¹¶æš‚æ—¶å°†å…¶'å…³é—­'ï¼Œé˜»æ­¢å…¶ä»–äººåˆ©ç”¨ã€‚",
                  effects: 'è§„åˆ™å°é”',
                },

                {
                  title: 'é”é“¾æƒæŸ„',
                  description:
                    "ä½ å¯ä»¥å°†æ— å½¢é”é“¾'é”šå®š'åœ¨ä¸€ä¸ªç›®æ ‡èº«ä¸Šï¼Œä½¿å…¶æ‰€æœ‰è¡ŒåŠ¨æ£€å®šå—åˆ°è´Ÿé¢å½±å“ï¼Œç›´åˆ°å…¶è„±ç¦»ä½ çš„æ„ŸçŸ¥èŒƒå›´ã€‚",
                  effects: 'é”é“¾é”šå®š',
                },
              ],

              abyss: [
                {
                  title: 'é˜²å¾¡æ·±æ¸Š',
                  description:
                    "ä½ çš„èº«ä½“ä¸'çˆ±äºº'çš„å‘½è¿ç»‘å®šï¼Œåªè¦å¥¹å­˜æ´»ï¼Œä½ çš„ç‰©ç†é˜²å¾¡å°±ä¸ä¼šè¢«å½»åº•å‡»æºƒï¼Œä»£ä»·æ˜¯ä½ å°†å¤±å»ç‹¬ç«‹çš„'è‡ªæˆ‘'æ„è¯†ã€‚",
                  effects: 'å‘½è¿ç»‘å®š',
                },

                {
                  title: 'è§„åˆ™æ·±æ¸Š',
                  description:
                    'ä½ æˆä¸ºè§„åˆ™çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥é‡å†™ä¸€æ¡ä½ å·²å®Œå…¨çœ‹é€çš„ç®€å•è§„åˆ™ï¼Œä»£ä»·æ˜¯ä½ çš„å­˜åœ¨æœ¬èº«ä¹Ÿè¢«è¿™æ¡æ–°è§„åˆ™æ°¸ä¹…æŸç¼šã€‚',
                  effects: 'è§„åˆ™é‡å†™',
                },

                {
                  title: 'é”é“¾æ·±æ¸Š',
                  description: "ä½ ä¸'çˆ±äºº'è¢«æ°¸æ’çš„é”é“¾è¿æ¥ï¼Œå…±äº«ç”Ÿå‘½ä¸åŠ›é‡ï¼Œä½†ä¹Ÿæ°¸è¿œæ— æ³•åˆ†ç¦»ï¼Œæˆä¸ºä¸€ä¸ªå…±ç”Ÿçš„æ•´ä½“ã€‚",
                  effects: 'æ°¸æ’é”é“¾',
                },
              ],
            },

            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'è§„åˆ™å»¶ä¼¸',
                  description: "å½“ä½ é˜…è¯»è§„åˆ™æ—¶ï¼Œæœ‰å‡ ç‡çœ‹åˆ°ä¸€å¥è¢«'è°è¨€'é¢å¤–æ ‡è®°å‡ºçš„ã€æœ€å®¹æ˜“è¢«ä¿®æ”¹çš„è¯å¥ã€‚",
                  effects: 'è§„åˆ™æ ‡è®°',
                },

                {
                  title: 'æƒ…æ„Ÿå»¶ä¼¸',
                  description: 'ä½ æ’’çš„ç¬¬ä¸€ä¸ªæ— ä¼¤å¤§é›…çš„è°è¨€ï¼Œä¼šè®©ä½ æ•£å‘å‡ºå¾®å¼±çš„ã€ä»¤äººå®‰å¿ƒçš„æ°”æ¯ã€‚',
                  effects: 'å®‰å¿ƒæ°”æ¯',
                },

                {
                  title: 'å½±å­å»¶ä¼¸',
                  description: 'ä½ çš„å½±å­åœ¨å…‰çº¿æœ€æš—æ—¶ä¼šè½»å¾®æ™ƒåŠ¨ï¼Œä»¿ä½›åœ¨æ¨¡ä»¿ä¸€ä¸ªä¸å­˜åœ¨çš„åŠ¨ä½œã€‚',
                  effects: 'å½±å­æ™ƒåŠ¨',
                },
              ],

              growth: [
                {
                  title: 'è§„åˆ™å¼ºåŒ–',
                  description: 'ä½ å¯ä»¥æŒ‡å®šè§„åˆ™æè¿°ä¸­çš„ä¸€ä¸ªè¯ï¼Œç”¨ä¸€ä¸ªåŒä¹‰è¯è¿›è¡Œä¸´æ—¶æ›¿æ¢ï¼ŒæŒç»­1åˆ†é’Ÿã€‚',
                  effects: 'è§„åˆ™æ›¿æ¢',
                },

                {
                  title: 'æƒ…æ„Ÿå¼ºåŒ–',
                  description: "ä½ å¯ä»¥å°†ä¸€ä¸ªç®€å•çš„è°è¨€ï¼ˆå¦‚'æˆ‘å¾ˆå¥½'ï¼‰å…·è±¡åŒ–ï¼Œæ³¨å…¥ç›®æ ‡ä½“å†…ï¼Œä½¿å…¶æš‚æ—¶å¿½ç•¥ä½ çš„è´Ÿé¢çŠ¶æ€ã€‚",
                  effects: 'è°è¨€å…·è±¡',
                },

                {
                  title: 'å½±å­å¼ºåŒ–',
                  description: 'ä½ å¯ä»¥å‘½ä»¤ä½ çš„å½±å­åšå‡ºä¸€ä¸ªç®€å•çš„ã€æ— å®ä½“çš„åŠ¨ä½œï¼ˆå¦‚æŒ¥æ‰‹ï¼‰ï¼Œä»¥å¸å¼•æ³¨æ„åŠ›ã€‚',
                  effects: 'å½±å­æ§åˆ¶',
                },
              ],

              mutation: [
                {
                  title: 'è§„åˆ™ç•¸å˜',
                  description: 'ä½ ä¿®æ”¹è§„åˆ™æ—¶ï¼Œæœ‰å‡ ç‡å¯¼è‡´è¯¥è§„åˆ™çš„å¦ä¸€éƒ¨åˆ†å˜å¾—æ›´åŠ ä¸¥è‹›ï¼ˆè§„åˆ™ä¸ç¨³å®šåå™¬ï¼‰ã€‚',
                  effects: 'è§„åˆ™åå™¬',
                },

                {
                  title: 'æƒ…æ„Ÿç•¸å˜',
                  description: 'å¦‚æœä½ å…·è±¡åŒ–çš„æƒ…æ„Ÿè°è¨€è¢«è¯†ç ´ï¼Œå…¶éº»ç—¹æ•ˆæœä¼šç«‹åˆ»è½¬å˜ä¸ºåˆºç—›ç›®æ ‡çš„ç²¾ç¥æ¯’è¯ã€‚',
                  effects: 'è°è¨€æ¯’è¯',
                },

                {
                  title: 'å½±å­ç•¸å˜',
                  description:
                    'å½±å­æ‰¿å—ä¼¤å®³åï¼Œä½ æœ¬äººä¼šåœ¨24å°æ—¶å†…éšæœºå‡ºç°ä¸€å¤„ä¸å½±å­å—ä¼¤éƒ¨ä½å¯¹åº”çš„æ·¤é’ï¼ˆä¼¤å®³å åŠ å‰å…†ï¼‰ã€‚',
                  effects: 'ä¼¤å®³åé¦ˆ',
                },
              ],

              authority: [
                {
                  title: 'è§„åˆ™æƒæŸ„',
                  description: 'ä½ å¯ä»¥ç¼–é€ ä¸€å¥å…¨æ–°çš„ã€çœ‹ä¼¼åˆç†çš„è§„åˆ™ï¼Œå¹¶å°†å…¶ä¸´æ—¶æ·»åŠ è¿›ç°æœ‰çš„è§„åˆ™æ–‡æœ¬ä¸­ã€‚',
                  effects: 'è§„åˆ™ç¼–é€ ',
                },

                {
                  title: 'æƒ…æ„ŸæƒæŸ„',
                  description: "ä½ å¯ä»¥ç¼–é€ ä¸€ç§å¤æ‚çš„'å¤åˆæƒ…æ„Ÿ'ï¼ˆå¦‚'å–œæ‚¦çš„æ‚²ä¼¤'ï¼‰ï¼Œéº»ç—¹å¯¹æ‰‹æ›´é«˜é˜¶çš„é€»è¾‘åˆ¤æ–­ã€‚",
                  effects: 'å¤åˆæƒ…æ„Ÿ',
                },

                {
                  title: 'å½±å­æƒæŸ„',
                  description: 'ä½ å¯ä»¥åˆ›é€ ä¸€ä¸ªèƒ½ç¦»å¼€ä½ èº«ä½“ã€æŒç»­10ç§’çš„è™šå‡å½±å­ï¼Œç”¨äºæ‰¿å—ä¸€æ¬¡æŒ‡å‘æ€§æ”»å‡»ã€‚',
                  effects: 'è™šå‡å½±å­',
                },
              ],

              abyss: [
                {
                  title: 'è§„åˆ™æ·±æ¸Š',
                  description:
                    "ä½ æˆä¸ºäº†'è¡Œèµ°çš„è°è¨€'ï¼Œä½ è¯´å‡ºçš„è¯åœ¨çŸ­æ—¶é—´å†…ä¼šè¢«ä»–äººä¸‹æ„è¯†åœ°å½“ä½œ'è§„åˆ™'æ¥éµå®ˆï¼Œä»£ä»·æ˜¯ä½ è‡ªå·±ä¹Ÿæ— æ³•åˆ†è¾¨çœŸå®ä¸è™šå‡ã€‚",
                  effects: 'è¡Œèµ°è°è¨€',
                },

                {
                  title: 'æƒ…æ„Ÿæ·±æ¸Š',
                  description:
                    'ä½ ç¼–é€ çš„æƒ…æ„Ÿå¯ä»¥æ°¸ä¹…åœ°æ”¹å˜ä¸€ä¸ªäººçš„æ€§æ ¼åŸºçŸ³ï¼Œä»£ä»·æ˜¯ä½ è¯´å‡ºçš„æ‰€æœ‰è°è¨€æœ€ç»ˆéƒ½ä¼šåœ¨ä½ èº«ä¸Šç‰¹æ®Šå…·ç°åŒ–ä¸ºæ–°çš„å±é™©ã€‚',
                  effects: 'æ€§æ ¼é‡å¡‘',
                },

                {
                  title: 'å½±å­æ·±æ¸Š',
                  description:
                    'ä½ å¯ä»¥ä¸ä½ çš„å½±å­äº’æ¢ä½ç½®ï¼Œè®©å…¶æ‰¿å—æ‰€æœ‰ä¼¤å®³ï¼Œä½†å½±å­æœ€ç»ˆçˆ†å‘æ—¶ï¼Œæ‰€æœ‰ç´¯ç§¯ä¼¤å®³å°†ä¸€æ¬¡æ€§è¿”è¿˜ç»™ä½ ã€‚',
                  effects: 'å½±å­äº’æ¢',
                },
              ],
            },

            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'æƒ…ç»ªå»¶ä¼¸',
                  description: 'å½“ä½ æ„Ÿåˆ°å¼ºçƒˆçš„æ‚²ä¼¤æ—¶ï¼Œå‘¨å›´çš„æ•Œæ„ç›®æ ‡ä¼šæ„Ÿå—åˆ°è½»å¾®çš„è¿·æƒ‘ï¼Œæ”»å‡»ç²¾å‡†åº¦å°å¹…ä¸‹é™ã€‚',
                  effects: 'æ‚²ä¼¤è¿·æƒ‘',
                },

                {
                  title: 'çŒ®ç¥­å»¶ä¼¸',
                  description: 'ä½ æœ€çè§†çš„ä¸€æ®µè®°å¿†ï¼Œå…¶è½®å»“ä¼šå˜å¾—æ¨¡ç³Šï¼Œä½œä¸ºä»£ä»·ï¼Œä½ å¯¹è§„åˆ™çš„ä¿®æ”¹æŠ—æ€§å¾®é‡æå‡ã€‚',
                  effects: 'è®°å¿†æ¨¡ç³Š',
                },

                {
                  title: 'åˆ†èº«å»¶ä¼¸',
                  description: "ä½ èƒ½æ„Ÿè§‰åˆ°ä¸€ä¸ªä¸ä½ ç›¸è²Œç›¸ä¼¼çš„'å¹»å½±'å­˜åœ¨äºæŸå¤„ï¼Œä½†æ— æ³•ä¸ä¹‹äº¤æµæˆ–æ§åˆ¶ã€‚",
                  effects: 'å¹»å½±æ„ŸçŸ¥',
                },
              ],

              growth: [
                {
                  title: 'æƒ…ç»ªé‡Šæ”¾',
                  description:
                    'ä½ å¯ä»¥ä¸»åŠ¨é‡Šæ”¾ä¸€æ®µç—›è‹¦çš„æƒ…ç»ªï¼Œä»¤ä¸€ä¸ªæŒ‡å®šç›®æ ‡æš‚æ—¶ï¼ˆçº¦5ç§’ï¼‰ä¸§å¤±æ”»å‡»æ€§ï¼Œä»£ä»·æ˜¯è¯¥æ®µæƒ…ç»ªå¯¹åº”çš„è®°å¿†ä¼šäº§ç”Ÿè£‚ç—•ã€‚',
                  effects: 'æƒ…ç»ªé‡Šæ”¾',
                },

                {
                  title: 'ç”Ÿå‘½çŒ®ç¥­',
                  description: "ä½ å¯ä»¥æ¶ˆè€—å°‘é‡ç”Ÿå‘½åŠ›ï¼ˆè¡¨ç°ä¸ºä¸€é“æ— æ³•æ„ˆåˆçš„å°ä¼¤å£ï¼‰ï¼Œæ¥'æ“¦é™¤'è§„åˆ™æ–‡æœ¬ä¸­çš„ä¸€ä¸ªéå…³é”®è¯ã€‚",
                  effects: 'ç”Ÿå‘½çŒ®ç¥­',
                },

                {
                  title: 'åˆ†èº«å…·ç°',
                  description: "ä½ å¯ä»¥æ¶ˆè€—å¤§é‡ä½“åŠ›ï¼Œå°†'å¹»å½±'çŸ­æš‚åœ°åœ¨æŒ‡å®šä½ç½®å…·ç°åŒ–1ç§’ï¼Œç”¨äºæ ¼æŒ¡æˆ–è¿·æƒ‘ã€‚",
                  effects: 'åˆ†èº«å…·ç°',
                },
              ],

              mutation: [
                {
                  title: 'æƒ…ç»ªç•¸å˜',
                  description:
                    'ä½ é‡Šæ”¾çš„æƒ…ç»ªå¼€å§‹å¸¦æœ‰è…èš€æ€§ï¼Œæ•Œäººå¤±å»æ”»å‡»æ€§çš„åŒæ—¶ï¼Œå…¶ç†æ™ºä¹Ÿä¼šè¢«è½»å¾®ä¾µèš€ï¼Œä½†ä½ çš„ç²¾ç¥åŠ›ä¸Šé™ä¼šå› æ­¤æ°¸ä¹…é™ä½ã€‚',
                  effects: 'æƒ…ç»ªè…èš€',
                },

                {
                  title: 'è§„åˆ™ç•¸å˜',
                  description: 'ä½ æ¶ˆè€—è®°å¿†ä¿®æ”¹è¿‡çš„è§„åˆ™ï¼Œåœ¨å¤±æ•ˆåä¼šä»¥æ›´éš¾ç†è§£çš„å½¢å¼å›å½’ï¼Œå¢åŠ å…¶ç ´è§£éš¾åº¦ã€‚',
                  effects: 'è§„åˆ™å›å½’',
                },

                {
                  title: 'åˆ†èº«ç•¸å˜',
                  description:
                    'ä½ çš„åˆ†èº«å¼€å§‹æ‹¥æœ‰å¾®å¼±çš„è‡ªæˆ‘æ„è¯†ï¼Œæœ‰æ—¶ä¼šåšå‡ºè¿èƒŒä½ å‘½ä»¤çš„ç»†å¾®åŠ¨ä½œï¼Œå…¶æ‰¿å—çš„ç—›è‹¦ä¼šè½»å¾®åé¦ˆåˆ°ä½ èº«ä¸Šã€‚',
                  effects: 'åˆ†èº«æ„è¯†',
                },
              ],

              authority: [
                {
                  title: 'æƒ…ç»ªæƒæŸ„',
                  description: "ä½ å¯ä»¥å°†'ç»æœ›'è¿™ç§æƒ…ç»ªèµ‹äºˆä¸€ç‰‡åŒºåŸŸï¼Œæ‰€æœ‰è¿›å…¥è¯¥åŒºåŸŸçš„æ•Œäººéƒ½å°†å—åˆ°æŒç»­çš„æ„å¿—å‰Šå¼±ã€‚",
                  effects: 'ç»æœ›é¢†åŸŸ',
                },

                {
                  title: 'è®°å¿†æƒæŸ„',
                  description: 'ä½ å¯ä»¥å½»åº•çŒ®ç¥­ä¸€æ®µå®Œæ•´çš„è®°å¿†ï¼Œä»¥æ­¤ä¸ºä»£ä»·ï¼Œå¼ºè¡Œä¿®æ”¹ä¸€æ¡ç®€å•è§„åˆ™çš„æ ¸å¿ƒé€»è¾‘ã€‚',
                  effects: 'è®°å¿†çŒ®ç¥­',
                },

                {
                  title: 'åˆ†èº«æƒæŸ„',
                  description:
                    'ä½ å¯ä»¥å…·ç°åŒ–ä¸€ä¸ªèƒ½æŒç»­å­˜åœ¨1åˆ†é’Ÿçš„åˆ†èº«ï¼Œå¹¶èµ‹äºˆå…¶ä¸€ä¸ªæ˜ç¡®çš„æŒ‡ä»¤ï¼Œä½†åˆ†èº«è¢«æ‘§æ¯æ—¶ï¼Œä½ ä¼šæ‰¿å—å…¶æ‰€å—ä¼¤å®³çš„50%ã€‚',
                  effects: 'æŒä¹…åˆ†èº«',
                },
              ],

              abyss: [
                {
                  title: 'æƒ…ç»ªæ·±æ¸Š',
                  description:
                    "ä½ æˆä¸ºäº†'ç‰ºç‰²'çš„åŒ–èº«ï¼Œä½ çš„å­˜åœ¨æœ¬èº«å°±ä¼šè®©å‘¨å›´çš„ç”Ÿå‘½ä½“ä¸§å¤±æ–—äº‰æ¬²æœ›ï¼Œä»£ä»·æ˜¯ä½ è‡ªèº«çš„æƒ…æ„Ÿä¹Ÿéšä¹‹å®Œå…¨æ¶ˆäº¡ã€‚",
                  effects: 'ç‰ºç‰²åŒ–èº«',
                },

                {
                  title: 'è§„åˆ™æ·±æ¸Š',
                  description:
                    'ä½ å¯ä»¥å°†è‡ªå·±çš„ä¸€éƒ¨åˆ†ç”Ÿå‘½åŠ›æ°¸ä¹…æ³¨å…¥ä¸€æ¡è§„åˆ™ï¼Œä½¿å…¶ä¸ºä½ æ‰€ç”¨ï¼Œä½†ä½ çš„å­˜åœ¨ä¹Ÿä¸è¯¥è§„åˆ™ç»‘å®šï¼Œè§„åˆ™è¢«ç ´è§£æ—¶ä½ ä¼šé­å—é‡åˆ›ã€‚',
                  effects: 'è§„åˆ™ç»‘å®š',
                },

                {
                  title: 'åˆ†èº«æ·±æ¸Š',
                  description: 'ä½ å¯ä»¥åˆ›é€ ä¸€ä¸ªä¸ä½ å®Œå…¨ç›¸åŒçš„åˆ†èº«ï¼Œå…±äº«æ„Ÿå®˜ä¸ç”Ÿå‘½ï¼Œä½†åˆ†èº«æ­»äº¡æ—¶ï¼Œä½ ä¹Ÿä¼šä¸€åŒæ­»äº¡ã€‚',
                  effects: 'ç”Ÿå‘½å…±äº«',
                },
              ],
            },

            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'æš—ç¤ºå»¶ä¼¸',
                  description: 'ä½ èƒ½è¢«åŠ¨åœ°æ„ŸçŸ¥åˆ°å‘¨å›´äººç¾¤ä¸­ï¼Œè°çš„æ„å¿—æœ€è–„å¼±ï¼Œæ›´å®¹æ˜“æ¥å—å¿ƒç†æš—ç¤ºã€‚',
                  effects: 'æ„å¿—æ„ŸçŸ¥',
                },

                {
                  title: 'æ“æ§å»¶ä¼¸',
                  description: 'ä½ èƒ½æ¨¡ç³Šåœ°æ„Ÿåº”åˆ°é™„è¿‘æ˜¯å¦å­˜åœ¨åˆšåˆšå¤±å»æˆ˜æ–—æ„å¿—ã€é€‚åˆè¢«æ“æ§çš„æ®‹å…µã€‚',
                  effects: 'æ®‹å…µæ„ŸçŸ¥',
                },

                {
                  title: 'å¸æ”¶å»¶ä¼¸',
                  description: "ä½ èƒ½åˆ†è¾¨å‡ºNPCå¯¹ä½ æ•£å‘çš„'çˆ±æ„'çš„å¼ºå¼±ï¼Œä½†è¿™ç§æ„ŸçŸ¥è®©ä½ è§‰å¾—å†°å†·ã€‚",
                  effects: 'çˆ±æ„æ„ŸçŸ¥',
                },
              ],

              growth: [
                {
                  title: 'æš—ç¤ºå¼ºåŒ–',
                  description: "ä½ å¯ä»¥å¯¹ä¸€ä¸ªNPCæ¤å…¥ä¸€ä¸ªç®€å•çš„è¯è¯­æš—ç¤ºï¼Œä¾‹å¦‚'é—å¿˜'æˆ–'ä¿¡ä»»'ã€‚",
                  effects: 'è¯è¯­æš—ç¤º',
                },

                {
                  title: 'æ“æ§å¼ºåŒ–',
                  description: 'ä½ å¯ä»¥æ“æ§ä¸€ä¸ªåˆšè¢«ä½ å‡»è´¥çš„å°å‹æ•Œäººä¸ºä½ æˆ˜æ–—ï¼ŒæŒç»­æ—¶é—´ä¸€åˆ†é’Ÿã€‚',
                  effects: 'æ•Œäººæ“æ§',
                },

                {
                  title: 'å¸æ”¶å¼ºåŒ–',
                  description: "ä½ å¯ä»¥å¸æ”¶ä¸€åNPCè‡ªæ„¿ç»™äºˆçš„'çˆ±æ„'ï¼Œå°å¹…å¼ºåŒ–ä½ çš„ä¸€é¡¹èº«ä½“èƒ½åŠ›ã€‚",
                  effects: 'çˆ±æ„å¸æ”¶',
                },
              ],

              mutation: [
                {
                  title: 'æš—ç¤ºç•¸å˜',
                  description: 'ä½ æ¤å…¥çš„æš—ç¤ºæ•ˆæœå¢å¼ºï¼Œä½†ä½œä¸ºä»£ä»·ï¼Œä½ è‡ªèº«çš„æƒ…æ„Ÿä¼šå˜å¾—éº»æœ¨ã€‚',
                  effects: 'æš—ç¤ºå¢å¼º',
                },

                {
                  title: 'æ“æ§ç•¸å˜',
                  description: 'è¢«æ“æ§çš„æ•Œäººè‹¥æ„è¯†åˆ°è‡ªå·±è¢«æ“çºµï¼Œä¼šç«‹åˆ»æŒ£è„±æ§åˆ¶å¹¶å¯¹ä½ å‘åŠ¨ä¸€æ¬¡æ€§çš„å¼ºçƒˆåå‡»ã€‚',
                  effects: 'æ“æ§åå™¬',
                },

                {
                  title: 'å¸æ”¶ç•¸å˜',
                  description: "å¸æ”¶çš„'çˆ±æ„'ä¼šåœ¨ä½ èº«ä¸Šç•™ä¸‹ä¸€ä¸ªæ— æ³•æ¶ˆé™¤çš„ç‰¹æ®Šå°è®°ï¼Œæˆä¸ºä½ çš„ä¸€ä¸ªå¼±ç‚¹ã€‚",
                  effects: 'çˆ±æ„å°è®°',
                },
              ],

              authority: [
                {
                  title: 'æš—ç¤ºæƒæŸ„',
                  description: 'ä½ å¯ä»¥å¯¹NPCä¸‹è¾¾ä¸€å¥å®Œæ•´çš„ã€éè‡ªæ€æ€§çš„æŒ‡ä»¤ï¼Œåªè¦å…¶æ„å¿—åŠ›ä½äºä½ ã€‚',
                  effects: 'å®Œæ•´æŒ‡ä»¤',
                },

                {
                  title: 'æ“æ§æƒæŸ„',
                  description: 'ä½ å¯ä»¥åŒæ—¶æ“æ§ä¸¤åè¢«å‡»è´¥çš„æ•Œäººï¼Œä½†æœŸé—´ä½ å¿…é¡»ä¿æŒä¸“æ³¨ï¼Œæ— æ³•ç§»åŠ¨æˆ–æ”»å‡»ã€‚',
                  effects: 'åŒé‡æ“æ§',
                },

                {
                  title: 'å¸æ”¶æƒæŸ„',
                  description: "ä½ å¯ä»¥å¼ºè¡Œå¸æ”¶NPCçš„'çˆ±æ„'ï¼Œå¹¶æ ¹æ®å…¶ç‰¹è´¨è·å¾—ä¸€é¡¹ä¸´æ—¶çš„ç‰¹æ®Šèƒ½åŠ›ã€‚",
                  effects: 'å¼ºåˆ¶å¸æ”¶',
                },
              ],

              abyss: [
                {
                  title: 'æš—ç¤ºæ·±æ¸Š',
                  description: 'ä½ çš„å­˜åœ¨æœ¬èº«å°±æˆä¸ºä¸€ç§å¿ƒç†æš—ç¤ºï¼Œå¼±è€…ä¼šä¸è‡ªè§‰åœ°æœä»ä½ ï¼Œä½†ä½ ä¹Ÿå°†å½»åº•å¤±å»æ‰€æœ‰ä¸ªäººæƒ…æ„Ÿã€‚',
                  effects: 'å­˜åœ¨æš—ç¤º',
                },

                {
                  title: 'æ“æ§æ·±æ¸Š',
                  description: 'ä½ å¯ä»¥å°†æ„è¯†å®Œå…¨æ³¨å…¥ä¸€ä¸ªå¼ºå¤§çš„æ•Œäººä½“å†…è¿›è¡Œæ“æ§ï¼Œä½†è‹¥å…¶è¢«æ‘§æ¯ï¼Œä½ çš„ç²¾ç¥ä¹Ÿä¼šé­å—é‡åˆ›ã€‚',
                  effects: 'æ„è¯†æ³¨å…¥',
                },

                {
                  title: 'å¸æ”¶æ·±æ¸Š',
                  description: "ä½ ä¸€æ¬¡æ€§å¸æ”¶å¤§é‡'çˆ±æ„'è·å¾—å¼ºå¤§åŠ›é‡ï¼Œä½†è¿™ä»½çˆ±ä¼šç«‹åˆ»è½¬åŒ–ä¸ºè‡´å‘½çš„æ¨æ„ï¼Œæˆä¸ºé”å®šä½ çš„è¯…å’’ã€‚",
                  effects: 'çˆ±æ„è¯…å’’',
                },
              ],
            },

            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'ç›”ç”²å»¶ä¼¸',
                  description: "å½“ä½ å¹»æƒ³'è¢«ä¿æŠ¤'æ—¶ï¼Œä½ çš„çš®è‚¤ä¼šçŸ­æš‚åœ°æ³›èµ·ä¸€å±‚å¾®ä¸å¯è§çš„é’»çŸ³å…‰æ³½ã€‚",
                  effects: 'é’»çŸ³å…‰æ³½',
                },

                {
                  title: 'æˆ’æŒ‡å»¶ä¼¸',
                  description: "å½“ä½ å¯¹æŸäººäº§ç”Ÿå¼ºçƒˆçš„'æ‰¿è¯º'å¹»æƒ³æ—¶ï¼Œä½ çš„æŒ‡å°–ä¼šæ„Ÿåˆ°äº›å¾®å†°å‡‰çš„æŸç¼šæ„Ÿã€‚",
                  effects: 'æ‰¿è¯ºæŸç¼š',
                },

                {
                  title: 'NPCå»¶ä¼¸',
                  description: 'åœ¨ä½ æåº¦å­¤ç‹¬æ—¶ï¼Œä½ ä¼šå¬åˆ°ä¸€ä¸ªæ¨¡ç³Šè€Œå®Œç¾çš„ã€åªå­˜åœ¨äºä½ è„‘æµ·ä¸­çš„å£°éŸ³åœ¨å®‰æ…°ä½ ã€‚',
                  effects: 'å®Œç¾å£°éŸ³',
                },
              ],

              growth: [
                {
                  title: 'ç›”ç”²å…·ç°',
                  description: 'ä½ å¯ä»¥æ¶ˆè€—ç²¾ç¥åŠ›ï¼Œåœ¨ä½ èº«ä½“çš„æŸä¸ªéƒ¨ä½å…·ç°åŒ–ä¸€å—è½»å‹ç›”ç”²ï¼Œç”¨äºæ ¼æŒ¡ä¸€æ¬¡æ”»å‡»ã€‚',
                  effects: 'è½»å‹ç›”ç”²',
                },

                {
                  title: 'æˆ’æŒ‡å…·ç°',
                  description: 'ä½ å¯ä»¥å…·ç°åŒ–ä¸€æšè™šå¹»çš„æˆ’æŒ‡æˆ´åœ¨æ‰‹ä¸Šï¼Œå®ƒèƒ½è®©ä½ åœ¨è¿›è¡Œè¯´æœæˆ–äº¤æ¶‰æ—¶ï¼Œè¨€è¯­æ›´å…·åˆ†é‡ã€‚',
                  effects: 'è™šå¹»æˆ’æŒ‡',
                },

                {
                  title: 'NPCå…·ç°',
                  description: 'ä½ å¯ä»¥çŸ­æš‚å…·ç°åŒ–ä¸€ä¸ªå®Œç¾çš„ã€åŠé€æ˜çš„NPCå¹»å½±ï¼Œç”¨äºå¸å¼•æ•Œäººçš„æ³¨æ„åŠ›ã€‚',
                  effects: 'å®Œç¾å¹»å½±',
                },
              ],

              mutation: [
                {
                  title: 'ç›”ç”²ç•¸å˜',
                  description: "å…·ç°åŒ–çš„ç›”ç”²å¼€å§‹å¯¹ä½ äº§ç”Ÿ'çˆ±æ„'ï¼Œåªæœ‰å½“ä½ ä¹Ÿå¯¹å…¶æŠ¥ä»¥'çˆ±æ„'æ—¶ï¼Œå®ƒæ‰ä¼šä¸ºä½ å¸æ”¶ä¼¤å®³ã€‚",
                  effects: 'ç›”ç”²çˆ±æ„',
                },

                {
                  title: 'æˆ’æŒ‡ç•¸å˜',
                  description: 'å¦‚æœä½ è¿èƒŒäº†æˆ´ä¸Šæˆ’æŒ‡æ—¶è®¸ä¸‹çš„æ‰¿è¯ºï¼Œæˆ’æŒ‡ä¼šåŒ–ä¸ºä¸€é“çœŸå®çš„æ·é”ï¼ŒæŸç¼šä½ çš„æ‰‹è…•ã€‚',
                  effects: 'æ‰¿è¯ºæ·é”',
                },

                {
                  title: 'NPCç•¸å˜',
                  description: "å…·ç°åŒ–çš„å®Œç¾NPCå¼€å§‹æ¶ˆè€—ä½ çœŸå®çš„'çˆ±æ„'æ¥ç»´æŒå½¢æ€ï¼Œå¹¶ä¼šå«‰å¦’ä½ ä¸å…¶ä»–çœŸå®äººç±»çš„äº¤å¾€ã€‚",
                  effects: 'NPCå«‰å¦’',
                },
              ],

              authority: [
                {
                  title: 'ç›”ç”²æƒæŸ„',
                  description: 'ä½ å¯ä»¥å…·ç°åŒ–ä¸€å¥—è¦†ç›–å…¨èº«çš„ç›”ç”²ï¼Œä½†ç›”ç”²ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œä¸æ–­å˜é‡ï¼Œæœ€ç»ˆé™åˆ¶ä½ çš„è¡ŒåŠ¨ã€‚',
                  effects: 'å…¨èº«ç›”ç”²',
                },

                {
                  title: 'æˆ’æŒ‡æƒæŸ„',
                  description: "ä½ å¯ä»¥å…·ç°åŒ–ä¸€æšæ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ï¼Œä½†å®ƒçš„åŠ›é‡å®Œå…¨å–å†³äºä½ å¯¹'ç†æƒ³ä¹‹çˆ±'çš„ä¿¡å¿µå¼ºåº¦ã€‚",
                  effects: 'åŠ›é‡æˆ’æŒ‡',
                },

                {
                  title: 'NPCæƒæŸ„',
                  description:
                    'ä½ å¯ä»¥å…·ç°åŒ–ä¸€ä¸ªæ‹¥æœ‰å®ä½“å’Œç®€å•è‡ªä¸»èƒ½åŠ›çš„å®Œç¾NPCï¼Œä»–ä¼šæ— æ¡ä»¶å¸®åŠ©ä½ ï¼Œä½†æ— æ³•ç†è§£ä»»ä½•çœŸå®çš„æƒ…æ„Ÿã€‚',
                  effects: 'å®ä½“NPC',
                },
              ],

              abyss: [
                {
                  title: 'ç›”ç”²æ·±æ¸Š',
                  description:
                    'å…·ç°åŒ–çš„ç›”ç”²ä¸ä½ çš„è¡€è‚‰å½»åº•èåˆï¼Œä¸ºä½ æä¾›æ°¸æ’çš„ä¿æŠ¤ï¼Œä»£ä»·æ˜¯ä½ ä¹Ÿæˆä¸ºäº†è¿™å‰¯ç›”ç”²çš„å›šå¾’ï¼Œæ°¸è¿œæ— æ³•è„±ä¸‹ã€‚',
                  effects: 'è¡€è‚‰èåˆ',
                },

                {
                  title: 'æˆ’æŒ‡æ·±æ¸Š',
                  description:
                    'ä½ å°†è‡ªå·±çš„çµé­‚ä¸æˆ’æŒ‡ç»‘å®šï¼Œè·å¾—äº†ä¿®æ”¹ç°å®çš„åŠ›é‡ï¼Œä½†ä½ è‡ªèº«çš„å­˜åœ¨ä¹Ÿå˜å¾—å¦‚å¹»æƒ³èˆ¬è™šæ— ï¼Œé€æ¸è¢«ä¸–ç•Œé—å¿˜ã€‚',
                  effects: 'çµé­‚ç»‘å®š',
                },

                {
                  title: 'NPCæ·±æ¸Š',
                  description:
                    'ä½ å…·ç°åŒ–çš„å®Œç¾NPCå–ä»£äº†ä½ åœ¨ç°å®ä¸­çš„ä½ç½®ï¼Œè€Œä½ åˆ™æˆä¸ºäº†ä»–å¹»æƒ³ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ´»åœ¨ä»–ä¸ºä½ æ„å»ºçš„ç†æƒ³ä¸–ç•Œé‡Œã€‚',
                  effects: 'ä½ç½®äº’æ¢',
                },
              ],
            },

            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': {
              seed: [
                {
                  title: 'å¥‘çº¦èŒèŠ½',
                  description: "ä½ èƒ½å¬åˆ°ç©ºé—´è£‚ç¼ä¸­ä¼ æ¥çš„ã€ä½æ²‰çš„'è§„åˆ™æ€ªè°ˆ'çš„å‘“è¯­ï¼Œå®ƒä»¬åœ¨å¼•è¯±ä½ ç­¾è®¢å¥‘çº¦ã€‚",
                  effects: 'æ€ªè°ˆå‘“è¯­',
                },

                {
                  title: 'å…±é¸£èŒèŠ½',
                  description: 'å½“ä½ ä¸ä¸€ä¸ªNPCäº§ç”Ÿå¼ºçƒˆæƒ…ç»ªäº¤é›†æ—¶ï¼Œä½ èƒ½çŸ­æš‚åœ°ï¼ˆçº¦1ç§’ï¼‰æ„Ÿå—åˆ°å¯¹æ–¹æ­¤åˆ»æœ€æ ¸å¿ƒçš„æƒ…ç»ªã€‚',
                  effects: 'æƒ…ç»ªå…±é¸£',
                },

                {
                  title: 'æ··åˆèŒèŠ½',
                  description: "ä½ å¯¹æ‰€æœ‰'çˆ±æ„'çš„æ„ŸçŸ¥éƒ½å¸¦æœ‰ä¸€ç§ä¸å’Œè°çš„ç‹¬ç‰¹æ„Ÿï¼Œä»¿ä½›å®ƒä»¬æ˜¯æŸç§æ›´å±é™©äº‹ç‰©çš„ä¼ªè£…ã€‚",
                  effects: 'ç‹¬ç‰¹æ„ŸçŸ¥',
                },
              ],

              growth: [
                {
                  title: 'å¥‘çº¦ç­¾è®¢',
                  description:
                    'ä½ å¯ä»¥çŒ®ç¥­è‡ªå·±çš„ä¸€é¡¹æ„Ÿå®˜ï¼ˆå¦‚å—…è§‰ã€è‰²è§‰ï¼‰ä½œä¸ºä»£ä»·ï¼Œä¸ä¸€ä¸ªä½é˜¶è§„åˆ™æ€ªè°ˆç­¾è®¢ä¸´æ—¶å¥‘çº¦ï¼Œè·å¾—ä¸€æ¬¡æ€§çš„ã€å¾®å°çš„ç°å®åˆ«æ ·èƒ½åŠ›ã€‚',
                  effects: 'æ„Ÿå®˜çŒ®ç¥­',
                },

                {
                  title: 'å…±é¸£å¤åˆ¶',
                  description: 'ä½ å¯ä»¥ä¸»åŠ¨ä¸ä¸€åNPCè¿›è¡Œæƒ…ç»ªå…±é¸£ï¼Œéšæœºå¤åˆ¶å…¶ä¸€é¡¹æœ€åŸºç¡€çš„éæˆ˜æ–—èƒ½åŠ›ï¼ŒæŒç»­5åˆ†é’Ÿã€‚',
                  effects: 'èƒ½åŠ›å¤åˆ¶',
                },

                {
                  title: 'æƒ…æ„Ÿäº¤æ˜“',
                  description:
                    "ä½ å¯ä»¥å°†ä¸€ä»½çœŸå®çš„'çˆ±æ„'ä½œä¸ºå•†å“ï¼Œä¸å…¶ä»–å­˜åœ¨äº¤æ˜“ï¼Œæ¢å–ä¸€ä¸ªæ— æ³•é¢„æµ‹æ•ˆæœçš„'ç¥ç¦'æˆ–'è¯…å’’'ã€‚",
                  effects: 'çˆ±æ„äº¤æ˜“',
                },
              ],

              mutation: [
                {
                  title: 'å¥‘çº¦ç•¸å˜',
                  description: 'å¥‘çº¦çš„åŠ›é‡å¼€å§‹ä¾µèš€ä½ çš„è®¤çŸ¥ï¼Œä½ çœ‹åˆ°çš„ç°å®ä¸–ç•Œä¼šéšæœºå‡ºç°ç¬¦åˆæ€ªè°ˆé€»è¾‘çš„ã€æ— å®³çš„å¹»è§‰ã€‚',
                  effects: 'è®¤çŸ¥ä¾µèš€',
                },

                {
                  title: 'å…±é¸£ç•¸å˜',
                  description: 'å…±é¸£ç»“æŸæ—¶ï¼Œä½ ä¸ä»…è¦æ‰¿å—å¯¹æ–¹çš„æ‰€æœ‰ç—›è‹¦ï¼Œå…¶æœ€å¼ºçƒˆçš„ä¸€ç§è´Ÿé¢æƒ…ç»ªè¿˜ä¼šåœ¨ä½ å¿ƒä¸­æ®‹ç•™ä¸€å°æ—¶ã€‚',
                  effects: 'ç—›è‹¦æ®‹ç•™',
                },

                {
                  title: 'ä»£ä»·å¼‚åŒ–',
                  description:
                    "ä½ ä¸ºè·å¾—åŠ›é‡è€Œä»˜å‡ºçš„'ä»£ä»·'ï¼ˆå¦‚å¤±å»çš„æ„Ÿå®˜ï¼‰ï¼Œä¼šä»¥ä¸€ç§ç‹¬ç‰¹çš„å½¢å¼åœ¨ä½ èº«ä½“å‘¨å›´é‡ç°ï¼Œå½¢æˆä¸€ä¸ªå¯è§çš„ã€ä»¤äººä¸å®‰çš„å…‰ç¯ã€‚",
                  effects: 'ä»£ä»·å…‰ç¯',
                },
              ],

              authority: [
                {
                  title: 'å¥‘çº¦æƒæŸ„',
                  description:
                    'ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå¼ºå¤§çš„è§„åˆ™æ€ªè°ˆï¼Œé€šè¿‡çŒ®ç¥­ä¸€é¡¹æ°¸ä¹…çš„èº«ä½“èƒ½åŠ›ï¼ˆå¦‚å¥”è·‘èƒ½åŠ›ï¼‰ï¼Œæ¢å–ä¸€æ¬¡ç¬é—´é€†è½¬å±€åŠ¿çš„å·¨å¤§åŠ›é‡ã€‚',
                  effects: 'èƒ½åŠ›çŒ®ç¥­',
                },

                {
                  title: 'å…±é¸£æƒæŸ„',
                  description: 'ä½ å¯ä»¥æŒ‡å®šå¤åˆ¶NPCçš„ä¸€é¡¹å¼ºå¤§èƒ½åŠ›ï¼Œä½†ä½œä¸ºä»£ä»·ï¼Œä½ çš„äººæ ¼ä¼šæš‚æ—¶è¢«å¯¹æ–¹çš„æ€§æ ¼ç‰¹è´¨æ‰€è¦†ç›–ã€‚',
                  effects: 'äººæ ¼è¦†ç›–',
                },

                {
                  title: 'ä¸å‡¡è§„åˆ™',
                  description:
                    "ä½ å¯ä»¥å°†ä¸¤ç§ä¸ç›¸å…³çš„'çˆ±æ„'èƒ½åŠ›è¿›è¡Œæ··åˆï¼Œåˆ›é€ å‡ºä¸€ä¸ªå…¨æ–°çš„ã€æ•ˆæœå¼ºå¤§ä½†å®Œå…¨ä¸å¯æ§çš„ä¸€æ¬¡æ€§æŠ€èƒ½ã€‚",
                  effects: 'èƒ½åŠ›æ··åˆ',
                },
              ],

              abyss: [
                {
                  title: 'å¥‘çº¦æ·±æ¸Š',
                  description:
                    'ä½ å°†è‡ªå·±ä½œä¸ºæœ€ç»ˆçš„ç¥­å“ï¼Œä¸ä¸€ä¸ªè§„åˆ™æ€ªè°ˆæœ¬èº«èä¸ºä¸€ä½“ï¼Œæˆä¸ºæ–°çš„æ€ªè°ˆï¼Œæ‹¥æœ‰åˆ¶å®šè§„åˆ™çš„åŠ›é‡ï¼Œä½†å½»åº•å¤±å»äººæ€§ã€‚',
                  effects: 'æ€ªè°ˆèåˆ',
                },

                {
                  title: 'å…±é¸£æ·±æ¸Š',
                  description:
                    "ä½ å¯ä»¥ä¸ä¸€ä¸ªç›®æ ‡è¿›è¡Œæ°¸ä¹…çš„æƒ…ç»ªå…±é¸£ï¼Œå®Œå…¨å¤åˆ¶å…¶æ‰€æœ‰èƒ½åŠ›ä¸è®°å¿†ï¼Œä½†ä½ çš„'è‡ªæˆ‘'ä¹Ÿå°†è¢«å¯¹æ–¹å®Œå…¨åŒåŒ–ï¼Œæˆä¸ºå…¶å½±å­ã€‚",
                  effects: 'å®Œå…¨åŒåŒ–',
                },

                {
                  title: 'æ··æ²ŒåŒ–èº«',
                  description:
                    "ä½ æˆä¸ºäº†'ç‹¬ç‰¹ä¹‹çˆ±'çš„åŒ–èº«ï¼Œèƒ½å¤Ÿéšæ„ç»„åˆæ‰€æœ‰çˆ±æ„èƒ½åŠ›ï¼Œä½†æ¯ä¸€æ¬¡ä½¿ç”¨éƒ½ä¼šè®©ä½ çš„å­˜åœ¨æœ¬èº«å˜å¾—æ›´åŠ æ··ä¹±å’Œä¸å¯åçŠ¶ï¼Œæœ€ç»ˆèµ°å‘å½»åº•çš„ç†µå¢ä¸æ¶ˆæ•£ã€‚",
                  effects: 'æ··æ²ŒåŒ–èº«',
                },
              ],
            },
          };

          return talentOptions[majorTalent]?.[level] || talentOptions['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'][level];
        }

        // å¤§å¤©èµ‹æè¿°è¯æ˜ å°„

        getMajorTalentDescription(majorTalent) {
          const descriptions = {
            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': {
              name: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡ç‹¬å å’Œæ§åˆ¶æ¥å¼ºåŒ–è‡ªèº«ã€‚åŠ›é‡æºäºå¯¹æŸç‰©çš„å¼ºçƒˆå æœ‰æ¬²ã€‚',

              positive: 'èƒ½å¤Ÿçœ‹ç©¿è§„åˆ™æ¼æ´ï¼Œæ‰¾åˆ°éšè—å¼±ç‚¹ï¼›çŸ­æ—¶é—´å†…å¤§å¹…æå‡é˜²å¾¡åŠ›ï¼›å…·ç°åŒ–æ— å½¢é”é“¾é”å®šç›®æ ‡ã€‚',

              negative:
                'èƒ½åŠ›è¶Šå¼ºï¼Œå¯¹"çˆ±äºº"çš„ä¾èµ–å’ŒæŸç¼šè¶Šæ·±ï¼Œæœ€ç»ˆå¤±å»è‡ªæˆ‘ï¼›è§†é‡å˜å¾—ç‹­çª„ï¼›æ¯æ¬¡ä½¿ç”¨ç•™ä¸‹"ä¼¤ç—•"ï¼›é”é“¾ä¼šåå™¬è‡ªèº«ã€‚',
            },

            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': {
              name: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰',

              description: 'å°†è°è¨€å’Œæ¬ºéª—è½¬åŒ–ä¸ºç°å®ã€‚åŠ›é‡æ˜¯ä¸ç¨³å®šçš„ï¼Œéšç€æ¬ºéª—è€Œæ”¹å˜ã€‚',

              positive: 'æš‚æ—¶ä¿®æ”¹è§„åˆ™æè¿°ä½¿å…¶æœ‰åˆ©ï¼›å°†è°è¨€å…·è±¡åŒ–ä¸ºéº»ç—¹æ•Œäººçš„æƒ…æ„Ÿï¼›åˆ›é€ è™šå‡"å½±å­"æ‰¿å—ä¼¤å®³ã€‚',

              negative:
                'æ‰€è¯´çš„ä¸€åˆ‡è°è¨€éƒ½ä¼šæ‰­æ›²å…·ç°åŒ–æˆä¸ºæ–°çš„å±é™©ï¼›è§„åˆ™å˜å¾—ä¸ç¨³å®šå¯èƒ½åå™¬ï¼›è°è¨€è¢«è¯†ç ´æ—¶æƒ…æ„Ÿå˜ä¸ºè‡´å‘½æ¯’è¯ï¼›å½±å­æ‰¿å—çš„ä¼¤å®³ä¼šå åŠ çˆ†å‘ã€‚',
            },

            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': {
              name: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡è‡ªæˆ‘ç‰ºç‰²æ¥å½±å“ä»–äººæˆ–ç¯å¢ƒã€‚åŠ›é‡æ˜¯æ— ç§çš„ï¼Œå´ä»¥è‡ªå·±çš„"å¤±å»"ä¸ºä»£ä»·ã€‚',

              positive: 'é‡Šæ”¾æƒ…ç»ªä½¿æ•Œäººå¤±å»æ”»å‡»æ€§ï¼›æ¶ˆè€—ç”Ÿå‘½æˆ–è®°å¿†ä¿®æ”¹è§„åˆ™ï¼›å…·ç°åŒ–åˆ†èº«æ‰§è¡Œä»»åŠ¡ã€‚',

              negative:
                'æ¯ä¸€æ¬¡ç‰ºç‰²éƒ½ä¼šæ°¸ä¹…å‰Šå¼±è‡ªèº«ï¼›ç²¾ç¥åŠ›ä¸Šé™æ°¸ä¹…é™ä½ï¼›ä¿®æ”¹çš„è§„åˆ™ä¼šä»¥æ›´å¼ºå½¢æ€å›å½’ï¼›åˆ†èº«è¢«æ‘§æ¯æ—¶ä¸€åŒæ­»äº¡ã€‚',
            },

            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': {
              name: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰',

              description: 'é€šè¿‡ç²¾ç¥æ§åˆ¶å’Œæƒ…æ„Ÿæ“çºµæ¥å¥´å½¹ä»–äººã€‚åŠ›é‡æºäºå¯¹ä»–äººçš„ç»å¯¹æ§åˆ¶ã€‚',

              positive: 'ç»™NPCæ–½åŠ å¿ƒç†æš—ç¤ºä½¿å…¶æœä»ï¼›æ“æ§è¢«å‡»è´¥çš„æ•Œäººä¸ºä½ æˆ˜æ–—ï¼›å¸æ”¶NPC"çˆ±æ„"è·å¾—ç‰¹æ®Šèƒ½åŠ›ã€‚',

              negative:
                'æ§åˆ¶çš„è¶Šå¤šè‡ªèº«æƒ…æ„Ÿè¶Šéº»æœ¨ï¼›NPCæ„è¯†åˆ°è¢«æ“çºµæ—¶å¼•å‘å¼ºçƒˆåå™¬ï¼›å¿…é¡»ä¸“æ³¨æ“æ§æ— æ³•ä½¿ç”¨å…¶ä»–èƒ½åŠ›ï¼›å¸æ”¶çš„"çˆ±æ„"ç•™ä¸‹æ‰­æ›²å°è®°æˆä¸ºå¼±ç‚¹ã€‚',
            },

            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': {
              name: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰',

              description: 'å°†æƒ³è±¡ä¸­çš„å®Œç¾ä¹‹çˆ±å…·ç°åŒ–ä¸ºå®ç‰©ã€‚åŠ›é‡æ¥æºäºå¯¹å®Œç¾çš„å¹»æƒ³ã€‚',

              positive: 'å…·ç°åŒ–è½»å‹ç›”ç”²å¸æ”¶ä¼¤å®³ï¼›å…·ç°åŒ–æˆ’æŒ‡è·å¾—å¼ºå¤§åŠ›é‡ï¼›å…·ç°åŒ–å®Œç¾NPCæ— æ¡ä»¶å¸®åŠ©ã€‚',

              negative:
                'å…·ç°åŒ–ç‰©å“åªå¯¹"çˆ±æ„"ååº”å¹¶é€æ¸å–ä»£ç°å®ï¼›ç›”ç”²é€æ¸å˜é‡é™åˆ¶è¡ŒåŠ¨ï¼›è¿èƒŒæ‰¿è¯ºæˆ’æŒ‡åŒ–ä¸ºæ·é”ï¼›å®Œç¾NPCæ¶ˆè€—å¤§é‡"çˆ±"ä¸”æ— æ³•ç†è§£çœŸå®æƒ…æ„Ÿã€‚',
            },

            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': {
              name: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰',

              description: 'æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„ã€è¶…è¶Šå¸¸è§„çš„æ‰­æ›²èƒ½åŠ›ã€‚åŠ›é‡æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œé€šå¸¸æ˜¯ä»¥ä¸Šäº”ç§çˆ±æ„çš„æ··åˆæˆ–å˜å¼‚ã€‚',

              positive: 'ä¸å¼ºå¤§è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦è·å¾—ç¬é—´å·¨å¤§åŠ›é‡ï¼›ä¸NPCæƒ…ç»ªå…±é¸£å¤åˆ¶å…¶èƒ½åŠ›ã€‚',

              negative: 'èƒ½åŠ›ä¼´éšæœ€ä¸å¯æ§çš„é£é™©å’Œæœ€æ·±çš„å¼‚åŒ–ï¼›å¿…é¡»ä»¥æŸéƒ¨åˆ†ä¸ºä»£ä»·ï¼›å…±é¸£ç»“æŸæ—¶æ‰¿å—æ‰€æœ‰ç—›è‹¦ã€‚',
            },
          };

          return descriptions[majorTalent] || descriptions['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'];
        }

        // è·å–å½“å‰é€‰æ‹©çš„å¤§å¤©èµ‹æ–¹å‘

        getCurrentMajorTalent() {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ğŸ”¥ ä¸ä½¿ç”¨[0]ç´¢å¼•ï¼Œç›´æ¥è·å–å¤§å¤©èµ‹
              let majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', { default_value: null });

              // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨getAllVariablesä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
                  const allVars = window.teresenDebug.getAllVariables();
                  majorTalent = window.teresenDebug.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', null);
                }
              }

              // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
              }

              return majorTalent;
            }
          } catch (error) {
            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          return 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
        }

        updateUpgradeHistory() {
          const container = document.getElementById('upgrade-history');

          if (!container) return;

          try {
            let acquiredTalents = [];

            // ä»MVUå˜é‡è¯»å–å·²è·å¾—çš„å¤©èµ‹

            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              const levels = ['èŒèŠ½', 'ç”Ÿé•¿', 'ç•¸å˜', 'æƒæŸ„', 'æ·±æ¸Š'];

              levels.forEach(level => {
                const talent = Mvu.getMvuVariable(mvuData, `è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.${level}`, { default_value: null });

                if (talent) {
                  acquiredTalents.push({
                    level: level,

                    title: talent,
                  });
                }
              });
            }

            if (acquiredTalents.length === 0) {
              container.innerHTML =
                '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">æš‚æ— å‡çº§è®°å½•</div>';

              return;
            }

            let html = '';

            acquiredTalents.forEach((talent, index) => {
              html += `

                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">

                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">

                    <span style="color: #22c55e; font-size: 16px; font-weight: bold;">${talent.level} - ${talent.title}</span>

                  </div>

                </div>

              `;
            });

            container.innerHTML = html;
          } catch (error) {
            console.error('æ›´æ–°å‡çº§è®°å½•å¤±è´¥:', error);

            container.innerHTML =
              '<div style="text-align: center; color: #666666; font-style: italic; padding: 50px;">åŠ è½½å¤±è´¥</div>';
          }
        }

        // å½“å‰é¡µé¢ç´¢å¼•

        currentTalentPage = 0;

        // é¡µé¢æ ‡é¢˜æ•°ç»„

        talentPageTitles = ['ğŸ“– å½“å‰å¤©èµ‹', 'ğŸŒ± èŒèŠ½', 'ğŸŒ¿ ç”Ÿé•¿', 'ğŸŒ€ ç•¸å˜', 'ğŸ‘‘ æƒæŸ„', 'ğŸŒŒ æ·±æ¸Š', 'ğŸ“š å‡çº§è®°å½•'];

        switchTalentPage(page) {
          // æ’­æ”¾ç¿»é¡µå£°éŸ³
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          // éšè—æ‰€æœ‰é¡µé¢

          const pages = document.querySelectorAll('.book-page');

          pages.forEach(p => (p.style.display = 'none'));

          // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€

          const buttons = document.querySelectorAll('.page-btn');

          buttons.forEach(btn => {
            btn.classList.remove('active');

            btn.style.background = 'rgba(139, 69, 19, 0.3)';

            btn.style.border = '2px solid rgba(139, 69, 19, 0.5)';

            btn.style.color = '#8b4513';
          });

          // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢

          const targetPage = document.getElementById(`page-${page}-content`);

          if (targetPage) {
            targetPage.style.display = 'block';
          }

          // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®

          const targetBtn = document.getElementById(`page-${page}`);

          if (targetBtn) {
            targetBtn.classList.add('active');

            targetBtn.style.background = 'linear-gradient(135deg, #8b4513, #a0522d)';

            targetBtn.style.border = '2px solid #8b4513';

            targetBtn.style.color = '#ffffff';
          }
        }

        // ç¿»é¡µåˆ°æŒ‡å®šé¡µé¢

        goToTalentPage(pageIndex) {
          if (pageIndex < 0 || pageIndex >= this.talentPageTitles.length) return;

          // æ’­æ”¾ç¿»é¡µå£°éŸ³
          const sound = document.getElementById('page-flip-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          this.currentTalentPage = pageIndex;

          // æ›´æ–°å®¹å™¨ä½ç½® - ä¿®å¤å®½åº¦è®¡ç®—é—®é¢˜

          const container = document.getElementById('book-pages-container');

          if (container) {
            // è·å–å®¹å™¨çš„å®é™…å®½åº¦

            const containerWidth = container.offsetWidth;

            // ä½¿ç”¨åƒç´ å€¼è€Œä¸æ˜¯ç™¾åˆ†æ¯”ï¼Œç¡®ä¿åœ¨ä¸åŒå®½åº¦ä¸‹éƒ½èƒ½æ­£ç¡®ç¿»é¡µ

            container.style.transform = `translateX(-${pageIndex * containerWidth}px)`;
          }

          // æ›´æ–°é¡µé¢æŒ‡ç¤ºå™¨

          this.updatePageIndicator();

          // æ›´æ–°æŒ‰é’®çŠ¶æ€

          this.updatePageButtons();

          // æ›´æ–°å½“å‰é¡µé¢çš„é€‰é¡¹

          this.updateCurrentPageOptions();
        }

        // ä¸Šä¸€é¡µ

        prevTalentPage() {
          if (this.currentTalentPage > 0) {
            // æ’­æ”¾ç¿»é¡µå£°éŸ³
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            this.goToTalentPage(this.currentTalentPage - 1);
          }
        }

        // ä¸‹ä¸€é¡µ

        nextTalentPage() {
          if (this.currentTalentPage < this.talentPageTitles.length - 1) {
            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            // æ£€æŸ¥ä¸‹ä¸€å±‚çº§æ˜¯å¦å·²è§£é”

            if (nextLevel && !this.isLevelUnlocked(nextLevel)) {
              const previousLevel = this.getPreviousLevel(nextLevel);

              const previousLevelChinese = this.getLevelChineseName(previousLevel);

              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(
                  `æ— æ³•è®¿é—®è¯¥å±‚çº§ï¼éœ€è¦å…ˆå®Œæˆ ${previousLevelChinese} å±‚çº§çš„å¤©èµ‹é€‰æ‹©ã€‚è¯·è¿”å›ä¸Šä¸€é¡µé€‰æ‹©å¤©èµ‹ã€‚`,
                );
              }

              return;
            }

            // æ’­æ”¾ç¿»é¡µå£°éŸ³
            const sound = document.getElementById('page-flip-sound');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('ç¿»é¡µéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            this.goToTalentPage(nextPage);
          }
        }

        // æ›´æ–°é¡µé¢æŒ‡ç¤ºå™¨

        updatePageIndicator() {
          const titleElement = document.getElementById('current-page-title');

          const numberElement = document.getElementById('page-number');

          if (titleElement) {
            titleElement.textContent = this.talentPageTitles[this.currentTalentPage];
          }

          if (numberElement) {
            numberElement.textContent = `ç¬¬ ${this.currentTalentPage + 1} é¡µ / å…± ${this.talentPageTitles.length} é¡µ`;
          }
        }

        // æ›´æ–°ç¿»é¡µæŒ‰é’®çŠ¶æ€

        updatePageButtons() {
          const prevBtn = document.getElementById('prev-page-btn');

          const nextBtn = document.getElementById('next-page-btn');

          if (prevBtn) {
            prevBtn.disabled = this.currentTalentPage === 0;

            prevBtn.style.opacity = this.currentTalentPage === 0 ? '0.5' : '1';
          }

          if (nextBtn) {
            const nextPage = this.currentTalentPage + 1;

            const nextLevel = this.getLevelByPageIndex(nextPage);

            // æ£€æŸ¥ä¸‹ä¸€å±‚çº§æ˜¯å¦å·²è§£é”

            const isNextLevelUnlocked = !nextLevel || this.isLevelUnlocked(nextLevel);

            const isLastPage = this.currentTalentPage === this.talentPageTitles.length - 1;

            nextBtn.disabled = isLastPage || !isNextLevelUnlocked;

            nextBtn.style.opacity = isLastPage || !isNextLevelUnlocked ? '0.5' : '1';

            // å¦‚æœä¸‹ä¸€å±‚çº§æœªè§£é”ï¼Œæ·»åŠ æç¤º

            if (!isLastPage && !isNextLevelUnlocked) {
              nextBtn.title = `éœ€è¦å…ˆå®Œæˆ ${this.getLevelChineseName(this.getPreviousLevel(nextLevel))} å±‚çº§`;
            } else {
              nextBtn.title = '';
            }
          }
        }

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬

        addKeyboardListeners() {
          this.keyboardHandler = e => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
              e.preventDefault();

              this.prevTalentPage();
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
              e.preventDefault();

              this.nextTalentPage();
            } else if (e.key === 'Escape') {
              e.preventDefault();

              this.closeTalentsModal();
            }
          };

          document.addEventListener('keydown', this.keyboardHandler);
        }

        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬

        removeKeyboardListeners() {
          if (this.keyboardHandler) {
            document.removeEventListener('keydown', this.keyboardHandler);

            this.keyboardHandler = null;
          }
        }

        // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨

        addResizeListener() {
          this.resizeHandler = () => {
            // é‡æ–°è®¡ç®—å½“å‰é¡µé¢ä½ç½®ï¼Œä¿®å¤å®½åº¦å˜åŒ–æ—¶ç¿»é¡µé”™ä½é—®é¢˜

            const container = document.getElementById('book-pages-container');

            if (container) {
              const containerWidth = container.offsetWidth;

              container.style.transform = `translateX(-${this.currentTalentPage * containerWidth}px)`;
            }
          };

          window.addEventListener('resize', this.resizeHandler);
        }

        // ç§»é™¤çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨

        removeResizeListener() {
          if (this.resizeHandler) {
            window.removeEventListener('resize', this.resizeHandler);

            this.resizeHandler = null;
          }
        }

        // å…³é—­å¤©èµ‹æ¨¡æ€æ¡†

        closeTalentsModal() {
          const modal = document.getElementById('talents-modal');

          if (modal) {
            modal.style.display = 'none';

            modal.style.justifyContent = '';

            modal.style.alignItems = '';

            this.removeKeyboardListeners();

            // ç§»é™¤çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨

            this.removeResizeListener();
          }
        }

        // æµ‹è¯•MVUæ³¨å…¥åŠŸèƒ½

        async testMvuInjection() {
          try {
            console.log('ğŸ§ª æµ‹è¯•MVUæ³¨å…¥åŠŸèƒ½...');

            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ç¡®ä¿stat_dataæœ‰$internalå±æ€§ï¼ˆMVU betaéœ€è¦ï¼‰
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°ç¡®ä¿$internalæ­£ç¡®åˆå§‹åŒ–
              if (!mvuData || !mvuData.stat_data) {
                console.error('âŒ MVUæ•°æ®æ— æ•ˆ');
                return;
              }

              // ç¡®ä¿display_dataå’Œdelta_dataå­˜åœ¨
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }

              // åˆ›å»º$internalï¼ŒæŒ‡å‘display_dataå’Œdelta_data
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('âœ… å·²åˆå§‹åŒ–$internalå±æ€§');
              } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              // æµ‹è¯•æ³¨å…¥ä¸€ä¸ªå¤©èµ‹

              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.èŒèŠ½', 'æµ‹è¯•å¤©èµ‹', {
                reason: 'æµ‹è¯•æ³¨å…¥',

                is_recursive: true,
              });

              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              console.log('âœ… MVUæ³¨å…¥æµ‹è¯•æˆåŠŸï¼');

              alert('MVUæ³¨å…¥æµ‹è¯•æˆåŠŸï¼è¯·æ£€æŸ¥å¤©èµ‹ç•Œé¢');
            } else {
              console.warn('âš ï¸ MVU API ä¸å¯ç”¨');

              alert('MVU API ä¸å¯ç”¨');
            }
          } catch (error) {
            console.error('âŒ MVUæ³¨å…¥æµ‹è¯•å¤±è´¥:', error);

            alert('MVUæ³¨å…¥æµ‹è¯•å¤±è´¥: ' + error.message);
          }
        }

        // æ£€æŸ¥MVUçŠ¶æ€

        checkMvuStatus() {
          console.log('ğŸ” æ£€æŸ¥MVUçŠ¶æ€...');

          // æ£€æŸ¥MVUå¯¹è±¡

          console.log('ğŸ“Š MVUå¯¹è±¡:', typeof Mvu);

          if (typeof Mvu !== 'undefined') {
            console.log('âœ… MVUå¯¹è±¡å­˜åœ¨');

            console.log('ğŸ“‹ MVUå‡½æ•°:', {
              getMvuData: typeof Mvu.getMvuData,

              setMvuVariable: typeof Mvu.setMvuVariable,

              replaceMvuData: typeof Mvu.replaceMvuData,

              getMvuVariable: typeof Mvu.getMvuVariable,
            });
          } else {
            console.error('âŒ MVUå¯¹è±¡ä¸å­˜åœ¨');
          }

          // å°è¯•è·å–MVUæ•°æ®

          try {
            const mvuData = Mvu.getMvuData({ type: 'chat' });

            console.log('ğŸ“Š MVUæ•°æ®è·å–:', mvuData ? 'æˆåŠŸ' : 'å¤±è´¥');

            console.log('ğŸ“‹ MVUæ•°æ®å†…å®¹:', mvuData);
          } catch (error) {
            console.error('âŒ MVUæ•°æ®è·å–å¤±è´¥:', error);
          }

          // æ£€æŸ¥å½“å‰ç»“æ™¶æ•°é‡

          try {
            const mvuData = Mvu.getMvuData({ type: 'chat' });

            const crystals = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', { default_value: 0 });

            console.log('ğŸ’ å½“å‰ç»“æ™¶æ•°é‡:', crystals);
          } catch (error) {
            console.error('âŒ ç»“æ™¶æ•°é‡è·å–å¤±è´¥:', error);
          }

          alert('MVUçŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
        }

        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆAIå›ç­”

        // è®¾ç½®å›è½¦å‘é€åŠŸèƒ½
        setupEnterToSend() {
          const actionInput = document.getElementById('action-input');
          if (!actionInput) return;

          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (actionInput._enterToSendHandler) {
            $(actionInput).off('keydown', actionInput._enterToSendHandler);
            actionInput._enterToSendHandler = null;
          }

          // æ£€æŸ¥è®¾ç½®ï¼ˆé»˜è®¤å…³é—­ï¼Œåªæœ‰æ˜ç¡®ä¸º'true'æ—¶æ‰å¯ç”¨ï¼‰
          const enterToSend = localStorage.getItem('teresen_enter_to_send') === 'true';

          if (enterToSend) {
            // æ·»åŠ å›è½¦é”®äº‹ä»¶ç›‘å¬å™¨
            actionInput._enterToSendHandler = e => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                $('#btn-send-action').click();
              }
            };
            $(actionInput).on('keydown', actionInput._enterToSendHandler);
          }
        }

        // ğŸ”¥ åˆå§‹åŒ–å¿«æ·åŠŸèƒ½æ‚¬æµ®çª— - å‚è€ƒåœ°å›¾å¼¹çª—çš„å®ç°æ–¹å¼
        initQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) {
            console.warn('âš ï¸ æœªæ‰¾åˆ°å¿«æ·åŠŸèƒ½å¼¹çª—å…ƒç´ ');
            return;
          }

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå‚è€ƒåœ°å›¾å¼¹çª—çš„å®ç°
          $(document).on('click', '#quick-action-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickActionModal();
          });

          $(document).on('click', '#quick-action-modal-close-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickActionModal();
          });

          $(document).on('click', '#quick-action-modal', e => {
            if (e.target.id === 'quick-action-modal') {
              this.closeQuickActionModal();
            }
          });

          // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
          $(document).on('click', '.quick-action-modal-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const action = $(e.currentTarget).data('action');
            if (action) {
              this.handleQuickAction(action);
              this.closeQuickActionModal();
            }
          });

          console.log('âœ… å¿«æ·åŠŸèƒ½å¼¹çª—å·²åˆå§‹åŒ–');
        }

        // ğŸ”¥ æ‰“å¼€å¿«æ·åŠŸèƒ½å¼¹çª— - å‚è€ƒå¤©èµ‹å¼¹çª—çš„å®ç°æ–¹å¼
        openQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) return;

          // å‚è€ƒå¤©èµ‹å¼¹çª—ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modal.parentNode !== overlay) {
            modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
            overlay.appendChild(modal);
            console.log('âœ… quick-action-modal å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨');
          }

          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
        }

        // ğŸ”¥ å…³é—­å¿«æ·åŠŸèƒ½å¼¹çª— - å‚è€ƒå¤©èµ‹å¼¹çª—çš„å®ç°æ–¹å¼
        closeQuickActionModal() {
          const modal = document.getElementById('quick-action-modal');
          if (!modal) return;

          modal.style.display = 'none';
          modal.style.justifyContent = '';
          modal.style.alignItems = '';
        }

        // ğŸ”¥ åˆå§‹åŒ–å¿«æ·å§¿åŠ¿å¼¹çª— - å‚è€ƒåœ°å›¾å¼¹çª—çš„å®ç°æ–¹å¼
        initQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) {
            console.warn('âš ï¸ æœªæ‰¾åˆ°å¿«æ·å§¿åŠ¿å¼¹çª—å…ƒç´ ');
            return;
          }

          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå‚è€ƒåœ°å›¾å¼¹çª—çš„å®ç°
          $(document).on('click', '#quick-position-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickPositionModal();
          });

          $(document).on('click', '#quick-position-modal-close-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickPositionModal();
          });

          $(document).on('click', '#quick-position-modal', e => {
            if (e.target.id === 'quick-position-modal') {
              this.closeQuickPositionModal();
            }
          });

          // äºŒçº§å¯¼èˆªï¼šå¤§ç±»æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '.position-category-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const category = $(e.currentTarget).data('category');
            if (category) {
              this.showPositionSubcategory(category);
            }
          });

          // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '.position-back-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.showPositionCategoryList();
          });

          // å§¿åŠ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '.quick-position-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            const position = $(e.currentTarget).data('position');
            if (position) {
              this.handleQuickPosition(position);
              this.closeQuickPositionModal();
            }
          });

          console.log('âœ… å¿«æ·å§¿åŠ¿å¼¹çª—å·²åˆå§‹åŒ–');
        }

        // ğŸ”¥ æ‰“å¼€å¿«æ·å§¿åŠ¿å¼¹çª— - å‚è€ƒå¤©èµ‹å¼¹çª—çš„å®ç°æ–¹å¼
        openQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          // å‚è€ƒå¤©èµ‹å¼¹çª—ï¼šæ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modal.parentNode !== overlay) {
            modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
            overlay.appendChild(modal);
            console.log('âœ… quick-position-modal å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨');
          }

          // é‡ç½®åˆ°ç¬¬ä¸€çº§å¯¼èˆª
          this.showPositionCategoryList();
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
        }

        // ğŸ”¥ å…³é—­å¿«æ·å§¿åŠ¿å¼¹çª— - å‚è€ƒå¤©èµ‹å¼¹çª—çš„å®ç°æ–¹å¼
        closeQuickPositionModal() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          modal.style.display = 'none';
          modal.style.justifyContent = '';
          modal.style.alignItems = '';
        }

        // ğŸ”¥ æ˜¾ç¤ºå§¿åŠ¿åˆ†ç±»åˆ—è¡¨ï¼ˆç¬¬ä¸€çº§ï¼‰
        showPositionCategoryList() {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          const categoryList = modal.querySelector('.position-category-list');
          const subcategoryList = modal.querySelector('.position-subcategory-list');

          if (categoryList) categoryList.style.display = 'block';
          if (subcategoryList) subcategoryList.style.display = 'none';
        }

        // ğŸ”¥ æ˜¾ç¤ºå§¿åŠ¿å­åˆ†ç±»ï¼ˆç¬¬äºŒçº§ï¼‰
        showPositionSubcategory(category) {
          const modal = document.getElementById('quick-position-modal');
          if (!modal) return;

          const categoryList = modal.querySelector('.position-category-list');
          const subcategoryList = modal.querySelector('.position-subcategory-list');

          if (categoryList) categoryList.style.display = 'none';
          if (subcategoryList) {
            subcategoryList.style.display = 'block';
            // æ˜¾ç¤ºå¯¹åº”åˆ†ç±»çš„å†…å®¹
            const allSubcategories = subcategoryList.querySelectorAll('.position-subcategory');
            allSubcategories.forEach(sub => {
              if (sub.dataset.category === category) {
                sub.style.display = 'block';
              } else {
                sub.style.display = 'none';
              }
            });
          }
        }

        // ğŸ”¥ å¤„ç†å¿«æ·å§¿åŠ¿æŒ‰é’®ç‚¹å‡»
        handleQuickPosition(position) {
          console.log('ğŸ’• å¿«æ·å§¿åŠ¿:', position);

          // å°†"è¦æ±‚ xxxå§¿åŠ¿"å¡«å…¥è¾“å…¥æ¡†
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            actionInput.value = `è¦æ±‚${position}å§¿åŠ¿`;
            // è§¦å‘inputäº‹ä»¶ä»¥ç¡®ä¿ç•Œé¢æ›´æ–°
            actionInput.dispatchEvent(new Event('input', { bubbles: true }));

            // è‡ªåŠ¨å‘é€
            setTimeout(() => {
              const sendBtn = document.getElementById('btn-send-action');
              if (sendBtn) {
                sendBtn.click();
              }
            }, 100);
          }
        }

        // ğŸ”¥ å¤„ç†å¿«æ·åŠŸèƒ½æŒ‰é’®ç‚¹å‡»
        handleQuickAction(action) {
          console.log('âš¡ å¿«æ·åŠŸèƒ½:', action);

          // åŠŸèƒ½åç§°æ˜ å°„
          const actionNames = {
            meal: 'åŠ é¤',
            borrow: 'å€Ÿé’±',
            game: 'æ‰“æ¸¸æˆ',
            chat: 'èŠå¤©',
            rest: 'ä¼‘æ¯åˆ°ä¸‹å‘¨',
            train: 'è®­ç»ƒé©¬å¨˜',
            schedule: 'æŸ¥çœ‹èµ›ç¨‹',
            gacha: 'å»æ‰­è›‹',
            phone: 'æ‰‹æœºè”ç»œ',
            rules: 'è§„åˆ™æ£€æŸ¥',
          };

          const actionName = actionNames[action] || action;

          // ç›´æ¥å‘é€åˆ°èŠå¤©æ¡†
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            // æ ¹æ®ä¸åŒçš„åŠŸèƒ½å‘é€ä¸åŒçš„æ–‡æœ¬
            let message = '';
            switch (action) {
              case 'meal':
                message = 'è¦æ±‚åŠ é¤';
                break;
              case 'borrow':
                message = 'è¦æ±‚å€Ÿé’±';
                break;
              case 'game':
                message = 'è¦æ±‚æ‰“æ¸¸æˆ';
                break;
              case 'chat':
                message = 'è¦æ±‚èŠå¤©';
                break;
              case 'rest':
                message = 'ä¼‘æ¯åˆ°ä¸‹å‘¨';
                break;
              case 'train':
                message = 'è®­ç»ƒé©¬å¨˜';
                break;
              case 'schedule':
                message = 'æŸ¥çœ‹èµ›ç¨‹';
                break;
              case 'gacha':
                message = 'å»æ‰­è›‹';
                break;
              case 'phone':
                message = 'æ‰‹æœºè”ç»œ';
                break;
              case 'rules':
                message = 'è§„åˆ™æ£€æŸ¥';
                break;
              default:
                message = actionName;
            }

            actionInput.value = message;
            // è§¦å‘inputäº‹ä»¶ä»¥ç¡®ä¿ç•Œé¢æ›´æ–°
            actionInput.dispatchEvent(new Event('input', { bubbles: true }));

            // è‡ªåŠ¨å‘é€
            setTimeout(() => {
              const sendBtn = document.getElementById('btn-send-action');
              if (sendBtn) {
                sendBtn.click();
              }
            }, 100);
          }
        }

        // ğŸ”¥ å¼€å§‹å¿«æ·åŠŸèƒ½é€‰æ‹©ï¼ˆéœ€è¦é€‰æ‹©é©¬å¨˜ï¼‰
        startQuickActionSelection(actionType) {
          const actionNames = {
            meal: 'åŠ é¤',
            borrow: 'å€Ÿé’±',
            game: 'æ‰“æ¸¸æˆ',
            chat: 'èŠå¤©',
          };
          const actionName = actionNames[actionType] || actionType;

          // æ˜¾ç¤ºæç¤º
          $('.quick-action-selection-hint').remove();
          const hint = $('<div class="quick-action-selection-hint gift-selection-hint">').html(`
            <div class="hint-content">
              <span class="hint-icon">${actionType === 'meal' ? 'ğŸ½ï¸' : actionType === 'borrow' ? 'ğŸ’°' : actionType === 'game' ? 'ğŸ®' : 'ğŸ’¬'}</span>
              <span class="hint-text">è¯·ç‚¹å‡»è¦${actionName}çš„é©¬å¨˜å¡ç‰‡</span>
              <button class="hint-close" onclick="$(this).closest('.quick-action-selection-hint').remove(); if (window.quickActionSelectionMode) window.quickActionSelectionMode = null;">Ã—</button>
            </div>
          `);
          $('body').append(hint);

          // é«˜äº®é©¬å¨˜å¡ç‰‡
          if (typeof highlightCharacterCards === 'function') {
            highlightCharacterCards();
          }

          // è®¾ç½®é€‰æ‹©æ¨¡å¼
          window.quickActionSelectionMode = {
            active: true,
            actionType: actionType,
            actionName: actionName,
            startTime: Date.now(),
          };

          // 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
          setTimeout(() => {
            if (window.quickActionSelectionMode?.active) {
              this.cancelQuickActionSelection();
            }
          }, 30000);
        }

        // ğŸ”¥ å–æ¶ˆå¿«æ·åŠŸèƒ½é€‰æ‹©
        cancelQuickActionSelection() {
          $('.quick-action-selection-hint').remove();
          window.quickActionSelectionMode = null;
          $('.gift-selectable, .uma-item, .character-card').removeClass('gift-selectable skill-selectable');
        }

        // ğŸ”¥ æ‰§è¡Œå¿«æ·åŠŸèƒ½
        executeQuickAction(actionType, characterName, characterId) {
          const actionData = {
            characterName: characterName,
            characterId: characterId,
          };

          // æ ¹æ®ç±»å‹æ·»åŠ åˆ°æŒ‡ä»¤ç³»ç»Ÿ
          let actionCommand = '';
          switch (actionType) {
            case 'meal':
              actionCommand = 'åŠ é¤';
              break;
            case 'borrow':
              actionCommand = 'å€Ÿé’±';
              break;
            case 'game':
              actionCommand = 'æ‰“æ¸¸æˆ';
              break;
            case 'chat':
              actionCommand = 'èŠå¤©';
              break;
          }

          if (typeof addPendingAction === 'function' && actionCommand) {
            // ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’actionCommandä½œä¸ºitemNameï¼Œè¿™æ ·åœ¨æ ¼å¼åŒ–æ—¶ä¼šæ­£ç¡®æ˜¾ç¤º
            addPendingAction(actionType, actionCommand, actionData);
            console.log(`âœ… å·²æ·»åŠ ${actionCommand}æŒ‡ä»¤: ${characterName}`);
          }
        }

        // ğŸ”¥ ä¼‘æ¯åˆ°ä¸‹å‘¨
        handleRestToNextWeek() {
          if (typeof addPendingAction === 'function') {
            addPendingAction('rest', 'ä¼‘æ¯åˆ°ä¸‹å‘¨', {
              description: 'è®­ç»ƒå‘˜å†³å®šä¼‘æ¯åˆ°ä¸‹å‘¨',
            });
            console.log('âœ… å·²æ·»åŠ ä¼‘æ¯åˆ°ä¸‹å‘¨æŒ‡ä»¤');
          }
        }

        // ğŸ”¥ å¤–å‡ºï¼ˆè°ƒç”¨å¿«æ·åœ°å›¾ï¼‰
        handleGoOut() {
          if (this.openQuickMap) {
            this.openQuickMap();
          } else if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.openQuickMap) {
            window.TavernHelper.openQuickMap();
          } else {
            console.warn('å¿«æ·åœ°å›¾åŠŸèƒ½ä¸å¯ç”¨');
          }
        }

        async rerollAIResponse() {
          try {
            if (!this.lastSentPrompt) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€æ¡æŒ‡ä»¤ï¼');
              }

              return;
            }

            // åŠ è½½è‡ªåŠ¨å­˜æ¡£

            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (autoSaveData) {
              const saveData = JSON.parse(autoSaveData);

              if (saveData.mvu_data) {
                // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU
                this.currentMvuState = saveData.mvu_data;
                this.renderUI(this.currentMvuState.stat_data);
              }
            }

            // é‡æ–°å‘é€ä¸Šä¸€æ¡æŒ‡ä»¤

            const actionInput = document.getElementById('action-input');

            if (actionInput) {
              actionInput.value = this.lastSentPrompt;

              await this.handleActionSubmit();
            }

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('æ­£åœ¨é‡æ–°ç”ŸæˆAIå›ç­”...');
            }
          } catch (error) {
            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼');
            }
          }
        }

        // ğŸ”¥ è¾…åŠ©å‡½æ•°ï¼šå°†å¼¹çª—æ·»åŠ åˆ°æ­£ç¡®çš„ä½ç½®ï¼ˆå…¨å±æ—¶æ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨ï¼‰
        appendModalToCorrectParent(html) {
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            // å…¨å±çŠ¶æ€ï¼šæ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨
            overlay.insertAdjacentHTML('beforeend', html);
            console.log('âœ… å¼¹çª—å·²æ·»åŠ åˆ°å…¨å±è¦†ç›–å±‚å†…éƒ¨');
          } else {
            // éå…¨å±çŠ¶æ€ï¼šæ·»åŠ åˆ° body
            document.body.insertAdjacentHTML('beforeend', html);
            console.log('âœ… å¼¹çª—å·²æ·»åŠ åˆ° body');
          }
        }

        // ğŸ”¥ å°†æ‰€æœ‰å·²å­˜åœ¨çš„å¼¹çª—ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
        moveModalsToOverlay(overlay) {
          const modalSelectors = [
            '#rules-modal',
            '#load-modal',
            '.danger-modal',
            '#command-modal',
            '#talents-modal',
            '#saveManagerModal',
            '#world-map-modal',
            '#tarot-modal',
            '#shrine-modal',
            '#achievement-modal',
            '#achievements-modal',
            '.item-detail-popup',
            '#roster-modal',
            '#roster-detail-modal',
            '#location-detail-panel',
            '#quick-map-modal',
            '#quick-action-modal',
            '#quick-position-modal',
            '#music-player-modal',
            '#location-confirm-modal',
            '#settings-modal',
            '#history-menu-modal',
            '#chat-history-modal',
            '#avatar-selector-modal',
          ];

          modalSelectors.forEach(selector => {
            const modals = document.querySelectorAll(selector);
            modals.forEach(modal => {
              if (modal && modal.parentNode !== overlay) {
                // ä¿å­˜åŸå§‹çˆ¶å…ƒç´ ä¿¡æ¯
                modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
                // ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
                overlay.appendChild(modal);
                console.log(`âœ… å¼¹çª— ${selector} å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨`);
              }
            });
          });
        }

        // ğŸ”¥ æ£€æŸ¥å¹¶ç§»åŠ¨å¼¹çª—åˆ°è¦†ç›–å±‚å†…éƒ¨ï¼ˆåœ¨æ˜¾ç¤ºæ—¶è°ƒç”¨ï¼‰
        ensureModalInOverlay(modalElement) {
          if (!modalElement) return;

          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && modalElement.parentNode !== overlay) {
            // ä¿å­˜åŸå§‹çˆ¶å…ƒç´ ä¿¡æ¯
            if (!modalElement.dataset.originalParent) {
              modalElement.dataset.originalParent = modalElement.parentNode?.tagName || 'BODY';
            }
            // ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨
            overlay.appendChild(modalElement);
            console.log(`âœ… å¼¹çª—å·²ç§»åŠ¨åˆ°è¦†ç›–å±‚å†…éƒ¨: ${modalElement.id || modalElement.className}`);
          }
        }

        // ğŸ”¥ å°†æ‰€æœ‰å¼¹çª—ç§»å›åŸä½ç½®
        restoreModalsToOriginalPosition() {
          const modalSelectors = [
            '#rules-modal',
            '#load-modal',
            '.danger-modal',
            '#command-modal',
            '#talents-modal',
            '#saveManagerModal',
            '#world-map-modal',
            '#tarot-modal',
            '#shrine-modal',
            '#achievement-modal',
            '#achievements-modal',
            '.item-detail-popup',
            '#roster-modal',
            '#roster-detail-modal',
            '#location-detail-panel',
            '#quick-map-modal',
            '#quick-action-modal',
            '#quick-position-modal',
            '#music-player-modal',
            '#location-confirm-modal',
            '#settings-modal',
            '#history-menu-modal',
            '#chat-history-modal',
            '#avatar-selector-modal',
          ];

          modalSelectors.forEach(selector => {
            const modals = document.querySelectorAll(selector);
            modals.forEach(modal => {
              if (modal && modal.dataset.originalParent) {
                const originalParent =
                  modal.dataset.originalParent === 'BODY'
                    ? document.body
                    : document.querySelector(modal.dataset.originalParent);

                if (originalParent && modal.parentNode !== originalParent) {
                  originalParent.appendChild(modal);
                  delete modal.dataset.originalParent;
                  console.log(`âœ… å¼¹çª— ${selector} å·²ç§»å›åŸä½ç½®`);
                }
              }
            });
          });
        }

        // æ–°å¢ï¼šå®Œæ•´çš„å­˜æ¡£ç®¡ç†å™¨æ¨¡æ€æ¡†

        // ğŸ”¥ å­˜æ¡£åŠŸèƒ½å·²åˆ é™¤
        openSaveManagerModal_DELETED() {
          const modalId = 'saveManagerModal';

          if (document.getElementById(modalId)) {
            return; // å·²æ‰“å¼€
          }

          const html = `

              <div id="${modalId}" class="rules-modal" style="display: flex;">

                <div class="rules-modal-content" style="max-width: 900px; width: 95%; max-height: 80vh;">

                  <div class="rules-modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(139, 105, 20, 0.3);">

                    <h2 class="rules-title" style="margin: 0;">ç‰¹é›·æ£®å­¦é™¢ Â· å­˜æ¡£ç®¡ç†</h2>

                    <div style="display: flex; gap: 10px; align-items: center;">
                      <button id="importSaveBtn" class="interaction-btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #2d1b1b, #3d2b2b); border: 1px solid #8b0000; color: #e8d5d5;">å¯¼å…¥å­˜æ¡£</button>
                      <button id="clearAllSavesBtn" class="interaction-btn" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b0000, #a00000); border: 1px solid #8b0000; color: #e8d5d5;">æ¸…é™¤æ‰€æœ‰å­˜æ¡£</button>
                    <button class="close-rules-btn" id="closeSaveManager">Ã—</button>
                    </div>

                  </div>

                  <div class="rules-modal-body">

                    <!-- æ—§æŒ‰é’®å·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨å­˜æ¡£æ§½ä½æŒ‰é’® -->

                    <div class="save-manager-sections" style="display: flex; flex-direction: column; gap: 20px;">

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                          <h3 class="rules-section-title" style="margin: 0;">ğŸ”„ è‡ªåŠ¨å­˜æ¡£</h3>
                          <label style="display: flex; align-items: center; gap: 8px; color: #e0dcd1; font-size: 14px; cursor: pointer;">
                            <input type="checkbox" id="auto-save-enabled-checkbox" style="width: 18px; height: 18px; cursor: pointer;" checked>
                            <span>å¼€å¯è‡ªåŠ¨å­˜æ¡£</span>
                          </label>
                    </div>

                        <div id="auto-save-slot-container" class="save-manager-list" style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                      <div class="save-manager-section" style="background: rgba(139, 105, 20, 0.05); border: 1px solid rgba(139, 105, 20, 0.2); border-radius: 6px; padding: 15px;">

                        <h3 class="rules-section-title">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</h3>

                        <div id="save-slots-container" class="save-manager-list" style="max-height: 400px; overflow-y: auto; border: 1px solid rgba(139, 105, 20, 0.3); border-radius: 6px; padding: 10px; background: rgba(139, 105, 20, 0.05);"></div>

                      </div>

                    </div>

                  </div>

                </div>

              </div>

            `;

          this.appendModalToCorrectParent(html);

          // ç»‘å®šå…³é—­äº‹ä»¶

          document.getElementById('closeSaveManager').addEventListener('click', () => {
            document.getElementById(modalId).remove();
          });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­

          document.getElementById(modalId).addEventListener('click', e => {
            if (e.target.id === modalId) {
              document.getElementById(modalId).remove();
            }
          });

          // ç»‘å®šæŒ‰é’®äº‹ä»¶

          // å¯¼å…¥å­˜æ¡£æŒ‰é’®
          document.getElementById('importSaveBtn').addEventListener('click', async () => {
            await this.loadSaveFromFile();
          });

          // æ¸…é™¤æ‰€æœ‰å­˜æ¡£æŒ‰é’®
          document.getElementById('clearAllSavesBtn').addEventListener('click', async () => {
            const ok = await this.showFullscreenConfirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­˜æ¡£å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', {
              title: 'æ¸…é™¤æ‰€æœ‰å­˜æ¡£',
              icon: 'ğŸ—‘ï¸',
              confirmText: 'æ¸…é™¤',
              cancelText: 'å–æ¶ˆ',
              danger: true,
            });
            if (!ok) return;
            localStorage.removeItem('teresen_multi_save_data');
            await this.showFullscreenAlert('æ‰€æœ‰å­˜æ¡£å·²æ¸…é™¤ï¼', { title: 'å®Œæˆ', icon: 'âœ…' });
            this.showSaveLoadManager(); // åˆ·æ–°ç•Œé¢
            setTimeout(() => {
              this.bindSaveSlotListeners();
            }, 100);
          });

          // è‡ªåŠ¨å­˜æ¡£å¼€å¯é€‰é¡¹
          const autoSaveCheckbox = document.getElementById('auto-save-enabled-checkbox');
          if (autoSaveCheckbox) {
            // åŠ è½½ä¿å­˜çš„çŠ¶æ€
            const savedState = localStorage.getItem('teresen_auto_save_enabled');
            autoSaveCheckbox.checked = savedState !== 'false'; // é»˜è®¤å¼€å¯

            autoSaveCheckbox.addEventListener('change', e => {
              const isEnabled = e.target.checked;
              localStorage.setItem('teresen_auto_save_enabled', isEnabled.toString());
              this.isAutoSaveEnabled = isEnabled;
              console.log(`è‡ªåŠ¨å­˜æ¡£å·²${isEnabled ? 'å¼€å¯' : 'å…³é—­'}`);
            });

            // åˆå§‹åŒ–çŠ¶æ€
            this.isAutoSaveEnabled = autoSaveCheckbox.checked;
          }

          // åŠ è½½å­˜æ¡£åˆ—è¡¨ï¼ˆæ˜¾ç¤ºå¤šä¸ªå­˜æ¡£æ§½ä½ï¼‰
          this.showSaveLoadManager();

          // ç»‘å®šå­˜æ¡£æ§½ä½æŒ‰é’®äº‹ä»¶
          setTimeout(() => {
            this.bindSaveSlotListeners();
          }, 100);
        }

        // æ–°å¢ï¼šå¯¼å‡ºå½“å‰èŠå¤©è®°å½•å­˜æ¡£
        async exportCurrentChatHistory() {
          try {
            console.log('ğŸ“¤ å¼€å§‹å¯¼å‡ºèŠå¤©è®°å½•...');

            // è·å–å®Œæ•´èŠå¤©å†å²
            const chatHistory = await this.getChatHistory();

            if (!chatHistory || chatHistory.length === 0) {
              alert('æš‚æ— èŠå¤©è®°å½•å¯å¯¼å‡º');
              return;
            }

            // è·å–å½“å‰æ¸¸æˆçŠ¶æ€
            const currentVariables = this.getAllVariables();

            // æ„å»ºå¯¼å‡ºæ•°æ®
            const exportData = {
              exportTime: new Date().toLocaleString('zh-CN'),
              gameTitle: 'ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ',
              version: '2.0',
              totalMessages: chatHistory.length,
              gameState: currentVariables,
              chatHistory: chatHistory.map(msg => ({
                type: msg.is_user || msg.role === 'user' ? 'user' : 'ai',
                time: msg.send_date || (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : ''),
                content: msg.content || msg.mes || msg.message || '',
              })),
            };

            // åˆ›å»ºä¸‹è½½
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ç‰¹é›·æ£®å­¦é™¢æ€ªè°ˆ_èŠå¤©è®°å½•_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('âœ… èŠå¤©è®°å½•å¯¼å‡ºæˆåŠŸ');
            alert('èŠå¤©è®°å½•å¯¼å‡ºæˆåŠŸï¼');
          } catch (error) {
            console.error('âŒ å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥:', error);
            alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
          }
        }

        // æ–°å¢ï¼šä»æ–‡ä»¶è¯»æ¡£
        async loadSaveFromFile() {
          try {
            console.log('ğŸ“ å¼€å§‹ä»æ–‡ä»¶è¯»æ¡£...');

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';

            input.onchange = async event => {
              const file = event.target.files[0];
              if (!file) return;

              try {
                const text = await file.text();
                const saveData = JSON.parse(text);

                // éªŒè¯å­˜æ¡£æ•°æ®ï¼ˆæ”¯æŒæ–°æ ¼å¼å’Œæ—§æ ¼å¼ï¼‰
                if (!saveData.snapshot_data && !saveData.mvu_data && !saveData.gameState) {
                  throw new Error('æ— æ•ˆçš„å­˜æ¡£æ–‡ä»¶ï¼šç¼ºå°‘æ¸¸æˆçŠ¶æ€æ•°æ®');
                }

                // ç¡®è®¤è¯»æ¡£
                const saveName = saveData.save_name || file.name;
                const confirmLoad = await this.showFullscreenConfirm(
                  `ç¡®å®šè¦è¯»å–å­˜æ¡£å—ï¼Ÿ\nå­˜æ¡£åç§°: ${saveName}\nè¿™å°†è¦†ç›–å½“å‰æ¸¸æˆçŠ¶æ€ã€‚`,
                  {
                    title: 'è¯»å–å­˜æ¡£',
                    icon: 'ğŸ“–',
                    confirmText: 'è¯»å–',
                    cancelText: 'å–æ¶ˆ',
                  },
                );
                if (!confirmLoad) return;

                // ğŸ”¥ ä½¿ç”¨loadGameçš„é€»è¾‘æ¥åŠ è½½å­˜æ¡£ï¼ˆæ”¯æŒæ–°æ ¼å¼ï¼‰
                // å¦‚æœæ˜¯æ–°æ ¼å¼ï¼ˆæœ‰timeline_historyï¼‰ï¼Œç›´æ¥è°ƒç”¨loadGame
                if (saveData.timeline_history || saveData.snapshot_data) {
                  // å…ˆä¿å­˜åˆ°ä¸´æ—¶æ§½ä½ï¼Œç„¶ååŠ è½½
                  const allSaves = this.getSavesFromStorage();
                  const tempSlotId = `imported_${Date.now()}`;
                  allSaves[tempSlotId] = saveData;
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));

                  // åŠ è½½å­˜æ¡£
                  await this.loadGame(tempSlotId);

                  // åˆ é™¤ä¸´æ—¶æ§½ä½
                  delete allSaves[tempSlotId];
                  localStorage.setItem('teresen_multi_save_data', JSON.stringify(allSaves));
                } else {
                  // æ—§æ ¼å¼ï¼šç›´æ¥åº”ç”¨å˜é‡
                  const variablesToApply = saveData.mvu_data || saveData.gameState;

                  // ä½¿ç”¨setVariableé€ä¸ªè®¾ç½®å˜é‡
                  if (typeof setVariable === 'function' && variablesToApply) {
                    for (const [key, value] of Object.entries(variablesToApply)) {
                      try {
                        await setVariable(key, value);
                        console.log(`âœ… è®¾ç½®å˜é‡: ${key}`);
                      } catch (e) {
                        console.warn(`âš ï¸ è®¾ç½®å˜é‡å¤±è´¥: ${key}`, e);
                      }
                    }
                  }

                  // æ›´æ–°ç•Œé¢
                  await this.updateInterface();
                }

                console.log('âœ… å­˜æ¡£è¯»å–æˆåŠŸ');
                await this.showFullscreenAlert('å­˜æ¡£è¯»å–æˆåŠŸï¼', { title: 'å®Œæˆ', icon: 'âœ…' });

                // å…³é—­å­˜æ¡£ç®¡ç†å™¨
                const modal = document.getElementById('saveManagerModal');
                if (modal) modal.remove();
              } catch (error) {
                console.error('âŒ è¯»æ¡£å¤±è´¥:', error);
                await this.showFullscreenAlert('è¯»æ¡£å¤±è´¥: ' + error.message, { title: 'è¯»æ¡£å¤±è´¥', icon: 'âŒ' });
              }
            };

            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
          } catch (error) {
            console.error('âŒ åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨å¤±è´¥:', error);
            await this.showFullscreenAlert('è¯»æ¡£åŠŸèƒ½å‡ºé”™: ' + error.message, { title: 'é”™è¯¯', icon: 'âŒ' });
          }
        }

        // æ–°å¢ï¼šåˆ›å»ºå­˜æ¡£ï¼ˆå¸¦æç¤ºï¼‰

        async createSaveWithPrompt() {
          const saveName = prompt('è¯·è¾“å…¥å­˜æ¡£åç§°:');

          if (!saveName) return;

          try {
            const currentVariables = this.getAllVariables();

            const chatMessages = await getChatMessages(0);

            const currentMessage = chatMessages && chatMessages.length > 0 ? chatMessages[0].message : '';

            // è·å–å®Œæ•´èŠå¤©å†å²
            const chatHistory = await this.getChatHistory();

            const timestamp = Date.now();
            const saveData = {
              timestamp: timestamp,
              save_name: saveName,
              mvu_data: currentVariables,
              message_content: currentMessage,
              chat_history: chatHistory,
              user_input: '',
              type: 'manual',
              version: '2.0', // æ ‡è®°ä¸ºæ–°ç‰ˆæœ¬å­˜æ¡£æ ¼å¼
            };

            // ç”Ÿæˆå”¯ä¸€ID

            const saveId = `save_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            localStorage.setItem(`teresen_save_${saveId}`, JSON.stringify(saveData));

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('å­˜æ¡£æˆåŠŸï¼');
            }
          } catch (error) {
            console.error('å­˜æ¡£å¤±è´¥:', error);

            alert('å­˜æ¡£å¤±è´¥ï¼');
          }
        }

        // æ–°å¢ï¼šåŠ è½½å­˜æ¡£åˆ—è¡¨

        loadSaveList() {
          this.loadAutoSaveList();

          this.loadManualSaveList();
        }

        // æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨å­˜æ¡£åˆ—è¡¨

        loadAutoSaveList() {
          const container = document.getElementById('auto-save-container');

          if (!container) return;

          // è·å–æ‰€æœ‰è‡ªåŠ¨å­˜æ¡£

          const autoSaves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen-auto-save-')) {
              try {
                const saveData = JSON.parse(localStorage.getItem(key));

                autoSaves.push({ key, data: saveData });
              } catch (e) {
                console.warn('è§£æè‡ªåŠ¨å­˜æ¡£å¤±è´¥:', key, e);
              }
            }
          }

          // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰

          autoSaves.sort((a, b) => b.data.timestamp - a.data.timestamp);

          // åªæ˜¾ç¤ºæœ€è¿‘5ä¸ª

          const recentSaves = autoSaves.slice(0, 5);

          let html = '';

          if (recentSaves.length > 0) {
            html = recentSaves

              .map((save, index) => {
                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();

                return `

                <div class="save-manager-item save-manager-auto-item" style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #22c55e; font-size: 16px;">ğŸ”„</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">è‡ªåŠ¨å­˜æ¡£ #${index + 1}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'æ— æ­£æ–‡è®°å½•'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end;">

                    <button class="save-button" onclick="n.loadAutoSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ“–</span>

                      <span>è¯»æ¡£</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('auto', '${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ‘ï¸</span>

                      <span>è¯¦æƒ…</span>

                    </button>

                  </div>

                </div>

              `;
              })

              .join('');
          } else {
            html =
              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">æš‚æ— è‡ªåŠ¨å­˜æ¡£</div>';
          }

          container.innerHTML = html;
        }

        // æ–°å¢ï¼šåŠ è½½æ‰‹åŠ¨å­˜æ¡£åˆ—è¡¨

        loadManualSaveList() {
          const container = document.getElementById('manual-save-container');

          if (!container) return;

          const saves = [];

          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);

            if (key && key.startsWith('teresen_save_')) {
              try {
                const saveData = JSON.parse(localStorage.getItem(key));

                saves.push({ key, data: saveData });
              } catch (e) {
                console.warn('è§£æå­˜æ¡£å¤±è´¥:', key, e);
              }
            }
          }

          // æŒ‰æ—¶é—´æ’åº

          saves.sort((a, b) => b.data.timestamp - a.data.timestamp);

          let html = '';

          if (saves.length > 0) {
            html = saves

              .map(save => {
                const date = new Date(save.data.timestamp).toLocaleString('zh-CN');

                const summary = this._getDisplayText(save.data.message_content)

                  .replace(/[\n\r]+/g, ' ')

                  .trim();

                return `

                <div class="save-manager-item save-manager-manual-item" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 12px; margin-bottom: 8px; transition: all 0.2s;">

                  <div class="save-manager-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">

                    <div class="save-manager-title" style="display: flex; align-items: center; gap: 8px;">

                      <span style="color: #3b82f6; font-size: 16px;">ğŸ’¾</span>

                      <span style="font-weight: bold; color: #ffffff; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${save.data.save_name}</span>

                    </div>

                    <div class="save-manager-time" style="color: #ffffff; font-size: 11px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${date}</div>

                  </div>

                  <div class="save-manager-content" style="margin-bottom: 10px;">

                    <div class="save-manager-summary" style="color: #ffffff; font-size: 12px; line-height: 1.4; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; max-height: 60px; overflow: hidden; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">

                      ${summary ? summary : 'æ— æ­£æ–‡è®°å½•'}

                    </div>

                  </div>

                  <div class="save-manager-actions" style="display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap;">

                    <button class="save-button" onclick="n.loadManualSave('${save.key}')" style="background: linear-gradient(135deg, #22c55e, #16a34a); border: 1px solid #22c55e; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ“–</span>

                      <span>è¯»æ¡£</span>

                    </button>

                    <button class="save-button" onclick="n.renameSave('${save.key}', '${save.data.save_name}')" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: 1px solid #f59e0b; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">âœï¸</span>

                      <span>é‡å‘½å</span>

                    </button>

                    <button class="save-button" onclick="n.viewSaveDetails('manual', '${save.key}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: 1px solid #3b82f6; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ‘ï¸</span>

                      <span>è¯¦æƒ…</span>

                    </button>

                    <button class="save-button" onclick="n.deleteManualSave('${save.key}')" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: 1px solid #ef4444; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">

                      <span style="font-size: 14px;">ğŸ—‘ï¸</span>

                      <span>åˆ é™¤</span>

                    </button>

                  </div>

                </div>

              `;
              })

              .join('');
          } else {
            html =
              '<div class="save-manager-empty" style="text-align: center; color: #8b4513; padding: 1rem; font-size: 0.875rem; font-style: italic;">æš‚æ— æ‰‹åŠ¨å­˜æ¡£</div>';
          }

          container.innerHTML = html;
        }

        // æ–°å¢ï¼šåŠ è½½è‡ªåŠ¨å­˜æ¡£

        async loadAutoSave() {
          try {
            const autoSaveData = localStorage.getItem('teresen_auto_save');

            if (!autoSaveData) {
              alert('æ²¡æœ‰è‡ªåŠ¨å­˜æ¡£ï¼');

              return;
            }

            const saveData = JSON.parse(autoSaveData);

            await this.restoreSaveData(saveData);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('è‡ªåŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼');
            }

            document.getElementById('saveManagerModal').remove();
          } catch (error) {
            console.error('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('åŠ è½½è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼');
            }
          }
        }

        // æ–°å¢ï¼šåŠ è½½æ‰‹åŠ¨å­˜æ¡£

        async loadManualSave(saveKey) {
          try {
            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('å­˜æ¡£ä¸å­˜åœ¨ï¼');
              }

              return;
            }

            const saveData = JSON.parse(savedData);

            await this.restoreSaveData(saveData);

            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('æ‰‹åŠ¨å­˜æ¡£åŠ è½½æˆåŠŸï¼');
            }

            document.getElementById('saveManagerModal').remove();
          } catch (error) {
            console.error('åŠ è½½æ‰‹åŠ¨å­˜æ¡£å¤±è´¥:', error);

            alert('åŠ è½½æ‰‹åŠ¨å­˜æ¡£å¤±è´¥ï¼');
          }
        }

        // æ–°å¢ï¼šåˆ é™¤æ‰‹åŠ¨å­˜æ¡£

        async deleteManualSave(saveKey) {
          const ok = await this.showFullscreenConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ', {
            title: 'åˆ é™¤å­˜æ¡£',
            icon: 'ğŸ—‘ï¸',
            confirmText: 'åˆ é™¤',
            cancelText: 'å–æ¶ˆ',
            danger: true,
          });
          if (!ok) return;

          try {
            localStorage.removeItem(saveKey);

            await this.showFullscreenAlert('åˆ é™¤æˆåŠŸï¼', { title: 'å®Œæˆ', icon: 'âœ…' });

            this.loadManualSaveList();
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);

            await this.showFullscreenAlert('åˆ é™¤å¤±è´¥ï¼', { title: 'é”™è¯¯', icon: 'âŒ' });
          }
        }

        // æ–°å¢ï¼šæ¢å¤å­˜æ¡£æ•°æ®çš„é€šç”¨æ–¹æ³•

        async restoreSaveData(saveData) {
          console.log('ğŸ”„ å¼€å§‹æ¢å¤å­˜æ¡£æ•°æ®...', saveData);

          // æ¢å¤å˜é‡çŠ¶æ€

          if (saveData.mvu_data) {
            // ç›´æ¥è®¾ç½®å˜é‡ï¼Œä¸è°ƒç”¨MVU

            this.currentMvuState = saveData.mvu_data;

            this.renderUI(this.currentMvuState.stat_data);

            console.log('âœ… æ¸¸æˆçŠ¶æ€å·²æ¢å¤');
          }

          // ğŸ”¥ æ¢å¤å®Œæ•´èŠå¤©å†å²ï¼ˆä¼˜å…ˆä½¿ç”¨æ–°æ ¼å¼ï¼‰

          if (saveData.chat_history && Array.isArray(saveData.chat_history) && saveData.chat_history.length > 0) {
            console.log('ğŸ”„ æ¢å¤å®Œæ•´èŠå¤©å†å² (' + saveData.chat_history.length + ' æ¡æ¶ˆæ¯)...');

            if (
              'function' == typeof getChatMessages &&
              'undefined' != typeof TavernHelper &&
              TavernHelper.setChatMessages
            ) {
              // æ¢å¤æ‰€æœ‰èŠå¤©æ¶ˆæ¯ï¼Œä¿æŒå†å²è®°å½•çš„å®Œæ•´æ€§

              await TavernHelper.setChatMessages(saveData.chat_history, { refresh: 'none' });

              console.log('âœ… å®Œæ•´èŠå¤©å†å²å·²æ¢å¤ (' + saveData.chat_history.length + ' æ¡æ¶ˆæ¯)');
            }
          }

          // å…¼å®¹æ—§ç‰ˆæœ¬æ ¼å¼
          else if (saveData.message_content) {
            console.log('âš ï¸ ä½¿ç”¨æ—§ç‰ˆå­˜æ¡£æ ¼å¼ï¼Œåªæ¢å¤å•æ¡æ¶ˆæ¯');

            const chatMessages = await getChatMessages(0);

            if (chatMessages && chatMessages.length > 0) {
              const firstMessage = chatMessages[0];

              // ğŸ”¥ æ¢å¤æ¶ˆæ¯åˆ°extra.teresen_chatï¼Œè€Œä¸æ˜¯0å±‚æ¶ˆæ¯çš„messageå­—æ®µ
              if (!firstMessage.extra) {
                firstMessage.extra = {};
              }
              firstMessage.extra.teresen_chat = [
                {
                  role: 'assistant',
                  content: saveData.message_content || '',
                  id: 'load_' + Date.now(),
                  timestamp: Date.now(),
                  variableState: saveData.mvu_data || null,
                },
              ];

              // åªæ›´æ–°dataå­—æ®µï¼Œä¸æ›´æ–°messageå­—æ®µ
              firstMessage.data = saveData.mvu_data;

              if (typeof SillyTavern !== 'undefined' && SillyTavern.saveChat) {
                await SillyTavern.saveChat();
                console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæ—§ç‰ˆæ ¼å¼ï¼‰');
              } else {
                await TavernHelper.setChatMessages([firstMessage], { refresh: 'none' });
                console.log('âœ… å•æ¡æ¶ˆæ¯å·²æ¢å¤åˆ°extra.teresen_chatï¼ˆæœªæ›´æ–°messageå­—æ®µï¼‰');
              }
            }
          }

          // æ›´æ–°ç•Œé¢

          await this.updateDynamicData();

          console.log('âœ… å­˜æ¡£æ•°æ®æ¢å¤å®Œæˆ');
        }

        // æ–°å¢ï¼šæŸ¥çœ‹å­˜æ¡£è¯¦æƒ…

        async viewSaveDetails(type, saveKey = null) {
          try {
            let saveData;

            if (type === 'auto') {
              // å¯¹äºè‡ªåŠ¨å­˜æ¡£ï¼Œå¦‚æœæä¾›äº†saveKeyï¼Œä½¿ç”¨saveKeyï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„è‡ªåŠ¨å­˜æ¡£
              if (saveKey && saveKey.startsWith('teresen-auto-save-')) {
                const savedData = localStorage.getItem(saveKey);
                if (!savedData) {
                  alert('è‡ªåŠ¨å­˜æ¡£ä¸å­˜åœ¨ï¼');
                  return;
                }
                saveData = JSON.parse(savedData);
              } else {
                const autoSaveData = localStorage.getItem('teresen_auto_save');
                if (!autoSaveData) {
                  alert('æ²¡æœ‰è‡ªåŠ¨å­˜æ¡£ï¼');
                  return;
                }
                saveData = JSON.parse(autoSaveData);
              }
            } else {
              const savedData = localStorage.getItem(saveKey);
              if (!savedData) {
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('å­˜æ¡£ä¸å­˜åœ¨ï¼');
                }
                return;
              }
              saveData = JSON.parse(savedData);
            }

            const date = new Date(saveData.timestamp).toLocaleString('zh-CN');

            const summary = this._getDisplayText(saveData.message_content);

            // ğŸ”¥ è·å–èŠå¤©å†å²è¯¦ç»†ä¿¡æ¯

            let chatHistoryInfo = '';

            let contentToShow = summary || 'æ— å†…å®¹';

            if (saveData.chat_history && Array.isArray(saveData.chat_history)) {
              chatHistoryInfo = `

                <div style="margin-bottom: 10px;">

                  <strong style="color: #e0e0e0;">ğŸ’­ èŠå¤©è®°å½•:</strong> 

                  <span style="color: #c0c0c0;">${saveData.chat_history.length} æ¡æ¶ˆæ¯</span>

                </div>

              `;

              // æ˜¾ç¤ºå®Œæ•´çš„èŠå¤©å†å²

              contentToShow = saveData.chat_history
                .map((msg, index) => {
                  const msgText = typeof msg === 'string' ? msg : msg.message || msg.content || JSON.stringify(msg);

                  return `[${index + 1}] ${msgText}`;
                })
                .join('\n\n');
            } else if (saveData.message_content) {
              chatHistoryInfo = `

                <div style="margin-bottom: 10px;">

                  <strong style="color: #e0e0e0;">ğŸ’­ èŠå¤©è®°å½•:</strong> 

                  <span style="color: #c0c0c0;">1 æ¡æ¶ˆæ¯ï¼ˆæ—§æ ¼å¼ï¼‰</span>

                </div>

              `;
            }

            // ğŸ”¥ é‡æ–°è®¾è®¡å­˜æ¡£è¯¦æƒ…çš„å†…å®¹ç»“æ„ï¼Œå»æ‰å¤šä½™çš„å®¹å™¨

            const detailsContent = `

                <div style="background: rgba(139, 69, 19, 0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(139, 69, 19, 0.4);">

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">ğŸ“ å­˜æ¡£åç§°:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${saveData.save_name || 'è‡ªåŠ¨å­˜æ¡£'}</span>

                  </div>

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">ğŸ• ä¿å­˜æ—¶é—´:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${date}</span>

                  </div>

                  <div style="margin-bottom: 15px;">

                    <strong style="color: #e0e0e0; font-size: 14px;">ğŸ·ï¸ å­˜æ¡£ç±»å‹:</strong> 

                    <span style="color: #c0c0c0; margin-left: 8px;">${type === 'auto' ? 'è‡ªåŠ¨å­˜æ¡£' : 'æ‰‹åŠ¨å­˜æ¡£'}</span>

                  </div>

                  ${chatHistoryInfo}

                </div>

                <div style="background: rgba(139, 69, 19, 0.15); padding: 20px; border-radius: 8px; border: 1px solid rgba(139, 69, 19, 0.4);">

                  <strong style="color: #e0e0e0; display: block; margin-bottom: 15px; font-size: 14px;">ğŸ’¬ å¯¹è¯å†…å®¹:</strong>

                  <textarea readonly style="width: 100%; box-sizing: border-box; height: 300px; color: #c0c0c0; line-height: 1.5; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 6px; font-size: 13px; border: 1px solid rgba(139, 105, 20, 0.3); resize: none; scrollbar-width: thin; scrollbar-color: #8b4513 rgba(0,0,0,0.3); font-family: inherit;">${contentToShow}</textarea>

                </div>

            `;

            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ¥æ˜¾ç¤ºè¯¦æƒ…ï¼Œè€Œä¸æ˜¯ç”¨alert

            const detailModalId = 'saveDetailModal';

            if (document.getElementById(detailModalId)) {
              document.getElementById(detailModalId).remove();
            }

            const detailModalHtml = `

              <div id="${detailModalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10001; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px);">

                <div style="max-width: 600px; width: 90%; max-height: 80vh; background: linear-gradient(135deg, #1a1a1a, #2d1b1b); border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7); overflow: hidden; border: 2px solid #8b4513;">

                  <div style="background: linear-gradient(135deg, #2d1b1b, #3d2b2b); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #8b4513; position: sticky; top: 0; z-index: 1;">

                    <h2 style="color: #e0e0e0; margin: 0; font-size: 18px; font-weight: bold;">ğŸ“‹ å­˜æ¡£è¯¦æƒ…</h2>

                    <button onclick="document.getElementById('${detailModalId}').remove()" style="background: #8b0000; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" onmouseover="this.style.background='#a00000'" onmouseout="this.style.background='#8b0000'">Ã—</button>

                  </div>

                  <div id="${detailModalId}_content" style="padding: 25px; overflow-y: auto; max-height: calc(80vh - 80px); color: #e0e0e0; scrollbar-width: thin; scrollbar-color: #8b4513 rgba(0,0,0,0.3);">

                    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->

                  </div>

                </div>

              </div>

            `;

            this.appendModalToCorrectParent(detailModalHtml);

            // åŠ¨æ€è®¾ç½®å†…å®¹ï¼Œé¿å…å­—ç¬¦é™åˆ¶

            const contentDiv = document.getElementById(detailModalId + '_content');

            contentDiv.innerHTML = detailsContent;

            // ğŸ”¥ æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼

            const scrollStyle = document.createElement('style');

            scrollStyle.textContent = `

              #${detailModalId} *::-webkit-scrollbar {

                width: 8px;

                height: 8px;

              }

              #${detailModalId} *::-webkit-scrollbar-track {

                background: rgba(0, 0, 0, 0.3);

                border-radius: 4px;

              }

              #${detailModalId} *::-webkit-scrollbar-thumb {

                background: #8b4513;

                border-radius: 4px;

                border: 1px solid rgba(0, 0, 0, 0.2);

              }

              #${detailModalId} *::-webkit-scrollbar-thumb:hover {

                background: #a0522d;

              }

              #${detailModalId} *::-webkit-scrollbar-corner {

                background: rgba(0, 0, 0, 0.3);

              }

            `;

            document.head.appendChild(scrollStyle);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­

            document.getElementById(detailModalId).addEventListener('click', e => {
              if (e.target.id === detailModalId) {
                document.getElementById(detailModalId).remove();

                // æ¸…ç†æ ·å¼

                if (scrollStyle && scrollStyle.parentNode) {
                  scrollStyle.parentNode.removeChild(scrollStyle);
                }
              }
            });

            // ğŸ”¥ ç¡®ä¿å…³é—­æŒ‰é’®ä¹Ÿæ¸…ç†æ ·å¼

            const closeBtn = document.querySelector(`#${detailModalId} button`);

            if (closeBtn) {
              const originalOnClick = closeBtn.onclick;

              closeBtn.onclick = function () {
                // æ¸…ç†æ ·å¼

                if (scrollStyle && scrollStyle.parentNode) {
                  scrollStyle.parentNode.removeChild(scrollStyle);
                }

                originalOnClick.call(this);
              };
            }
          } catch (error) {
            console.error('æŸ¥çœ‹å­˜æ¡£è¯¦æƒ…å¤±è´¥:', error);

            alert('æŸ¥çœ‹å­˜æ¡£è¯¦æƒ…å¤±è´¥ï¼');
          }
        }

        // æ–°å¢ï¼šé‡å‘½åå­˜æ¡£

        async renameSave(saveKey, currentName) {
          try {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„å­˜æ¡£åç§°:', currentName);

            if (!newName || newName === currentName) return;

            const savedData = localStorage.getItem(saveKey);

            if (!savedData) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('å­˜æ¡£ä¸å­˜åœ¨ï¼');
              }

              return;
            }

            const saveData = JSON.parse(savedData);

            saveData.save_name = newName;

            localStorage.setItem(saveKey, JSON.stringify(saveData));

            alert('é‡å‘½åæˆåŠŸï¼');

            // åˆ·æ–°åˆ—è¡¨

            this.loadSaveList();
          } catch (error) {
            console.error('é‡å‘½åå­˜æ¡£å¤±è´¥:', error);

            alert('é‡å‘½åå¤±è´¥ï¼');
          }
        }

        // æ–°å¢ï¼šè·å–æ˜¾ç¤ºæ–‡æœ¬çš„è¾…åŠ©æ–¹æ³•

        _getDisplayText(text) {
          if (!text) return '';

          // ç§»é™¤HTMLæ ‡ç­¾

          let cleanText = text.replace(/<[^>]*>/g, '');

          // ç§»é™¤å¤šä½™çš„ç©ºç™½å­—ç¬¦

          cleanText = cleanText.replace(/\s+/g, ' ').trim();

          // é™åˆ¶é•¿åº¦

          if (cleanText.length > 200) {
            cleanText = cleanText.substring(0, 200) + '...';
          }

          return cleanText;
        }

        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆAIå›ç­”

        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆAIå›ç­” - å…ˆè¿”å›ä¸Šä¸€æ­¥ï¼Œç„¶åé‡æ–°å‘é€
        async performReroll() {
          try {
            // ğŸ”¥ ç¬¬ä¸€æ­¥ï¼šåˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯ï¼ˆå‚è€ƒè¿”å›ä¸Šä¸€æ­¥çš„é€»è¾‘ï¼‰
            const chatHistory = await this.loadChatHistoryFromExtra();

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¼€å±€ï¼‰
            if (chatHistory.length <= 1) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('å¼€å±€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ');
              }
              return;
            }

            // æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦æ˜¯AIå›å¤
            const lastMessage = chatHistory[chatHistory.length - 1];
            if (lastMessage.role !== 'assistant') {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('æœ€åä¸€æ¡æ¶ˆæ¯ä¸æ˜¯AIå›å¤ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ');
              }
              return;
            }

            // æ‰¾åˆ°ä¸Šä¸€æ¡ç”¨æˆ·è¾“å…¥
            let lastUserInput = null;
            for (let i = chatHistory.length - 2; i >= 0; i--) {
              if (chatHistory[i].role === 'user') {
                lastUserInput = chatHistory[i].content;
                break;
              }
            }

            if (!lastUserInput) {
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage('æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€æ¬¡çš„ç”¨æˆ·è¾“å…¥');
              }
              return;
            }

            // åˆ é™¤æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆAIå›å¤ï¼‰
            const updatedHistory = chatHistory.slice(0, -1);

            // ğŸ”¥ è°ƒç”¨_syncStateWithHistoryåŒæ­¥å˜é‡çŠ¶æ€ï¼ˆä»åˆ é™¤åçš„æœ€åä¸€æ¡æ¶ˆæ¯è·å–variableStateï¼‰
            await this._syncStateWithHistory(updatedHistory);

            // æ›´æ–°UI
            const newLastMessage = updatedHistory[updatedHistory.length - 1];
            if (newLastMessage && newLastMessage.variableState) {
              this.currentMvuState = JSON.parse(JSON.stringify(newLastMessage.variableState));
              if (newLastMessage.variableState.stat_data) {
                this.renderUI(newLastMessage.variableState.stat_data);
              }
            }

            // å¼ºåˆ¶æ›´æ–°ç•Œé¢
            await this.updateInterface();

            // ğŸ”¥ ç¬¬äºŒæ­¥ï¼šé‡æ–°å‘é€ä¸Šä¸€æ¬¡ç”¨æˆ·è¾“å…¥
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              // æå–ç”¨æˆ·è¾“å…¥å†…å®¹ï¼ˆå¦‚æœæœ‰contentæ ‡ç­¾ï¼Œæå–æ ‡ç­¾å†…å®¹ï¼‰
              let userInputContent = lastUserInput;
              const contentMatch = lastUserInput.match(/<content>([\s\S]*?)<\/content>/s);
              if (contentMatch) {
                userInputContent = contentMatch[1].trim();
              }
              actionInput.value = userInputContent;
            }

            // é‡æ–°æäº¤
            await this.handleActionSubmit();

            console.log('âœ… é‡æ–°ç”Ÿæˆå·²è§¦å‘');
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('æ­£åœ¨é‡æ–°ç”ŸæˆAIå›ç­”...');
            }
          } catch (error) {
            console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
            }
          }
        }

        // ğŸ”¥ è®¾ç½®æ•…äº‹æ–‡æœ¬æ“ä½œæŒ‰é’®äº‹ä»¶
        setupStoryActionButtons() {
          // æ€»ç»“æŒ‰é’®
          const btnSummary = document.getElementById('btn-summary');
          if (btnSummary) {
            btnSummary.addEventListener('click', async () => {
              // è°ƒç”¨Tavern Helperçš„æ€»ç»“åŠŸèƒ½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.summarizeChat) {
                window.TavernHelper.summarizeChat();
              } else {
                console.log('ğŸ“ æ€»ç»“åŠŸèƒ½æš‚æœªå®ç°');
                // ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—æ›¿ä»£alert
                if (window.teresenDebug && typeof window.teresenDebug.showFullscreenAlert === 'function') {
                  await window.teresenDebug.showFullscreenAlert('æ€»ç»“åŠŸèƒ½æš‚æœªå®ç°', { title: 'æç¤º', icon: 'ğŸ“' });
                } else if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('æ€»ç»“åŠŸèƒ½æš‚æœªå®ç°');
                } else {
                  alert('æ€»ç»“åŠŸèƒ½æš‚æœªå®ç°');
                }
              }
            });
          }

          // ğŸ”¥ è¿”å›æŒ‰é’® - åˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯å¹¶å›é€€å˜é‡çŠ¶æ€
          const btnBack = document.getElementById('btn-back');
          if (btnBack) {
            // åˆå§‹æ£€æŸ¥å¹¶è®¾ç½®æŒ‰é’®çŠ¶æ€
            this.updateBackRerollButtonsState();

            btnBack.addEventListener('click', async () => {
              try {
                // ä»extra.teresen_chatåŠ è½½å®Œæ•´å†å²
                const chatHistory = await this.loadChatHistoryFromExtra();

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¼€å±€ï¼‰
                if (chatHistory.length <= 1) {
                  if (typeof showTemporaryMessage === 'function') {
                    showTemporaryMessage('å¼€å±€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ— æ³•è¿”å›');
                  }
                  return;
                }

                // åˆ é™¤æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆAIå›å¤ï¼‰
                const updatedHistory = chatHistory.slice(0, -1);

                // ğŸ”¥ è°ƒç”¨_syncStateWithHistoryåŒæ­¥å˜é‡çŠ¶æ€ï¼ˆä»åˆ é™¤åçš„æœ€åä¸€æ¡æ¶ˆæ¯è·å–variableStateï¼‰
                await this._syncStateWithHistory(updatedHistory);

                // æ›´æ–°UI
                const lastMessage = updatedHistory[updatedHistory.length - 1];
                if (lastMessage && lastMessage.variableState) {
                  this.currentMvuState = JSON.parse(JSON.stringify(lastMessage.variableState));
                  if (lastMessage.variableState.stat_data) {
                    this.renderUI(lastMessage.variableState.stat_data);
                  }
                }

                // å¼ºåˆ¶æ›´æ–°ç•Œé¢ï¼ˆåŒ…æ‹¬æŒ‰é’®çŠ¶æ€ï¼‰
                await this.updateInterface();

                console.log('âœ… å·²è¿”å›ä¸Šä¸€æ­¥ï¼Œåˆ é™¤æœ€åä¸€æ¡AIæ¶ˆæ¯');
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('å·²è¿”å›ä¸Šä¸€æ­¥');
                }
              } catch (error) {
                console.error('è¿”å›å¤±è´¥:', error);
                if (typeof showTemporaryMessage === 'function') {
                  showTemporaryMessage('è¿”å›å¤±è´¥ï¼š' + error.message);
                }
              }
            });
          }

          // é‡æ–°ç”ŸæˆæŒ‰é’®
          const btnReroll = document.getElementById('btn-reroll');
          if (btnReroll) {
            btnReroll.addEventListener('click', async () => {
              await this.performReroll();
            });
          }
        }

        /**
         * ğŸ”¥ æ›´æ–°è¿”å›å’Œé‡æ–°ç”ŸæˆæŒ‰é’®çš„çŠ¶æ€ï¼ˆæ ¹æ®èŠå¤©å†å²é•¿åº¦ï¼‰
         */
        async updateBackRerollButtonsState() {
          try {
            const chatHistory = await this.loadChatHistoryFromExtra();
            const btnBack = document.getElementById('btn-back');
            const btnReroll = document.getElementById('btn-reroll');

            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¼€å±€ï¼‰ï¼Œç¦ç”¨æŒ‰é’®
            const isFirstMessage = chatHistory.length <= 1;

            if (btnBack) {
              if (isFirstMessage) {
                btnBack.disabled = true;
                btnBack.style.opacity = '0.5';
                btnBack.style.cursor = 'not-allowed';
                btnBack.title = 'å¼€å±€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ— æ³•è¿”å›';
              } else {
                btnBack.disabled = false;
                btnBack.style.opacity = '1';
                btnBack.style.cursor = 'pointer';
                btnBack.title = 'è¿”å›';
              }
            }

            if (btnReroll) {
              if (isFirstMessage) {
                btnReroll.disabled = true;
                btnReroll.style.opacity = '0.5';
                btnReroll.style.cursor = 'not-allowed';
                btnReroll.title = 'å¼€å±€ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆ';
              } else {
                btnReroll.disabled = false;
                btnReroll.style.opacity = '1';
                btnReroll.style.cursor = 'pointer';
                btnReroll.title = 'é‡æ–°ç”Ÿæˆ';
              }
            }
          } catch (error) {
            console.error('æ›´æ–°æŒ‰é’®çŠ¶æ€å¤±è´¥:', error);
          }
        }
      })();

      if ('undefined' != typeof eventOn && void 0 !== window.tavern_events) {
        const e = window.tavern_events;

        eventOn(e.APP_READY, () => {
          (console.log('ğŸ¯ é…’é¦†ç¯å¢ƒå°±ç»ªï¼Œå¼€å§‹åˆå§‹åŒ–ç‰¹é›·æ£®ç•Œé¢...'),
            n.init(),
            setTimeout(() => n.initSexPositionSection(), 100));
        });
      } else
        (console.warn('âš ï¸ é…’é¦†äº‹ä»¶APIä¸å¯ç”¨ï¼Œä½¿ç”¨ä¼ ç»Ÿåˆå§‹åŒ–æ–¹å¼'),
          setTimeout(() => {
            n.init();
          }, 2e3));
    </script>

    <script>
      // ç§»åŠ¨ç«¯æ£€æµ‹å’Œè‡ªåŠ¨é€‚é…ç³»ç»Ÿ
      class MobileDetector {
        constructor() {
          this.isMobile = this.detectMobile();
          this.init();
        }

        detectMobile() {
          const userAgent = navigator.userAgent.toLowerCase();
          const mobileKeywords = [
            'mobile',
            'android',
            'iphone',
            'ipad',
            'ipod',
            'blackberry',
            'windows phone',
            'opera mini',
          ];

          // æ£€æŸ¥User-Agentæ˜¯å¦åŒ…å«ç§»åŠ¨è®¾å¤‡å…³é”®è¯
          const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));

          // æ£€æŸ¥å±å¹•å®½åº¦
          const isSmallScreen = window.innerWidth <= 768;

          // æ£€æŸ¥è§¦æ‘¸æ”¯æŒ
          const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

          console.log('ğŸ” è®¾å¤‡æ£€æµ‹ç»“æœ:', {
            userAgent: userAgent,
            isMobileUA: isMobileUA,
            screenWidth: window.innerWidth,
            isSmallScreen: isSmallScreen,
            isTouchDevice: isTouchDevice,
          });

          return isMobileUA || (isSmallScreen && isTouchDevice);
        }

        init() {
          if (this.isMobile) {
            console.log('ğŸ“± æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œå¯ç”¨ç§»åŠ¨ç«¯é€‚é…');
            console.log('ğŸ¯ ç§»åŠ¨ç«¯å¸ƒå±€ï¼šæ–‡æœ¬å†…å®¹ â†’ é©¬å¨˜å¡ç‰‡ â†’ å…¶ä»–åŠŸèƒ½');
            document.documentElement.classList.add('mobile-device');
            document.documentElement.classList.remove('desktop-device');
            this.applyMobileStyles();
            this.addMobileLayoutIndicator();
          } else {
            console.log('ğŸ’» æ£€æµ‹åˆ°æ¡Œé¢è®¾å¤‡ï¼Œä½¿ç”¨é»˜è®¤æ ·å¼');
            document.documentElement.classList.add('desktop-device');
            document.documentElement.classList.remove('mobile-device');
            this.removeMobileLayoutIndicator();
          }

          // ç›‘å¬çª—å£å¤§å°å˜åŒ–
          let resizeTimeout;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
              const newIsMobile = this.detectMobile();
              if (newIsMobile !== this.isMobile) {
                console.log(
                  `ğŸ”„ è®¾å¤‡ç±»å‹å˜åŒ–: ${this.isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'} â†’ ${newIsMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}`,
                );
                this.isMobile = newIsMobile;
                location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°çš„æ ·å¼
              }
            }, 300); // é˜²æŠ–å¤„ç†
          });
        }

        addMobileLayoutIndicator() {
          // æ·»åŠ ç§»åŠ¨ç«¯å¸ƒå±€æŒ‡ç¤ºå™¨
          const indicator = document.createElement('div');
          indicator.id = 'mobile-layout-indicator';
          indicator.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            font-family: system-ui, -apple-system, sans-serif;
          `;
          indicator.textContent = 'ğŸ“± ç§»åŠ¨ç«¯æ¨¡å¼';
          document.body.appendChild(indicator);

          // 3ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            if (indicator && indicator.parentNode) {
              indicator.style.opacity = '0';
              indicator.style.transition = 'opacity 0.5s';
              setTimeout(() => {
                if (indicator.parentNode) {
                  indicator.parentNode.removeChild(indicator);
                }
              }, 500);
            }
          }, 3000);
        }

        removeMobileLayoutIndicator() {
          const indicator = document.getElementById('mobile-layout-indicator');
          if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
          }
        }

        applyMobileStyles() {
          // åˆ›å»ºç§»åŠ¨ç«¯æ ·å¼
          const mobileStyles = `
            <style id="mobile-adaptive-styles">
              /* ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ */
              .mobile-device {
                font-size: 26px;
              }
              
              /* ç§»åŠ¨ç«¯ä¸‰è¡Œå¸ƒå±€ - æ ¸å¿ƒå¸ƒå±€é‡æ„ */
              .mobile-device .connected-panels {
                display: flex !important;
                flex-direction: column !important;
                grid-template-columns: none !important;
                grid-template-rows: none !important;
                height: auto !important;
                min-height: 100vh !important;
                max-width: 100% !important;
                width: 100% !important;
                gap: 1px !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                box-sizing: border-box !important;
              }
              
              /* ç§»åŠ¨ç«¯é¢æ¿é¡ºåºå’Œæ ·å¼ */
              .mobile-device .center-panel {
                order: 1 !important;
                width: 100% !important;
                margin-bottom: 0 !important;
                min-height: 400px !important;
              }
              
              .mobile-device .left-panel {
                order: 2 !important;
                width: 100% !important;
                margin-bottom: 0 !important;
                grid-area: unset !important;
                position: relative !important;
              }
              
              .mobile-device .right-panel {
                order: 3 !important;
                width: 100% !important;
                grid-area: unset !important;
              }
              
              /* ç§»åŠ¨ç«¯é¢æ¿å†…å®¹ä¼˜åŒ– */
              .mobile-device .panel-content {
                padding: 5px !important;
                max-height: none !important;
                overflow: visible !important;
              }
              
              /* ç§»åŠ¨ç«¯åˆ†éš”çº¿éšè— */
              .mobile-device .panel-divider {
                display: none !important;
              }
              
              /* ç§»åŠ¨ç«¯è®­ç»ƒå‘˜ä¿¡æ¯ä¼˜åŒ– */
              .mobile-device .character-panel {
                width: 100% !important;
                max-width: none !important;
                margin-bottom: 20px !important;
              }
              
              .mobile-device .character-info {
                flex-direction: column !important;
                gap: 8px !important;
              }
              
              .mobile-device .character-avatar {
                width: 80px !important;
                height: 80px !important;
              }
              
              .mobile-device .character-stats {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
                display: flex !important;
                flex-direction: column !important;
              }
              
              /* ç§»åŠ¨ç«¯çŠ¶æ€æ å¸ƒå±€ - æ¯è¡Œä¸€ä¸ªçŠ¶æ€ */
              .mobile-device .character-stats .stat-item,
              .mobile-device .character-stats .currency-section {
                width: 100% !important;
                margin-bottom: 0 !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 10px 12px !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(139, 105, 20, 0.3) !important;
                border-radius: 6px !important;
                font-size: 14px !important;
              }
              
              /* ç§»åŠ¨ç«¯æŒ‰é’®ç»„ä¼˜åŒ– */
              .mobile-device .action-buttons {
                flex-direction: column !important;
                gap: 4px !important;
              }
              
              .mobile-device .action-button {
                width: 100% !important;
                padding: 8px !important;
                font-size: 16px !important;
              }
              
              /* ç§»åŠ¨ç«¯çŠ¶æ€æ•ˆæœä¼˜åŒ– */
              .mobile-device .status-effects {
                grid-template-columns: repeat(2, 1fr) !important;
              }
              
              /* ç§»åŠ¨ç«¯ç‰©å“æ ä¼˜åŒ– */
              .mobile-device .inventory-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
              }
              
              /* ç§»åŠ¨ç«¯èŠå¤©å®¹å™¨ä¼˜åŒ– */
              .mobile-device .chat-container {
                height: 300px !important;
              }
              
              /* ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
              .mobile-device .input-area {
                flex-direction: column !important;
                gap: 10px !important;
              }
              
              .mobile-device .input-area input,
              .mobile-device .input-area textarea {
                width: 100% !important;
                margin-bottom: 10px !important;
                box-sizing: border-box !important;
              }
              
              .mobile-device .input-area button {
                width: 100% !important;
                padding: 12px !important;
              }
              
              /* ç§»åŠ¨ç«¯è¾“å…¥æ§åˆ¶åŒºåŸŸ */
              .mobile-device .input-controls {
                display: flex !important;
                flex-direction: row !important;
                gap: 0 !important;
                flex-shrink: 0 !important;
              }
              
              /* ç§»åŠ¨ç«¯æ•…äº‹å†…å®¹åŒºåŸŸä¼˜åŒ– */
              .mobile-device .story-container {
                padding: 8px !important;
              }
              
              .mobile-device .story-content {
                font-size: 20px !important;
                line-height: 1.6 !important;
                padding: 10px !important;
              }

              /* ğŸ”¥ å¿«æ·åŠŸèƒ½å¼¹çª—æ ·å¼ */
              #quick-action-modal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 10000 !important;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
              }

              #quick-action-modal .quick-action-modal-btn {
                transition: all 0.2s ease;
              }

              #quick-action-modal .quick-action-modal-btn:hover {
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.18), rgba(139, 105, 20, 0.1)) !important;
                border-color: rgba(139, 105, 20, 0.4) !important;
                transform: translateY(-2px);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
              }

              #quick-action-modal .quick-action-modal-btn:active {
                transform: translateY(0);
              }

              /* ğŸ”¥ å¿«æ·å§¿åŠ¿å¼¹çª—æ ·å¼ */
              #quick-position-modal {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 10000 !important;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(2px);
              }

              #quick-position-modal .quick-position-btn {
                transition: all 0.2s ease;
              }

              #quick-position-modal .quick-position-btn:hover {
                background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), rgba(233, 30, 99, 0.08)) !important;
                border-color: rgba(233, 30, 99, 0.4) !important;
                transform: translateY(-2px);
                box-shadow: 0 3px 6px rgba(233, 30, 99, 0.2);
              }

              #quick-position-modal .quick-position-btn:active {
                transform: translateY(0);
              }

              /* ğŸ”¥ äºŒçº§å¯¼èˆªæ ·å¼ */
              .position-category-btn:hover {
                background: linear-gradient(135deg, rgba(233, 30, 99, 0.2), rgba(233, 30, 99, 0.1)) !important;
                border-color: rgba(233, 30, 99, 0.5) !important;
                transform: translateY(-3px);
                box-shadow: 0 4px 8px rgba(233, 30, 99, 0.2) !important;
              }

              .position-category-btn:active {
                transform: translateY(-1px);
              }

              .position-back-btn:hover {
                background: rgba(139, 105, 20, 0.2) !important;
                border-color: rgba(139, 105, 20, 0.5) !important;
                transform: translateX(-3px);
              }

              .position-back-btn:active {
                transform: translateX(0);
              }

              /* ğŸ”¥ ç¾åŒ–æ»šåŠ¨æ¡ - å¿«æ·åŠŸèƒ½å¼¹çª— */
              #quick-action-modal .rules-modal-body::-webkit-scrollbar {
                width: 8px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.05);
                border-radius: 4px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.3);
                border-radius: 4px;
              }
              #quick-action-modal .rules-modal-body::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.5);
              }

              /* ğŸ”¥ ç¾åŒ–æ»šåŠ¨æ¡ - å¿«æ·å§¿åŠ¿å¼¹çª— */
              #quick-position-modal .rules-modal-body::-webkit-scrollbar {
                width: 8px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.05);
                border-radius: 4px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.3);
                border-radius: 4px;
              }
              #quick-position-modal .rules-modal-body::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.5);
              }
              
              /* ç§»åŠ¨ç«¯é©¬å¨˜å¡ç‰‡åŒºåŸŸä¼˜åŒ– */
              .mobile-device .uma-musume-section {
                margin-bottom: 20px !important;
              }
              
              .mobile-device .uma-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
              }
              
              .mobile-device .uma-card {
                width: 100% !important;
                max-width: none !important;
              }
              
              /* ç§»åŠ¨ç«¯è§„åˆ™å’ŒåŠŸèƒ½æŒ‰é’®ä¸€è¡Œæ˜¾ç¤ºå¹¶ç¼©å° */
              .mobile-device .rules-buttons-container {
                display: flex !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
              }
              
              .mobile-device .rules-section {
                flex: 1 !important;
                margin-bottom: 0 !important;
              }
              
              .mobile-device .view-rules-button {
                flex: 1 !important;
                width: 100% !important;
                padding: 6px 10px !important;
                font-size: 11px !important;
                min-height: 24px !important;
              }
              
              .mobile-device .view-rules-button .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              .mobile-device .view-rules-button span {
                font-size: 12px !important;
              }
              
              /* ç§»åŠ¨ç«¯å­˜æ¡£åŒºåŸŸä¼˜åŒ– */
              .mobile-device .save-section {
                display: flex !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
                position: static !important;
                order: 3 !important;
              }
              
              .mobile-device .save-button,
              .mobile-device #fullscreen-btn {
                flex: 1 !important;
                width: 100% !important;
                padding: 10px 12px !important;
                font-size: 13px !important;
                min-height: 36px !important;
                margin-bottom: 4px !important;
                line-height: 1.2 !important;
                touch-action: manipulation !important;
              }
              
              .mobile-device .save-button .icon,
              .mobile-device #fullscreen-btn .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              /* å¤©èµ‹ç®¡ç†åŒºåŸŸæ’åº */
              .mobile-device .talent-management {
                order: 2 !important;
              }
              
              /* ç§»åŠ¨ç«¯ä¸ªäººæ¡£æ¡ˆä¼˜åŒ– */
              /* ç§»åŠ¨ç«¯ä¸ªäººæ¡£æ¡ˆå’Œäººç‰©å†ç¨‹åˆ†è¡Œæ˜¾ç¤º */
              .mobile-device .profile-journey-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                margin-bottom: 8px !important;
              }
              
              .mobile-device .profile-section,
              .mobile-device .journey-section {
                width: 100% !important;
                margin-bottom: 0 !important;
                min-width: 0 !important;
              }
              
              .mobile-device .section-header {
                padding: 4px !important;
                font-size: 10px !important;
                margin-bottom: 4px !important;
              }
              
              .mobile-device .section-header h3 {
                font-size: 11px !important;
                margin: 2px 0 !important;
              }
              
              .mobile-device .section-header .icon {
                width: 12px !important;
                height: 12px !important;
              }
              
              .mobile-device .profile-basic,
              .mobile-device .journey-basic {
                font-size: 9px !important;
                padding: 2px !important;
              }
              
              /* ç§»åŠ¨ç«¯çŠ¶æ€æ ä¼˜åŒ– */
              .mobile-device .status-section {
                margin-bottom: 4px !important;
              }
              
              .mobile-device .status-header {
                margin-bottom: 2px !important;
              }
              
              .mobile-device .status-label {
                font-size: 10px !important;
              }
              
              .mobile-device .status-value {
                font-size: 10px !important;
              }
              
              .mobile-device .progress-bar {
                height: 8px !important;
              }
              
              /* æ‰‹æœºç«¯æ‰€æœ‰çŠ¶æ€æ¡éƒ½å æ»¡ä¸€è¡Œ */
              .mobile-device .status-item {
                flex: 1 !important;
                margin-bottom: 0 !important;
                margin-right: 4px !important;
                font-size: 14px !important;
              }
              
              .mobile-device .status-item:last-child {
                margin-right: 0 !important;
              }
              
              .mobile-device .status-item .progress-bar {
                width: 100% !important;
                min-width: 60px !important;
                height: 10px !important;
              }
              
              .mobile-device .journey-timeline {
                padding: 10px !important;
              }
              
              /* ç§»åŠ¨ç«¯ç‰©å“æ ä¼˜åŒ– */
              .mobile-device .inventory-section {
                margin-bottom: 20px !important;
              }
              
              .mobile-device .inventory-container {
                padding: 10px !important;
              }
              
              /* ç§»åŠ¨ç«¯æŠ€èƒ½æŒ‰é’®åŒºåŸŸä¼˜åŒ– */
              .mobile-device .skills-section {
                margin-bottom: 15px !important;
              }
              
              .mobile-device .skill-button {
                width: 100% !important;
                margin-bottom: 8px !important;
                padding: 12px !important;
                font-size: 16px !important;
              }
              
              /* ç§»åŠ¨ç«¯å±é™©æŒ‰é’®ä¼˜åŒ– - ä¸€è¡Œæ˜¾ç¤º */
              .mobile-device .danger-button {
                width: auto !important;
                padding: 6px 8px !important;
                font-size: 11px !important;
                margin-bottom: 0 !important;
                min-height: 26px !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
              }
              
              /* ç§»åŠ¨ç«¯æ—¶é—´æ˜¾ç¤ºå’Œå±é™©æŒ‰é’®ä¸€è¡Œæ˜¾ç¤º */
              .mobile-device .input-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                gap: 6px !important;
                margin-bottom: 0px !important;
              }
              
              .mobile-device .time-display {
                font-size: 13px !important;
                margin-bottom: 0 !important;
                text-align: left !important;
                flex: 1 !important;
                min-width: 60% !important;
              }
              
              .mobile-device .time-display .icon {
                width: 13px !important;
                height: 13px !important;
              }
              
              /* ç§»åŠ¨ç«¯è¾“å…¥æç¤ºä¼˜åŒ– */
              .mobile-device .input-prompt {
                font-size: 18px !important;
                margin-right: 10px !important;
              }
              
              /* ç§»åŠ¨ç«¯å¡ç‰‡è¯¦æƒ…ä¼˜åŒ– */
              .mobile-device .detail-card {
                padding: 15px !important;
                margin-bottom: 15px !important;
              }
              
              .mobile-device .detail-item {
                padding: 8px 0 !important;
                font-size: 16px !important;
              }
              
              /* ç§»åŠ¨ç«¯å…¨å±æ¨¡å¼é€‚é… */
              .mobile-device.fullscreen-active .connected-panels {
                padding: 0 !important;
                gap: 1px !important;
                grid-template-rows: auto auto 1fr auto !important;
                height: 100vh !important;
              }
              
              /* å…¨å±æ¨¡å¼ä¸‹çš„åŒºåŸŸé«˜åº¦åˆ†é… - æ­£æ–‡+è¾“å…¥æ å 70% */
              .mobile-device.fullscreen-active .left-panel {
                max-height: 15vh !important;
                min-height: 50px !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.3) !important;
              }
              
              .mobile-device.fullscreen-active .right-panel {
                max-height: 15vh !important;
                min-height: 50px !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.3) !important;
              }
              
              .mobile-device.fullscreen-active .center-panel {
                min-height: 55vh !important;
                max-height: 55vh !important;
                flex: 1 !important;
                overflow-y: auto !important;
              }
              
              .mobile-device.fullscreen-active .bottom-panel {
                min-height: 15vh !important;
                max-height: 15vh !important;
                padding: 4px 8px !important;
                overflow-y: auto !important;
              }
              
              /* å…¨å±æ¨¡å¼ä¸‹ç¼©å°æŒ‰é’®å’Œæ§ä»¶ */
              .mobile-device.fullscreen-active .save-button {
                padding: 6px 8px !important;
                font-size: 11px !important;
                min-height: 28px !important;
                margin: 1px !important;
              }
              
              .mobile-device.fullscreen-active .page-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-height: 24px !important;
              }
              
              .mobile-device.fullscreen-active .music-btn {
                padding: 2px 4px !important;
                font-size: 9px !important;
                min-height: 20px !important;
              }
              
              /* å…¨å±æ¨¡å¼ä¸‹ç¼©å°æ ‡é¢˜å’Œé—´è· */
              .mobile-device.fullscreen-active .panel-header {
                padding: 4px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device.fullscreen-active .panel-title {
                font-size: 12px !important;
              }
              
              .mobile-device.fullscreen-active .story-container {
                padding: 8px !important;
              }
              
              .mobile-device.fullscreen-active .story-content {
                font-size: 14px !important;
                line-height: 1.5 !important;
                padding-bottom: 10px !important;
              }
              
              /* å…¨å±æ¨¡å¼ä¸‹çš„çŠ¶æ€æ ç´§å‡‘åŒ– */
              .mobile-device.fullscreen-active .status-section {
                margin-bottom: 4px !important;
                gap: 4px !important;
              }
              
              .mobile-device.fullscreen-active .progress-bar {
                height: 8px !important;
              }
              
              
              /* ç§»åŠ¨ç«¯å“åº”å¼å­—ä½“è°ƒæ•´ */
              @media (max-width: 480px) {
                .mobile-device {
                  font-size: 15px !important;
                }
                
                .mobile-device .story-content {
                  font-size: 16px !important;
                }
                
                .mobile-device .section-header h3 {
                  font-size: 17px !important;
                }
              }
              
              /* ç§»åŠ¨ç«¯æ¨ªå±é€‚é… */
              @media (orientation: landscape) and (max-height: 600px) {
                .mobile-device .connected-panels {
                  min-height: auto !important;
                }
                
                .mobile-device .center-panel {
                  min-height: 300px !important;
                }
              }
              
              /* ç§»åŠ¨ç«¯å¼¹çª—ä¼˜åŒ– */
              .mobile-device .modal-content,
              .mobile-device .rules-modal-content,
              .mobile-device .danger-modal-content,
              .mobile-device .tarot-modal-content {
                width: 98% !important;
                max-width: none !important;
                max-height: 95vh !important;
                margin: 2vh auto !important;
                padding: 6px !important;
                border-radius: 6px !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .modal-body,
              .mobile-device .rules-modal-body {
                max-height: 80vh !important;
                overflow-y: auto !important;
                padding: 6px !important;
              }
              
              .mobile-device .modal-header,
              .mobile-device .rules-modal-header {
                padding: 4px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device .modal-title,
              .mobile-device .rules-title {
                font-size: 14px !important;
                margin: 0 !important;
                line-height: 1.2 !important;
              }
              
              .mobile-device .close-rules-btn {
                font-size: 16px !important;
                padding: 2px 6px !important;
                min-height: 24px !important;
                width: 24px !important;
              }
              
              /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
              .mobile-device button {
                min-height: 28px !important;
                padding: 4px 8px !important;
                font-size: 11px !important;
                touch-action: manipulation !important;
                margin: 2px !important;
              }
              
              /* ç§»åŠ¨ç«¯å­˜æ¡£ç®¡ç†å™¨æŒ‰é’®ä¼˜åŒ– */
              .mobile-device .save-manager-actions .save-button {
                padding: 8px 10px !important;
                font-size: 13px !important;
                min-height: 32px !important;
                margin-bottom: 4px !important;
                flex: 1 !important;
                min-width: 60px !important;
              }
              
              .mobile-device .save-manager-actions {
                gap: 6px !important;
                flex-wrap: wrap !important;
              }
              
              .mobile-device .save-manager-toolbar {
                flex-direction: column !important;
                gap: 8px !important;
              }
              
              .mobile-device .save-manager-toolbar .save-button {
                width: 100% !important;
                justify-content: center !important;
                min-height: 38px !important;
              }
              
              .mobile-device .music-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-height: 24px !important;
              }
              
              .mobile-device .page-btn {
                padding: 4px 8px !important;
                font-size: 11px !important;
                min-height: 28px !important;
              }
              
              /* ç§»åŠ¨ç«¯æ–‡æœ¬ä¼˜åŒ– */
              .mobile-device .text-content {
                line-height: 1.4 !important;
                font-size: 14px !important;
              }
              
              /* ç§»åŠ¨ç«¯å®¹å™¨ä¼˜åŒ– */
              .mobile-device .container,
              .mobile-device .row,
              .mobile-device .col {
                padding: 4px !important;
                margin: 1px 0 !important;
              }
              
              .mobile-device .card,
              .mobile-device .panel {
                padding: 8px !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device .form-group {
                margin-bottom: 6px !important;
              }
              
              /* ç§»åŠ¨ç«¯å¤©èµ‹ç®¡ç†ä¸“ç”¨æ ·å¼ - ä»…åœ¨å±å¹•å®½åº¦å°äº768pxæ—¶ç”Ÿæ•ˆ */
              @media (max-width: 767px) {
                .talents-modal-content {
                  max-width: 95% !important;
                  width: 95% !important;
                  margin: 10px auto !important;
                  max-height: 85vh !important;
                }
                
                .talents-grid {
                  grid-template-columns: repeat(2, 1fr) !important;
                  gap: 8px !important;
                  padding: 8px !important;
                }
                
                .talent-card {
                  padding: 8px !important;
                  font-size: 12px !important;
                  min-height: auto !important;
                }
                
                .talent-card h4 {
                  font-size: 13px !important;
                  margin-bottom: 4px !important;
                  line-height: 1.2 !important;
                }
                
                .talent-card p {
                  font-size: 11px !important;
                  line-height: 1.3 !important;
                  margin-bottom: 4px !important;
                }
                
                .talent-effects {
                  font-size: 10px !important;
                  line-height: 1.2 !important;
                }
                
                .rules-modal-header {
                  padding: 8px 12px !important;
                  flex-shrink: 0 !important;
                }
                
                .rules-modal-body {
                  max-height: calc(85vh - 120px) !important;
                  overflow-y: auto !important;
                  padding: 8px !important;
                }
                
                .close-rules-btn {
                  font-size: 18px !important;
                  padding: 4px 8px !important;
                  min-height: 32px !important;
                  width: 32px !important;
                }
                
                .rules-title {
                  font-size: 16px !important;
                  margin: 0 !important;
                }
              }
              
              .mobile-device .input-group {
                margin: 2px 0 !important;
              }
              
              /* ç§»åŠ¨ç«¯æ ‡é¢˜å’Œæ–‡æœ¬å¤§å°ä¼˜åŒ– */
              .mobile-device h1 { font-size: 18px !important; margin: 8px 0 !important; }
              .mobile-device h2 { font-size: 16px !important; margin: 6px 0 !important; }
              .mobile-device h3 { font-size: 14px !important; margin: 4px 0 !important; }
              .mobile-device h4 { font-size: 13px !important; margin: 3px 0 !important; }
              .mobile-device h5 { font-size: 12px !important; margin: 2px 0 !important; }
              .mobile-device h6 { font-size: 11px !important; margin: 2px 0 !important; }
              
              .mobile-device p {
                font-size: 14px !important;
                line-height: 1.4 !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device label {
                font-size: 11px !important;
                margin-bottom: 2px !important;
              }
              
              .mobile-device input,
              .mobile-device textarea,
              .mobile-device select {
                font-size: 14px !important;
                padding: 8px 10px !important;
                min-height: 44px !important;
              }
              
              .mobile-device .input-container {
                flex-direction: row !important;
                align-items: flex-end !important;
                gap: 4px !important;
                margin-top: 1px !important;
              }
              
              .mobile-device .action-input {
                flex: 1 !important;
                min-width: 0 !important;
              }
              
              /* ç§»åŠ¨ç«¯ä¸‰æ å¸ƒå±€ä¼˜åŒ– - æ”¹ä¸ºå‚ç›´å †å  */
              .mobile-device .connected-panels {
                grid-template-columns: 1fr !important;
                grid-template-rows: auto auto 1fr auto !important;
                height: auto !important;
                min-height: 100vh !important;
                max-width: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                gap: 1px !important;
              }
              
              /* ç§»åŠ¨ç«¯é¢æ¿é‡æ–°æ’åº */
              .mobile-device .left-panel {
                grid-area: 1 / 1 / 2 / 2 !important;
                height: auto !important;
                max-height: 45vh !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.4) !important;
                scrollbar-width: thin !important;
                scrollbar-color: rgba(139, 105, 20, 0.6) rgba(139, 105, 20, 0.1) !important;
              }
              
              /* ç§»åŠ¨ç«¯å·¦é¢æ¿æ»šåŠ¨æ¡æ ·å¼ */
              .mobile-device .left-panel::-webkit-scrollbar {
                width: 6px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-track {
                background: rgba(139, 105, 20, 0.1) !important;
                border-radius: 3px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-thumb {
                background: rgba(139, 105, 20, 0.6) !important;
                border-radius: 3px !important;
              }
              
              .mobile-device .left-panel::-webkit-scrollbar-thumb:hover {
                background: rgba(139, 105, 20, 0.8) !important;
              }
              
              .mobile-device .right-panel {
                grid-area: 2 / 1 / 3 / 2 !important;
                height: auto !important;
                max-height: 30vh !important;
                overflow-y: auto !important;
                border-bottom: 1px solid rgba(139, 105, 20, 0.4) !important;
              }
              
              .mobile-device .center-panel {
                grid-area: 3 / 1 / 4 / 2 !important;
                height: auto !important;
                min-height: 50vh !important;
                flex: 1 !important;
              }
              
              .mobile-device .bottom-panel {
                order: 4 !important;
                height: auto !important;
                min-height: 50px !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
                padding: 8px !important;
                width: 100% !important;
                display: flex !important;
              }
              
              /* ç§»åŠ¨ç«¯é¢æ¿åˆ†éš”çº¿éšè— */
              .mobile-device .panel-divider {
                display: none !important;
              }
              
              /* ç§»åŠ¨ç«¯å¯æŠ˜å ä¾§è¾¹æ  */
              .mobile-device .left-panel,
              .mobile-device .right-panel {
                transition: max-height 0.3s ease !important;
              }
              
              .mobile-device .left-panel.collapsed {
                max-height: 60px !important;
                overflow: hidden !important;
              }
              
              .mobile-device .right-panel.collapsed {
                max-height: 60px !important;
                overflow: hidden !important;
              }
              
              /* ç§»åŠ¨ç«¯é¢æ¿æ ‡é¢˜æ  */
              .mobile-device .panel-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 8px 12px !important;
                background: linear-gradient(135deg, #f5f0e8, #e8d5c4) !important;
                border-bottom: 1px solid #8b6914 !important;
                cursor: pointer !important;
                user-select: none !important;
              }
              
              .mobile-device .panel-title {
                font-size: 14px !important;
                font-weight: 600 !important;
                color: #2d2d2d !important;
                margin: 0 !important;
              }
              
              .mobile-device .panel-toggle {
                color: #8b6914 !important;
                font-size: 16px !important;
                transition: transform 0.3s ease !important;
                cursor: pointer !important;
              }
              
              .mobile-device .panel-toggle.collapsed {
                transform: rotate(180deg) !important;
              }
              
              /* ç§»åŠ¨ç«¯å†…å®¹ä¼˜å…ˆçº§ä¼˜åŒ– */
              .mobile-device .story-container {
                padding: 12px !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .story-content {
                font-size: 15px !important;
                line-height: 1.6 !important;
                padding-bottom: 20px !important;
              }
              
              /* ç§»åŠ¨ç«¯çŠ¶æ€æ ä¼˜åŒ– */
              .mobile-device .status-section {
                display: flex !important;
                flex-direction: row !important;
                gap: 4px !important;
                margin-bottom: 6px !important;
                justify-content: space-between !important;
              }
              
              
              .mobile-device .progress-bar {
                height: 10px !important;
              }
              
              /* ç§»åŠ¨ç«¯å³ä¾§é¢æ¿å†…å®¹ä¼˜åŒ– */
              .mobile-device .rules-section {
                flex: 1 !important;
                margin-bottom: 8px !important;
              }
              
              .mobile-device .view-rules-button {
                flex: 1 !important;
                padding: 6px 10px !important;
                font-size: 11px !important;
                min-height: 24px !important;
              }
              
              /* ç§»åŠ¨ç«¯ç‰©å“å’Œè§’è‰²åˆ—è¡¨ä¼˜åŒ– */
              .mobile-device .inventory-container,
              .mobile-device .uma-list {
                max-height: 25vh !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .inventory-item,
              .mobile-device .uma-item {
                padding: 6px !important;
                margin-bottom: 4px !important;
                font-size: 12px !important;
              }
              
              /* ç§»åŠ¨ç«¯æ—…ç¨‹è®°å½•ä¼˜åŒ– */
              .mobile-device .journey-list {
                max-height: 20vh !important;
                overflow-y: auto !important;
              }
              
              .mobile-device .journey-entry {
                padding: 6px !important;
                margin-bottom: 4px !important;
                font-size: 11px !important;
              }
              
              /* ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
              .mobile-device .input-section {
                padding: 4px !important;
                background-color: #fdfbf7 !important;
                border-top: 1px solid rgba(139, 105, 20, 0.3) !important;
                position: sticky !important;
                bottom: 0 !important;
                z-index: 100 !important;
                box-shadow: 0 -4px 12px rgba(139, 105, 20, 0.2) !important;
                margin-top: 8px !important; /* å‡å°‘ä¸ä¸Šæ–¹å†…å®¹çš„è·ç¦» */
              }
              
              .mobile-device .input-header {
                flex-wrap: wrap !important;
                gap: 4px !important;
                margin-bottom: 0px !important;
              }
              
              .mobile-device .time-display {
                font-size: 12px !important;
                order: 1 !important;
              }
              
              .mobile-device .skills-section {
                order: 3 !important;
                width: 100% !important;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 6px !important;
                margin-top: 8px !important;
              }
              
              .mobile-device .skill-button {
                flex: 1 !important;
                min-width: calc(50% - 3px) !important;
                font-size: 10px !important;
                padding: 6px 8px !important;
                min-height: 32px !important;
              }
              
              .mobile-device .input-container {
                background-color: #f5f0e8 !important;
                border: 2px solid #8b6914 !important;
                border-radius: 8px !important;
                padding: 4px !important;
                box-shadow: inset 0 2px 4px rgba(139, 105, 20, 0.1) !important;
                margin-top: 1px !important;
              }
              
              .mobile-device .input-prompt {
                font-size: 16px !important;
                color: #8b4513 !important;
                margin-bottom: 8px !important;
                display: block !important;
              }
              
              .mobile-device .action-input {
                min-height: 36px !important;
                max-height: 60px !important;
                font-size: 16px !important;
                line-height: 1.4 !important;
                padding: 8px !important;
                border: 1px solid #d4af37 !important;
                border-radius: 6px !important;
                background-color: #ffffff !important;
                resize: vertical !important;
              }
              
              .mobile-device .input-controls {
                margin-top: 0 !important;
                justify-content: flex-end !important;
              }
              
              .mobile-device .send-button {
                width: auto !important;
                max-width: none !important;
                padding: 8px 16px !important;
                flex-shrink: 0 !important;
                font-size: 16px !important;
                font-weight: 600 !important;
                min-height: 48px !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 8px rgba(139, 105, 20, 0.3) !important;
              }
              
              /* ç§»åŠ¨ç«¯ç‰¹å®šå…ƒç´ ä¼˜åŒ– */
              .mobile-device .nav-tabs {
                padding: 2px !important;
              }
              
              .mobile-device .nav-tabs li {
                margin: 1px !important;
              }
              
              .mobile-device .nav-tabs a {
                padding: 4px 8px !important;
                font-size: 11px !important;
              }
              
              .mobile-device .table {
                font-size: 11px !important;
              }
              
              .mobile-device .table th,
              .mobile-device .table td {
                padding: 3px 4px !important;
              }
              
              .mobile-device .alert {
                padding: 6px 8px !important;
                margin: 4px 0 !important;
                font-size: 11px !important;
              }
              
              .mobile-device .badge {
                font-size: 9px !important;
                padding: 2px 4px !important;
              }
              
              /* ç§»åŠ¨ç«¯åˆ—è¡¨ä¼˜åŒ– */
              .mobile-device ul, .mobile-device ol {
                padding-left: 16px !important;
                margin: 4px 0 !important;
              }
              
              .mobile-device li {
                margin: 2px 0 !important;
                font-size: 12px !important;
                line-height: 1.3 !important;
              }
              
              /* ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ– */
              .mobile-device .scrollable {
                -webkit-overflow-scrolling: touch !important;
              }
              
              /* ç§»åŠ¨ç«¯çŠ¶æ€åŠ¨ç”»é€‚é… */
              .mobile-device .status-animation-container {
                font-size: 14px !important;
              }
              
              .mobile-device .status-animation-text {
                font-size: 18px !important;
                padding: 15px !important;
              }
            </style>
          `;

          document.head.insertAdjacentHTML('beforeend', mobileStyles);
        }
      }

      // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–ç§»åŠ¨ç«¯æ£€æµ‹
      document.addEventListener('DOMContentLoaded', () => {
        window.mobileDetector = new MobileDetector();
      });

      // ç«‹å³æ‰§è¡ŒåŸºç¡€æ£€æµ‹ï¼ˆç”¨äºCSSç±»æ·»åŠ ï¼‰
      if (typeof window !== 'undefined') {
        const quickDetect = () => {
          const userAgent = navigator.userAgent.toLowerCase();
          const isMobile =
            /mobile|android|iphone|ipad|ipod|blackberry|windows phone|opera mini/.test(userAgent) ||
            (window.innerWidth <= 768 && ('ontouchstart' in window || navigator.maxTouchPoints > 0));

          if (isMobile) {
            document.documentElement.classList.add('mobile-device');
          } else {
            document.documentElement.classList.add('desktop-device');
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', quickDetect);
        } else {
          quickDetect();
        }
      }
    </script>

    <style>
      /* æ–°å¢ï¼šçŠ¶æ€åˆ¤å®šåŠ¨ç”»å’Œå¡”ç½—buffç³»ç»Ÿæ ·å¼ */

      /* çŠ¶æ€åŠ¨ç”»å®¹å™¨ */
      .status-animation-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .status-animation-container.show {
        opacity: 1;
      }

      .status-animation {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
        max-width: 500px;
        transform: scale(0.8);
        transition: transform 0.5s ease;
      }

      .status-animation-container.show .status-animation {
        transform: scale(1);
      }

      .status-title {
        font-size: 2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }

      .status-content {
        margin-bottom: 1rem;
      }

      .status-message {
        font-size: 1rem;
        color: #e5e7eb;
        margin-top: 1rem;
        font-style: italic;
      }

      .status-hint {
        font-size: 0.9rem;
        color: #d4af37;
        margin-top: 0.5rem;
        font-style: italic;
        opacity: 0.8;
      }

      /* ä¸åŒçŠ¶æ€ç±»å‹çš„ç‰¹æ®Šæ ·å¼ */
      .status-animation-container.critical .status-animation {
        border-color: #dc2626;
        box-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
        animation: criticalShake 0.5s ease-in-out infinite;
      }

      .status-animation-container.stamina .status-animation {
        border-color: #ef4444;
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
      }

      .status-animation-container.sanity .status-animation {
        border-color: #8b5cf6;
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
      }

      @keyframes criticalShake {
        0%,
        100% {
          transform: scale(1) rotate(0deg);
        }
        25% {
          transform: scale(1.02) rotate(-1deg);
        }
        75% {
          transform: scale(1.02) rotate(1deg);
        }
      }

      /* Buffé€šçŸ¥æ ·å¼ */
      .buff-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        z-index: 10000;
        max-width: 350px;
        transform: translateX(100%);
        transition: transform 0.5s ease;
      }

      .buff-notification.show {
        transform: translateX(0);
      }

      .buff-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 1rem;
        text-align: center;
      }

      .buff-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .buff-item {
        padding: 0.5rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .buff-item.courage {
        border-left: 3px solid #ef4444;
      }
      .buff-item.skill {
        border-left: 3px solid #3b82f6;
      }
      .buff-item.intuition {
        border-left: 3px solid #8b5cf6;
      }
      .buff-item.fertility {
        border-left: 3px solid #10b981;
      }
      .buff-item.authority {
        border-left: 3px solid #f59e0b;
      }
      .buff-item.harmony {
        border-left: 3px solid #06b6d4;
      }
      .buff-item.victory {
        border-left: 3px solid #dc2626;
      }
      .buff-item.strength {
        border-left: 3px solid #ea580c;
      }
      .buff-item.wisdom {
        border-left: 3px solid #7c3aed;
      }
      .buff-item.fortune {
        border-left: 3px solid #fbbf24;
      }

      .buff-name {
        display: block;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.25rem;
      }

      .buff-effect {
        display: block;
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.25rem;
      }

      .buff-duration {
        display: block;
        font-size: 0.8rem;
        color: #9ca3af;
      }

      .tarot-result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-result-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-result-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-result-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .tarot-card {
        background: linear-gradient(135deg, #2d3748, #4a5568);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        transition: transform 0.2s;
      }

      .tarot-card:hover {
        transform: translateY(-5px);
      }

      .tarot-card.reversed {
        border-color: #ef4444;
      }

      .card-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #d4af37;
        margin-bottom: 0.5rem;
      }

      .card-meaning {
        font-size: 0.9rem;
        color: #e5e7eb;
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .card-position {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .tarot-advice {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid #d4af37;
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .tarot-advice h3 {
        color: #d4af37;
        margin: 0 0 0.5rem 0;
      }

      .tarot-advice p {
        color: #e5e7eb;
        margin: 0;
        line-height: 1.5;
      }

      /* å¡”ç½—buffå¼¹çª— */
      .tarot-buffs-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .tarot-buffs-modal.show {
        opacity: 1;
      }

      .tarot-buffs-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid #d4af37;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8);
        transition: transform 0.3s ease;
      }

      .tarot-buffs-modal.show .tarot-buffs-content {
        transform: scale(1);
      }

      .tarot-buffs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #d4af37;
        padding-bottom: 1rem;
      }

      .tarot-buffs-header h2 {
        color: #d4af37;
        margin: 0;
      }

      .tarot-buffs-header button {
        background: none;
        border: none;
        color: #d4af37;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }

      .tarot-buffs-header button:hover {
        background: rgba(212, 175, 55, 0.2);
      }

      .tarot-buffs-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .tarot-buffs-body .buff-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1rem;
      }

      .buff-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .buff-remaining {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
      }

      .buff-source {
        font-size: 0.8rem;
        color: #6b7280;
        font-style: italic;
        margin-top: 0.5rem;
      }

      /*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */

      @layer properties {
        @supports ((-webkit-hyphens: none) and (not (margin-trim: inline))) or
          ((-moz-orient: inline) and (not (color: rgb(from red r g b)))) {
          *,
          :before,
          :after,
          ::backdrop {
            --tw-rotate-x: initial;

            --tw-rotate-y: initial;

            --tw-rotate-z: initial;

            --tw-skew-x: initial;

            --tw-skew-y: initial;

            --tw-border-style: solid;

            --tw-shadow: 0 0 #0000;

            --tw-shadow-color: initial;

            --tw-shadow-alpha: 100%;

            --tw-inset-shadow: 0 0 #0000;

            --tw-inset-shadow-color: initial;

            --tw-inset-shadow-alpha: 100%;

            --tw-ring-color: initial;

            --tw-ring-shadow: 0 0 #0000;

            --tw-inset-ring-color: initial;

            --tw-inset-ring-shadow: 0 0 #0000;

            --tw-ring-inset: initial;

            --tw-ring-offset-width: 0px;

            --tw-ring-offset-color: #fff;

            --tw-ring-offset-shadow: 0 0 #0000;

            --tw-outline-style: solid;

            --tw-backdrop-blur: initial;

            --tw-backdrop-brightness: initial;

            --tw-backdrop-contrast: initial;

            --tw-backdrop-grayscale: initial;

            --tw-backdrop-hue-rotate: initial;

            --tw-backdrop-invert: initial;

            --tw-backdrop-opacity: initial;

            --tw-backdrop-saturate: initial;

            --tw-backdrop-sepia: initial;
          }
        }
      }

      .absolute {
        position: absolute;
      }

      .fixed {
        position: fixed;
      }

      .block {
        display: block;
      }

      .flex {
        display: flex;
      }

      .hidden {
        display: none;
      }

      .flex-shrink {
        flex-shrink: 1;
      }

      .transform {
        transform: var(--tw-rotate-x,) var(--tw-rotate-y,) var(--tw-rotate-z,) var(--tw-skew-x,) var(--tw-skew-y,);
      }

      .resize {
        resize: both;
      }

      .flex-wrap {
        flex-wrap: wrap;
      }

      .border {
        border-style: var(--tw-border-style);

        border-width: 1px;
      }

      .ring {
        --tw-ring-shadow: var(--tw-ring-inset,) 0 0 0 calc(1px + var(--tw-ring-offset-width))
          var(--tw-ring-color, currentcolor);

        box-shadow:
          var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow),
          var(--tw-shadow);
      }

      .outline {
        outline-style: var(--tw-outline-style);

        outline-width: 1px;
      }

      .backdrop-filter {
        backdrop-filter: var(--tw-backdrop-blur,) var(--tw-backdrop-brightness,) var(--tw-backdrop-contrast,)
          var(--tw-backdrop-grayscale,) var(--tw-backdrop-hue-rotate,) var(--tw-backdrop-invert,)
          var(--tw-backdrop-opacity,) var(--tw-backdrop-saturate,) var(--tw-backdrop-sepia,);
      }

      .transition {
        transition-property:
          color, background-color, border-color, outline-color, text-decoration-color, fill, stroke, --tw-gradient-from,
          --tw-gradient-via, --tw-gradient-to, opacity, box-shadow, transform, translate, scale, rotate, filter,
          backdrop-filter, display, visibility, content-visibility, overlay, pointer-events;

        transition-timing-function: var(--tw-ease, ease);

        transition-duration: var(--tw-duration, 0s);
      }

      @layer base {
        html {
          font-family:
            Noto Sans SC,
            Georgia,
            Times New Roman,
            serif;
        }

        body {
          color: #2d2d2d;

          background: linear-gradient(135deg, #f8f2e6 0%, #f2e8d8 25%, #ecddc7 50%, #e6d3b6 75%, #e0c8a5 100%) fixed;

          margin: 0;

          padding: 0;

          font-family:
            'WenQuanYi Micro Hei', 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Helvetica Neue', Arial,
            sans-serif;

          font-weight: 400;

          line-height: 1.6;
        }
      }

      @layer components {
        .leather-journal {
          background: linear-gradient(145deg, #faf6f0 0%, #f5f0e8 50%, #f0eae0 100%);

          border: 2px solid #8b6914;

          min-height: 600px;

          position: relative;

          box-shadow:
            inset 0 0 20px #8b691433,
            0 4px 8px #0000004d;
        }

        .leather-journal:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 15% 25%, #8b691414 1px, #0000 2px),
            radial-gradient(circle at 85% 75%, #6543210f 1px, #0000 2px),
            radial-gradient(circle at 45% 60%, #a086590a 1px, #0000 2px);

          background-size:
            40px 40px,
            60px 60px,
            80px 80px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .connected-panels {
          z-index: 2;

          border-radius: 8px;

          grid-template-rows: auto 1fr auto;

          grid-template-columns: 250px 1fr 200px;

          gap: 0;

          width: 100%;

          max-width: 1600px;

          height: 575px;

          margin: auto;

          transition: all 0.3s;

          display: grid;

          position: relative;

          overflow: hidden;

          box-shadow: 0 8px 16px #00000080;
        }

        .connected-panels.fullscreen-active {
          z-index: 9999;

          border-radius: 0;

          width: 100vw;

          max-width: none;

          height: 100vh;

          margin: 0;

          position: fixed;

          top: 0;

          left: 0;
        }

        .connected-panels.fullscreen-active .panel-content {
          z-index: 10000;
        }

        .connected-panels.fullscreen-active .save-section {
          z-index: 10001;

          position: relative;
        }

        .connected-panels.fullscreen-active ~ .rules-modal {
          z-index: 10002;
        }

        .connected-panels.fullscreen-active ~ .rules-modal .rules-modal-content {
          z-index: 10003;
        }

        .connected-panels.fullscreen-active ~ .danger-modal,
        .connected-panels.fullscreen-active ~ #load-modal,
        .connected-panels.fullscreen-active ~ #rules-modal,
        .connected-panels.fullscreen-active ~ #command-modal {
          z-index: 10002;
        }

        /* ğŸ”¥ å…¨å±è¦†ç›–å±‚å†…éƒ¨çš„å¼¹çª—æ ·å¼ï¼ˆå¼¹çª—æ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨ï¼‰ */
        #teresen-fullscreen-overlay .rules-modal,
        #teresen-fullscreen-overlay .danger-modal,
        #teresen-fullscreen-overlay #load-modal,
        #teresen-fullscreen-overlay #rules-modal,
        #teresen-fullscreen-overlay #command-modal,
        #teresen-fullscreen-overlay #talents-modal,
        #teresen-fullscreen-overlay #saveManagerModal,
        #teresen-fullscreen-overlay #world-map-modal,
        #teresen-fullscreen-overlay #tarot-modal,
        #teresen-fullscreen-overlay #shrine-modal,
        #teresen-fullscreen-overlay #achievement-modal,
        #teresen-fullscreen-overlay #achievements-modal,
        #teresen-fullscreen-overlay .item-detail-popup,
        #teresen-fullscreen-overlay #roster-modal,
        #teresen-fullscreen-overlay .roster-modal,
        #teresen-fullscreen-overlay #roster-detail-modal,
        #teresen-fullscreen-overlay #location-detail-panel,
        #teresen-fullscreen-overlay #quick-map-modal,
        #teresen-fullscreen-overlay #quick-action-modal,
        #teresen-fullscreen-overlay #quick-position-modal,
        #teresen-fullscreen-overlay #music-player-modal,
        #teresen-fullscreen-overlay #location-confirm-modal,
        #teresen-fullscreen-overlay #settings-modal,
        #teresen-fullscreen-overlay #card-display-modal {
          position: fixed !important;
          z-index: 100001 !important; /* é«˜äºè¦†ç›–å±‚ï¼ˆ99999ï¼‰å’Œæ§åˆ¶æ ï¼ˆ100000ï¼‰ */
          top: 0 !important;
          left: 0 !important;
          width: 100vw !important;
          height: 100vh !important;
          padding: 20px !important; /* ğŸ”¥ æ·»åŠ paddingï¼Œè®©å¼¹çª—ä¸è´´è¾¹ */
          box-sizing: border-box !important;
        }

        /* ğŸ”¥ å…¨å±æ—¶card-display-modal-contentçš„æ ·å¼ä¼˜åŒ– */
        #teresen-fullscreen-overlay #card-display-modal .rules-modal-content {
          width: 100% !important;
          max-width: calc(100vw - 40px) !important; /* å‡å»padding */
          max-height: calc(100vh - 40px) !important; /* å‡å»padding */
          margin: 0 !important;
          border-radius: 16px !important;
          box-shadow:
            0 25px 50px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(139, 105, 20, 0.1) !important;
        }

        /* ğŸ”¥ ç‰©å“å¼¹çª—ç‰¹æ®Šå¤„ç†ï¼ˆä¿æŒåŸæœ‰å®šä½ï¼‰ */
        #teresen-fullscreen-overlay .item-detail-popup {
          width: auto !important;
          height: auto !important;
        }

        .danger-modal,
        #load-modal,
        #rules-modal {
          z-index: 10000;
        }

        /* ğŸ”¥ ç¡®ä¿æ‰€æœ‰å¼¹çª—åœ¨å…¨å±çŠ¶æ€ä¸‹éƒ½èƒ½æ˜¾ç¤º */
        .rules-modal,
        .danger-modal,
        #load-modal,
        #rules-modal,
        #command-modal,
        #talents-modal,
        #saveManagerModal {
          position: fixed !important;
        }

        .parchment-page {
          color: #2d2d2d;

          background-color: #fdfbf7;

          border: 1px solid #8b6914;

          flex-direction: column;

          display: flex;

          position: relative;

          box-shadow: inset 0 0 20px #8b69141a;
        }

        .parchment-page:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .left-panel {
          grid-area: 1/1/3;

          width: 100%;

          height: 100%;

          overflow: hidden auto;
        }

        .center-panel {
          flex-direction: column;

          grid-area: 1/2/3;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;
        }

        .right-panel {
          flex-direction: column;

          grid-area: 1/3/3;

          gap: 0.75rem;

          width: 100%;

          height: 100%;

          display: flex;

          overflow: hidden auto;
        }

        .panel-content {
          z-index: 1;

          flex-direction: column;

          height: 100%;

          padding: 0.75rem;

          font-size: 1rem;

          display: flex;

          position: relative;

          overflow-y: auto;
        }

        .panel-divider {
          background: linear-gradient(#8b6914, #a0865a, #8b6914);

          width: 3px;

          height: 100%;

          position: relative;

          box-shadow:
            inset 0 0 4px #0000004d,
            0 0 8px #8b691433;
        }

        .panel-divider:before {
          content: '';

          background: linear-gradient(#0000 0%, #ffffff1a 50%, #0000 100%);

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .panel-divider:after {
          content: '';

          background: radial-gradient(circle, #a0865a, #8b6914);

          border-radius: 50%;

          width: 8px;

          height: 8px;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);

          box-shadow: 0 0 4px #0000004d;

          display: none; /* éšè—è£…é¥°æ€§å°åœ†ç‚¹ */
        }

        .section-header {
          border-bottom: 1px solid #8b69144d;

          align-items: center;

          gap: 0.5rem;

          margin-bottom: 0.75rem;

          padding-bottom: 0.375rem;

          display: flex;
        }

        .section-header h3 {
          color: #2d2d2d;

          margin: 0;

          font-size: 0.9rem;

          font-weight: 600;

          flex: 1;
        }

        .icon {
          color: #8b4513;

          width: 1rem;

          height: 1rem;
        }

        /* ç¼©å°æŒ‰é’®ä¸­çš„å›¾æ ‡å°ºå¯¸ */
        .view-rules-button .icon {
          width: 1rem;
          height: 1rem;
        }

        .roster-btn {
          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          font-size: 1rem;

          color: #8b4513;

          transition: all 0.2s ease;
        }

        .roster-btn:hover {
          background-color: #8b69141a;

          transform: scale(1.1);
        }

        /* é©¬å¨˜è®°åå†Œå¼¹çª—æ ·å¼ */
        .roster-modal {
          z-index: 1000;
          backdrop-filter: blur(4px);
          background: #000000b3;
          justify-content: center;
          align-items: center;
          width: 100%;
          height: 100%;
          display: flex;
          position: fixed;
          top: 0;
          left: 0;
        }

        .roster-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
          border-radius: 1rem;
          max-width: 600px;
          height: auto;
          max-height: calc(100vh - 40px);
          width: 90%;
          overflow: visible;
          box-shadow: 0 20px 40px #0000004d;
          position: relative;
          display: flex;
          flex-direction: column;
        }

        .roster-content:before {
          content: '';
          pointer-events: none;
          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);
          background-size:
            60px 60px,
            40px 40px;
          position: absolute;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        }

        .roster-header {
          background: linear-gradient(135deg, #8b6914, #a0865a);
          color: #fdfbf7;
          padding: 1rem 1.5rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 2px solid #654321;
        }

        .roster-header h2 {
          margin: 0;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .roster-close-btn {
          background: none;
          border: none;
          color: white;
          font-size: 1.5rem;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background-color 0.2s;
        }

        .roster-close-btn:hover {
          background-color: rgba(255, 255, 255, 0.2);
        }

        .roster-body {
          flex: 1;
          min-height: 0;
          padding: 1.5rem;
          overflow-y: auto;
          max-height: calc(100vh - 120px);
        }

        .empty-roster {
          text-align: center;
          color: #8b4513;
          font-style: italic;
          padding: 2rem;
        }

        .roster-list {
          display: flex;
          flex-direction: column;
          gap: 1rem;
        }

        .roster-item {
          background: white;
          border: 1px solid #d4af37;
          border-radius: 6px;
          padding: 1rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .roster-item-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
          border-bottom: 1px solid #f0f0f0;
          padding-bottom: 0.5rem;
        }

        .roster-item-header h3 {
          margin: 0;
          color: #8b4513;
          font-size: 1.1rem;
          font-weight: 600;
        }

        .encounter-count {
          background: #8b4513;
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 12px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .roster-item-details {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        }

        .roster-detail {
          color: #2d2d2d;
          font-size: 0.9rem;
          line-height: 1.4;
        }

        .roster-detail strong {
          color: #8b4513;
          font-weight: 600;
        }

        .expand-btn {
          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          margin-left: auto;

          padding: 0.25rem;

          transition: background-color 0.2s;
        }

        .expand-btn:hover {
          background-color: #8b69141a;
        }

        .save-section {
          gap: 0.5rem;

          margin-bottom: 1.5rem;

          display: flex;
        }

        .save-section .save-button {
          flex: 1;

          min-width: 0;

          padding: 0.375rem;

          font-size: 0.7rem;
        }

        .save-button {
          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.25rem;

          justify-content: center;

          align-items: center;

          gap: 0.5rem;

          width: 100%;

          padding: 0.5rem;

          font-size: 0.75rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:
            inset 0 1px #ffffff1a,
            0 2px 4px #0006;
        }

        .save-button:before {
          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .save-button:hover:before {
          opacity: 1;
        }

        .save-button:hover {
          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:
            inset 0 1px #ffffff26,
            0 3px 6px #00000080;
        }

        .save-button:active {
          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:
            inset 0 2px 4px #0009,
            0 1px 2px #0000004d;
        }

        .status-section {
          margin-bottom: 0.5rem;
        }

        .status-item {
          margin-bottom: 0.3rem;
        }

        .status-header {
          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .status-label {
          color: #2d2d2d;

          font-size: 0.75rem;

          font-weight: 500;
        }

        .status-value {
          color: #8b4513;

          font-size: 0.75rem;

          font-weight: 600;
        }

        .progress-bar {
          background-color: #8b691433;

          border-radius: 9999px;

          height: 0.5rem;

          position: relative;

          overflow: hidden;
        }

        .progress-fill {
          background: linear-gradient(90deg, #059669 0%, #10b981 100%);

          border-radius: 9999px;

          height: 100%;

          transition: width 0.5s;
        }

        .progress-fill.danger {
          background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);

          animation: 3s ease-in-out infinite subtle-pulse;
        }

        .progress-fill.warning {
          background: linear-gradient(90deg, #d97706 0%, #f59e0b 100%);
        }

        .profile-section,
        .journey-section,
        .inventory-section {
          margin-bottom: 1rem;
        }

        .profile-basic,
        .journey-basic {
          font-size: 0.75rem;
        }

        .profile-item,
        .detail-item {
          justify-content: space-between;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .label {
          color: #6b7280;

          font-weight: 400;
        }

        .value {
          color: #2d2d2d;

          font-weight: 500;
        }

        .status-excellent {
          color: #059669;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(5, 150, 105, 0.3);
        }

        .status-good {
          color: #d97706;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(217, 119, 6, 0.3);
        }

        .status-normal {
          color: #6b7280;

          font-weight: 500;
        }

        .status-bad {
          color: #dc2626;

          font-weight: 600;

          text-shadow: 0 0 5px rgba(220, 38, 38, 0.3);
        }

        .status-terrible {
          color: #7f1d1d;

          font-weight: 700;

          text-shadow: 0 0 8px rgba(127, 29, 29, 0.5);

          animation: 2s ease-in-out infinite subtle-pulse;
        }

        .profile-detail,
        .journey-detail {
          font-size: 0.75rem;
        }

        .profile-current-song {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 12px;
          background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 105, 20, 0.1));
          border: 1px solid rgba(139, 69, 19, 0.3);
          border-radius: 6px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          animation: fadeIn 0.3s ease-in;
        }

        .profile-current-song .label {
          font-size: 0.85rem;
          color: #8b6914;
          font-weight: 600;
        }

        .profile-current-song .value {
          font-size: 0.85rem;
          color: #a0522d;
          font-weight: 500;
          max-width: 200px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(-5px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .detail-card {
          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;
        }

        .anomaly-card {
          background: linear-gradient(45deg, #8b00001a, #8b000033);

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.75rem;
        }

        .anomaly-card h4 {
          margin: 0 0 0.5rem;

          font-size: 0.875rem;
        }

        .anomaly-list {
          flex-direction: column;

          gap: 0.25rem;

          display: flex;
        }

        .anomaly-item {
          font-size: 0.75rem;
        }

        .profile-link,
        .journey-link {
          color: #8b4513;

          cursor: pointer;

          font-size: 0.75rem;
        }

        .journey-list {
          flex-direction: column;

          gap: 0.5rem;

          max-height: 200px;

          display: flex;

          overflow-y: auto;
        }

        .journey-entry {
          background-color: #8b69141a;

          border-left: 2px solid #8b6914;

          border-radius: 0.25rem;

          padding: 0.5rem;
        }

        .journey-header {
          justify-content: space-between;

          align-items: flex-start;

          margin-bottom: 0.25rem;

          display: flex;
        }

        .journey-day {
          color: #2d2d2d;

          font-weight: 600;
        }

        .journey-status {
          border-radius: 0.125rem;

          padding: 0.125rem 0.25rem;

          font-size: 0.625rem;

          font-weight: 600;
        }

        .journey-status.normal {
          color: #059669;

          background-color: #05966933;
        }

        .journey-status.confused {
          color: #d97706;

          background-color: #d9770633;
        }

        .journey-event {
          color: #8b4513;

          margin-bottom: 0.125rem;

          font-weight: 500;
        }

        .journey-desc {
          color: #654321;

          font-size: 0.625rem;
        }

        .sanity-change {
          margin-top: 0.25rem;

          font-size: 0.625rem;
        }

        .inventory-container {
          max-height: 200px;

          overflow-y: auto;
        }

        .empty-inventory,
        .empty-rules,
        .loading-uma {
          text-align: center;

          color: #8b4513;

          padding: 1rem;

          font-size: 0.75rem;
        }

        .empty-uma {
          text-align: center;
          color: #8b4513;
          padding: 1rem 0.75rem;
          font-size: 0.85rem;
          font-weight: 500;
          background: linear-gradient(135deg, rgba(244, 241, 232, 0.9), rgba(255, 250, 240, 0.9));
          border: 1px dashed #d4af37;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(139, 69, 19, 0.1);
          position: relative;
          font-family: 'Noto Serif SC', serif;
        }

        .empty-uma::before {
          content: 'ğŸ';
          display: inline-block;
          font-size: 1.5rem;
          margin-right: 0.5rem;
          opacity: 0.7;
          vertical-align: middle;
        }

        .story-container {
          flex: 1;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .story-content {
          color: #2d2d2d;

          white-space: pre-wrap;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 1rem;

          line-height: 1.8;

          min-height: 200px;

          position: relative;
        }

        .story-text {
          margin: 0;
        }

        .input-section {
          background-color: #fdfbf7;

          border-top: 2px solid #8b6914;

          padding: 0.75rem;
        }

        .input-header {
          justify-content: flex-start;

          align-items: center;

          margin-bottom: 0.75rem;

          display: flex;

          flex-wrap: wrap;

          gap: 0.5rem;
        }

        .time-display {
          color: #8b4513;

          align-items: center;

          gap: 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: flex;
        }

        .time-display.compact {
          font-size: 0.75rem;

          gap: 0.5rem;
        }

        .time-display.compact .icon {
          width: 0.8rem;

          height: 0.8rem;
        }

        .compact-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));

          border: 1px solid rgba(139, 105, 20, 0.3);

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          color: #8b4513;

          cursor: pointer;

          transition: all 0.2s;

          display: flex;

          align-items: center;

          gap: 0.25rem;

          font-size: 0.7rem;

          font-weight: 600;
        }

        .compact-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));

          transform: translateY(-1px);

          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);

          border-color: rgba(139, 105, 20, 0.5);
        }

        .compact-button .icon {
          width: 14px;

          height: 14px;
        }

        .streaming-toggle.compact {
          font-size: 0.7rem;
          gap: 0.15rem;
        }

        .streaming-toggle.compact .toggle-label {
          font-size: 0.7rem;
        }

        .danger-button.compact {
          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          border-radius: 0.25rem;
        }

        .danger-level {
          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: inline-flex;
        }

        .danger-details {
          color: #78350f;

          white-space: pre-line;

          background: #fef3c7e6;

          border: 1px solid #f59e0b;

          border-radius: 0.5rem;

          margin-top: 0.5rem;

          padding: 1rem;

          font-size: 0.8rem;

          line-height: 1.6;
        }

        .danger-modal {
          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;
        }

        .danger-modal-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;
        }

        .danger-modal-content:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .danger-modal-header {
          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;
        }

        .danger-modal-header h3 {
          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);
        }

        .danger-modal-close {
          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;
        }

        .danger-modal-close:hover {
          background: #fff3;
        }

        .danger-modal-body {
          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .danger-current-period {
          text-align: center;

          color: #8b4513;

          background: #8b69141a;

          border: 2px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 1.5rem;

          padding: 1rem;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.1rem;

          font-weight: 600;
        }

        .danger-details-content {
          color: #654321;

          white-space: pre-line;

          background: #fff6;

          border: 1px solid #8b691433;

          border-radius: 0.75rem;

          padding: 1.5rem;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 0.9rem;

          line-height: 1.8;

          box-shadow: inset 0 2px 4px #0000001a;
        }

        .danger-details-content strong {
          color: #8b4513;

          font-weight: 600;
        }

        .danger-details-content .danger-stars {
          color: #d4af37;

          margin: 0.5rem 0;

          font-size: 1.1rem;
        }

        .danger-details-content .danger-suggestion {
          background: #8b69141a;

          border-left: 3px solid #8b6914;

          border-radius: 0.25rem;

          margin: 0.75rem 0;

          padding: 0.75rem;
        }

        .danger-level.safe {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;
        }

        .danger-level.low {
          color: #d97706;

          background: linear-gradient(135deg, #d977061a, #f59e0b1a);

          border: 1px solid #d97706;
        }

        .danger-level.medium {
          color: #ea580c;

          background: linear-gradient(135deg, #ea580c1a, #fb923c1a);

          border: 1px solid #ea580c;
        }

        .danger-level.high {
          color: #dc2626;

          background: linear-gradient(135deg, #dc26261a, #ef44441a);

          border: 1px solid #dc2626;
        }

        .danger-level.extreme {
          color: #1f2937;

          background: linear-gradient(135deg, #1f29371a, #3741511a);

          border: 1px solid #1f2937;
        }

        .danger-button {
          color: #8b0000;

          cursor: pointer;

          background-color: #8b00001a;

          border: 1px solid #8b0000;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.75rem;

          font-weight: 600;

          transition: all 0.2s;
        }

        .danger-button:hover {
          background-color: #8b000033;
        }

        .input-container {
          background-color: #8b69141a;

          border: 1px solid #8b6914;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          padding: 0.75rem;

          display: flex;
        }

        .input-prompt {
          color: #8b4513;

          font-size: 1.125rem;

          font-weight: 700;
        }

        .action-input {
          color: #2d2d2d;

          resize: vertical;

          background: 0 0;

          border: none;

          outline: none;

          flex: 1;

          min-height: 40px;

          max-height: 120px;

          font-family:
            Georgia,
            Times New Roman,
            serif;

          font-size: 0.875rem;

          font-weight: 500;

          line-height: 1.5;
        }

        .input-controls {
          align-items: center;

          gap: 0.5rem;

          margin-top: 0.5rem;

          display: flex;
        }

        .send-button {
          color: #fdfbf7;

          cursor: pointer;

          background: linear-gradient(135deg, #8b6914, sienna);

          border: none;

          border-radius: 0.375rem;

          padding: 0.5rem 1rem;

          font-size: 0.875rem;

          font-weight: 600;

          transition: all 0.2s;

          box-shadow: 0 2px 4px #0003;
        }

        .send-button:hover {
          background: linear-gradient(135deg, sienna, #8b6914);

          transform: translateY(-1px);

          box-shadow: 0 4px 8px #0000004d;
        }

        .send-button:active {
          transform: translateY(0);

          box-shadow: 0 2px 4px #0003;
        }

        .action-input::placeholder {
          color: #8b4513;
        }

        .rules-section,
        .uma-section {
          margin-bottom: 1rem;
        }

        .uma-section-header {
          cursor: pointer;

          background: #8b69140d;

          border-bottom: 1px solid #8b6914;

          border-radius: 0.25rem;

          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          display: flex;
        }

        .uma-section-header:hover {
          background-color: #8b69141a;

          border-radius: 0.25rem;
        }

        .uma-section-title {
          color: #2d2d2d;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .uma-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .uma-content {
          max-height: 300px;

          margin-top: 0.5rem;

          overflow: hidden auto;
        }

        .rules-list,
        .uma-list {
          flex-direction: column;

          gap: 0.5rem;

          display: flex;
        }

        .rule-item {
          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;
        }

        .rule-item:hover {
          box-shadow: 0 4px 8px #00000026;
        }

        .rule-item.dangerous-rule {
          background: linear-gradient(135deg, #8b00001a, #8b000033);

          border-left: 3px solid #8b0000;

          box-shadow: 0 2px 8px #8b000033;
        }

        .rule-item.dangerous-rule:hover {
          box-shadow: 0 4px 12px #8b00004d;
        }

        .rule-number {
          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;
        }

        .rule-text {
          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;
        }

        .dangerous-rule .rule-number {
          color: #8b0000;

          text-shadow: 0 1px 3px #8b00004d;
        }

        .dangerous-rule .rule-text {
          color: #8b0000;

          text-shadow: 0 0 2px #8b000033;
        }

        .fixed-rule {
          background: linear-gradient(135deg, #8b69141a, #d4af371a);

          border-left: 3px solid #8b6914;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          font-size: 0.75rem;

          line-height: 1.3;

          transition: all 0.3s;

          box-shadow: 0 2px 4px #0000001a;
        }

        .fixed-rule:hover {
          background: linear-gradient(135deg, #8b691426, #d4af3726);

          box-shadow: 0 4px 8px #00000026;
        }

        .fixed-rule .rule-number {
          color: #8b6914;

          text-shadow: 0 1px 2px #0000001a;

          margin-right: 0.75rem;

          font-size: 0.9rem;

          font-weight: 700;
        }

        .fixed-rule .rule-text {
          color: #2d2d2d;

          font-weight: 500;

          line-height: 1.3;
        }

        .view-rules-button {
          color: #e8d5d5;

          cursor: pointer;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #2d1b1b, #3d2b2b);

          border: 1px solid #8b0000;

          border-radius: 0.2rem;

          justify-content: center;

          align-items: center;

          gap: 0.15rem;

          width: 100%;

          padding: 0.15rem 0.25rem;

          font-size: 0.45rem;

          font-weight: 500;

          transition: all 0.2s;

          display: flex;

          position: relative;

          box-shadow:
            inset 0 1px #ffffff1a,
            0 2px 4px #0006;
        }

        .view-rules-button:before {
          content: '';

          opacity: 0;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.2s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .view-rules-button:hover:before {
          opacity: 1;
        }

        .view-rules-button:hover {
          color: #f0e0e0;

          background: linear-gradient(135deg, #3d2b2b, #4d3b3b);

          border-color: #a00000;

          box-shadow:
            inset 0 1px #ffffff26,
            0 3px 6px #00000080;
        }

        .view-rules-button:active {
          background: linear-gradient(135deg, #1d0b0b, #2d1b1b);

          box-shadow:
            inset 0 2px 4px #0009,
            0 1px 2px #0000004d;
        }

        .rules-modal {
          z-index: 1000;

          backdrop-filter: blur(4px);

          background: #000000b3;

          justify-content: center;

          align-items: center;

          width: 100%;

          height: 100%;

          display: flex;

          position: fixed;

          top: 0;

          left: 0;
        }

        .rules-modal-content {
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);

          border: 3px solid #8b6914;

          border-radius: 1rem;

          width: 90%;

          max-width: 600px;

          max-height: 80vh;

          position: relative;

          overflow: hidden;

          box-shadow: 0 20px 40px #0000004d;
        }

        /* å¡é¢å±•ç¤ºåŒºåŸŸæ ·å¼ */
        .card-display-section {
          margin-top: 0.75rem;
        }

        .card-display-icon {
          color: #8b6914;
          filter: drop-shadow(0 1px 2px rgba(139, 105, 20, 0.3));
          transition: all 0.3s ease;
          position: relative;
        }

        .card-display-icon::after {
          content: 'ğŸƒ';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 0.6em;
          opacity: 0.6;
          pointer-events: none;
        }

        .card-display-section:hover .card-display-icon {
          color: #a08659;
          transform: scale(1.1);
          filter: drop-shadow(0 2px 4px rgba(139, 105, 20, 0.5));
        }

        .card-display-section:hover .card-display-icon::after {
          opacity: 0.8;
          transform: translate(-50%, -50%) rotate(15deg);
        }

        /* å¡é¢å±•ç¤ºç½‘æ ¼æ ·å¼ */
        .card-display-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 18px; /* ğŸ”¥ å¢å¤§é—´è·ï¼Œæ›´ç¾è§‚ */
          padding: 25px; /* ğŸ”¥ å¢åŠ å†…è¾¹è· */
          max-height: 70vh;
          overflow-y: auto;
          background: rgba(253, 251, 247, 0.3); /* ğŸ”¥ æ·»åŠ è½»å¾®èƒŒæ™¯è‰²åŒºåˆ† */
          border-radius: 12px;
          margin: 15px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .card-display-grid::-webkit-scrollbar {
          width: 8px;
        }

        .card-display-grid::-webkit-scrollbar-track {
          background: rgba(139, 105, 20, 0.1);
          border-radius: 4px;
        }

        /* äººç‰©è¡¨æƒ…å±•ç¤ºåŒºåŸŸæ ·å¼ */
        .uma-expression-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 20px;
          padding: 10px;
          max-height: 60vh;
          overflow-y: auto;
        }

        .uma-expression-grid::-webkit-scrollbar {
          width: 8px;
        }

        .uma-expression-grid::-webkit-scrollbar-track {
          background: rgba(139, 105, 20, 0.1);
          border-radius: 4px;
        }

        .uma-expression-grid::-webkit-scrollbar-thumb {
          background: rgba(139, 105, 20, 0.3);
          border-radius: 4px;
        }

        .uma-expression-grid::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 105, 20, 0.5);
        }

        .uma-expression-item {
          display: flex;
          justify-content: center;
          align-items: center;
        }

        .uma-expression-card {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(244, 241, 232, 0.95) 100%);
          border: 2px solid #8b4513;
          border-radius: 12px;
          padding: 15px;
          text-align: center;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(139, 69, 19, 0.15);
          width: 100%;
          max-width: 200px;
        }

        .uma-expression-card:hover {
          transform: translateY(-5px) scale(1.02);
          box-shadow: 0 6px 16px rgba(139, 69, 19, 0.3);
          border-color: #d4af37;
        }

        .uma-expression-name {
          font-size: 1em;
          font-weight: bold;
          color: #8b4513;
          margin-bottom: 8px;
          text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.1);
        }

        .uma-expression-status {
          font-size: 0.85em;
          color: #654321;
          margin-bottom: 10px;
          opacity: 0.8;
        }

        .uma-expression-image {
          width: 100%;
          max-width: 150px;
          height: auto;
          border: 2px solid #d4af37;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(139, 69, 19, 0.2);
          background: rgba(255, 255, 255, 0.5);
          object-fit: contain;
          transition:
            transform 0.3s ease,
            box-shadow 0.3s ease;
        }

        .uma-expression-card:hover .uma-expression-image {
          transform: scale(1.05);
          box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .card-display-grid::-webkit-scrollbar-thumb {
          background: rgba(139, 105, 20, 0.3);
          border-radius: 4px;
        }

        .card-display-grid::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 105, 20, 0.5);
        }

        .card-display-item {
          position: relative;
          aspect-ratio: 1;
          border-radius: 12px; /* ğŸ”¥ æ›´åœ†æ¶¦çš„è¾¹è§’ */
          overflow: hidden;
          cursor: pointer;
          transition:
            transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            box-shadow 0.3s ease,
            border-color 0.3s ease; /* ğŸ”¥ æ·»åŠ è¾¹æ¡†è¿‡æ¸¡ */
          background: #fff;
          border: 2px solid rgba(139, 105, 20, 0.2); /* ğŸ”¥ æ·»åŠ è¾¹æ¡† */
          box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.1),
            0 2px 4px rgba(139, 105, 20, 0.08); /* ğŸ”¥ æ›´ç«‹ä½“çš„é˜´å½± */
        }

        .card-display-item:hover {
          transform: translateY(-4px) scale(1.03); /* ğŸ”¥ æ·»åŠ å‘ä¸Šæµ®åŠ¨æ•ˆæœ */
          box-shadow:
            0 8px 24px rgba(139, 105, 20, 0.25),
            0 4px 8px rgba(0, 0, 0, 0.15); /* ğŸ”¥ æ›´å¼ºçš„é˜´å½±æ•ˆæœ */
          border-color: rgba(139, 105, 20, 0.5); /* ğŸ”¥ æ‚¬åœæ—¶è¾¹æ¡†å˜æ·± */
        }

        .card-display-item img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          display: block;
          transition: transform 0.3s ease;
        }

        .card-display-item:hover img {
          transform: scale(1.05); /* ğŸ”¥ å›¾ç‰‡ç¨å¾®æ”¾å¤§ */
        }

        /* å¡é¢å±•ç¤ºæ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ */
        #card-display-modal .rules-modal-content {
          max-width: 90%;
          width: 1200px;
          max-height: 90vh;
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 50%, #ede8dd 100%); /* ğŸ”¥ æ›´ä¸°å¯Œçš„æ¸å˜èƒŒæ™¯ */
          border: 3px solid #8b6914;
          border-radius: 16px; /* ğŸ”¥ æ›´å¤§çš„åœ†è§’ */
          box-shadow:
            0 25px 50px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(139, 105, 20, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.5); /* ğŸ”¥ æ›´ç«‹ä½“çš„é˜´å½± */
          position: relative;
          overflow: hidden;
        }

        /* ğŸ”¥ card-display-modal-contentçš„è£…é¥°æ•ˆæœ */
        #card-display-modal .rules-modal-content::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(
            90deg,
            rgba(139, 105, 20, 0.8) 0%,
            rgba(160, 130, 105, 0.9) 50%,
            rgba(139, 105, 20, 0.8) 100%
          );
          z-index: 1;
        }

        #card-display-modal .rules-modal-body {
          padding: 0;
          overflow: hidden;
        }

        /* å…¨å±æ¨¡å¼ä¸‹çš„å¡é¢å±•ç¤ºæ¨¡æ€æ¡†æ€§èƒ½ä¼˜åŒ– */
        #teresen-fullscreen-overlay #card-display-modal {
          /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘backdrop-filteråœ¨å…¨å±æ¨¡å¼ä¸‹çš„ä½¿ç”¨ */
          backdrop-filter: none !important;
        }

        #teresen-fullscreen-overlay #card-display-modal .rules-modal-content {
          max-width: 95%;
          width: 1400px;
          max-height: 95vh;
          /* æ€§èƒ½ä¼˜åŒ–ï¼šç¡¬ä»¶åŠ é€Ÿ */
          will-change: transform;
          transform: translateZ(0);
        }

        #teresen-fullscreen-overlay #card-display-modal .card-display-grid {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
          gap: 20px;
          max-height: 85vh;
          /* æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨GPUåŠ é€Ÿæ»šåŠ¨ */
          will-change: scroll-position;
          transform: translateZ(0);
        }

        /* å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡† */
        .card-image-viewer {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.95);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          /* æ€§èƒ½ä¼˜åŒ–ï¼šç¡¬ä»¶åŠ é€Ÿ */
          will-change: opacity;
          transform: translateZ(0);
          backface-visibility: hidden;
          /* å‡å°‘é‡ç»˜ */
          contain: layout style paint;
        }

        /* å…¨å±æ¨¡å¼ä¸‹çš„å›¾ç‰‡æŸ¥çœ‹å™¨ */
        .connected-panels.fullscreen-active ~ .card-image-viewer,
        #teresen-fullscreen-overlay .card-image-viewer {
          z-index: 100002 !important; /* é«˜äºå¡é¢å±•ç¤ºæ¨¡æ€æ¡†ï¼ˆ100001ï¼‰ */
        }

        .card-image-viewer img {
          max-width: 90%;
          max-height: 90%;
          object-fit: contain;
          border-radius: 8px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
          /* æ€§èƒ½ä¼˜åŒ–ï¼šç¡¬ä»¶åŠ é€Ÿå’Œå›¾ç‰‡ä¼˜åŒ– */
          will-change: transform;
          transform: translateZ(0);
          image-rendering: -webkit-optimize-contrast;
          image-rendering: crisp-edges;
        }

        /* å›¾ç‰‡åŠ è½½çŠ¶æ€ */
        .card-image-viewer img[data-loading='true'] {
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .card-image-viewer img[data-loaded='true'] {
          opacity: 1;
        }

        .card-image-viewer .close-viewer {
          position: absolute;
          top: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.2);
          border: 2px solid rgba(255, 255, 255, 0.5);
          color: white;
          font-size: 30px;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          /* æ€§èƒ½ä¼˜åŒ–ï¼šåªè¿‡æ¸¡èƒŒæ™¯è‰²ï¼Œä½¿ç”¨transformè¿›è¡Œæ—‹è½¬ */
          transition: background-color 0.3s ease;
          will-change: transform, background-color;
          transform: translateZ(0);
        }

        .card-image-viewer .close-viewer:hover {
          background: rgba(255, 255, 255, 0.3);
          transform: translateZ(0) rotate(90deg);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */

        #talents-modal .current-talents::-webkit-scrollbar,
        #talents-modal .upgrade-options::-webkit-scrollbar {
          width: 8px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-track,
        #talents-modal .upgrade-options::-webkit-scrollbar-track {
          background: rgba(139, 69, 19, 0.1);

          border-radius: 4px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-thumb,
        #talents-modal .upgrade-options::-webkit-scrollbar-thumb {
          background: rgba(139, 69, 19, 0.3);

          border-radius: 4px;
        }

        #talents-modal .current-talents::-webkit-scrollbar-thumb:hover,
        #talents-modal .upgrade-options::-webkit-scrollbar-thumb:hover {
          background: rgba(139, 69, 19, 0.5);
        }

        /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ - é’ˆå¯¹é‚£äº›ç°è‰²çš„æ»šåŠ¨æ¡ */

        ::-webkit-scrollbar {
          width: 4px;
        }

        ::-webkit-scrollbar-track {
          background: rgba(240, 240, 240, 0.3);

          border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
          background: rgba(180, 180, 180, 0.4);

          border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: rgba(160, 160, 160, 0.6);
        }

        .rules-modal-content:before {
          content: '';

          pointer-events: none;

          background-image:
            radial-gradient(circle at 20% 30%, #8b69140d 2px, #0000 4px),
            radial-gradient(circle at 80% 70%, #a086590a 1px, #0000 3px);

          background-size:
            60px 60px,
            40px 40px;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .rules-modal-header {
          color: #fdfbf7;

          background: linear-gradient(135deg, #8b6914, #a0865a);

          border-bottom: 2px solid #654321;

          justify-content: space-between;

          align-items: center;

          padding: 1rem 1.5rem;

          display: flex;
        }

        .rules-title {
          text-shadow: 0 2px 4px #0000004d;

          margin: 0;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.5rem;

          font-weight: 700;

          transform: rotate(-1deg);
        }

        .close-rules-btn {
          color: #fdfbf7;

          cursor: pointer;

          background: 0 0;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 1.5rem;

          transition: all 0.2s;
        }

        .close-rules-btn:hover {
          background: #fff3;
        }

        .rules-modal-body {
          max-height: 60vh;

          padding: 1.5rem;

          overflow-y: auto;
        }

        .book-tab:hover {
          transform: translateY(-3px) !important;

          box-shadow: 0 -4px 16px rgba(139, 105, 20, 0.4) !important;
        }

        .book-page-content {
          position: relative;

          overflow: hidden;
        }

        .book-page-content::before {
          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);
        }

        .book-page-content::after {
          content: '';

          position: absolute;

          bottom: 0;

          left: 0;

          right: 0;

          height: 1px;

          background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.3), transparent);
        }

        .rules-section-fixed,
        .rules-section-random {
          margin-bottom: 2rem;
        }

        .rules-section-title {
          color: #8b4513;

          border-bottom: 2px solid #d4af37;

          margin-bottom: 1rem;

          padding-bottom: 0.5rem;

          font-family:
            Brush Script MT,
            cursive;

          font-size: 1.2rem;

          font-weight: 700;

          transform: rotate(1deg);
        }

        .rules-list-handwritten {
          color: #2d2d2d;

          text-shadow: 0 1px 1px #fffc;

          font-family:
            Segoe Script,
            Brush Script MT,
            Georgia,
            serif;

          font-size: 0.95rem;

          font-weight: 500;

          line-height: 1.7;
        }

        .rule-item-handwritten {
          background: #fff9;

          border-left: 3px solid #d4af37;

          border-radius: 0.25rem;

          gap: 0.75rem;

          margin-bottom: 0.75rem;

          padding: 0.5rem;

          transition: all 0.3s;

          display: flex;
        }

        .rule-item-handwritten:hover {
          background: #fffc;

          transform: translate(4px);
        }

        .rule-number-handwritten {
          color: #8b6914;

          min-width: 1.5rem;

          font-size: 1rem;

          font-weight: 700;
        }

        .rule-text-handwritten {
          flex: 1;

          font-style: normal;

          font-weight: 500;
        }

        /* è§„åˆ™è®°å½•åŠŸèƒ½æ ·å¼ */
        .rules-record-controls {
          display: flex;
          gap: 0.5rem;
          margin-bottom: 1rem;
        }

        .add-rule-btn,
        .clear-rules-btn {
          background: linear-gradient(135deg, #8b4513, #a0522d);
          color: white;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          font-family: 'Segoe Script', cursive;
        }

        .add-rule-btn:hover,
        .clear-rules-btn:hover {
          background: linear-gradient(135deg, #a0522d, #cd853f);
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
        }

        .clear-rules-btn {
          background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .clear-rules-btn:hover {
          background: linear-gradient(135deg, #ef4444, #f87171);
        }

        .rule-item-editable {
          position: relative;
          padding-right: 2rem;
        }

        .rule-edit-btn,
        .rule-delete-btn {
          position: absolute;
          right: 0.25rem;
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          color: #8b4513;
          cursor: pointer;
          font-size: 0.8rem;
          padding: 0.1rem;
          border-radius: 0.2rem;
          transition: all 0.2s;
        }

        .rule-edit-btn {
          right: 1.5rem;
        }

        .rule-edit-btn:hover,
        .rule-delete-btn:hover {
          background: rgba(139, 69, 19, 0.1);
          color: #a0522d;
        }

        .rule-delete-btn:hover {
          color: #dc2626;
        }

        .rule-input {
          width: 100%;
          background: #fff9;
          border: 1px solid #d4af37;
          border-radius: 0.25rem;
          padding: 0.25rem 0.5rem;
          font-family: 'Segoe Script', cursive;
          font-size: 0.9rem;
          color: #2d2d2d;
          resize: vertical;
          min-height: 2rem;
        }

        .rule-input:focus {
          outline: none;
          border-color: #8b4513;
          background: #fffc;
        }

        .empty-rules {
          color: #8b4513;
          font-style: italic;
          text-align: center;
          padding: 1rem;
          background: rgba(139, 69, 19, 0.1);
          border-radius: 0.25rem;
          border: 1px dashed #d4af37;
        }
        .location-display {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .inventory-item {
          background: linear-gradient(145deg, #ffffffb3, #8b69141a);

          border: 1px solid #d4af37;

          border-radius: 0.5rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          transition: all 0.3s;

          position: relative;

          box-shadow: 0 2px 6px #0000001a;

          display: flex;

          align-items: center;

          gap: 0.5rem;
        }

        .item-icon {
          font-size: 1.5rem;

          line-height: 1;

          flex-shrink: 0;

          display: inline-block;
        }

        .item-header {
          display: flex;

          align-items: center;

          gap: 0.5rem;

          width: 100%;
        }

        .inventory-item:before {
          content: '';

          opacity: 0.6;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;
        }

        .inventory-item:hover {
          border-color: gold;

          box-shadow: 0 4px 10px #00000026;
        }

        .uma-item {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 20% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;

          border: 1px solid #d4af37 !important;

          border-radius: 0.5rem;

          margin-bottom: 0.75rem;

          padding: 0.75rem;

          transition: all 0.3s;

          position: relative;

          overflow: visible;

          box-shadow:
            0 2px 8px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2),
            inset 0 -1px 0 rgba(0, 0, 0, 0.05) !important;
        }

        /* å¼ºåˆ¶è¦†ç›–ä»»ä½•å¯èƒ½çš„èƒŒæ™¯è‰²è®¾ç½® */

        .uma-item[style*='background'] {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;
        }

        /* æœ€é«˜ä¼˜å…ˆçº§å¼ºåˆ¶è®¾ç½® */

        div.uma-item,
        .uma-item,
        .uma-item[style],
        .parchment-page .uma-item,
        .panel-content .uma-item {
          background:
            linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(139, 105, 20, 0.1)),
            radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 60%),
            radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
            linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.05) 50%, transparent 70%) !important;

          background-color: transparent !important;
        }

        .uma-item:before {
          content: '';

          opacity: 0.7;

          background: linear-gradient(90deg, #d4af37, gold, #d4af37);

          height: 2px;

          position: absolute;

          top: 0;

          left: 0;

          right: 0;
        }

        /* å¡”ç½—å åœæ ·å¼ */
        .tarot-divination {
          color: #8b6914;
          background: #ffffffe6;
          border: 1px solid #d4af37;
          border-radius: 0.375rem;
          align-items: center;
          gap: 0.5rem;
          min-width: -moz-fit-content;
          min-width: fit-content;
          padding: 0.25rem 0.75rem;
          font-size: 0.8rem;
          font-weight: 600;
          display: flex;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }

        .tarot-divination:hover {
          background: #ffffff;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: #8b6914;
        }

        .tarot-modal-content {
          max-width: 800px;
          max-height: 90vh;
        }

        .tarot-info {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #8b4513;
        }

        .tarot-info p {
          margin: 0.25rem 0;
          font-weight: 600;
        }

        .spread-buttons {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 1.5rem;
        }

        .spread-btn {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 1rem;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
          color: #8b4513;
          font-weight: 600;
          position: relative;
        }

        .spread-btn:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .spread-btn.disabled {
          opacity: 0.5;
          cursor: not-allowed;
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.05), rgba(139, 105, 20, 0.02));
        }

        .spread-btn.advanced {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
          border-color: rgba(34, 197, 94, 0.3);
          color: #22c55e;
        }

        .spread-btn.advanced:hover:not(.disabled) {
          background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
          box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
          border-color: rgba(34, 197, 94, 0.5);
        }

        .spread-icon {
          font-size: 1.5rem;
        }

        .spread-name {
          font-size: 0.9rem;
          font-weight: 700;
        }

        .spread-cost {
          font-size: 0.8rem;
          color: #6b7280;
        }

        .spread-requirement {
          font-size: 0.7rem;
          color: #f59e0b;
          font-weight: 600;
        }

        .tarot-result {
          background: linear-gradient(135deg, #4c1d951a, #7c3aed1a);
          border: 1px solid #a855f7;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-top: 1rem;
        }

        .tarot-cards {
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          margin-bottom: 1rem;
        }

        .tarot-card {
          background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
          border: 2px solid #d1d5db;
          border-radius: 0.5rem;
          padding: 1rem;
          min-width: 120px;
          text-align: center;
          position: relative;
          cursor: pointer;
          transition: all 0.3s;
        }

        .tarot-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .tarot-card.reversed {
          transform: rotate(180deg);
        }

        .tarot-card-name {
          font-weight: 700;
          color: #374151;
          margin-bottom: 0.5rem;
        }

        .tarot-card-meaning {
          font-size: 0.8rem;
          color: #6b7280;
        }

        .tarot-interpretation {
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          border-radius: 0.5rem;
          padding: 1rem;
          margin-bottom: 1rem;
          color: #374151;
        }

        .tarot-effects {
          background: linear-gradient(135deg, #fef3c7, #fde68a);
          border: 1px solid #f59e0b;
          border-radius: 0.5rem;
          padding: 1rem;
          color: #92400e;
        }

        .tarot-effects h4 {
          margin: 0 0 0.5rem 0;
          color: #92400e;
        }

        .tarot-effects ul {
          margin: 0;
          padding-left: 1.5rem;
        }

        .tarot-effects li {
          margin: 0.25rem 0;
        }

        /* ç¥ç¤¾ç¥ˆç¦æ ·å¼ */
        .omikuji-container {
          background: linear-gradient(135deg, #fffaf0, #fef5e7);
          border: 2px solid #8b6914;
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 15px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
          color: #2d2d2d;
          text-align: center;
        }

        .omikuji-fortune {
          font-size: 2.5em;
          font-weight: bold;
          color: #8b6914;
          border-bottom: 2px dashed rgba(139, 105, 20, 0.3);
          padding-bottom: 10px;
          margin-bottom: 10px;
        }

        .omikuji-desc {
          font-style: italic;
          color: #8b6914;
          margin-bottom: 20px;
          font-size: 1.1rem;
        }

        .omikuji-items {
          list-style: none;
          padding: 0;
          text-align: left;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
        }

        .omikuji-items li {
          background: rgba(139, 105, 20, 0.1);
          padding: 8px;
          border-radius: 6px;
          border: 1px solid rgba(139, 105, 20, 0.2);
        }

        .omikuji-items li strong {
          color: #8b6914;
        }

        .shrine-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .shrine-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none !important;
        }

        .uma-item::after {
          content: '';

          position: absolute;

          top: 0;

          left: 0;

          right: 0;

          bottom: 0;

          background:
            radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
            radial-gradient(circle at 70% 80%, rgba(212, 175, 55, 0.06) 0%, transparent 50%),
            linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.02) 50%, transparent 60%);

          pointer-events: none;

          z-index: 1;
        }

        .uma-item:hover {
          border-color: gold;

          box-shadow:
            0 4px 12px rgba(0, 0, 0, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.3),
            inset 0 -1px 0 rgba(0, 0, 0, 0.1);

          transform: translateY(-1px);
        }

        .uma-header {
          justify-content: space-between;

          align-items: center;

          margin-bottom: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;
        }

        .uma-info {
          align-items: center;

          gap: 0.5rem;

          display: flex;
        }

        .uma-name {
          color: #dc2626;

          text-shadow: 0 1px 2px #00000040;

          letter-spacing: 0.5px;

          font-size: 1rem;

          font-weight: 700;

          margin-bottom: 0.2rem;
        }

        .uma-text-info {
          display: flex;

          flex-direction: column;

          gap: 0.15rem;

          justify-content: center;
        }

        .uma-name {
          font-size: 1rem;

          font-weight: 600;

          line-height: 1.2;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .uma-status-text {
          font-size: 0.7rem;

          font-weight: 400;

          opacity: 0.9;

          transition: all 0.3s ease;

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);

          border-radius: 0.3rem;

          padding: 0.1rem 0.3rem;

          background: rgba(255, 255, 255, 0.85);

          backdrop-filter: blur(3px);

          border: 1px solid rgba(212, 175, 55, 0.2);

          color: #ff69b4 !important;

          letter-spacing: 0.2px;

          box-shadow: 0 1px 3px rgba(212, 175, 55, 0.15);
        }

        /* ä¸åŒçŠ¶æ€æ–‡å­—çš„ç¾åŒ–æ ·å¼ */
        .uma-status-text[style*='color: #059669'] {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.12), rgba(5, 150, 105, 0.08));

          border-color: rgba(5, 150, 105, 0.25);

          color: #059669 !important;

          box-shadow: 0 1px 3px rgba(5, 150, 105, 0.15);
        }

        .uma-status-text[style*='color: #8b0000'] {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.12), rgba(139, 0, 0, 0.08));

          border-color: rgba(139, 0, 0, 0.25);

          color: #8b0000 !important;

          box-shadow: 0 1px 3px rgba(139, 0, 0, 0.15);
        }

        .uma-status-text[style*='color: #6b7280'] {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.12), rgba(107, 114, 128, 0.08));

          border-color: rgba(107, 114, 128, 0.25);

          color: #6b7280 !important;

          box-shadow: 0 1px 3px rgba(107, 114, 128, 0.15);
        }

        .uma-status-text[style*='color: #f59e0b'] {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.08));

          border-color: rgba(245, 158, 11, 0.25);

          color: #dc2626 !important;

          box-shadow: 0 1px 3px rgba(245, 158, 11, 0.15);
        }

        .uma-status-text[style*='color: #ef4444'] {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.08));

          border-color: rgba(239, 68, 68, 0.25);

          color: #ef4444 !important;

          box-shadow: 0 1px 3px rgba(239, 68, 68, 0.15);
        }

        .uma-status-text[style*='color: #dc2626'] {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(185, 28, 28, 0.1));

          border-color: rgba(220, 38, 38, 0.3);

          color: #dc2626 !important;

          box-shadow: 0 1px 4px rgba(220, 38, 38, 0.2);
        }

        /* çŠ¶æ€æ–‡å­—æ‚¬åœæ•ˆæœ */
        .uma-status-text:hover {
          transform: translateY(-0.5px);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);

          transition: all 0.3s ease;
        }

        .uma-avatar-container {
          position: relative;

          display: inline-block;
        }

        .uma-avatar {
          width: 3rem;

          height: 3rem;

          border-radius: 50%;

          object-fit: cover;

          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .avatar-decoration {
          position: absolute;

          top: -0.5rem;

          right: -0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.2rem;

          height: 1.2rem;

          font-size: 0.8rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));

          backdrop-filter: blur(5px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);

          z-index: 10;

          animation: decorationFloat 2s ease-in-out infinite;
        }

        .uma-status-decoration {
          position: absolute;

          top: 0.5rem;

          right: 0.5rem;

          display: flex;

          align-items: center;

          justify-content: center;

          width: 1.5rem;

          height: 1.5rem;

          font-size: 1rem;

          border-radius: 50%;

          background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));

          backdrop-filter: blur(10px);

          border: 1px solid rgba(255, 255, 255, 0.3);

          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);

          transition: all 0.3s ease;

          animation: decorationFloat 3s ease-in-out infinite;

          z-index: 10;
        }

        .uma-status-decoration:hover {
          transform: scale(1.1) rotate(5deg);

          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        @keyframes decorationFloat {
          0%,
          100% {
            transform: translateY(0px);
          }

          50% {
            transform: translateY(-3px);
          }
        }

        /* ä¸åŒçŠ¶æ€çš„å¤´åƒè£…é¥°æ ·å¼ */
        .uma-avatar-container.normal .avatar-decoration {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.9), rgba(5, 150, 105, 0.7));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;
        }

        .uma-avatar-container.possessed .avatar-decoration {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(139, 0, 0, 0.7));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation:
            decorationFloat 2s ease-in-out infinite,
            possessedGlow 1.5s ease-in-out infinite alternate;
        }

        .uma-avatar-container.missing .avatar-decoration {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.9), rgba(107, 114, 128, 0.7));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;
        }

        .uma-avatar-container.confused .avatar-decoration {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(245, 158, 11, 0.7));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation:
            decorationFloat 1.5s ease-in-out infinite,
            confusedSpin 3s linear infinite;
        }

        .uma-avatar-container.alert .avatar-decoration {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(239, 68, 68, 0.7));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation:
            decorationFloat 1s ease-in-out infinite,
            alertPulse 0.8s ease-in-out infinite;
        }

        .uma-avatar-container.yandere .avatar-decoration {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.9), rgba(185, 28, 28, 0.8));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation:
            decorationFloat 0.8s ease-in-out infinite,
            yandereShake 0.5s ease-in-out infinite;
        }

        /* ä¸åŒçŠ¶æ€çš„è£…é¥°æ ·å¼ */
        .uma-status-decoration.normal {
          background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(5, 150, 105, 0.1));

          border-color: rgba(5, 150, 105, 0.3);

          color: #059669;
        }

        .uma-status-decoration.possessed {
          background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(139, 0, 0, 0.1));

          border-color: rgba(139, 0, 0, 0.3);

          color: #8b0000;

          animation:
            decorationFloat 2s ease-in-out infinite,
            possessedGlow 1.5s ease-in-out infinite alternate;
        }

        .uma-status-decoration.missing {
          background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));

          border-color: rgba(107, 114, 128, 0.3);

          color: #6b7280;
        }

        .uma-status-decoration.confused {
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));

          border-color: rgba(245, 158, 11, 0.3);

          color: #f59e0b;

          animation:
            decorationFloat 1.5s ease-in-out infinite,
            confusedSpin 3s linear infinite;
        }

        .uma-status-decoration.alert {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));

          border-color: rgba(239, 68, 68, 0.3);

          color: #ef4444;

          animation:
            decorationFloat 1s ease-in-out infinite,
            alertPulse 0.8s ease-in-out infinite;
        }

        .uma-status-decoration.yandere {
          background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(185, 28, 28, 0.2));

          border-color: rgba(220, 38, 38, 0.4);

          color: #dc2626;

          animation:
            decorationFloat 0.8s ease-in-out infinite,
            yandereShake 0.5s ease-in-out infinite;
        }

        /* ç‰¹æ®ŠåŠ¨ç”»æ•ˆæœ */
        @keyframes possessedGlow {
          0%,
          100% {
            box-shadow: 0 2px 8px rgba(139, 0, 0, 0.3);
          }

          50% {
            box-shadow: 0 2px 16px rgba(139, 0, 0, 0.6);
          }
        }

        @keyframes confusedSpin {
          0% {
            transform: translateY(0px) rotate(0deg);
          }

          50% {
            transform: translateY(-3px) rotate(180deg);
          }

          100% {
            transform: translateY(0px) rotate(360deg);
          }
        }

        @keyframes alertPulse {
          0%,
          100% {
            transform: scale(1);
          }

          50% {
            transform: scale(1.1);
          }
        }

        @keyframes yandereShake {
          0%,
          100% {
            transform: translateX(0px);
          }

          25% {
            transform: translateX(-2px);
          }

          75% {
            transform: translateX(2px);
          }
        }

        .uma-status-badge {
          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;

          transition: all 0.3s ease;
        }

        .uma-status {
          text-transform: uppercase;

          letter-spacing: 0.5px;

          border-radius: 0.75rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          font-weight: 600;

          box-shadow: 0 1px 3px #0003;
        }

        .uma-status-badge.normal {
          color: #fff;

          background: linear-gradient(135deg, #059669cc, #05966999);

          border: 1px solid #0596694d;
        }

        .uma-status-badge.possessed {
          color: #fff;

          background: linear-gradient(135deg, #8b0000cc, #8b000099);

          border: 1px solid #8b00004d;
        }

        .uma-status-badge.missing {
          color: #fff;

          background: linear-gradient(135deg, #6b7280cc, #6b728099);

          border: 1px solid #6b72804d;
        }

        .uma-status-badge.confused {
          color: #fff;

          background: linear-gradient(135deg, #f59e0bcc, #f59e0b99);

          border: 1px solid #f59e0b4d;
        }

        .uma-status-badge.alert {
          color: #fff;

          background: linear-gradient(135deg, #ef4444cc, #ef444499);

          border: 1px solid #ef44444d;
        }

        .uma-status-badge.yandere {
          color: #fff;

          text-shadow: 0 1px 2px #00000080;

          background: linear-gradient(135deg, #dc2626e6, #b91c1ccc);

          border: 2px solid #dc262680;

          font-weight: 700;

          animation: 2s ease-in-out infinite yanderePulse;

          box-shadow: 0 0 10px #dc262666;
        }

        @keyframes yanderePulse {
          0%,
          to {
            box-shadow: 0 0 10px #dc262666;
          }

          50% {
            box-shadow:
              0 0 20px #dc2626b3,
              0 0 30px #dc26264d;
          }
        }

        @keyframes bloodGlow {
          0% {
            transform: rotate(0);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }

          25% {
            transform: rotate(90deg);

            box-shadow:
              0 0 25px #ff0000e6,
              0 0 50px #ff000080,
              0 0 75px #ff00004d;
          }

          50% {
            transform: rotate(180deg);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }

          75% {
            transform: rotate(270deg);

            box-shadow:
              0 0 25px #ff0000e6,
              0 0 50px #ff000080,
              0 0 75px #ff00004d;
          }

          to {
            transform: rotate(360deg);

            box-shadow:
              0 0 20px #f00c,
              0 0 40px #f006,
              0 0 60px #f003;
          }
        }

        .uma-status.worried {
          color: #fff;

          background: linear-gradient(135deg, #a855f7cc, #a855f799);

          border: 1px solid #a855f74d;
        }

        .uma-status.protect {
          color: #fff;

          background: linear-gradient(135deg, #22c55ecc, #22c55e99);

          border: 1px solid #22c55e4d;
        }

        .uma-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin: 0.5rem 0;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;

          position: relative;

          z-index: 2;
        }

        .uma-hearts {
          justify-content: center;

          gap: 0.25rem;

          margin-top: 0.5rem;

          display: flex;

          position: relative;

          z-index: 2;
        }

        .heart {
          color: #dc2626;

          text-shadow: 0 2px 4px #dc26264d;

          font-size: 1rem;

          animation: 2s ease-in-out infinite heartBeat;

          display: inline-block;
        }

        .heart:nth-child(2) {
          animation-delay: 0.2s;
        }

        .heart:nth-child(3) {
          animation-delay: 0.4s;
        }

        .heart:nth-child(4) {
          animation-delay: 0.6s;
        }

        .heart:nth-child(5) {
          animation-delay: 0.8s;
        }

        @keyframes heartBeat {
          0%,
          to {
            transform: scale(1);
          }

          50% {
            transform: scale(1.1);
          }
        }

        .twisted-love-accent {
          color: #8b0000;

          text-shadow: 0 0 3px #8b000066;

          font-weight: 700;
        }

        .horror-glow {
          color: #8b0000;

          text-shadow: 0 0 4px #8b000099;
        }

        .typewriter-cursor {
          color: #8b0000;

          animation: 1.2s infinite blink;
        }

        @keyframes blink {
          0%,
          50% {
            opacity: 1;
          }

          51%,
          to {
            opacity: 0;
          }
        }

        @keyframes subtle-pulse {
          0%,
          to {
            opacity: 0.8;

            transform: scale(1);
          }

          50% {
            opacity: 1;

            transform: scale(1.02);
          }
        }

        .subtle-hover {
          transition: all 0.2s;
        }

        .subtle-hover:hover {
          transform: translateY(-1px);

          box-shadow: 0 2px 4px #0000004d;
        }

        .inventory-item {
          background: #ffffffb3;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          margin-bottom: 0.5rem;

          padding: 0.5rem;

          box-shadow: 0 2px 4px #0000001a;
        }

        .item-header {
          cursor: pointer;

          z-index: 10;

          -webkit-user-select: none;

          user-select: none;

          justify-content: space-between;

          align-items: center;

          padding: 0.25rem 0;

          display: flex;

          position: relative;
        }

        .item-header:hover {
          background-color: #d4af371a;

          border-radius: 0.25rem;
        }

        .item-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .item-name {
          color: #8b6914;

          flex: 1;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .item-details {
          border-top: 1px solid #d4af374d;

          margin-top: 0.5rem;

          padding-top: 0.5rem;
        }

        .item-detail-popup {
          z-index: 100;

          background: #fffffff2;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          min-width: 180px;

          max-width: 250px;

          padding: 0.75rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;
        }

        .skill-detail-popup {
          z-index: 100;

          background: #fffffff2;

          border: 1px solid #805ad5;

          border-radius: 0.375rem;

          min-width: 150px;

          max-width: 200px;

          padding: 0.5rem;

          font-size: 0.75rem;

          position: absolute;

          top: -10px;

          left: 0;

          box-shadow: 0 2px 8px #0003;
        }

        .skill-popup:after {
          content: '';

          border-top: 5px solid #805ad5;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;
        }

        .skill-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.4;
        }

        .skill-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 12px;
          padding-bottom: 8px;
          border-bottom: 1px solid rgba(139, 69, 19, 0.2);
        }

        .skill-title {
          font-size: 16px;
          font-weight: bold;
          color: #8b4513;
        }

        .skill-use-btn {
          background: linear-gradient(135deg, #805ad5, #6b46c1);

          color: white;

          border: none;

          border-radius: 0.25rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.7rem;

          cursor: pointer;

          margin: 0.25rem 0.25rem 0 0;

          transition: all 0.2s;
        }

        .skill-use-btn:hover {
          background: linear-gradient(135deg, #6b46c1, #553c9a);

          transform: translateY(-1px);
        }

        .item-popup.show {
          display: block;
        }

        .item-popup:after {
          content: '';

          border-top: 5px solid #d4af37;

          border-left: 5px solid #0000;

          border-right: 5px solid #0000;

          width: 0;

          height: 0;

          position: absolute;

          top: 100%;

          left: 1rem;
        }

        .item-desc {
          color: #654321;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.75rem;

          font-size: 0.8rem;

          font-style: italic;

          line-height: 1.5;
        }

        .item-effect {
          color: #059669;

          text-shadow: 0 1px 1px #ffffff80;

          margin-bottom: 0.5rem;

          font-size: 0.8rem;

          font-weight: 600;
        }

        .item-rarity {
          border-radius: 0.375rem;

          padding: 0.25rem 0.5rem;

          font-size: 0.75rem;

          font-weight: 600;

          display: inline-block;

          text-align: center;
        }

        /* ç¨€æœ‰åº¦æ ·å¼ */

        .rarity-æ™®é€š {
          color: #696969;

          background: linear-gradient(135deg, #f5f5f5, #e0e0e0);

          border: 2px solid #b0b0b0;

          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .rarity-ç¨€æœ‰ {
          color: #2563eb;

          background: linear-gradient(135deg, #dbeafe, #bfdbfe);

          border: 2px solid #3b82f6;

          box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);

          text-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }

        .rarity-å²è¯— {
          color: #7c3aed;

          background: linear-gradient(135deg, #ede9fe, #ddd6fe);

          border: 2px solid #8b5cf6;

          box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);

          text-shadow: 0 1px 2px rgba(139, 92, 246, 0.2);
        }

        .rarity-ä¼ è¯´ {
          color: #d97706;

          background: linear-gradient(135deg, #fef3c7, #fde68a);

          border: 2px solid #f59e0b;

          box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);

          text-shadow: 0 1px 3px rgba(217, 119, 6, 0.3);

          animation: legendary-glow 2s ease-in-out infinite alternate;
        }

        @keyframes legendary-glow {
          from {
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
          }

          to {
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);
          }
        }

        .rules-section-header {
          cursor: pointer;

          border-bottom: 1px solid #d4af37;

          justify-content: space-between;

          align-items: center;

          margin: 0.75rem 0 0.5rem;

          padding: 0.5rem 0;

          display: flex;
        }

        .rules-section-header:hover {
          background-color: #d4af371a;

          border-radius: 0.25rem;
        }

        .rules-section-title {
          color: #8b6914;

          font-size: 0.875rem;

          font-weight: 600;
        }

        .rules-toggle {
          color: #8b6914;

          font-size: 0.75rem;

          transition: transform 0.2s;
        }

        .rules-content {
          margin-top: 0.5rem;
        }

        .currency-section {
          color: #8b6914;

          background: #ffffffe6;

          border: 1px solid #d4af37;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .bottom-panel {
          white-space: nowrap;

          background-color: #fdfbf7;

          border-top: 2px solid #8b6914;

          flex-wrap: nowrap;

          grid-area: 3/1/4/4;

          justify-content: space-between;

          align-items: center;

          gap: 1rem;

          height: 40px;

          padding: 0.5rem;

          display: flex;

          overflow: hidden;
        }

        .bottom-group {
          flex-shrink: 0;

          align-items: center;

          gap: 0.5rem;

          display: flex;
        }

        .festival-notice {
          color: #b8860b;

          background: linear-gradient(135deg, #ffd7001a, #ffc1071a);

          border: 1px solid gold;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .rules-countdown {
          color: #dc2626;

          background: linear-gradient(135deg, #8b00001a, #dc26261a);

          border: 1px solid #dc2626;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .reply-timer {
          color: #16a34a;

          background: linear-gradient(135deg, #22c55e1a, #16a34a1a);

          border: 1px solid #16a34a;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          transition: all 0.3s;

          display: flex;
        }

        .reply-timer.warning {
          color: #d97706;

          background: linear-gradient(135deg, #f59e0b1a, #d977061a);

          border-color: #d97706;
        }

        .reply-timer.danger {
          color: #dc2626;

          background: linear-gradient(135deg, #ef44441a, #dc26261a);

          border-color: #dc2626;

          animation: 1s ease-in-out infinite pulse;
        }

        @keyframes pulse {
          0%,
          to {
            opacity: 1;
          }

          50% {
            opacity: 0.7;
          }
        }

        .gacha-coin {
          color: #b8860b;

          background: linear-gradient(135deg, #b8860b1a, #ffd7001a);

          border: 1px solid #b8860b;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        /* å·¥å…·æ æ ·å¼ */
        .input-toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.5rem 0;
          margin-bottom: 0.5rem;
          border-bottom: 1px solid rgba(139, 105, 20, 0.2);
        }

        .toolbar-left {
          display: flex;
          gap: 0.5rem;
        }

        .toolbar-right {
          display: flex;
          align-items: center;
        }

        .toolbar-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 0.5rem 0.75rem;
          color: #8b4513;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 0.375rem;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .toolbar-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .toolbar-button .icon {
          width: 16px;
          height: 16px;
        }

        .streaming-toggle {
          display: flex;
          align-items: center;
          gap: 0.25rem;
          cursor: pointer;
          color: #8b4513;
          font-size: 0.8rem;
          font-weight: 600;
        }

        .streaming-toggle input[type='checkbox'] {
          width: 16px;
          height: 16px;
          accent-color: #8b4513;
          cursor: pointer;
        }

        .toggle-label {
          user-select: none;
        }

        /* åº•æ æŒ‰é’®æ ·å¼ */
        .bottom-button {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.05));
          border: 1px solid rgba(139, 105, 20, 0.3);
          border-radius: 0.375rem;
          padding: 0.375rem;
          color: #8b4513;
          cursor: pointer;
          transition: all 0.2s;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          height: 32px;
        }

        .bottom-button:hover {
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.2), rgba(139, 105, 20, 0.1));
          transform: translateY(-1px);
          box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
          border-color: rgba(139, 105, 20, 0.5);
        }

        .bottom-button .icon {
          width: 16px;
          height: 16px;
        }

        /* ä¸ªäººæ¡£æ¡ˆè´§å¸è¡Œæ ·å¼ */
        .currency-row {
          display: flex;
          gap: 1rem;
          margin-top: 0.5rem;
          padding-top: 0.5rem;
          border-top: 1px solid rgba(139, 105, 20, 0.2);
        }

        .currency-item {
          flex: 1;
          background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.04));
          border: 1px solid rgba(139, 105, 20, 0.2);
          border-radius: 0.375rem;
          padding: 0.5rem;
          margin-bottom: 0;
        }

        .currency-item .label {
          color: #8b6914;
          font-weight: 600;
        }

        .currency-item .value {
          color: #8b4513;
          font-weight: 700;
        }

        .hot-spring-ticket {
          color: #059669;

          background: linear-gradient(135deg, #0596691a, #10b9811a);

          border: 1px solid #059669;

          border-radius: 0.375rem;

          align-items: center;

          gap: 0.5rem;

          min-width: -moz-fit-content;

          min-width: fit-content;

          padding: 0.25rem 0.75rem;

          font-size: 0.8rem;

          font-weight: 600;

          display: flex;
        }

        .save-button,
        .view-rules-button {
          color: #2d2d2d;

          cursor: pointer;

          background: linear-gradient(135deg, #f5f0e8, #e8d5c4);

          border: 2px solid #8b4513;

          border-radius: 0.3rem;

          padding: 0.4rem 0.8rem;

          font-size: 0.75rem;

          font-weight: 600;

          transition: all 0.3s;

          position: relative;

          overflow: hidden;
        }

        .save-button:before,
        .view-rules-button:before {
          content: '';

          opacity: 0;

          border-radius: inherit;

          background: linear-gradient(135deg, #8b00001a, #0000);

          transition: opacity 0.3s;

          position: absolute;

          top: 0;

          right: 0;

          bottom: 0;

          left: 0;
        }

        .save-button:after,
        .view-rules-button:after {
          content: '';

          background: radial-gradient(circle, #8b00004d 0%, #0000 70%);

          border-radius: 50%;

          width: 0;

          height: 0;

          transition: all 0.4s;

          position: absolute;

          top: 50%;

          left: 50%;

          transform: translate(-50%, -50%);
        }

        .save-button:hover,
        .view-rules-button:hover {
          transform: translateY(-2px);

          box-shadow: 0 4px 12px #8b00004d;
        }

        .save-button:hover:before,
        .view-rules-button:hover:before {
          opacity: 1;
        }

        .save-button:hover:after,
        .view-rules-button:hover:after {
          width: 200px;

          height: 200px;
        }

        .save-button:active,
        .view-rules-button:active {
          transform: translateY(0);

          box-shadow: 0 2px 8px #8b000066;
        }

        .save-button:active:after,
        .view-rules-button:active:after {
          background: radial-gradient(circle, #8b000080 0%, #0000 60%);

          width: 300px;

          height: 300px;
        }
      }

      @property --tw-rotate-x {
        syntax: '*';

        inherits: false;
      }

      @property --tw-rotate-y {
        syntax: '*';

        inherits: false;
      }

      @property --tw-rotate-z {
        syntax: '*';

        inherits: false;
      }

      @property --tw-skew-x {
        syntax: '*';

        inherits: false;
      }

      @property --tw-skew-y {
        syntax: '*';

        inherits: false;
      }

      @property --tw-border-style {
        syntax: '*';

        inherits: false;

        initial-value: solid;
      }

      @property --tw-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-shadow-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-shadow-alpha {
        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;
      }

      @property --tw-inset-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-inset-shadow-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-inset-shadow-alpha {
        syntax: '<percentage>';

        inherits: false;

        initial-value: 100%;
      }

      @property --tw-ring-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-ring-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-inset-ring-color {
        syntax: '*';

        inherits: false;
      }

      @property --tw-inset-ring-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-ring-inset {
        syntax: '*';

        inherits: false;
      }

      @property --tw-ring-offset-width {
        syntax: '<length>';

        inherits: false;

        initial-value: 0;
      }

      @property --tw-ring-offset-color {
        syntax: '*';

        inherits: false;

        initial-value: #fff;
      }

      @property --tw-ring-offset-shadow {
        syntax: '*';

        inherits: false;

        initial-value: 0 0 #0000;
      }

      @property --tw-outline-style {
        syntax: '*';

        inherits: false;

        initial-value: solid;
      }

      @property --tw-backdrop-blur {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-brightness {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-contrast {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-grayscale {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-hue-rotate {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-invert {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-opacity {
        syntax: '*';

        inherits: false;
      }

      @property --tw-backdrop-saturate {
        syntax: '*';

        inherits: false;
      }

      /* æ–‡æœ¬æ ¼å¼ç¾åŒ–æ ·å¼ */
      body,
      .story-text,
      .story-content {
        color: #000000 !important;
      }

      .dialogue-text {
        color: #000000 !important;
      }

      .psychology-text {
        color: #000000 !important;
      }

      .scenery-text {
        color: #000000 !important;
      }

      /* ğŸ”¥ å˜é‡æ›´æ–°è£…é¥°æ ·å¼ */
      .variable-update-decoration {
        position: relative;
        overflow: hidden;
      }

      /* ğŸ”¥ å˜é‡æ›´æ–°è£…é¥°åŠ¨ç”» - ç”Ÿæˆä¸­æ—¶æ’­æ”¾ */
      .variable-update-decoration.updating {
        animation: variableUpdating 1.5s ease-in-out infinite;
      }

      .variable-update-decoration.updating::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(139, 105, 20, 0.2), transparent);
        animation: shimmer 2s ease-in-out infinite;
      }

      .variable-update-decoration.updating svg {
        animation: rotateIcon 2s linear infinite;
      }

      .variable-update-text {
        color: #8b4513 !important;
        font-style: italic;
        text-shadow: 0 1px 2px rgba(139, 105, 20, 0.1);
      }

      .variable-update-decoration.updating .variable-update-text {
        animation: pulseText 1.5s ease-in-out infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes variableUpdating {
        0%,
        100% {
          border-left-color: rgba(139, 105, 20, 0.5);
          box-shadow: 0 1px 3px rgba(139, 105, 20, 0.1);
        }
        50% {
          border-left-color: rgba(139, 105, 20, 0.8);
          box-shadow: 0 2px 8px rgba(139, 105, 20, 0.3);
        }
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      @keyframes rotateIcon {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes pulseText {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      @property --tw-backdrop-sepia {
        syntax: '*';

        inherits: false;
      }

      @keyframes shimmer {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }
    </style>
  </head>

  <body>
    <div class="connected-panels">
      <!-- å·¦ä¾§é¢æ¿ï¼šè®­ç»ƒå‘˜ä¿¡æ¯ -->

      <div class="parchment-page left-panel">
        <div class="panel-content">
          <!-- ä¸ªäººæ¡£æ¡ˆå’Œäººç‰©å†ç¨‹å®¹å™¨ -->
          <div class="profile-journey-container">
            <!-- ä¸ªäººæ¡£æ¡ˆ -->
            <div class="profile-section">
              <div class="section-header">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                </svg>

                <h3>ä¸ªäººæ¡£æ¡ˆ</h3>

                <button class="expand-btn" id="profile-expand">
                  <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                  </svg>
                </button>
              </div>

              <div class="profile-basic" id="profile-basic" style="display: none">
                <div class="profile-link">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ¡£æ¡ˆ...</div>
              </div>

              <div class="profile-detail" id="profile-detail" style="display: block">
                <div class="detail-card">
                  <!-- å¤´åƒæ˜¾ç¤º -->
                  <div
                    class="detail-item"
                    style="
                      display: flex;
                      align-items: center;
                      gap: 15px;
                      margin-bottom: 15px;
                      padding-bottom: 15px;
                      border-bottom: 1px solid rgba(139, 105, 20, 0.2);
                    "
                  >
                    <div style="flex-shrink: 0">
                      <img
                        id="profile-avatar"
                        src="https://files.catbox.moe/u9szcj.gif"
                        alt="å¤´åƒ"
                        style="
                          width: 80px;
                          height: 80px;
                          border-radius: 8px;
                          object-fit: cover;
                          border: 2px solid rgba(139, 105, 20, 0.3);
                          cursor: pointer;
                          transition: all 0.2s;
                        "
                        title="ç‚¹å‡»æ›´æ¢å¤´åƒ"
                      />
                    </div>
                    <div style="flex: 1">
                      <div style="font-size: 0.9em; color: #8b6914; margin-bottom: 5px">å¤´åƒ</div>
                      <div style="font-size: 0.8em; color: #666">ç‚¹å‡»å¤´åƒå¯ä»¥æ›´æ¢</div>
                    </div>
                  </div>

                  <!-- å½“å‰æ’­æ”¾æ­Œæ›²æ˜¾ç¤º -->
                  <div id="profile-current-song" class="profile-current-song" style="display: none">
                    <span class="label">ğŸµ æ­£åœ¨æ’­æ”¾:</span>
                    <span class="value" id="profile-song-name">-</span>
                  </div>

                  <!-- å·¦å³å¸ƒå±€ï¼šå·¦ä¾§åŸºæœ¬ä¿¡æ¯ï¼Œå³ä¾§çŠ¶æ€æ¡ -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px">
                    <!-- å·¦ä¾§ï¼šåŸºæœ¬ä¿¡æ¯ -->
                    <div>
                      <div class="detail-item">
                        <span class="label">èº«ä»½:</span>
                        <span class="value">è®­ç»ƒå‘˜</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">èƒŒæ™¯:</span>
                        <span class="value" id="trainer-background">æ— </span>
                      </div>
                      <div class="detail-item">
                        <span class="label">çŠ¶æ€:</span>
                        <span class="value" id="trainer-status">æ­£å¸¸</span>
                      </div>
                      <div class="detail-item">
                        <span class="label">ç§°å·:</span>
                        <span
                          class="value"
                          id="trainer-title"
                          style="color: #b8860b; font-weight: 500; display: inline-block"
                          >åˆå…¥ä¸–ç•Œ</span
                        >
                      </div>
                      <!-- æ‰­è›‹å¸ -->
                      <div class="detail-item">
                        <span class="label" style="font-weight: 600; color: #8b4513">æ‰­è›‹å¸:</span>
                        <span class="value" id="profile-gacha-coin">0</span>
                      </div>
                      <!-- å®éªŒç‚¹æ•° -->
                      <div class="detail-item">
                        <span class="label" style="font-weight: 600; color: #8b4513">å®éªŒç‚¹æ•°:</span>
                        <span class="value" id="profile-currency-value">0</span>
                      </div>
                    </div>

                    <!-- å³ä¾§ï¼šç†æ™ºã€ä½“åŠ›ã€è‡ªæ§ã€åŠ›é‡ã€æŠ€å·§ -->
                    <div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">ç†æ™ºå€¼:</span>
                        <span class="value" id="sanity-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="sanity-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #3b82f6, #2563eb);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">ä½“åŠ›:</span>
                        <span class="value" id="stamina-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="stamina-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #10b981, #059669);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div class="detail-item" style="margin-bottom: 0.25rem">
                        <span class="label">è‡ªæ§:</span>
                        <span class="value" id="self-control-value">0</span>
                      </div>
                      <div
                        class="progress-bar"
                        style="
                          height: 8px;
                          margin-bottom: 0.5rem;
                          background: rgba(139, 105, 20, 0.1);
                          border-radius: 4px;
                          overflow: hidden;
                        "
                      >
                        <div
                          class="progress-fill"
                          id="self-control-bar"
                          style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
                            border-radius: 4px;
                            transition: width 0.3s ease;
                          "
                        ></div>
                      </div>
                      <div
                        class="detail-item"
                        style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center"
                      >
                        <span class="label">åŠ›:</span>
                        <span class="value" id="power-value" style="color: #dc2626; font-weight: 600">0</span>
                        <span class="label" style="margin-left: 0.75rem">æŠ€:</span>
                        <span class="value" id="skill-value" style="color: #9333ea; font-weight: 600">0</span>
                      </div>
                    </div>
                  </div>

                  <!-- è¿æ°”ï¼šå•ç‹¬ä¸€è¡Œï¼Œè·¨è¶Šä¸¤åˆ— -->
                  <div style="grid-column: 1 / -1; margin-top: 0.5rem">
                    <div class="detail-item" style="margin-bottom: 0.25rem">
                      <span class="label">è¿æ°”:</span>
                      <span class="value" id="luck-value" style="color: #ff8c00; font-weight: 600">0</span>
                    </div>
                    <div
                      class="progress-bar"
                      style="
                        height: 8px;
                        margin-bottom: 0;
                        background: rgba(139, 105, 20, 0.1);
                        border-radius: 4px;
                        overflow: hidden;
                      "
                    >
                      <div
                        class="progress-fill"
                        id="luck-bar"
                        style="
                          width: 0%;
                          height: 100%;
                          background: linear-gradient(90deg, #ff8c00, #ffa500);
                          border-radius: 4px;
                          transition: width 0.3s ease;
                        "
                      ></div>
                    </div>
                  </div>

                  <!-- åŠŸèƒ½æŒ‰é’®ï¼ˆä¸€è¡Œæ˜¾ç¤ºï¼‰ -->
                  <div
                    style="
                      display: flex;
                      gap: 8px;
                      align-items: center;
                      margin-top: 0.5rem;
                      padding-top: 0.5rem;
                      border-top: 1px solid rgba(139, 105, 20, 0.2);
                    "
                  >
                    <!-- æŸ¥çœ‹è§„åˆ™æŒ‰é’® -->
                    <button
                      id="view-rules-btn"
                      class="profile-icon-btn"
                      title="æŸ¥çœ‹è§„åˆ™"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px">
                        <path
                          d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"
                        />
                      </svg>
                    </button>
                    <!-- å¤©èµ‹ç®¡ç†æŒ‰é’® -->
                    <button
                      id="manage-talents-btn-inner"
                      class="profile-icon-btn"
                      title="å¤©èµ‹ç®¡ç†"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px">
                        <path
                          d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                        />
                      </svg>
                    </button>
                    <!-- é©¬å¨˜è®°åå†ŒæŒ‰é’® -->
                    <button
                      id="uma-roster-btn-inner"
                      class="profile-icon-btn"
                      title="é©¬å¨˜è®°åå†Œ"
                      onclick="window.teresenDebug.openUmaRoster()"
                      style="
                        background: linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08));
                        border: 1px solid rgba(139, 69, 19, 0.3);
                        border-radius: 6px;
                        padding: 6px;
                        color: #8b4513;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 32px;
                        height: 32px;
                        flex-shrink: 0;
                      "
                      onmouseover="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.25), rgba(139, 69, 19, 0.15)'; this.style.transform='translateY(-1px)'"
                      onmouseout="this.style.background='linear-gradient(135deg, rgba(139, 69, 19, 0.15), rgba(139, 69, 19, 0.08)'; this.style.transform='translateY(0)'"
                    >
                      <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="width: 18px; height: 18px">
                        <path
                          d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"
                        />
                      </svg>
                    </button>
                    <!-- åœ¨æ ¡å¤©æ•° -->
                    <div class="detail-item" style="margin-left: auto; display: flex; align-items: center; gap: 4px">
                      <span class="label" style="font-weight: 600; color: #8b4513">åœ¨æ ¡å¤©æ•°:</span>
                      <span class="value" id="days-in-park">0å¤©</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- åœ°ç‚¹å›¾ç‰‡å±•ç¤º -->
            <div style="margin-top: 0.75rem; margin-bottom: 0.75rem">
              <div style="text-align: center; margin-bottom: 10px">
                <div style="font-size: 0.9em; color: #8b6914; margin-bottom: 8px; font-weight: 600">å½“å‰åœ°ç‚¹</div>
                <div
                  id="location-image-display"
                  style="
                    width: 100%;
                    max-height: 200px;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid rgba(139, 105, 20, 0.2);
                    background: rgba(139, 105, 20, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    id="location-image"
                    src=""
                    alt="åœ°ç‚¹å›¾ç‰‡"
                    style="width: 100%; height: auto; max-height: 200px; object-fit: cover; display: none"
                    loading="lazy"
                  />
                  <div
                    id="location-image-placeholder"
                    style="color: #8b6914; font-size: 0.85em; padding: 20px; text-align: center"
                  >
                    æš‚æ— åœ°ç‚¹å›¾ç‰‡
                  </div>
                </div>
              </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ï¼ˆä»å³ä¾§é¢æ¿ç§»æ¤ï¼‰ -->
            <div class="task-list-section" style="margin-top: 0.75rem">
              <div class="section-header">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="color: #8b6914">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                  <path
                    fill-rule="evenodd"
                    d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                    clip-rule="evenodd"
                  />
                </svg>
                <h3>ä»»åŠ¡åˆ—è¡¨</h3>
                <button class="expand-btn" id="task-list-expand" title="å±•å¼€ä»»åŠ¡åˆ—è¡¨">
                  <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                  </svg>
                </button>
              </div>

              <div class="task-list-basic" id="task-list-basic" style="display: block">
                <div class="task-list-link" style="color: #8b4513; cursor: pointer; font-size: 0.75rem; padding: 4px 0">
                  ç‚¹å‡»æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨...
                </div>
              </div>

              <div
                class="task-list-detail"
                id="task-list-detail"
                style="
                  display: none;
                  margin-top: 10px;
                  padding: 15px;
                  background:
                    linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                    repeating-linear-gradient(
                      45deg,
                      transparent,
                      transparent 10px,
                      rgba(139, 105, 20, 0.03) 10px,
                      rgba(139, 105, 20, 0.03) 20px
                    );
                  border: 1px solid rgba(139, 105, 20, 0.2);
                  border-radius: 8px;
                  box-shadow:
                    inset 0 2px 4px rgba(139, 105, 20, 0.1),
                    0 1px 2px rgba(139, 105, 20, 0.1);
                  position: relative;
                  overflow: hidden;
                "
              >
                <div
                  style="
                    position: absolute;
                    top: -50%;
                    right: -50%;
                    width: 200%;
                    height: 200%;
                    background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                    pointer-events: none;
                  "
                ></div>
                <div id="task-list-content" style="position: relative; z-index: 1">
                  <div style="color: #8b4513; font-size: 0.85em; text-align: center; padding: 20px">æš‚æ— ä»»åŠ¡</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç‰©å“æ  -->

          <div class="inventory-section">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
              </svg>

              <h3>ç‰©å“æ </h3>

              <div class="command-manager-dot" id="command-manager-dot" style="display: none">
                <span class="dot-icon">ğŸ“‹</span>

                <span class="dot-count">0</span>
              </div>
            </div>

            <div class="inventory-container" id="inventory-list">
              <div class="empty-inventory">ç‰©å“æ ä¸ºç©º</div>
            </div>
          </div>
        </div>
      </div>

      <!-- åˆ†éš”çº¿ -->

      <div class="panel-divider"></div>

      <!-- ä¸­å¤®é¢æ¿ï¼šæ­£æ–‡å†…å®¹ -->

      <div class="parchment-page center-panel">
        <div class="story-container">
          <!-- æ•…äº‹æ–‡æœ¬æ“ä½œæŒ‰é’®æ ï¼ˆå°å›¾æ ‡æ ·å¼ï¼‰ -->
          <div
            class="story-actions-bar"
            id="story-actions-bar"
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 6px;
              padding: 8px 12px;
              margin-bottom: 8px;
              background: rgba(244, 241, 232, 0.3);
              border-radius: 6px;
              border: 1px solid rgba(139, 105, 20, 0.15);
            "
          >
            <!-- å·¦ä¾§æŒ‰é’®ç»„ï¼šå­˜æ¡£å’Œå…¨å± -->
            <div style="display: flex; align-items: center; gap: 6px">
              <!-- ğŸ”¥ å­˜æ¡£æŒ‰é’®å·²åˆ é™¤ -->
              <button
                id="fullscreen-btn"
                class="story-action-btn"
                title="å…¨å±"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z"
                  />
                </svg>
              </button>

              <!-- ğŸ”¥ æµå¼ä¼ è¾“å¼€å…³ï¼ˆç§»åˆ°å­˜æ¡£ã€å…¨å±æŒ‰é’®å³è¾¹ï¼Œç¾åŒ–æ ·å¼ï¼‰ -->
              <label
                class="streaming-toggle"
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  padding: 6px 12px;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 12px;
                  font-weight: 500;
                  margin-left: 4px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <input
                  type="checkbox"
                  id="streaming-checkbox"
                  checked
                  style="width: 16px; height: 16px; cursor: pointer; accent-color: #8b4513"
                />
                <span class="toggle-label" style="user-select: none">æµå¼</span>
              </label>
              <!-- ğŸ”¥ èŠå¤©å†å²å¼€å…³æŒ‰é’® -->
              <label
                class="chat-history-toggle"
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  padding: 6px 12px;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 12px;
                  font-weight: 500;
                  margin-left: 4px;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <input
                  type="checkbox"
                  id="chat-history-checkbox"
                  style="width: 16px; height: 16px; cursor: pointer; accent-color: #8b4513"
                />
                <span class="toggle-label" style="user-select: none">èŠå¤©</span>
              </label>
            </div>
            <!-- å³ä¾§æŒ‰é’®ç»„ï¼šæ€»ç»“ã€è¿”å›ã€é‡æ–°ç”Ÿæˆ -->
            <div style="display: flex; align-items: center; gap: 6px">
              <button
                id="btn-summary"
                class="story-action-btn"
                title="æ€»ç»“"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="btn-back"
                class="story-action-btn"
                title="è¿”å›"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="btn-reroll"
                class="story-action-btn"
                title="é‡æ–°ç”Ÿæˆ"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="story-content" id="story-content" style="margin-bottom: 0; position: relative">
            <p class="story-text">ç­‰å¾…æ•…äº‹å†…å®¹åŠ è½½...</p>
          </div>

          <!-- ğŸ”¥ èŠå¤©å†å²é¢æ¿ï¼ˆå¯åˆ‡æ¢æ˜¾ç¤ºï¼‰ -->
          <div
            id="chat-history-panel"
            style="
              display: none;
              margin-top: 20px;
              border-top: 2px solid rgba(139, 105, 20, 0.3);
              padding-top: 15px;
              max-height: 400px;
              overflow-y: auto;
              background: rgba(255, 255, 255, 0.5);
              border-radius: 4px;
              padding: 15px;
            "
          >
            <div
              style="
                font-size: 14px;
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(139, 105, 20, 0.2);
              "
            >
              èŠå¤©å†å²
            </div>
            <div id="chat-history-content-list" style="color: #654321; line-height: 1.8; font-size: 13px">
              åŠ è½½ä¸­...
            </div>
          </div>

          <!-- å˜é‡æ›´æ–°è£…é¥° - æ”¾åœ¨æ•…äº‹æ–‡æœ¬å’Œé€‰é¡¹ä¹‹é—´ -->
          <div
            id="variable-update-decoration"
            class="variable-update-decoration"
            style="
              margin-top: 15px;
              margin-bottom: 15px;
              padding: 8px 12px;
              background:
                linear-gradient(135deg, rgba(139, 105, 20, 0.1), rgba(139, 105, 20, 0.15)),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 8px,
                  rgba(139, 105, 20, 0.02) 8px,
                  rgba(139, 105, 20, 0.02) 16px
                );
              border-left: 3px solid rgba(139, 105, 20, 0.5);
              border-radius: 4px;
              display: none;
              position: static;
              animation: fadeIn 0.3s ease-in;
              box-shadow: 0 1px 3px rgba(139, 105, 20, 0.1);
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                color: #8b4513;
                font-size: 0.85em;
                font-weight: 500;
                font-style: italic;
              "
            >
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20" style="flex-shrink: 0; opacity: 0.7">
                <path
                  fill-rule="evenodd"
                  d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                  clip-rule="evenodd"
                />
              </svg>
              <span id="variable-update-text" class="variable-update-text" style="flex: 1; line-height: 1.4"></span>
            </div>
          </div>

          <!-- Actioné€‰é¡¹å®¹å™¨ - æ”¾åœ¨æ•…äº‹æ–‡æœ¬ç•Œé¢å†… -->
          <div
            class="action-options-container"
            id="action-options-container"
            style="
              margin-top: 20px;
              padding: 15px;
              background:
                linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 10px,
                  rgba(139, 105, 20, 0.03) 10px,
                  rgba(139, 105, 20, 0.03) 20px
                );
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
              box-shadow:
                inset 0 2px 4px rgba(139, 105, 20, 0.1),
                0 1px 2px rgba(139, 105, 20, 0.1);
              display: none;
            "
          >
            <div
              style="
                font-weight: 600;
                color: #8b4513;
                font-size: 0.9em;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span style="font-size: 1.2em">ğŸ¯</span>
              <span>è¡ŒåŠ¨é€‰é¡¹</span>
            </div>
            <div id="action-options-list" style="display: flex; flex-direction: column; gap: 10px"></div>
          </div>
        </div>

        <div class="input-section ruled-paper">
          <div class="input-header">
            <div class="time-display compact">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                />
              </svg>

              <span id="current-time">ç­‰å¾…æ—¶é—´åŠ è½½...</span>
            </div>

            <!-- æŠ€èƒ½æŒ‰é’®åŒºåŸŸï¼ˆç§»å›åŸä½ç½®ï¼‰ -->
            <div class="skills-section" id="skills-section" style="display: none">
              <!-- æŠ€èƒ½æŒ‰é’®å°†æ ¹æ®å½“å‰å¤§å¤©èµ‹åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- æ§ä»¶åŒºåŸŸï¼ˆç§»åˆ°å³ä¾§ï¼‰ -->
            <div style="margin-left: auto; display: flex; align-items: center; gap: 2px">
              <button
                id="quickmap-btn"
                class="story-action-btn"
                title="å¿«æ·åœ°å›¾"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              <button
                id="quick-action-btn"
                class="story-action-btn"
                title="å¿«æ·åŠŸèƒ½"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #8b4513;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(139, 105, 20, 0.2)'; this.style.borderColor='rgba(139, 105, 20, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <button
                id="quick-position-btn"
                class="story-action-btn"
                title="å¿«æ·å§¿åŠ¿"
                style="
                  width: 32px;
                  height: 32px;
                  padding: 0;
                  border: 1px solid rgba(139, 105, 20, 0.3);
                  border-radius: 4px;
                  background: rgba(139, 105, 20, 0.1);
                  color: #e91e63;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 1000;
                  pointer-events: auto;
                "
                onmouseover="this.style.background='rgba(233, 30, 99, 0.2)'; this.style.borderColor='rgba(233, 30, 99, 0.5)'"
                onmouseout="this.style.background='rgba(139, 105, 20, 0.1)'; this.style.borderColor='rgba(139, 105, 20, 0.3)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none">
                  <path
                    fill-rule="evenodd"
                    d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>

          <div class="input-container">
            <span class="input-prompt">{">"}</span>

            <textarea id="action-input" placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨..." class="action-input"></textarea>

            <div class="input-controls">
              <button id="btn-send-action" class="send-button">å‘é€</button>
            </div>
          </div>
        </div>
      </div>

      <!-- åˆ†éš”çº¿ -->

      <div class="panel-divider"></div>

      <!-- å³ä¾§é¢æ¿ï¼šç¦å¿Œè§„åˆ™å’Œèµ›é©¬å¨˜çŠ¶æ€ -->

      <div class="parchment-page right-panel" id="right-panel-container" style="position: relative">
        <div class="panel-content">
          <!-- èµ›é©¬å¨˜çŠ¶æ€ -->

          <div class="uma-section">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                />
              </svg>

              <h3>èµ›é©¬å¨˜çŠ¶æ€</h3>

              <button
                class="roster-btn"
                id="fullscreen-btn-right"
                title="å…¨å±"
                style="
                  cursor: pointer;
                  background: 0 0;
                  border: none;
                  border-radius: 0.25rem;
                  margin-left: auto;
                  padding: 0.25rem;
                  font-size: 1rem;
                  color: #8b4513;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 24px;
                  height: 24px;
                "
                onmouseover="this.style.backgroundColor='#8b69141a'; this.style.transform='scale(1.1)'"
                onmouseout="this.style.backgroundColor='transparent'; this.style.transform='scale(1)'"
              >
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 11-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z"
                  />
                </svg>
              </button>
            </div>

            <div class="uma-list" id="uma-status" style="display: block">
              <div class="loading-uma">ç­‰å¾…çŠ¶æ€åŠ è½½...</div>
            </div>
          </div>

          <!-- å¡é¢å±•ç¤ºæ  -->
          <div class="card-display-section">
            <div class="section-header">
              <svg class="icon card-display-icon" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                  clip-rule="evenodd"
                />
              </svg>
              <h3>å¡é¢å±•ç¤º</h3>
              <button class="expand-btn" id="card-display-btn" title="æŸ¥çœ‹å¡é¢">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
              </button>
            </div>
          </div>

          <!-- äººç‰©è¡¨æƒ…å±•ç¤ºåŒºåŸŸ -->
          <div
            class="uma-expression-section"
            id="main-uma-expression-section"
            style="
              margin-top: 2px;
              padding: 15px;
              background:
                linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                repeating-linear-gradient(
                  45deg,
                  transparent,
                  transparent 10px,
                  rgba(139, 105, 20, 0.03) 10px,
                  rgba(139, 105, 20, 0.03) 20px
                );
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
              box-shadow:
                inset 0 2px 4px rgba(139, 105, 20, 0.1),
                0 1px 2px rgba(139, 105, 20, 0.1);
              position: relative;
              overflow: hidden;
            "
          >
            <div
              style="
                position: absolute;
                top: -50%;
                right: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                pointer-events: none;
              "
            ></div>
            <div id="main-uma-expression-grid" style="text-align: center; position: relative; z-index: 1"></div>
          </div>

          <!-- æ€§çˆ±å§¿åŠ¿å›¾åŒºåŸŸ -->
          <div class="sex-position-section" style="margin-top: 0.75rem">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20" style="color: #8b6914">
                <path
                  fill-rule="evenodd"
                  d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                  clip-rule="evenodd"
                />
              </svg>
              <h3>å§¿åŠ¿å›¾</h3>
              <button class="expand-btn" id="sex-position-expand" title="å±•å¼€å§¿åŠ¿å›¾">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                </svg>
              </button>
            </div>

            <div class="sex-position-basic" id="sex-position-basic" style="display: block">
              <div
                class="sex-position-link"
                style="color: #8b4513; cursor: pointer; font-size: 0.75rem; padding: 4px 0"
              >
                ç‚¹å‡»æŸ¥çœ‹å§¿åŠ¿å›¾...
              </div>
            </div>

            <div
              class="sex-position-detail"
              id="sex-position-detail"
              style="
                display: none;
                margin-top: 10px;
                padding: 15px;
                background:
                  linear-gradient(135deg, rgba(244, 241, 232, 0.6) 0%, rgba(232, 224, 208, 0.6) 100%),
                  repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(139, 105, 20, 0.03) 10px,
                    rgba(139, 105, 20, 0.03) 20px
                  );
                border: 1px solid rgba(139, 105, 20, 0.2);
                border-radius: 8px;
                box-shadow:
                  inset 0 2px 4px rgba(139, 105, 20, 0.1),
                  0 1px 2px rgba(139, 105, 20, 0.1);
                position: relative;
                overflow: hidden;
              "
            >
              <div
                style="
                  position: absolute;
                  top: -50%;
                  right: -50%;
                  width: 200%;
                  height: 200%;
                  background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
                  pointer-events: none;
                "
              ></div>
              <div style="text-align: center; position: relative; z-index: 1">
                <div
                  id="sex-position-text"
                  style="font-size: 0.95em; font-weight: 600; color: #8b4513; margin-bottom: 10px; text-align: center"
                ></div>
                <div
                  style="
                    width: 100%;
                    max-height: 300px;
                    border-radius: 8px;
                    overflow: hidden;
                    border: 2px solid rgba(139, 105, 20, 0.3);
                    background: rgba(139, 105, 20, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    id="sex-position-image"
                    src=""
                    alt="æ€§çˆ±å§¿åŠ¿å›¾"
                    style="width: 100%; height: auto; max-height: 300px; object-fit: contain; display: none"
                    loading="lazy"
                  />
                  <div
                    id="sex-position-placeholder"
                    style="color: #8b4513; font-size: 0.85em; padding: 40px; text-align: center"
                  >
                    æš‚æ— å§¿åŠ¿å›¾ç‰‡
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- QTEæŒ£æ‰åŒºåŸŸ -->

          <div class="qte-section" id="qte-section" style="display: none">
            <div class="section-header">
              <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />
              </svg>

              <h3>æŒ£æ‰é€‰é¡¹</h3>
            </div>

            <div class="qte-container">
              <div class="qte-info">
                <p class="qte-description">ä½ è¢«é©¬å¨˜æŸç¼šäº†ï¼</p>

                <p class="qte-subtitle">é€‰æ‹©ä½ çš„è¡ŒåŠ¨...</p>
              </div>

              <div class="qte-options">
                <button
                  class="qte-btn struggle-btn"
                  id="qte-struggle-btn"
                  onclick="window.teresenDebug.triggerQTE('struggle')"
                >
                  <span class="qte-icon">ğŸ’ª</span>

                  <span class="qte-text">å¥‹åŠ›æŒ£æ‰</span>

                  <span class="qte-desc">å°è¯•æŒ£è„±æŸç¼š</span>
                </button>

                <button
                  class="qte-btn submit-btn"
                  id="qte-submit-btn"
                  onclick="window.teresenDebug.triggerQTE('submit')"
                >
                  <span class="qte-icon">ğŸ˜Œ</span>

                  <span class="qte-text">ä¸åæŠ—</span>

                  <span class="qte-desc">æ¥å—ç°çŠ¶</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨é¢æ¿ï¼šè´§å¸ç³»ç»Ÿã€èŠ‚æ—¥é€šçŸ¥ã€è§„åˆ™å€’è®¡æ—¶ -->

      <div class="bottom-panel">
        <!-- åŠŸèƒ½ç›¸å…³ -->

        <div class="bottom-group">
          <!-- æ–°å¢æŒ‰é’® -->
          <button id="settings-btn" class="bottom-button" title="è®¾ç½®">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="achievements-btn" class="bottom-button" title="æˆå°±">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
              />
            </svg>
          </button>

          <button id="world-map-btn" class="bottom-button" title="ä¸–ç•Œåœ°å›¾">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M12 1.586l-4 4v12.828l4-4V1.586zM3.707 3.293A1 1 0 002 4v10a1 1 0 00.293.707L6 18.414V5.586L3.707 3.293zM17.707 5.293L14 1.586v12.828l2.293 2.293A1 1 0 0018 16V6a1 1 0 00-.293-.707z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="music-player-btn" class="bottom-button" title="éŸ³ä¹æ’­æ”¾å™¨">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <button id="tarot-divination" class="bottom-button" title="å¡”ç½—å åœ">
            <span>ğŸ”®</span>
          </button>

          <button id="shrine-btn" class="bottom-button" title="ç¥ç¤¾ç¥ˆç¦">
            <span>â›©ï¸</span>
          </button>
        </div>

        <!-- æ—¶é—´ç›¸å…³ -->

        <div class="bottom-group">
          <div class="festival-notice" id="festival-notice" style="display: none">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
              />
            </svg>

            <span id="festival-text">èŠ‚æ—¥é€šçŸ¥</span>
          </div>

          <div class="reply-timer" id="reply-timer">
            <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
              />
            </svg>

            <span id="reply-timer-text">å›å¤æ—¶é—´: --:--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <!-- ğŸ”¥ å¿«æ·åŠŸèƒ½å¼¹çª— -->
    <div
      id="quick-action-modal"
      class="rules-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="rules-modal-content" style="max-width: 500px; width: 90%; max-height: 90vh">
        <div class="rules-modal-header">
          <h2 class="rules-title">âš¡ å¿«æ·åŠŸèƒ½</h2>
          <button id="quick-action-modal-close-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div
          class="rules-modal-body"
          style="
            padding: 12px;
            overflow-y: auto;
            max-height: calc(90vh - 60px);
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 105, 20, 0.3) transparent;
          "
        >
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
            <button
              class="quick-action-modal-btn"
              data-action="meal"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ½ï¸</span>
              <span style="line-height: 1.2">åŠ é¤</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="borrow"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ’°</span>
              <span style="line-height: 1.2">å€Ÿé’±</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="game"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ®</span>
              <span style="line-height: 1.2">æ‰“æ¸¸æˆ</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="chat"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ’¬</span>
              <span style="line-height: 1.2">èŠå¤©</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="rest"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ˜´</span>
              <span style="line-height: 1.2">ä¼‘æ¯åˆ°ä¸‹å‘¨</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="train"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸƒ</span>
              <span style="line-height: 1.2">è®­ç»ƒé©¬å¨˜</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="schedule"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ“…</span>
              <span style="line-height: 1.2">æŸ¥çœ‹èµ›ç¨‹</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="gacha"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ°</span>
              <span style="line-height: 1.2">å»æ‰­è›‹</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="phone"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ“±</span>
              <span style="line-height: 1.2">æ‰‹æœºè”ç»œ</span>
            </button>
            <button
              class="quick-action-modal-btn"
              data-action="rules"
              style="
                padding: 6px 4px;
                border: 1px solid rgba(139, 105, 20, 0.25);
                border-radius: 5px;
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.08), rgba(139, 105, 20, 0.03));
                color: #2d2d2d;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                font-weight: 500;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                min-height: 50px;
              "
            >
              <span style="font-size: 16px; line-height: 1">ğŸ“‹</span>
              <span style="line-height: 1.2">è§„åˆ™æ£€æŸ¥</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ å¿«æ·å§¿åŠ¿å¼¹çª— - äºŒçº§å¯¼èˆª -->
    <div
      id="quick-position-modal"
      class="rules-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="rules-modal-content" style="max-width: 700px; width: 90%; max-height: 90vh">
        <div class="rules-modal-header">
          <h2 class="rules-title">ğŸ’• å¿«æ·å§¿åŠ¿</h2>
          <button id="quick-position-modal-close-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div
          class="rules-modal-body"
          style="
            padding: 12px;
            overflow-y: auto;
            max-height: calc(90vh - 60px);
            scrollbar-width: thin;
            scrollbar-color: rgba(139, 105, 20, 0.3) transparent;
          "
        >
          <!-- ç¬¬ä¸€çº§ï¼šåˆ†ç±»åˆ—è¡¨ -->
          <div class="position-category-list" style="display: block">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px">
              <!-- åŸºç¡€äº’åŠ¨ä¸è°ƒæƒ… -->
              <button
                class="position-category-btn"
                data-category="basic"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">åŸºç¡€äº’åŠ¨ä¸è°ƒæƒ…</span>
              </button>

              <!-- å±€éƒ¨æ€§è¡Œä¸º -->
              <button
                class="position-category-btn"
                data-category="partial"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">å±€éƒ¨æ€§è¡Œä¸º</span>
              </button>

              <!-- æ­£å¼ä½“ä½ - å¸¸è§„ -->
              <button
                class="position-category-btn"
                data-category="normal"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">æ­£å¼ä½“ä½ - å¸¸è§„</span>
              </button>

              <!-- æ­£å¼ä½“ä½ - è‚›äº¤ -->
              <button
                class="position-category-btn"
                data-category="anal"
                style="
                  padding: 16px;
                  border: 1px solid rgba(233, 30, 99, 0.3);
                  border-radius: 8px;
                  background: linear-gradient(135deg, rgba(233, 30, 99, 0.12), rgba(233, 30, 99, 0.05));
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 4px rgba(233, 30, 99, 0.1);
                "
              >
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20" style="color: #e91e63">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span style="font-size: 14px; font-weight: 600">æ­£å¼ä½“ä½ - è‚›äº¤</span>
              </button>
            </div>
          </div>

          <!-- ç¬¬äºŒçº§ï¼šå­åˆ†ç±»åˆ—è¡¨ -->
          <div class="position-subcategory-list" style="display: none">
            <!-- è¿”å›æŒ‰é’® -->
            <button
              class="position-back-btn"
              style="
                margin-bottom: 12px;
                padding: 8px 16px;
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 6px;
                background: rgba(139, 105, 20, 0.1);
                color: #8b4513;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                transition: all 0.2s;
              "
            >
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>è¿”å›åˆ†ç±»</span>
            </button>

            <!-- åŸºç¡€äº’åŠ¨ä¸è°ƒæƒ… -->
            <div class="position-subcategory" data-category="basic" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="äº¤è°ˆ"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ’¬ äº¤è°ˆ
                </button>
                <button
                  class="quick-position-btn"
                  data-position="è°ƒæƒ…"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ˜˜ è°ƒæƒ…
                </button>
                <button
                  class="quick-position-btn"
                  data-position="æ¥å»"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ’‹ æ¥å»
                </button>
                <button
                  class="quick-position-btn"
                  data-position="æŠšæ‘¸è€³æœµ"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘‚ æŠšæ‘¸è€³æœµ
                </button>
                <button
                  class="quick-position-btn"
                  data-position="çˆ±æŠšå¤§è…¿"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ¦µ çˆ±æŠšå¤§è…¿
                </button>
                <button
                  class="quick-position-btn"
                  data-position="çˆ±æŠšå°¾å·´"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ´ çˆ±æŠšå°¾å·´
                </button>
                <button
                  class="quick-position-btn"
                  data-position="çˆ±æŠšèƒ¸éƒ¨"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ’• çˆ±æŠšèƒ¸éƒ¨
                </button>
                <button
                  class="quick-position-btn"
                  data-position="çˆ±æŠšé˜´æ ¸"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸŒ¸ çˆ±æŠšé˜´æ ¸
                </button>
                <button
                  class="quick-position-btn"
                  data-position="æ‰‹æŒ‡æ’å…¥"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘† æ‰‹æŒ‡æ’å…¥
                </button>
              </div>
            </div>

            <!-- å±€éƒ¨æ€§è¡Œä¸º -->
            <div class="position-subcategory" data-category="partial" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="æ‰‹äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  âœ‹ æ‰‹äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å£äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘„ å£äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="æ·±å–‰"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ”½ æ·±å–‰
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èˆŒäº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘… èˆŒäº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="ä¹³äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ¼ ä¹³äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="ä¹³å¤¹å£äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ’ ä¹³å¤¹å£äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="è¶³äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ¦¶ è¶³äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="ç´ è‚¡"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ¦µ ç´ è‚¡
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èˆ”è‚›ä¾å¥‰"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘… èˆ”è‚›ä¾å¥‰
                </button>
              </div>
            </div>

            <!-- æ­£å¼ä½“ä½ - å¸¸è§„ -->
            <div class="position-subcategory" data-category="normal" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="æ­£å¸¸ä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ›ï¸ æ­£å¸¸ä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="åèƒŒä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ”™ åèƒŒä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¯¹é¢åä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸª‘ å¯¹é¢åä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èƒŒé¢åä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸª‘ èƒŒé¢åä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¯¹é¢ç«‹ä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸš¶ å¯¹é¢ç«‹ä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èƒŒé¢ç«‹ä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸš¶ èƒŒé¢ç«‹ä½
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å…­ä¹å¼"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  69 å…­ä¹å¼
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¥³ä¸Šä½"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘† å¥³ä¸Šä½
                </button>
              </div>
            </div>

            <!-- æ­£å¼ä½“ä½ - è‚›äº¤ -->
            <div class="position-subcategory" data-category="anal" style="display: none">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px">
                <button
                  class="quick-position-btn"
                  data-position="æ­£å¸¸ä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ›ï¸ æ­£å¸¸ä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="åèƒŒä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ”™ åèƒŒä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¯¹é¢åä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸª‘ å¯¹é¢åä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èƒŒé¢åä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸª‘ èƒŒé¢åä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¯¹é¢ç«‹ä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸš¶ å¯¹é¢ç«‹ä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="èƒŒé¢ç«‹ä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸš¶ èƒŒé¢ç«‹ä½è‚›äº¤
                </button>
                <button
                  class="quick-position-btn"
                  data-position="å¥³ä¸Šä½è‚›äº¤"
                  style="
                    padding: 8px;
                    border: 1px solid rgba(233, 30, 99, 0.25);
                    border-radius: 6px;
                    background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(233, 30, 99, 0.05));
                    color: #2d2d2d;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 12px;
                    box-shadow: 0 1px 3px rgba(233, 30, 99, 0.15);
                  "
                >
                  ğŸ‘† å¥³ä¸Šä½è‚›äº¤
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="settings-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 600px; width: 90%">
        <div class="rules-modal-header">
          <h2 class="rules-title">âš™ï¸ è®¾ç½®</h2>
          <button id="teresen-settings-close-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body">
          <!-- å­—ä½“è®¾ç½® -->
          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">å­—ä½“è®¾ç½®</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px">
              <button
                class="font-option-btn"
                data-font="'Source Han Serif', 'æ€æºå®‹ä½“', serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Serif', 'æ€æºå®‹ä½“', serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">æ€æºå®‹ä½“</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'Source Han Sans', 'æ€æºé»‘ä½“', sans-serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Sans', 'æ€æºé»‘ä½“', sans-serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">æ€æºé»‘ä½“</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'Source Han Font', 'æºæ±‰å­—ä½“', sans-serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'Source Han Font', 'æºæ±‰å­—ä½“', sans-serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">æºæ±‰å­—ä½“</div>
              </button>
              <button
                class="font-option-btn"
                data-font="'KaiTi', 'æ¥·ä½“', serif"
                style="
                  padding: 15px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-family: 'KaiTi', 'æ¥·ä½“', serif;
                "
              >
                <div style="font-size: 0.85em; color: #666">æ¥·ä½“</div>
              </button>
            </div>
          </div>

          <!-- å­—ä½“å¤§å°è®¾ç½® -->
          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">å­—ä½“å¤§å°</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap">
              <button
                class="font-size-btn"
                data-size="0.9"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 0.9em;
                "
              >
                <div style="font-size: 0.8em; color: #666">å°å·</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1em;
                "
              >
                <div style="font-size: 0.8em; color: #666">ä¸­å·</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1.15"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1.15em;
                "
              >
                <div style="font-size: 0.8em; color: #666">å¤§å·</div>
              </button>
              <button
                class="font-size-btn"
                data-size="1.3"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  font-size: 1.3em;
                "
              >
                <div style="font-size: 0.8em; color: #666">ç‰¹å¤§å·</div>
              </button>
            </div>
          </div>

          <!-- é¢„è§ˆæ•ˆæœ -->
          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">é¢„è§ˆæ•ˆæœ</h3>
            <div
              id="font-preview"
              style="
                padding: 20px;
                background: rgba(139, 105, 20, 0.05);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 8px;
                min-height: 120px;
                color: #2d2d2d;
                line-height: 1.6;
              "
            >
              <p style="margin: 0">è¿™æ˜¯é¢„è§ˆæ–‡æœ¬ï¼Œç”¨äºå±•ç¤ºå½“å‰é€‰æ‹©çš„å­—ä½“å’Œå­—ä½“å¤§å°æ•ˆæœã€‚</p>
            </div>
          </div>

          <!-- å…¨å±èƒŒæ™¯è®¾ç½® -->
          <div style="margin-bottom: 25px">
            <h3 style="color: #8b6914; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">å…¨å±èƒŒæ™¯</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px">
              <button
                id="bg-black-btn"
                class="bg-option-btn"
                data-bg-type="black"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(0, 0, 0, 0.85);
                  color: #fff;
                  cursor: pointer;
                  transition: all 0.2s;
                  flex: 1;
                "
              >
                é»‘è¾¹
              </button>
              <button
                id="bg-image-btn"
                class="bg-option-btn"
                data-bg-type="image"
                style="
                  padding: 12px 20px;
                  border: 2px solid rgba(139, 105, 20, 0.3);
                  border-radius: 8px;
                  background: rgba(139, 105, 20, 0.05);
                  color: #2d2d2d;
                  cursor: pointer;
                  transition: all 0.2s;
                  flex: 1;
                "
              >
                èƒŒæ™¯å›¾
              </button>
            </div>
            <div id="bg-image-upload" style="display: none">
              <!-- é¢„è®¾å›¾ç‰‡é€‰æ‹© -->
              <div style="margin-bottom: 15px">
                <h4 style="color: #8b6914; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600">é¢„è®¾å›¾ç‰‡</h4>
                <div
                  id="preset-images-grid"
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                    gap: 10px;
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 10px;
                    background: rgba(139, 105, 20, 0.03);
                    border-radius: 8px;
                    border: 1px solid rgba(139, 105, 20, 0.2);
                  "
                ></div>
              </div>

              <!-- è‡ªå®šä¹‰URLè¾“å…¥ -->
              <div style="margin-bottom: 10px">
                <h4 style="color: #8b6914; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600">è‡ªå®šä¹‰å›¾ç‰‡URL</h4>
                <div style="display: flex; gap: 10px">
                  <input
                    type="text"
                    id="bg-image-url"
                    placeholder="è¾“å…¥å›¾ç‰‡URL"
                    style="
                      flex: 1;
                      padding: 8px;
                      border: 1px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      background: rgba(139, 105, 20, 0.05);
                      color: #2d2d2d;
                    "
                  />
                  <button
                    id="bg-image-load-btn"
                    style="
                      padding: 8px 16px;
                      border: 1px solid rgba(139, 105, 20, 0.3);
                      border-radius: 6px;
                      background: rgba(139, 105, 20, 0.2);
                      color: #2d2d2d;
                      cursor: pointer;
                    "
                  >
                    åŠ è½½
                  </button>
                </div>
              </div>

              <!-- é¢„è§ˆåŒºåŸŸ -->
              <div
                id="bg-image-preview"
                style="
                  margin-top: 10px;
                  max-height: 200px;
                  border-radius: 8px;
                  overflow: hidden;
                  display: none;
                  position: relative;
                "
              >
                <img id="bg-preview-img" src="" style="width: 100%; height: auto; display: block" />
                <button
                  id="bg-image-delete-btn"
                  style="
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    padding: 5px 10px;
                    background: rgba(220, 38, 38, 0.9);
                    border: 1px solid rgba(220, 38, 38, 1);
                    border-radius: 4px;
                    color: #fff;
                    cursor: pointer;
                    font-size: 12px;
                    z-index: 10;
                  "
                >
                  åˆ é™¤
                </button>
              </div>
            </div>
          </div>

          <!-- å…¨å±åŠ è½½è®¾ç½® -->
          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(139, 105, 20, 0.2);
            "
          >
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer">
              <input
                type="checkbox"
                id="auto-fullscreen-checkbox"
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b6914"
              />
              <span style="color: #2d2d2d; font-size: 1rem; font-weight: 500"
                >å…¨å±åŠ è½½ç”»é¢ï¼ˆç”µè„‘ç«¯è‡ªåŠ¨å…¨å±ç¼©æ”¾åŠ è½½ï¼‰</span
              >
            </label>
            <p style="margin: 8px 0 0 28px; color: #666; font-size: 0.85em; line-height: 1.4">
              å‹¾é€‰åï¼Œåœ¨ç”µè„‘ç«¯åŠ è½½é¡µé¢æ—¶ä¼šè‡ªåŠ¨è¿›å…¥å…¨å±ç¼©æ”¾æ¨¡å¼
            </p>
          </div>

          <!-- å›è½¦å‘é€è®¾ç½® -->
          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(139, 105, 20, 0.2);
            "
          >
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer">
              <input
                type="checkbox"
                id="enter-to-send-checkbox"
                style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b6914"
              />
              <span style="color: #2d2d2d; font-size: 1rem; font-weight: 500">å›è½¦å‘é€æ¶ˆæ¯</span>
            </label>
            <p style="margin: 8px 0 0 28px; color: #666; font-size: 0.85em; line-height: 1.4">
              å‹¾é€‰åï¼Œåœ¨è¾“å…¥æ¡†ä¸­æŒ‰å›è½¦é”®å³å¯å‘é€æ¶ˆæ¯ç»™AIï¼ˆé»˜è®¤å…³é—­ï¼‰
            </p>
          </div>

          <!-- æ¸…é™¤ç¼“å­˜ -->
          <div
            style="
              margin-bottom: 25px;
              padding: 15px;
              background: rgba(220, 38, 38, 0.05);
              border-radius: 8px;
              border: 1px solid rgba(220, 38, 38, 0.3);
            "
          >
            <h3 style="color: #dc2626; margin-bottom: 15px; font-size: 1.1rem; font-weight: 600">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</h3>
            <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9em; line-height: 1.5">
              æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„ç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬è®¾ç½®ã€å†å²è®°å½•ç­‰ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚
            </p>
            <button
              id="clear-cache-btn"
              style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
                box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
              "
              onmouseover="this.style.background='linear-gradient(135deg, #b91c1c, #991b1b)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(220, 38, 38, 0.3)'"
              onmouseout="this.style.background='linear-gradient(135deg, #dc2626, #b91c1c)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(220, 38, 38, 0.2)'"
            >
              æ¸…é™¤æ‰€æœ‰ç¼“å­˜
            </button>
            <div
              id="clear-cache-result"
              style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none; font-size: 0.9em"
            ></div>
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button
              id="apply-settings-btn"
              style="
                flex: 1;
                padding: 12px 24px;
                background: linear-gradient(135deg, #10b981, #059669);
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              åº”ç”¨è®¾ç½®
            </button>
            <button
              id="reset-settings-btn"
              style="
                flex: 1;
                padding: 12px 24px;
                background: rgba(139, 105, 20, 0.1);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 8px;
                color: #2d2d2d;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              é‡ç½®é»˜è®¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è§„åˆ™é¡µé¢æ¨¡æ€æ¡† -->

    <div id="rules-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ</h2>

          <div class="music-controls" style="display: flex; align-items: center; gap: 10px; margin-right: 10px">
            <button
              id="music-controller"
              class="music-btn"
              style="
                background: rgba(139, 105, 20, 0.8);
                border: 1px solid #8b6914;
                color: #fdfbf7;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
              "
              title="ç‚¹å‡»åˆ‡æ¢éŸ³ä¹ (å…±2é¦–ï¼Œç¬¬3æ¬¡ç‚¹å‡»å…³é—­)"
            >
              ğŸµ éŸ³ä¹æ§åˆ¶
            </button>
          </div>

          <button id="close-rules-btn" class="close-rules-btn">Ã—</button>
        </div>

        <div class="rules-modal-body">
          <div
            class="rules-section-danger"
            style="
              margin-bottom: 20px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.05);
              border: 1px solid rgba(139, 105, 20, 0.2);
              border-radius: 8px;
            "
          >
            <h3 class="rules-section-title" style="margin-bottom: 10px">å½“å‰é£é™©æœŸ</h3>
            <div id="danger-period-display" style="font-size: 16px; color: #8b4513; font-weight: 500">
              <span id="danger-period-text">--</span>
            </div>
          </div>

          <div class="rules-section-fixed">
            <h3 class="rules-section-title">ç”Ÿå­˜è§„åˆ™</h3>

            <div id="fixed-rules-list" class="rules-list-handwritten"></div>
          </div>

          <div class="rules-section-random">
            <h3 class="rules-section-title">è§„åˆ™è®°å½•</h3>
            <div class="rules-record-controls">
              <button id="add-rule-btn" class="add-rule-btn">+ æ·»åŠ è§„åˆ™</button>
              <button id="clear-rules-btn" class="clear-rules-btn">æ¸…ç©ºè®°å½•</button>
            </div>
            <div id="random-rules-list" class="rules-list-handwritten"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯»æ¡£æ¨¡æ€æ¡† -->

    <div id="load-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">è¯»å–å­˜æ¡£</h2>

          <button id="close-load-btn" class="close-rules-btn">Ã—</button>
        </div>

        <div class="rules-modal-body">
          <div class="load-section">
            <h3 class="rules-section-title">æœ¬åœ°å­˜æ¡£ (localStorage)</h3>

            <div id="local-saves-list" class="saves-list"></div>

            <h3 class="rules-section-title">ä¸–ç•Œä¹¦å­˜æ¡£ (TavernHelper)</h3>

            <div id="worldbook-saves-list" class="saves-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->

    <div id="history-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">å†å²è®°å½•</h2>

          <button id="close-history-btn" class="close-rules-btn">Ã—</button>
        </div>

        <div class="rules-modal-body">
          <div class="history-section">
            <h3 class="rules-section-title">äººç‰©å†ç¨‹</h3>

            <div id="current-journey-list" class="journey-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¡é¢å±•ç¤ºæ¨¡æ€æ¡† -->
    <div id="card-display-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 90%; width: 1200px">
        <div class="rules-modal-header">
          <h2 class="rules-title">ğŸƒ å¡é¢å±•ç¤º</h2>
          <button id="close-card-display-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body">
          <div id="card-display-grid" class="card-display-grid"></div>

          <!-- äººç‰©è¡¨æƒ…å±•ç¤ºåŒºåŸŸ -->
          <div
            class="uma-expression-section"
            style="
              margin-top: 30px;
              padding: 20px;
              background: linear-gradient(135deg, rgba(244, 241, 232, 0.9) 0%, rgba(232, 224, 208, 0.9) 100%);
              border: 2px solid #8b4513;
              border-radius: 12px;
              box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
            "
          >
            <div
              style="
                font-size: 1.2em;
                font-weight: bold;
                color: #8b4513;
                margin-bottom: 20px;
                text-align: center;
                text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
              "
            >
              ğŸ’­ äººç‰©è¡¨æƒ…
            </div>
            <div id="uma-expression-grid" class="uma-expression-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¡”ç½—å åœæ¨¡æ€æ¡† -->
    <div id="tarot-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content tarot-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">ç‰¹é›·æ£®å­¦é™¢å¡”ç½—å åœ</h2>
          <button id="close-tarot-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body">
          <div class="tarot-section">
            <div class="tarot-info">
              <p>ä»Šæ—¥å‰©ä½™å åœæ¬¡æ•°: <span id="tarot-remaining">3</span></p>
              <p>å½“å‰ç†æ™º: <span id="tarot-sanity">--</span></p>
            </div>

            <div class="tarot-spreads">
              <h3 class="rules-section-title">åŸºç¡€å åœ</h3>
              <div class="spread-buttons">
                <button class="spread-btn" data-spread="single" data-cost="5">
                  <span class="spread-icon">ğŸ”®</span>
                  <span class="spread-name">å•å¼ ç‰Œå åœ</span>
                  <span class="spread-cost">æ¶ˆè€—5ç†æ™º</span>
                </button>
                <button class="spread-btn" data-spread="timeline" data-cost="10">
                  <span class="spread-icon">â°</span>
                  <span class="spread-name">æ—¶é—´ä¹‹æµ</span>
                  <span class="spread-cost">æ¶ˆè€—10ç†æ™º</span>
                </button>
                <button class="spread-btn" data-spread="choice" data-cost="8">
                  <span class="spread-icon">âš–ï¸</span>
                  <span class="spread-name">äºŒé€‰ä¸€</span>
                  <span class="spread-cost">æ¶ˆè€—8ç†æ™º</span>
                </button>
              </div>

              <h3 class="rules-section-title">é«˜çº§å åœ</h3>
              <div class="spread-buttons">
                <button class="spread-btn advanced" data-spread="hexagram" data-cost="15" data-requirement="7">
                  <span class="spread-icon">â­</span>
                  <span class="spread-name">å…­èŠ’æ˜Ÿå åœ</span>
                  <span class="spread-cost">æ¶ˆè€—15ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥7</span>
                </button>
                <button class="spread-btn advanced" data-spread="celtic" data-cost="20" data-requirement="14">
                  <span class="spread-icon">ğŸ•¯ï¸</span>
                  <span class="spread-name">å‡¯å°”ç‰¹åå­—</span>
                  <span class="spread-cost">æ¶ˆè€—20ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥14</span>
                </button>
                <button class="spread-btn advanced" data-spread="zodiac" data-cost="25" data-requirement="21">
                  <span class="spread-icon">ğŸŒŸ</span>
                  <span class="spread-name">é»„é“åäºŒå®«</span>
                  <span class="spread-cost">æ¶ˆè€—25ç†æ™º</span>
                  <span class="spread-requirement">éœ€è¦åœ¨æ ¡å¤©æ•°â‰¥21</span>
                </button>
              </div>
            </div>

            <div class="tarot-result" id="tarot-result" style="display: none">
              <h3 class="rules-section-title">å åœç»“æœ</h3>
              <div id="tarot-cards" class="tarot-cards"></div>
              <div id="tarot-interpretation" class="tarot-interpretation"></div>
              <div id="tarot-effects" class="tarot-effects"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¥ç¤¾ç¥ˆç¦æ¨¡æ€æ¡† -->
    <div id="shrine-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 600px; width: 90%">
        <div class="rules-modal-header">
          <h2 class="rules-title">â›©ï¸ å¿ƒä¹‹ç¥ç¤¾</h2>
          <button id="close-shrine-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body">
          <!-- å¾¡ç¥ç­¾ç»“æœæ˜¾ç¤º -->
          <div id="omikuji-result-display" class="omikuji-container" style="display: none">
            <div class="omikuji-fortune"></div>
            <div class="omikuji-desc"></div>
            <ul class="omikuji-items"></ul>
          </div>

          <!-- æç¤ºè¯­ -->
          <div id="shrine-prompt" style="text-align: center; color: #8b6914; margin: 30px 0; font-size: 1.1rem">
            è¯·å…ˆä¸æ­æ¡£ä¸€åŒå‚æ‹œã€‚
          </div>

          <!-- æŒ‰é’®éƒ¨åˆ† -->
          <div style="display: flex; gap: 10px; margin-bottom: 15px">
            <button
              id="shrine-pray-btn"
              class="shrine-btn"
              style="
                flex: 1;
                padding: 12px 20px;
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8));
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
            >
              ä¸€åŒå‚æ‹œ
            </button>
            <button
              id="shrine-draw-btn"
              class="shrine-btn"
              style="
                flex: 1;
                padding: 12px 20px;
                background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
                border: none;
                border-radius: 8px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              "
              disabled
            >
              æ‘‡åŠ¨ç­¾ç­’
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸–ç•Œåœ°å›¾æ¨¡æ€æ¡† -->
    <div id="world-map-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 95%; max-height: 95%; width: 900px">
        <div class="rules-modal-header">
          <h2 class="rules-title">ç‰¹é›·æ£®ä¸–ç•Œåœ°å›¾</h2>
          <button id="close-world-map-btn" class="close-rules-btn">Ã—</button>
        </div>
        <div class="rules-modal-body" style="padding: 0">
          <div class="world-map-container">
            <div
              class="map-wrapper"
              style="
                position: relative;
                overflow: auto;
                max-height: 70vh;
                border: 2px solid #8b4513;
                border-radius: 8px;
              "
            >
              <img
                id="world-map-image"
                src="https://files.catbox.moe/l35lb5.png"
                alt="ç‰¹é›·æ£®ä¸–ç•Œåœ°å›¾"
                style="width: 100%; height: auto; display: block"
              />
              <div
                id="map-markers-container"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none"
              ></div>
            </div>
            <div
              class="map-legend"
              style="
                margin-top: 15px;
                padding: 15px;
                background: rgba(139, 105, 20, 0.1);
                border: 1px solid rgba(139, 105, 20, 0.3);
                border-radius: 6px;
              "
            >
              <h4 style="margin: 0 0 10px 0; color: #8b4513">åœ°ç‚¹ç±»å‹å›¾ä¾‹ï¼š</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 12px">
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%"></div>
                  <span>ç«é©¬åœº</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #007bff; border-radius: 50%"></div>
                  <span>åŸå¸‚</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%"></div>
                  <span>é£æ™¯åèƒœ</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #6f42c1; border-radius: 50%"></div>
                  <span>åœ°æ ‡å»ºç­‘</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px">
                  <div style="width: 12px; height: 12px; background: #fd7e14; border-radius: 50%"></div>
                  <span>è®¾æ–½</span>
                </div>
              </div>
            </div>
          </div>
          <div
            id="location-detail-panel"
            style="
              display: none;
              margin-top: 15px;
              padding: 15px;
              background: rgba(139, 105, 20, 0.1);
              border: 1px solid rgba(139, 105, 20, 0.3);
              border-radius: 6px;
            "
          >
            <h4 id="location-detail-name" style="margin: 0 0 8px 0; color: #8b4513"></h4>
            <div id="location-detail-type" style="font-size: 12px; color: #8b4513; margin-bottom: 8px"></div>
            <div id="location-detail-description" style="color: #654321; line-height: 1.4"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¿«æ·åœ°å›¾æ¨¡æ€æ¡† -->
    <div id="quick-map-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content" style="max-width: 90%; max-height: 95%; width: 800px; height: 90vh">
        <button
          id="close-quick-map-btn"
          class="close-rules-btn"
          style="
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1000;
            font-size: 18px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            padding: 0;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
          "
        >
          Ã—
        </button>
        <div
          id="map-container"
          style="
            position: relative;
            width: 100%;
            height: 90vh;
            overflow: auto;
            transform-origin: center center;
            transition: transform 0.2s ease;
          "
        >
          <img
            id="quick-map-image"
            src="https://files.catbox.moe/psluhm.jpg"
            alt="ç‰¹é›·æ£®å­¦é™¢åœ°å›¾"
            style="width: 150%; height: auto; display: block; user-select: none; pointer-events: none"
          />
          <div
            id="quick-map-markers-container"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: none;
              transform-origin: center center;
            "
          ></div>
          <div
            class="map-zoom-controls"
            style="
              position: absolute;
              top: 10px;
              left: 10px;
              display: flex;
              flex-direction: column;
              gap: 3px;
              z-index: 100;
            "
          >
            <button
              id="zoom-in-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 16px; background: rgba(255, 255, 255, 0.9)"
            >
              +
            </button>
            <button
              id="zoom-out-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 16px; background: rgba(255, 255, 255, 0.9)"
            >
              âˆ’
            </button>
            <button
              id="zoom-reset-btn"
              class="compact-button"
              style="width: 30px; height: 30px; padding: 0; font-size: 12px; background: rgba(255, 255, 255, 0.9)"
            >
              âŒ‚
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆå°±ç³»ç»Ÿæ¨¡æ€æ¡† -->
    <div id="achievement-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 900px;
          width: 90%;
          max-height: 85vh;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border-radius: 12px 12px 0 0;
            color: #2c1810;
            flex-shrink: 0;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px">
            ğŸ† æˆå°±ç³»ç»Ÿ
          </h2>
          <button
            id="close-achievement-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 20px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.1);
              border: none;
              border-radius: 50%;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            Ã—
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px; flex: 1; overflow-y: auto">
          <div
            id="achievement-stats"
            style="
              background: rgba(139, 69, 19, 0.1);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
              border: 1px solid rgba(139, 105, 20, 0.3);
              text-align: center;
            "
          >
            <div style="font-weight: bold; color: #8b4513; margin-bottom: 8px">æˆå°±è¿›åº¦</div>
            <div id="achievement-progress" style="color: #666"></div>
          </div>
          <div
            id="achievement-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
              gap: 20px;
              align-content: flex-start;
            "
          >
            <!-- æˆå°±å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- æˆå°±è¯¦æƒ…å¼¹çª— -->
    <div id="achievement-detail-modal" class="rules-modal" style="display: none; z-index: 10002">
      <div
        class="rules-modal-content"
        style="
          max-width: 500px;
          width: 90%;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border-radius: 12px 12px 0 0;
            color: #2c1810;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px">
            ğŸ† æˆå°±è¯¦æƒ…
          </h2>
          <button
            id="close-achievement-detail-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 20px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.1);
              border: none;
              border-radius: 50%;
              width: 28px;
              height: 28px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            Ã—
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px">
          <div style="text-align: center; margin-bottom: 20px">
            <div id="achievement-detail-icon" style="font-size: 3em; margin-bottom: 10px">ğŸ†</div>
            <div
              id="achievement-detail-name"
              style="font-size: 1.5em; font-weight: bold; color: #8b4513; margin-bottom: 8px"
            ></div>
            <div
              id="achievement-detail-quality"
              style="
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.9em;
                font-weight: bold;
                color: white;
              "
            ></div>
          </div>
          <div
            id="achievement-detail-description"
            style="margin-bottom: 15px; color: #666; text-align: center; line-height: 1.4"
          ></div>
          <div
            id="achievement-detail-requirement"
            style="
              background: rgba(139, 69, 19, 0.1);
              padding: 12px;
              border-radius: 8px;
              margin-bottom: 15px;
              border: 1px solid rgba(139, 105, 20, 0.3);
            "
          >
            <div style="font-weight: bold; color: #8b4513; margin-bottom: 5px">å®Œæˆæ¡ä»¶:</div>
            <div id="achievement-detail-req-text" style="color: #666"></div>
          </div>
          <div
            id="achievement-detail-reward"
            style="
              background: rgba(139, 69, 19, 0.1);
              padding: 12px;
              border-radius: 8px;
              border: 1px solid rgba(139, 105, 20, 0.3);
            "
          >
            <div style="font-weight: bold; color: #8b4513; margin-bottom: 5px">å®Œæˆæ„Ÿè¨€:</div>
            <div id="achievement-detail-completion-text" style="color: #666; font-style: italic"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
    <div id="music-player-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 400px;
          width: 90%;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
          border: 3px solid #8b6914;
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            border-radius: 12px 12px 0 0;
            color: #2c1810;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px">
            ğŸµ éŸ³ä¹æ’­æ”¾å™¨
          </h2>
          <button
            id="close-music-player-btn"
            class="close-rules-btn"
            style="
              color: #2c1810;
              font-size: 20px;
              font-weight: bold;
              background: rgba(44, 24, 16, 0.1);
              border: none;
              border-radius: 50%;
              width: 28px;
              height: 28px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            Ã—
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px">
          <div id="music-player-content">
            <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
            <div style="text-align: center; margin-bottom: 20px">
              <div
                id="current-track-name"
                style="font-size: 16px; font-weight: bold; margin-bottom: 8px; color: #8b4513"
              >
                æœªé€‰æ‹©éŸ³ä¹
              </div>
              <div id="current-track-time" style="font-size: 12px; color: #666">00:00 / 00:00</div>
            </div>

            <!-- æ—¶é—´è½´æ§åˆ¶ -->
            <div style="margin-bottom: 20px">
              <input
                type="range"
                id="music-progress-slider"
                min="0"
                max="100"
                value="0"
                style="width: 100%; accent-color: #8b4513; margin-bottom: 5px"
              />
              <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666">
                <span id="current-time-display">00:00</span>
                <span id="total-time-display">00:00</span>
              </div>
            </div>

            <!-- æ’­æ”¾æ§åˆ¶ -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 25px">
              <button
                id="music-prev-btn"
                class="music-control-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 16px;
                "
              >
                â®
              </button>
              <button
                id="music-play-pause-btn"
                class="music-control-btn"
                style="
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
                  border: none;
                  color: white;
                  font-size: 18px;
                "
              >
                â–¶
              </button>
              <button
                id="music-next-btn"
                class="music-control-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 16px;
                "
              >
                â­
              </button>
            </div>

            <!-- æ’­æ”¾æ¨¡å¼æ§åˆ¶ -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px">
              <span style="font-size: 12px; color: #666">æ’­æ”¾æ¨¡å¼:</span>
              <button
                id="music-mode-btn"
                class="music-control-btn"
                style="
                  width: 45px;
                  height: 35px;
                  border-radius: 6px;
                  background: rgba(139, 69, 19, 0.1);
                  border: 1px solid rgba(139, 69, 19, 0.3);
                  color: #8b4513;
                  font-size: 18px;
                  cursor: pointer;
                  transition: all 0.2s;
                  position: relative;
                  z-index: 10;
                "
                title="é¡ºåºæ’­æ”¾"
              >
                â–¶ï¸
              </button>
            </div>

            <!-- éŸ³é‡æ§åˆ¶ -->
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px">
              <span style="font-size: 14px; color: #8b4513">ğŸ”Š</span>
              <input
                type="range"
                id="music-volume-slider"
                min="0"
                max="100"
                value="50"
                style="flex: 1; accent-color: #8b4513"
              />
              <span id="volume-display" style="font-size: 12px; color: #666; min-width: 30px">50%</span>
            </div>

            <!-- éŸ³ä¹åˆ—è¡¨ -->
            <div
              style="
                background: rgba(139, 69, 19, 0.1);
                border: 1px solid rgba(139, 69, 19, 0.3);
                border-radius: 8px;
                padding: 10px;
              "
            >
              <div
                class="music-track"
                data-src="https://files.catbox.moe/yyq6oj.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€Šå“ˆåŸºç±³èµ·åºŠæ›²ã€‹ğŸ±</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/qfwwgp.flac"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆãƒ»ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°</div>
                <div style="font-size: 11px; color: #666">FLAC</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/jueda8.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">é©¬å¨˜ç››å®´ï¼ç¾é£Ÿå¤§æ¸¸è¡Œ</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/2izau9.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ãƒˆãƒ¬ã‚»ãƒ³éŸ³é ­ (å¼ºå‡»å®å®çš„)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/v0iy0a.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">è¶…ãˆã‚‹(è¶…è¶Šå§)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/k0r0id.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ãƒˆãƒ¬ã‚»ãƒ³éŸ³é ­ (Game Size)</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/okct8d.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">U.M.A. NEW WORLD!!</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/146x8h.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">GIRLS' LEGEND U</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/agi8yx.mp3"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">Glorious Momentï¼</div>
                <div style="font-size: 11px; color: #666">MP3</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/umai3u.m4a"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å‘¨å¹´åº†éŸ³ä¹1</div>
                <div style="font-size: 11px; color: #666">M4A</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/j0qaqf.m4a"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å‘¨å¹´åº†éŸ³ä¹2</div>
                <div style="font-size: 11px; color: #666">M4A</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/wlhqc9.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">123æˆ‘å“ˆä½ </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ui1gwf.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å“ˆåŸºç±³è¿™ä¸ªç”œèœœã€çº¯å‡€å“ˆåŸºç±³ã€‘</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/34edv0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  ã€å“ˆåŸºç±³ã€‘Conundrum å®ƒå“ˆæ°”äº†ï¼Œæ˜¨å¤©å“ˆçš„ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œå®ƒå‰å¤©å°±æ­»äº†
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ppchr5.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å¾€äº‹åªèƒ½å“ˆåŸº</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/s8c70r.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ç²‰ çº¢ è‰² çš„ åŸº ç±³</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/dchs4n.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€å“ˆåŸºç±³FMã€‘èˆŒå°–ä¸Šçš„åŸºç±³</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/nhrhjl.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€æƒåŸºé¾™ã€‘Ji MI YOU</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/en0iq0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€å“ˆåŸºç±³FMã€‘_å“ˆæ²«</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>

              <div
                class="music-track"
                data-src="https://files.catbox.moe/bq9xsi.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€åŸºæººã€‘æ‚¬æººä¸€å“ï¼ŒåŸºç±³ç™»åœº</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/7zivog.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  ã€è¡¥æ¡£ã€‘ğŸµæ›¼æ³¢ ğ‘µğ’ ğ‘´ğ’ğ’“ğ’†ğŸµä¸å†æ›¼æ³¢ï¼ˆå®Œæ•´ç‰ˆï¼‰
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/8gc10g.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€å®Œæ•´ç‰ˆã€‘æœ€åä¸€å“ˆ</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/33d0tw.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">ã€å“ˆåŸºç±³éŸ³ä¹ã€‘ä¸å¾—ä¸å“ˆ</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/23dd5p.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">
                  ã€Šæ‰“ç«åŸº (å“ˆåŸºç±³)ã€‹å®Œæ•´ç‰ˆï¼Œå“ˆåŸºç±³å•Šå—åŒ—ç»¿è±†ï¼
                </div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/87jhj8.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">åŸºç±³è¯´å®Œæ•´ç‰ˆ</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/6yjali.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å‡ºå±±ï¼ˆå“ˆåŸºç±³ï¼‰å®Œæ•´ç‰ˆ</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/xt6sla.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">è“è²å“ˆ</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/ss1zds.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">è·³æ¥¼åŸº</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/o1gorl.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">æˆ‘è¢«å›°åœ¨äº†å“ˆåŸºä¹¡</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/h3rwx1.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">å“ˆåŸºç±³_talking to the moon</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/idekh0.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">æ›¼æ³¢ ğ‘µğ’ ğ‘´ğ’ğ’“ğ’† ä¸å†æ›¼æ³¢ï¼ˆå®Œæ•´ç‰ˆï¼‰</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
              <div
                class="music-track"
                data-src="https://files.catbox.moe/sudv0z.mp4"
                style="
                  padding: 8px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin-bottom: 5px;
                  transition: background 0.2s;
                "
              >
                <div style="font-weight: bold; font-size: 13px; color: #8b4513">SomeåŸºç±³ just like this</div>
                <div style="font-size: 11px; color: #666">MP4</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åœ°ç‚¹ç¡®è®¤å¼¹çª— -->
    <div id="location-confirm-modal" class="rules-modal" style="display: none; z-index: 10001">
      <div
        class="rules-modal-content"
        style="
          max-width: 480px;
          width: 95%;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        "
      >
        <div
          class="rules-modal-header"
          style="
            padding: 20px 25px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-radius: 12px 12px 0 0;
            color: white;
          "
        >
          <h2 class="rules-title" style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px">
            ğŸ—ºï¸ å‰å¾€åœ°ç‚¹
          </h2>
          <button
            id="close-location-confirm-btn"
            class="close-rules-btn"
            style="
              color: white;
              font-size: 24px;
              font-weight: bold;
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 50%;
              width: 30px;
              height: 30px;
            "
          >
            Ã—
          </button>
        </div>
        <div class="rules-modal-body" style="padding: 25px">
          <div id="location-confirm-content">
            <div style="margin-bottom: 25px; text-align: center">
              <div
                id="confirm-location-name"
                style="
                  font-weight: bold;
                  font-size: 22px;
                  color: #2c3e50;
                  margin-bottom: 12px;
                  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
                "
              ></div>
              <div
                id="confirm-location-description"
                style="
                  font-size: 15px;
                  color: #495057;
                  line-height: 1.6;
                  max-height: 100px;
                  overflow-y: auto;
                  background: rgba(255, 255, 255, 0.7);
                  padding: 15px;
                  border-radius: 8px;
                  border-left: 4px solid #007bff;
                "
              ></div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center">
              <button
                id="cancel-location-move"
                class="compact-button"
                style="
                  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                  color: white;
                  padding: 12px 24px;
                  font-size: 16px;
                  border-radius: 8px;
                  border: none;
                  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
                  transition: all 0.3s ease;
                "
              >
                âŒ å–æ¶ˆ
              </button>
              <button
                id="confirm-location-move"
                class="compact-button"
                style="
                  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                  color: white;
                  padding: 12px 24px;
                  font-size: 16px;
                  border-radius: 8px;
                  border: none;
                  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                  transition: all 0.3s ease;
                "
              >
                ğŸš€ å‰å¾€
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æŒ‡ä»¤ç®¡ç†æ¨¡æ€æ¡† -->

    <div id="command-modal" class="rules-modal" style="display: none">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <h2 class="rules-title">æŒ‡ä»¤ç®¡ç†</h2>

          <button id="close-command-btn" class="close-rules-btn">Ã—</button>
        </div>

        <div class="rules-modal-body">
          <div class="command-section">
            <div class="command-list">
              <!-- æŒ‡ä»¤åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="command-footer">
              <button class="clear-all-btn">æ¸…é™¤å…¨éƒ¨</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- éŸ³æ•ˆ -->

    <audio id="page-flip-sound" preload="auto">
      <source src="https://files.catbox.moe/5ppdp9.mp3" type="audio/mpeg" />
    </audio>

    <audio id="talent-sound" preload="auto">
      <source src="https://files.catbox.moe/5091vt.mp3" type="audio/mpeg" />
    </audio>

    <audio id="tarot-shuffle" preload="auto">
      <source src="https://files.catbox.moe/b4b019.mp3" type="audio/mpeg" />
    </audio>

    <!-- éŸ³ä¹æ’­æ”¾å™¨éŸ³é¢‘å…ƒç´  -->
    <audio id="music-player-audio" preload="auto"></audio>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm-track1" class="music-source" src="https://files.catbox.moe/umai3u.m4a" loop preload="auto"></audio>
    <audio id="bgm-track2" class="music-source" src="https://files.catbox.moe/j0qaqf.m4a" loop preload="auto"></audio>

    <audio id="save-load-sound" preload="auto">
      /* https://files.catbox.moe/txinhc.mp3 */
      <source src="https://files.catbox.moe/vbrvns.mp3" type="audio/mpeg" />
      /* https://files.catbox.moe/m9h2z4.mp3 */
    </audio>

    <audio id="danger-rules-sound" preload="auto">
      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />
    </audio>

    <audio id="item-detail-sound" preload="auto">
      <source src="https://files.catbox.moe/412btp.mp3" type="audio/mpeg" />
    </audio>

    <audio id="uma-roster-sound" preload="auto">
      <source src="https://files.catbox.moe/zxb18s.mp3" type="audio/mpeg" />
    </audio>

    <!-- å˜é‡ç®¡ç†å™¨è„šæœ¬ -->

    <!-- é“å…·ç³»ç»Ÿå‡çº§è„šæœ¬ -->

    <script>
      // é“å…·ç³»ç»Ÿå‡çº§åŠŸèƒ½

      let pendingActions = [];

      let giftSelectionMode = null;

      let skillSelectionMode = null;

      // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä¾›MVUç®¡ç†å™¨ä½¿ç”¨

      window.pendingActions = pendingActions;
      window.giftSelectionMode = giftSelectionMode;
      window.skillSelectionMode = skillSelectionMode;

      // åˆå§‹åŒ–

      $(document).ready(function () {
        loadPendingActions();

        updateActionIcons();

        updateInventoryCommandManager();

        // å®šæœŸæ›´æ–°ç‰©å“æ ç®¡ç†åŠŸèƒ½

        setInterval(function () {
          updateInventoryCommandManager();
        }, 2000);
      });

      // æ·»åŠ å¾…æ‰§è¡ŒæŒ‡ä»¤

      function addPendingAction(action, itemName, extraData = {}) {
        const actionObj = {
          action: action,

          itemName: itemName,

          ...extraData,
        };

        pendingActions.push(actionObj);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();

        // åŒæ­¥åˆ°å…¨å±€

        window.pendingActions = pendingActions;
      }

      // ç§»é™¤æŒ‡å®šæŒ‡ä»¤

      function removeAction(index) {
        pendingActions.splice(index, 1);

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();
      }

      // æ¸…é™¤æ‰€æœ‰æŒ‡ä»¤

      function clearAllActions() {
        if (pendingActions.length === 0) {
          return;
        }

        // ç›´æ¥æ¸…é™¤ï¼Œä¸éœ€è¦ç¡®è®¤
        pendingActions = [];

        // ğŸ”¥ åŒæ­¥åˆ°window.pendingActions
        window.pendingActions = pendingActions;

        savePendingActions();

        updateActionIcons();

        updateInventoryCommandManager();
      }

      // åˆ‡æ¢é“å…·é”å®šçŠ¶æ€

      function toggleItemLock(itemName, button) {
        const isLocked = button.text() === 'è§£é”';

        button.text(isLocked ? 'é”å®š' : 'è§£é”');

        button.css('background', isLocked ? '#4a5568' : '#e53e3e');

        // æ›´æ–°ä¸¢å¼ƒæŒ‰é’®çŠ¶æ€

        const discardBtn = button.siblings('.item-discard-btn');

        if (isLocked) {
          discardBtn.prop('disabled', false).css('opacity', '1');
        } else {
          discardBtn.prop('disabled', true).css('opacity', '0.5');
        }
      }

      // å¼€å§‹èµ é€é€‰æ‹©

      function startGiftSelection(itemName) {
        showGiftHint();

        highlightCharacterCards();

        giftSelectionMode = {
          active: true,

          itemName: itemName,

          startTime: Date.now(),
        };

        // ğŸ”¥ æ›´æ–°å…¨å±€å¼•ç”¨
        window.giftSelectionMode = giftSelectionMode;

        // 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

        setTimeout(() => {
          if (giftSelectionMode?.active) {
            cancelGiftSelection();
          }
        }, 30000);
      }

      // æ˜¾ç¤ºèµ é€æç¤º

      function showGiftHint() {
        // å…ˆç§»é™¤ç°æœ‰çš„æç¤º

        $('.gift-selection-hint').remove();

        const hint = $('<div class="gift-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">ğŸ</span>

              <span class="hint-text">è¯·ç‚¹å‡»è¦èµ é€çš„é©¬å¨˜å¡ç‰‡</span>

              <button class="hint-close" onclick="$(this).closest('.gift-selection-hint').remove()">Ã—</button>

            </div>

          `);

        $('body').append(hint);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤

        setTimeout(() => {
          hint.remove();
        }, 3000);
      }

      // é«˜äº®é©¬å¨˜å¡ç‰‡

      function highlightCharacterCards() {
        $('.character-card, .uma-item, .character-item').addClass('gift-selectable skill-selectable');
      }

      // ğŸ”¥ å¤„ç†é©¬å¨˜å¡ç‰‡ç‚¹å‡»ï¼ˆç»Ÿä¸€å¤„ç†èµ é€å’ŒæŠ€èƒ½é€‰æ‹©ï¼Œä¼˜å…ˆçº§ï¼šæŠ€èƒ½ > èµ é€ > è¡¨æƒ…ï¼‰
      $(document).on('click', '.gift-selectable, .skill-selectable, .uma-item, .character-card', function (e) {
        // ä¼˜å…ˆå¤„ç†æŠ€èƒ½é€‰æ‹©ï¼ˆæ£€æŸ¥å…¨å±€å˜é‡ï¼‰
        if (window.skillSelectionMode && window.skillSelectionMode.active) {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«skill-selectableç±»ï¼ˆhighlightCharacterCardsä¼šæ·»åŠ è¿™ä¸ªç±»ï¼‰
          if (
            $(this).hasClass('skill-selectable') ||
            $(this).hasClass('uma-item') ||
            $(this).hasClass('character-card')
          ) {
            e.stopPropagation();
            e.preventDefault();

            const characterName = getCharacterNameFromCard($(this));
            const characterId = getCharacterIdFromCard($(this));

            // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©ï¼ˆè·Ÿèµ é€ç‰©å“ä¸€æ ·ï¼Œæç¤º"å¯¹xxä½¿ç”¨xx"ï¼‰
            const actionText = `[ä½¿ç”¨æŠ€èƒ½: ${window.skillSelectionMode.skillName} å¯¹ ${characterName}]`;
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              actionInput.focus();
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`å¯¹ ${characterName} ä½¿ç”¨ ${window.skillSelectionMode.skillName}`);
              }
            }

            cancelSkillSelection();
            return false;
          }
        }

        // å…¶æ¬¡å¤„ç†èµ é€é€‰æ‹©ï¼ˆæ£€æŸ¥å…¨å±€å˜é‡ï¼‰
        if (window.giftSelectionMode && window.giftSelectionMode.active) {
          // æ£€æŸ¥æ˜¯å¦åŒ…å«gift-selectableç±»
          if (
            $(this).hasClass('gift-selectable') ||
            $(this).hasClass('uma-item') ||
            $(this).hasClass('character-card')
          ) {
            e.stopPropagation();
            e.preventDefault();

            const characterName = getCharacterNameFromCard($(this));
            const characterId = getCharacterIdFromCard($(this));

            // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©
            const actionText = `[èµ é€é“å…·: ${window.giftSelectionMode.itemName} ç»™ ${characterName}]`;
            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              actionInput.focus();
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`å·²å°† ${actionText} å¡«å…¥è¾“å…¥æ¡†`);
              }
            }

            cancelGiftSelection();
            return false;
          }
        }

        // å¦‚æœä¸åœ¨é€‰æ‹©æ¨¡å¼ï¼Œä¸é˜»æ­¢äº‹ä»¶ï¼Œè®©è¡¨æƒ…å±•ç¤ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
      });

      // å–æ¶ˆèµ é€é€‰æ‹©

      function cancelGiftSelection() {
        clearGiftSelectionMode();

        giftSelectionMode = null;
        window.giftSelectionMode = null;
      }

      // æ¸…é™¤èµ é€é€‰æ‹©æ¨¡å¼

      function clearGiftSelectionMode() {
        $('.gift-selectable').removeClass('gift-selectable');

        $('.skill-selectable').removeClass('skill-selectable');
      }

      // å¼€å§‹æŠ€èƒ½é€‰æ‹©

      function startSkillSelection(skillName, skillType) {
        showSkillHint();

        highlightCharacterCards();

        skillSelectionMode = {
          active: true,

          skillName: skillName,

          skillType: skillType,

          startTime: Date.now(),
        };

        // ğŸ”¥ æ›´æ–°å…¨å±€å¼•ç”¨
        window.skillSelectionMode = skillSelectionMode;

        // 30ç§’è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

        setTimeout(() => {
          if (skillSelectionMode?.active) {
            cancelSkillSelection();
          }
        }, 30000);
      }

      // æ˜¾ç¤ºæŠ€èƒ½æç¤º

      function showSkillHint() {
        // å…ˆç§»é™¤ç°æœ‰çš„æç¤º

        $('.skill-selection-hint').remove();

        const hint = $('<div class="skill-selection-hint gift-selection-hint">').html(`

            <div class="hint-content">

              <span class="hint-icon">âš¡</span>

              <span class="hint-text">è¯·ç‚¹å‡»è¦å¯¹é©¬å¨˜ä½¿ç”¨æŠ€èƒ½çš„ç›®æ ‡</span>

              <button class="hint-close" onclick="$(this).closest('.skill-selection-hint').remove(); cancelSkillSelection();">Ã—</button>

            </div>

          `);

        $('body').append(hint);

        // 3ç§’åè‡ªåŠ¨ç§»é™¤ï¼ˆä¸èµ é€åŠŸèƒ½ä¸€è‡´ï¼‰

        setTimeout(() => {
          hint.remove();
        }, 3000);
      }

      // å–æ¶ˆæŠ€èƒ½é€‰æ‹©

      function cancelSkillSelection() {
        clearSkillSelectionMode();

        skillSelectionMode = null;
        window.skillSelectionMode = null;
      }

      // æ¸…é™¤æŠ€èƒ½é€‰æ‹©æ¨¡å¼

      function clearSkillSelectionMode() {
        $('.skill-selectable').removeClass('skill-selectable');
      }

      // åº”ç”¨è‡ªå®šä¹‰æŠ€èƒ½ç›®æ ‡

      window.applyCustomSkillTarget = function (skillName, skillType) {
        const customTarget = $('#custom-skill-target').val().trim();

        if (!customTarget) {
          alert('è¯·è¾“å…¥ç›®æ ‡');

          return;
        }

        // æ·»åŠ å¾…æ‰§è¡ŒæŒ‡ä»¤

        addPendingAction('skill', skillName, {
          target: customTarget,

          skillType: skillType,
        });

        // å…³é—­æç¤º

        $('.skill-selection-hint').remove();

        // å–æ¶ˆæŠ€èƒ½é€‰æ‹©æ¨¡å¼

        cancelSkillSelection();
      };

      // ä»å¡ç‰‡è·å–è§’è‰²åç§°

      function getCharacterNameFromCard(card) {
        const nameElement = card.find('.character-name, .uma-name, .name');

        return nameElement.length ? nameElement.text().trim() : 'æœªçŸ¥è§’è‰²';
      }

      // ä»å¡ç‰‡è·å–è§’è‰²ID

      function getCharacterIdFromCard(card) {
        return card.data('character-id') || card.attr('id') || 'unknown';
      }

      // ä¿å­˜æŒ‡ä»¤åˆ°æœ¬åœ°å­˜å‚¨

      function savePendingActions() {
        localStorage.setItem('item_pending_actions', JSON.stringify(pendingActions));
      }

      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æŒ‡ä»¤

      function loadPendingActions() {
        const saved = localStorage.getItem('item_pending_actions');

        pendingActions = saved ? JSON.parse(saved) : [];
      }

      // æ›´æ–°æŒ‡ä»¤å›¾æ ‡æ˜¾ç¤º

      function updateActionIcons() {
        const timeLocationBar = $('.time-location-bar');

        if (!timeLocationBar.length) return;

        // ç§»é™¤ç°æœ‰å›¾æ ‡

        timeLocationBar.find('.action-icons-container').remove();

        if (pendingActions.length === 0) return;

        // ç»Ÿè®¡å„ç§æ“ä½œçš„æ•°é‡

        const actionCounts = {
          use: 0,
          discard: 0,
          gift: 0,
          lock: 0,
          skill: 0,
          move: 0,
          meal: 0,
          borrow: 0,
          game: 0,
          chat: 0,
          rest: 0,
        };

        pendingActions.forEach(action => {
          if (actionCounts.hasOwnProperty(action.action)) {
            actionCounts[action.action]++;
          }
        });

        // ç”Ÿæˆå›¾æ ‡HTML

        const icons = [];

        if (actionCounts.use > 0) {
          icons.push(
            `<span class="action-icon use-icon" title="ä½¿ç”¨ ${actionCounts.use} ä¸ªé“å…·"> (${actionCounts.use})</span>`,
          );
        }

        if (actionCounts.discard > 0) {
          icons.push(
            `<span class="action-icon discard-icon" title="ä¸¢å¼ƒ ${actionCounts.discard} ä¸ªé“å…·">ğŸ—‘ï¸ (${actionCounts.discard})</span>`,
          );
        }

        if (actionCounts.gift > 0) {
          icons.push(
            `<span class="action-icon gift-icon" title="èµ é€ ${actionCounts.gift} ä¸ªé“å…·">ğŸ (${actionCounts.gift})</span>`,
          );
        }

        if (actionCounts.lock > 0) {
          icons.push(
            `<span class="action-icon lock-icon" title="é”å®š ${actionCounts.lock} ä¸ªé“å…·">ğŸ”’ (${actionCounts.lock})</span>`,
          );
        }

        if (actionCounts.skill > 0) {
          icons.push(
            `<span class="action-icon skill-icon" title="ä½¿ç”¨ ${actionCounts.skill} ä¸ªæŠ€èƒ½">âš¡ (${actionCounts.skill})</span>`,
          );
        }

        if (actionCounts.move > 0) {
          icons.push(
            `<span class="action-icon move-icon" title="å‰å¾€ ${actionCounts.move} ä¸ªåœ°ç‚¹">ğŸ—ºï¸ (${actionCounts.move})</span>`,
          );
        }

        if (actionCounts.meal > 0) {
          icons.push(
            `<span class="action-icon meal-icon" title="åŠ é¤ ${actionCounts.meal} æ¬¡">ğŸ½ï¸ (${actionCounts.meal})</span>`,
          );
        }

        if (actionCounts.borrow > 0) {
          icons.push(
            `<span class="action-icon borrow-icon" title="å€Ÿé’± ${actionCounts.borrow} æ¬¡">ğŸ’° (${actionCounts.borrow})</span>`,
          );
        }

        if (actionCounts.game > 0) {
          icons.push(
            `<span class="action-icon game-icon" title="æ‰“æ¸¸æˆ ${actionCounts.game} æ¬¡">ğŸ® (${actionCounts.game})</span>`,
          );
        }

        if (actionCounts.chat > 0) {
          icons.push(
            `<span class="action-icon chat-icon" title="èŠå¤© ${actionCounts.chat} æ¬¡">ğŸ’¬ (${actionCounts.chat})</span>`,
          );
        }

        if (actionCounts.rest > 0) {
          icons.push(`<span class="action-icon rest-icon" title="ä¼‘æ¯åˆ°ä¸‹å‘¨">ğŸ˜´ (${actionCounts.rest})</span>`);
        }

        if (icons.length > 0) {
          const iconsContainer = $('<div class="action-icons-container">').html(icons.join(''));

          timeLocationBar.find('.current-location').after(iconsContainer);
        }
      }

      // æ›´æ–°ç‰©å“æ ç®¡ç†æŒ‡ä»¤åŠŸèƒ½

      function updateInventoryCommandManager() {
        const commandDot = $('#command-manager-dot');

        if (pendingActions.length > 0) {
          commandDot.show();

          commandDot.find('.dot-count').text(pendingActions.length);

          // ç»‘å®šç‚¹å‡»äº‹ä»¶

          commandDot.off('click').on('click', function () {
            toggleCommandManager();
          });
        } else {
          commandDot.hide();
        }
      }

      // åˆ‡æ¢æŒ‡ä»¤ç®¡ç†å™¨æ˜¾ç¤º

      function toggleCommandManager() {
        const commandModal = $('#command-modal');

        const isVisible = commandModal.is(':visible');

        if (isVisible) {
          commandModal.hide();
        } else {
          commandModal.show();

          updateCommandList();
        }
      }

      // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶

      $(document).on('click', '#close-command-btn', function () {
        $('#command-modal').hide();
      });

      // ç»‘å®šç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—äº‹ä»¶

      $(document).on('click', '#command-modal', function (e) {
        if (e.target === this) {
          $('#command-modal').hide();
        }
      });

      // ç»‘å®šæ¸…é™¤å…¨éƒ¨æŒ‰é’®äº‹ä»¶

      $(document).on('click', '.clear-all-btn', function () {
        clearAllActions();

        updateCommandList();
      });

      // æ›´æ–°æŒ‡ä»¤åˆ—è¡¨

      function updateCommandList() {
        const commandList = $('#command-modal .command-list');

        if (pendingActions.length === 0) {
          commandList.html('<div class="empty-command">æš‚æ— å¾…æ‰§è¡ŒæŒ‡ä»¤</div>');

          return;
        }

        const commandItems = pendingActions

          .map(
            (action, index) => `

                <div class="command-item">

                  <div class="command-content">

                    <span class="command-icon">${getActionIcon(action.action)}</span>

                    <span class="command-text">${formatActionText(action)}</span>

                  </div>

                  <button class="remove-command-btn" onclick="removeAction(${index}); updateCommandList();">Ã—</button>

                </div>

              `,
          )

          .join('');

        commandList.html(commandItems);
      }

      // è·å–æ“ä½œå›¾æ ‡

      function getActionIcon(action) {
        const icons = {
          use: ' ',

          discard: 'ğŸ—‘ï¸',

          gift: 'ğŸ',

          lock: 'ğŸ”’',

          skill: 'âš¡',

          meal: 'ğŸ½ï¸',

          borrow: 'ğŸ’°',

          game: 'ğŸ®',

          chat: 'ğŸ’¬',

          rest: 'ğŸ˜´',

          move: 'ğŸš¶',
        };

        return icons[action] || 'ğŸ“';
      }

      // æ ¼å¼åŒ–æŒ‡ä»¤æ–‡æœ¬

      function formatActionText(action) {
        switch (action.action) {
          case 'use':
            let useText = `ä½¿ç”¨é“å…· [${action.itemName}]`;
            if (action.itemData) {
              useText += `\næ•ˆæœ: ${action.itemData.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜'}`;
              useText += `\nç¨€æœ‰åº¦: ${action.itemData.ç¨€æœ‰åº¦ || 'æ™®é€š'}`;
            }
            return useText;

          case 'move':
            let moveText = `å‰å¾€ [${action.itemName}]`;
            if (action.description) {
              moveText += `\næè¿°: ${action.description}`;
            }
            return moveText;

          case 'discard':
            let discardText = `ä¸¢å¼ƒé“å…· [${action.itemName}]`;
            if (action.itemData) {
              discardText += `\næè¿°: ${action.itemData.æè¿° || 'æ— æè¿°'}`;
            }
            return discardText;

          case 'gift':
            let giftText = `èµ é€é“å…· [${action.itemName}] ç»™ [${action.characterName || action.target}]`;
            if (action.itemData) {
              giftText += `\næ•ˆæœ: ${action.itemData.æ•ˆæœ || 'æ— æ•ˆæœè¯´æ˜'}`;
            }
            return giftText;

          case 'lock':
            let lockText = `é”å®šé“å…· [${action.itemName}]`;
            if (action.itemData) {
              lockText += `\næè¿°: ${action.itemData.æè¿° || 'æ— æè¿°'}`;
            }
            return lockText;

          case 'skill':
            // è·å–æŠ€èƒ½è¯¦ç»†ä¿¡æ¯
            let skillInfo = '';
            if (action.skillType && action.majorTalent) {
              // æ ¹æ®æŠ€èƒ½ç±»å‹è·å–è¯¦ç»†ä¿¡æ¯
              const skillDetails = {
                // å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰
                defense: { name: 'é˜²å¾¡æŠ€èƒ½', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é˜²å¾¡èƒ½åŠ›ï¼Œå¯ä»¥å¼ºåŒ–è‡ªèº«é˜²å¾¡åŠ›ã€‚' },
                rule_enhance: { name: 'è§„åˆ™æ´å¯Ÿ', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„æ´å¯Ÿèƒ½åŠ›ï¼Œå¯ä»¥çœ‹ç©¿è§„åˆ™çš„æœ¬è´¨ã€‚' },
                chain_enhance: { name: 'é”é“¾æ§åˆ¶', description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„æ§åˆ¶èƒ½åŠ›ï¼Œå¯ä»¥å¼ºåŒ–é”é“¾çš„æŸç¼šæ•ˆæœã€‚' },
                // å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰
                rule_change: { name: 'è§„åˆ™ä¿®æ”¹', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„ä¿®æ”¹èƒ½åŠ›ï¼Œå¯ä»¥ä¸´æ—¶æ”¹å˜è§„åˆ™ã€‚' },
                emotion: { name: 'æƒ…æ„Ÿæ“æ§', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥æ“æ§ç›®æ ‡çš„æƒ…æ„Ÿã€‚' },
                shadow: { name: 'å½±å­æ“æ§', description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„å½±å­èƒ½åŠ›ï¼Œå¯ä»¥æ“æ§å½±å­è¿›è¡Œæ”»å‡»ã€‚' },
                // æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰
                emotion_release: {
                  name: 'æƒ…ç»ªé‡Šæ”¾',
                  description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„é‡Šæ”¾èƒ½åŠ›ï¼Œå¯ä»¥é‡Šæ”¾å¼ºçƒˆçš„æƒ…æ„Ÿèƒ½é‡ã€‚',
                },
                sacrifice: { name: 'ç”Ÿå‘½çŒ®ç¥­', description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„çŒ®ç¥­èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²ç”Ÿå‘½æˆ–è®°å¿†è·å¾—åŠ›é‡ã€‚' },
                phantom: { name: 'åˆ†èº«å…·ç°', description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„åˆ†èº«èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å¹»å½±åˆ†èº«ã€‚' },
                // æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰
                suggestion: { name: 'å¿ƒç†æš—ç¤º', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¿ƒç†æš—ç¤ºèƒ½åŠ›ï¼Œå¯ä»¥æ¤å…¥æ€æƒ³æ§åˆ¶ç›®æ ‡ã€‚' },
                control: { name: 'ç²¾ç¥æ“æ§', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„ç²¾ç¥æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥æ§åˆ¶æ•Œäººè¡ŒåŠ¨ã€‚' },
                absorption: { name: 'çˆ±æ„å¸æ”¶', description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¸æ”¶èƒ½åŠ›ï¼Œå¯ä»¥å¸æ”¶ä»–äººçš„çˆ±æ„è·å¾—åŠ›é‡ã€‚' },
                // å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰
                armor: { name: 'ç†æƒ³ç›”ç”²', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„ç›”ç”²èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„é˜²æŠ¤è£…å¤‡ã€‚' },
                ring: { name: 'æ‰¿è¯ºæˆ’æŒ‡', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„æˆ’æŒ‡èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–æ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ã€‚' },
                npc: { name: 'å®Œç¾NPC', description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„NPCèƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„åŠ©æ‰‹ã€‚' },
                // ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰
                contract: { name: 'æ€ªè°ˆå¥‘çº¦', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å¥‘çº¦èƒ½åŠ›ï¼Œå¯ä»¥ä¸è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦ã€‚' },
                resonance: { name: 'æƒ…ç»ªå…±é¸£', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å…±é¸£èƒ½åŠ›ï¼Œå¯ä»¥ä¸ç›®æ ‡è¿›è¡Œæƒ…ç»ªå…±é¸£ã€‚' },
                chaos: { name: 'æ··æ²Œæ··åˆ', description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„æ··åˆèƒ½åŠ›ï¼Œå¯ä»¥æ··åˆä¸åŒçˆ±æ„åˆ›é€ æ–°æŠ€èƒ½ã€‚' },
              };

              const skillDetail = skillDetails[action.skillType];
              if (skillDetail) {
                skillInfo = `ä½¿ç”¨å¤§å¤©èµ‹æŠ€èƒ½ [${skillDetail.name}] (${action.majorTalent})\næŠ€èƒ½æè¿°: ${skillDetail.description}`;
              }
            }

            if (action.target === 'self') {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: è‡ªå·±`;
            } else if (action.target === 'uma' && action.characterName) {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: ${action.characterName}`;
            } else {
              return `${skillInfo}\nä½¿ç”¨ç›®æ ‡: æœªæŒ‡å®š`;
            }

          case 'meal':
            return `åŠ é¤${action.characterName ? ` ä¸ [${action.characterName}]` : ''}`;

          case 'borrow':
            return `å€Ÿé’±${action.characterName ? ` å‘ [${action.characterName}]` : ''}`;

          case 'game':
            return `æ‰“æ¸¸æˆ${action.characterName ? ` ä¸ [${action.characterName}]` : ''}`;

          case 'chat':
            return `èŠå¤©${action.characterName ? ` ä¸ [${action.characterName}]` : ''}`;

          case 'rest':
            return `ä¼‘æ¯åˆ°ä¸‹å‘¨${action.description ? `\n${action.description}` : ''}`;

          default:
            return JSON.stringify(action);
        }
      }

      // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯

      function showTemporaryMessage(message) {
        const messageDiv = $('<div class="temporary-message">').text(message);

        $('body').append(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 2000);
      }

      // è·å–å¾…æ‰§è¡ŒæŒ‡ä»¤ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰

      window.getPendingActions = function () {
        return pendingActions;
      };

      // æ¸…é™¤æ‰€æœ‰æŒ‡ä»¤ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰

      window.clearAllPendingActions = function () {
        clearAllActions();
      };

      // ESCé”®å–æ¶ˆèµ é€é€‰æ‹©

      $(document).on('keydown', function (e) {
        if (e.key === 'Escape' && giftSelectionMode?.active) {
          cancelGiftSelection();
        }

        if (e.key === 'Escape' && skillSelectionMode?.active) {
          cancelSkillSelection();
        }
      });
    </script>

    <!-- é“å…·ç³»ç»Ÿæ ·å¼ -->

    <style>
      /* é“å…·å¼¹çª—æŒ‰é’®æ ·å¼ */

      .item-info-row {
        display: flex;

        justify-content: space-between;

        align-items: center;

        margin-top: 0.5rem;
      }

      .item-actions {
        display: flex;

        gap: 4px;

        align-items: center;
      }

      .item-use-btn,
      .item-discard-btn,
      .item-lock-btn,
      .item-gift-btn {
        padding: 6px;

        border: none;

        border-radius: 50%;

        font-size: 14px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        width: 28px;

        height: 28px;

        display: flex;

        align-items: center;

        justify-content: center;

        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .item-use-btn:hover,
      .item-discard-btn:hover,
      .item-lock-btn:hover,
      .item-gift-btn:hover {
        transform: scale(1.1);

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .item-use-btn {
        background: #38a169;

        color: white;
      }

      .item-use-btn:hover {
        background: #2f855a;
      }

      .item-discard-btn {
        background: #e53e3e;

        color: white;
      }

      .item-discard-btn:hover {
        background: #c53030;
      }

      .item-discard-btn:disabled {
        opacity: 0.5;

        cursor: not-allowed;
      }

      .item-lock-btn {
        background: #4a5568;

        color: white;
      }

      .item-lock-btn:hover {
        background: #2d3748;
      }

      .item-gift-btn {
        background: #d69e2e;

        color: white;
      }

      .item-gift-btn:hover {
        background: #b7791f;
      }

      /* æŒ‡ä»¤å›¾æ ‡æ ·å¼ */

      .action-icons-container {
        display: flex;

        align-items: center;

        gap: 8px;

        margin: 0 15px;
      }

      .action-icon {
        display: inline-flex;

        align-items: center;

        padding: 3px 6px;

        border-radius: 12px;

        font-size: 11px;

        font-weight: bold;

        cursor: pointer;

        transition: all 0.2s;

        border: 1px solid transparent;
      }

      .action-icon:hover {
        transform: scale(1.1);
      }

      .use-icon {
        background: #38a169;

        color: white;

        border-color: #2f855a;
      }

      .discard-icon {
        background: #e53e3e;

        color: white;

        border-color: #c53030;
      }

      .gift-icon {
        background: #d69e2e;

        color: white;

        border-color: #b7791f;
      }

      .lock-icon {
        background: #4a5568;

        color: white;

        border-color: #2d3748;
      }

      .skill-icon {
        background: #805ad5;

        color: white;

        border-color: #6b46c1;
      }

      /* èµ é€é€‰æ‹©æç¤ºæ ·å¼ */

      .gift-selection-hint {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;
      }

      .hint-content {
        display: flex;

        align-items: center;

        gap: 10px;
      }

      .hint-icon {
        font-size: 18px;
      }

      .hint-close {
        background: none;

        border: none;

        color: white;

        font-size: 16px;

        cursor: pointer;

        margin-left: 10px;
      }

      /* æŠ€èƒ½é€‰æ‹©æç¤ºæ ·å¼ */

      .skill-selection-hint {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(128, 90, 213, 0.9);

        color: white;

        padding: 15px 20px;

        border-radius: 8px;

        font-size: 14px;

        z-index: 1001;

        animation: fadeInOut 2s ease-in-out;
      }

      /* æŠ€èƒ½ç³»ç»Ÿæ ·å¼ */

      .skills-section {
        display: flex;

        gap: 8px;

        align-items: center;

        margin: 0 15px;
      }

      .skill-btn {
        display: flex;

        align-items: center;

        justify-content: center;

        padding: 2px 4px;

        border: 1px solid #8b4513;

        border-radius: 4px;

        background: linear-gradient(135deg, #2d1b1b, #1a0f0f);

        color: #ffffff;

        cursor: pointer;

        transition: all 0.3s ease;

        width: 24px;

        height: 24px;

        box-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
      }

      .skill-btn:hover {
        transform: translateY(-2px);

        box-shadow: 0 4px 16px rgba(139, 69, 19, 0.5);

        border-color: #a0522d;
      }

      .skill-btn:active {
        transform: translateY(0);
      }

      .skill-icon {
        font-size: 12px;

        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
      }

      .no-skills-message {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border: 1px solid rgba(139, 69, 19, 0.3);
        border-radius: 4px;
        background: linear-gradient(135deg, rgba(45, 27, 27, 0.6), rgba(26, 15, 15, 0.6));
        color: rgba(139, 69, 19, 0.9);
        font-size: 11px;
        font-style: italic;
        width: 120px;
        height: 24px;
        box-shadow: 0 1px 3px rgba(139, 69, 19, 0.3);
        opacity: 1;
        transition: all 0.3s ease;
      }

      .no-skills-message:hover {
        opacity: 1;
        border-color: rgba(139, 69, 19, 0.5);
        box-shadow: 0 2px 4px rgba(139, 69, 19, 0.3);
      }

      .skill-use-btn {
        background: linear-gradient(135deg, #805ad5, #6b46c1);

        color: white;

        border: none;

        border-radius: 0.25rem;

        padding: 0.25rem 0.5rem;

        font-size: 0.7rem;

        cursor: pointer;

        margin: 0.25rem 0.25rem 0 0;

        transition: all 0.2s;
      }

      .skill-use-btn:hover {
        background: linear-gradient(135deg, #6b46c1, #553c9a);

        transform: translateY(-1px);
      }

      @keyframes fadeInOut {
        0%,
        100% {
          opacity: 0;
        }

        20%,
        80% {
          opacity: 1;
        }
      }

      /* å¯é€‰æ‹©çš„é©¬å¨˜å¡ç‰‡æ ·å¼ */

      .gift-selectable {
        cursor: pointer;
        border: 3px solid #e91e63 !important;
        box-shadow:
          0 0 15px rgba(233, 30, 99, 0.8),
          inset 0 0 15px rgba(233, 30, 99, 0.3) !important;
        transition: all 0.3s ease;
        animation: gift-pulse 1.5s ease-in-out infinite;
      }

      @keyframes gift-pulse {
        0%,
        100% {
          box-shadow:
            0 0 15px rgba(233, 30, 99, 0.8),
            inset 0 0 15px rgba(233, 30, 99, 0.3);
        }
        50% {
          box-shadow:
            0 0 25px rgba(233, 30, 99, 1),
            inset 0 0 20px rgba(233, 30, 99, 0.5);
        }
      }

      .skill-selectable {
        cursor: pointer;
        border: 3px solid #805ad5 !important;
        box-shadow:
          0 0 15px rgba(128, 90, 213, 0.8),
          inset 0 0 15px rgba(128, 90, 213, 0.3) !important;
        transition: all 0.3s ease;
        animation: skill-pulse 1.5s ease-in-out infinite;
      }

      @keyframes skill-pulse {
        0%,
        100% {
          box-shadow:
            0 0 15px rgba(128, 90, 213, 0.8),
            inset 0 0 15px rgba(128, 90, 213, 0.3);
        }
        50% {
          box-shadow:
            0 0 25px rgba(128, 90, 213, 1),
            inset 0 0 20px rgba(128, 90, 213, 0.5);
        }
      }

      .skill-selectable:hover {
        border-color: #9f7aea !important;
        box-shadow:
          0 0 30px rgba(128, 90, 213, 1),
          inset 0 0 25px rgba(128, 90, 213, 0.6) !important;
      }

      /* ä¸´æ—¶æ¶ˆæ¯æ ·å¼ */

      .temporary-message {
        position: fixed;

        top: 20px;

        right: 20px;

        background: rgba(0, 0, 0, 0.8);

        color: white;

        padding: 10px 15px;

        border-radius: 6px;

        font-size: 12px;

        z-index: 1002;

        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);

          opacity: 0;
        }

        to {
          transform: translateX(0);

          opacity: 1;
        }
      }

      @keyframes tarotResultFadeIn {
        from {
          opacity: 0;
          transform: scale(0.8) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .tarot-result-card:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 8px 25px rgba(168, 85, 247, 0.5);
      }

      .tarot-result-card.reversed:hover {
        transform: rotate(180deg) translateY(-5px) scale(1.05);
      }

      @keyframes tarotStartPulse {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes tarotIconFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes tarotDotPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes tarotFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
          opacity: 0.3;
        }
        50% {
          transform: translateY(-15px) rotate(5deg);
          opacity: 0.6;
        }
      }

      /* ç‰©å“æ æŒ‡ä»¤ç®¡ç†å™¨æ ·å¼ - å‚è€ƒä¸ªäººæ¡£æ¡ˆå’Œäººç‰©å†ç¨‹çš„å¼¹çª—è®¾è®¡ */

      .command-manager-dot {
        display: inline-flex;

        align-items: center;

        margin-left: auto;

        cursor: pointer;

        background: #e53e3e;

        color: white;

        border-radius: 12px;

        padding: 2px 6px;

        font-size: 11px;

        font-weight: bold;

        transition: all 0.2s;

        animation: pulse 1.5s infinite;
      }

      .command-manager-dot:hover {
        background: #c53030;

        transform: scale(1.1);
      }

      .dot-icon {
        margin-right: 3px;
      }

      .dot-count {
        font-size: 10px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.7;
        }
      }

      .command-section {
        margin-bottom: 1rem;
      }

      .command-list {
        flex-direction: column;

        gap: 0.5rem;

        max-height: 300px;

        display: flex;

        overflow-y: auto;

        margin-bottom: 1rem;
      }

      .command-item {
        background-color: #8b69141a;

        border-left: 2px solid #8b6914;

        border-radius: 0.25rem;

        padding: 0.5rem;

        display: flex;

        align-items: center;

        justify-content: space-between;
      }

      .command-content {
        display: flex;

        align-items: center;

        flex: 1;
      }

      .command-icon {
        margin-right: 0.5rem;

        font-size: 0.875rem;
      }

      .command-text {
        flex: 1;

        font-size: 0.75rem;

        color: #654321;

        font-weight: 500;
      }

      .remove-command-btn {
        background: #e53e3e;

        color: white;

        border: none;

        width: 16px;

        height: 16px;

        border-radius: 50%;

        cursor: pointer;

        font-size: 10px;

        line-height: 1;

        transition: all 0.2s;

        margin-left: 0.5rem;
      }

      .remove-command-btn:hover {
        background: #c53030;

        transform: scale(1.1);
      }

      .command-footer {
        text-align: center;

        padding-top: 0.5rem;

        margin-top: 0.5rem;

        border-top: 1px solid #8b691433;
      }

      .clear-all-btn {
        background: #e53e3e;

        color: white;

        border: none;

        border-radius: 0.375rem;

        padding: 0.5rem 1rem;

        font-size: 0.875rem;

        font-weight: 600;

        cursor: pointer;

        transition: all 0.2s;
      }

      .clear-all-btn:hover {
        background: #c53030;

        transform: translateY(-1px);
      }

      .empty-command {
        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.75rem;
      }

      /* å­˜æ¡£æ ·å¼ */

      .save-item {
        background: rgba(139, 105, 20, 0.1);

        border: 1px solid rgba(139, 105, 20, 0.3);

        border-radius: 0.375rem;

        padding: 0.75rem;

        margin-bottom: 0.5rem;

        cursor: pointer;

        transition: all 0.2s;
      }

      .save-item:hover {
        background: rgba(139, 105, 20, 0.2);

        border-color: rgba(139, 105, 20, 0.5);

        transform: translateY(-1px);
      }

      /* æ‰‹åŠ¨å­˜æ¡£æ ·å¼ */

      .manual-save-item {
        background: rgba(59, 130, 246, 0.1);

        border: 1px solid rgba(59, 130, 246, 0.3);
      }

      .manual-save-item:hover {
        background: rgba(59, 130, 246, 0.2);

        border-color: rgba(59, 130, 246, 0.5);
      }

      /* è‡ªåŠ¨å­˜æ¡£æ ·å¼ */

      .auto-save-item {
        background: rgba(34, 197, 94, 0.1);

        border: 1px solid rgba(34, 197, 94, 0.3);

        position: relative;
      }

      .auto-save-item:hover {
        background: rgba(34, 197, 94, 0.2);

        border-color: rgba(34, 197, 94, 0.5);
      }

      /* ä¸–ç•Œä¹¦å­˜æ¡£æ ·å¼ */

      .worldbook-save-item {
        background: rgba(168, 85, 247, 0.1);

        border: 1px solid rgba(168, 85, 247, 0.3);
      }

      .worldbook-save-item:hover {
        background: rgba(168, 85, 247, 0.2);

        border-color: rgba(168, 85, 247, 0.5);
      }

      .save-type {
        font-size: 0.75rem;

        font-weight: 600;

        margin-top: 0.25rem;
      }

      .manual-save-item .save-type {
        color: #3b82f6;
      }

      .auto-save-item .save-type {
        color: #22c55e;
      }

      .worldbook-save-item .save-type {
        color: #a855f7;
      }

      .save-name {
        font-weight: bold;

        margin-bottom: 0.25rem;

        color: #e0e0e0;
      }

      .save-content {
        font-size: 0.8rem;

        color: #c0c0c0;

        margin-bottom: 0.25rem;

        line-height: 1.3;

        max-height: 2.6rem;

        overflow: hidden;

        text-overflow: ellipsis;

        display: -webkit-box;

        -webkit-line-clamp: 2; /* WebKitæµè§ˆå™¨ */

        line-clamp: 2; /* æ ‡å‡†å±æ€§ï¼Œæé«˜å…¼å®¹æ€§ */

        -webkit-box-orient: vertical;
      }

      .save-time {
        font-size: 0.75rem;

        color: #a0a0a0;
      }

      .empty-save {
        text-align: center;

        color: #8b4513;

        padding: 1rem;

        font-size: 0.875rem;

        font-style: italic;
      }

      /* QTEæŒ£æ‰åŒºåŸŸæ ·å¼ */

      .qte-section {
        margin-top: 15px;

        padding: 15px;

        background: rgba(139, 69, 19, 0.05);

        border: 2px dashed rgba(139, 69, 19, 0.3);

        border-radius: 8px;

        animation: qtePulse 2s ease-in-out infinite;
      }

      @keyframes qtePulse {
        0%,
        100% {
          border-color: rgba(139, 69, 19, 0.3);
        }

        50% {
          border-color: rgba(139, 69, 19, 0.6);
        }
      }

      .qte-container {
        text-align: center;
      }

      .qte-info {
        margin-bottom: 15px;
      }

      .qte-description {
        font-size: 1.1em;

        font-weight: bold;

        color: #8b4513;

        margin: 0 0 5px 0;

        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      }

      .qte-subtitle {
        font-size: 0.9em;

        color: #654321;

        margin: 0;

        font-style: italic;
      }

      .qte-options {
        display: flex;

        gap: 10px;

        justify-content: center;

        flex-wrap: wrap;
      }

      .qte-btn {
        display: flex;

        flex-direction: column;

        align-items: center;

        padding: 12px 16px;

        border: 2px solid #8b4513;

        border-radius: 8px;

        background: rgba(244, 241, 232, 0.9);

        cursor: pointer;

        transition: all 0.3s ease;

        min-width: 100px;

        box-shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
      }

      .qte-btn:hover {
        transform: translateY(-2px);

        box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);

        background: rgba(244, 241, 232, 1);
      }

      .qte-btn:active {
        transform: translateY(0);
      }

      .qte-icon {
        font-size: 1.5em;

        margin-bottom: 5px;
      }

      .qte-text {
        font-weight: bold;

        color: #8b4513;

        font-size: 0.9em;

        margin-bottom: 3px;
      }

      .qte-desc {
        font-size: 0.75em;

        color: #654321;

        opacity: 0.8;
      }

      .struggle-btn:hover {
        border-color: #dc2626;

        background: rgba(220, 38, 38, 0.1);
      }

      .submit-btn:hover {
        border-color: #059669;

        background: rgba(5, 150, 105, 0.1);
      }
    </style>

    <!-- å¤©èµ‹ç®¡ç†æ¨¡æ€æ¡† -->

    <div id="talents-modal" class="rules-modal" style="display: none; justify-content: center; align-items: center">
      <div
        class="rules-modal-content"
        style="
          max-width: 1200px;
          width: 95%;
          max-height: 90vh;
          background: linear-gradient(135deg, #2d1b1b, #1a0f0f);
          border: 2px solid #8b4513;
        "
      >
        <div
          class="rules-modal-header"
          style="
            background: linear-gradient(135deg, #8b6914, #a0865a);
            padding: 2px 20px;
            border-bottom: 1px solid #654321;
            display: flex;
            justify-content: flex-end;
            position: relative;
            min-height: 30px;
          "
        >
          <button
            id="close-talents-btn"
            class="close-rules-btn"
            style="
              background: rgba(255, 255, 255, 0.15);
              border: 1px solid rgba(255, 255, 255, 0.2);
              color: #ffffff;
              font-size: 14px;
              padding: 3px 6px;
              border-radius: 3px;
              cursor: pointer;
              position: absolute;
              top: 6px;
              right: 20px;
              transition: all 0.2s ease;
            "
          >
            Ã—
          </button>
        </div>

        <div
          class="rules-modal-body"
          style="
            padding: 20px 30px 30px 30px;
            background: linear-gradient(135deg, #fdfbf7 0%, #f5f0e8 100%);
            min-height: 500px;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
          "
        >
          <!-- ä¹¦é¡µç¿»é¡µæ§åˆ¶ - åº•éƒ¨ä¹¦ç­¾å¼è®¾è®¡ -->

          <div
            class="book-controls"
            style="
              position: absolute;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 20px;
              z-index: 10;
            "
          >
            <button
              id="prev-page-btn"
              class="page-btn book-tab"
              onclick="window.teresenDebug.prevTalentPage()"
              style="
                background: linear-gradient(135deg, #8b6914, #a0865a);
                border: 2px solid #654321;
                color: #ffffff;
                padding: 8px 16px;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3);
                transform: translateY(0);
              "
            >
              <span style="font-size: 14px">â—€</span>

              <span>ä¸Šä¸€é¡µ</span>
            </button>

            <div
              class="page-indicator book-tab"
              style="
                background: linear-gradient(135deg, rgba(139, 105, 20, 0.15), rgba(160, 134, 90, 0.08));
                border: 2px solid rgba(139, 105, 20, 0.4);
                border-radius: 8px 8px 0 0;
                padding: 8px 16px;
                text-align: center;
                box-shadow: 0 -2px 12px rgba(139, 105, 20, 0.2);
                transform: translateY(0);
              "
            >
              <div
                id="current-page-title"
                style="color: #8b4513; font-size: 13px; font-weight: bold; margin-bottom: 2px"
              >
                ğŸ“– ç¬¬ <span id="page-number">1</span> é¡µ
              </div>

              <div style="color: #666666; font-size: 10px">å…± 7 é¡µ</div>
            </div>

            <button
              id="next-page-btn"
              class="page-btn book-tab"
              onclick="window.teresenDebug.nextTalentPage()"
              style="
                background: linear-gradient(135deg, #8b6914, #a0865a);
                border: 2px solid #654321;
                color: #ffffff;
                padding: 8px 16px;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 -2px 8px rgba(139, 105, 20, 0.3);
                transform: translateY(0);
              "
            >
              <span>ä¸‹ä¸€é¡µ</span>

              <span style="font-size: 14px">â–¶</span>
            </button>
          </div>

          <!-- ä¹¦é¡µå†…å®¹ - çœŸæ­£çš„ä¹¦é¡µç¿»é¡µæ•ˆæœ -->

          <div class="book-content" style="position: relative; overflow: hidden; min-height: 600px">
            <div
              id="book-pages-container"
              style="display: flex; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); height: 100%"
            >
              <!-- å½“å‰å¤©èµ‹é¡µé¢ -->

              <div class="book-page" style="width: 100%; flex-shrink: 0; padding: 20px">
                <div
                  class="book-page-content"
                  style="
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9));
                    border: 2px solid rgba(139, 105, 20, 0.3);
                    border-radius: 16px;
                    padding: 30px;
                    min-height: 500px;
                    box-shadow:
                      0 8px 32px rgba(139, 105, 20, 0.15),
                      inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    max-width: 800px;
                    margin: 0 auto;
                    position: relative;
                  "
                >
                  <!-- ä¹¦é¡µè£…é¥°è§’ -->

                  <div
                    style="
                      position: absolute;
                      top: 15px;
                      right: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, transparent 50%, rgba(139, 105, 20, 0.2) 50%);
                      border-radius: 0 16px 0 0;
                    "
                  ></div>

                  <div
                    style="
                      position: absolute;
                      bottom: 15px;
                      left: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, rgba(139, 105, 20, 0.2) 50%, transparent 50%);
                      border-radius: 0 0 0 16px;
                    "
                  ></div>

                  <h3
                    style="
                      color: #8b4513;
                      font-size: 20px;
                      font-weight: bold;
                      margin-bottom: 25px;
                      text-align: center;
                      text-shadow: 0 2px 4px rgba(139, 105, 20, 0.2);
                      font-family: 'Georgia', serif;
                    "
                  >
                    ğŸŒŸ å½“å‰å¤©èµ‹
                  </h3>

                  <div id="current-talents-list" class="talents-list" style="min-height: 350px"></div>
                </div>
              </div>

              <!-- èŒèŠ½é¡µé¢ -->

              <div class="book-page" style="width: 100%; flex-shrink: 0; padding: 20px">
                <div
                  class="book-page-content"
                  style="
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 240, 232, 0.9));
                    border: 2px solid rgba(139, 69, 19, 0.3);
                    border-radius: 16px;
                    padding: 30px;
                    min-height: 500px;
                    box-shadow:
                      0 8px 32px rgba(139, 69, 19, 0.15),
                      inset 0 1px 0 rgba(255, 255, 255, 0.8);
                    max-width: 800px;
                    margin: 0 auto;
                    position: relative;
                  "
                >
                  <!-- ä¹¦é¡µè£…é¥°è§’ -->

                  <div
                    style="
                      position: absolute;
                      top: 15px;
                      right: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, transparent 50%, rgba(139, 69, 19, 0.2) 50%);
                      border-radius: 0 16px 0 0;
                    "
                  ></div>

                  <div
                    style="
                      position: absolute;
                      bottom: 15px;
                      left: 15px;
                      width: 20px;
                      height: 20px;
                      background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 50%, transparent 50%);
                      border-radius: 0 0 0 16px;
                    "
                  ></div>

                  <h3
                    style="
                      color: #8b4513;
                      font-size: 20px;
                      font-weight: bold;
                      margin-bottom: 25px;
                      text-align: center;
                      text-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
                      font-family: 'Georgia', serif;
                    "
                  >
                    ğŸŒ± èŒèŠ½ (The Seed)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">
                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(75, 0, 0, 0.12), rgba(50, 0, 0, 0.06));
                        border: 2px solid rgba(75, 0, 0, 0.35);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(75, 0, 0, 0.2);
                      "
                    >
                      <h4
                        style="
                          color: #dc2626;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ“– æ•…äº‹èƒŒæ™¯
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          text-shadow: none;
                          letter-spacing: 0.3px;
                        "
                      >
                        "ä½ åªæ˜¯åœ¨ç»å¢ƒä¸­ï¼Œæ— æ„è¯†åœ°æŠ“ä½äº†æ±‚ç”Ÿçš„ç¨»è‰ã€‚è¿™ä»½åŠ›é‡å¾®å¼±ã€ä¸å—æ§åˆ¶ï¼Œæ˜¯ä½ åœ¨è¿™åˆ«æ ·ä¸–ç•Œä¸­å‘å‡ºçš„ç¬¬ä¸€å£°å¾®å¼±çš„å•¼å“­ã€‚"
                      </p>
                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯
                      </h4>

                      <div id="seed-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç”Ÿé•¿é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    ğŸŒ¿ ç”Ÿé•¿ (The Growth)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">
                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(139, 0, 0, 0.15), rgba(75, 0, 0, 0.08));
                        border: 2px solid rgba(139, 0, 0, 0.4);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(139, 0, 0, 0.2);
                      "
                    >
                      <h4
                        style="
                          color: #dc2626;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ“– æ•…äº‹èƒŒæ™¯
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "ä½ å¼€å§‹ç†è§£å¹¶æœ‰æ„è¯†åœ°è¿ç”¨è¿™ä»½åŠ›é‡ï¼Œå°†å…¶ä½œä¸ºè§£å†³é—®é¢˜çš„å·¥å…·ã€‚ä½ ä»è¢«åŠ¨çš„å—å®³è€…ï¼Œè½¬å˜ä¸ºä¸€ä¸ªèƒ½åœ¨æ£‹ç›˜ä¸Šè°¨æ…è½å­çš„å‚ä¸è€…ã€‚"
                      </p>
                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯
                      </h4>

                      <div id="growth-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç•¸å˜é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    ğŸŒ€ ç•¸å˜ (The Aberration)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">
                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(75, 0, 130, 0.18), rgba(45, 0, 80, 0.1));
                        border: 2px solid rgba(75, 0, 130, 0.5);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(75, 0, 130, 0.25);
                      "
                    >
                      <h4
                        style="
                          color: #8b5cf6;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ“– æ•…äº‹èƒŒæ™¯
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "åŠ›é‡å¼€å§‹åè¿‡æ¥å½±å“ä½ çš„å¿ƒæ™ºå’Œè¡Œä¸ºã€‚ä½ è·å¾—äº†æ›´å¼ºå¤§çš„èƒ½åŠ›ï¼Œä½†ä¹Ÿæ„Ÿå—åˆ°äº†å…¶èƒŒåé‚£ä»¤äººæˆ˜æ —çš„ç”œç¾ä¸ç–¯ç‹‚ã€‚"
                      </p>
                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯
                      </h4>

                      <div id="mutation-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æƒæŸ„é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    ğŸ‘‘ æƒæŸ„ (The Authority)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">
                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(139, 0, 0, 0.22), rgba(100, 0, 0, 0.12));
                        border: 2px solid rgba(139, 0, 0, 0.6);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(139, 0, 0, 0.3);
                      "
                    >
                      <h4
                        style="
                          color: #ef4444;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ“– æ•…äº‹èƒŒæ™¯
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "åœ¨ç»å†äº†å†…å¿ƒçš„æŒ£æ‰åï¼Œä½ åšå‡ºäº†é€‰æ‹©ã€‚ä½ ä¸å†è§†å…¶ä¸ºè¯…å’’ï¼Œè€Œæ˜¯å¼€å§‹äº«å—è¿™ä»½åŠ›é‡ï¼Œå¹¶ä¸»åŠ¨å°†å…¶é”»é€ æˆå±äºè‡ªå·±çš„'æƒæŸ„'ã€‚"
                      </p>
                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯
                      </h4>

                      <div id="authority-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ·±æ¸Šé¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    ğŸŒŒ æ·±æ¸Š (The Abyss)
                  </h3>

                  <div style="display: flex; gap: 20px; max-width: 800px; margin: 0 auto">
                    <!-- å·¦ä¾§ï¼šæ•…äº‹æè¿° -->

                    <div
                      style="
                        width: 300px;
                        background: linear-gradient(135deg, rgba(0, 0, 0, 0.25), rgba(20, 20, 20, 0.15));
                        border: 2px solid rgba(0, 0, 0, 0.7);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
                      "
                    >
                      <h4
                        style="
                          color: #6b7280;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ“– æ•…äº‹èƒŒæ™¯
                      </h4>

                      <p
                        style="
                          color: #000000;
                          font-size: 13px;
                          line-height: 1.6;
                          text-align: center;
                          font-style: italic;
                          margin: 0;
                          word-wrap: break-word;
                          overflow-wrap: break-word;
                          font-weight: 600;
                          letter-spacing: 0.3px;
                        "
                      >
                        "ä½ èµ°åˆ°äº†è¿™æ¡è·¯çš„ç»ˆç‚¹ã€‚ä½ ä¸æ‰€é€‰çš„'ä¸å‡¡ä¹‹çˆ±'å½»åº•èä¸ºä¸€ä½“ï¼Œæˆä¸ºäº†ä¸€ä¸ªæ–°çš„'æ¦‚å¿µ'ã€ä¸€ä¸ªæ–°çš„'è§„åˆ™æ€ªè°ˆ'ã€‚"
                      </p>
                    </div>

                    <!-- å³ä¾§ï¼šå¤©èµ‹é€‰æ‹© -->

                    <div
                      style="
                        flex: 1;
                        max-width: 550px;
                        background: rgba(139, 69, 19, 0.08);
                        border: 2px solid rgba(139, 69, 19, 0.25);
                        border-radius: 16px;
                        padding: 20px;
                      "
                    >
                      <h4
                        style="
                          color: #8b4513;
                          font-size: 16px;
                          font-weight: bold;
                          margin-bottom: 12px;
                          text-align: center;
                        "
                      >
                        ğŸ¯ é€‰æ‹©ä½ çš„é“è·¯
                      </h4>

                      <div id="abyss-options" style="max-height: 250px; overflow-y: auto"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- å‡çº§è®°å½•é¡µé¢ -->

              <div class="book-page" style="min-width: 100%; flex-shrink: 0">
                <div
                  style="
                    background: rgba(139, 69, 19, 0.08);
                    border: 2px solid rgba(139, 69, 19, 0.25);
                    border-radius: 12px;
                    padding: 20px;
                    min-height: 400px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                  "
                >
                  <h3
                    style="
                      color: #8b4513;
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 16px;
                      text-align: center;
                      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    "
                  >
                    ğŸ“š å‡çº§è®°å½•
                  </h3>

                  <div id="upgrade-history" style="min-height: 300px">
                    <div style="text-align: center; color: #666666; font-style: italic; padding: 50px">
                      æš‚æ— å‡çº§è®°å½•
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æš´éœ²å…¨å±€å‡½æ•°ä¾›MVUç®¡ç†å™¨ä½¿ç”¨ -->

    <script>
      // æš´éœ²é“å…·ç³»ç»Ÿå‡½æ•°åˆ°å…¨å±€

      window.savePendingActions = savePendingActions;

      window.updateActionIcons = updateActionIcons;

      window.updateInventoryCommandManager = updateInventoryCommandManager;
    </script>

    <!-- æŠ€èƒ½ç³»ç»Ÿè„šæœ¬ -->

    <script>
      // æŠ€èƒ½ç³»ç»Ÿ

      class SkillSystem {
        constructor() {
          this.currentSkill = null;

          // ğŸ”¥ ä»…åœ¨â€œé¦–æ¬¡è§£é”â€æ—¶å¼¹ä¸€æ¬¡æç¤º
          this._skillsUnlocked = false;

          this.skillData = {
            // å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            defense: {
              icon: 'ğŸ›¡ï¸',

              name: 'é˜²å¾¡æŠ€èƒ½',

              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é˜²å¾¡èƒ½åŠ›ï¼Œå¯ä»¥æå‡è‡ªèº«æˆ–ç›®æ ‡çš„é˜²å¾¡åŠ›ã€‚',

              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰',
            },

            rule_enhance: {
              icon: 'ğŸ“œ',

              name: 'è§„åˆ™æ´å¯Ÿ',
              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„è§„åˆ™æ´å¯Ÿèƒ½åŠ›ï¼Œå¯ä»¥çœ‹ç©¿è§„åˆ™æ¼æ´å¹¶åŠ ä»¥åˆ©ç”¨ã€‚',
              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰',
            },
            chain_enhance: {
              icon: 'ğŸ”—',

              name: 'é”é“¾æ§åˆ¶',
              description: 'åŸºäºå¼ºåŒ–ç³»å¤©èµ‹çš„é”é“¾æ§åˆ¶èƒ½åŠ›ï¼Œå¯ä»¥æŸç¼šæˆ–é”å®šç›®æ ‡ã€‚',
              majorTalent: 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰',
            },

            // å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            rule_change: {
              icon: 'ğŸ“',
              name: 'è§„åˆ™ä¿®æ”¹',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„è§„åˆ™ä¿®æ”¹èƒ½åŠ›ï¼Œå¯ä»¥ä¸´æ—¶æ”¹å˜è§„åˆ™å†…å®¹ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰',
            },
            emotion: {
              icon: 'ğŸ’­',
              name: 'æƒ…æ„Ÿæ“æ§',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„æƒ…æ„Ÿæ“æ§èƒ½åŠ›ï¼Œå¯ä»¥å°†è°è¨€å…·è±¡åŒ–ä¸ºæƒ…æ„Ÿæ­¦å™¨ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰',
            },
            shadow: {
              icon: 'ğŸ‘¤',
              name: 'å½±å­æ“æ§',
              description: 'åŸºäºå˜åŒ–ç³»å¤©èµ‹çš„å½±å­æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥åˆ›é€ å’Œæ§åˆ¶è™šå‡å½±å­ã€‚',
              majorTalent: 'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰',
            },

            // æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            emotion_release: {
              icon: 'ğŸ’”',
              name: 'æƒ…ç»ªé‡Šæ”¾',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„æƒ…ç»ªé‡Šæ”¾èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²æƒ…æ„Ÿå½±å“æ•Œäººã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰',
            },
            sacrifice: {
              icon: 'âš°ï¸',
              name: 'ç”Ÿå‘½çŒ®ç¥­',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„çŒ®ç¥­èƒ½åŠ›ï¼Œå¯ä»¥ç‰ºç‰²ç”Ÿå‘½æˆ–è®°å¿†è·å¾—åŠ›é‡ã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰',
            },
            phantom: {
              icon: 'ğŸ‘»',
              name: 'åˆ†èº«å…·ç°',
              description: 'åŸºäºæ”¾å‡ºç³»å¤©èµ‹çš„åˆ†èº«èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å¹»å½±åˆ†èº«ã€‚',
              majorTalent: 'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰',
            },

            // æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            suggestion: {
              icon: 'ğŸ§ ',
              name: 'å¿ƒç†æš—ç¤º',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¿ƒç†æš—ç¤ºèƒ½åŠ›ï¼Œå¯ä»¥æ¤å…¥æ€æƒ³æ§åˆ¶ç›®æ ‡ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰',
            },
            control: {
              icon: 'ğŸ®',
              name: 'ç²¾ç¥æ“æ§',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„ç²¾ç¥æ“æ§èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥æ§åˆ¶æ•Œäººè¡ŒåŠ¨ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰',
            },
            absorption: {
              icon: 'ğŸ’•',
              name: 'çˆ±æ„å¸æ”¶',
              description: 'åŸºäºæ“ä½œç³»å¤©èµ‹çš„å¸æ”¶èƒ½åŠ›ï¼Œå¯ä»¥å¸æ”¶ä»–äººçš„çˆ±æ„è·å¾—åŠ›é‡ã€‚',
              majorTalent: 'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰',
            },

            // å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            armor: {
              icon: 'ğŸ›¡ï¸',
              name: 'ç†æƒ³ç›”ç”²',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„ç›”ç”²èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„é˜²æŠ¤è£…å¤‡ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰',
            },
            ring: {
              icon: 'ğŸ’',
              name: 'æ‰¿è¯ºæˆ’æŒ‡',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„æˆ’æŒ‡èƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–æ‹¥æœ‰å¼ºå¤§åŠ›é‡çš„æˆ’æŒ‡ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰',
            },
            npc: {
              icon: 'ğŸ¤–',
              name: 'å®Œç¾NPC',
              description: 'åŸºäºå…·ç°åŒ–ç³»å¤©èµ‹çš„NPCèƒ½åŠ›ï¼Œå¯ä»¥å…·ç°åŒ–å®Œç¾çš„åŠ©æ‰‹ã€‚',
              majorTalent: 'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰',
            },

            // ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰çš„ä¸‰ä¸ªæŠ€èƒ½æ–¹å‘
            contract: {
              icon: 'ğŸ“‹',
              name: 'æ€ªè°ˆå¥‘çº¦',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å¥‘çº¦èƒ½åŠ›ï¼Œå¯ä»¥ä¸è§„åˆ™æ€ªè°ˆç­¾è®¢å¥‘çº¦ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰',
            },
            resonance: {
              icon: 'ğŸµ',
              name: 'æƒ…ç»ªå…±é¸£',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„å…±é¸£èƒ½åŠ›ï¼Œå¯ä»¥ä¸ç›®æ ‡è¿›è¡Œæƒ…ç»ªå…±é¸£ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰',
            },
            chaos: {
              icon: 'ğŸŒ€',
              name: 'æ··æ²Œæ··åˆ',
              description: 'åŸºäºç‰¹è´¨ç³»å¤©èµ‹çš„æ··åˆèƒ½åŠ›ï¼Œå¯ä»¥æ··åˆä¸åŒçˆ±æ„åˆ›é€ æ–°æŠ€èƒ½ã€‚',
              majorTalent: 'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰',
            },
          };

          this.init();
        }

        init() {
          this.bindEvents();

          this.checkSkillUnlock();
        }

        bindEvents() {
          // æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - åŠ¨æ€ç»‘å®š
          $(document).on('click', '.skill-btn', e => {
            const skillType = $(e.currentTarget).data('skill-type');
            if (skillType) {
              this.showSkillPopup(skillType, e);
            }
          });

          // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æŠ€èƒ½å¼¹çª—

          $(document).on('click', e => {
            if (!$(e.target).closest('.skill-detail-popup').length && !$(e.target).closest('.skill-btn').length) {
              this.hideSkillPopup();
            }
          });
        }

        checkSkillUnlock() {
          // ğŸ”¥ ç§»é™¤è§£é”é™åˆ¶ï¼Œç›´æ¥æ˜¾ç¤ºæŠ€èƒ½
          try {
            // ç›´æ¥æ˜¾ç¤ºæŠ€èƒ½æŒ‰é’®ï¼Œä¸æ£€æŸ¥è§£é”æ¡ä»¶
            $('#skills-section').show();
            this.updateSkillButtons();
            console.log('ğŸ¯ æŠ€èƒ½ç³»ç»Ÿå·²æ˜¾ç¤ºï¼ˆæ— è§£é”é™åˆ¶ï¼‰');
          } catch (error) {
            console.error('æ˜¾ç¤ºæŠ€èƒ½å¤±è´¥:', error);
            $('#skills-section').hide();
          }
        }

        updateSkillButtons() {
          // è·å–å½“å‰å¤§å¤©èµ‹ï¼ˆä¸ä½¿ç”¨[0]ç´¢å¼•ï¼‰
          let majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              console.log('ğŸ” MVUæ•°æ®:', mvuData);

              // ğŸ”¥ ä¸ä½¿ç”¨[0]ç´¢å¼•ï¼Œç›´æ¥è·å–å¤§å¤©èµ‹
              majorTalent = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', { default_value: null });
              console.log('ğŸ” ç¬¬ä¸€æ¬¡è·å–å¤§å¤©èµ‹:', majorTalent, 'ç±»å‹:', typeof majorTalent);

              // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨getAllVariablesä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
                  const allVars = window.teresenDebug.getAllVariables();
                  console.log('ğŸ” æ‰€æœ‰å˜é‡:', allVars);
                  majorTalent = window.teresenDebug.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', null);
                  console.log('ğŸ” å¤‡ç”¨æ–¹æ¡ˆè·å–å¤§å¤©èµ‹:', majorTalent, 'ç±»å‹:', typeof majorTalent);
                }
              }

              // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
              if (!majorTalent || majorTalent === '' || majorTalent === 'æ— ') {
                console.warn('âš ï¸ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                majorTalent = 'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰';
              }

              // ğŸ”¥ æ¸…ç†å¯èƒ½çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
              if (typeof majorTalent === 'string') {
                majorTalent = majorTalent.trim();
              }

              console.log('ğŸ¯ æœ€ç»ˆä½¿ç”¨çš„å¤§å¤©èµ‹:', majorTalent, 'ç±»å‹:', typeof majorTalent);
            }
          } catch (error) {
            console.warn('è·å–å¤§å¤©èµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          // æ ¹æ®å¤§å¤©èµ‹è·å–å¯¹åº”çš„3ä¸ªæŠ€èƒ½
          const skills = this.getSkillsByMajorTalent(majorTalent);
          console.log('ğŸ¯ è·å–åˆ°çš„æŠ€èƒ½:', skills);

          // æ›´æ–°æŠ€èƒ½æŒ‰é’®ï¼ˆåªæ˜¾ç¤ºå¤©èµ‹ä¸“å±æŠ€èƒ½ï¼‰
          const container = $('#skills-section');
          container.empty();

          if (skills.length === 0) {
            // æ²¡æœ‰æŠ€èƒ½æ—¶æ˜¾ç¤ºæç¤º
            container.html('<div class="no-skills-message">æ½œèƒ½æœªè§‰é†’ï¼Œæš‚æ— æŠ€èƒ½</div>');
          } else {
            skills.forEach(skill => {
              const button = $(`
                <button class="skill-btn" data-skill-type="${skill.type}" title="${skill.name}">
                  <span class="skill-icon">${skill.icon}</span>
                </button>
              `);
              container.append(button);
            });
          }
        }

        getSkillsByMajorTalent(majorTalent) {
          // ğŸ”¥ æ¸…ç†è¾“å…¥å€¼ï¼Œç¡®ä¿åŒ¹é…
          if (typeof majorTalent === 'string') {
            majorTalent = majorTalent.trim();
          }

          const skillMapping = {
            'å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰': [
              { type: 'defense', icon: 'ğŸ›¡ï¸', name: 'é˜²å¾¡æŠ€èƒ½' },
              { type: 'rule_enhance', icon: 'ğŸ“œ', name: 'è§„åˆ™æ´å¯Ÿ' },
              { type: 'chain_enhance', icon: 'ğŸ”—', name: 'é”é“¾æ§åˆ¶' },
            ],
            'å˜åŒ–ç³»ï¼ˆè°è¨€ä¹‹çˆ±ï¼‰': [
              { type: 'rule_change', icon: 'ğŸ“', name: 'è§„åˆ™ä¿®æ”¹' },
              { type: 'emotion', icon: 'ğŸ’­', name: 'æƒ…æ„Ÿæ“æ§' },
              { type: 'shadow', icon: 'ğŸ‘¤', name: 'å½±å­æ“æ§' },
            ],
            'æ”¾å‡ºç³»ï¼ˆç‰ºç‰²ä¹‹çˆ±ï¼‰': [
              { type: 'emotion_release', icon: 'ğŸ’”', name: 'æƒ…ç»ªé‡Šæ”¾' },
              { type: 'sacrifice', icon: 'âš°ï¸', name: 'ç”Ÿå‘½çŒ®ç¥­' },
              { type: 'phantom', icon: 'ğŸ‘»', name: 'åˆ†èº«å…·ç°' },
            ],
            'æ“ä½œç³»ï¼ˆæ§åˆ¶ä¹‹çˆ±ï¼‰': [
              { type: 'suggestion', icon: 'ğŸ§ ', name: 'å¿ƒç†æš—ç¤º' },
              { type: 'control', icon: 'ğŸ®', name: 'ç²¾ç¥æ“æ§' },
              { type: 'absorption', icon: 'ğŸ’•', name: 'çˆ±æ„å¸æ”¶' },
            ],
            'å…·ç°åŒ–ç³»ï¼ˆç†æƒ³ä¹‹çˆ±ï¼‰': [
              { type: 'armor', icon: 'ğŸ›¡ï¸', name: 'ç†æƒ³ç›”ç”²' },
              { type: 'ring', icon: 'ğŸ’', name: 'æ‰¿è¯ºæˆ’æŒ‡' },
              { type: 'npc', icon: 'ğŸ¤–', name: 'å®Œç¾NPC' },
            ],
            'ç‰¹è´¨ç³»ï¼ˆæ‰­æ›²ä¹‹çˆ±ï¼‰': [
              { type: 'contract', icon: 'ğŸ“‹', name: 'æ€ªè°ˆå¥‘çº¦' },
              { type: 'resonance', icon: 'ğŸµ', name: 'æƒ…ç»ªå…±é¸£' },
              { type: 'chaos', icon: 'ğŸŒ€', name: 'æ··æ²Œæ··åˆ' },
            ],
          };

          console.log('ğŸ” æŠ€èƒ½æ˜ å°„é”®:', Object.keys(skillMapping));
          console.log('ğŸ” æŸ¥æ‰¾å¤§å¤©èµ‹:', majorTalent);
          console.log('ğŸ” æ˜¯å¦åŒ¹é…:', skillMapping.hasOwnProperty(majorTalent));

          // ğŸ”¥ å¦‚æœç›´æ¥åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
          if (skillMapping[majorTalent]) {
            console.log('âœ… æ‰¾åˆ°åŒ¹é…çš„æŠ€èƒ½:', skillMapping[majorTalent]);
            return skillMapping[majorTalent];
          }

          // ğŸ”¥ å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼‰
          for (const key in skillMapping) {
            if (majorTalent.includes(key) || key.includes(majorTalent)) {
              console.log('âœ… æ¨¡ç³ŠåŒ¹é…æˆåŠŸ:', key, '->', skillMapping[key]);
              return skillMapping[key];
            }
          }

          console.warn('âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„æŠ€èƒ½ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          return skillMapping['å¼ºåŒ–ç³»ï¼ˆå æœ‰ä¹‹çˆ±ï¼‰'];
        }

        showSkillPopup(skillType, event) {
          const skill = this.skillData[skillType];

          if (!skill) return;

          this.currentSkill = skillType;

          // ç§»é™¤ç°æœ‰çš„æŠ€èƒ½å¼¹çª—

          $('.skill-detail-popup').remove();

          // åˆ›å»ºæŠ€èƒ½å¼¹çª—

          const popup = $(`

            <div class="skill-detail-popup">

              <div class="skill-header">
                <span class="skill-icon">${skill.icon}</span>
                <span class="skill-title">${skill.name}</span>
              </div>
              <div class="skill-desc">${skill.description}</div>

              <div>

                <button class="skill-use-btn" data-target="self">ğŸ‘¤ å¯¹è‡ªå·±ä½¿ç”¨</button>

                <button class="skill-use-btn" data-target="uma">ğŸ å¯¹é©¬å¨˜ä½¿ç”¨</button>

              </div>

            </div>

          `);

          // ç»‘å®šæŒ‰é’®äº‹ä»¶

          popup.find('.skill-use-btn').on('click', e => {
            const target = $(e.target).data('target');

            this.useSkill(target);
          });

          // å®šä½å¼¹çª—

          const button = $(event.target).closest('.skill-btn');

          const buttonOffset = button.offset();

          popup.css({
            position: 'absolute',

            top: buttonOffset.top - popup.outerHeight() - 10,

            left: buttonOffset.left,

            zIndex: 10001,
          });

          // ğŸ”¥ æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±çŠ¶æ€ï¼Œå¦‚æœæ˜¯å°±æ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay && overlay.style.display !== 'none') {
            // å…¨å±çŠ¶æ€ä¸‹ï¼Œæ·»åŠ åˆ°è¦†ç›–å±‚
            overlay.appendChild(popup[0]);
            console.log('âœ… æŠ€èƒ½å¼¹çª—å·²æ·»åŠ åˆ°å…¨å±è¦†ç›–å±‚');
          } else {
            // éå…¨å±çŠ¶æ€ä¸‹ï¼Œæ·»åŠ åˆ°body
            $('body').append(popup);
          }

          // æ’­æ”¾éŸ³æ•ˆ

          const skillSound = document.getElementById('item-detail-sound');

          if (skillSound) {
            skillSound.currentTime = 0;

            skillSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }
        }

        hideSkillPopup() {
          $('.skill-detail-popup').remove();

          this.currentSkill = null;
        }

        useSkill(target) {
          if (!this.currentSkill) return;

          const skill = this.skillData[this.currentSkill];

          if (target === 'self') {
            const actionText = `[ä½¿ç”¨æŠ€èƒ½: ${skill.name}]`;

            // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©

            const actionInput = document.getElementById('action-input');
            if (actionInput) {
              actionInput.value = actionText;
              // èšç„¦åˆ°è¾“å…¥æ¡†
              actionInput.focus();
              // æ˜¾ç¤ºæç¤º
              if (typeof showTemporaryMessage === 'function') {
                showTemporaryMessage(`å·²å°† ${actionText} å¡«å…¥è¾“å…¥æ¡†`);
              }
            } else {
              console.warn('âš ï¸ æ‰¾ä¸åˆ°action-inputå…ƒç´ ');
            }

            // å…³é—­å¼¹çª—

            this.hideSkillPopup();
          } else if (target === 'uma') {
            // å…³é—­å¼¹çª—

            this.hideSkillPopup();

            // ğŸ”¥ å¼€å§‹æŠ€èƒ½é€‰æ‹©æ¨¡å¼ï¼ˆä¸èµ é€åŠŸèƒ½ä¸€æ ·ï¼‰

            startSkillSelection(skill.name, this.currentSkill);
          }
        }

        showTemporaryMessage(message) {
          const messageDiv = $('<div class="temporary-message">')
            .text(message)

            .css({
              position: 'fixed',

              top: '50%',

              left: '50%',

              transform: 'translate(-50%, -50%)',

              background: 'rgba(0, 0, 0, 0.8)',

              color: 'white',

              padding: '10px 20px',

              borderRadius: '8px',

              fontSize: '14px',

              zIndex: 1000,

              animation: 'fadeInOut 2s ease-in-out',
            });

          $('body').append(messageDiv);

          setTimeout(() => {
            messageDiv.remove();
          }, 2000);
        }
      }

      // åˆå§‹åŒ–æŠ€èƒ½ç³»ç»Ÿ

      $(document).ready(function () {
        window.skillSystem = new SkillSystem();

        // ç›‘å¬å¤©èµ‹å˜åŒ–ï¼Œæ›´æ–°æŠ€èƒ½æŒ‰é’®
        if (window.teresenDebug && window.teresenDebug.updateInterface) {
          const originalUpdateInterface = window.teresenDebug.updateInterface;
          window.teresenDebug.updateInterface = function () {
            originalUpdateInterface.call(this);
            if (window.skillSystem) {
              window.skillSystem.checkSkillUnlock();
            }
          };
        }

        // ç®€å•ç›´æ¥çš„éŸ³ä¹æ’­æ”¾åŠŸèƒ½
        function setupMusicControls() {
          console.log('ğŸµ åˆå§‹åŒ–éŸ³ä¹æ§åˆ¶');

          // ç›´æ¥ç”¨jQueryç»‘å®šç‚¹å‡»äº‹ä»¶
          $('#music-controller').on('click', function () {
            console.log('ğŸµ éŸ³ä¹æŒ‰é’®è¢«ç‚¹å‡»');

            const audio1 = document.getElementById('bgm-track1');
            const audio2 = document.getElementById('bgm-track2');

            // è®¾ç½®éŸ³é‡
            if (audio1) audio1.volume = 0.3;
            if (audio2) audio2.volume = 0.3;

            // æ£€æŸ¥å½“å‰çŠ¶æ€å¹¶åˆ‡æ¢
            if (audio1 && audio1.paused && audio2 && audio2.paused) {
              // éƒ½æ²¡æ’­æ”¾ï¼Œæ’­æ”¾ç¬¬ä¸€é¦–
              audio1
                .play()
                .then(() => {
                  console.log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³ä¹1');
                  $(this).text('ğŸµ æ’­æ”¾ä¸­1');
                })
                .catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
            } else if (audio1 && !audio1.paused) {
              // ç¬¬ä¸€é¦–åœ¨æ’­æ”¾ï¼Œåˆ‡æ¢åˆ°ç¬¬äºŒé¦–
              audio1.pause();
              audio1.currentTime = 0;
              audio2
                .play()
                .then(() => {
                  console.log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³ä¹2');
                  $(this).text('ğŸµ æ’­æ”¾ä¸­2');
                })
                .catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
            } else if (audio2 && !audio2.paused) {
              // ç¬¬äºŒé¦–åœ¨æ’­æ”¾ï¼Œåœæ­¢æ‰€æœ‰
              audio2.pause();
              audio2.currentTime = 0;
              console.log('ğŸµ åœæ­¢æ’­æ”¾');
              $(this).text('ğŸµ éŸ³ä¹æ§åˆ¶');
            }
          });
        }

        // è°ƒç”¨éŸ³ä¹æ§åˆ¶åˆå§‹åŒ–
        setupMusicControls();
      });

      // å¡”ç½—å åœç³»ç»Ÿ
      class TarotDivinationSystem {
        constructor() {
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿæ„é€ å‡½æ•°å¼€å§‹');
          this.tarotCards = [
            { name: 'æ„šè€…', meaning: 'æ–°çš„å¼€å§‹ï¼Œå†’é™©ç²¾ç¥', reversed: 'é²è½ï¼Œä¸è´Ÿè´£ä»»' },
            { name: 'é­”æœ¯å¸ˆ', meaning: 'åˆ›é€ åŠ›ï¼ŒæŠ€èƒ½æŒæ¡', reversed: 'æŠ€èƒ½ä¸è¶³ï¼Œæœºä¼šæµªè´¹' },
            { name: 'å¥³ç¥­å¸', meaning: 'ç›´è§‰ï¼Œç¥ç§˜çŸ¥è¯†', reversed: 'éšè—çš„çœŸç›¸ï¼Œè¡¨é¢ç°è±¡' },
            { name: 'å¥³çš‡', meaning: 'ä¸°æ”¶ï¼Œæ¯æ€§ï¼Œåˆ›é€ åŠ›', reversed: 'ä¾èµ–ï¼Œè¿‡åº¦ä¿æŠ¤' },
            { name: 'çš‡å¸', meaning: 'æƒå¨ï¼Œé¢†å¯¼åŠ›ï¼Œç¨³å®š', reversed: 'ä¸“åˆ¶ï¼Œç¼ºä¹çµæ´»æ€§' },
            { name: 'æ•™çš‡', meaning: 'ä¼ ç»Ÿï¼Œç²¾ç¥æŒ‡å¯¼', reversed: 'æ•™æ¡ï¼Œé™åˆ¶' },
            { name: 'æ‹äºº', meaning: 'çˆ±æƒ…ï¼Œé€‰æ‹©ï¼Œå’Œè°', reversed: 'ä¸å’Œè°ï¼Œé”™è¯¯é€‰æ‹©' },
            { name: 'æˆ˜è½¦', meaning: 'èƒœåˆ©ï¼Œæ„å¿—åŠ›ï¼Œæ§åˆ¶', reversed: 'å¤±æ§ï¼Œå¤±è´¥' },
            { name: 'åŠ›é‡', meaning: 'å†…åœ¨åŠ›é‡ï¼Œå‹‡æ°”', reversed: 'è½¯å¼±ï¼Œç¼ºä¹ä¿¡å¿ƒ' },
            { name: 'éšè€…', meaning: 'æ™ºæ…§ï¼Œå†…çœï¼ŒæŒ‡å¯¼', reversed: 'å­¤ç‹¬ï¼Œæ‹’ç»å¸®åŠ©' },
            { name: 'å‘½è¿ä¹‹è½®', meaning: 'å˜åŒ–ï¼Œå‘½è¿è½¬æŠ˜', reversed: 'åè¿æ°”ï¼Œåœæ»' },
            { name: 'æ­£ä¹‰', meaning: 'å…¬å¹³ï¼ŒçœŸç†ï¼Œå¹³è¡¡', reversed: 'ä¸å…¬ï¼Œåè§' },
            { name: 'å€’åŠäºº', meaning: 'ç‰ºç‰²ï¼Œæ–°è§†è§’', reversed: 'æ— æ„ä¹‰çš„ç‰ºç‰²' },
            { name: 'æ­»ç¥', meaning: 'ç»“æŸï¼Œè½¬å˜ï¼Œé‡ç”Ÿ', reversed: 'åœæ»ï¼Œæ‹’ç»æ”¹å˜' },
            { name: 'èŠ‚åˆ¶', meaning: 'å¹³è¡¡ï¼Œé€‚åº¦ï¼Œå’Œè°', reversed: 'è¿‡åº¦ï¼Œä¸å¹³è¡¡' },
            { name: 'æ¶é­”', meaning: 'æŸç¼šï¼Œç‰©è´¨æ¬²æœ›', reversed: 'æ‘†è„±æŸç¼šï¼Œè§‰é†’' },
            { name: 'å¡”', meaning: 'çªç„¶å˜åŒ–ï¼Œå¯ç¤º', reversed: 'é¿å…ç¾éš¾ï¼Œé‡å»º' },
            { name: 'æ˜Ÿæ˜Ÿ', meaning: 'å¸Œæœ›ï¼Œçµæ„Ÿï¼Œä¿¡å¿ƒ', reversed: 'å¤±æœ›ï¼Œç¼ºä¹ä¿¡å¿ƒ' },
            { name: 'æœˆäº®', meaning: 'ç›´è§‰ï¼Œå¹»æƒ³ï¼Œææƒ§', reversed: 'é‡Šæ”¾ææƒ§ï¼ŒçœŸç›¸' },
            { name: 'å¤ªé˜³', meaning: 'æˆåŠŸï¼Œå¿«ä¹ï¼Œæ´»åŠ›', reversed: 'æš‚æ—¶çš„å›°éš¾' },
            { name: 'å®¡åˆ¤', meaning: 'é‡ç”Ÿï¼Œå†…åœ¨å¬å”¤', reversed: 'è‡ªæˆ‘æ€€ç–‘ï¼Œæ‹’ç»æ”¹å˜' },
            { name: 'ä¸–ç•Œ', meaning: 'å®Œæˆï¼Œå’Œè°ï¼ŒæˆåŠŸ', reversed: 'æœªå®Œæˆï¼Œå»¶è¿Ÿ' },
          ];

          this.tarotItems = {
            èµ«å°”å¢¨æ–¯ç¾½æ¯›: {
              æè¿°: 'ä¿¡ä½¿ç¥èµ«å°”å¢¨æ–¯ç¿…è†€ä¸Šçš„ä¸€ç‰‡ç¾½æ¯›ï¼Œèƒ½å¸¦æ¥å¥½è¿',
              æ•ˆæœ: 'è¿æ°”+8ï¼Œè§£é”1ä¸ªéšè—å¯¹è¯',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'ä¿¡ä½¿ä¹‹ç¿¼',
            },
            æ™ºæ…§ä¹‹æ³‰: {
              æè¿°: 'æ¥è‡ªåŒ—æ¬§ç¥è¯æ™ºæ…§ä¹‹æ³‰çš„ä¸€æ»´æ°´ç ',
              æ•ˆæœ: 'ç†æ™º+10ï¼Œè·å¾—1ä¸ªç‰¹æ®ŠçŸ¥è¯†',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'æ™ºæ…§å¯è¿ª',
            },
            å‡€åŒ–ä¹‹é•œ: {
              æè¿°: 'èƒ½é©±æ•£è´Ÿé¢èƒ½é‡çš„ç¥ç§˜é•œå­',
              æ•ˆæœ: 'å‡€åŒ–1ä¸ªè´Ÿé¢çŠ¶æ€ï¼Œè¿æ°”+5',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'å‡€åŒ–ä¹‹å…‰',
            },
            å‘½è¿ç¡¬å¸: {
              æè¿°: 'èƒ½æ”¹å˜ä¸€æ¬¡éšæœºäº‹ä»¶ç»“æœçš„ç¥ç§˜ç¡¬å¸',
              æ•ˆæœ: 'ä¸‹æ¬¡éšæœºäº‹ä»¶ç»“æœ+20%',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'å‘½è¿ç¿»è½¬',
            },
            çµé­‚ç¢ç‰‡: {
              æè¿°: 'æ¥è‡ªç¥ç§˜çµé­‚çš„å¾®å°ç¢ç‰‡',
              æ•ˆæœ: 'éšæœºé©¬å¨˜å¥½æ„Ÿåº¦+8ï¼Œç†æ™º+3',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'çµé­‚å…±é¸£',
            },
            æ—¶é—´æ²™ç²’: {
              æè¿°: 'æ¥è‡ªæ—¶é—´é•¿æ²³çš„ä¸€ç²’æ²™',
              æ•ˆæœ: 'åœ¨æ ¡å¤©æ•°+1ï¼Œä½“åŠ›+10',
              ç¨€æœ‰åº¦: 'ç¨€æœ‰',
              ç‰¹æ€§: 'æ—¶é—´æ“æ§',
            },
          };

          this.bindEvents();
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿæ„é€ å‡½æ•°å®Œæˆ');
        }

        bindEvents() {
          console.log('ğŸ´ ç»‘å®šå¡”ç½—å åœäº‹ä»¶');

          // ç»‘å®šå¡”ç½—å åœæŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '#tarot-divination', e => {
            console.log('ğŸ´ å¡”ç½—å åœæŒ‰é’®è¢«ç‚¹å‡»');
            // æ’­æ”¾å¡”ç½—å£°éŸ³
            const sound = document.getElementById('tarot-shuffle');
            if (sound) {
              sound.currentTime = 0;
              sound.play().catch(e => console.log('å¡”ç½—éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
            }
            e.preventDefault();
            e.stopPropagation();
            this.openTarotModal();
          });

          // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
          $(document).on('click', '#close-tarot-btn', e => {
            console.log('ğŸ´ å…³é—­å¡”ç½—å åœæ¨¡æ€æ¡†');
            e.preventDefault();
            e.stopPropagation();
            this.closeTarotModal();
          });

          // ç»‘å®šå åœæŒ‰é’®äº‹ä»¶
          $(document).on('click', '.spread-btn:not(.disabled)', e => {
            console.log('ğŸ´ å åœæŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            const spreadType = $(e.currentTarget).data('spread');
            const cost = $(e.currentTarget).data('cost');
            this.performDivination(spreadType, cost);
          });

          console.log('ğŸ´ å¡”ç½—å åœäº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        openTarotModal() {
          console.log('ğŸ´ æ‰“å¼€å¡”ç½—å åœæ¨¡æ€æ¡†');
          this.updateTarotInfo();
          this.updateSpreadButtons();
          const modal = document.getElementById('tarot-modal');
          if (modal) {
            // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#tarot-modal').show();
          console.log('ğŸ´ å¡”ç½—å åœæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        }

        closeTarotModal() {
          $('#tarot-modal').hide();
          $('#tarot-result').hide();
        }

        updateTarotInfo() {
          console.log('ğŸ´ æ›´æ–°å¡”ç½—å åœä¿¡æ¯');

          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          let sanity = 100;
          let gameDay = 1;
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              sanity = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º', { default_value: 100 });
              gameDay = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', { default_value: 1 });
              console.log('ğŸ´ MVUç†æ™ºå€¼è·å–æˆåŠŸ:', sanity);
              console.log('ğŸ´ æ¸¸æˆå¤©æ•°è·å–æˆåŠŸ:', gameDay);
            }
          } catch (error) {
            console.warn('ğŸ´ è·å–ç†æ™ºå€¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          const remaining = this.getDailyRemaining();
          console.log('ğŸ´ ç†æ™º:', sanity, 'æ¸¸æˆå¤©æ•°:', gameDay, 'å‰©ä½™æ¬¡æ•°:', remaining);

          // æ˜¾ç¤ºç†æ™ºå€¼
          $('#tarot-sanity').text(sanity);

          // æ˜¾ç¤ºæ¸¸æˆå¤©æ•°å’Œå‰©ä½™æ¬¡æ•°
          const remainingText = `æ¸¸æˆç¬¬${gameDay}å¤© - å‰©ä½™æ¬¡æ•°: ${remaining}`;
          $('#tarot-remaining').text(remainingText);

          // å¦‚æœæ¬¡æ•°ç”¨å®Œï¼Œæ·»åŠ æç¤º
          if (remaining === 0) {
            $('#tarot-remaining').append(
              '<br><small style="color: #ef4444; font-size: 0.8rem;">éœ€è¦ç­‰åˆ°æ¸¸æˆå†…ä¸‹ä¸€å¤©æ‰èƒ½ç»§ç»­ä½¿ç”¨</small>',
            );
          }
        }

        updateSpreadButtons() {
          console.log('ğŸ´ æ›´æ–°å åœæŒ‰é’®çŠ¶æ€');

          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          // ä½¿ç”¨å’Œä¸ªäººæ¡£æ¡ˆç›¸åŒçš„å˜é‡è·å–æ–¹å¼
          let sanity = 100;
          let schoolDays = 0;
          try {
            const allVars = this.getAllVariables();
            sanity = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º', 100);
            schoolDays = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', 1);
            console.log('ğŸ´ ä½¿ç”¨getAllVariablesè·å–å˜é‡æˆåŠŸ:', { sanity, schoolDays });
          } catch (error) {
            console.warn('ğŸ´ è·å–å˜é‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
          }

          console.log('ğŸ´ ç†æ™º:', sanity, 'åœ¨æ ¡å¤©æ•°:', schoolDays);
          console.log('ğŸ´ getGameDay()è¿”å›:', this.getGameDay());

          $('.spread-btn').each((index, button) => {
            const $btn = $(button);
            const cost = $btn.data('cost');
            const requirement = $btn.data('requirement');

            let disabled = false;
            let reason = '';

            if (sanity < cost) {
              disabled = true;
              reason = 'ç†æ™ºä¸è¶³';
            } else if (requirement && schoolDays < requirement) {
              disabled = true;
              reason = 'åœ¨æ ¡å¤©æ•°ä¸è¶³';
            }

            if (disabled) {
              $btn.addClass('disabled');
              $btn.attr('title', reason);
            } else {
              $btn.removeClass('disabled');
              $btn.attr('title', '');
            }
          });
          console.log('ğŸ´ å åœæŒ‰é’®çŠ¶æ€æ›´æ–°å®Œæˆ');
        }

        async performDivination(spreadType, cost) {
          console.log('ğŸ´ å¼€å§‹å åœ:', spreadType, 'æ¶ˆè€—:', cost);

          // æ£€æŸ¥æ¯æ—¥å‰©ä½™æ¬¡æ•°ï¼ˆåŸºäºæ¸¸æˆå¤©æ•°ï¼‰- æš‚æ—¶ä¸é™åˆ¶
          // const dailyRemaining = this.getDailyRemaining();
          // if (dailyRemaining <= 0) {
          //   const gameDay = this.getGameDay();
          //   if (typeof showTemporaryMessage === 'function') {
          //     showTemporaryMessage(`æ¸¸æˆç¬¬${gameDay}å¤©çš„å åœæ¬¡æ•°å·²ç”¨å®Œï¼Œéœ€è¦ç­‰åˆ°æ¸¸æˆå†…ä¸‹ä¸€å¤©æ‰èƒ½ç»§ç»­ä½¿ç”¨ï¼`);
          //   } else {
          //     alert(`æ¸¸æˆç¬¬${gameDay}å¤©çš„å åœæ¬¡æ•°å·²ç”¨å®Œï¼Œéœ€è¦ç­‰åˆ°æ¸¸æˆå†…ä¸‹ä¸€å¤©æ‰èƒ½ç»§ç»­ä½¿ç”¨ï¼`);
          //   }
          //   return;
          // }
          console.log('ğŸ´ å åœå¤©æ•°é™åˆ¶å·²ç¦ç”¨');

          // ä½¿ç”¨ä¸updateSpreadButtonsç›¸åŒçš„æ–¹æ³•è·å–ç†æ™ºå€¼ï¼Œç¡®ä¿ä¸€è‡´æ€§
          let currentSanity = 100;
          try {
            // ä¼˜å…ˆä½¿ç”¨teresenDebugçš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨MVU
            if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
              const allVars = window.teresenDebug.getAllVariables();
              currentSanity = window.teresenDebug.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º', 100);
              console.log('ğŸ´ ä½¿ç”¨teresenDebugè·å–ç†æ™ºå€¼:', currentSanity);
            } else if (typeof this.getAllVariables === 'function') {
              const allVars = this.getAllVariables();
              currentSanity = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.ç†æ™º', 100);
              console.log('ğŸ´ ä½¿ç”¨this.getAllVariablesè·å–ç†æ™ºå€¼:', currentSanity);
            } else if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              currentSanity = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º', { default_value: 100 });
              console.log('ğŸ´ ä½¿ç”¨MVUè·å–ç†æ™ºå€¼:', currentSanity);
            }
          } catch (error) {
            console.warn('ğŸ´ è·å–ç†æ™ºå€¼å¤±è´¥:', error);
          }

          // æ£€æŸ¥ç†æ™ºæ˜¯å¦è¶³å¤Ÿï¼ˆæš‚æ—¶ä¸æ£€æŸ¥ï¼Œå…è®¸å åœï¼‰
          // if (currentSanity < cost) {
          //   if (typeof showTemporaryMessage === 'function') {
          //     showTemporaryMessage('ç†æ™ºä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå åœï¼');
          //   } else {
          //     alert('ç†æ™ºä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå åœï¼');
          //   }
          //   return;
          // }

          // æ¶ˆè€—ç†æ™º - æš‚æ—¶ä¸æ‰£é™¤ç†æ™º
          // const newSanity = currentSanity - cost;
          // try {
          //   if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
          //     const mvuData = Mvu.getMvuData({ type: 'chat' });
          //     await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º', newSanity, {
          //       reason: 'å¡”ç½—å åœæ¶ˆè€—',
          //       is_recursive: true,
          //     });
          //     await Mvu.replaceMvuData(mvuData, { type: 'chat' });
          //     console.log('ğŸ´ ç†æ™ºå€¼æ‰£é™¤æˆåŠŸ:', currentSanity, '->', newSanity);
          //   }
          // } catch (error) {
          //   console.error('ğŸ´ æ‰£é™¤ç†æ™ºå€¼å¤±è´¥:', error);
          //   if (typeof showTemporaryMessage === 'function') {
          //     showTemporaryMessage('æ‰£é™¤ç†æ™ºå€¼å¤±è´¥ï¼');
          //   } else {
          //     alert('æ‰£é™¤ç†æ™ºå€¼å¤±è´¥ï¼');
          //   }
          //   return;
          // }
          console.log('ğŸ´ å åœä¸æ‰£é™¤ç†æ™ºï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰');

          // æ˜¾ç¤ºå åœå¼€å§‹åŠ¨ç”»
          this.showDivinationStartAnimation(spreadType);

          // å»¶è¿Ÿç”Ÿæˆç»“æœï¼Œå¢åŠ ç¥ç§˜æ„Ÿ
          setTimeout(async () => {
            // ç”Ÿæˆå åœç»“æœ
            const result = await this.generateDivinationResult(spreadType);

            // éšè—å¼€å§‹åŠ¨ç”»
            $('.tarot-start-animation').fadeOut(500, () => {
              $('.tarot-start-animation').remove();
            });

            // æ˜¾ç¤ºç»“æœ
            this.showTarotResultPopup(result);
          }, 2000);

          // æ›´æ–°ç•Œé¢
          this.updateTarotInfo();
          this.updateSpreadButtons();

          // è®°å½•ä½¿ç”¨æ¬¡æ•°
          this.recordDailyUsage();
        }

        async generateDivinationResult(spreadType) {
          const cards = [];
          const cardCount = this.getCardCount(spreadType);

          for (let i = 0; i < cardCount; i++) {
            const card = this.getRandomCard();
            cards.push(card);
          }

          const result = await this.interpretCards(cards, spreadType);
          return { cards, result };
        }

        getCardCount(spreadType) {
          const counts = {
            single: 1,
            timeline: 3,
            choice: 2,
            hexagram: 6,
            celtic: 10,
            zodiac: 12,
          };
          return counts[spreadType] || 1;
        }

        getRandomCard() {
          const card = this.tarotCards[Math.floor(Math.random() * this.tarotCards.length)];
          const isReversed = Math.random() < 0.3; // 30%æ¦‚ç‡é€†ä½
          return {
            ...card,
            reversed: isReversed,
            meaning: isReversed ? card.reversed : card.meaning,
          };
        }

        async interpretCards(cards, spreadType) {
          const result = {
            type: this.determineResultType(cards),
            luckChange: 0,
            reasonChange: 0,
            canGetItem: false,
            affectionChange: 0,
            interpretation: '',
            effects: [],
          };

          // æ ¹æ®å¡ç‰Œå’Œç‰Œé˜µç±»å‹ç”Ÿæˆç»“æœ
          switch (spreadType) {
            case 'single':
              result.luckChange = this.calculateLuckChange(cards);
              result.reasonChange = this.calculateReasonChange(cards);
              result.canGetItem = Math.random() < 0.15;
              result.affectionChange = this.calculateAffectionChange(cards);
              break;
            case 'timeline':
              result.luckChange = this.calculateLuckChange(cards) * 1.5;
              result.reasonChange = this.calculateReasonChange(cards) * 1.5;
              result.canGetItem = Math.random() < 0.2;
              result.affectionChange = this.calculateAffectionChange(cards) * 1.5;
              break;
            case 'choice':
              result.luckChange = this.calculateLuckChange(cards) * 0.8;
              result.reasonChange = this.calculateReasonChange(cards) * 0.8;
              result.canGetItem = Math.random() < 0.12;
              result.affectionChange = this.calculateAffectionChange(cards) * 0.8;
              break;
            default:
              result.luckChange = this.calculateLuckChange(cards) * 2;
              result.reasonChange = this.calculateReasonChange(cards) * 2;
              result.canGetItem = Math.random() < 0.25;
              result.affectionChange = this.calculateAffectionChange(cards) * 2;
          }

          // ç”Ÿæˆè§£é‡Šæ–‡æœ¬
          result.interpretation = this.generateInterpretation(cards, spreadType);

          // åº”ç”¨æ•ˆæœ - æš‚æ—¶ä¸åº”ç”¨ï¼Œåªç”Ÿæˆç»“æœ
          // await this.applyDivinationEffects(result);
          console.log('ğŸ´ å åœæ•ˆæœæš‚æ—¶ä¸åº”ç”¨ï¼ˆå·²ç¦ç”¨ï¼‰');

          return result;
        }

        determineResultType(cards) {
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) return 'ç¥è¿¹æ˜¾ç°';
          if (positiveRatio >= 0.6) return 'æ™ºæ…§å¯è¿ª';
          if (positiveRatio >= 0.4) return 'å‘½è¿æ³¢åŠ¨';
          if (positiveRatio >= 0.2) return 'è¿·é›¾ç¬¼ç½©';
          if (positiveRatio >= 0.1) return 'æ··æ²Œå›å“';
          return 'æ·±æ¸Šä½è¯­';
        }

        calculateLuckChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 3 + Math.random() * 5;
            } else {
              change += 3 + Math.random() * 5;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateReasonChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        calculateAffectionChange(cards) {
          let change = 0;
          cards.forEach(card => {
            if (card.reversed) {
              change -= 2 + Math.random() * 3;
            } else {
              change += 2 + Math.random() * 3;
            }
          });
          return Math.round(change / cards.length);
        }

        generateInterpretation(cards, spreadType) {
          const spreadNames = {
            single: 'å•å¼ ç‰Œå åœ',
            timeline: 'æ—¶é—´ä¹‹æµå åœ',
            choice: 'äºŒé€‰ä¸€å åœ',
            hexagram: 'å…­èŠ’æ˜Ÿå åœ',
            celtic: 'å‡¯å°”ç‰¹åå­—å åœ',
            zodiac: 'é»„é“åäºŒå®«å åœ',
          };

          const spreadDescriptions = {
            single: 'åœ¨ç¥ç§˜çš„æœˆå…‰ä¸‹ï¼Œä½ æŠ½å‡ºäº†å‘½è¿ä¹‹ç‰Œã€‚è¿™å¼ ç‰Œå¦‚åŒå¤œç©ºä¸­çš„åŒ—ææ˜Ÿï¼Œä¸ºä½ æŒ‡æ˜å‰è¿›çš„æ–¹å‘...',
            timeline: 'æ—¶é—´çš„é•¿æ²³åœ¨ä½ é¢å‰å±•å¼€ï¼Œè¿‡å»ã€ç°åœ¨ä¸æœªæ¥äº¤ç»‡æˆå‘½è¿çš„ç»‡é”¦ã€‚æ¯ä¸€å¼ ç‰Œéƒ½æ‰¿è½½ç€æ—¶å…‰çš„é‡é‡...',
            choice: 'å‘½è¿åœ¨ä½ é¢å‰æ‘†å‡ºäº†ä¸¤æ¡é“è·¯ï¼Œå¦‚åŒåå­—è·¯å£çš„é€‰æ‹©ã€‚æ¯ä¸€æ¡è·¯éƒ½é€šå‘ä¸åŒçš„æœªæ¥...',
            hexagram: 'å…­èŠ’æ˜Ÿçš„å¤è€ç¬¦å·åœ¨è™šç©ºä¸­é—ªçƒï¼Œå…­å¼ ç‰Œå¦‚åŒæ˜Ÿè¾°èˆ¬æ’åˆ—ï¼Œæ­ç¤ºç€æ·±å±‚çš„å‘½è¿å¯†ç ...',
            celtic: 'å‡¯å°”ç‰¹åå­—çš„å¤è€æ™ºæ…§åœ¨ä½ é¢å‰å±•å¼€ï¼Œåå¼ ç‰Œå¦‚åŒç”Ÿå‘½ä¹‹æ ‘çš„æå¶ï¼Œå±•ç°ç€å†…å¿ƒçš„æ·±å±‚ç»“æ„...',
            zodiac: 'é»„é“åäºŒå®«çš„æ˜Ÿè±¡åœ¨ä½ å‘¨å›´æ—‹è½¬ï¼ŒåäºŒå¼ ç‰Œå¦‚åŒå®‡å®™çš„å’Œè°ä¹ç« ï¼Œæ˜ å°„ç€å¤©åœ°çš„å¹³è¡¡...',
          };

          let interpretation = spreadDescriptions[spreadType] || 'åœ¨ç¥ç§˜çš„å åœä»ªå¼ä¸­ï¼Œå‘½è¿çš„å¥¥ç§˜åœ¨ä½ é¢å‰ç¼“ç¼“å±•å¼€...';

          interpretation += '\n\n';

          cards.forEach((card, index) => {
            const cardNumber = index + 1;
            const positionText = card.reversed ? 'é€†ä½' : 'æ­£ä½';
            const positionDesc = card.reversed
              ? 'è¿™å¼ ç‰Œä»¥é€†ä½å‡ºç°ï¼Œæš—ç¤ºç€æŒ‘æˆ˜ä¸è­¦ç¤º'
              : 'è¿™å¼ ç‰Œä»¥æ­£ä½å‡ºç°ï¼Œå¸¦æ¥ç¥ç¦ä¸æŒ‡å¼•';

            interpretation += `ç¬¬${cardNumber}å¼ ç‰Œï¼š${card.name}ï¼ˆ${positionText}ï¼‰\n`;
            interpretation += `${positionDesc}ã€‚${card.meaning}\n\n`;
          });

          // æ·»åŠ æ€»ç»“æ€§çš„è¯è¯­
          const positiveCards = cards.filter(card => !card.reversed).length;
          const totalCards = cards.length;
          const positiveRatio = positiveCards / totalCards;

          if (positiveRatio >= 0.8) {
            interpretation += 'ğŸŒŸ å‘½è¿ä¹‹é•œæ˜¾ç¤ºï¼Œä½ çš„æœªæ¥å……æ»¡å…‰æ˜ä¸å¸Œæœ›ã€‚å‹‡æ•¢åœ°å‘å‰è¿ˆè¿›å§ï¼';
          } else if (positiveRatio >= 0.6) {
            interpretation += 'âœ¨ è™½ç„¶å‰è·¯æœ‰äº›æ³¢æŠ˜ï¼Œä½†æ™ºæ…§ä¸å‹‡æ°”å°†æŒ‡å¼•ä½ èµ°å‘æˆåŠŸã€‚';
          } else if (positiveRatio >= 0.4) {
            interpretation += 'ğŸŒ™ å‘½è¿ä¹‹è½®æ­£åœ¨è½¬åŠ¨ï¼Œä¿æŒè€å¿ƒä¸åšæŒï¼Œè½¬æœºå³å°†åˆ°æ¥ã€‚';
          } else if (positiveRatio >= 0.2) {
            interpretation += 'âš¡ æŒ‘æˆ˜ä¸æœºé‡å¹¶å­˜ï¼Œè°¨æ…è¡Œäº‹ï¼Œæ™ºæ…§å°†åŠ©ä½ åº¦è¿‡éš¾å…³ã€‚';
          } else {
            interpretation += 'ğŸ”® é»‘æš—ä¸­çš„æ˜Ÿå…‰æœ€ä¸ºçè´µï¼Œä¿æŒå¸Œæœ›ï¼Œå‘½è¿ç»ˆå°†çœ·é¡¾å‹‡æ•¢è€…ã€‚';
          }

          return interpretation;
        }

        async applyDivinationEffects(result) {
          console.log('ğŸ´ åº”ç”¨å åœæ•ˆæœ');

          // å‚è€ƒå¤©èµ‹ç³»ç»Ÿçš„å®ç°æ–¹å¼
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ç¡®ä¿stat_dataæœ‰$internalå±æ€§ï¼ˆMVU betaéœ€è¦ï¼‰
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°ç¡®ä¿$internalæ­£ç¡®åˆå§‹åŒ–
              if (!mvuData || !mvuData.stat_data) {
                console.error('âŒ MVUæ•°æ®æ— æ•ˆ');
                return;
              }

              // ç¡®ä¿display_dataå’Œdelta_dataå­˜åœ¨
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }

              // åˆ›å»º$internalï¼ŒæŒ‡å‘display_dataå’Œdelta_data
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('âœ… å·²åˆå§‹åŒ–$internalå±æ€§');
              } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              // åº”ç”¨è¿æ°”å˜åŒ–
              const currentLuck = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.è¿æ°”', { default_value: 50 });
              const newLuck = Math.max(0, Math.min(100, currentLuck + result.luckChange));
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.è¿æ°”', newLuck, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              result.effects.push(`è¿æ°”${result.luckChange > 0 ? '+' : ''}${result.luckChange}`);

              // åº”ç”¨ç†æ™ºå˜åŒ–
              const currentReason = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º', { default_value: 100 });
              const newReason = Math.max(0, Math.min(100, currentReason + result.reasonChange));
              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç†æ™º', newReason, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              result.effects.push(`ç†æ™º${result.reasonChange > 0 ? '+' : ''}${result.reasonChange}`);

              // ä¿å­˜æ›´æ–°åçš„æ•°æ®
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('ğŸ´ å åœæ•ˆæœåº”ç”¨æˆåŠŸ');
            }
          } catch (error) {
            console.error('ğŸ´ åº”ç”¨å åœæ•ˆæœå¤±è´¥:', error);
          }

          // å¤„ç†ç‰©å“è·å–
          if (result.canGetItem) {
            const itemCheck = this.canGetTarotItem();
            if (itemCheck.canGet) {
              const item = this.getRandomTarotItem();
              if (item) {
                await this.addTarotItem(item, this.tarotItems[item]);
                result.effects.push(`è·å¾—ç¥ç§˜ç‰©å“ï¼š${item}`);
                this.recordItemAcquisition();
              }
            }
          }

          // å¤„ç†é©¬å¨˜å¥½æ„Ÿåº¦
          if (result.affectionChange !== 0) {
            const affectionResult = await this.affectRandomHorseGirlAffection(result.affectionChange);
            if (affectionResult) {
              result.effects.push(
                `${affectionResult.name}å¥½æ„Ÿåº¦${result.affectionChange > 0 ? '+' : ''}${result.affectionChange}`,
              );
            }
          }
        }

        showTarotResultPopup(result) {
          console.log('ğŸ´ æ˜¾ç¤ºå åœç»“æœ:', result);

          // è°ƒè¯•ï¼šæ£€æŸ¥resultç»“æ„
          if (!result || !result.cards || !result.result) {
            console.error('ğŸ´ resultæ•°æ®ç»“æ„é”™è¯¯:', result);
            alert('å åœæ•°æ®ç”Ÿæˆå¤±è´¥ï¼result=' + JSON.stringify(result));
            return;
          }

          // ç§»é™¤ç°æœ‰çš„ç»“æœå¼¹çª—
          $('.tarot-result-modal').remove();

          // åˆ›å»ºç¥ç§˜ä¼˜ç¾çš„å åœç»“æœå¼¹çª—
          const resultModal = $(`
            <div class="tarot-result-modal" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.8);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 10000;
              backdrop-filter: blur(5px);
            ">
              <div class="tarot-result-content" style="
                background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
                border: 2px solid #a855f7;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
                animation: tarotResultFadeIn 0.8s ease-out;
              ">
                <!-- å…³é—­æŒ‰é’® -->
                <button class="tarot-result-close" style="
                  position: absolute;
                  top: 15px;
                  right: 20px;
                  background: none;
                  border: none;
                  color: #a855f7;
                  font-size: 24px;
                  cursor: pointer;
                  z-index: 10001;
                ">Ã—</button>
                
                <!-- ç¥ç§˜æ ‡é¢˜ -->
                <div class="tarot-result-header" style="
                  text-align: center;
                  margin-bottom: 25px;
                  padding-bottom: 20px;
                  border-bottom: 2px solid rgba(168, 85, 247, 0.3);
                ">
                  <h2 style="
                    color: #a855f7;
                    font-size: 28px;
                    margin: 0;
                    text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
                    font-family: 'Times New Roman', serif;
                  ">ğŸ”® å‘½è¿ä¹‹é•œ ğŸ”®</h2>
                  <p style="
                    color: #cbd5e1;
                    font-size: 16px;
                    margin: 10px 0 0 0;
                    font-style: italic;
                  ">${result.result.type}</p>
                </div>
                
                <!-- å¡ç‰Œå±•ç¤ºåŒºåŸŸ -->
                <div class="tarot-cards-display" style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                  gap: 15px;
                  margin-bottom: 25px;
                ">
                  ${result.cards
                    .map(
                      (card, index) => `
                    <div class="tarot-result-card ${card.reversed ? 'reversed' : ''}" style="
                      background: linear-gradient(135deg, #2d1b69, #4c1d95);
                      border: 2px solid ${card.reversed ? '#ef4444' : '#a855f7'};
                      border-radius: 12px;
                      padding: 15px;
                      text-align: center;
                      position: relative;
                      transform: ${card.reversed ? 'rotate(180deg)' : 'none'};
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
                    ">
                      <div class="card-number" style="
                        position: absolute;
                        top: 5px;
                        left: 10px;
                        color: #a855f7;
                        font-size: 12px;
                        font-weight: bold;
                      ">${index + 1}</div>
                      <div class="card-name" style="
                        color: #f3f4f6;
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 8px;
                        text-shadow: 0 0 5px rgba(168, 85, 247, 0.5);
                      ">${card.name}</div>
                      <div class="card-meaning" style="
                        color: #cbd5e1;
                        font-size: 12px;
                        line-height: 1.4;
                        font-style: italic;
                      ">${card.meaning}</div>
                      ${card.reversed ? '<div style="position: absolute; top: 5px; right: 10px; color: #ef4444; font-size: 12px;">é€†ä½</div>' : ''}
                    </div>
                  `,
                    )
                    .join('')}
                </div>
                
                <!-- ç¥ç§˜è§£è¯» -->
                <div class="tarot-interpretation-section" style="
                  background: rgba(168, 85, 247, 0.1);
                  border: 1px solid rgba(168, 85, 247, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                  margin-bottom: 25px;
                ">
                  <h3 style="
                    color: #a855f7;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">ğŸŒŸ ç¥ç§˜è§£è¯» ğŸŒŸ</h3>
                  <div class="interpretation-text" style="
                    color: #e2e8f0;
                    font-size: 14px;
                    line-height: 1.6;
                    text-align: justify;
                    font-family: 'Georgia', serif;
                  ">${result.result.interpretation}</div>
                </div>
                
                <!-- å‘½è¿å½±å“ -->
                <div class="tarot-effects-section" style="
                  background: rgba(34, 197, 94, 0.1);
                  border: 1px solid rgba(34, 197, 94, 0.3);
                  border-radius: 12px;
                  padding: 20px;
                ">
                  <h3 style="
                    color: #22c55e;
                    font-size: 20px;
                    margin: 0 0 15px 0;
                    text-align: center;
                    font-family: 'Times New Roman', serif;
                  ">âœ¨ å‘½è¿å½±å“ âœ¨</h3>
                  <div class="effects-list" style="
                    display: grid;
                    gap: 8px;
                  ">
                    ${result.result.effects
                      .map(
                        effect => `
                      <div class="effect-item" style="
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.2);
                        border-radius: 8px;
                        padding: 10px;
                        color: #22c55e;
                        font-size: 14px;
                        text-align: center;
                        font-weight: 500;
                      ">${effect}</div>
                    `,
                      )
                      .join('')}
                  </div>
                </div>
                
                <!-- ç¥ç§˜è£…é¥° -->
                <div style="
                  position: absolute;
                  top: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">ğŸŒ™</div>
                <div style="
                  position: absolute;
                  top: 10px;
                  right: 50px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">â­</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  left: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">ğŸ”®</div>
                <div style="
                  position: absolute;
                  bottom: 10px;
                  right: 10px;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                ">âœ¨</div>
              </div>
            </div>
          `);

          // ç»‘å®šå…³é—­äº‹ä»¶
          resultModal.find('.tarot-result-close').on('click', () => {
            resultModal.fadeOut(300, () => resultModal.remove());
          });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          resultModal.on('click', e => {
            if (e.target === resultModal[0]) {
              resultModal.fadeOut(300, () => resultModal.remove());
            }
          });

          // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
          $('body').append(resultModal);

          // æ’­æ”¾ç¥ç§˜éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          const tarotSound = document.getElementById('tarot-result-sound');
          if (tarotSound) {
            tarotSound.currentTime = 0;
            tarotSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          console.log('ğŸ´ å åœç»“æœå¼¹çª—å·²æ˜¾ç¤º');
        }

        showDivinationStartAnimation(spreadType) {
          console.log('ğŸ´ æ˜¾ç¤ºå åœå¼€å§‹åŠ¨ç”»');

          // ç§»é™¤ç°æœ‰çš„å¼€å§‹åŠ¨ç”»
          $('.tarot-start-animation').remove();

          const spreadNames = {
            single: 'å•å¼ ç‰Œå åœ',
            timeline: 'æ—¶é—´ä¹‹æµå åœ',
            choice: 'äºŒé€‰ä¸€å åœ',
            hexagram: 'å…­èŠ’æ˜Ÿå åœ',
            celtic: 'å‡¯å°”ç‰¹åå­—å åœ',
            zodiac: 'é»„é“åäºŒå®«å åœ',
          };

          const spreadIcons = {
            single: 'ğŸ”®',
            timeline: 'â°',
            choice: 'âš–ï¸',
            hexagram: 'â­',
            celtic: 'ğŸ•¯ï¸',
            zodiac: 'ğŸŒŸ',
          };

          // åˆ›å»ºç¥ç§˜çš„å¼€å¯åŠ¨ç”»
          const startAnimation = $(`
            <div class="tarot-start-animation" style="
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(26,26,46,0.95) 100%);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 9999;
              backdrop-filter: blur(10px);
            ">
              <div class="animation-content" style="
                text-align: center;
                color: #a855f7;
                animation: tarotStartPulse 2s ease-in-out infinite;
              ">
                <div class="mystical-icon" style="
                  font-size: 80px;
                  margin-bottom: 20px;
                  text-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
                  animation: tarotIconFloat 3s ease-in-out infinite;
                ">${spreadIcons[spreadType] || 'ğŸ”®'}</div>
                
                <h2 style="
                  font-size: 32px;
                  margin: 0 0 15px 0;
                  text-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
                  font-family: 'Times New Roman', serif;
                ">${spreadNames[spreadType] || 'ç¥ç§˜å åœ'}</h2>
                
                <p style="
                  font-size: 18px;
                  margin: 0 0 30px 0;
                  color: #cbd5e1;
                  font-style: italic;
                ">å‘½è¿ä¹‹é•œæ­£åœ¨æ­ç¤ºä½ çš„æœªæ¥...</p>
                
                <div class="loading-dots" style="
                  display: flex;
                  justify-content: center;
                  gap: 8px;
                ">
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.2s;
                  "></div>
                  <div class="dot" style="
                    width: 12px;
                    height: 12px;
                    background: #a855f7;
                    border-radius: 50%;
                    animation: tarotDotPulse 1.5s ease-in-out infinite 0.4s;
                  "></div>
                </div>
                
                <!-- ç¥ç§˜è£…é¥°å…ƒç´  -->
                <div style="
                  position: absolute;
                  top: 20%;
                  left: 10%;
                  font-size: 24px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite;
                ">ğŸŒ™</div>
                <div style="
                  position: absolute;
                  top: 30%;
                  right: 15%;
                  font-size: 20px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 1s;
                ">â­</div>
                <div style="
                  position: absolute;
                  bottom: 25%;
                  left: 15%;
                  font-size: 22px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 2s;
                ">âœ¨</div>
                <div style="
                  position: absolute;
                  bottom: 35%;
                  right: 10%;
                  font-size: 26px;
                  color: rgba(168, 85, 247, 0.3);
                  animation: tarotFloat 4s ease-in-out infinite 3s;
                ">ğŸ”®</div>
              </div>
            </div>
          `);

          // æ·»åŠ åˆ°é¡µé¢
          $('body').append(startAnimation);

          // æ’­æ”¾ç¥ç§˜éŸ³æ•ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          const tarotStartSound = document.getElementById('tarot-start-sound');
          if (tarotStartSound) {
            tarotStartSound.currentTime = 0;
            tarotStartSound.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
          }

          console.log('ğŸ´ å åœå¼€å§‹åŠ¨ç”»å·²æ˜¾ç¤º');
        }

        // ç‰©å“ç›¸å…³æ–¹æ³•
        canGetTarotItem() {
          const lastItemTime = localStorage.getItem('tarot_last_item_time');
          const itemCount = parseInt(localStorage.getItem('tarot_item_count') || '0');

          if (itemCount >= 3) {
            return { canGet: false, reason: 'å·²è¾¾åˆ°æœ€å¤§ç‰©å“æ•°é‡é™åˆ¶' };
          }

          if (lastItemTime) {
            const hoursSinceLastItem = (Date.now() - parseInt(lastItemTime)) / (1000 * 60 * 60);
            if (hoursSinceLastItem < 24) {
              return { canGet: false, reason: 'ç‰©å“è·å–å†·å´ä¸­' };
            }
          }

          return { canGet: true };
        }

        getRandomTarotItem() {
          const items = Object.keys(this.tarotItems);
          const rand = Math.random();
          if (rand < 0.15) {
            // 15%æ¦‚ç‡è·å¾—ç‰©å“
            return items[Math.floor(Math.random() * items.length)];
          }
          return null;
        }

        async addTarotItem(itemName, itemData) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ç¡®ä¿stat_dataæœ‰$internalå±æ€§ï¼ˆMVU betaéœ€è¦ï¼‰
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°ç¡®ä¿$internalæ­£ç¡®åˆå§‹åŒ–
              if (!mvuData || !mvuData.stat_data) {
                console.error('âŒ MVUæ•°æ®æ— æ•ˆ');
                return;
              }

              // ç¡®ä¿display_dataå’Œdelta_dataå­˜åœ¨
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }

              // åˆ›å»º$internalï¼ŒæŒ‡å‘display_dataå’Œdelta_data
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('âœ… å·²åˆå§‹åŒ–$internalå±æ€§');
              } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              const currentItems = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç‰©å“æ ', { default_value: {} });
              currentItems[itemName] = itemData;

              await Mvu.setMvuVariable(mvuData, 'è®­ç»ƒå‘˜.ç‰©å“æ ', currentItems, {
                reason: 'å¡”ç½—å åœè·å¾—ç‰©å“',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });
              console.log('ğŸ´ ç‰©å“æ·»åŠ æˆåŠŸ:', itemName);
            }
          } catch (error) {
            console.error('ğŸ´ æ·»åŠ ç‰©å“å¤±è´¥:', error);
          }
        }

        recordItemAcquisition() {
          localStorage.setItem('tarot_last_item_time', Date.now().toString());
          localStorage.setItem(
            'tarot_item_count',
            (parseInt(localStorage.getItem('tarot_item_count') || '0') + 1).toString(),
          );
        }

        // é©¬å¨˜ç›¸å…³æ–¹æ³•
        getExistingHorseGirls() {
          const horseGirls = this.getVariable('é©¬å¨˜', {});
          return Object.keys(horseGirls).filter(name => name !== '$meta');
        }

        getRandomExistingHorseGirl() {
          const existingGirls = this.getExistingHorseGirls();
          if (existingGirls.length === 0) return null;
          return existingGirls[Math.floor(Math.random() * existingGirls.length)];
        }

        async affectRandomHorseGirlAffection(affectionChange) {
          const horseGirlName = this.getRandomExistingHorseGirl();
          if (!horseGirlName) return null;

          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });

              // ç¡®ä¿stat_dataæœ‰$internalå±æ€§ï¼ˆMVU betaéœ€è¦ï¼‰
              // ä½¿ç”¨è¾…åŠ©å‡½æ•°ç¡®ä¿$internalæ­£ç¡®åˆå§‹åŒ–
              if (!mvuData || !mvuData.stat_data) {
                console.error('âŒ MVUæ•°æ®æ— æ•ˆ');
                return;
              }

              // ç¡®ä¿display_dataå’Œdelta_dataå­˜åœ¨
              if (!mvuData.display_data) {
                mvuData.display_data = {};
              }
              if (!mvuData.delta_data) {
                mvuData.delta_data = {};
              }

              // åˆ›å»º$internalï¼ŒæŒ‡å‘display_dataå’Œdelta_data
              if (!mvuData.stat_data.$internal) {
                mvuData.stat_data.$internal = {
                  display_data: mvuData.display_data,
                  delta_data: mvuData.delta_data,
                };
                console.log('âœ… å·²åˆå§‹åŒ–$internalå±æ€§');
              } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç¡®ä¿æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡
                mvuData.stat_data.$internal.display_data = mvuData.display_data;
                mvuData.stat_data.$internal.delta_data = mvuData.delta_data;
              }

              const currentHorseGirls = Mvu.getMvuVariable(mvuData, 'é©¬å¨˜', { default_value: {} });
              const currentAffection = currentHorseGirls[horseGirlName]?.å¥½æ„Ÿåº¦ || 0;
              const newAffection = Math.max(0, Math.min(100, currentAffection + affectionChange));

              // æ›´æ–°é©¬å¨˜å¥½æ„Ÿåº¦
              if (!currentHorseGirls[horseGirlName]) {
                currentHorseGirls[horseGirlName] = { å¥½æ„Ÿåº¦: 0 };
              }
              currentHorseGirls[horseGirlName].å¥½æ„Ÿåº¦ = newAffection;

              await Mvu.setMvuVariable(mvuData, 'é©¬å¨˜', currentHorseGirls, {
                reason: 'å¡”ç½—å åœé©¬å¨˜å¥½æ„Ÿåº¦å˜åŒ–',
                is_recursive: true,
              });
              await Mvu.replaceMvuData(mvuData, { type: 'chat' });

              return {
                name: horseGirlName,
                oldAffection: currentAffection,
                newAffection: newAffection,
                change: affectionChange,
              };
            }
          } catch (error) {
            console.error('ğŸ´ æ›´æ–°é©¬å¨˜å¥½æ„Ÿåº¦å¤±è´¥:', error);
          }
          return null;
        }

        // æ¯æ—¥é™åˆ¶ç›¸å…³æ–¹æ³•
        getDailyRemaining() {
          try {
            // ä½¿ç”¨æ¸¸æˆå†…å¤©æ•°è€Œä¸æ˜¯ç°å®å¤©æ•°
            const gameDay = this.getGameDay();
            const lastUsedDay = localStorage.getItem('tarot_last_used_day');
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const usageCount = parseInt(localStorage.getItem(gameDayKey) || '0');

            // æ£€æµ‹æ–°å¼€å±€æˆ–æ–°çš„æ¸¸æˆå¤©æ•°
            const lastUsedDayNum = parseInt(lastUsedDay) || -1;

            // å¦‚æœå½“å‰å¤©æ•°å°äºä¸Šæ¬¡è®°å½•çš„å¤©æ•°ï¼Œè¯´æ˜æ˜¯æ–°å¼€å±€
            if (gameDay < lastUsedDayNum) {
              console.log(`ğŸ´ æ£€æµ‹åˆ°æ–°å¼€å±€: å½“å‰å¤©æ•°=${gameDay}, ä¸Šæ¬¡å¤©æ•°=${lastUsedDayNum}`);
              this.resetTarotData();
              return 3;
            }

            // å¦‚æœæ˜¯æ–°çš„æ¸¸æˆå¤©æ•°ï¼Œé‡ç½®ä½¿ç”¨æ¬¡æ•°
            if (lastUsedDay !== gameDay.toString()) {
              console.log(`ğŸ´ æ–°çš„æ¸¸æˆå¤©æ•°: ä»ç¬¬${lastUsedDay}å¤©åˆ°ç¬¬${gameDay}å¤©`);
              localStorage.setItem('tarot_last_used_day', gameDay.toString());
              // æ¸…ç†æ—§å¤©æ•°çš„æ•°æ®
              this.cleanupOldUsageData();
              return 3;
            }

            return Math.max(0, 3 - usageCount);
          } catch (error) {
            console.warn('ğŸ´ è·å–æ¯æ—¥å‰©ä½™æ¬¡æ•°å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç°å®å¤©æ•°
            const today = new Date().toDateString();
            const lastUsage = localStorage.getItem('tarot_last_usage');
            const usageCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');

            if (lastUsage !== today) {
              localStorage.setItem('tarot_last_usage', today);
              localStorage.setItem('tarot_usage_count', '0');
              return 3;
            }

            return Math.max(0, 3 - usageCount);
          }
        }

        // æ¸…ç†æ—§å¤©æ•°çš„ä½¿ç”¨æ•°æ®
        cleanupOldUsageData() {
          try {
            const currentGameDay = this.getGameDay();
            // æ¸…ç†30å¤©å‰çš„æ•°æ®
            for (let i = 1; i <= 30; i++) {
              const oldDay = currentGameDay - i;
              if (oldDay > 0) {
                localStorage.removeItem(`tarot_usage_day_${oldDay}`);
              }
            }
            console.log('ğŸ´ å·²æ¸…ç†æ—§å¤©æ•°çš„å¡”ç½—å åœä½¿ç”¨æ•°æ®');
          } catch (error) {
            console.warn('ğŸ´ æ¸…ç†æ—§æ•°æ®å¤±è´¥:', error);
          }
        }

        // é‡ç½®æ‰€æœ‰å¡”ç½—ç‰Œæ•°æ®ï¼ˆæ–°å¼€å±€æ—¶ä½¿ç”¨ï¼‰
        resetTarotData() {
          try {
            // æ¸…é™¤æ‰€æœ‰å¡”ç½—ç‰Œç›¸å…³çš„localStorageæ•°æ®
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('tarot_')) {
                keysToRemove.push(key);
              }
            }

            keysToRemove.forEach(key => {
              localStorage.removeItem(key);
              console.log(`ğŸ´ æ¸…é™¤å¡”ç½—ç‰Œæ•°æ®: ${key}`);
            });

            console.log('ğŸ´ å·²é‡ç½®æ‰€æœ‰å¡”ç½—ç‰Œæ•°æ®ï¼ˆæ–°å¼€å±€ï¼‰');
          } catch (error) {
            console.warn('ğŸ´ é‡ç½®å¡”ç½—ç‰Œæ•°æ®å¤±è´¥:', error);
          }
        }

        recordDailyUsage() {
          // ä½¿ç”¨æ¸¸æˆå†…å¤©æ•°è€Œä¸æ˜¯ç°å®å¤©æ•°
          try {
            // è·å–æ¸¸æˆå†…å½“å‰å¤©æ•°
            const gameDay = this.getGameDay();
            const gameDayKey = `tarot_usage_day_${gameDay}`;
            const currentCount = parseInt(localStorage.getItem(gameDayKey) || '0');
            localStorage.setItem(gameDayKey, (currentCount + 1).toString());

            // è®°å½•æœ€åä¸€æ¬¡ä½¿ç”¨çš„æ¸¸æˆå¤©æ•°
            localStorage.setItem('tarot_last_used_day', gameDay.toString());

            console.log(`ğŸ´ å¡”ç½—å åœä½¿ç”¨è®°å½•ï¼šæ¸¸æˆç¬¬${gameDay}å¤©ï¼Œä½¿ç”¨${currentCount + 1}æ¬¡`);
          } catch (error) {
            console.warn('ğŸ´ è®°å½•å¡”ç½—å åœä½¿ç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç°å®å¤©æ•°
            const today = new Date().toDateString();
            const currentCount = parseInt(localStorage.getItem('tarot_usage_count') || '0');
            localStorage.setItem('tarot_usage_count', (currentCount + 1).toString());
          }
        }

        // è·å–æ¸¸æˆå†…å¤©æ•° - ä½¿ç”¨å’ŒrenderUIç›¸åŒçš„æ–¹æ³•
        getGameDay() {
          try {
            // ä½¿ç”¨å’ŒupdateTarotInfoç›¸åŒçš„å˜é‡è·å–æ–¹å¼
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              const gameDay = Mvu.getMvuVariable(mvuData, 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', { default_value: 1 });
              const day = parseInt(gameDay) || 1;
              console.log(`ğŸ´ ä½¿ç”¨MVUè·å–åœ¨æ ¡å¤©æ•°: ${gameDay} -> ${day}`);
              return day;
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨getAllVariables
            const allVars = this.getAllVariables();
            const schoolDays = this.getVariable(allVars, 'stat_data.è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', 1);
            const day = parseInt(schoolDays) || 1;
            console.log(`ğŸ´ ä½¿ç”¨getAllVariablesè·å–åœ¨æ ¡å¤©æ•°: ${schoolDays} -> ${day}`);
            return day;

            // å¤‡ç”¨æ–¹æ¡ˆï¼šä»localStorageè·å–
            const savedDay = localStorage.getItem('game_current_day');
            if (savedDay) {
              return parseInt(savedDay) || 1;
            }

            // é»˜è®¤è¿”å›ç¬¬1å¤©
            return 1;
          } catch (error) {
            console.warn('ğŸ´ è·å–æ¸¸æˆå¤©æ•°å¤±è´¥:', error);
            return 1;
          }
        }

        // å·¥å…·æ–¹æ³•
        getAllVariables() {
          // ä¼˜å…ˆä½¿ç”¨teresenDebugçš„æ–¹æ³•
          if (window.teresenDebug && typeof window.teresenDebug.getAllVariables === 'function') {
            return window.teresenDebug.getAllVariables();
          }
          // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å…¨å±€getAllVariableså‡½æ•°
          if (typeof getAllVariables === 'function') {
            return getAllVariables();
          }
          // æœ€åå¤‡ç”¨æ–¹æ¡ˆï¼šè¿”å›ç©ºå¯¹è±¡
          console.warn('ğŸ´ getAllVariablesæ–¹æ³•ä¸å¯ç”¨');
          return {};
        }

        getVariable(dataObj, path, defaultValue = null) {
          // ä¼˜å…ˆä½¿ç”¨teresenDebugçš„æ–¹æ³•
          if (window.teresenDebug && typeof window.teresenDebug.getVariable === 'function') {
            return window.teresenDebug.getVariable(dataObj, path, defaultValue);
          }
          // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨è§£æè·¯å¾„
          try {
            const keys = path.split(/\.|\[|\]/).filter(k => k !== '');
            let value = dataObj;
            for (const key of keys) {
              if (value == null || typeof value !== 'object') {
                return defaultValue;
              }
              value = value[key];
            }
            return value != null ? value : defaultValue;
          } catch (e) {
            console.warn('è·å–å˜é‡å¤±è´¥:', path, e);
            return defaultValue;
          }
        }

        setVariable(path, value) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.setMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              Mvu.setMvuVariable(mvuData, path, value, {
                reason: 'å¡”ç½—å åœæ•ˆæœ',
                is_recursive: true,
              });
              Mvu.replaceMvuData(mvuData, { type: 'chat' });
            }
          } catch (e) {
            console.error('è®¾ç½®å˜é‡å¤±è´¥:', path, e);
          }
        }
      }

      // é©¬å¨˜è®°åå†Œç³»ç»Ÿ
      class UmaRosterSystem {
        constructor() {
          this.rosterKey = 'uma_roster';
          this.init();
        }

        init() {
          // åˆå§‹åŒ–è®°åå†Œæ•°æ®
          if (!localStorage.getItem(this.rosterKey)) {
            localStorage.setItem(this.rosterKey, JSON.stringify({}));
          }
        }

        // è·å–è®°åå†Œæ•°æ®
        getUmaRoster() {
          try {
            const rosterData = localStorage.getItem(this.rosterKey);
            return rosterData ? JSON.parse(rosterData) : {};
          } catch (error) {
            console.error('è·å–é©¬å¨˜è®°åå†Œå¤±è´¥:', error);
            return {};
          }
        }

        // æ·»åŠ é©¬å¨˜åˆ°è®°åå†Œ
        addUmaToRoster(umaName, details = {}) {
          try {
            const roster = this.getUmaRoster();
            const now = new Date().toISOString();

            if (!roster[umaName]) {
              roster[umaName] = {
                name: umaName,
                encounter_count: 1,
                first_met: now,
                last_met: now,
                notes: details.notes || '',
                personality: details.personality || '',
                abilities: details.abilities || '',
              };
            } else {
              roster[umaName].encounter_count += 1;
              roster[umaName].last_met = now;
              if (details.notes) roster[umaName].notes = details.notes;
              if (details.personality) roster[umaName].personality = details.personality;
              if (details.abilities) roster[umaName].abilities = details.abilities;
            }

            localStorage.setItem(this.rosterKey, JSON.stringify(roster));
            console.log(`ğŸ“– å·²æ·»åŠ  ${umaName} åˆ°é©¬å¨˜è®°åå†Œ`);
            return true;
          } catch (error) {
            console.error('æ·»åŠ é©¬å¨˜åˆ°è®°åå†Œå¤±è´¥:', error);
            return false;
          }
        }

        // æ‰“å¼€è®°åå†Œç•Œé¢
        openUmaRoster() {
          // æ’­æ”¾é©¬å¨˜è®°åå†ŒéŸ³æ•ˆ
          const sound = document.getElementById('uma-roster-sound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(e => console.log('æ’­æ”¾é©¬å¨˜è®°åå†ŒéŸ³æ•ˆå¤±è´¥:', e));
          }

          const roster = this.getUmaRoster();
          const umaList = Object.values(roster);

          let rosterHtml = `
            <div class="roster-modal" id="roster-modal">
              <div class="roster-content">
                <div class="roster-header">
                  <h2>ğŸ“– é©¬å¨˜è®°åå†Œ</h2>
                  <button class="roster-close-btn" onclick="this.closest('.roster-modal').remove()">Ã—</button>
                </div>
                <div class="roster-body">
          `;

          if (umaList.length === 0) {
            rosterHtml += '<div class="empty-roster">è¿˜æ²¡æœ‰é‡åˆ°ä»»ä½•é©¬å¨˜...</div>';
          } else {
            rosterHtml += '<div class="roster-list">';
            umaList.forEach(uma => {
              const firstMet = new Date(uma.first_met).toLocaleDateString('zh-CN');
              const lastMet = new Date(uma.last_met).toLocaleDateString('zh-CN');

              rosterHtml += `
                <div class="roster-item">
                  <div class="roster-item-header">
                    <h3>${uma.name}</h3>
                    <span class="encounter-count">é‡åˆ° ${uma.encounter_count} æ¬¡</span>
                  </div>
                  <div class="roster-item-details">
                    <div class="roster-detail">
                      <strong>é¦–æ¬¡é‡åˆ°:</strong> ${firstMet}
                    </div>
                    <div class="roster-detail">
                      <strong>æœ€åé‡åˆ°:</strong> ${lastMet}
                    </div>
                    ${uma.personality ? `<div class="roster-detail"><strong>æ€§æ ¼:</strong> ${uma.personality}</div>` : ''}
                    ${uma.abilities ? `<div class="roster-detail"><strong>èƒ½åŠ›:</strong> ${uma.abilities}</div>` : ''}
                    ${uma.notes ? `<div class="roster-detail"><strong>å¤‡æ³¨:</strong> ${uma.notes}</div>` : ''}
                  </div>
                </div>
              `;
            });
            rosterHtml += '</div>';
          }

          rosterHtml += `
                </div>
              </div>
            </div>
          `;

          // ç§»é™¤ç°æœ‰çš„è®°åå†Œå¼¹çª—
          $('.roster-modal').remove();

          // ğŸ”¥ æ·»åŠ æ–°çš„è®°åå†Œå¼¹çª—ï¼ˆå…¨å±æ—¶æ·»åŠ åˆ°è¦†ç›–å±‚å†…éƒ¨ï¼‰
          const overlay = document.getElementById('teresen-fullscreen-overlay');
          if (overlay) {
            overlay.insertAdjacentHTML('beforeend', rosterHtml);
          } else {
            $('body').append(rosterHtml);
          }
        }

        // æ–°å¢ï¼šçŠ¶æ€è§¦å‘ç³»ç»Ÿ
        checkStatusTriggers() {
          try {
            // é˜²æ­¢é‡å¤è§¦å‘
            if (this.statusAnimationActive) {
              console.log('ğŸ­ çŠ¶æ€åŠ¨ç”»å·²æ¿€æ´»ï¼Œè·³è¿‡æ£€æŸ¥');
              return;
            }

            const variables = this.getAllVariables();
            const trainer = variables?.stat_data?.è®­ç»ƒå‘˜;

            if (!trainer) return;

            const stamina = trainer.ä½“åŠ› || 0;
            const sanity = trainer.ç†æ™º || 0;

            console.log('ğŸ­ æ£€æŸ¥çŠ¶æ€è§¦å‘ - ä½“åŠ›:', stamina, 'ç†æ™º:', sanity);

            // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘çŠ¶æ€åˆ¤å®š
            if (stamina <= 0 || sanity <= 0) {
              console.log('ğŸ­ è§¦å‘çŠ¶æ€åŠ¨ç”» - ä½“åŠ›:', stamina, 'ç†æ™º:', sanity);
              this.triggerStatusAnimation(stamina, sanity);
            }
          } catch (error) {
            console.warn('çŠ¶æ€è§¦å‘æ£€æŸ¥å¤±è´¥:', error);
          }
        }

        // æ–°å¢ï¼šçŠ¶æ€åŠ¨ç”»æ¼”å‡º
        triggerStatusAnimation(stamina, sanity) {
          console.log('ğŸ­ è§¦å‘çŠ¶æ€åŠ¨ç”»æ¼”å‡º');

          // è®¾ç½®çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          this.statusAnimationActive = true;

          // åˆ¤æ–­çŠ¶æ€ç±»å‹
          let statusType = 'normal';
          let statusTitle = 'çŠ¶æ€å˜åŒ–';
          let statusMessage = 'AIå°†ä¸ºä½ åˆ¤å®šæ–°çš„çŠ¶æ€...';

          if (stamina <= 0 && sanity <= 0) {
            statusType = 'critical';
            statusTitle = 'âš ï¸ åŒé‡å´©æºƒ';
            statusMessage = 'ä½“åŠ›ä¸ç†æ™ºåŒæ—¶å´©æºƒï¼AIå°†åˆ¤å®šä½ çš„å‘½è¿...';
          } else if (stamina <= 0) {
            statusType = 'stamina';
            statusTitle = 'ğŸ’ª ä½“åŠ›å´©æºƒ';
            statusMessage = 'ä½“åŠ›è€—å°½ï¼è¿™æ˜¯è€ƒéªŒæ„å¿—çš„æ—¶åˆ»...';
          } else if (sanity <= 0) {
            statusType = 'sanity';
            statusTitle = 'ğŸ§  ç†æ™ºå´©æºƒ';
            statusMessage = 'ç†æ™ºå´©æºƒï¼ç–¯ç‹‚ä¸­è•´å«ç€åŠ›é‡...';
          }

          // åˆ›å»ºçŠ¶æ€åŠ¨ç”»å®¹å™¨
          const animationContainer = document.createElement('div');
          animationContainer.className = `status-animation-container ${statusType}`;
          animationContainer.innerHTML = `
            <div class="status-animation">
              <div class="status-title">${statusTitle}</div>
              <div class="status-content">
                ${stamina <= 0 ? `<div class="status-item stamina">ä½“åŠ›: ${stamina}</div>` : ''}
                ${sanity <= 0 ? `<div class="status-item sanity">ç†æ™º: ${sanity}</div>` : ''}
              </div>
              <div class="status-message">${statusMessage}</div>
              <div class="status-hint">ç­‰å¾…AIçš„åˆ¤å®š...</div>
            </div>
          `;

          // æ·»åŠ åˆ°é¡µé¢
          document.body.appendChild(animationContainer);

          // æ’­æ”¾åŠ¨ç”»
          setTimeout(() => {
            animationContainer.classList.add('show');
          }, 100);

          // 5ç§’åè‡ªåŠ¨ç§»é™¤
          setTimeout(() => {
            animationContainer.classList.remove('show');
            setTimeout(() => {
              if (animationContainer.parentNode) {
                animationContainer.parentNode.removeChild(animationContainer);
              }
              // é‡ç½®çŠ¶æ€æ ‡å¿—
              this.statusAnimationActive = false;
            }, 500);
          }, 5000);
        }

        // å·²åˆ é™¤é‡å¤çš„å¡”ç½—å åœç³»ç»Ÿ
      }

      // åˆå§‹åŒ–é©¬å¨˜è®°åå†Œç³»ç»Ÿ
      $(document).ready(function () {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
          window.umaRosterSystem = new UmaRosterSystem();
          console.log('ğŸ“– é©¬å¨˜è®°åå†Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });

      // åˆå§‹åŒ–å¡”ç½—å åœç³»ç»Ÿ
      $(document).ready(function () {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
          window.tarotSystem = new TarotDivinationSystem();
          console.log('ğŸ´ å¡”ç½—å åœç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });

      // ç¥ç¤¾ç¥ˆç¦ç³»ç»Ÿ
      class ShrineSystem {
        constructor() {
          console.log('â›©ï¸ ç¥ç¤¾ç¥ˆç¦ç³»ç»Ÿæ„é€ å‡½æ•°å¼€å§‹');
          this.fortunes = [
            { name: 'å¤§å‰', rank: 1, desc: 'æœ€å¥½çš„è¿åŠ¿ã€‚ä½†è¦æ³¨æ„åŠªåŠ›ç»´æŒç°çŠ¶å“¦ã€‚' },
            { name: 'å‰', rank: 2, desc: 'ä»…æ¬¡äºå¤§å‰çš„å¥½è¿ï¼Œå¯ä»¥æ”¾å¿ƒä¸€æ®µæ—¶é—´ã€‚' },
            { name: 'ä¸­å‰', rank: 3, desc: 'è¿æ°”æ˜¯"å‰"çš„ä¸€åŠï¼Œæ ¹æ®åŠªåŠ›å¯ä»¥æå‡ã€‚' },
            { name: 'å°å‰', rank: 4, desc: 'ä¸å¥½ä¸åï¼Œä¼šæœ‰å°å°çš„å¹¸ç¦ï¼Œä¸å®œå¼ºæ±‚ã€‚' },
            { name: 'æœ«å‰', rank: 5, desc: '"å‰"ä¸­ä¹‹æœ«ï¼Œä½†æœ‰è®¸å¤šä¸Šå‡ç©ºé—´ã€‚' },
            { name: 'å‡¶', rank: 6, desc: 'è¿åŠ¿ä¸å¥½ï¼Œéœ€è¦å°å¿ƒè°¨æ…ï¼Œé‡æ–°å®¡è§†è‡ªèº«ã€‚' },
            { name: 'å¤§å‡¶', rank: 7, desc: 'æœ€å·®çš„è¿åŠ¿ï¼Œä½†å·²æ— å¤„å¯é™ï¼Œè€å¿ƒç­‰å¾…ç¿»èº«æœºä¼šå§ã€‚' },
          ];
          this.omikujiItems = ['æ„¿æœ›', 'æ‹çˆ±', 'å¾…äºº', 'å©šäº‹', 'ç”Ÿæ„', 'å¤±ç‰©', 'æˆ¿å±‹', 'å‡ºè¡Œ', 'å¥åº·', 'å­¦é—®', 'çº·äº‰'];
          this.itemResults = {
            good: [
              'ä¼šå®ç°',
              'ä¼šä¸€å¸†é£é¡º',
              'ä¼šå‡ºç°',
              'æœ‰è‰¯ç¼˜',
              'ä¼šå¾ˆé¡ºåˆ©',
              'èƒ½æ‰¾åˆ°',
              'æœ‰å¥½è¿æ°”',
              'ä¼šå¾ˆé¡ºåˆ©',
              'ä¼šå¾ˆå¥åº·',
              'èƒ½æˆåŠŸ',
              'ä¼šèƒœåˆ©',
            ],
            bad: [
              'éš¾ä»¥å®ç°',
              'ä¼šæœ‰æ³¢æŠ˜',
              'ä¸ä¼šå‡ºç°',
              'ç¼˜åˆ†æœªåˆ°',
              'ä¼šæœ‰å›°éš¾',
              'æ‰¾ä¸åˆ°äº†',
              'è¿åŠ¿ä¸ä½³',
              'æœ€å¥½æ¨è¿Ÿ',
              'éœ€è¦æ³¨æ„',
              'éœ€è¦åŠªåŠ›',
              'ä¼šå¤±è´¥',
            ],
          };
          this.bindEvents();
          console.log('â›©ï¸ ç¥ç¤¾ç¥ˆç¦ç³»ç»Ÿæ„é€ å‡½æ•°å®Œæˆ');
        }

        bindEvents() {
          console.log('â›©ï¸ ç»‘å®šç¥ç¤¾ç¥ˆç¦äº‹ä»¶');

          // ç»‘å®šç¥ç¤¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          $(document).on('click', '#shrine-btn', e => {
            console.log('â›©ï¸ ç¥ç¤¾æŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            this.openShrineModal();
          });

          // ç»‘å®šæ¨¡æ€æ¡†å…³é—­äº‹ä»¶
          $(document).on('click', '#close-shrine-btn', e => {
            console.log('â›©ï¸ å…³é—­ç¥ç¤¾æ¨¡æ€æ¡†');
            e.preventDefault();
            e.stopPropagation();
            this.closeShrineModal();
          });

          // ç»‘å®šå‚æ‹œæŒ‰é’®äº‹ä»¶
          $(document).on('click', '#shrine-pray-btn', e => {
            console.log('â›©ï¸ å‚æ‹œæŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            this.pray();
          });

          // ç»‘å®šæŠ½ç­¾æŒ‰é’®äº‹ä»¶
          $(document).on('click', '#shrine-draw-btn', e => {
            console.log('â›©ï¸ æŠ½ç­¾æŒ‰é’®è¢«ç‚¹å‡»');
            e.preventDefault();
            e.stopPropagation();
            this.drawOmikuji();
          });

          // ç»‘å®šæ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
          $(document).on('click', '#shrine-modal', e => {
            if (e.target.id === 'shrine-modal') {
              this.closeShrineModal();
            }
          });

          console.log('â›©ï¸ ç¥ç¤¾ç¥ˆç¦äº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        openShrineModal() {
          console.log('â›©ï¸ æ‰“å¼€ç¥ç¤¾æ¨¡æ€æ¡†');
          // é‡ç½®çŠ¶æ€
          $('#omikuji-result-display').hide();
          $('#shrine-prompt').show().text('è¯·å…ˆä¸æ­æ¡£ä¸€åŒå‚æ‹œã€‚');
          $('#shrine-draw-btn').prop('disabled', true);
          $('#shrine-modal').show();
          // ç¡®ä¿åœ¨å…¨å±æ—¶ç§»åŠ¨åˆ°è¦†ç›–å±‚
          if (window.teresenDebug && window.teresenDebug.ensureModalInOverlay) {
            const modal = document.getElementById('shrine-modal');
            if (modal) {
              window.teresenDebug.ensureModalInOverlay(modal);
            }
          }
          console.log('â›©ï¸ ç¥ç¤¾æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        }

        closeShrineModal() {
          $('#shrine-modal').hide();
        }

        pray() {
          console.log('â›©ï¸ å¼€å§‹å‚æ‹œ');
          $('#shrine-prompt').text('æ€€ç€æ•¬æ„ï¼Œä¸æ­æ¡£ä¸€åŒå‘ç¥æ˜ä¼ è¾¾äº†å¿ƒæ„...');
          $('#omikuji-result-display').hide();
          $('#shrine-prompt').show();
          $('#shrine-draw-btn').prop('disabled', false);
        }

        drawOmikuji() {
          console.log('â›©ï¸ å¼€å§‹æŠ½ç­¾');
          const fortune = this.fortunes[Math.floor(Math.random() * this.fortunes.length)];

          // æ˜¾ç¤ºå¾¡ç¥ç­¾ï¼Œéšè—æç¤ºè¯­
          $('#shrine-prompt').hide();
          const $display = $('#omikuji-result-display').show();

          // å¡«å……å†…å®¹
          $display.find('.omikuji-fortune').text(`ã€${fortune.name}ã€‘`);
          $display.find('.omikuji-desc').text(fortune.desc);
          const $itemsList = $display.find('.omikuji-items').empty();

          this.omikujiItems.forEach(item => {
            const isGood = Math.random() > (fortune.rank - 1) / (this.fortunes.length - 1) - 0.1;
            const itemResult = isGood
              ? this.itemResults.good[Math.floor(Math.random() * this.itemResults.good.length)]
              : this.itemResults.bad[Math.floor(Math.random() * this.itemResults.bad.length)];
            $itemsList.append(`<li><strong>ã€${item}ã€‘</strong> ${itemResult}</li>`);
          });

          // ç¦ç”¨æŒ‰é’®
          $('#shrine-draw-btn').prop('disabled', true);

          console.log('â›©ï¸ æŠ½ç­¾å®Œæˆ:', fortune.name);
        }
      }

      // åˆå§‹åŒ–ç¥ç¤¾ç¥ˆç¦ç³»ç»Ÿ
      $(document).ready(function () {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
          window.shrineSystem = new ShrineSystem();
          console.log('â›©ï¸ ç¥ç¤¾ç¥ˆç¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });
    </script>

    <!-- ä¸–ç•Œåœ°å›¾åŠŸèƒ½è„šæœ¬ -->
    <script>
      class WorldMapSystem {
        constructor() {
          this.mapData = {
            mapInfo: {
              id: 'treisen_world_map',
              name: 'ç‰¹é›·æ£®ä¸–ç•Œåœ°å›¾',
              imageUrl: 'https://files.catbox.moe/l35lb5.png',
              originalWidth: 710,
              originalHeight: 480,
            },
            locations: [
              {
                id: 'location_1757318274166',
                name: 'ç‰¹é›·æ£®å­¦é™¢',
                description: 'ç‰¹é›·æ£®å­¦é™¢æ‰€åœ¨åœ°',
                type: 'racetrack',
                coordinates: { x: 0.7746, y: 0.4104 },
              },
              {
                id: 'location_1757318283780',
                name: 'å¯Œå£«å±±',
                description: '',
                type: 'scenic',
                coordinates: { x: 0.6423, y: 0.5208 },
              },
              {
                id: 'location_1757318295113',
                name: 'ä¸œäº¬',
                description: '',
                type: 'city',
                coordinates: { x: 0.8254, y: 0.4354 },
              },
              {
                id: 'location_1757318321436',
                name: 'å¤æ—¥é›†è®­å¤„',
                description: '',
                type: 'facility',
                coordinates: { x: 0.7887, y: 0.5479 },
              },
              {
                id: 'location_1757318364205',
                name: 'ä¸­äº¬ç«é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.3366, y: 0.6021 },
              },
              {
                id: 'location_1757318450243',
                name: 'äº¬éƒ½ç«é©¬åœº',
                description: 'å¤©çš‡èµæ¯”èµ›çš„åœ°æ–¹',
                type: 'racetrack',
                coordinates: { x: 0.1141, y: 0.65 },
              },
              {
                id: 'location_1757318469917',
                name: 'é˜ªç¥ç«é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.0493, y: 0.6979 },
              },
              {
                id: 'location_1757318506058',
                name: 'ç¬ æ¾å­¦é™¢',
                description: 'å°æ —å¸½åŸæ¥å¾…çš„å­¦é™¢åœ°æ–¹',
                type: 'racetrack',
                coordinates: { x: 0.2986, y: 0.5042 },
              },
              {
                id: 'location_1757319664664',
                name: 'ä¸­å±±ç«é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.8915, y: 0.5667 },
              },
              {
                id: 'location_1757319874524',
                name: 'æ–°æ½Ÿèµ›é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.6845, y: 0.1187 },
              },
              {
                id: 'location_1757319889843',
                name: 'å‡½é¦†ç«é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.8507, y: 0.1521 },
              },
              {
                id: 'location_1757319956272',
                name: 'å°ä»“ç«é©¬åœº',
                description: '',
                type: 'racetrack',
                coordinates: { x: 0.1155, y: 0.8479 },
              },
            ],
          };
          this.init();
        }

        init() {
          this.bindEvents();
        }

        bindEvents() {
          $(document).on('click', '#world-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openWorldMap();
          });

          $(document).on('click', '#close-world-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeWorldMap();
          });

          $(document).on('click', '#world-map-modal', e => {
            if (e.target.id === 'world-map-modal') {
              this.closeWorldMap();
            }
          });

          $(window).on('resize', () => {
            if ($('#world-map-modal').is(':visible')) {
              setTimeout(() => {
                this.renderMapMarkers();
              }, 100);
            }
          });
        }

        openWorldMap() {
          console.log('ğŸ—¾ æ‰“å¼€ä¸–ç•Œåœ°å›¾');
          const modal = document.getElementById('world-map-modal');
          if (modal) {
            // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#world-map-modal').show();
          setTimeout(() => {
            this.renderMapMarkers();
          }, 100);
        }

        closeWorldMap() {
          $('#world-map-modal').hide();
          $('#location-detail-panel').hide();
        }

        renderMapMarkers() {
          const container = document.getElementById('map-markers-container');
          const image = document.getElementById('world-map-image');

          if (!container || !image) return;

          container.innerHTML = '';

          const waitForImageLoad = () => {
            if (image.complete && image.naturalHeight !== 0) {
              this.placeMarkers(container, image);
            } else {
              image.onload = () => this.placeMarkers(container, image);
            }
          };

          waitForImageLoad();
        }

        placeMarkers(container, image) {
          const imageRect = image.getBoundingClientRect();
          const containerRect = container.getBoundingClientRect();

          container.style.width = `${image.offsetWidth}px`;
          container.style.height = `${image.offsetHeight}px`;

          this.mapData.locations.forEach(location => {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.dataset.locationId = location.id;

            const x = location.coordinates.x * image.offsetWidth;
            const y = location.coordinates.y * image.offsetHeight;

            marker.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background: ${this.getTypeColor(location.type)};
              border: 2px solid white;
              cursor: pointer;
              pointer-events: all;
              transform: translate(-50%, -50%);
              transition: all 0.2s;
              z-index: 10;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;

            marker.addEventListener('mouseenter', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1.5)';
              marker.style.zIndex = '20';
            });

            marker.addEventListener('mouseleave', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1)';
              marker.style.zIndex = '10';
            });

            marker.addEventListener('click', e => {
              e.stopPropagation();
              this.showLocationDetail(location);
            });

            container.appendChild(marker);

            const label = document.createElement('div');
            label.className = 'map-label';
            label.textContent = location.name;
            label.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              transform: translate(-50%, -25px);
              font-size: 12px;
              color: #ffffff;
              font-weight: bold;
              white-space: nowrap;
              text-shadow: 2px 2px 4px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.7);
              background: rgba(0,0,0,0.6);
              padding: 2px 6px;
              border-radius: 4px;
              pointer-events: none;
              z-index: 5;
            `;

            container.appendChild(label);
          });
        }

        getTypeColor(type) {
          const colors = {
            racetrack: '#dc3545',
            city: '#007bff',
            scenic: '#28a745',
            landmark: '#6f42c1',
            facility: '#fd7e14',
            event: '#17a2b8',
            other: '#6c757d',
          };
          return colors[type] || colors['other'];
        }

        getTypeLabel(type) {
          const labels = {
            racetrack: 'ç«é©¬åœº',
            city: 'åŸå¸‚',
            scenic: 'é£æ™¯åèƒœ',
            landmark: 'åœ°æ ‡å»ºç­‘',
            facility: 'è®¾æ–½',
            event: 'äº‹ä»¶åœ°ç‚¹',
            other: 'å…¶ä»–',
          };
          return labels[type] || type;
        }

        showLocationDetail(location) {
          const panel = document.getElementById('location-detail-panel');
          const nameEl = document.getElementById('location-detail-name');
          const typeEl = document.getElementById('location-detail-type');
          const descEl = document.getElementById('location-detail-description');

          if (nameEl) nameEl.textContent = location.name;
          if (typeEl) typeEl.textContent = this.getTypeLabel(location.type);
          if (descEl) descEl.textContent = location.description || 'æš‚æ— æè¿°';

          if (panel) {
            panel.style.display = 'block';
          }
        }
      }

      $(document).ready(() => {
        setTimeout(() => {
          window.worldMapSystem = new WorldMapSystem();
          console.log('ğŸ—¾ ä¸–ç•Œåœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 100);
      });
    </script>

    <!-- å¿«æ·åœ°å›¾åŠŸèƒ½è„šæœ¬ -->
    <script>
      class MusicPlayerSystem {
        constructor() {
          this.currentTrackIndex = -1;
          this.isPlaying = false;
          this.currentVolume = 0.5;
          this.isDraggingProgress = false; // ç”¨äºé˜²æ­¢æ‹–åŠ¨æ—¶é—´è½´æ—¶è§¦å‘æ’­æ”¾
          // æ’­æ”¾æ¨¡å¼: 'sequence' (é¡ºåºæ’­æ”¾), 'random' (éšæœºæ’­æ”¾), 'repeat' (å¾ªç¯æ’­æ”¾)
          this.playMode = 'sequence'; // é»˜è®¤é¡ºåºæ’­æ”¾
          this.tracks = [
            {
              name: 'ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆãƒ»ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°',
              src: 'https://files.catbox.moe/qfwwgp.flac',
              type: 'FLAC',
            },
            {
              name: 'é©¬å¨˜ç››å®´ï¼ç¾é£Ÿå¤§æ¸¸è¡Œ',
              src: 'https://files.catbox.moe/jueda8.mp3',
              type: 'MP3',
            },
            {
              name: 'ãƒˆãƒ¬ã‚»ãƒ³éŸ³é ­ (å¼ºå‡»å®å®çš„)',
              src: 'https://files.catbox.moe/2izau9.mp3',
              type: 'MP3',
            },
            {
              name: 'è¶…ãˆã‚‹(è¶…è¶Šå§)',
              src: 'https://files.catbox.moe/v0iy0a.mp3',
              type: 'MP3',
            },
            {
              name: 'ãƒˆãƒ¬ã‚»ãƒ³éŸ³é ­ (Game Size)',
              src: 'https://files.catbox.moe/k0r0id.mp3',
              type: 'MP3',
            },
            {
              name: 'U.M.A. NEW WORLD!!',
              src: 'https://files.catbox.moe/okct8d.mp3',
              type: 'MP3',
            },
            {
              name: "GIRLS' LEGEND U",
              src: 'https://files.catbox.moe/146x8h.mp3',
              type: 'MP3',
            },
            {
              name: 'Glorious Momentï¼',
              src: 'https://files.catbox.moe/agi8yx.mp3',
              type: 'MP3',
            },
            {
              name: 'å‘¨å¹´åº†éŸ³ä¹1',
              src: 'https://files.catbox.moe/umai3u.m4a',
              type: 'M4A',
            },
            {
              name: 'å‘¨å¹´åº†éŸ³ä¹2',
              src: 'https://files.catbox.moe/j0qaqf.m4a',
              type: 'M4A',
            },
            { name: '123æˆ‘å“ˆä½ ', src: 'https://files.catbox.moe/wlhqc9.mp4', type: 'MP4' },
            { name: 'å“ˆåŸºç±³è¿™ä¸ªç”œèœœã€çº¯å‡€å“ˆåŸºç±³ã€‘', src: 'https://files.catbox.moe/ui1gwf.mp4', type: 'MP4' },
            {
              name: 'ã€å“ˆåŸºç±³ã€‘Conundrum å®ƒå“ˆæ°”äº†ï¼Œæ˜¨å¤©å“ˆçš„ï¼Œä½†å¥‡æ€ªçš„æ˜¯ï¼Œå®ƒå‰å¤©å°±æ­»äº†',
              src: 'https://files.catbox.moe/34edv0.mp4',
              type: 'MP4',
            },
            { name: 'å¾€äº‹åªèƒ½å“ˆåŸº', src: 'https://files.catbox.moe/ppchr5.mp4', type: 'MP4' },
            { name: 'ç²‰ çº¢ è‰² çš„ åŸº ç±³', src: 'https://files.catbox.moe/s8c70r.mp4', type: 'MP4' },
            { name: 'ã€å“ˆåŸºç±³FMã€‘èˆŒå°–ä¸Šçš„åŸºç±³', src: 'https://files.catbox.moe/dchs4n.mp4', type: 'MP4' },
            { name: 'ã€æƒåŸºé¾™ã€‘Ji MI YOU', src: 'https://files.catbox.moe/nhrhjl.mp4', type: 'MP4' },
            { name: 'ã€å“ˆåŸºç±³FMã€‘_å“ˆæ²«', src: 'https://files.catbox.moe/en0iq0.mp4', type: 'MP4' },
            { name: 'ã€Šå“ˆåŸºç±³èµ·åºŠæ›²ã€‹ğŸ±', src: 'https://files.catbox.moe/yyq6oj.mp4', type: 'MP4' },
            { name: 'ã€åŸºæººã€‘æ‚¬æººä¸€å“ï¼ŒåŸºç±³ç™»åœº', src: 'https://files.catbox.moe/bq9xsi.mp4', type: 'MP4' },
            {
              name: 'ã€è¡¥æ¡£ã€‘ğŸµæ›¼æ³¢ ğ‘µğ’ ğ‘´ğ’ğ’“ğ’†ğŸµä¸å†æ›¼æ³¢ï¼ˆå®Œæ•´ç‰ˆï¼‰',
              src: 'https://files.catbox.moe/7zivog.mp4',
              type: 'MP4',
            },
            { name: 'ã€å®Œæ•´ç‰ˆã€‘æœ€åä¸€å“ˆ', src: 'https://files.catbox.moe/8gc10g.mp4', type: 'MP4' },
            { name: 'ã€å“ˆåŸºç±³éŸ³ä¹ã€‘ä¸å¾—ä¸å“ˆ', src: 'https://files.catbox.moe/33d0tw.mp4', type: 'MP4' },
            {
              name: 'ã€Šæ‰“ç«åŸº (å“ˆåŸºç±³)ã€‹å®Œæ•´ç‰ˆï¼Œå“ˆåŸºç±³å•Šå—åŒ—ç»¿è±†ï¼',
              src: 'https://files.catbox.moe/23dd5p.mp4',
              type: 'MP4',
            },
            { name: 'åŸºç±³è¯´å®Œæ•´ç‰ˆ', src: 'https://files.catbox.moe/87jhj8.mp4', type: 'MP4' },
            { name: 'å‡ºå±±ï¼ˆå“ˆåŸºç±³ï¼‰å®Œæ•´ç‰ˆ', src: 'https://files.catbox.moe/6yjali.mp4', type: 'MP4' },
            { name: 'è“è²å“ˆ', src: 'https://files.catbox.moe/xt6sla.mp4', type: 'MP4' },
            { name: 'è·³æ¥¼åŸº', src: 'https://files.catbox.moe/ss1zds.mp4', type: 'MP4' },
            { name: 'æˆ‘è¢«å›°åœ¨äº†å“ˆåŸºä¹¡', src: 'https://files.catbox.moe/o1gorl.mp4', type: 'MP4' },
            { name: 'å“ˆåŸºç±³_talking to the moon', src: 'https://files.catbox.moe/h3rwx1.mp4', type: 'MP4' },
            { name: 'æ›¼æ³¢ ğ‘µğ’ ğ‘´ğ’ğ’“ğ’† ä¸å†æ›¼æ³¢ï¼ˆå®Œæ•´ç‰ˆï¼‰', src: 'https://files.catbox.moe/idekh0.mp4', type: 'MP4' },
            { name: 'SomeåŸºç±³ just like this', src: 'https://files.catbox.moe/sudv0z.mp4', type: 'MP4' },
          ];
          this.audio = null;
          this.init();
        }

        init() {
          this.bindEvents();
          this.audio = document.getElementById('music-player-audio');
          if (this.audio) {
            this.audio.volume = this.currentVolume;
            this.audio.loop = false; // ç”±ä»£ç æ§åˆ¶å¾ªç¯ï¼Œä¸ä½¿ç”¨HTMLçš„loopå±æ€§
            this.audio.addEventListener('timeupdate', () => this.updateTimeDisplay());
            this.audio.addEventListener('ended', () => this.onTrackEnded());
            this.audio.addEventListener('play', () => this.updateProfileSongDisplay());
            this.audio.addEventListener('pause', () => this.updateProfileSongDisplay());
          }
          // åˆå§‹åŒ–æ—¶æ›´æ–°æ­Œæ›²æ˜¾ç¤º
          this.updateProfileSongDisplay();
        }

        bindEvents() {
          $(document).on('click', '#music-player-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openMusicPlayer();
          });

          $(document).on('click', '#close-music-player-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeMusicPlayer();
          });

          $(document).on('click', '#music-player-modal', e => {
            if (e.target.id === 'music-player-modal') {
              this.closeMusicPlayer();
            }
          });

          $(document).on('click', '#music-play-pause-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.togglePlayPause();
          });

          $(document).on('click', '#music-prev-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.prevTrack();
          });

          $(document).on('click', '#music-next-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.nextTrack();
          });

          $(document).on('input', '#music-volume-slider', e => {
            this.setVolume(e.target.value / 100);
          });

          // æ—¶é—´è½´æ§åˆ¶
          $(document).on('input', '#music-progress-slider', e => {
            if (this.audio && this.audio.duration) {
              const seekTime = (e.target.value / 100) * this.audio.duration;
              this.audio.currentTime = seekTime;
            }
          });

          // é˜²æ­¢æ‹–åŠ¨æ—¶é—´è½´æ—¶è§¦å‘æ’­æ”¾
          $(document).on('mousedown', '#music-progress-slider', () => {
            this.isDraggingProgress = true;
          });
          $(document).on('mouseup', '#music-progress-slider', () => {
            this.isDraggingProgress = false;
          });

          $(document).on('click', '.music-track', e => {
            const trackSrc = $(e.currentTarget).data('src');
            const trackIndex = this.tracks.findIndex(track => track.src === trackSrc);
            if (trackIndex !== -1) {
              this.playTrack(trackIndex);
            }
          });

          // æ’­æ”¾æ¨¡å¼åˆ‡æ¢æŒ‰é’® - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
          $(document).on('click', '#music-mode-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            console.log('æ¨¡å¼åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡», å½“å‰æ¨¡å¼:', this.playMode);
            this.togglePlayMode();
            return false;
          });

          // ä¹Ÿå°è¯•ç›´æ¥ç»‘å®šåˆ°æŒ‰é’®ï¼ˆå¦‚æœæŒ‰é’®å·²å­˜åœ¨ï¼‰
          const modeBtn = document.getElementById('music-mode-btn');
          if (modeBtn) {
            modeBtn.addEventListener('click', e => {
              e.preventDefault();
              e.stopPropagation();
              console.log('æ¨¡å¼åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆç›´æ¥ç»‘å®šï¼‰, å½“å‰æ¨¡å¼:', this.playMode);
              this.togglePlayMode();
              return false;
            });
          }

          $(document).on('mouseenter', '.music-track', function () {
            $(this).css('background', 'rgba(255,255,255,0.1)');
          });

          $(document).on('mouseleave', '.music-track', function () {
            $(this).css('background', 'transparent');
          });
        }

        openMusicPlayer() {
          const modal = document.getElementById('music-player-modal');
          if (modal) {
            // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#music-player-modal').fadeIn(200, () => {
            // åœ¨æ¨¡æ€æ¡†å®Œå…¨æ˜¾ç¤ºåï¼Œç¡®ä¿æŒ‰é’®äº‹ä»¶ç»‘å®š
            const modeBtn = document.getElementById('music-mode-btn');
            if (modeBtn && !modeBtn.dataset.bound) {
              modeBtn.dataset.bound = 'true';
              modeBtn.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                console.log('æ¨¡å¼åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆå»¶è¿Ÿç»‘å®šï¼‰, å½“å‰æ¨¡å¼:', this.playMode);
                this.togglePlayMode();
                return false;
              });
            }
          });
          this.updateUI();
        }

        closeMusicPlayer() {
          $('#music-player-modal').fadeOut(200);
        }

        playTrack(index) {
          if (index < 0 || index >= this.tracks.length) return;

          this.currentTrackIndex = index;
          const track = this.tracks[index];

          if (this.audio) {
            this.audio.src = track.src;
            this.audio.load();
            // ç­‰å¾…éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
            this.audio.addEventListener(
              'loadedmetadata',
              () => {
                // é‡ç½®æ—¶é—´è½´
                const progressSlider = document.getElementById('music-progress-slider');
                if (progressSlider) {
                  progressSlider.value = 0;
                  progressSlider.max = 100;
                }
              },
              { once: true },
            );
            this.audio
              .play()
              .then(() => {
                this.isPlaying = true;
                this.updateUI();
                this.updateProfileSongDisplay();
              })
              .catch(e => {
                console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
              });
          }
        }

        togglePlayPause() {
          if (!this.audio) return;

          if (this.currentTrackIndex === -1 && this.tracks.length > 0) {
            this.playTrack(0);
            return;
          }

          if (this.isPlaying) {
            this.audio.pause();
            this.isPlaying = false;
          } else {
            this.audio
              .play()
              .then(() => {
                this.isPlaying = true;
              })
              .catch(e => {
                console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
              });
          }
          this.updateUI();
        }

        prevTrack() {
          if (this.tracks.length === 0) return;

          let prevIndex;
          if (this.playMode === 'random') {
            // éšæœºæ’­æ”¾ï¼šéšæœºé€‰æ‹©ä¸€é¦–æ­Œ
            prevIndex = Math.floor(Math.random() * this.tracks.length);
          } else if (this.playMode === 'repeat') {
            // å¾ªç¯æ’­æ”¾ï¼šå¾ªç¯å½“å‰æ­Œæ›²
            prevIndex = this.currentTrackIndex;
          } else {
            // é¡ºåºæ’­æ”¾ï¼šä¸Šä¸€é¦–
            prevIndex = this.currentTrackIndex <= 0 ? this.tracks.length - 1 : this.currentTrackIndex - 1;
          }

          this.playTrack(prevIndex);
        }

        nextTrack() {
          if (this.tracks.length === 0) return;

          let nextIndex;
          if (this.playMode === 'random') {
            // éšæœºæ’­æ”¾ï¼šéšæœºé€‰æ‹©ä¸€é¦–æ­Œ
            nextIndex = Math.floor(Math.random() * this.tracks.length);
          } else if (this.playMode === 'repeat') {
            // å¾ªç¯æ’­æ”¾ï¼šé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            nextIndex = this.currentTrackIndex;
          } else {
            // é¡ºåºæ’­æ”¾ï¼šä¸‹ä¸€é¦–
            nextIndex = this.currentTrackIndex >= this.tracks.length - 1 ? 0 : this.currentTrackIndex + 1;
          }

          this.playTrack(nextIndex);
        }

        onTrackEnded() {
          if (this.playMode === 'repeat') {
            // å¾ªç¯æ’­æ”¾æ¨¡å¼ï¼šé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            if (this.currentTrackIndex >= 0 && this.audio) {
              this.audio.currentTime = 0;
              this.audio
                .play()
                .then(() => {
                  this.isPlaying = true;
                  this.updateUI();
                })
                .catch(e => {
                  console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
                });
            }
          } else {
            // é¡ºåºæ’­æ”¾æˆ–éšæœºæ’­æ”¾ï¼šæ’­æ”¾ä¸‹ä¸€é¦–
            this.nextTrack();
          }
        }

        togglePlayMode() {
          // åˆ‡æ¢æ’­æ”¾æ¨¡å¼ï¼šé¡ºåº -> éšæœº -> å¾ªç¯ -> é¡ºåº
          const modes = ['sequence', 'random', 'repeat'];
          const currentModeIndex = modes.indexOf(this.playMode);
          this.playMode = modes[(currentModeIndex + 1) % modes.length];
          console.log('æ’­æ”¾æ¨¡å¼åˆ‡æ¢ä¸º:', this.playMode);
          this.updateUI();
        }

        setVolume(volume) {
          this.currentVolume = Math.max(0, Math.min(1, volume));
          if (this.audio) {
            this.audio.volume = this.currentVolume;
          }
          $('#volume-display').text(Math.round(this.currentVolume * 100) + '%');
        }

        updateTimeDisplay() {
          if (!this.audio) return;

          const current = this.formatTime(this.audio.currentTime);
          const total = this.formatTime(this.audio.duration || 0);
          $('#current-track-time').text(`${current} / ${total}`);

          // æ›´æ–°æ—¶é—´è½´æ»‘å—å’Œæ˜¾ç¤º
          if (this.audio.duration && !isNaN(this.audio.duration)) {
            const progress = (this.audio.currentTime / this.audio.duration) * 100;
            const progressSlider = document.getElementById('music-progress-slider');
            if (progressSlider && !this.isDraggingProgress) {
              progressSlider.value = progress;
            }
            $('#current-time-display').text(current);
            $('#total-time-display').text(total);
          } else {
            $('#current-time-display').text('00:00');
            $('#total-time-display').text('00:00');
          }
        }

        formatTime(seconds) {
          if (isNaN(seconds)) return '00:00';
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        updateUI() {
          const playPauseBtn = $('#music-play-pause-btn');
          const trackName = $('#current-track-name');
          const modeBtn = $('#music-mode-btn');

          if (this.isPlaying) {
            playPauseBtn.text('â¸');
          } else {
            playPauseBtn.text('â–¶');
          }

          // æ›´æ–°æ’­æ”¾æ¨¡å¼æŒ‰é’®æ˜¾ç¤º
          let modeText = '';
          let modeTitle = '';
          switch (this.playMode) {
            case 'sequence':
              modeText = 'â–¶ï¸';
              modeTitle = 'é¡ºåºæ’­æ”¾';
              break;
            case 'random':
              modeText = 'ğŸ”€';
              modeTitle = 'éšæœºæ’­æ”¾';
              break;
            case 'repeat':
              modeText = 'ğŸ”‚';
              modeTitle = 'å¾ªç¯æ’­æ”¾';
              break;
          }
          if (modeBtn.length) {
            modeBtn.text(modeText);
            modeBtn.attr('title', modeTitle);
          }

          if (this.currentTrackIndex >= 0 && this.currentTrackIndex < this.tracks.length) {
            const track = this.tracks[this.currentTrackIndex];
            trackName.text(track.name);

            $('.music-track').css('background', 'transparent');
            $(`.music-track[data-src="${track.src}"]`).css('background', 'rgba(139, 69, 19, 0.3)');
          } else {
            trackName.text('æœªé€‰æ‹©éŸ³ä¹');
          }
        }

        updateProfileSongDisplay() {
          const profileSongElement = $('#profile-current-song');
          const profileSongName = $('#profile-song-name');

          if (this.isPlaying && this.currentTrackIndex >= 0 && this.currentTrackIndex < this.tracks.length) {
            const track = this.tracks[this.currentTrackIndex];
            profileSongName.text(track.name);
            profileSongElement.show();
          } else {
            profileSongElement.hide();
          }
        }
      }

      class QuickMapSystem {
        constructor() {
          this.mapData = {
            mapInfo: {
              id: 'treisen_map',
              name: 'ç‰¹é›·æ£®åœ°å›¾',
              imageUrl: 'https://files.catbox.moe/psluhm.jpg',
              originalWidth: 800,
              originalHeight: 885,
            },
            locations: [
              {
                id: 'location_1757315796222',
                name: 'æ“åœº',
                description:
                  'ç”¨äºæ¯”èµ›è®­ç»ƒã€‚è®­ç»ƒé¡¹ç›®æ˜¯æ ¹æ®æ¯ä¸ªå›¢é˜Ÿçš„è®­ç»ƒå‘˜çš„æŒ‡ç¤ºæ¥è®¾ç½®çš„ã€‚å¦å¤–ï¼Œèµ›é“æ¯å¹´ä¼šä¸¾è¡Œå¤šæ¬¡é€‰æ‹”èµ›ï¼Œå¤§æ‰¹çš„è®­ç»ƒå‘˜ä¼šé›†ä¸­äºæ­¤ï¼Œå’Œäº’ç›¸ä¸­æ„çš„é©¬å¨˜ç¼”ç»“æ‹…å½“å…³ç³»ã€‚ èµ›é“ç”±è‰åœ°ã€æ³¥åœ°ã€æœ¨å±‘å’Œæ–œå¡ç»„æˆã€‚',
                type: 'academy',
                coordinates: { x: 0.4325, y: 0.3186 },
              },
              {
                id: 'location_1757315823108',
                name: 'é“è·¯',
                description: 'ä¸€æ¡å¾ˆé•¿é€šå¾€å¹½å¾„çš„é“è·¯',
                type: 'academy',
                coordinates: { x: 0.1138, y: 0.3209 },
              },
              {
                id: 'location_1757315838038',
                name: 'è®­ç»ƒåœºå…¥å£',
                description: '',
                type: 'academy',
                coordinates: { x: 0.5075, y: 0.4927 },
              },
              {
                id: 'location_1757315853595',
                name: 'è§‚æ™¯å°',
                description: 'å¯ä»¥è§‚å¯Ÿæ•´ä¸ªè®­ç»ƒåœº',
                type: 'academy',
                coordinates: { x: 0.3588, y: 0.4633 },
              },
              {
                id: 'location_1757315890935',
                name: 'å®¤å†…æ¸¸æ³³å®¤',
                description: 'é‡Œé¢æœ‰æ³³æ± å’Œè·³å°ï¼Œç”¨äºé©¬å¨˜è€åŠ›è®­ç»ƒ',
                type: 'academy',
                coordinates: { x: 0.3975, y: 0.5684 },
              },
              {
                id: 'location_1757316016060',
                name: 'æ¼”æ’­å®¤',
                description: 'å­¦é™¢å¹¿æ’­å¤„',
                type: 'academy',
                coordinates: { x: 0.3375, y: 0.5831 },
              },
              {
                id: 'location_1757316031219',
                name: 'å¥èº«æˆ¿',
                description:
                  'å¥èº«æˆ¿é‡Œé…å¤‡äº†å„ç§è®­ç»ƒå™¨æï¼ŒåŒ…æ‹¬æ é“ƒå’Œè·‘æ­¥æœºï¼Œç”¨äºä½“èƒ½è®­ç»ƒã€‚å–œæ¬¢é”»ç‚¼çš„é©¬å¨˜ä¼šç»å¸¸å…‰é¡¾è¿™é‡Œã€‚æ­¤å¤–ï¼Œå¥èº«æˆ¿è¿˜æœ‰åŠˆç“¦åœºåœ°å’Œæ‹³å‡»æ²™è¢‹ã€‚',
                type: 'academy',
                coordinates: { x: 0.3075, y: 0.5718 },
              },
              {
                id: 'location_1757316059582',
                name: 'ä¸»æ•™å­¦æ¥¼',
                description: 'é©¬å¨˜ä¸Šè¯¾çš„åœ°æ–¹',
                type: 'academy',
                coordinates: { x: 0.4537, y: 0.7243 },
              },
              {
                id: 'location_1757316081381',
                name: 'é©¬å¨˜å¤§å…',
                description:
                  'é©¬å¨˜å¤§å…æ˜¯ä½äºæ•™å­¦æ¥¼ä¸­å¤®çš„ä¸¤å±‚é«˜çš„å¤§å…ã€‚å¯ä»¥è¿›å…¥é‡‡è´­éƒ¨ã€å›¾ä¹¦é¦†ã€å­¦æ ¡å…¬å‘Šæ ã€è®­ç»ƒå‘˜å®¤ã€èµ„æ–™å®¤å’Œå„ç§æ¯”èµ›ç™»è®°å¤§å…ã€‚å½“æ²¡æœ‰è¯¾ç¨‹æˆ–åŸ¹è®­æ—¶ï¼Œé©¬å¨˜ä»¬ä¼šåœ¨å¸ƒç½®å¥½çš„æ¡Œå­å’Œæ²™å‘ä¸ŠèŠå¤©ã€‚åœ¨æ´»åŠ¨æœŸé—´ï¼Œå¤§å…ä¼šè¢«è£…é¥°å¾—å¾ˆæ¼‚äº®ã€‚',
                type: 'academy',
                coordinates: { x: 0.4525, y: 0.6621 },
              },
              {
                id: 'location_1757316107919',
                name: 'è®­ç»ƒå‘˜å®¤',
                description:
                  'å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å»ºç­‘ï¼Œæœ‰ç‰¹å®šçš„å‚¨ç‰©æŸœå­˜æ”¾é©¬å¨˜ä»¬è®­ç»ƒç”¨çš„ä¸ªäººç‰©å“ï¼›å®ƒç›´æ¥ä¸ä¸»æ•™å­¦æ¥¼çš„å…¥å£å¤§å…ç›¸è¿ã€‚ä¸æ•™å¸ˆçš„æˆ¿é—´ä¸åŒï¼Œåªè¦æ²¡æœ‰ä¸Šé”ï¼Œå³ä½¿æ˜¯éæ‹…å½“é©¬å¨˜ä¹Ÿå¯ä»¥è‡ªç”±å‡ºå…¥è®­ç»ƒå‘˜å®¤ã€‚è®­ç»ƒå‘˜æ¯å¤©ä»ä»–ä»¬çš„å…¬å¯“æˆ–é™„è¿‘çš„ä½æ‰€åˆ°è¾¾è‡ªå·±çš„æˆ¿é—´ã€‚',
                type: 'academy',
                coordinates: { x: 0.5563, y: 0.6938 },
              },
              {
                id: 'location_1757316131313',
                name: 'èµ„æ–™å®¤',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3488, y: 0.6655 },
              },
              {
                id: 'location_1757316135656',
                name: 'å›¾ä¹¦é¦†',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3488, y: 0.6949 },
              },
              {
                id: 'location_1757316143920',
                name: 'æ¯”èµ›ç™»è®°å¤§å…',
                description: '',
                type: 'academy',
                coordinates: { x: 0.3475, y: 0.7232 },
              },
              {
                id: 'location_1757316184357',
                name: 'é£Ÿå ‚',
                description:
                  'èœå•ä¼¼ä¹å¾ˆå‡è¡¡ï¼Œæä¾›äº†å„ç§ä¸åŒçš„èƒ¡èåœèœè‚´ã€‚\né£Ÿå ‚æä¾›å…è´¹çš„è‡ªåŠ©é¤ï¼Œæƒ³åƒå¤šå°‘å°±åƒå¤šå°‘ï¼Œä¸ä¼šè®©é©¬å¨˜æœ‰æœºä¼šè¯´åƒä¸é¥±é¥­ã€‚\né£Ÿå ‚è¿˜æœ‰ä¸€å°ç”µè§†æœºï¼Œè¿‘æœŸæ²¡æœ‰æ¯”èµ›å®‰æ’çš„é©¬å¨˜å¯ä»¥åœ¨é‚£é‡Œè§‚çœ‹æ¯”èµ›ã€‚',
                type: 'academy',
                coordinates: { x: 0.2712, y: 0.6768 },
              },
              {
                id: 'location_1757316261180',
                name: 'è®­ç»ƒå‘˜å®¿èˆ',
                description: 'è®­ç»ƒå‘˜ä¸€äººå±…ä½çš„åœ°æ–¹ï¼ŒæŒ‰é“ç†åªèƒ½è®­ç»ƒå‘˜è¿›å…¥',
                type: 'dormitory',
                coordinates: { x: 0.1412, y: 0.7842 },
              },
              {
                id: 'location_1757316315511',
                name: 'è¡Œæ”¿æ¥¼',
                description: 'ç†äº‹é•¿åŠå…¬å®¤ã€æ•™å¸ˆåŠå…¬å®¤æ‰€åœ¨çš„åœ°æ–¹',
                type: 'academy',
                coordinates: { x: 0.2825, y: 0.7864 },
              },
              {
                id: 'location_1757316324398',
                name: 'åŒ»åŠ¡å®¤',
                description: '',
                type: 'academy',
                coordinates: { x: 0.2362, y: 0.8181 },
              },
              {
                id: 'location_1757316354682',
                name: 'ä¸‰å¥³ç¥åƒ',
                description: 'åè½äºæ•™å­¦æ¥¼å‰ï¼Œä¸­å¿ƒå¹¿åœºä¸­é—´',
                type: 'academy',
                coordinates: { x: 0.455, y: 0.7898 },
              },
              {
                id: 'location_1757316365937',
                name: 'ä¸­å¿ƒå¹¿åœº',
                description: '',
                type: 'academy',
                coordinates: { x: 0.455, y: 0.826 },
              },
              {
                id: 'location_1757316382806',
                name: 'åœè½¦åœº',
                description: 'ä¸€ä¸ªå¹¿é˜”çš„åœè½¦åœº',
                type: 'academy',
                coordinates: { x: 0.7662, y: 0.513 },
              },
              {
                id: 'location_1757316447437',
                name: 'éœ²å¤©æ¼”å‡ºèˆå°',
                description: 'é©¬å¨˜èƒœè€…èˆå°æ¼”å‡ºçš„åœ°æ–¹',
                type: 'academy',
                coordinates: { x: 0.6575, y: 0.6655 },
              },
              {
                id: 'location_1757316464723',
                name: 'èˆè¹ˆå®¤',
                description:
                  'å®ƒè¢«ç”¨äºèƒœè€…èˆå°çš„ç»ƒä¹ ã€‚å®ƒè¿˜æœ‰æ£€æŸ¥å®µç¦çš„èŒèƒ½ï¼Œé©¬å¨˜ä»¬è½®æµè´Ÿè´£æ­¤äº‹ï¼Œé€šå¸¸ç”±å°æ —å¸½ã€è±äºšé©¬é€Šå’Œå¯Œå£«å¥‡çŸ³æ¥æ‹…ä»»ã€‚\nå¢™å£æ˜¯é•œé¢çš„ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªèŠ­è•¾èˆè¯¾ç”¨çš„å§å°ä»¥åŠæ‰¬å£°å™¨ã€‚',
                type: 'academy',
                coordinates: { x: 0.6262, y: 0.6983 },
              },
              {
                id: 'location_1757316486267',
                name: 'ç½‘çƒåœº',
                description: '',
                type: 'academy',
                coordinates: { x: 0.595, y: 0.896 },
              },
              {
                id: 'location_1757316492058',
                name: 'è¶³çƒåœº',
                description: '',
                type: 'academy',
                coordinates: { x: 0.25, y: 0.8893 },
              },
              {
                id: 'location_1757316529235',
                name: 'æ­£é—¨å‡ºå£',
                description: 'ç¦»å¼€ç‰¹é›·æ£®å­¦é™¢çš„æ­£é—¨å‡ºå£',
                type: 'academy',
                coordinates: { x: 0.4537, y: 0.9028 },
              },
              {
                id: 'location_1757316616185',
                name: 'å®¤å†…ä½“è‚²é¦†',
                description: 'é‡Œé¢æœ‰ç¯®çƒåœºï¼Œå®¤å†…æ“åœº',
                type: 'academy',
                coordinates: { x: 0.6225, y: 0.8011 },
              },
              {
                id: 'location_1757316674951',
                name: 'åˆ†æ¥¼Bæ¥¼',
                description: 'ä¸»æ•™å­¦æ¥¼å³åˆ†æ¥¼Bæ¥¼',
                type: 'academy',
                coordinates: { x: 0.5637, y: 0.7831 },
              },
              {
                id: 'location_1757316700900',
                name: 'åˆ†æ¥¼Aæ¥¼',
                description: 'ä¸»æ•™å­¦æ¥¼å·¦åˆ†æ¥¼Aæ¥¼',
                type: 'academy',
                coordinates: { x: 0.35, y: 0.7876 },
              },
              {
                id: 'location_1757316880923',
                name: 'ä¸­åº­çš„æ¯æ ‘æ´',
                description:
                  'æ ‘æ´ä½äºå­¦é™¢çš„ä¸­åº­çš„ä¸€ä¸ªè§’è½ã€‚é‡Œé¢ç©ºç©ºåœ°æ•å¼€ç€ï¼Œæ˜¯ç”¨äºè®©äººä»¬æŠŠç—›è‹¦å’Œæ‚”æ¨å‘æ³„å‡ºæ¥çš„åœºæ‰€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿæœ‰åˆ©ç”¨å®ƒæ¥å‘æ³„åœ¨è„‘å†…æŠ‘åˆ¶ä¸ä½çš„ä¸€äº›æƒ³æ³•çš„é©¬å¨˜ã€‚',
                type: 'academy',
                coordinates: { x: 0.5112, y: 0.652 },
              },
              {
                id: 'location_1757316897037',
                name: 'å°æ ‘æ—',
                description: 'ç¥ç§˜å°æ ‘æ—',
                type: 'academy',
                coordinates: { x: 0.17, y: 0.5198 },
              },
              {
                id: 'location_1757316924958',
                name: 'èåœå†œåœº',
                description: 'é©¬å¨˜ç§æ¤èƒ¡èåœçš„å†œåœº',
                type: 'academy',
                coordinates: { x: 0.2288, y: 0.5299 },
              },
              {
                id: 'location_1757316979646',
                name: 'åå±±',
                description: 'è¿™é‡Œå¯ä»¥è¿›å…¥æ¸©æ³‰ï¼Œéœ€è¦é—¨ç¥¨æ¸©æ³‰å·',
                type: 'academy',
                coordinates: { x: 0.7037, y: 0.1322 },
              },
              {
                id: 'location_1757317006073',
                name: 'æ´»åŠ¨å®¤1',
                description: 'é©¬å¨˜çš„å°å‹æ´»åŠ¨å®¤',
                type: 'academy',
                coordinates: { x: 0.5288, y: 0.9345 },
              },
              {
                id: 'location_1757317034055',
                name: 'æ´»åŠ¨å®¤2',
                description: 'å­¦é™¢è§’è½åˆ†å¸ƒçš„é©¬å¨˜å°å‹æ´»åŠ¨å®¤',
                type: 'academy',
                coordinates: { x: 0.715, y: 0.9345 },
              },
              {
                id: 'location_1757317092573',
                name: 'å‰å¾€é©¬å¨˜å®¿èˆ',
                description: 'åˆ†ä¸ºç¾æµ¦å¯®å’Œæ —ä¸œå¯®ï¼Œåœ¨å­¦é™¢å¤–ï¼Œæ­£å¯¹ç€å­¦é™¢çš„æ­£é—¨',
                type: 'dormitory',
                coordinates: { x: 0.4525, y: 0.9367 },
              },
              {
                id: 'location_1757317305740',
                name: 'æ´»åŠ¨æ¥¼',
                description: 'ä¾›é©¬å¨˜ä»¬åœ¨ä¼‘æ¯æ—¶å…‰å¨±ä¹ã€æ´»åŠ¨æˆ–å‚åŠ ç¤¾å›¢æ´»åŠ¨çš„å¤§æ¥¼ï¼Œæœ‰ç€ç¾æœ¯å®¤ã€éŸ³ä¹å®¤ç­‰ç­‰',
                type: 'academy',
                coordinates: { x: 0.6775, y: 0.8915 },
              },
              {
                id: 'location_1757317376475',
                name: 'å‰å¾€è½¦ç«™',
                description: 'å†…æœ‰å•†åŸå’Œé¥­åº—ï¼Œäº¤é€šæ¢çº½',
                type: 'event',
                coordinates: { x: 0.8775, y: 0.4497 },
              },
              {
                id: 'location_1757317431673',
                name: 'å‰å¾€å•†ä¸šè¡—',
                description: 'å­¦é™¢å¤–çš„å•†ä¸šè¡—ï¼Œå“ªé‡Œæœ‰è¡—æœºå…ã€æ‰­è›‹æœºã€ç”µå½±é™¢ã€å¡æ‹‰OK',
                type: 'event',
                coordinates: { x: 0.9, y: 0.4836 },
              },
              {
                id: 'location_1757317539563',
                name: 'å‰å¾€æ²³æ',
                description: 'å­¦é™¢å¤–æ²³è¾¹çš„å ¤å²¸ï¼Œç¯å¢ƒä¼˜ç¾',
                type: 'academy',
                coordinates: { x: 0.82, y: 0.4576 },
              },
            ],
          };

          this.selectedLocation = null;
          this.zoomLevel = 1;
          this.minZoom = 0.5;
          this.maxZoom = 3;
          this.zoomStep = 0.25;
          this.isDragging = false;
          this.dragStart = { x: 0, y: 0 };
          this.dragOffset = { x: 0, y: 0 };
          this.init();
        }

        init() {
          this.bindEvents();
        }

        bindEvents() {
          $(document).on('click', '#quickmap-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.openQuickMap();
          });

          $(document).on('click', '#close-quick-map-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeQuickMap();
          });

          $(document).on('click', '#quick-map-modal', e => {
            if (e.target.id === 'quick-map-modal') {
              this.closeQuickMap();
            }
          });

          $(window).on('resize', () => {
            if ($('#quick-map-modal').is(':visible')) {
              setTimeout(() => {
                this.renderMapMarkers();
              }, 100);
            }
          });

          $(document).on('click', '#close-location-confirm-btn, #cancel-location-move', e => {
            e.preventDefault();
            e.stopPropagation();
            this.closeLocationConfirm();
          });

          $(document).on('click', '#confirm-location-move', e => {
            e.preventDefault();
            e.stopPropagation();
            this.executeMove();
          });

          $(document).on('click', '#location-confirm-modal', e => {
            if (e.target.id === 'location-confirm-modal') {
              this.closeLocationConfirm();
            }
          });

          $(document).on('click', '#zoom-in-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.zoomIn();
          });

          $(document).on('click', '#zoom-out-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.zoomOut();
          });

          $(document).on('click', '#zoom-reset-btn', e => {
            e.preventDefault();
            e.stopPropagation();
            this.resetZoom();
          });

          $(document).on('mousedown', '#map-container', e => {
            if (this.zoomLevel > 1 && !$(e.target).hasClass('compact-button') && !$(e.target).hasClass('map-marker')) {
              this.isDragging = true;
              this.dragStart.x = e.clientX;
              this.dragStart.y = e.clientY;
              $('#map-container').css('cursor', 'grabbing');
              e.preventDefault();
              e.stopPropagation();
            }
          });

          $(document).on('mousemove', e => {
            if (this.isDragging && this.zoomLevel > 1) {
              const deltaX = e.clientX - this.dragStart.x;
              const deltaY = e.clientY - this.dragStart.y;

              this.dragOffset.x += deltaX;
              this.dragOffset.y += deltaY;

              this.dragStart.x = e.clientX;
              this.dragStart.y = e.clientY;

              this.updateTransform();
              e.preventDefault();
            }
          });

          $(document).on('mouseup', () => {
            if (this.isDragging) {
              this.isDragging = false;
              $('#map-container').css('cursor', this.zoomLevel > 1 ? 'grab' : 'default');
            }
          });

          $(document).on('mouseleave', '#quick-map-modal', () => {
            if (this.isDragging) {
              this.isDragging = false;
              $('#map-container').css('cursor', this.zoomLevel > 1 ? 'grab' : 'default');
            }
          });
        }

        openQuickMap() {
          console.log('ğŸ—ºï¸ æ‰“å¼€å¿«æ·åœ°å›¾');
          const modal = document.getElementById('quick-map-modal');
          if (modal) {
            // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#quick-map-modal').show();
          setTimeout(() => {
            this.renderMapMarkers();
          }, 100);
        }

        closeQuickMap() {
          $('#quick-map-modal').hide();
          this.resetZoom();
        }

        renderMapMarkers() {
          const container = document.getElementById('quick-map-markers-container');
          const image = document.getElementById('quick-map-image');

          if (!container || !image) return;

          const waitForImageLoad = () => {
            if (image.complete && image.naturalHeight !== 0) {
              this.placeMarkers(container, image);
            } else {
              image.onload = () => this.placeMarkers(container, image);
            }
          };

          waitForImageLoad();
        }

        placeMarkers(container, image) {
          container.innerHTML = '';

          const imageWidth = image.offsetWidth;
          const imageHeight = image.offsetHeight;

          this.mapData.locations.forEach(location => {
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.dataset.locationId = location.id;

            const x = location.coordinates.x * imageWidth;
            const y = location.coordinates.y * imageHeight;

            marker.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background: ${this.getTypeColor(location.type)};
              border: 2px solid white;
              cursor: pointer;
              pointer-events: all;
              transform: translate(-50%, -50%);
              transition: all 0.2s;
              z-index: 10;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;

            marker.addEventListener('mouseenter', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1.5)';
              marker.style.zIndex = '20';
            });

            marker.addEventListener('mouseleave', () => {
              marker.style.transform = 'translate(-50%, -50%) scale(1)';
              marker.style.zIndex = '10';
            });

            marker.addEventListener('click', e => {
              e.stopPropagation();
              this.confirmMoveTo(location);
            });

            container.appendChild(marker);

            const label = document.createElement('div');
            label.className = 'map-label';
            label.textContent = location.name;
            label.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              transform: translate(-50%, -25px);
              font-size: 12px;
              color: #ffffff;
              font-weight: bold;
              white-space: nowrap;
              text-shadow: 2px 2px 4px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.7);
              background: rgba(0,0,0,0.6);
              padding: 2px 6px;
              border-radius: 4px;
              pointer-events: none;
              z-index: 5;
            `;

            container.appendChild(label);
          });
        }

        getTypeColor(type) {
          const colors = {
            academy: '#007bff',
            dormitory: '#28a745',
            event: '#ffc107',
          };
          return colors[type] || '#6c757d';
        }

        confirmMoveTo(location) {
          this.selectedLocation = location;

          $('#confirm-location-name').text(location.name);
          $('#confirm-location-description').text(location.description || 'æ— è¯¦ç»†æè¿°');

          // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨ï¼ˆä¿®å¤å…¨å±æ¨¡å¼ä¸‹å¼¹çª—ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼‰
          const modal = document.getElementById('location-confirm-modal');
          if (modal) {
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }

          $('#location-confirm-modal').fadeIn(200);
        }

        closeLocationConfirm() {
          $('#location-confirm-modal').fadeOut(200);
          this.selectedLocation = null;
        }

        executeMove() {
          if (!this.selectedLocation) return;

          // ğŸ”¥ å‘é€åˆ°è¾“å…¥æ¡†ï¼Œä¸å‘é€èŠå¤©
          const actionText = `[å‰å¾€${this.selectedLocation.name}]`;
          const actionInput = document.getElementById('action-input');
          if (actionInput) {
            actionInput.value = actionText;
            actionInput.focus();
            console.log(`ğŸ—ºï¸ å·²å°†ç§»åŠ¨æŒ‡ä»¤å¡«å…¥è¾“å…¥æ¡†: ${actionText}`);
            if (typeof showTemporaryMessage === 'function') {
              showTemporaryMessage(`å·²å°† ${actionText} å¡«å…¥è¾“å…¥æ¡†`);
            }
          } else {
            console.error('æ‰¾ä¸åˆ°action-inputå…ƒç´ ');
          }

          this.closeLocationConfirm();
          this.closeQuickMap();
        }

        zoomIn() {
          if (this.zoomLevel < this.maxZoom) {
            this.zoomLevel = Math.min(this.zoomLevel + this.zoomStep, this.maxZoom);
            this.applyZoom();
          }
        }

        zoomOut() {
          if (this.zoomLevel > this.minZoom) {
            this.zoomLevel = Math.max(this.zoomLevel - this.zoomStep, this.minZoom);
            this.applyZoom();
          }
        }

        resetZoom() {
          this.zoomLevel = 1;
          this.dragOffset.x = 0;
          this.dragOffset.y = 0;
          this.applyZoom();
        }

        updateTransform() {
          const mapContainer = document.getElementById('map-container');
          if (mapContainer) {
            mapContainer.style.transform = `scale(${this.zoomLevel}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;
          }
        }

        applyZoom() {
          const mapContainer = document.getElementById('map-container');

          if (mapContainer) {
            mapContainer.style.transform = `scale(${this.zoomLevel}) translate(${this.dragOffset.x}px, ${this.dragOffset.y}px)`;
            mapContainer.style.cursor = this.zoomLevel > 1 ? 'grab' : 'default';
          }
        }
      }

      $(document).ready(() => {
        setTimeout(() => {
          window.quickMapSystem = new QuickMapSystem();

          // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨ç³»ç»Ÿ
          window.musicPlayerSystem = new MusicPlayerSystem();

          // åˆå§‹åŒ–æˆå°±ç³»ç»Ÿ
          window.achievementSystem = new TreisenAchievementSystem();
          window.achievementSystem.init();
          console.log('ğŸ—ºï¸ å¿«æ·åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
          console.log('ğŸ† ç‰¹é›·æ£®æˆå°±ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }, 200);
      });
    </script>

    <!-- ç‰¹é›·æ£®æˆå°±ç³»ç»Ÿ -->
    <script>
      const TREISEN_ACHIEVEMENTS = [
        // å¤©èµ‹è§‰é†’æˆå°±
        {
          id: 'talent_awakened',
          name: 'å¤©èµ‹è§‰é†’',
          description: 'æˆåŠŸè§‰é†’ç¬¬ä¸€ä¸ªå¤§å¤©èµ‹',
          completionText: 'å†…å¿ƒæ·±å¤„çš„åŠ›é‡å¼€å§‹è§‰é†’',
          quality: 'ç¨€æœ‰',
          icon: 'â­',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å¤§å¤©èµ‹.name', operator: '!=', value: '' },
        },
        {
          id: 'small_talent_unlocked',
          name: 'å°å¤©èµ‹å¯è’™',
          description: 'è§£é”ç¬¬ä¸€ä¸ªå°å¤©èµ‹ï¼ˆèŒèŠ½å±‚çº§ï¼‰',
          completionText: 'å¤©èµ‹ä¹‹è·¯çš„ç¬¬ä¸€æ­¥',
          quality: 'æ™®é€š',
          icon: 'âœ¨',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.èŒèŠ½', operator: '!=', value: null },
        },

        // ç»“æ™¶ç›¸å…³æˆå°±ï¼ˆåˆå§‹0ï¼‰
        {
          id: 'first_crystal',
          name: 'åˆæ¬¡æ”¶è·',
          description: 'è·å¾—ç¬¬ä¸€ä¸ªç•¸å½¢æƒ…æ„Ÿç»“æ™¶',
          completionText: 'è¿™å¥‡å¼‚çš„ç»“æ™¶æ•£å‘ç€ç¥ç§˜çš„å…‰èŠ’',
          quality: 'æ™®é€š',
          icon: 'ğŸ’',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', operator: '>=', value: 1 },
        },
        {
          id: 'crystal_collector',
          name: 'ç»“æ™¶æ”¶é›†å®¶',
          description: 'ç§¯ç´¯50ä¸ªç•¸å½¢æƒ…æ„Ÿç»“æ™¶',
          completionText: 'è¿™äº›ç»“æ™¶è•´å«ç€å¼ºå¤§çš„åŠ›é‡',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ’',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', operator: '>=', value: 50 },
        },
        {
          id: 'crystal_hoarder',
          name: 'ç»“æ™¶å¤§å¸ˆ',
          description: 'ç§¯ç´¯100ä¸ªç•¸å½¢æƒ…æ„Ÿç»“æ™¶',
          completionText: 'ä½ å·²ç»æŒæ¡äº†æƒ…æ„Ÿç»“æ™¶åŒ–çš„ç§˜å¯†',
          quality: 'å²è¯—',
          icon: 'ğŸ‘‘',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', operator: '>=', value: 100 },
        },

        // ç”Ÿå­˜æŒ‘æˆ˜æˆå°±
        {
          id: 'sanity_crisis',
          name: 'ç†æ™ºè¾¹ç¼˜',
          description: 'ç†æ™ºå€¼é™åˆ°20ä»¥ä¸‹ä½†ä»å­˜æ´»',
          completionText: 'åœ¨ç–¯ç‹‚è¾¹ç¼˜ï¼Œä½ ä¾ç„¶åšæŒç€',
          quality: 'å²è¯—',
          icon: 'ğŸ§ ',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç†æ™º', operator: '<=', value: 20 },
        },
        {
          id: 'exhausted',
          name: 'ç²¾ç–²åŠ›å°½',
          description: 'ä½“åŠ›å€¼é™åˆ°10ä»¥ä¸‹',
          completionText: 'ç–²æƒ«ä¸å ªï¼Œä½†æ„å¿—ä¾ç„¶åšå®š',
          quality: 'æ™®é€š',
          icon: 'ğŸ˜´',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ä½“åŠ›', operator: '<=', value: 10 },
        },
        {
          id: 'rule_breaker',
          name: 'å›é€†è€…',
          description: 'è¿è§„5æ¬¡ä»¥ä¸Š',
          completionText: 'æœ‰æ—¶å€™ï¼Œè¿èƒŒè§„åˆ™ä¹Ÿæ˜¯ä¸€ç§é€‰æ‹©',
          quality: 'ç¨€æœ‰',
          icon: 'âš¡',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å·²è¿è§„æ¬¡æ•°', operator: '>=', value: 5 },
        },

        // æ—¶é—´ç›¸å…³æˆå°±
        {
          id: 'week_survivor',
          name: 'ä¸€å‘¨ç”Ÿå­˜è€…',
          description: 'åœ¨å­¦é™¢ç”Ÿå­˜7å¤©',
          completionText: 'ä½ å·²ç»é€‚åº”äº†è¿™é‡Œçš„ç”Ÿæ´»',
          quality: 'æ™®é€š',
          icon: 'ğŸ“…',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', operator: '>=', value: 7 },
        },
        {
          id: 'month_veteran',
          name: 'èµ„æ·±å­¦å‘˜',
          description: 'åœ¨å­¦é™¢ç”Ÿå­˜30å¤©',
          completionText: 'ä½ å·²ç»æ˜¯è¿™é‡Œçš„è€æ‰‹äº†',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ“',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', operator: '>=', value: 30 },
        },

        // è¿æ°”ç›¸å…³æˆå°±
        {
          id: 'lucky_star',
          name: 'å¹¸è¿ä¹‹æ˜Ÿ',
          description: 'è¿æ°”å€¼è¾¾åˆ°80ä»¥ä¸Š',
          completionText: 'å‘½è¿å¥³ç¥åœ¨çœ·é¡¾ç€ä½ ',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ€',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è¿æ°”', operator: '>=', value: 80 },
        },
        {
          id: 'unlucky_soul',
          name: 'å€’éœ‰è›‹',
          description: 'è¿æ°”å€¼é™åˆ°20ä»¥ä¸‹',
          completionText: 'æœ‰æ—¶å€™åè¿æ°”ä¹Ÿæ˜¯ä¸€ç§ä½“éªŒ',
          quality: 'æ™®é€š',
          icon: 'ğŸ˜…',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è¿æ°”', operator: '<=', value: 20 },
        },

        // å®éªŒå®¤æˆå°±
        {
          id: 'research_start',
          name: 'ç ”ç©¶åŠ©æ‰‹',
          description: 'è·å¾—ç¬¬ä¸€ä¸ªå®éªŒæ•°æ®ç‚¹',
          completionText: 'ç§‘å­¦ç ”ç©¶çš„é“è·¯ä»è¿™é‡Œå¼€å§‹',
          quality: 'æ™®é€š',
          icon: 'ğŸ”¬',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å®éªŒæ•°æ®ç‚¹', operator: '>=', value: 1 },
        },

        // æ‰­è›‹ç›¸å…³æˆå°±
        {
          id: 'first_gacha',
          name: 'åˆæ¬¡æŠ½å¥–',
          description: 'è·å¾—ç¬¬ä¸€ä¸ªæ‰­è›‹å¸',
          completionText: 'è¿æ°”æ¸¸æˆå³å°†å¼€å§‹',
          quality: 'æ™®é€š',
          icon: 'ğŸ°',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.æ‰­è›‹å¸', operator: '>=', value: 1 },
        },

        // è½®å›ç›¸å…³æˆå°±
        {
          id: 'second_chance',
          name: 'é‡æ–°å¼€å§‹',
          description: 'ç»å†ç¬¬ä¸€æ¬¡è½®å›',
          completionText: 'æ­»äº¡ä¸æ˜¯ç»ˆç‚¹ï¼Œè€Œæ˜¯æ–°çš„å¼€å§‹',
          quality: 'å²è¯—',
          icon: 'ğŸ”„',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è½®å›æ¬¡æ•°', operator: '>=', value: 1 },
        },
        {
          id: 'eternal_returner',
          name: 'æ°¸æ’è½®å›è€…',
          description: 'ç»å†3æ¬¡è½®å›',
          completionText: 'ä½ å·²ç»è¶…è¶Šäº†æ­»äº¡çš„æŸç¼š',
          quality: 'ä¼ è¯´',
          icon: 'â™¾ï¸',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è½®å›æ¬¡æ•°', operator: '>=', value: 3 },
        },

        // å¤©èµ‹è¿›é˜¶æˆå°±
        {
          id: 'talent_growth',
          name: 'å¤©èµ‹æˆé•¿',
          description: 'è§£é”ç”Ÿé•¿å±‚çº§çš„å°å¤©èµ‹',
          completionText: 'ä½ çš„å¤©èµ‹æ­£åœ¨èŒå£®æˆé•¿',
          quality: 'æ™®é€š',
          icon: 'ğŸŒ±',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.ç”Ÿé•¿', operator: '!=', value: null },
        },
        {
          id: 'talent_mutation',
          name: 'å¤©èµ‹ç•¸å˜',
          description: 'è§£é”ç•¸å˜å±‚çº§çš„å°å¤©èµ‹',
          completionText: 'åŠ›é‡çš„ä»£ä»·æ˜¯æ‰­æ›²',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ§¬',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.ç•¸å˜', operator: '!=', value: null },
        },
        {
          id: 'talent_authority',
          name: 'æƒæŸ„æŒæ§',
          description: 'è§£é”æƒæŸ„å±‚çº§çš„å°å¤©èµ‹',
          completionText: 'ä½ å¼€å§‹æŒæ¡çœŸæ­£çš„æƒåŠ›',
          quality: 'å²è¯—',
          icon: 'ğŸ‘‘',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.æƒæŸ„', operator: '!=', value: null },
        },
        {
          id: 'talent_abyss',
          name: 'æ·±æ¸Šå‡è§†',
          description: 'è§£é”æ·±æ¸Šå±‚çº§çš„å°å¤©èµ‹',
          completionText: 'å½“ä½ å‡è§†æ·±æ¸Šæ—¶ï¼Œæ·±æ¸Šä¹Ÿåœ¨å‡è§†ç€ä½ ',
          quality: 'ä¼ è¯´',
          icon: 'ğŸ•³ï¸',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å¤©èµ‹.å°å¤©èµ‹.æ·±æ¸Š', operator: '!=', value: null },
        },

        // ç”Ÿå­˜æé™æˆå°±
        {
          id: 'critical_sanity',
          name: 'ç†æ™ºå´©å',
          description: 'ç†æ™ºå€¼é™åˆ°5ä»¥ä¸‹',
          completionText: 'ä½ åœ¨ç–¯ç‹‚çš„æ·±æ¸Šä¸­è‹¦è‹¦æŒ£æ‰',
          quality: 'ä¼ è¯´',
          icon: 'ğŸ’€',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç†æ™º', operator: '<=', value: 5 },
        },
        {
          id: 'near_death',
          name: 'æ¿’æ­»ä½“éªŒ',
          description: 'ä½“åŠ›å€¼é™åˆ°1',
          completionText: 'ä½ æ„Ÿå—åˆ°äº†æ­»ç¥çš„å‘¼å¸',
          quality: 'å²è¯—',
          icon: 'ğŸ’”',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ä½“åŠ›', operator: '<=', value: 1 },
        },

        // è¿æ°”æç«¯æˆå°±
        {
          id: 'fortune_favored',
          name: 'å¤©å‘½ä¹‹å­',
          description: 'è¿æ°”å€¼è¾¾åˆ°95ä»¥ä¸Š',
          completionText: 'ä½ å°±æ˜¯ä¼ è¯´ä¸­çš„å¤©å‘½ä¹‹å­',
          quality: 'ä¼ è¯´',
          icon: 'âœ¨',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è¿æ°”', operator: '>=', value: 95 },
        },
        {
          id: 'cursed_soul',
          name: 'è¢«è¯…å’’çš„çµé­‚',
          description: 'è¿æ°”å€¼é™åˆ°5ä»¥ä¸‹',
          completionText: 'ä»¿ä½›æ•´ä¸ªä¸–ç•Œéƒ½åœ¨ä¸ä½ ä¸ºæ•Œ',
          quality: 'å²è¯—',
          icon: 'ğŸŒ©ï¸',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.è¿æ°”', operator: '<=', value: 5 },
        },

        // ç»“æ™¶è¿›é˜¶æˆå°±
        {
          id: 'crystal_master',
          name: 'ç»“æ™¶å®—å¸ˆ',
          description: 'ç§¯ç´¯500ä¸ªç•¸å½¢æƒ…æ„Ÿç»“æ™¶',
          completionText: 'ä½ å·²ç»æ˜¯æƒ…æ„Ÿç»“æ™¶åŒ–çš„ç»å¯¹ä¸“å®¶',
          quality: 'ä¼ è¯´',
          icon: 'ğŸ’ ',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç•¸å½¢æƒ…æ„Ÿç»“æ™¶', operator: '>=', value: 500 },
        },

        // å®éªŒå®¤è¿›é˜¶æˆå°±
        {
          id: 'mad_scientist',
          name: 'ç–¯ç‹‚ç§‘å­¦å®¶',
          description: 'ç§¯ç´¯500ä¸ªå®éªŒæ•°æ®ç‚¹',
          completionText: 'ä¸ºäº†ç§‘å­¦ï¼Œä»»ä½•ä»£ä»·éƒ½æ˜¯å€¼å¾—çš„',
          quality: 'å²è¯—',
          icon: 'âš—ï¸',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å®éªŒæ•°æ®ç‚¹', operator: '>=', value: 500 },
        },

        // æ‰­è›‹è¿›é˜¶æˆå°±
        {
          id: 'gacha_addict',
          name: 'æ‰­è›‹æˆç˜¾è€…',
          description: 'ç§¯ç´¯50ä¸ªæ‰­è›‹å¸',
          completionText: 'æ‰­è›‹çš„é­…åŠ›è®©äººæ— æ³•æŠ—æ‹’',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ²',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.æ‰­è›‹å¸', operator: '>=', value: 50 },
        },

        // é“å…·æ”¶é›†æˆå°±
        {
          id: 'item_collector',
          name: 'æ”¶é›†å®¶',
          description: 'ç‰©å“æ ä¸­æ‹¥æœ‰5ä»¶ä¸åŒçš„é“å…·',
          completionText: 'ä½ å¼€å§‹ç§¯ç´¯å„ç§æœ‰ç”¨çš„ç‰©å“',
          quality: 'æ™®é€š',
          icon: 'ğŸ’',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç‰©å“æ ', operator: 'count_>=', value: 5 },
        },
        {
          id: 'item_hoarder',
          name: 'å›¤ç§¯ç‹‚',
          description: 'ç‰©å“æ ä¸­æ‹¥æœ‰15ä»¶ä¸åŒçš„é“å…·',
          completionText: 'ä½ çš„èƒŒåŒ…å¿«è¦è£…ä¸ä¸‹äº†',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ“¦',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç‰©å“æ ', operator: 'count_>=', value: 15 },
        },
        {
          id: 'treasure_hunter',
          name: 'å®ç‰©çŒäºº',
          description: 'ç‰©å“æ ä¸­æ‹¥æœ‰30ä»¶ä¸åŒçš„é“å…·',
          completionText: 'ä½ å·²ç»æ˜¯åå‰¯å…¶å®çš„å®ç‰©æ”¶é›†å¤§å¸ˆ',
          quality: 'å²è¯—',
          icon: 'ğŸ’°',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç‰©å“æ ', operator: 'count_>=', value: 30 },
        },
        {
          id: 'handbook_keeper',
          name: 'æ‰‹å†Œå®ˆæŠ¤è€…',
          description: 'å§‹ç»ˆæŒæœ‰ç‰¹é›·æ£®å­¦é™¢è®­ç»ƒå‘˜æ‰‹å†Œ',
          completionText: 'è¿™æœ¬æ‰‹å†Œæ˜¯ä½ åœ¨è¿™ä¸ªä¸–ç•Œçš„å”¯ä¸€é”šç‚¹',
          quality: 'æ™®é€š',
          icon: 'ğŸ“–',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.ç‰©å“æ .ç‰¹é›·æ£®å­¦é™¢è®­ç»ƒå‘˜æ‰‹å†Œ', operator: 'exists' },
        },

        // é©¬å¨˜å…³ç³»æˆå°±
        {
          id: 'first_bond',
          name: 'åˆæ¬¡é‚‚é€…',
          description: 'ä¸ç¬¬ä¸€ä½é©¬å¨˜å»ºç«‹è”ç³»',
          completionText: 'æ–°çš„å‹è°Šä»è¿™é‡Œå¼€å§‹',
          quality: 'æ™®é€š',
          icon: 'ğŸ¤',
          requirement: { type: 'mvu', key: 'é©¬å¨˜', operator: 'count_>=', value: 1 },
        },
        {
          id: 'popular_trainer',
          name: 'å—æ¬¢è¿çš„è®­ç»ƒå‘˜',
          description: 'ä¸5ä½é©¬å¨˜å»ºç«‹è”ç³»',
          completionText: 'ä½ åœ¨é©¬å¨˜ä¸­å¾ˆå—æ¬¢è¿',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ‘¥',
          requirement: { type: 'mvu', key: 'é©¬å¨˜', operator: 'count_>=', value: 5 },
        },
        {
          id: 'harem_master',
          name: 'åå®«ä¹‹ç‹',
          description: 'ä¸10ä½é©¬å¨˜å»ºç«‹è”ç³»',
          completionText: 'ä½ åœ¨æ„Ÿæƒ…ç®¡ç†ä¸Šå±•ç°äº†æƒŠäººçš„å¤©èµ‹',
          quality: 'å²è¯—',
          icon: 'ğŸ‘‘',
          requirement: { type: 'mvu', key: 'é©¬å¨˜', operator: 'count_>=', value: 10 },
        },
        {
          id: 'beloved_trainer',
          name: 'è¢«æ·±çˆ±çš„è®­ç»ƒå‘˜',
          description: 'è·å¾—ä»»æ„é©¬å¨˜80ç‚¹ä»¥ä¸Šå¥½æ„Ÿåº¦',
          completionText: 'çœŸæŒšçš„æ„Ÿæƒ…è¶…è¶Šäº†ä¸€åˆ‡ç•Œé™',
          quality: 'ç¨€æœ‰',
          icon: 'ğŸ’•',
          requirement: { type: 'mvu', key: 'é©¬å¨˜.*.å¥½æ„Ÿåº¦', operator: 'any_>=', value: 80 },
        },
        {
          id: 'perfect_bond',
          name: 'å®Œç¾ç¾ç»Š',
          description: 'è·å¾—ä»»æ„é©¬å¨˜100ç‚¹æ»¡å¥½æ„Ÿåº¦',
          completionText: 'è¿™æ˜¯æœ€å®Œç¾çš„è®­ç»ƒå‘˜ä¸é©¬å¨˜çš„å…³ç³»',
          quality: 'å²è¯—',
          icon: 'ğŸ’–',
          requirement: { type: 'mvu', key: 'é©¬å¨˜.*.å¥½æ„Ÿåº¦', operator: 'any_>=', value: 100 },
        },
        {
          id: 'dangerous_obsession',
          name: 'å±é™©çš„è¿·æ‹',
          description: 'ä»»æ„é©¬å¨˜çš„ç‹¬å åº¦è¾¾åˆ°80ä»¥ä¸Š',
          completionText: 'è¿™ç§æ„Ÿæƒ…å·²ç»è¶…å‡ºäº†æ­£å¸¸çš„èŒƒç•´...',
          quality: 'å²è¯—',
          icon: 'ğŸ”—',
          requirement: { type: 'mvu', key: 'é©¬å¨˜.*.ç‹¬å åº¦', operator: 'any_>=', value: 80 },
        },
        {
          id: 'heartbreaker',
          name: 'è´Ÿå¿ƒæ±‰',
          description: 'è®©ä»»æ„é©¬å¨˜çš„å¥½æ„Ÿåº¦é™åˆ°10ä»¥ä¸‹',
          completionText: 'æœ‰äº›ä¼¤å®³ä¸€æ—¦é€ æˆå°±æ— æ³•æŒ½å›',
          quality: 'æ™®é€š',
          icon: 'ğŸ’”',
          requirement: { type: 'mvu', key: 'é©¬å¨˜.*.å¥½æ„Ÿåº¦', operator: 'any_<=', value: 10 },
        },

        {
          id: 'chronic_offender',
          name: 'æƒ¯çŠ¯',
          description: 'è¿è§„æ¬¡æ•°è¾¾åˆ°10æ¬¡',
          completionText: 'è§„åˆ™å¯¹ä½ æ¥è¯´åªæ˜¯å»ºè®®',
          quality: 'å²è¯—',
          icon: 'ğŸ”¥',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.å·²è¿è§„æ¬¡æ•°', operator: '>=', value: 10 },
        },

        // æ—¶é—´ç›¸å…³è¿›é˜¶æˆå°±
        {
          id: 'semester_survivor',
          name: 'å­¦æœŸç”Ÿå­˜è€…',
          description: 'åœ¨å­¦é™¢ç”Ÿå­˜90å¤©',
          completionText: 'ä½ å·²ç»åº¦è¿‡äº†ä¸€ä¸ªå®Œæ•´çš„å­¦æœŸ',
          quality: 'å²è¯—',
          icon: 'ğŸ“š',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', operator: '>=', value: 90 },
        },
        {
          id: 'academy_legend',
          name: 'å­¦é™¢ä¼ å¥‡',
          description: 'åœ¨å­¦é™¢ç”Ÿå­˜365å¤©',
          completionText: 'ä½ çš„åå­—å°†è¢«æ°¸è¿œé“­è®°åœ¨å­¦é™¢å²å†Œä¸Š',
          quality: 'ä¼ è¯´',
          icon: 'ğŸ›ï¸',
          requirement: { type: 'mvu', key: 'è®­ç»ƒå‘˜.åœ¨æ ¡å¤©æ•°', operator: '>=', value: 365 },
        },
      ];

      const ACHIEVEMENT_QUALITIES = {
        æ™®é€š: { color: '#8b9dc3', bgColor: 'linear-gradient(135deg, #8b9dc3 0%, #6b7d9c 100%)' },
        ç¨€æœ‰: { color: '#4fc3f7', bgColor: 'linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%)' },
        å²è¯—: { color: '#ab47bc', bgColor: 'linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%)' },
        ä¼ è¯´: { color: '#ff9800', bgColor: 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' },
      };

      class TreisenAchievementSystem {
        constructor() {
          this.achievements = TREISEN_ACHIEVEMENTS;
          this.completedAchievements = JSON.parse(localStorage.getItem('treisenAchievements') || '[]');
        }

        init() {
          this.bindEvents();
          this.addAnimationStyles();
        }

        bindEvents() {
          $(document).on('click', '#achievements-btn', () => this.openAchievementModal());
          $(document).on('click', '#close-achievement-btn', () => this.closeAchievementModal());
          $(document).on('click', '#close-achievement-detail-btn', () => this.closeAchievementDetailModal());
          $(document).on('click', '.achievement-card', e => {
            const achievementId = $(e.currentTarget).data('achievement-id');
            const achievement = this.achievements.find(a => a.id === achievementId);
            if (achievement) this.showAchievementDetail(achievement);
          });
        }

        getMvuValue(key) {
          try {
            if (typeof Mvu !== 'undefined' && Mvu.getMvuVariable) {
              const mvuData = Mvu.getMvuData({ type: 'chat' });
              return Mvu.getMvuVariable(mvuData, key, { default_value: null });
            }
          } catch (error) {
            console.warn('MVUå˜é‡è¯»å–å¤±è´¥:', key, error);
          }
          return null;
        }

        checkAchievements() {
          let newAchievements = [];

          this.achievements.forEach(achievement => {
            if (this.completedAchievements.includes(achievement.id)) return;

            let isCompleted = false;
            const req = achievement.requirement;

            if (req.type === 'mvu') {
              const value = this.getMvuValue(req.key);
              if (value !== null && value !== undefined) {
                switch (req.operator) {
                  case '>=':
                    isCompleted = Number(value) >= req.value;
                    break;
                  case '<=':
                    isCompleted = Number(value) <= req.value;
                    break;
                  case '==':
                    isCompleted = value == req.value;
                    break;
                  case '!=':
                    isCompleted = value != req.value;
                    break;
                  case 'exists':
                    isCompleted = value !== null && value !== undefined;
                    break;
                  case 'count_>=':
                    if (typeof value === 'object' && value !== null) {
                      const count = Object.keys(value).filter(key => !key.startsWith('$')).length;
                      isCompleted = count >= req.value;
                    }
                    break;
                  case 'any_>=':
                    if (typeof value === 'object' && value !== null) {
                      isCompleted = Object.values(value).some(item => {
                        if (typeof item === 'object' && item !== null && item['å¥½æ„Ÿåº¦']) {
                          return Number(item['å¥½æ„Ÿåº¦']) >= req.value;
                        }
                        return false;
                      });
                    }
                    break;
                  case 'any_<=':
                    if (typeof value === 'object' && value !== null) {
                      isCompleted = Object.values(value).some(item => {
                        if (typeof item === 'object' && item !== null && item['å¥½æ„Ÿåº¦']) {
                          return Number(item['å¥½æ„Ÿåº¦']) <= req.value;
                        }
                        return false;
                      });
                    }
                    break;
                }
              }
            }

            if (isCompleted) {
              this.completedAchievements.push(achievement.id);
              newAchievements.push(achievement);
              this.showAchievementNotification(achievement);
            }
          });

          if (newAchievements.length > 0) {
            this.saveProgress();
          }
        }

        showAchievementNotification(achievement) {
          const notification = $(`
              <div class="achievement-notification" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
                color: #2c1810;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 350px;
                animation: slideInRight 0.5s ease-out;
              ">
                <div style="font-size: 2em;">${achievement.icon}</div>
                <div>
                  <div style="font-weight: bold; margin-bottom: 4px;">ğŸ† æˆå°±è¾¾æˆï¼</div>
                  <div style="font-size: 1.1em; margin-bottom: 2px;">${achievement.name}</div>
                  <div style="font-size: 0.9em; opacity: 0.9;">${achievement.completionText}</div>
                </div>
              </div>
            `);

          $('body').append(notification);
          setTimeout(() => notification.fadeOut(500, () => notification.remove()), 4000);
        }

        openAchievementModal() {
          this.checkAchievements();
          this.renderAchievements();
          const modal = document.getElementById('achievement-modal');
          if (modal) {
            // ğŸ”¥ ç¡®ä¿å¼¹çª—åœ¨è¦†ç›–å±‚å†…éƒ¨
            const overlay = document.getElementById('teresen-fullscreen-overlay');
            if (overlay && modal.parentNode !== overlay) {
              modal.dataset.originalParent = modal.parentNode?.tagName || 'BODY';
              overlay.appendChild(modal);
            }
          }
          $('#achievement-modal').show();
        }

        closeAchievementModal() {
          $('#achievement-modal').hide();
        }

        closeAchievementDetailModal() {
          $('#achievement-detail-modal').hide();
        }

        renderAchievements() {
          const completed = this.completedAchievements.length;
          const total = this.achievements.length;
          $('#achievement-progress').text(`å·²å®Œæˆ ${completed}/${total} ä¸ªæˆå°±`);

          const grid = $('#achievement-grid');
          grid.empty();

          this.achievements.forEach(achievement => {
            const isCompleted = this.completedAchievements.includes(achievement.id);
            const quality = ACHIEVEMENT_QUALITIES[achievement.quality] || ACHIEVEMENT_QUALITIES['æ™®é€š'];

            const card = $(`
                <div class="achievement-card ${isCompleted ? 'completed' : 'locked'}" data-achievement-id="${achievement.id}" style="
                  background: rgba(255, 255, 255, 0.05);
                  border: 2px solid ${quality.color};
                  border-radius: 12px;
                  padding: 20px;
                  cursor: pointer;
                  transition: all 0.3s;
                  text-align: center;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  gap: 12px;
                  ${!isCompleted ? 'opacity: 0.6; filter: grayscale(80%);' : 'box-shadow: 0 0 15px ' + quality.color + '40;'}
                ">
                  <div style="font-size: 2.5em; ${isCompleted ? '' : 'filter: grayscale(100%);'}">${achievement.icon}</div>
                  <div style="font-weight: bold; color: ${isCompleted ? quality.color : '#666'}; font-size: 1.1em;">${achievement.name}</div>
                  <div style="padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: bold; color: white; background: ${quality.bgColor};">${achievement.quality}</div>
                  ${isCompleted ? '<div style="color: #4caf50; font-size: 0.9em;">âœ“ å·²å®Œæˆ</div>' : '<div style="color: #666; font-size: 0.9em;">æœªå®Œæˆ</div>'}
                </div>
              `);

            card.hover(
              function () {
                $(this).css('transform', 'translateY(-5px)');
              },
              function () {
                $(this).css('transform', 'translateY(0)');
              },
            );

            grid.append(card);
          });
        }

        showAchievementDetail(achievement) {
          const isCompleted = this.completedAchievements.includes(achievement.id);
          const quality = ACHIEVEMENT_QUALITIES[achievement.quality] || ACHIEVEMENT_QUALITIES['æ™®é€š'];

          $('#achievement-detail-icon').text(achievement.icon);
          $('#achievement-detail-name').text(achievement.name);
          $('#achievement-detail-quality').css({ background: quality.bgColor }).text(achievement.quality);
          $('#achievement-detail-description').text(achievement.description);

          let reqText = this.getRequirementText(achievement.requirement, isCompleted);
          $('#achievement-detail-req-text').text(reqText);
          $('#achievement-detail-completion-text').text(achievement.completionText);

          $('#achievement-detail-modal').show();
        }

        getRequirementText(req, isCompleted) {
          if (req.type === 'mvu') {
            const currentValue = this.getMvuValue(req.key);
            const keyName = req.key.split('.').pop().replace('[0]', '');

            let text = '';
            switch (req.operator) {
              case 'exists':
                text = `æ‹¥æœ‰ ${keyName}`;
                break;
              case 'count_>=':
                text = `${keyName}æ•°é‡ >= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const count = Object.keys(currentValue).filter(key => !key.startsWith('$')).length;
                  text += ` (å½“å‰: ${count})`;
                }
                break;
              case 'any_>=':
                text = `ä»»æ„é©¬å¨˜å¥½æ„Ÿåº¦ >= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const maxFavorability = Math.max(
                    ...Object.values(currentValue).map(item => {
                      if (typeof item === 'object' && item !== null && item['å¥½æ„Ÿåº¦']) {
                        return Number(item['å¥½æ„Ÿåº¦']);
                      }
                      return 0;
                    }),
                  );
                  text += ` (æœ€é«˜: ${maxFavorability})`;
                }
                break;
              case 'any_<=':
                text = `ä»»æ„é©¬å¨˜å¥½æ„Ÿåº¦ <= ${req.value}`;
                if (typeof currentValue === 'object' && currentValue !== null) {
                  const minFavorability = Math.min(
                    ...Object.values(currentValue).map(item => {
                      if (typeof item === 'object' && item !== null && item['å¥½æ„Ÿåº¦']) {
                        return Number(item['å¥½æ„Ÿåº¦']);
                      }
                      return 100;
                    }),
                  );
                  text += ` (æœ€ä½: ${minFavorability})`;
                }
                break;
              default:
                text = `${keyName} ${req.operator} ${req.value}`;
                if (currentValue !== null && currentValue !== undefined) {
                  text += ` (å½“å‰: ${currentValue})`;
                }
            }

            if (isCompleted) text += ' âœ“';
            return text;
          }
          return 'æœªçŸ¥æ¡ä»¶';
        }

        saveProgress() {
          localStorage.setItem('treisenAchievements', JSON.stringify(this.completedAchievements));
        }

        addAnimationStyles() {
          if (!document.getElementById('achievement-animations')) {
            const style = document.createElement('style');
            style.id = 'achievement-animations';
            style.textContent = `
                @keyframes slideInRight {
                  from { transform: translateX(100%); opacity: 0; }
                  to { transform: translateX(0); opacity: 1; }
                }
              `;
            document.head.appendChild(style);
          }
        }
      }
    </script>
  </body>
</html>

<!--
================================================================================
  ç‰¹é›·æ£®è§„åˆ™æ€ªè°ˆ - è®­ç»ƒå‘˜ç”Ÿå­˜æŒ‡å— (ç»“æŸ)
  
  ä½œè€…: Eternal zz
  åˆ›æ„æ”¯æŒï¼ŒæŠ€æœ¯æ”¯æŒ
  Discord ID: eternalzz0840
  
  æ„Ÿè°¢ä½¿ç”¨æœ¬é¡¹ç›®ï¼
  
  ç‰ˆæƒå£°æ˜:
  - ç¦æ­¢å•†ç”¨
  - ç¦æ­¢äºŒåˆ›  
  - åªèƒ½åœ¨ç±»è„‘ã€æ—…ç¨‹äºŒä¼ 
================================================================================
-->

